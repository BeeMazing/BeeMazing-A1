<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BeeMazing Admin - User Tasks</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-color: #FFC107;
      --secondary-color: #212121;
      --accent-color: #FFFFFF;
      --light-bg: #1E1F26;
      --text-color: #FFFFFF;
      --danger-color: #D32F2F;
      --modal-bg: rgba(33, 33, 33, 0.7);
      --header-height: 68px;
      --footer-height: 70px;
      --border-dark: #444754;
      --card-bg: #2A2B32;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-color);
      height: 100vh;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color), #FFB300);
      height: var(--header-height);
      position: fixed;
      width: 100%;
      top: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .title {
      font-size: 24px;
      font-weight: 600;
      color: var(--secondary-color);
    }

    .date-header {
      position: fixed;
      top: var(--header-height);
      width: 100%;
      background: var(--secondary-color);
      z-index: 90;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .month-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      padding: 5px;
      color: var(--accent-color);
    }
    .month-nav button {
      background: var(--secondary-color);
      color: var(--accent-color);
      border: none;
      font-size: 18px;
      padding: 4px 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .month-nav button:hover {
      background: var(--primary-color);
      color: var(--secondary-color);
    }
    .day-scroll-wrapper {
      display: flex;
      align-items: center;
      overflow: hidden;
      padding: 6px 10px;
    }
    .day-scroll {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 5px;
      scroll-behavior: smooth;
    }
    .day-scroll::-webkit-scrollbar {
      display: none;
    }
    .day {
      min-width: 38px;
      height: 38px;
      line-height: 38px;
      border-radius: 50%;
      background: var(--secondary-color);
      color: var(--accent-color);
      text-align: center;
      font-weight: bold;
      cursor: pointer;
      flex-shrink: 0;
    }
    .day.selected {
      background: var(--primary-color);
      color: var(--secondary-color);
    }

    .scroll-btn {
      background: var(--secondary-color);
      color: var(--accent-color);
      border: none;
      font-size: 20px;
      border-radius: 10px;
      padding: 5px 10px;
      cursor: pointer;
    }

    .tasks-table {
      position: absolute;
      top: calc(var(--header-height) + 100px);
      bottom: var(--footer-height);
      width: 100%;
      overflow-y: auto;
      padding: 20px;
      background-color: var(--light-bg);
    }
    .tasks-table h3 {
      text-align: center;
      margin-bottom: 15px;
      color: var(--primary-color);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-dark);
    }
    th {
      background: var(--secondary-color);
      color: var(--primary-color);
    }
    td {
      background: var(--card-bg);
    }
    .status-completed { color: #4CAF50; font-weight: bold; }
    .status-pending { color: #FFB300; font-weight: bold; }
    .action-btn {
      padding: 6px 12px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-right: 6px;
    }
    .accept-btn { background-color: #4CAF50; color: white; }
    .decline-btn { background-color: var(--danger-color); color: white; }

    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      height: var(--footer-height);
      background: var(--secondary-color);
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
    }
    .footer a {
      text-decoration: none;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .footer a img {
      width: 40px;
      height: 40px;
      filter: invert(100%);
    }
    .footer a span {
      font-size: 12px;
      font-weight: bold;
    }

    @media (max-width: 600px) {
      th, td { font-size: 14px; }
      .footer a img { width: 35px; height: 35px; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header"><h1 class="title">Admin - User Tasks</h1></div>

  <!-- Date Header -->
  <div class="date-header">
    <div class="month-nav">
      <button id="prevMonth">&lt;</button>
      <span id="monthLabel">Loading...</span>
      <button id="nextMonth">&gt;</button>
    </div>
    <div class="day-scroll-wrapper">
      <button class="scroll-btn" id="scrollLeft">&lt;</button>
      <div class="day-scroll" id="dayScrollContainer"></div>
      <button class="scroll-btn" id="scrollRight">&gt;</button>
    </div>
  </div>

  <!-- Tasks Table -->
  <div class="tasks-table">
    <h3>Tasks Overview</h3>
    <table>
      <thead>
        <tr>
          <th>Task Title</th>
          <th>Assigned To</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="adminTasksBody"></tbody>
    </table>
  </div>

  <!-- Footer -->
  <div class="footer">
    <a href="/BeeMazing-Y1/mobile/1-Home/home.html">
      <img src="/BeeMazing-Y1/mobile/1-Home/HomeBtn.png" alt="Home" /><span>Home</span>
    </a>
    <a href="#"><img src="/BeeMazing-Y1/mobile/1-Home/ProfileBtn.png" alt="Profile" /><span>Profile</span></a>
    <a href="#"><img src="/BeeMazing-Y1/mobile/1-Home/MarketBtn.png" alt="Market" /><span>Market</span></a>
    <a href="#"><img src="/BeeMazing-Y1/mobile/1-Home/RewardsBtn.png" alt="Rewards" /><span>Rewards</span></a>
  </div>

  <script>
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    function updateMonthLabel() {
      const options = { month: 'long', year: 'numeric' };
      const date = new Date(currentYear, currentMonth);
      document.getElementById("monthLabel").textContent = date.toLocaleDateString(undefined, options);
      generateDays(currentYear, currentMonth);
    }

    function generateDays(year, month) {
      const container = document.getElementById("dayScrollContainer");
      container.innerHTML = "";
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();

      for (let i = 1; i <= daysInMonth; i++) {
        const day = document.createElement("div");
        day.className = "day";
        day.textContent = i;

        if (
          year === today.getFullYear() &&
          month === today.getMonth() &&
          i === today.getDate()
        ) {
          day.classList.add("selected");
        }

        day.onclick = () => {
          document.querySelectorAll(".day").forEach(d => d.classList.remove("selected"));
          day.classList.add("selected");
        };

        container.appendChild(day);
      }
    }

    document.getElementById("prevMonth").onclick = () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      updateMonthLabel();
    };

    document.getElementById("nextMonth").onclick = () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      updateMonthLabel();
    };

    async function loadAdminTasks() {
      const adminEmail = localStorage.getItem("currentAdminEmail");
      if (!adminEmail) return;

      const today = new Date().toISOString().split("T")[0];
      const res = await fetch(`https://beemazing.onrender.com/api/admin-tasks?adminEmail=${adminEmail}`);
      const result = await res.json();
      if (!result.success) return;

      const tbody = document.getElementById("adminTasksBody");
      tbody.innerHTML = "";

      result.tasks.forEach(task => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${task.title}</td>
          <td>${task.user}</td>
          <td class="${task.status === 'Completed' ? 'status-completed' : 'status-pending'}">${task.status}</td>
          <td>
            ${task.status === "Completed"
              ? `<button class="action-btn accept-btn" onclick="handleTaskAction('${adminEmail}', '${task.title}', '${task.user}', 'accept')">Accept</button>
                 <button class="action-btn decline-btn" onclick="handleTaskAction('${adminEmail}', '${task.title}', '${task.user}', 'decline')">Decline</button>`
              : "-"
            }
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    async function handleTaskAction(adminEmail, title, user, action) {
      const today = new Date().toISOString().split("T")[0];
      const res = await fetch("https://beemazing.onrender.com/api/task-action", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ adminEmail, taskTitle: title, user, action, date: today })
      });

      const data = await res.json();
      if (data.success) loadAdminTasks();
      else alert("Error: " + (data.message || "Unable to update task."));
    }

    window.addEventListener("DOMContentLoaded", () => {
      updateMonthLabel();
      loadAdminTasks();
    });


    let monthOffset = 0;

function generateScrollableDates(monthOffset = 0) {
  const container = document.getElementById("dayScrollContainer");
  container.innerHTML = "";

  const today = new Date();
  today.setDate(1);
  today.setMonth(today.getMonth() + monthOffset);

  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  // Set month label like "April 2025"
  document.getElementById("monthLabel").textContent = today.toLocaleDateString(undefined, {
    month: 'long',
    year: 'numeric'
  });

  const selectedToday = new Date();
const todayStr = new Date(
  selectedToday.getFullYear(),
  selectedToday.getMonth(),
  selectedToday.getDate()
).toLocaleDateString("en-CA"); // "YYYY-MM-DD"


  for (let i = 1; i <= daysInMonth; i++) {
    const date = new Date(currentYear, currentMonth, i);
    const dateStr = date.toLocaleDateString('en-CA'); // YYYY-MM-DD


    const dayDiv = document.createElement("div");
    dayDiv.className = "day";
    dayDiv.textContent = i;
    dayDiv.dataset.date = dateStr;

    dayDiv.addEventListener("click", () => {
      document.querySelectorAll(".day").forEach(d => d.classList.remove("selected"));
      dayDiv.classList.add("selected");
      loadAdminTasks(dateStr); // 👈 pass selected date to load
    });

    if (dateStr === todayStr && monthOffset === 0) {
      dayDiv.classList.add("selected");
      loadAdminTasks(dateStr); // 👈 load today's tasks on load
    }

    container.appendChild(dayDiv);
  }

  // Scroll selected day into view
  setTimeout(() => {
    const selected = document.querySelector(".day.selected");
    if (selected) selected.scrollIntoView({ behavior: "smooth", inline: "center" });
  }, 50);
}

document.getElementById("prevMonth").addEventListener("click", () => {
  monthOffset--;
  generateScrollableDates(monthOffset);
});
document.getElementById("nextMonth").addEventListener("click", () => {
  monthOffset++;
  generateScrollableDates(monthOffset);
});
document.getElementById("scrollLeft").addEventListener("click", () => {
  document.getElementById("dayScrollContainer").scrollBy({ left: -150, behavior: "smooth" });
});
document.getElementById("scrollRight").addEventListener("click", () => {
  document.getElementById("dayScrollContainer").scrollBy({ left: 150, behavior: "smooth" });
});

// Modify your existing loadAdminTasks to accept a date:
async function loadAdminTasks(selectedDate = new Date().toISOString().split("T")[0]) {
  const adminEmail = localStorage.getItem("currentAdminEmail");
  if (!adminEmail) return;

  const res = await fetch(`https://beemazing.onrender.com/api/tasks?adminEmail=${adminEmail}`);
  const result = await res.json();
  if (!result.success) return;

  const tbody = document.getElementById("adminTasksBody");
  tbody.innerHTML = "";

  const parseDate = (str) => {
    const [y, m, d] = str.split("-").map(Number);
    return new Date(y, m - 1, d);
  };

  result.tasks.forEach(task => {
    const range = task.date.split(" to ");
    const from = parseDate(range[0]);
    const to = range[1] ? parseDate(range[1]) : new Date(3000, 0, 1);
    const dateObj = parseDate(selectedDate);

    if (dateObj < from || dateObj > to) return;

    let currentTurn = task.tempTurnReplacement?.replacement || task.turn || task.users[0];
    if (task.repeat === "Daily" && task.timesPerDay === 1) {
      const diff = Math.floor((dateObj - from) / (1000 * 60 * 60 * 24));
      const userList = [...task.users];
      const idx = diff % userList.length;
      currentTurn = userList[idx];
    }

    const completions = task.completions?.[selectedDate] || [];
    const completedBy = Array.isArray(completions) ? completions : [];
    const requiredTimes = task.timesPerDay || task.timesPerWeek || task.timesPerMonth || 1;
    const completedCount = completedBy.length;

    // Determine if this task has pending approval
    const needsApproval = completedCount >= requiredTimes;

    const tr = document.createElement("tr");
const assignedUser = completedBy[0] || currentTurn;

tr.innerHTML = `
  <td>${task.title}</td>
  <td>${needsApproval ? completedBy.join(", ") : currentTurn}</td>
  <td class="${needsApproval ? "status-completed" : "status-pending"}">${needsApproval ? "Completed" : "Pending"}</td>
  <td>
    ${needsApproval
      ? `<button class="action-btn accept-btn" onclick="handleTaskAction('${adminEmail}', '${task.title}', '${assignedUser}', 'accept')">Accept</button>
         <button class="action-btn decline-btn" onclick="handleTaskAction('${adminEmail}', '${task.title}', '${assignedUser}', 'decline')">Decline</button>`
      : "-"
    }
  </td>
`;

    tbody.appendChild(tr);
  });
}


window.addEventListener("DOMContentLoaded", () => {
  generateScrollableDates(); // Auto-generate and auto-select today
});
  </script>
</body>
</html>
