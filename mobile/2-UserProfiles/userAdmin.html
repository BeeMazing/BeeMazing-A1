<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Task Review</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">


  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #1E1F26;
      color: #FFFFFF;
      margin: 0;
      padding: 0;
    }
    .date-header {
      background: #212121;
      padding: 10px;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .month-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      font-weight: bold;
    }
    .month-nav button {
      margin: 0 10px;
      background: #FFC107;
      color: #212121;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .day-scroll-wrapper {
      display: flex;
      align-items: center;
      padding: 5px 0;
      overflow: hidden;
    }
    .scroll-btn {
      background: #212121;
      color: #fff;
      border: none;
      font-size: 20px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .day-scroll {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 5px 10px;
    }
    .day {
      min-width: 38px;
      height: 38px;
      line-height: 38px;
      text-align: center;
      border-radius: 50%;
      background: #333;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
    .day.selected {
      background: #FFC107;
      color: #212121;
    }
    .task-entry {
      background: #2A2B32;
      border: 2px solid #444754;
      border-radius: 12px;
      padding: 16px;
      margin: 15px;
      cursor: pointer;
    }
    .task-entry:hover {
      background: #333540;
    }
    .task-title {
      margin: 0;
      font-weight: bold;
    }
    .task-details {
      display: none;
      margin-top: 10px;
    }
    .task-details.show {
      display: block;
    }
    .turn-entry {
      background: #3A3B44;
      border-radius: 8px;
      padding: 10px;
      margin: 5px 0;
    }
    .turn-entry p {
      margin: 5px 0;
    }
    .accept-btn, .decline-btn, .replace-btn, .revert-btn {
      margin-top: 10px;
      padding: 8px 14px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .accept-btn {
      background-color: #4CAF50;
      color: white;
      margin-right: 10px;
    }
    .decline-btn {
      background-color: #D32F2F;
      color: white;
    }
    .replace-btn {
      background-color: #2196F3;
      color: white;
      margin-right: 10px;
    }
    .revert-btn {
      background-color: #FF9800;
      color: white;
    }
    select {
      padding: 8px;
      border-radius: 6px;
      background: #333;
      color: #fff;
      border: 1px solid #444754;
      margin-top: 10px;
    }
    .day-scroll::-webkit-scrollbar {
      display: none;
    }
    .day-scroll {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>




</head>
<body>

  <div class="date-header">
    <div class="month-nav">
      <button id="prevMonth">&lt;</button>
      <span id="monthLabel">Month</span>
      <button id="nextMonth">&gt;</button>
    </div>
    <div class="day-scroll-wrapper">
      <button class="scroll-btn" id="scrollLeft">&lt;</button>
      <div class="day-scroll" id="dayScrollContainer"></div>
      <button class="scroll-btn" id="scrollRight">&gt;</button>
    </div>
  </div>

  <div id="taskContainer">Loading tasks...</div>





  <script>
    const adminEmail = localStorage.getItem("currentAdminEmail");
    let selectedDate = new Date().toLocaleDateString("sv-SE");
    let allUsers = [];
  
    async function fetchUsers() {
      try {
        const res = await fetch(`https://beemazing.onrender.com/get-users?adminEmail=${encodeURIComponent(adminEmail)}`);
        const data = await res.json();
        allUsers = data.users || [];
      } catch (err) {
        console.error("Error fetching users:", err);
      }
    }
  
    async function handleDecision(title, date, index, decision, user, event) {
      try {
        const button = event.target;
        const taskEntry = button.closest(".task-entry");
        const buttons = taskEntry.querySelectorAll("button");
        buttons.forEach(btn => {
          btn.disabled = true;
          btn.style.opacity = "0.5";
        });
  
        const response = await fetch("https://beemazing.onrender.com/api/review-task", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            adminEmail,
            title,
            date,
            selectedDate,
            user,
            decision
          })
        });
  
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to process decision");
  
        setTimeout(() => loadTasks(), 500);
      } catch (err) {
        console.error("Error processing decision:", err);
        const errorDiv = document.createElement("div");
        errorDiv.style.color = "red";
        errorDiv.textContent = `Error: ${err.message}`;
        taskEntry.appendChild(errorDiv);
        taskEntry.querySelectorAll("button").forEach(btn => {
          btn.disabled = false;
          btn.style.opacity = "1";
        });
      }
    }
  
    async function handleReplace(title, date, index, originalUser, event) {
      const taskEntry = event.target.closest(".task-entry");
      const select = taskEntry.querySelector(`#replace-select-${index}`);
      const newUser = select.value;
      if (!newUser) return;
  
      try {
        const response = await fetch("https://beemazing.onrender.com/api/replace-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            adminEmail,
            title,
            date,
            selectedDate,
            index,
            originalUser,
            newUser
          })
        });
  
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to replace user");
  
        setTimeout(() => loadTasks(), 500);
      } catch (err) {
        console.error("Error replacing user:", err);
        const errorDiv = document.createElement("div");
        errorDiv.style.color = "red";
        errorDiv.textContent = `Error: ${err.message}`;
        taskEntry.appendChild(errorDiv);
      }
    }
  
    async function handleRevert(title, date, index, user, event) {
      try {
        const button = event.target;
        const taskEntry = button.closest(".task-entry");
        const buttons = taskEntry.querySelectorAll("button");
        buttons.forEach(btn => {
          btn.disabled = true;
          btn.style.opacity = "0.5";
        });
  
        const response = await fetch("https://beemazing.onrender.com/api/revert-decision", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            adminEmail,
            title,
            date,
            selectedDate,
            user
          })
        });
  
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to revert decision");
  
        setTimeout(() => loadTasks(), 500);
      } catch (err) {
        console.error("Error reverting decision:", err);
        const errorDiv = document.createElement("div");
        errorDiv.style.color = "red";
        errorDiv.textContent = `Error: ${err.message}`;
        taskEntry.appendChild(errorDiv);
        taskEntry.querySelectorAll("button").forEach(btn => {
          btn.disabled = false;
          btn.style.opacity = "1";
        });
      }
    }
  
    async function loadTasks() {
      try {
        const res = await fetch(`https://beemazing.onrender.com/get-tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`, {
          cache: "no-store"
        });
        if (!res.ok) throw new Error(`HTTP error ${res.status}`);
        const { tasks } = await res.json();
  
        const container = document.getElementById("taskContainer");
        container.innerHTML = "";
  
        const tasksByTitle = {};
        tasks.forEach(task => {
          if (!tasksByTitle[task.title]) {
            tasksByTitle[task.title] = [];
          }
          const pendingCompletions = task.pendingCompletions?.[selectedDate] || [];
          const completions = task.completions?.[selectedDate] || [];
          const userOrder = task.users || [];
          const repeat = task.repeat || "Daily";
          let requiredTimes = task.timesPerDay || 1;
          if (repeat === "Weekly") requiredTimes = task.timesPerWeek || 1;
          if (repeat === "Monthly") requiredTimes = task.timesPerMonth || 1;
  
          const fullTurn = [];
          for (let i = 0; i < requiredTimes; i++) {
            const user = task.tempTurnReplacement?.[selectedDate]?.[i] || userOrder[i % userOrder.length];
            fullTurn.push(user);
          }
  
          fullTurn.forEach((user, index) => {
            tasksByTitle[task.title].push({
              user,
              index,
              date: task.date,
              isPending: pendingCompletions.includes(user),
              isCompleted: completions.includes(user)
            });
          });
        });
  
        Object.keys(tasksByTitle).forEach(title => {
          const turns = tasksByTitle[title];
          const div = document.createElement("div");
          div.className = "task-entry";
          div.innerHTML = `
            <h3 class="task-title">${title}</h3>
            <div class="task-details">
              ${turns.map(turn => `
                <div class="turn-entry">
                  <p>Turn ${turn.index + 1}: ${turn.user} - ${turn.isCompleted ? 'Accepted' : turn.isPending ? 'Waiting for Review' : 'Pending'}</p>
                  ${turn.isPending && !turn.isCompleted ? `
                    <button class="accept-btn" onclick="handleDecision('${title}', '${turn.date}', ${turn.index}, 'accept', '${turn.user}', event)">Accept</button>
                    <button class="decline-btn" onclick="handleDecision('${title}', '${turn.date}', ${turn.index}, 'decline', '${turn.user}', event)">Decline</button>
                  ` : turn.isCompleted ? `
                    <button class="revert-btn" onclick="handleRevert('${title}', '${turn.date}', ${turn.index}, '${turn.user}', event)">Revert</button>
                  ` : `
                    <select id="replace-select-${turn.index}">
                      <option value="">Select User</option>
                      ${allUsers.map(u => `<option value="${u}">${u}</option>`).join('')}
                    </select>
                    <button class="replace-btn" onclick="handleReplace('${title}', '${turn.date}', ${turn.index}, '${turn.user}', event)">Replace</button>
                  `}
                </div>
              `).join('')}
            </div>
          `;
          container.appendChild(div);
  
          div.querySelector(".task-title").addEventListener("click", () => {
            const details = div.querySelector(".task-details");
            details.classList.toggle("show");
          });
        });
  
        if (!container.innerHTML) {
          container.innerHTML = "<p>No tasks for this date.</p>";
        }
      } catch (err) {
        console.error("Error loading tasks:", err);
        document.getElementById("taskContainer").innerHTML = "<p>Error loading tasks. Please try again.</p>";
      }
    }
  
    function generateScrollableDates(monthOffset = 0) {
      const container = document.getElementById("dayScrollContainer");
      container.innerHTML = "";
  
      const today = new Date();
      today.setDate(1);
      today.setMonth(today.getMonth() + monthOffset);
  
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  
      document.getElementById("monthLabel").textContent = today.toLocaleDateString(undefined, {
        month: 'long',
        year: 'numeric',
      });
  
      for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(currentYear, currentMonth, i);
        const btn = document.createElement("div");
        btn.className = "day";
        btn.textContent = i;
        btn.dataset.date = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  
        btn.addEventListener("click", () => {
          document.querySelectorAll(".day").forEach(d => d.classList.remove("selected"));
          btn.classList.add("selected");
          selectedDate = btn.dataset.date;
          loadTasks();
        });
  
        const todayStr = new Date().toLocaleDateString("sv-SE");
        if (btn.dataset.date === todayStr) {
          btn.classList.add("selected");
          selectedDate = btn.dataset.date;
          loadTasks();
        }
  
        container.appendChild(btn);
      }
  
      setTimeout(() => {
        const selected = document.querySelector(".day.selected");
        if (selected) {
          selected.scrollIntoView({ behavior: "smooth", inline: "center" });
        }
      }, 50);
    }
  
    let monthOffset = 0;
    document.getElementById("prevMonth").addEventListener("click", () => {
      monthOffset--;
      generateScrollableDates(monthOffset);
    });
    document.getElementById("nextMonth").addEventListener("click", () => {
      monthOffset++;
      generateScrollableDates(monthOffset);
    });
    document.getElementById("scrollLeft").addEventListener("click", () => {
      document.getElementById("dayScrollContainer").scrollBy({
        left: -200,
        behavior: "smooth",
      });
    });
    document.getElementById("scrollRight").addEventListener("click", () => {
      document.getElementById("dayScrollContainer").scrollBy({
        left: 200,
        behavior: "smooth",
      });
    });
  
    fetchUsers().then(() => generateScrollableDates());
  </script>





</body>
</html>