<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Task Review</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">







  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

:root {
    --primary-color: #131312;
    --secondary-color: #e4e3e0;
    --accent-color: #FFFFFF;
    --light-bg: #FFFFF8;
    --text-color: #000000;
    --footer-height: 70px;
    --modal-bg: rgba(19, 19, 18, 0.4); /* Added */
    --border-dark: #444754; /* Added */
    /* Cache buster v13.0 - direct DOM manipulation for no scrolling */
}

/* RGB color variations for Add User elements */
button[id="addUserBtn"],
#addUserBtn,
.add-user-btn {
    background-color: rgb(251, 183, 64) !important;
    background: rgb(251, 183, 64) !important;
    color: rgb(245, 245, 220) !important;
    border: none !important;
    border-radius: 50% !important;
    width: 24px !important;
    height: 24px !important;
    font-size: 16px !important;
    font-weight: bold !important;
    cursor: pointer !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
}

button[id="addUserBtn"]:hover,
#addUserBtn:hover,
.add-user-btn:hover {
    background-color: #5D4E41 !important;
    background: #5D4E41 !important;
    color: rgb(245, 245, 220) !important;
}

h3 {
    color: #5D4E41 !important;
}

/* Active user highlighting */
.user-list li.active-user {
    background: rgb(251, 183, 64) !important;
    color: #5D4E41 !important;
    font-weight: 600 !important;
}

/* Add User text styling - super specific selectors */
.bottom-sheet .bottom-sheet-header .header-title h3,
.bottom-sheet-header .header-title h3,
.header-title h3 {
    color: #5D4E41 !important;
    margin: 0 !important;
    font-size: 18px !important;
    font-weight: 600 !important;
}

/* Add User button styling - super specific selectors */
.bottom-sheet .bottom-sheet-header .header-title .add-user-btn,
.bottom-sheet-header .header-title .add-user-btn,
.header-title .add-user-btn,
#addUserBtn {
    background: #FBB740 !important;
    color: #F5F5DC !important;
    border: none !important;
    border-radius: 50% !important;
    width: 24px !important;
    height: 24px !important;
    font-size: 16px !important;
    font-weight: bold !important;
    cursor: pointer !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: background 0.2s ease !important;
}

.bottom-sheet .bottom-sheet-header .header-title .add-user-btn:hover,
.bottom-sheet-header .header-title .add-user-btn:hover,
.header-title .add-user-btn:hover,
#addUserBtn:hover {
    background: #5D4E41 !important;
    color: #F5F5DC !important;
}

#taskContainer {
  margin-top: 130px;
  padding-bottom: 80px;
}



    body {
      font-family: 'Poppins', sans-serif;
      background-color: #FFFFF8;
      color: #FFFFFF;
      margin: 0;
      padding: 0;
    }


    .header {
    background: linear-gradient(135deg, var(--primary-color), #181816);
    padding: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    position: fixed;
    top: 0;
    width: 100%;
    height: var(--header-height);
    z-index: 100;
}

    .date-header {
    background: #FFF6E9;
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 50;
    padding: 5px 0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    color: black;
}
    .month-nav {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        font-weight: bold;
        width: 100%;
        padding: 5px 0;
        color: #5D4E41;
    }
    .month-nav button {
      margin: 0 10px;
      background: #FBB740;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.3s ease;
      font-weight: bold;
    }
    .month-nav button:hover {
      transform: scale(1.1);
    }

    .scroll-btn {
      background: #e4e3e0;
      color: #181816;
      border: none;
      font-size: 20px;
      padding: 5px 10px;
      cursor: pointer;
    }



    .task-entry {
      background: #2A2B32;
      border: 2px solid #444754;
      border-radius: 12px;
      padding: 16px;
      margin: 15px;
      cursor: pointer;
    }
    .task-entry:hover {
      background: #333540;
    }
    .task-title {
      margin: 0;
      font-weight: bold;
      display: flex;
      align-items: center;
    }
    .notification-bubble {
      background: #D32F2F;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      line-height: 20px;
      text-align: center;
      font-size: 12px;
      margin-left: 10px;
    }
    .task-details {
      display: none;
      margin-top: 10px;
    }
    .task-details.show {
      display: block;
    }
    .turn-entry {
  background: #3A3B44;
  border-radius: 8px;
  padding: 10px;
  margin: 5px 0;
  border: 2px solid transparent;
}
    .turn-entry p {
      margin: 5px 0;
    }
    .accept-btn, .decline-btn, .replace-btn, .revert-btn {
      margin-top: 10px;
      padding: 8px 14px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .accept-btn {
      background-color: #4CAF50;
      color: white;
      margin-right: 10px;
    }
    .decline-btn {
      background-color: #D32F2F;
      color: white;
    }
    .replace-btn {
      background-color: #2196F3;
      color: white;
      margin-right: 10px;
    }
    .revert-btn {
      background-color: #FF9800;
      color: white;
    }
    select {
      padding: 8px;
      border-radius: 6px;
      background: #333;
      color: #fff;
      border: 1px solid #444754;
      margin-top: 10px;
    }


    .day-scroll-wrapper {
  display: flex;
  align-items: center;
  padding: 5px 0;
  overflow: hidden;
}
.day-scroll {
  display: flex;
  overflow-x: auto;
  gap: 8px;
  padding: 5px 10px;
}
.day-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 38px;
}
.day-label {
  font-size: 10px;
  color: #5D4E41;
  text-align: center;
  margin-bottom: 2px;
  font-weight: 600;
}
.day {
  width: 38px;
  height: 38px;
  line-height: 38px;
  text-align: center;
  border-radius: 50%;
  background: transparent;
  color: #5D4E41;
  font-weight: bold;
  cursor: pointer;
}
.day.selected {
  background: #FBB740;
  color: #fff;
}
.day.today {
  border: 2px solid #FBB740;
  font-weight: bold;
}
.day.today.selected {
  background: #FBB740;
  color: #fff;
  border: 2px solid #fff;
}
.day-scroll::-webkit-scrollbar {
  display: none;
}
.day-scroll {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

    .footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    left: 0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    background: #FBB740;
    padding: 10px 0;
    box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
    z-index: 100;
    height: var(--footer-height);
}
.footer a {
    text-decoration: none;
    color: #FFFFFF;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.3s ease;
}
.footer a:hover {
    transform: scale(1.1);
}
.footer-icon img, .footer-icon svg {
    width: 40px;
    height: 40px;
    filter: brightness(0) saturate(100%) invert(100%);
    transition: filter 0.3s ease;
}

.footer a.active svg {
    filter: brightness(0) saturate(100%) invert(30%) sepia(20%) saturate(2000%) hue-rotate(15deg) brightness(0.8) contrast(1.2) !important;
    color: #5D4E41;
}

.footer-icon span {
    font-size: 12px;
    margin-top: 5px;
    font-weight: 600;
}
.footer a.active span {
    color: #FFFFFF;
}
@media (max-width: 600px) {
    .footer-icon img, .footer-icon svg {
        width: 24px;
        height: 24px;
        margin-bottom: 2px;
        filter: brightness(0) saturate(100%) invert(100%);
    }
}














/* Profile Icon */
.profile-icon {
    position: fixed;
    top: 10px;
    right: 20px;
    width: 40px;
    height: 40px;
    cursor: pointer;
    z-index: 202;
    transition: transform 0.3s ease;
    background: #FBB740;
    border-radius: 50%;
    padding: 8px;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.profile-icon:hover {
    transform: scale(1.1);
}














/* Right top corner Select User Menu ********************************************************/
.bottom-sheet {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--modal-bg);
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}
.bottom-sheet.show {
    display: block;
    opacity: 1;
}
.bottom-sheet-content {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    max-height: none;
    background: var(--light-bg);
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    box-shadow: 0 -4px 20px rgba(19, 19, 18, 0.2);
    border: 2px solid var(--secondary-color);
    transform: translateY(100%);
    transition: transform 0.3s ease-in-out;
}
.bottom-sheet.show .bottom-sheet-content {
    transform: translateY(0);
}
.bottom-sheet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 2px solid var(--secondary-color);
    background: var(--accent-color);
}
.bottom-sheet-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #5D4E41 !important;
}
.bottom-sheet-header .close-btn {
    background: none;
    border: none;
    color: #F5F5DC !important;
    font-size: 24px;
    cursor: pointer;
    padding: 5px;
}
.bottom-sheet-header .close-btn:hover {
    color: #FFFFFF;
}
.user-list {
    list-style: none;
    padding: 0;
    margin: 0;
    height: auto !important;
    max-height: none !important;
    overflow-y: visible !important;
    min-height: 48px;
}

.user-list li:last-child {
    border-bottom: none;
}
.user-list::-webkit-scrollbar {
    width: 8px;
}
.user-list::-webkit-scrollbar-track {
    background: var(--light-bg);
}
.user-list::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 4px;
}
.user-list::-webkit-scrollbar-thumb:hover {
    background: var(--text-color);
}




@media (max-width: 600px) {
    .profile-icon {
        width: 35px;
        height: 35px;
    }
    .bottom-sheet-content {
        max-height: none;
    }
    .bottom-sheet-header h3 {
        font-size: 16px;
        color: #5D4E41 !important;
    }
    .user-list {
        height: auto !important;
        max-height: none !important;
        overflow-y: visible !important;
        min-height: 48px;
    }
    .user-list li {
        font-size: 14px;
        padding: 12px 15px;
        border-bottom: 1px solid var(--secondary-color);
        color: #5D4E41 !important;
        cursor: pointer;
        transition: background 0.2s ease;
        background: var(--light-bg) !important;
    }
    .user-list li:hover {
        background: var(--secondary-color);
    }
    .user-list li:last-child {
        border-bottom: none;
    }
    .modal-content {
        width: 95%;
        padding: 15px;
    }
    .modal-content h3 {
        font-size: 16px;
    }
    .modal-content p {
        font-size: 14px;
    }
    .modal-actions button {
        padding: 6px 12px;
        font-size: 14px;
    }
    .modal-content select {
        font-size: 14px;
        padding: 6px;
    }
    .remove-user-btn, .edit-user-btn {
        background: #FBB740 !important; /* Yellow background like add user */
        color: #F5F5DC !important; /* Light beige icon/text */
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        padding: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
    }
    .remove-user-btn:hover, .edit-user-btn:hover {
        background: #5D4E41 !important; /* Grey/brown hover like add user */
        color: #F5F5DC !important;
    }
}

/* Make remove button (X) yellow and dark text */
.remove-user-btn {
    background: #FFC107;
    color: #212121;
}

    .footer-icon img {
        width: 35px;
        height: 35px;
    }


    .overdue-task {
  font-size: 13px;
  padding: 8px 10px;
}
.overdue-task .task-title {
  font-size: 14px;
}
.overdue-task .task-info {
  font-size: 12px;
}


}



.footer {
    z-index: 100;
}





/* Modal Base Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--modal-bg);
    z-index: 1100;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}
.modal.show {
    display: block;
    opacity: 1;
}
.modal-content {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--light-bg);
    border-radius: 12px;
    padding: 20px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(19, 19, 18, 0.2);
    border: 2px solid var(--secondary-color);
}
.modal-content h3 {
    margin: 0 0 15px;
    font-size: 18px;
    color: var(--text-color);
}
.modal-content p {
    margin: 0 0 15px;
    font-size: 16px;
    color: var(--text-color);
}
.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}
.modal-actions button {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
}
.modal-actions button:first-child {
    background: #D32F2F;
    color: white;
}
.modal-actions button:first-child:hover {
    background: #B71C1C;
}
.modal-actions button:last-child {
    background: var(--primary-color);
    color: var(--accent-color);
}
.modal-actions button:last-child:hover {
    background: var(--text-color);
}

/* Permission Modal Specific */
.modal-content select {
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    background: #333;
    color: var(--text-color);
    border: 1px solid var(--border-dark);
    margin-bottom: 15px;
    font-size: 16px;
}
#savePermissionBtn {
    background: var(--primary-color);
    color: #212121;
}
#savePermissionBtn:hover {
    background: #FFD54F;
}

/* User List Item Adjustments */
.user-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    border-bottom: 1px solid var(--secondary-color);
    font-size: 16px;
    color: #5D4E41 !important;
    cursor: pointer;
    transition: background 0.2s ease;
    background: var(--light-bg) !important;
}
.user-list li:hover {
    background: var(--secondary-color);
}
.user-list-item {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-grow: 1;
}
.user-list-actions {
    display: flex;
    gap: 8px;
}
.remove-user-btn, .edit-user-btn {
    background: #FBB740 !important;
    color: #F5F5DC !important;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
}
.edit-user-btn {
    background: #FBB740 !important;
}
/* Optional hover effects */
.remove-user-btn:hover {
    background: #5D4E41 !important;
    color: #F5F5DC !important;
}
.edit-user-btn:hover {
    background: #5D4E41 !important;
    color: #F5F5DC !important;
}



@media (max-width: 600px) {
  .remove-user-btn, .edit-user-btn {
    width: 20px;
    height: 20px;
    font-size: 12px;
  }
}






/* Add User Button in User Selection Modal */
/* Add User Button in User Selection Modal */
/* Add User Button in User Selection Modal */
/* Old add-user-btn styles replaced above */

/* Add User Modal */
.add-user-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--modal-bg);
  z-index: 1200;
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
}
.add-user-modal.show {
  display: block;
  opacity: 1;
}
.add-user-modal-content {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--light-bg);
  border-radius: 12px;
  padding: 20px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 4px 20px rgba(19, 19, 18, 0.2);
  border: 2px solid var(--secondary-color);
}
.add-user-modal-content h3 {
  margin: 0 0 15px;
  font-size: 18px;
  color: var(--text-color);
}
.add-user-modal-content input {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  background: var(--accent-color);
  color: var(--text-color);
  border: 2px solid var(--secondary-color);
  margin-bottom: 15px;
  font-size: 16px;
}
.add-user-modal-content .error-message {
  color: #D32F2F;
  font-size: 14px;
  margin-bottom: 10px;
  display: none;
}
.add-user-modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
.add-user-modal-actions button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s ease;
}
.add-user-modal-actions .cancel-btn {
  background: #D32F2F;
  color: white;
}
.add-user-modal-actions .cancel-btn:hover {
  background: #B71C1C;
}
.add-user-modal-actions .submit-btn {
  background: var(--primary-color);
  color: var(--accent-color);
}
.add-user-modal-actions .submit-btn:hover {
  background: var(--text-color);
}

/* Header Title Container for Select User and Add Button */
.header-title {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Update Bottom Sheet Header for New Layout */
.bottom-sheet-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  border-bottom: 1px solid var(--border-dark);
}

/* Responsive Adjustments */
@media (max-width: 600px) {
  .add-user-btn {
    width: 20px !important;
    height: 20px !important;
    font-size: 14px !important;
    background: #FBB740 !important;
    color: #F5F5DC !important;
  }
  .add-user-btn:hover {
    background: #5D4E41 !important;
    color: #F5F5DC !important;
  }
  .add-user-modal-content {
    width: 95%;
    padding: 15px;
  }
  .add-user-modal-content h3 {
    font-size: 16px;
  }
  .add-user-modal-content input {
    font-size: 14px;
    padding: 6px;
  }
  .add-user-modal-actions button {
    padding: 6px 12px;
    font-size: 14px;
  }
  .header-title {
    gap: 6px;
  }
  .header-title h3 {
    color: #5D4E41 !important;
    font-size: 16px;
  }
}


/* Right top corner Select User Menu ********************************************************/






/* Logout Button ****************************************************/
.logout-container {
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 150;
}

#logoutBtn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
    background: #FBB740;
    border: none;
    cursor: pointer;
    border-radius: 8px;
    width: 40px;
    height: 40px;
    box-sizing: border-box;
    transition: transform 0.3s ease;
}

#logoutBtn:hover {
    transform: scale(1.1);
}

.logout-icon {
    width: 24px;
    height: 24px;
    filter: brightness(0) saturate(100%) invert(100%);
    transition: transform 0.3s ease;
}

.logout-icon:hover {
    transform: scale(1.1);
}

/* Logout Button ****************************************************/


/* Selecting Parent/Child Bee */


/* Selecting Parent/Child Bee */
.radio-group {
  margin-top: 10px;
  margin-bottom: 10px;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
  font-size: 16px;
  color: var(--text-color);
  line-height: 1; /* Helps center text next to custom radio */
}

.radio-option input[type="radio"] {
  appearance: none;
  -webkit-appearance: none;
  background-color: #333;
  border: 2px solid var(--primary-color);
  border-radius: 50%;
  width: 18px;
  height: 18px;
  position: relative;
  cursor: pointer;
  display: inline-block;
  vertical-align: middle;
  margin: 0;
}

.radio-option input[type="radio"]::before {
  content: '';
  position: absolute;
  top: 3px; /* Adjust this to perfectly center the dot */
  left: 3px;
  width: 8px;
  height: 8px;
  background: var(--primary-color);
  border-radius: 50%;
  display: none;
}

.radio-option input[type="radio"]:checked::before {
  display: block;
}

.radio-option span {
  vertical-align: middle;
  display: inline-block;
  line-height: 1;
}
/* Selecting Parent/Child Bee */





/* Selecting Parent/Child Bee */





#adminSections {
  margin-top: 130px;
  padding-bottom: 80px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 20px 15px 80px;
}

.admin-card {
  background: #fff;
  color: #212121;
  border-radius: 12px;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.08);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.15s ease;
}

.admin-card:hover {
  transform: scale(1.01);
}

.card-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.card-icon {
  font-size: 20px;
}

.card-right {
  display: flex;
  align-items: center;
  gap: 6px;
  color: #444;
}

.card-count {
  font-weight: 500;
}

.card-arrow {
  font-size: 18px;
}



#overdueTasks {
  display: none;
  transition: all 0.3s ease;
}

/* Overdue task compact layout */
.overdue-task {
  background: #2A2B32;
  border: 1px solid var(--border-dark);
  border-radius: 10px;
  padding: 10px 12px;
  margin-top: 8px;
  color: white;
  font-size: 14px;
}
.overdue-task .task-title {
  font-weight: 600;
  font-size: 15px;
  margin: 0;
}
.overdue-task .task-info {
  font-style: italic;
  font-size: 13px;
  color: #ccc;
  margin-top: 4px;
}



.pending-task {
  background: #2A2B32;
  border: 1px solid var(--border-dark);
  border-radius: 10px;
  padding: 10px 12px;
  margin-top: 8px;
  color: white;
  font-size: 14px;
}
.pending-task .task-title {
  font-weight: 600;
  font-size: 15px;
  margin: 0;
}
.pending-task .task-info {
  font-style: italic;
  font-size: 13px;
  color: #ccc;
  margin-top: 4px;
}
.pending-task .task-actions {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}



/* Reward Request Styles */
.reward-request {
    background: #2A2B32;
    border: 1px solid var(--border-dark);
    border-radius: 10px;
    padding: 10px 12px;
    margin-top: 8px;
    color: white;
    font-size: 14px;
}
.reward-request .request-title {
    font-weight: 600;
    font-size: 15px;
    margin: 0;
}
.reward-request .request-info {
    font-style: italic;
    font-size: 13px;
    color: #ccc;
    margin-top: 4px;
}
.reward-request .request-actions {
    display: flex;
    gap: 10px;
    margin-top: 8px;
}
.reward-request .approve-btn {
    background-color: #4CAF50;
    color: white;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}
.reward-request .decline-btn {
    background-color: #D32F2F;
    color: white;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
}




.your-task {
    background: #2A2B32;
    border: 1px solid var(--border-dark);
    border-radius: 10px;
    padding: 10px 12px;
    margin-top: 8px;
    color: white;
    font-size: 14px;
}
.your-task .task-title {
    font-weight: 600;
    font-size: 15px;
    margin: 0;
}
.your-task .task-info {
    font-style: italic;
    font-size: 13px;
    color: #ccc;
    margin-top: 4px;
}



.complete-btn {
    background-color: #4CAF50;
    color: white;
    padding: 8px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 8px;
    font-size: 14px;
}
.complete-btn:hover {
    background-color: #333;
}


  </style>





</head>
    <body>
        <div class="date-header">
            <div id="profileIcon" class="profile-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                </svg>
            </div>

            <div id="logoutContainer" class="logout-container">


              <button id="logoutBtn" aria-label="Logout" title="Logout">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 logout-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H15" />
                  </svg>
              </button>
          </div>
            <div class="month-nav">
                <button id="prevMonth"><</button>
                <span id="monthLabel">Month</span>
                <button id="nextMonth">></button>
            </div>
            <div class="day-scroll-wrapper">
                <button class="scroll-btn" id="scrollLeft"><</button>
                <div class="day-scroll" id="dayScrollContainer"></div>
                <button class="scroll-btn" id="scrollRight">></button>
            </div>
        </div>



        <div id="adminSections">
          <div class="admin-card" id="approvalCard" style="flex-direction: column; align-items: stretch;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div class="card-left">
                <span class="card-icon">🕒</span>
                <span class="card-title">Tasks Needing Approval 11</span>
              </div>
              <div class="card-right">
                <span class="card-count" id="approvalCount">(0)</span>
                <span class="card-arrow" id="approvalArrow">›</span>
              </div>
            </div>
            <div id="pendingTasks" class="task-list" style="display: none; padding: 0 10px 10px;"></div>
          </div>

          <div class="admin-card" id="overdueCard" style="flex-direction: column; align-items: stretch;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div class="card-left">
                <span class="card-icon">⚠️</span>
                <span class="card-title">Overdue Tasks</span>
              </div>
              <div class="card-right">
                <span class="card-count" id="overdueCount">(0)</span>
                <span class="card-arrow" id="overdueArrow">›</span>
              </div>
            </div>
            <div id="overdueTasks" class="task-list" style="display: none; padding: 0 10px 10px;"></div>
          </div>


          <div class="admin-card" id="rewardCard" style="flex-direction: column; align-items: stretch;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="card-left">
                    <span class="card-icon">🎁</span>
                    <span class="card-title">Rewards Needing Approval</span>
                </div>
                <div class="card-right">
                    <span class="card-count" id="rewardCount">(0)</span>
                    <span class="card-arrow" id="rewardArrow">›</span>
                </div>
            </div>
            <div id="rewardTasks" class="task-list" style="display: none; padding: 0 10px 10px;"></div>
        </div>

          <div class="admin-card" id="yourCard" style="flex-direction: column; align-items: stretch;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div class="card-left">
                <span class="card-icon">👤</span>
                <span class="card-title">Your Tasks</span>
              </div>
              <div class="card-right">
                <span class="card-count" id="yourTaskCount">(0)</span>
                <span class="card-arrow" id="yourArrow">›</span>
              </div>
            </div>
            <div id="yourTasks" class="task-list" style="display: none; padding: 0 10px 10px;"></div>
          </div>







    <!-- User Selection Modal -->
    <div class="bottom-sheet" id="userSelectModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(19, 19, 18, 0.4); z-index: 1000; opacity: 0; transition: opacity 0.3s ease-in-out;">
      <div class="bottom-sheet-content" style="position: fixed; bottom: 0; left: 0; width: 100%; max-height: none; background: #FFFFF8; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -4px 20px rgba(19, 19, 18, 0.2); border: 2px solid #e4e3e0; transform: translateY(100%); transition: transform 0.3s ease-in-out;">
        <div class="bottom-sheet-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 2px solid #e4e3e0; background: #FFFFFF;">
          <div class="header-title" style="display: flex; align-items: center; gap: 10px;">
            <h3 style="color: #5D4E41 !important; margin: 0; font-size: 18px; font-weight: 600; display: inline-block;">Add User</h3>
            <button class="add-user-btn" id="addUserBtn" style="background: rgb(251, 183, 64) !important; color: rgb(245, 245, 220) !important; border: none !important; border-radius: 50% !important; width: 24px !important; height: 24px !important; font-size: 16px !important; font-weight: bold !important; cursor: pointer !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; margin-left: 10px;" onmouseover="this.style.setProperty('background', '#5D4E41', 'important'); this.style.setProperty('background-color', '#5D4E41', 'important');" onmouseout="this.style.setProperty('background', 'rgb(251, 183, 64)', 'important'); this.style.setProperty('background-color', 'rgb(251, 183, 64)', 'important');">+</button>
          </div>
          <button id="closeModalBtn" class="close-btn" aria-label="Close" style="background: none; border: none; color: #F5F5DC !important; font-size: 24px; cursor: pointer; padding: 5px;">✕</button>
        </div>
        <ul id="userList" class="user-list" style="list-style: none; padding: 0; margin: 0; height: auto !important; max-height: none !important; overflow-y: visible !important; min-height: 48px;"></ul>
      </div>
    </div>

<!-- Confirm Delete Modal -->
<!-- Confirm Delete Modal -->
<div class="modal" id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(19, 19, 18, 0.4); z-index: 1001; justify-content: center; align-items: center;">
  <div class="modal-content" style="background: #2A2B32; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6); border: 2px solid #444754; color: #FFFFFF;">
    <p style="color: #FFFFFF; margin-bottom: 20px; font-size: 16px;">Are you sure you want to delete this user?</p>
    <div class="modal-actions" style="display: flex; gap: 10px; justify-content: center;">
      <button id="confirmYesBtn" style="background: rgb(251, 183, 64); color: #212121; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Yes</button>
      <button id="confirmNoBtn" style="background: #444754; color: #FFFFFF; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">No</button>
    </div>
  </div>
</div>

<!-- Permission Modal -->
<div class="modal" id="permissionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(19, 19, 18, 0.4); z-index: 1001; justify-content: center; align-items: center;">
  <div class="modal-content" style="background: #FFFFF8; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6); border: 2px solid #e4e3e0; color: #5D4E41;">
    <h3 id="permissionModalUser" style="color: #5D4E41; margin-bottom: 15px; font-weight: 600;">Edit Bee</h3>
    <input type="text" id="editUserNameInput" placeholder="Bee name" style="width: 100%; padding: 10px 12px; margin: 10px 0; background: #FFFFF8; color: #5D4E41; border: 2px solid #e4e3e0; border-radius: 8px; font-size: 16px; outline: none; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);" />
    <div class="radio-group" style="margin-top: 15px;">
      <label class="radio-option" style="display: flex; align-items: center; margin-bottom: 12px; font-size: 16px; cursor: pointer; gap: 10px; color: #5D4E41;">
        <input type="radio" name="editBeeRole" value="Admin" id="editAdminRole" style="accent-color: rgb(251, 183, 64); width: 18px; height: 18px; cursor: pointer;">
        <span>Parent Bee</span>
      </label>
      <label class="radio-option" style="display: flex; align-items: center; margin-bottom: 12px; font-size: 16px; cursor: pointer; gap: 10px; color: #5D4E41;">
        <input type="radio" name="editBeeRole" value="User" id="editUserRole" style="accent-color: rgb(251, 183, 64); width: 18px; height: 18px; cursor: pointer;">
        <span>Child Bee</span>
      </label>
    </div>
    <p id="editErrorMessage" style="color: #D32F2F; font-size: 14px; display: none;">Please enter a valid name</p>
    <div class="modal-actions" style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
      <button id="savePermissionBtn" style="background: rgb(251, 183, 64); color: #5D4E41; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Save</button>
      <button id="cancelEditBtn" style="background: #e4e3e0; color: #5D4E41; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Cancel</button>
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal" id="addUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(19, 19, 18, 0.4); z-index: 1001; justify-content: center; align-items: center;">
  <div class="modal-content" style="background: #FFFFF8; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6); border: 2px solid #e4e3e0; color: #5D4E41;">
    <h3 style="color: #5D4E41; margin-bottom: 15px; font-weight: 600;">Add a Bee</h3>
    <input type="text" id="usernameInput" placeholder="Bee name" style="width: 100%; padding: 10px 12px; margin: 10px 0; background: #FFFFF8; color: #5D4E41; border: 2px solid #e4e3e0; border-radius: 8px; font-size: 16px; outline: none; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);" />
    <div class="radio-group" style="margin-top: 15px;">
      <label class="radio-option" style="display: flex; align-items: center; margin-bottom: 12px; font-size: 16px; cursor: pointer; gap: 10px; color: #5D4E41;">
        <input type="radio" name="beeRole" value="Admin" style="accent-color: rgb(251, 183, 64); width: 18px; height: 18px; cursor: pointer;">
        <span>Parent Bee</span>
      </label>
      <label class="radio-option" style="display: flex; align-items: center; margin-bottom: 12px; font-size: 16px; cursor: pointer; gap: 10px; color: #5D4E41;">
        <input type="radio" name="beeRole" value="User" checked style="accent-color: rgb(251, 183, 64); width: 18px; height: 18px; cursor: pointer;">
        <span>Child Bee</span>
      </label>
    </div>
    <p id="errorMessage" style="color: #D32F2F; font-size: 14px; display: none;">Please enter a valid name</p>
    <div class="modal-actions" style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
      <button id="submitUserBtn" style="background: rgb(251, 183, 64); color: #5D4E41; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Add</button>
      <button id="cancelUserBtn" style="background: #e4e3e0; color: #5D4E41; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Cancel</button>
    </div>
  </div>
</div>



<!-- User Selection ----------------------------->

  <div class="footer">
    <a href="#" id="homeButton" class="footer-icon active" aria-label="Home">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6" style="width: 24px; height: 24px;">
          <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
        </svg>
    </a>
    <a href="/BeeMazing-A1/mobile/3-Tasks/tasks.html" class="footer-icon" aria-label="Tasks">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6"  style="width: 24px; height: 24px;">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
        </svg>

  </a>
  <a href="/BeeMazing-A1/mobile/4-Market/market.html" class="footer-icon" aria-label="Market">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6" style="width: 24px; height:24px;">
        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 0 0 2.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 0 1 2.916.52 6.003 6.003 0 0 1-5.395 4.972m0 0a6.726 6.726 0 0 1-2.749 1.35m0 0a6.772 6.772 0 0 1-3.044 0" />
      </svg>

  </a>
</div>



  <script>






// Dynamically set footer button links and active state
const urlParams = new URLSearchParams(window.location.search);
const globalAdminEmail = urlParams.get('admin') || localStorage.getItem('currentAdminEmail') || '';
const userName = urlParams.get('user') || '';
const basePath = '/BeeMazing-A1/mobile/2-UserProfiles';

const homeButton = document.getElementById('homeButton');
const tasksButton = document.querySelector('a[href="/BeeMazing-A1/mobile/3-Tasks/tasks.html"]');
const marketButton = document.querySelector('a[href="/BeeMazing-A1/mobile/4-Market/market.html"]');
if (globalAdminEmail && userName) {
    homeButton.href = `${basePath}/userAdmin.html?admin=${encodeURIComponent(globalAdminEmail)}&user=${encodeURIComponent(userName)}`;
    tasksButton.href = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?admin=${encodeURIComponent(globalAdminEmail)}&user=${encodeURIComponent(userName)}`;
    marketButton.href = `/BeeMazing-A1/mobile/4-Market/market.html?admin=${encodeURIComponent(globalAdminEmail)}&user=${encodeURIComponent(userName)}`;
}


// Fetch users from server (adapted from home.js)
async function fetchUsersFromServer(email) {
    try {
        const res = await fetch(`https://beemazing1.onrender.com/get-users?adminEmail=${encodeURIComponent(email)}`);
        const data = await res.json();
        if (data.success) {
            const allUserData = JSON.parse(localStorage.getItem("userData")) || {};
            if (!allUserData[email]) {
                allUserData[email] = { users: [], permissions: {} };
            }
            allUserData[email].users = data.users || [];
            allUserData[email].permissions = data.permissions || {};
            localStorage.setItem("userData", JSON.stringify(allUserData));
            return data.users || [];
        }
        return [];
    } catch (err) {
        console.error("Failed to fetch users:", err);
        return [];
    }
}



// User selection ///////////////////////////////////////////////////////////////////////






// Helper function to delete a user from the server
async function deleteUserFromServer(username) {
    const adminEmail = globalAdminEmail;
    try {
        const res = await fetch(
            `https://beemazing1.onrender.com/delete-user?adminEmail=${encodeURIComponent(adminEmail)}&username=${encodeURIComponent(username)}`,
            {
                method: "DELETE",
                headers: { "Content-Type": "application/json" }
            }
        );
        const result = await res.json();
        if (result.success) {
            const allUserData = JSON.parse(localStorage.getItem("userData")) || {};
            let users = allUserData[adminEmail]?.users || [];
            users = users.filter(user => user !== username);
            allUserData[adminEmail].users = users;
            localStorage.setItem("userData", JSON.stringify(allUserData));
            return true;
        } else {
            console.error("Failed to delete user: " + result.message);
            return false;
        }
    } catch (err) {
        console.error("Failed to delete user:", err);
        return false;
    }
}

// Setup user management immediately
console.log("🔧 Setting up user management...");
alert("🔧 UserAdmin.html JavaScript is running!");

// Get adminEmail from the URL params or localStorage
const urlParams = new URLSearchParams(window.location.search);
const adminEmail = urlParams.get('admin') || localStorage.getItem('currentAdminEmail') || '';

console.log("🔧 Admin email:", adminEmail);
alert("🔧 Admin email: " + adminEmail);

if (!adminEmail) {
    console.error("No admin email found. User management disabled.");
} else {
    let userToRemove = null;
    let selectedUserForPermission = null;

    function showConfirmModal(username) {
        userToRemove = username;
        const confirmModal = document.getElementById("confirmModal");
        confirmModal.style.display = "flex";
    }

    function showPermissionModal(username) {
        selectedUserForPermission = username;
        const permissionModalUser = document.getElementById("permissionModalUser");
        const editUserNameInput = document.getElementById("editUserNameInput");
        const editAdminRole = document.getElementById("editAdminRole");
        const editUserRole = document.getElementById("editUserRole");
        const editErrorMessage = document.getElementById("editErrorMessage");
        
        permissionModalUser.textContent = `Edit Bee`;
        editUserNameInput.value = username;
        editErrorMessage.style.display = "none";
        
        const allUserData = JSON.parse(localStorage.getItem("userData")) || {};
        const userPermissions = allUserData[adminEmail]?.permissions || {};
        const currentRole = userPermissions[username] || "User";
        
        if (currentRole === "Admin") {
            editAdminRole.checked = true;
        } else {
            editUserRole.checked = true;
        }
        
        const permissionModal = document.getElementById("permissionModal");
        permissionModal.style.display = "flex";
    }

    // Add User button functionality
    const addUserBtnInModal = document.getElementById("addUserBtn");
    const addUserModal = document.getElementById("addUserModal");
    const submitUserBtn = document.getElementById("submitUserBtn");
    const cancelUserBtn = document.getElementById("cancelUserBtn");
    const usernameInput = document.getElementById("usernameInput");
    const errorMessage = document.getElementById("errorMessage");

    console.log("🔧 Add user button element:", addUserBtnInModal);
    console.log("🔧 Add user modal element:", addUserModal);

    if (addUserBtnInModal) {
        console.log("🔧 Setting up add user button click handler");
        addUserBtnInModal.addEventListener("click", () => {
            console.log("🔧 Add user button clicked!");
            addUserModal.style.display = "flex";
            usernameInput.value = "";
            errorMessage.style.display = "none";
            document.querySelector('input[name="beeRole"][value="User"]').checked = true;
        });

        console.log("🔧 User management setup complete");
    } else {
        console.error("🔧 Add user button not found!");
    }

    if (cancelUserBtn) {
        cancelUserBtn.addEventListener("click", () => {
            addUserModal.style.display = "none";
        });
    }

    // Add user modal click outside to close
    if (addUserModal) {
        addUserModal.addEventListener("click", (e) => {
            if (e.target === addUserModal) {
                addUserModal.style.display = "none";
            }
        });
    }

    // Submit new user
    if (submitUserBtn) {
        submitUserBtn.addEventListener("click", async () => {
            const username = usernameInput.value.trim();
            
            if (!username) {
                errorMessage.style.display = "block";
                return;
            }

            if (!adminEmail) {
                alert("Error: Admin session expired. Please log in again.");
                window.location.href = "/BeeMazing-A1/login.html";
                return;
            }

            errorMessage.style.display = "none";
            const selectedRole = document.querySelector('input[name="beeRole"]:checked')?.value || "User";

            try {
                const res = await fetch("https://beemazing1.onrender.com/add-user", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        adminEmail: adminEmail,
                        newUser: username,
                        role: selectedRole
                    })
                });

                const result = await res.json();

                if (result.success) {
                    const allUserData = JSON.parse(localStorage.getItem("userData")) || {};
                    if (!allUserData[adminEmail]) {
                        allUserData[adminEmail] = { users: [], permissions: {} };
                    }

                    allUserData[adminEmail].users.push(username);
                    allUserData[adminEmail].permissions[username] = selectedRole;
                    localStorage.setItem("userData", JSON.stringify(allUserData));

                    addUserModal.style.display = "none";
                    alert(`${username} has been added as a ${selectedRole}!`);
                    
                    // Refresh the user list by clicking profile icon again
                    profileIcon.click();
                } else {
                    alert("Failed to add user: " + result.message);
                }
            } catch (err) {
                alert("Error adding user. Please try again.");
            }
        });
    }

    // Helper function to ensure proper modal styling
    function applyModalStyling() {
        try {
            const text = document.querySelector('.bottom-sheet-header h3');
            if (text) {
                text.style.setProperty('color', '#5D4E41', 'important');
            }
            
            const closeBtn = document.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.style.setProperty('color', '#F5F5DC', 'important');
            }
            
            const userListItems = document.querySelectorAll('.user-list li');
            userListItems.forEach(item => {
                if (!item.style.getPropertyValue('background')) {
                    item.style.setProperty('background', '#FFFFF8', 'important');
                }
            });
        } catch (e) {
            // Styling error - ignore
        }
    }

    // User selection modal functionality
    const isAdmin = localStorage.getItem("isAdmin") === "true";
    const profileIcon = document.getElementById("profileIcon");
    const userSelectModal = document.getElementById("userSelectModal");
    const userList = document.getElementById("userList");
    const closeModalBtn = document.getElementById("closeModalBtn");

    console.log("🔧 Profile icon element:", profileIcon);
    console.log("🔧 User select modal element:", userSelectModal);
    console.log("🔧 User list element:", userList);
    console.log("🔧 Close modal btn element:", closeModalBtn);

    // Profile icon functionality - same as market.html
    if (profileIcon) {
        console.log("🔧 Setting up profile icon click handler");
        profileIcon.addEventListener("click", async (event) => {
            console.log("🔧 Profile icon clicked!");
            event.preventDefault();
            event.stopPropagation();
            
            if (!adminEmail) {
                alert("Admin email not found. Please log in again.");
                return;
            }
            
            try {
                const res = await fetch(`https://beemazing1.onrender.com/get-users?adminEmail=${encodeURIComponent(adminEmail)}`);
                const data = await res.json();
                if (!res.ok || !data.users) throw new Error("Failed to fetch users");

                const allUserData = JSON.parse(localStorage.getItem("userData")) || {};
                const userPermissions = allUserData[adminEmail]?.permissions || data.permissions || {};
                const user = urlParams.get('user') || localStorage.getItem("currentUser");

                userList.innerHTML = "";
                
                data.users.forEach(userName => {
                    const li = document.createElement("li");
                    li.style.setProperty('color', '#5D4E41', 'important');
                    
                    const nameContainer = document.createElement("div");
                    nameContainer.classList.add("user-list-item");
                    const userNameSpan = document.createElement("span");
                    userNameSpan.textContent = userName;
                    userNameSpan.style.setProperty('color', '#5D4E41', 'important');
                    nameContainer.appendChild(userNameSpan);
                    
                    if (userPermissions[userName] === "Admin") {
                        const checkmark = document.createElement("span");
                        checkmark.textContent = "✓";
                        checkmark.style.color = "#00C4B4";
                        checkmark.style.fontSize = "16px";
                        checkmark.style.fontWeight = "bold";
                        checkmark.title = "Admin";
                        nameContainer.appendChild(checkmark);
                    }
                    
                    li.appendChild(nameContainer);
                    
                    // Add settings and delete buttons - check if user is admin
                    const isLoggedInAsAdmin = localStorage.getItem("isAdmin") === "true";
                    if (isLoggedInAsAdmin) {
                        const actionsContainer = document.createElement("div");
                        actionsContainer.style.setProperty('display', 'flex', 'important');
                        actionsContainer.style.setProperty('gap', '8px', 'important');
                        
                        const editBtn = document.createElement("button");
                        editBtn.innerHTML = "⚙️";
                        editBtn.style.setProperty('background', 'rgb(251, 183, 64)', 'important');
                        editBtn.style.setProperty('color', 'rgb(245, 245, 220)', 'important');
                        editBtn.style.setProperty('border', 'none', 'important');
                        editBtn.style.setProperty('border-radius', '50%', 'important');
                        editBtn.style.setProperty('width', '30px', 'important');
                        editBtn.style.setProperty('height', '30px', 'important');
                        editBtn.style.setProperty('font-size', '14px', 'important');
                        editBtn.style.setProperty('cursor', 'pointer', 'important');
                        editBtn.style.setProperty('display', 'flex', 'important');
                        editBtn.style.setProperty('align-items', 'center', 'important');
                        editBtn.style.setProperty('justify-content', 'center', 'important');
                        editBtn.onmouseover = function() { 
                            this.style.setProperty('background', '#5D4E41', 'important'); 
                            this.style.setProperty('background-color', '#5D4E41', 'important'); 
                        };
                        editBtn.onmouseout = function() { 
                            this.style.setProperty('background', 'rgb(251, 183, 64)', 'important'); 
                            this.style.setProperty('background-color', 'rgb(251, 183, 64)', 'important'); 
                        };
                        editBtn.addEventListener("click", (event) => {
                            console.log("🔧 Edit button clicked for:", userName);
                            event.stopPropagation();
                            showPermissionModal(userName);
                        });
                        
                        const removeBtn = document.createElement("button");
                        removeBtn.textContent = "X";
                        removeBtn.style.setProperty('background', 'rgb(251, 183, 64)', 'important');
                        removeBtn.style.setProperty('color', 'rgb(245, 245, 220)', 'important');
                        removeBtn.style.setProperty('border', 'none', 'important');
                        removeBtn.style.setProperty('border-radius', '50%', 'important');
                        removeBtn.style.setProperty('width', '30px', 'important');
                        removeBtn.style.setProperty('height', '30px', 'important');
                        removeBtn.style.setProperty('font-size', '14px', 'important');
                        removeBtn.style.setProperty('font-weight', 'bold', 'important');
                        removeBtn.style.setProperty('cursor', 'pointer', 'important');
                        removeBtn.style.setProperty('display', 'flex', 'important');
                        removeBtn.style.setProperty('align-items', 'center', 'important');
                        removeBtn.style.setProperty('justify-content', 'center', 'important');
                        removeBtn.onmouseover = function() { 
                            this.style.setProperty('background', '#5D4E41', 'important'); 
                            this.style.setProperty('background-color', '#5D4E41', 'important'); 
                        };
                        removeBtn.onmouseout = function() { 
                            this.style.setProperty('background', 'rgb(251, 183, 64)', 'important'); 
                            this.style.setProperty('background-color', 'rgb(251, 183, 64)', 'important'); 
                        };
                        removeBtn.addEventListener("click", (event) => {
                            console.log("🔧 Delete button clicked for:", userName);
                            event.stopPropagation();
                            showConfirmModal(userName);
                        });
                        
                        actionsContainer.appendChild(editBtn);
                        actionsContainer.appendChild(removeBtn);
                        li.appendChild(actionsContainer);
                    }
                    
                    // Highlight current user
                    if (userName === user) {
                        li.classList.add('active-user');
                        li.style.setProperty('background-color', 'rgb(251, 183, 64)', 'important');
                        li.style.setProperty('background', 'rgb(251, 183, 64)', 'important');
                        li.style.setProperty('color', '#5D4E41', 'important');
                        li.style.setProperty('font-weight', '600', 'important');
                    }
                    
                    li.addEventListener("click", async (clickEvent) => {
                        // Prevent default behavior
                        clickEvent.preventDefault();
                        clickEvent.stopPropagation();
                        
                        const isAdminUser = userPermissions[userName] === "Admin";
                        const basePath = "/BeeMazing-A1/mobile";
                        const currentLoggedInAsAdmin = localStorage.getItem("isAdmin") === "true";

                        if (isAdminUser) {
                            if (currentLoggedInAsAdmin) {
                                // Admin clicking on admin user - direct access
                                window.location.href = `${basePath}/2-UserProfiles/userAdmin.html?admin=${encodeURIComponent(adminEmail)}&user=${encodeURIComponent(userName)}`;
                            } else {
                                // Child clicking on admin user - need password
                                const enteredPassword = prompt("Enter Parent Password to access Admin profile:");
                                if (!enteredPassword) {
                                    alert("Password is required to access Admin profile.");
                                    return;
                                }
                                try {
                                    const res = await fetch(`https://beemazing1.onrender.com/verify-admin-password`, {
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        body: JSON.stringify({ email: adminEmail, password: enteredPassword }),
                                    });
                                    const verifyData = await res.json();
                                    if (res.ok && verifyData.success) {
                                        window.location.href = `${basePath}/2-UserProfiles/userAdmin.html?admin=${encodeURIComponent(adminEmail)}&user=${encodeURIComponent(userName)}`;
                                    } else {
                                        alert(verifyData.message || "Incorrect password. Access denied.");
                                    }
                                } catch (err) {
                                    alert("Failed to verify password. Please check your connection.");
                                }
                            }
                        } else {
                            // Regular user - direct access to users.html
                            window.location.href = `${basePath}/2-UserProfiles/users.html?admin=${encodeURIComponent(adminEmail)}&user=${encodeURIComponent(userName)}`;
                        }
                    });
                    
                    userList.appendChild(li);
                });

                // Show modal with force inline styles
                userSelectModal.style.display = 'block';
                userSelectModal.style.opacity = '1';
                userSelectModal.classList.add("show");
                
                const bottomSheetContent = userSelectModal.querySelector('.bottom-sheet-content');
                if (bottomSheetContent) {
                    bottomSheetContent.style.transform = 'translateY(0)';
                }
                
                // Apply styling after modal opens
                setTimeout(applyModalStyling, 10);
            } catch (err) {
                userList.innerHTML = '<li style="padding: 15px; color: #D32F2F;">Failed to load users</li>';
                userSelectModal.style.display = 'block';
                userSelectModal.style.opacity = '1';
                userSelectModal.classList.add("show");
            }
        });
    }

    // Modal close functionality
    if (userSelectModal) {
        userSelectModal.addEventListener("click", (e) => {
            if (e.target === userSelectModal) {
                userSelectModal.style.display = 'none';
                userSelectModal.style.opacity = '0';
                userSelectModal.classList.remove("show");
                const bottomSheetContent = userSelectModal.querySelector('.bottom-sheet-content');
                if (bottomSheetContent) {
                    bottomSheetContent.style.transform = 'translateY(100%)';
                }
            }
        });
    }

    if (closeModalBtn) {
        closeModalBtn.addEventListener("click", () => {
            userSelectModal.style.display = 'none';
            userSelectModal.style.opacity = '0';
            userSelectModal.classList.remove("show");
            const bottomSheetContent = userSelectModal.querySelector('.bottom-sheet-content');
            if (bottomSheetContent) {
                bottomSheetContent.style.transform = 'translateY(100%)';
            }
        });
    }

    // Confirm Delete Modal event listeners
    const confirmModal = document.getElementById("confirmModal");
    const confirmYesBtn = document.getElementById("confirmYesBtn");
    const confirmNoBtn = document.getElementById("confirmNoBtn");

    confirmYesBtn.addEventListener("click", async () => {
        if (userToRemove) {
            const success = await deleteUserFromServer(userToRemove);
            if (success) {
                userToRemove = null;
                confirmModal.style.display = "none";
                // Refresh the user list by clicking profile icon again
                profileIcon.click();
            }
        }
    });

    confirmNoBtn.addEventListener("click", () => {
        userToRemove = null;
        confirmModal.style.display = "none";
    });

    confirmModal.addEventListener("click", (e) => {
        if (e.target === confirmModal) {
            userToRemove = null;
            confirmModal.style.display = "none";
        }
    });

    // Permission Modal event listeners
    const permissionModal = document.getElementById("permissionModal");
    const savePermissionBtn = document.getElementById("savePermissionBtn");

    if (savePermissionBtn) {
        savePermissionBtn.addEventListener("click", async () => {
            if (selectedUserForPermission) {
                const editUserNameInput = document.getElementById("editUserNameInput");
                const editErrorMessage = document.getElementById("editErrorMessage");
                const newName = editUserNameInput.value.trim();
                
                if (!newName) {
                    editErrorMessage.style.display = "block";
                    return;
                }
                
                editErrorMessage.style.display = "none";
                const newPermission = document.querySelector('input[name="editBeeRole"]:checked')?.value || "User";
                const oldName = selectedUserForPermission;
                
                try {
                    const roleText = newPermission === "Admin" ? "Parent Bee" : "Child Bee";
                    
                    // If name changed, delete old user and add new one
                    if (oldName !== newName) {
                        // Delete old user
                        const deleteRes = await fetch(
                            `https://beemazing1.onrender.com/delete-user?adminEmail=${encodeURIComponent(adminEmail)}&username=${encodeURIComponent(oldName)}`,
                            {
                                method: "DELETE",
                                headers: { "Content-Type": "application/json" }
                            }
                        );
                        
                        // Add new user with new name and role
                        const addRes = await fetch("https://beemazing1.onrender.com/add-user", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                adminEmail: adminEmail,
                                newUser: newName,
                                role: newPermission
                            })
                        });
                        
                        const addResult = await addRes.json();
                        if (addResult.success) {
                            alert(`User updated! Name changed to "${newName}" and role set to ${roleText}.`);
                        } else {
                            alert("Failed to update user name: " + addResult.message);
                        }
                    } else {
                        // Only role changed, update permissions
                        const allUserData = JSON.parse(localStorage.getItem("userData")) || {};
                        if (!allUserData[adminEmail]) {
                            allUserData[adminEmail] = { users: [], permissions: {} };
                        }
                        allUserData[adminEmail].permissions[newName] = newPermission;
                        localStorage.setItem("userData", JSON.stringify(allUserData));
                        
                        const res = await fetch("https://beemazing1.onrender.com/save-permissions", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                adminEmail: adminEmail,
                                permissions: allUserData[adminEmail].permissions
                            })
                        });
                        const result = await res.json();
                        
                        if (result.success) {
                            alert(`User updated! ${newName} is now a ${roleText}.`);
                        } else {
                            alert(`Local changes saved. Role updated to ${roleText}.`);
                        }
                    }
                    
                    // Update localStorage regardless
                    const allUserData = JSON.parse(localStorage.getItem("userData")) || {};
                    if (!allUserData[adminEmail]) {
                        allUserData[adminEmail] = { users: [], permissions: {} };
                    }
                    
                    if (oldName !== newName) {
                        const userIndex = allUserData[adminEmail].users.indexOf(oldName);
                        if (userIndex !== -1) {
                            allUserData[adminEmail].users[userIndex] = newName;
                        }
                        delete allUserData[adminEmail].permissions[oldName];
                    }
                    allUserData[adminEmail].permissions[newName] = newPermission;
                    localStorage.setItem("userData", JSON.stringify(allUserData));
                    
                } catch (err) {
                    const roleText = newPermission === "Admin" ? "Parent Bee" : "Child Bee";
                    alert(`Error updating user. Please try again.`);
                }
                
                selectedUserForPermission = null;
                permissionModal.style.display = "none";
                profileIcon.click();
            }
        });
    }

    // Cancel edit button
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    if (cancelEditBtn) {
        cancelEditBtn.addEventListener("click", () => {
            selectedUserForPermission = null;
            permissionModal.style.display = "none";
        });
    }

    // Permission modal click outside to close
    if (permissionModal) {
        permissionModal.addEventListener("click", (e) => {
            if (e.target === permissionModal) {
                selectedUserForPermission = null;
                permissionModal.style.display = "none";
            }
        });
    }
}



// User selection ///////////////////////////////////////////////////////////////////////



// Logout Button
const logoutBtn = document.getElementById("logoutBtn");
logoutBtn.addEventListener("click", () => {
    // Only remove login session info
    localStorage.removeItem("isAdmin");
    localStorage.removeItem("userData");
    localStorage.removeItem("adminPassword");
    // Keep currentAdminEmail as per home.js
    window.location.href = "/BeeMazing-A1/login.html";
});




// Set active state
document.querySelectorAll('.footer a').forEach(link => {
    const currentPath = window.location.pathname.replace(/\/$/, '');
    const linkPath = new URL(link.href, window.location.origin).pathname.replace(/\/$/, '');
    if (currentPath === linkPath) {
        link.classList.add('active');
    } else {
        link.classList.remove('active');
    }
});





        let selectedDate = new Date().toLocaleDateString("sv-SE");
let allUsers = [];
const expandedTasks = new Set();

// Use the global adminEmail for tasks
if (globalAdminEmail) {
    fetchUsersFromServer(globalAdminEmail).then(users => {
        allUsers = users;
        try {
            generateScrollableDates();
        } catch (err) {
            console.error("Error in generateScrollableDates:", err);
        }
    }).catch(err => {
        console.error("Error fetching users:", err);
    });
}







// addtasks.html Settings: Rotation //////////////////////////////////////////////////////////////////////////////////////////





async function handleDecision(title, date, index, decision, user, event) {
  try {
    const button = event.target;
    const taskEntry = button.closest(".pending-task") || button.closest(".task-entry");
    const buttons = taskEntry.querySelectorAll("button");
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = "0.5";
    });

    // Fetch task data to check completion status
    const res = await fetch(`https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(globalAdminEmail)}&t=${Date.now()}`);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Failed to load tasks");

    const task = data.tasks.find(t => t.title === title && t.date.includes(date));
    if (!task) throw new Error("Task not found");

    const turnData = task.settings?.includes("Individual") ? individualTurnData(task, selectedDate) : null;
    if (!turnData) throw new Error("Invalid turn data");

    // Find the turn to get repetition
    const turn = turnData.turns[index];
    if (!turn) throw new Error("Invalid turn index");

    // Check if user has already completed the required number of turns
    const userCompletions = turnData.turns.filter(t => t.user === user && t.isCompleted).length;
    const requiredTimes = task.timesPerDay || 1;

    if (decision === "accept" && userCompletions >= requiredTimes) {
      throw new Error("User has already completed the maximum number of tasks for this day");
    }

    const response = await fetch("https://beemazing1.onrender.com/api/review-task", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        adminEmail: globalAdminEmail,
        title,
        date,
        selectedDate,
        user,
        decision,
        index: parseInt(index),
        repetition: turn.repetition
      })
    });

    const reviewData = await response.json();
    if (!response.ok) throw new Error(reviewData.error || "Failed to process decision");

    setTimeout(() => {
      try { loadTasks(); } catch (err) { console.error("Error in loadTasks:", err); }
      try { loadPendingTasks(); } catch (err) { console.error("Error in loadPendingTasks:", err); }
      try { loadOverdueTasks(); } catch (err) { console.error("Error in loadOverdueTasks:", err); }
    }, 500);
  } catch (err) {
    console.error("Error processing decision:", err);
    const errorDiv = document.createElement("div");
    errorDiv.style.color = "red";
    errorDiv.textContent = `Error: ${err.message}`;
    taskEntry.appendChild(errorDiv);
    taskEntry.querySelectorAll("button").forEach(btn => {
      btn.disabled = false;
      btn.style.opacity = "1";
    });
    setTimeout(() => errorDiv.remove(), 3000);
  }
}









async function handleReplace(title, date, index, user, event) {
  const taskEntry = event.target.closest(".task-entry");
  const select = taskEntry.querySelector(`#replace-select-${index}`);
  const newUser = select.value;

  // Validate new user
  if (!newUser || newUser === user) {
    const errorDiv = document.createElement("div");
    errorDiv.style.color = "red";
    errorDiv.textContent = "Please select a different user.";
    taskEntry.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 3000);
    return;
  }
  if (!allUsers.includes(newUser)) {
    const errorDiv = document.createElement("div");
    errorDiv.style.color = "red";
    errorDiv.textContent = "Invalid user selected.";
    taskEntry.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 3000);
    return;
  }

  try {
    const response = await fetch("https://beemazing1.onrender.com/api/replace-user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        adminEmail: globalAdminEmail,
        title,
        date,
        selectedDate,
        index: parseInt(index),
        originalUser: user,
        newUser
      })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || "Failed to replace user");

    // Update UI only after server confirmation
    const turnEntry = taskEntry.querySelector(`.turn-entry[data-index="${index}"]`);
    turnEntry.querySelector("p").textContent = `Turn ${parseInt(index) + 1}: ${newUser} - Pending`;
    turnEntry.querySelector("select").value = "";
    turnEntry.dataset.user = newUser;
    setTimeout(() => loadTasks(), 500);
  } catch (err) {
    console.error("Error replacing user:", err);
    const errorDiv = document.createElement("div");
    errorDiv.style.color = "red";
    errorDiv.textContent = `Error: ${err.message}`;
    taskEntry.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 3000);
  }
}


// addtasks.html Settings: Rotation //////////////////////////////////////////////////////////////////////////////////////////


//--

async function handleRevert(title, date, index, user, event) {
  try {
    const button = event.target;
    const taskEntry = button.closest(".task-entry");
    const buttons = taskEntry.querySelectorAll("button");
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = "0.5";
    });

    const response = await fetch("https://beemazing1.onrender.com/api/revert-decision", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        adminEmail: globalAdminEmail,
        title,
        date,
        selectedDate,
        user
      })
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || "Failed to revert decision");

    setTimeout(() => loadTasks(), 500);
  } catch (err) {
    console.error("Error reverting decision:", err);
    const errorDiv = document.createElement("div");
    errorDiv.style.color = "red";
    errorDiv.textContent = `Error: ${err.message}`;
    taskEntry.appendChild(errorDiv);
    taskEntry.querySelectorAll("button").forEach(btn => {
      btn.disabled = false;
      btn.style.opacity = "1";
    });
    setTimeout(() => errorDiv.remove(), 3000);
  }
}

//---


// addtasks.html Settings: Rotation //////////////////////////////////////////////////////////////////////////////////////////

async function loadTasks() {
  try {
    const container = document.getElementById("taskContainer");
    if (!container) {
      console.log("Task container not found, skipping load");
      return;
    }

    const res = await fetch(`https://beemazing1.onrender.com/get-tasks?adminEmail=${encodeURIComponent(globalAdminEmail)}&t=${Date.now()}`, {
      cache: "no-store"
    });
    if (!res.ok) throw new Error(`HTTP error ${res.status}`);
    const { tasks } = await res.json();

    // Filter tasks using filterTasksForDate from taskrotations.js
    const filteredTasks = filterTasksForDate(tasks, selectedDate);
    container.innerHTML = ""; // Clear UI

    if (filteredTasks.length === 0) {
      container.innerHTML = "<p>No tasks for this date.</p>";
      return;
    }

    filteredTasks.forEach(task => {
      if (!task.title || !task.users || !task.date) {
        console.warn(`Skipping invalid task:`, task);
        return;
      }

      let turnData;
      if (task.settings?.includes("Rotation")) {
        if (typeof mixedTurnData !== 'function') {
          console.error(`mixedTurnData is not defined for task: ${task.title}`);
          turnData = { turns: [], completedCount: 0, requiredTimes: 1 };
        } else {
          turnData = mixedTurnData(task, selectedDate);
        }
      } else if (task.settings?.includes("Individual")) {
        if (typeof individualTurnData !== 'function') {
          console.error(`individualTurnData is not defined for task: ${task.title}`);
          turnData = { turns: [], completedCount: 0, requiredTimes: 1 };
        } else {
          turnData = individualTurnData(task, selectedDate);
        }
      } else {
        console.warn(`Unsupported task settings for ${task.title}: ${task.settings}`);
        turnData = { turns: [], completedCount: 0, requiredTimes: 1 };
      }

      const pendingCount = turnData.turns.filter(t => t.isPending).length;
      const div = document.createElement("div");
      div.className = "task-entry";
      div.dataset.title = task.title;
      div.dataset.date = task.date;
      div.innerHTML = `
        <h3 class="task-title">${task.title}${pendingCount > 0 ? `<span class="notification-bubble">${pendingCount}</span>` : ''}</h3>
        <div class="task-details${expandedTasks.has(task.title) ? ' show' : ''}">
          ${
            turnData.turns.length && turnData.turns[0].repetition !== undefined && turnData.turns[0].user !== undefined
              ? (task.settings.includes("Rotation")
                ? turnData.turns.map(turn => `
                  <div class="turn-entry" data-index="${turn.index}" data-user="${turn.user}">
                    <p>Turn ${turn.index + 1}: ${turn.user} - ${turn.isCompleted ? 'Accepted' : turn.isPending ? 'Waiting for Review' : 'Pending'}</p>
                    ${turn.isPending && !turn.isCompleted ? `
                      <button class="accept-btn" onclick="handleDecision('${task.title}', '${task.date}', ${turn.index}, 'accept', '${turn.user}', event)">Accept</button>
                      <button class="decline-btn" onclick="handleDecision('${task.title}', '${task.date}', ${turn.index}, 'decline', '${turn.user}', event)">Decline</button>
                    ` : turn.isCompleted ? `
                      <button class="revert-btn" onclick="handleRevert('${task.title}', '${task.date}', ${turn.index}, '${turn.user}', event)">Revert</button>
                    ` : `

                    <!-- replace user -->
                      <select id="replace-select-${turn.index}">
                        <option value="">Select User</option>
                        ${allUsers.map(u => `<option value="${u}">${u}</option>`).join('')}
                      </select>
                      <button class="replace-btn" onclick="handleReplace('${task.title}', '${task.date}', ${turn.index}, '${turn.user}', event)">Replace</button>
                    <!-- replace user -->

                      `}
                  </div>
                `).join('')
                : task.users.map(user => {
                    const userTurns = turnData.turns.filter(t => t.user === user);
                    return `
                      <h4 style="margin-top: 10px;">${user}</h4>
                      ${userTurns.map(turn => `
                        <div class="turn-entry" draggable="false" data-index="${turn.index}" data-user="${turn.user}">
                          <p>Attempt ${turn.repetition}: ${turn.isCompleted ? 'Accepted' : turn.isPending ? 'Waiting for Review' : 'Pending'}</p>
                          ${turn.isPending && !turn.isCompleted ? `
                            <button class="accept-btn" onclick="handleDecision('${task.title}', '${task.date}', ${turn.index}, 'accept', '${turn.user}', event)">Accept</button>
                            <button class="decline-btn" onclick="handleDecision('${task.title}', '${task.date}', ${turn.index}, 'decline', '${turn.user}', event)">Decline</button>
                          ` : turn.isCompleted ? `
                            <button class="revert-btn" onclick="handleRevert('${task.title}', '${task.date}', ${turn.index}, '${turn.user}', event)">Revert</button>
                          ` : `

                          <!-- replace user -->
                            <select id="replace-select-${turn.index}">
                              <option value="">Select User</option>
                              ${allUsers.map(u => `<option value="${u}">${u}</option>`).join('')}
                            </select>
                            <button class="replace-btn" onclick="handleReplace('${task.title}', '${task.date}', ${turn.index}, '${turn.user}', event)">Replace</button>
                             <!-- replace user -->

                            `}
                        </div>
                      `).join('')}
                    `;
                  }).join(''))
              : '<p>No turns assigned.</p>'
          }
        </div>
      `;
      container.appendChild(div);

      div.querySelector(".task-title").addEventListener("click", () => {
        const details = div.querySelector(".task-details");
        details.classList.toggle("show");
        if (details.classList.contains("show")) {
          expandedTasks.add(task.title);
        } else {
          expandedTasks.delete(task.title);
        }
      });
    });
  } catch (err) {
    console.error("Error loading tasks:", err);
    const errorContainer = document.getElementById("taskContainer");
    if (errorContainer) {
      errorContainer.innerHTML = "<p>Error loading tasks. Please try again.</p>";
    }
  }
}

// addtasks.html Settings: Rotation //////////////////////////////////////////////////////////////////////////////////////////







async function loadYourTasks() {
    const adminEmail = globalAdminEmail;
    const urlParams = new URLSearchParams(window.location.search);
    let currentUser = urlParams.get("user") || localStorage.getItem("currentUser");

    const yourContainer = document.getElementById("yourTasks");
    yourContainer.innerHTML = "<p>Loading...</p>";

    // Save current user if provided
    if (currentUser) {
        localStorage.setItem("currentUser", currentUser);
    } else {
        yourContainer.innerHTML = "<p>Error: No user selected. Please select a user.</p>";
        return;
    }

    // Admin email is already set from globalAdminEmail

    if (!adminEmail || !currentUser) {
        yourContainer.innerHTML = "<p>Error: Missing admin or user info.</p>";
        return;
    }

    try {
        const res = await fetch(`https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`, {
            cache: "no-store"
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Failed to load tasks");

        const allTasks = data.tasks || [];
        const todayStr = selectedDate || new Date().toISOString().split("T")[0];

        // Get user permissions to detect if currentUser is admin
        const userRes = await fetch(`https://beemazing1.onrender.com/get-users?adminEmail=${encodeURIComponent(adminEmail)}`);
        const userData = await userRes.json();
        const isAdmin = userData.permissions?.[currentUser] === "Admin";

        // Filter for tasks assigned to this user
        const yourTasks = allTasks.filter(task => {
            if (!task || !task.users || !task.title || !task.date) return false;
            if (!filterTasksForDate([task], todayStr).length) return false;
            return task.users.includes(currentUser) ||
                (task.tempTurnReplacement?.[todayStr] && Object.values(task.tempTurnReplacement[todayStr]).includes(currentUser));
        });

        document.getElementById("yourTaskCount").textContent = `(${yourTasks.length})`;

        if (yourTasks.length === 0) {
            yourContainer.innerHTML = "<p>No tasks assigned to you 🎉</p>";
        } else {
            yourContainer.innerHTML = "";
            yourTasks.forEach(task => {
                let turnData = { turns: [], requiredTimes: task.timesPerDay || 1 };
                if (task.settings?.includes("Rotation")) {
                    turnData = typeof mixedTurnData === "function" ? mixedTurnData(task, todayStr) : turnData;
                } else if (task.settings?.includes("Individual")) {
                    turnData = typeof individualTurnData === "function" ? individualTurnData(task, todayStr) : turnData;
                }

                const userTurns = turnData.turns.filter(t => t.user === currentUser);
                const completedTurns = (task.completions?.[todayStr] || []).filter(c => c.user === currentUser).length;
                const pendingTurns = (task.pendingCompletions?.[todayStr] || []).filter(p => p.user === currentUser).length;

                let statusText = "Not Started";
                if (completedTurns > 0) {
                    statusText = `${completedTurns}/${turnData.requiredTimes} Completed`;
                } else if (pendingTurns > 0) {
                    statusText = `${pendingTurns} Pending Review`;
                }

                const canComplete = (isAdmin && completedTurns < turnData.requiredTimes) || (!isAdmin && completedTurns + pendingTurns < turnData.requiredTimes);

                const div = document.createElement("div");
                div.className = "your-task";
                div.innerHTML = `
                    <div class="task-title">${task.title}</div>
                    <div class="task-info">${task.notes || "No description provided"}</div>
                    <div class="task-info">Due: ${new Date(todayStr).toLocaleDateString()}</div>
                    <div class="task-info">Status: ${statusText}</div>
                    <div class="task-info">Assigned to: ${task.users.join(", ")}</div>
                    ${canComplete ? `<button class="complete-btn" onclick="submitTaskCompletion('${task.title}', '${todayStr}', '${currentUser}')">Mark Complete</button>` : ""}
                `;
                yourContainer.appendChild(div);
            });
        }
    } catch (err) {
        console.error("Error loading your tasks:", err);
        yourContainer.innerHTML = "<p>Error loading your tasks: " + err.message + "</p>";
    }
}












// Add task completion function
async function submitTaskCompletion(title, user, date) {
    try {
        const adminEmail = globalAdminEmail;
        const response = await fetch("https://beemazing1.onrender.com/api/complete-task", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                adminEmail,
                taskTitle: title,
                user,
                date
            })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to submit task");
        alert(data.message || "Task completed successfully!");
        await loadYourTasks(); // Ensure UI refreshes
    } catch (err) {
        console.error("Error submitting task:", err);
        alert("Error submitting task: " + err.message);
    }
}









function generateScrollableDates(monthOffset = 0) {
  const container = document.getElementById("dayScrollContainer");
  container.innerHTML = "";

  const today = new Date();
  today.setDate(1);
  today.setMonth(today.getMonth() + monthOffset);

  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  document.getElementById("monthLabel").textContent = today.toLocaleDateString(undefined, {
    month: "long",
    year: "numeric",
  });

  const todayStr = new Date().toLocaleDateString("sv-SE");
  const dayAbbreviations = ["S", "Mo", "Tu", "We", "Th", "Fr", "St"];

  for (let i = 1; i <= daysInMonth; i++) {
    const date = new Date(currentYear, currentMonth, i);
    const dayOfWeek = dayAbbreviations[date.getDay()]; // Get day abbreviation (Su, Mo, etc.)

    const containerDiv = document.createElement("div");
    containerDiv.className = "day-container";

    const label = document.createElement("span");
    label.className = "day-label";
    label.textContent = dayOfWeek;

    const btn = document.createElement("div");
    btn.className = "day";
    btn.textContent = i;
    btn.dataset.date = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;

    btn.addEventListener("click", () => {
      document.querySelectorAll(".day").forEach(d => d.classList.remove("selected"));
      btn.classList.add("selected");
      selectedDate = btn.dataset.date;
      try { loadTasks(); } catch (err) { console.error("Error in loadTasks:", err); }
      try { loadOverdueTasks(); } catch (err) { console.error("Error in loadOverdueTasks:", err); }
      try { loadPendingTasks(); } catch (err) { console.error("Error in loadPendingTasks:", err); }
      try { loadYourTasks(); } catch (err) { console.error("Error in loadYourTasks:", err); }
      try { loadPendingRewardRequests(); } catch (err) { console.error("Error in loadPendingRewardRequests:", err); }
    });

    // Always mark today's date with the "today" class when it exists in current month view
    const actualToday = new Date();
    const actualTodayStr = `${actualToday.getFullYear()}-${String(actualToday.getMonth() + 1).padStart(2, "0")}-${String(actualToday.getDate()).padStart(2, "0")}`;
    
    if (btn.dataset.date === actualTodayStr) {
      btn.classList.add("today");
      
      // Only auto-select today if we're viewing the current month (monthOffset === 0)
      if (monthOffset === 0) {
        btn.classList.add("selected");
        selectedDate = btn.dataset.date;
        try { loadTasks(); } catch (err) { console.error("Error in loadTasks:", err); }
        try { loadOverdueTasks(); } catch (err) { console.error("Error in loadOverdueTasks:", err); }
        try { loadPendingTasks(); } catch (err) { console.error("Error in loadPendingTasks:", err); }
        try { loadYourTasks(); } catch (err) { console.error("Error in loadYourTasks:", err); }
        try { loadPendingRewardRequests(); } catch (err) { console.error("Error in loadPendingRewardRequests:", err); }
      }
    }

    containerDiv.appendChild(label);
    containerDiv.appendChild(btn);
    container.appendChild(containerDiv);
  }

  setTimeout(() => {
    const selected = document.querySelector(".day.selected");
    if (selected) {
      selected.scrollIntoView({ behavior: "smooth", inline: "center" });
    }
  }, 50);
}













let monthOffset = 0;
document.getElementById("prevMonth").addEventListener("click", () => {
  monthOffset--;
  generateScrollableDates(monthOffset);
});
document.getElementById("nextMonth").addEventListener("click", () => {
  monthOffset++;
  generateScrollableDates(monthOffset);
});
document.getElementById("scrollLeft").addEventListener("click", () => {
  document.getElementById("dayScrollContainer").scrollBy({
    left: -200,
    behavior: "smooth",
  });
});
document.getElementById("scrollRight").addEventListener("click", () => {
  document.getElementById("dayScrollContainer").scrollBy({
    left: 200,
    behavior: "smooth",
  });
});





async function loadOverdueTasks() {
  const adminEmail = globalAdminEmail;
  const overdueContainer = document.getElementById("overdueTasks");
  if (!overdueContainer) {
    console.log("Overdue container not found, skipping load");
    return;
  }
  overdueContainer.innerHTML = "<p>Loading...</p>";

  try {
    const res = await fetch(`https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Failed to load tasks");

    const allTasks = data.tasks || [];
    const todayStr = selectedDate;

    const overdueTasks = allTasks.filter(task => {
      if (!task || !task.users || !task.title || !task.date) return false;
      if (!filterTasksForDate([task], todayStr).length) return false;

      if (!Array.isArray(task.users) || task.users.length === 0) {
        task.users = ["Unknown"];
      }

      let turnData;
      if (task.settings?.includes("Rotation")) {
        turnData = typeof mixedTurnData === "function" ? mixedTurnData(task, todayStr) : null;
        if (!turnData) return false;
        return turnData.completedCount < turnData.requiredTimes;
      } else if (task.settings?.includes("Individual")) {
        turnData = typeof individualTurnData === "function" ? individualTurnData(task, todayStr) : null;
        if (!turnData) return false;

        const usersNotDone = task.users.filter(user => {
          const turns = turnData.turns.filter(t => t.user === user);
          const completed = turns.filter(t => t.isCompleted || t.isPending).length;
          return completed < turnData.requiredTimes;
        });
        task.usersNotDone = usersNotDone; // Store for rendering
        return usersNotDone.length > 0;
      }
      return false;
    });

    document.getElementById("overdueCount").textContent = `(${overdueTasks.length})`;

    if (overdueTasks.length === 0) {
      overdueContainer.innerHTML = "<p>No overdue tasks 🎉</p>";
    } else {
      overdueContainer.innerHTML = "";
      overdueTasks.forEach(task => {
        const div = document.createElement("div");
        div.className = "overdue-task";
        const overdueUsers = task.settings?.includes("Individual") && task.usersNotDone?.length > 0
          ? task.usersNotDone.join(", ")
          : task.users.join(", ");
        div.innerHTML = `
          <div class="task-title">${task.title}</div>
          <div class="task-info">Task overdue for: ${overdueUsers || "Unknown"}</div>
        `;
        overdueContainer.appendChild(div);
      });
    }

  } catch (err) {
    console.error("Error loading overdue tasks:", err);
    const overdueContainer = document.getElementById("overdueTasks");
    if (overdueContainer) {
      overdueContainer.innerHTML = "<p>Error loading overdue tasks</p>";
    }
  }
}






// Toggle Overdue Task List
const overdueCard = document.getElementById("overdueCard");
const overdueTasksContainer = document.getElementById("overdueTasks");
const overdueArrow = document.getElementById("overdueArrow");

let overdueVisible = false;

overdueCard.addEventListener("click", () => {
  overdueVisible = !overdueVisible;
  overdueTasksContainer.style.display = overdueVisible ? "block" : "none";
  overdueArrow.textContent = overdueVisible ? "⌄" : "›"; // Down arrow vs right
});





async function loadPendingTasks() {
  const adminEmail = globalAdminEmail;
  const pendingContainer = document.getElementById("pendingTasks");
  if (!pendingContainer) {
    console.log("Pending container not found, skipping load");
    return;
  }
  pendingContainer.innerHTML = "<p>Loading...</p>";

  console.log("🔍 loadPendingTasks: Fetching pending tasks", { adminEmail });

  try {
    const res = await fetch(`https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`, { cache: "no-store" });
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.error || "Failed to load tasks");
    }

    const allTasks = data.tasks || [];
    const todayStr = new Date().toLocaleDateString("sv-SE");
    console.log("🔍 loadPendingTasks: Fetched tasks", allTasks.map(t => ({ title: t.title, date: t.date, pendingCompletions: t.pendingCompletions?.[todayStr] })));

    const pendingTasks = allTasks.filter(task => {
      if (!task || !task.pendingCompletions || !task.pendingCompletions[todayStr]) return false;
      return task.pendingCompletions[todayStr].length > 0;
    });

    document.getElementById("approvalCount").textContent = `(${pendingTasks.length})`;
    console.log("🔍 loadPendingTasks: Filtered pending tasks", pendingTasks.map(t => ({ title: t.title, pending: t.pendingCompletions[todayStr] })));

    if (pendingTasks.length === 0) {
      pendingContainer.innerHTML = "<p>No tasks needing approval</p>";
    } else {
      pendingContainer.innerHTML = "";
      pendingTasks.forEach(task => {
        task.pendingCompletions[todayStr].forEach((pending, index) => {
          const div = document.createElement("div");
          div.className = "pending-task";
          div.innerHTML = `
            <div class="task-title">${task.title}</div>
            <div class="task-info">Submitted by: ${pending.user} (Attempt ${pending.repetition})</div>
            <div class="task-actions">
              <button class="accept-btn" onclick="handleDecision('${task.title}', '${task.date}', '${todayStr}', ${index}, 'accept', '${pending.user}', ${pending.repetition}, event)">Accept</button>
              <button class="decline-btn" onclick="handleDecision('${task.title}', '${task.date}', '${todayStr}', ${index}, 'decline', '${pending.user}', ${pending.repetition}, event)">Decline</button>
            </div>
          `;
          pendingContainer.appendChild(div);
        });
      });
    }
  } catch (err) {
    console.error("🔥 loadPendingTasks: Error", err);
    const pendingContainer = document.getElementById("pendingTasks");
    if (pendingContainer) {
      pendingContainer.innerHTML = "<p>Error loading pending tasks</p>";
    }
  }
}





async function handleDecision(title, date, selectedDate, index, decision, user, repetition, event) {
  event.preventDefault();
  const adminEmail = globalAdminEmail;
  const button = event.target;
  button.disabled = true;

  console.log("🔍 handleDecision: Processing", { title, date, selectedDate, index, decision, user, repetition, adminEmail });

  try {
    const response = await fetch("https://beemazing1.onrender.com/api/review-task", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ adminEmail, title, date, selectedDate, user, decision, index, repetition })
    });
    const data = await response.json();
    if (!response.ok) {
      throw new Error(data.error || `HTTP error ${response.status}`);
    }

    console.log("✅ handleDecision: Success", data);
    const popup = document.createElement("div");
    popup.className = "reward-popup";
    popup.textContent = `Task ${decision}d successfully!`;
    document.body.appendChild(popup);
    setTimeout(() => {
      popup.remove();
      loadPendingTasks(); // Refresh pending tasks
    }, 2000);
  } catch (err) {
    console.error("🔥 handleDecision: Error", err);
    const popup = document.createElement("div");
    popup.className = "reward-popup";
    popup.textContent = `Error: ${err.message}`;
    popup.style.color = "red";
    document.body.appendChild(popup);
    setTimeout(() => {
      popup.remove();
      button.disabled = false;
    }, 3000);
  }
}






async function loadPendingRewardRequests() {
    const adminEmail = globalAdminEmail;
    const rewardContainer = document.getElementById("rewardRequests");
    if (!rewardContainer) {
        console.log("Reward container not found, skipping load");
        return;
    }
    rewardContainer.innerHTML = "<p>Loading...</p>";

    try {
        const response = await fetch(`https://beemazing1.onrender.com/api/reward-requests?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`, {
            cache: "no-store"
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to fetch reward requests");

        const pendingRequests = (data.requests || []).filter(req => req.status === "pending");
        document.getElementById("rewardCount").textContent = `(${pendingRequests.length})`;

        if (pendingRequests.length === 0) {
            rewardContainer.innerHTML = "<p>No rewards needing approval</p>";
        } else {
            rewardContainer.innerHTML = "";
            pendingRequests.forEach((request, index) => {
                const div = document.createElement("div");
                div.className = "reward-request";
                div.innerHTML = `
                    <div class="request-title">${request.rewardName}</div>
                    <div class="request-info">Requested by: ${request.user} (${request.rewardCost} 🍯)</div>
                    <div class="request-actions">
                        <button class="approve-btn" onclick="reviewReward(${index}, 'approve')">Approve</button>
                        <button class="decline-btn" onclick="reviewReward(${index}, 'decline')">Decline</button>
                    </div>
                `;
                rewardContainer.appendChild(div);
            });
        }
    } catch (err) {
        console.error("Error loading pending reward requests:", err);
        rewardContainer.innerHTML = "<p>Error loading reward requests</p>";
    }
}






async function reviewReward(requestIndex, decision) {
    const adminEmail = globalAdminEmail;
    try {
        const buttons = document.querySelectorAll(`.reward-request button`);
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = "0.5";
        });

        // Fetch current reward requests to get the request details
        const response = await fetch(`https://beemazing1.onrender.com/api/reward-requests?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`, {
            cache: "no-store"
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || "Failed to fetch reward requests");

        const pendingRequests = (data.requests || []).filter(req => req.status === "pending");
        const request = pendingRequests[requestIndex];
        if (!request) throw new Error("Reward request not found");

        // Update the reward request status
        const reviewResponse = await fetch("https://beemazing1.onrender.com/api/review-reward", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ adminEmail, requestIndex, decision })
        });
        const reviewData = await reviewResponse.json();
        if (!reviewResponse.ok) throw new Error(reviewData.error || "Failed to process reward request");

        // If approved or declined, remove the request from pending requests
        const deleteResponse = await fetch("https://beemazing1.onrender.com/api/delete-reward-request", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ adminEmail, requestIndex })
        });
        const deleteData = await deleteResponse.json();
        if (!deleteResponse.ok) throw new Error(deleteData.error || "Failed to delete reward request");

        alert(`Reward ${decision}d successfully!`);
        loadPendingRewardRequests(); // Refresh list
    } catch (err) {
        console.error("Error reviewing reward:", err);
        alert(`Failed to process reward request: ${err.message}`);
    } finally {
        const buttons = document.querySelectorAll(`.reward-request button`);
        buttons.forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = "1";
        });
    }
}







// Call on page load and date change
document.addEventListener("DOMContentLoaded", loadPendingRewardRequests);
// Also call when selectedDate changes
const originalGenerateScrollableDates = generateScrollableDates;
generateScrollableDates = function(monthOffset = 0) {
    originalGenerateScrollableDates(monthOffset);
    loadPendingRewardRequests();
};






const approvalCard = document.getElementById("approvalCard");
const pendingTasksContainer = document.getElementById("pendingTasks");
const approvalArrow = document.getElementById("approvalArrow");

let approvalVisible = false;

approvalCard.addEventListener("click", () => {
  approvalVisible = !approvalVisible;
  pendingTasksContainer.style.display = approvalVisible ? "block" : "none";
  approvalArrow.textContent = approvalVisible ? "⌄" : "›";
});








// Expand/collapse for Rewards Needing Approval
const rewardCard = document.getElementById("rewardCard");
const rewardTasksContainer = document.getElementById("rewardTasks");
const rewardArrow = document.getElementById("rewardArrow");
let rewardVisible = false;

rewardCard.addEventListener("click", () => {
  rewardVisible = !rewardVisible;
  rewardTasksContainer.style.display = rewardVisible ? "block" : "none";
  rewardArrow.textContent = rewardVisible ? "⌄" : "›";
});

// Expand/collapse for Your Tasks
const yourCard = document.getElementById("yourCard");
const yourTasksContainer = document.getElementById("yourTasks");
const yourArrow = document.getElementById("yourArrow");
let yourVisible = false;

yourCard.addEventListener("click", () => {
  yourVisible = !yourVisible;
  yourTasksContainer.style.display = yourVisible ? "block" : "none";
  yourArrow.textContent = yourVisible ? "⌄" : "›";
});








  </script>



<script src="/BeeMazing-A1/shared/taskrotations.js?t=${Date.now()}"></script>






</body>
</html>
