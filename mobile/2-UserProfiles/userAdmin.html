<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Task Review</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #FFC107;
      --secondary-color: #212121;
      --accent-color: #FFFFFF;
      --light-bg: #1E1F26;
      --text-color: #FFFFFF;
      --danger-color: #D32F2F;
      --modal-bg: rgba(33, 33, 33, 0.7);
      --footer-height: 70px;
      --border-dark: #444754;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-color);
      margin: 0;
      padding: 0;
    }

    .date-header {
      background: var(--secondary-color);
      padding: 5px 0;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .month-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      font-weight: bold;
      width: 100%;
      padding: 4px 0;
      color: var(--accent-color);
    }

    .month-nav button {
      margin: 0 8px;
      background: var(--secondary-color);
      color: var(--accent-color);
      border: none;
      padding: 4px 10px;
      border-radius: 8px;
      cursor: pointer;
    }

    .month-nav button:hover {
      background: var(--primary-color);
      color: var(--secondary-color);
    }

    .day-scroll-wrapper {
      display: flex;
      align-items: center;
      padding: 6px 0;
      overflow: hidden;
      background: transparent;
    }

    .scroll-btn {
      background: var(--secondary-color);
      color: var(--accent-color);
      border: none;
      font-size: 20px;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 10px;
      margin: 0 5px;
    }

    .day-scroll {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 6px 10px;
      scroll-behavior: smooth;
    }

    .day-scroll::-webkit-scrollbar {
      display: none;
    }

    .day {
      min-width: 38px;
      height: 38px;
      line-height: 38px;
      text-align: center;
      border-radius: 50%;
      background: var(--secondary-color);
      color: var(--accent-color);
      font-weight: bold;
      cursor: pointer;
      flex-shrink: 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .day:hover {
      background: #FFF3CD;
    }

    .day.selected {
      background: var(--primary-color);
      color: var(--secondary-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .task-entry {
      background: #2A2B32;
      border: 2px solid var(--border-dark);
      border-radius: 12px;
      padding: 16px;
      margin: 15px;
    }

    .task-title {
      margin: 0;
      font-weight: bold;
      display: flex;
      align-items: center;
    }

    .delete-btn {
      background-color: var(--danger-color);
      color: white;
      padding: 8px 14px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      margin: 10px 0;
    }

    .delete-btn:hover {
      background-color: #B71C1C;
    }

    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      background: var(--secondary-color);
      padding: 10px 0;
      box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
      z-index: 100;
      height: var(--footer-height);
    }

    .footer a {
      text-decoration: none;
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.3s ease;
    }

    .footer a:hover {
      transform: scale(1.1);
    }

    .footer-icon img {
      width: 40px;
      height: 40px;
      filter: invert(100%) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .footer a.active img {
      filter: invert(77%) sepia(88%) saturate(900%) hue-rotate(0deg)
        brightness(100%) contrast(100%) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)) !important;
    }

    .footer-icon span {
      font-size: 12px;
      margin-top: 5px;
      font-weight: 600;
    }

    .footer a.active span {
      color: var(--primary-color);
    }

    @media (max-width: 600px) {
      .footer-icon img {
        width: 35px;
        height: 35px;
      }
    }

    .menu-btn {
      position: fixed;
      top: 1px;
      left: 10px;
      background: var(--secondary-color);
      border: none;
      color: var(--text-color);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      z-index: 202;
      transition: color 0.3s ease, background 0.3s ease;
    }

    .menu-btn:hover {
      color: var(--primary-color);
      background: var(--light-bg);
    }

    .side-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      height: 100%;
      background: var(--secondary-color);
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      z-index: 201;
      display: flex;
      flex-direction: column;
    }

    .side-menu.open {
      transform: translateX(0);
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 200;
    }

    .overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .content-blur {
      transition: filter 0.3s ease;
    }

    body.menu-open .content-blur {
      filter: blur(3px);
    }

    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--light-bg);
      border-bottom: 1px solid var(--border-dark);
    }

    .menu-header h2 {
      font-size: 18px;
      color: var(--text-color);
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
    }

    .close-btn:hover {
      color: var(--primary-color);
    }

    .menu-items {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
    }

    .menu-items li {
      border-bottom: 1px solid var(--border-dark);
    }

    .menu-link {
      display: block;
      padding: 15px 20px;
      color: var(--text-color);
      text-decoration: none;
      font-size: 16px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .menu-link:hover {
      background: var(--light-bg);
      color: var(--primary-color);
    }

    @media (max-width: 600px) {
      .side-menu {
        width: 200px;
      }
      .menu-link {
        font-size: 14px;
        padding: 12px 15px;
      }
      .menu-header h2 {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <nav id="sideMenu" class="side-menu">
    <div class="menu-header">
      <h2>Admin Menu</h2>
      <button id="closeMenu" class="close-btn" aria-label="Close Menu">×</button>
    </div>
    <ul class="menu-items">
      <li><a href="#" id="taskSettingsLink" class="menu-link">Task Settings</a></li>
      <li><a href="#" id="marketDashLink" class="menu-link">Market Dash</a></li>
      <li><a href="#" id="userManagementLink" class="menu-link">User Management</a></li>
      <li><a href="#" id="logoutLink" class="menu-link">Logout</a></li>
    </ul>
  </nav>
  <div id="overlay" class="overlay"></div>
  <div class="date-header">
    <button id="menuToggle" class="menu-btn" aria-label="Toggle Menu">☰</button>
    <div class="month-nav">
      <button id="prevMonth"><</button>
      <span id="monthLabel">Month</span>
      <button id="nextMonth">></button>
    </div>
    <div class="day-scroll-wrapper">
      <button class="scroll-btn" id="scrollLeft"><</button>
      <div class="day-scroll" id="dayScrollContainer"></div>
      <button class="scroll-btn" id="scrollRight">></button>
    </div>
  </div>
  <div id="taskContainer">Loading tasks...</div>
  <div class="footer">
    <a href="#" id="homeButton" class="footer-icon active" aria-label="Home">
      <img src="/BeeMazing-Y1/mobile/1-Home/HomeBtn.png" alt="Home" />
      <span>Home</span>
    </a>
    <a href="#" id="profileButton" class="footer-icon" aria-label="Profile">
      <img src="/BeeMazing-Y1/mobile/1-Home/ProfileBtn.png" alt="Profile" />
      <span>Profile</span>
    </a>
    <a href="#" id="marketButton" class="footer-icon" aria-label="Market">
      <img src="/BeeMazing-Y1/mobile/1-Home/MarketBtn.png" alt="Market" />
      <span>Market</span>
    </a>
  </div>
  <script>
    // Dynamically set footer button links and active state
    const urlParams = new URLSearchParams(window.location.search);
    const adminEmail = urlParams.get('admin') || localStorage.getItem('currentAdminEmail') || '';
    const userName = urlParams.get('user') || '';
    const basePath = '/BeeMazing-Y1/mobile/2-UserProfiles';

    const homeButton = document.getElementById('homeButton');
    const profileButton = document.getElementById('profileButton');
    const marketButton = document.getElementById('marketButton');

    if (adminEmail && userName) {
      homeButton.href = `${basePath}/userAdmin.html?admin=${encodeURIComponent(adminEmail)}&user=${encodeURIComponent(userName)}`;
      profileButton.href = `${basePath}/users.html?admin=${encodeURIComponent(adminEmail)}&user=${encodeURIComponent(userName)}`;
      marketButton.href = `${basePath}/usermarket.html?admin=${encodeURIComponent(adminEmail)}&user=${encodeURIComponent(userName)}`;
    }

    // Set active state
    document.querySelectorAll('.footer a').forEach(link => {
      const currentPath = window.location.pathname.replace(/\/$/, '');
      const linkPath = new URL(link.href, window.location.origin).pathname.replace(/\/$/, '');
      if (currentPath === linkPath) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });

    // Side Menu Toggle
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');
    const closeMenu = document.getElementById('closeMenu');
    const overlay = document.getElementById('overlay');
    const contentElements = document.querySelectorAll('.date-header, #taskContainer, .footer');

    function openMenu() {
      sideMenu.classList.add('open');
      overlay.classList.add('active');
      document.body.classList.add('menu-open');
      contentElements.forEach(el => el.classList.add('content-blur'));
    }

    function closeMenuFn() {
      sideMenu.classList.remove('open');
      overlay.classList.remove('active');
      document.body.classList.remove('menu-open');
      contentElements.forEach(el => el.classList.remove('content-blur'));
    }

    menuToggle.addEventListener('click', openMenu);
    closeMenu.addEventListener('click', closeMenuFn);
    overlay.addEventListener('click', closeMenuFn);

    sideMenu.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    const taskSettingsLink = document.getElementById('taskSettingsLink');
    const marketDashLink = document.getElementById('marketDashLink');
    const userManagementLink = document.getElementById('userManagementLink');
    const logoutLink = document.getElementById('logoutLink');

    if (adminEmail && userName) {
      taskSettingsLink.href = `/BeeMazing-Y1/mobile/3-Tasks/tasks.html?admin=${encodeURIComponent(adminEmail)}&user=${encodeURIComponent(userName)}`;
      marketDashLink.href = `/BeeMazing-Y1/mobile/4-Market/market.html?admin=${encodeURIComponent(adminEmail)}&user=${encodeURIComponent(userName)}`;
      userManagementLink.href = `/BeeMazing-Y1/mobile/1-Home/home.html?admin=${encodeURIComponent(adminEmail)}&user=${encodeURIComponent(userName)}`;
      logoutLink.href = `/BeeMazing-Y1/login.html`;
    }

    logoutLink.addEventListener('click', () => {
      localStorage.removeItem('isAdmin');
      localStorage.removeItem('userData');
      localStorage.removeItem('adminPassword');
    });

    let selectedDate = new Date().toLocaleDateString("sv-SE");


    async function deleteTask(title, date) {
  const adminEmail = localStorage.getItem("currentAdminEmail");
  console.log("Deleting task with:", { adminEmail, title, date });
  if (!adminEmail) {
    alert("No admin email found.");
    return;
  }
  if (!title || !date) {
    alert("Missing task title or date.");
    return;
  }

  const startDate = date.split(" to ")[0];
  const maxRetries = 2;
  let attempt = 0;

  while (attempt <= maxRetries) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 seconds timeout

    try {
      console.log(`Attempt ${attempt + 1} to delete task: adminEmail=${adminEmail}, title=${title}, date=${startDate}`);
      const response = await fetch(
        `https://beemazing.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&title=${encodeURIComponent(title)}&date=${encodeURIComponent(startDate)}`,
        {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          signal: controller.signal
        }
      );

      clearTimeout(timeoutId);

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`Failed to delete task: ${errorData.error || response.statusText}`);
      }

      console.log("Task deleted successfully");
      setTimeout(() => loadTasks(), 500); // Refresh tasks after deletion
      return;
    } catch (error) {
      clearTimeout(timeoutId);
      attempt++;
      if (attempt > maxRetries) {
        console.error("Error deleting task after all retries:", error);
        alert(`Failed to delete task: ${error.message}`);
        return;
      }
      console.log(`Retrying delete request (${attempt}/${maxRetries})...`);
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
  }
}


    async function loadTasks() {
      try {
        const res = await fetch(`https://beemazing.onrender.com/get-tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`, {
          cache: "no-store"
        });
        if (!res.ok) throw new Error(`HTTP error ${res.status}`);
        const { tasks } = await res.json();
        console.log("Tasks received:", tasks.map(t => ({ title: t.title, date: t.date })));

        const container = document.getElementById("taskContainer");
        container.innerHTML = "";

        if (!tasks || tasks.length === 0) {
          container.innerHTML = "<p>No tasks available.</p>";
          return;
        }

        tasks.forEach(task => {
          const div = document.createElement("div");
          div.className = "task-entry";
          div.dataset.title = task.title;
          div.dataset.date = task.date;
          div.innerHTML = `
  <h3 class="task-title">${task.title}</h3>
  <p><strong>Date:</strong> ${task.date}</p>
  <button class="delete-btn" style="background-color: #D32F2F; color: white; padding: 8px 14px; font-weight: bold; border-radius: 6px; border: none; cursor: pointer; margin: 10px 0;">Delete Task</button>
`;
div.querySelector(".delete-btn").addEventListener("click", async () => {
  if (confirm(`Are you sure you want to delete the task "${task.title}"?`)) {
    try {
      await deleteTaskFromBackend(task.title, task.date);
      loadTasks();
    } catch (err) {
      console.error("Failed to delete task:", err);
      alert("Failed to delete task. Please try again.");
    }
  }
});
          container.appendChild(div);

          div.querySelector(".delete-btn").addEventListener("click", async () => {
            if (confirm(`Are you sure you want to delete the task "${task.title}"?`)) {
              const success = await deleteTask(task.title, task.date);
              if (success) {
                loadTasks();
              }
            }
          });
        });
      } catch (err) {
        console.error("Error loading tasks:", err);
        document.getElementById("taskContainer").innerHTML = "<p>Error loading tasks. Please try again.</p>";
      }
    }

    function generateScrollableDates(monthOffset = 0) {
      const container = document.getElementById("dayScrollContainer");
      container.innerHTML = "";

      const today = new Date();
      today.setDate(1);
      today.setMonth(today.getMonth() + monthOffset);

      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      document.getElementById("monthLabel").textContent = today.toLocaleDateString(undefined, {
        month: 'long',
        year: 'numeric',
      });

      for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(currentYear, currentMonth, i);
        const btn = document.createElement("div");
        btn.className = "day";
        btn.textContent = i;
        btn.dataset.date = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

        btn.addEventListener("click", () => {
          document.querySelectorAll(".day").forEach(d => d.classList.remove("selected"));
          btn.classList.add("selected");
          selectedDate = btn.dataset.date;
          loadTasks();
        });

        const todayStr = new Date().toLocaleDateString("sv-SE");
        if (btn.dataset.date === todayStr) {
          btn.classList.add("selected");
          selectedDate = btn.dataset.date;
          loadTasks();
        }

        container.appendChild(btn);
      }

      setTimeout(() => {
        const selected = document.querySelector(".day.selected");
        if (selected) {
          selected.scrollIntoView({ behavior: "smooth", inline: "center" });
        }
      }, 50);
    }

    let monthOffset = 0;
    document.getElementById("prevMonth").addEventListener("click", () => {
      monthOffset--;
      generateScrollableDates(monthOffset);
    });

    document.getElementById("nextMonth").addEventListener("click", () => {
      monthOffset++;
      generateScrollableDates(monthOffset);
    });

    document.getElementById("scrollLeft").addEventListener("click", () => {
      document.getElementById("dayScrollContainer").scrollBy({
        left: -200,
        behavior: "smooth"
      });
    });

    document.getElementById("scrollRight").addEventListener("click", () => {
      document.getElementById("dayScrollContainer").scrollBy({
        left: 200,
        behavior: "smooth"
      });
    });

    generateScrollableDates();
  </script>
</body>
</html>