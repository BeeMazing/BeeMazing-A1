<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeMazing Add Task</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
    --primary-color: #FFC107; /* bright yellow matching other pages */
    --secondary-color: #212121;
    --accent-color: #2C2F3A;
    --light-bg: #FFFFF8;
    --text-color: #6D4C41; /* brown text matching other pages */
    --card-bg: #FFFFFF; /* white card backgrounds */
    --danger-color: #D32F2F;
    --muted-button: #3A3D4B;
    --hover-accent: #3F4353;
    --border-dark: #444754;
    --selection-border: #555555;
    --selection-bg: #3A3D4B;
}


    html, body {
        height: 100%;
        width: 100%;
        overflow-x: hidden;
        font-family: 'Poppins', Arial, sans-serif;
        background-color: var(--light-bg);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
    }

    .header {
    position: relative;
    display: flex;
    justify-content: center; /* Center the title */
    align-items: center;
    background: var(--primary-color);
    padding: 15px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
}

.menu-icon {
position: absolute;
left: 15px;
font-size: 24px;
color: #FFFFFF; /* white for menu icon */
cursor: pointer;
}

.close-icon {
position: absolute;
right: 20px;
font-size: 28px;
color: #FFFFFF; /* white for close icon */
cursor: pointer;
transition: transform 0.2s ease;
z-index: 10;
font-weight: bold;
text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

.close-icon:hover {
transform: scale(1.1);
color: #ffcccc;
}

    .title {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-color); /* brown text for title */
    text-transform: uppercase;
    letter-spacing: 1px;
}

    .content {
        padding: 20px;
        padding-bottom: 110px;
        flex: 1;
        overflow-y: auto;
    }

    .form-group, .form-group-full {
    padding: 8px 0;
    margin-bottom: 8px;
}

    .form-group.room-section, .form-group.frequency-section, .form-group-full.date-section {
    background-color: rgba(255, 193, 7, 0.1);
    border: 2px solid var(--primary-color);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
}


    .form-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }


    .form-group label {
    margin-right: 12px; /* Adjust the spacing */
}




    label {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-color);
    }

    input, textarea {
    background: rgba(255, 193, 7, 0.1);
    color: var(--text-color);
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    padding: 10px;
    font-size: 16px;
    width: 100%;
}


    textarea {
        resize: vertical;
        height: 100px;
    }

    ::placeholder {
        color: rgba(109, 76, 65, 0.6);
    }

    .select-btn {
    background: var(--card-bg);
    border: 2px solid var(--primary-color);
    color: var(--text-color);
    font-size: 16px;
    font-weight: 600;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
}

.select-btn:hover {
    background: var(--primary-color);
    color: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
}

/* New class for the circular + button */
.plus-btn {
    background: var(--primary-color);
    border: none;
    color: var(--secondary-color);
    font-size: 20px;
    font-weight: 600;
    width: 32px;
    height: 32px;
    line-height: 32px; /* Centers the + vertically */
    border-radius: 50%; /* Fully circular */
    cursor: pointer;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
}

.plus-btn:hover {
    background: #FFB300; /* Brighter gold on hover */
    transform: translateY(-2px); /* Slight lift */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* Enhanced shadow */
}

.plus-btn:active {
    transform: translateY(0); /* Pressed effect */
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); /* Reduced shadow */
}

    .date-display {
        background: var(--light-bg);
        border: 2px solid var(--primary-color);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-color);
        text-align: center;
        cursor: pointer;
        transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
        min-width: 80px;
        box-shadow: 0 1px 3px rgba(255, 193, 7, 0.1);
    }

    .date-display:hover {
        background: rgba(255, 193, 7, 0.15);
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(255, 193, 7, 0.2);
    }

    .date-flex-row {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .date-flex-row label {
        width: 80px;
        margin: 0;
    }

    .date-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .date-input {
        display: none;
    }

    .save-btn {
        width: 100%;
        padding: 15px;
        margin-top: 20px;
        background: var(--primary-color);
        color: var(--secondary-color);
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .save-btn:hover {
        background: #FFB300;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal.show {
        display: flex;
        animation: fadeIn 0.3s ease-out;
    }

    .modal.hide {
        animation: fadeOut 0.3s ease-out;
        pointer-events: none;
    }

    .modal-content {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 15px;
        border: 2px solid var(--primary-color);
        width: 80%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
        color: var(--text-color);
    }

    .modal-content h3 {
        color: var(--text-color);
        font-weight: 600;
        margin-bottom: 15px;
    }

    .modal-content ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .modal-content ul li {
        padding: 10px;
        margin: 5px 0;
        background: var(--card-bg);
        color: var(--text-color);
        border: 2px solid var(--primary-color);
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .modal-content ul li:hover {
        background: var(--primary-color);
        color: var(--secondary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
    }

    .close-btn {
        margin-top: 15px;
        padding: 10px 20px;
        background: var(--primary-color);
        color: var(--text-color);
        border: 2px solid var(--text-color);
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        transition: all 0.3s ease;
    }

    .close-btn:hover {
        background: #FFB300;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.5);
    }

    .footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    display: flex;
    justify-content: space-around;
    background: var(--secondary-color); /* Changed to black */
    padding: 10px 0;
    box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
    z-index: 100;
    height: var(--footer-height);
}

.footer a {
    text-decoration: none;
    color: var(--accent-color); /* Changed to white for text */
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.3s ease;
}




    .footer img {
        width: 40px;
        height: 40px;
        filter: invert(100%) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)); /* Default: white */
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 28px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: white;
        border: 2px solid #ccc;
        transition: 0.4s;
        border-radius: 28px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: #444;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: white;
        border-color: var(--primary-color);
    }

    input:checked + .slider:before {
        background-color: var(--primary-color);
        transform: translateX(22px);
    }

    .fancy-input {
        padding: 8px 12px;
        font-size: 14px;
        border: 2px solid var(--border-dark);
        border-radius: 8px;
        background: var(--light-bg);
        color: var(--text-color);
        width: 80%;
        margin: 0 auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .fancy-input:focus {
        border-color: #FFB300;
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.5);
        outline: none;
    }

    .button-row {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        justify-content: space-between;
    }

    .btn-save {
        flex: 1;
        padding: 15px;
        background: var(--primary-color);
        color: var(--secondary-color);
        border: 2px solid var(--secondary-color);
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .btn-save:hover {
        background: #FFB300;
    }

    .btn-cancel {
        flex: 1;
        padding: 15px;
        background: var(--muted-button);
        color: #FFFFFF;
        border: 2px solid var(--border-dark);
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .btn-cancel:hover {
        background: var(--hover-accent);
    }

    @keyframes fadeIn {
        0% { opacity: 0; transform: scale(0.9); }
        100% { opacity: 1; transform: scale(1); }
    }

    @keyframes fadeOut {
        0% { opacity: 1; transform: scale(1); }
        100% { opacity: 0; transform: scale(0.9); }
    }

    @keyframes slideIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }

    /* Info popup styles */
    .info-popup {
        position: fixed;
        background: var(--card-bg);
        border: 2px solid var(--primary-color);
        border-radius: 8px;
        padding: 15px;
        font-size: 14px;
        line-height: 1.4;
        color: var(--text-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        width: 300px;
        max-width: 90vw;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s ease;
    }

    @media (max-width: 480px) {
        .info-popup {
            font-size: 16px;
            line-height: 1.5;
            padding: 18px;
            width: 320px;
        }
    }

    .info-popup.show {
        opacity: 1;
        pointer-events: auto;
    }

    .info-popup::after {
        content: '';
        position: absolute;
        border: 8px solid transparent;
    }

    .info-popup::before {
        content: '';
        position: absolute;
        transform: translateY(-1px);
        border: 6px solid transparent;
    }

    /* Remove arrows for centered popups */
    .info-popup::after,
    .info-popup::before {
        display: none;
    }


    /* Styling for date chips */
.date-chip {
    background: var(--accent-color);
    color: var(--text-color);
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--border-dark);
    transition: background-color 0.3s ease;
}

.date-chip:hover {
    background: var(--hover-accent);
}

.date-chip-remove {
    cursor: pointer;
    color: var(--danger-color);
    font-size: 16px;
    line-height: 1;
}

.date-chip-remove:hover {
    color: #B71C1C;
}

/* Ensure calendar in modal is centered and sized appropriately */
#specificDatesCalendar .flatpickr-calendar {
    background: var(--light-bg);
    border: 2px solid var(--border-dark);
    border-radius: 8px;
    width: 100%;
    max-width: 300px;
    margin: 0 auto;
}

#specificDatesCalendar .flatpickr-day.selected,
#specificDatesCalendar .flatpickr-day.startRange,
#specificDatesCalendar .flatpickr-day.endRange {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: var(--secondary-color);
}

#specificDatesCalendar .flatpickr-day.inRange {
    background: rgba(224, 176, 24, 0.3); /* Semi-transparent gold for range */
    border-color: var(--border-dark);
    color: var(--text-color);
}

#specificDatesCalendar .flatpickr-day:hover {
    background: var(--hover-accent);
    border-color: var(--border-dark);
}

/* Additional flatpickr styling to match page theme */
.flatpickr-calendar {
    background: var(--light-bg) !important;
    border: 2px solid var(--primary-color) !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2) !important;
}

.flatpickr-months {
    background: var(--primary-color) !important;
    border-radius: 8px 8px 0 0 !important;
}

.flatpickr-month {
    background: var(--primary-color) !important;
    color: var(--secondary-color) !important;
}

.flatpickr-current-month .flatpickr-monthDropdown-months {
    background: var(--primary-color) !important;
    color: var(--secondary-color) !important;
}

.flatpickr-current-month input.cur-year {
    background: var(--primary-color) !important;
    color: var(--secondary-color) !important;
}

.flatpickr-prev-month, .flatpickr-next-month {
    color: var(--secondary-color) !important;
}

.flatpickr-prev-month:hover, .flatpickr-next-month:hover {
    color: var(--text-color) !important;
    background: rgba(255, 255, 255, 0.2) !important;
}

.flatpickr-weekdays {
    background: var(--accent-color) !important;
    color: var(--text-color) !important;
}

.flatpickr-weekday {
    background: var(--accent-color) !important;
    color: var(--text-color) !important;
    font-weight: 600 !important;
}

.flatpickr-days {
    background: var(--light-bg) !important;
}

.flatpickr-day {
    background: var(--light-bg) !important;
    color: var(--text-color) !important;
    border: 1px solid transparent !important;
}

.flatpickr-day:hover {
    background: rgba(255, 193, 7, 0.1) !important;
    border-color: var(--primary-color) !important;
}

.flatpickr-day.selected {
    background: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
    color: var(--secondary-color) !important;
}

.flatpickr-day.today {
    border-color: var(--primary-color) !important;
    background: rgba(255, 193, 7, 0.1) !important;
    color: var(--text-color) !important;
    font-weight: 600 !important;
}

.flatpickr-day.today.selected {
    background: var(--primary-color) !important;
    color: var(--secondary-color) !important;
}

.flatpickr-day.prevMonthDay, .flatpickr-day.nextMonthDay {
    color: rgba(109, 76, 65, 0.4) !important;
    background: var(--light-bg) !important;
}

.flatpickr-day.prevMonthDay:hover, .flatpickr-day.nextMonthDay:hover {
    background: rgba(255, 193, 7, 0.05) !important;
}

.flatpickr-day.disabled {
    color: rgba(109, 76, 65, 0.2) !important;
    background: var(--light-bg) !important;
}

.flatpickr-time {
    background: var(--light-bg) !important;
    border-top: 1px solid var(--primary-color) !important;
}

.flatpickr-time input {
    background: var(--light-bg) !important;
    color: var(--text-color) !important;
}

/* Add spacing and alignment for the specific dates group */
#specificDatesGroup {
    display: flex;
    flex-direction: column; /* Stack label, button, and chips vertically */
    align-items: flex-start; /* Align items to the left */
    gap: 15px; /* Space between label/button and chips */
}

/* Ensure the button and label are aligned nicely */
#specificDatesGroup .button-wrapper {
    display: flex;
    align-items: center;
    gap: 10px; /* Space between label and + button */
}

/* Adjust container spacing */
#selectedDatesContainer {
    margin-top: 15px; /* Increased from 10px for more breathing room */
    display: flex;
    flex-wrap: wrap;
    gap: 10px; /* Slightly more gap between chips */
    width: 100%; /* Full width for better alignment */
}

#removeEndDateBtn:hover {
  color: #B71C1C;
  transform: scale(1.1);
}








/* Date Mode Selector */
#selectDateMode {
    width: 100%;
    text-align: left;
}

/* Specific Days Checkboxes */
#specificDaysCheckboxes label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
    color: var(--text-color);
}

#specificDaysCheckboxes input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--primary-color);
    cursor: pointer;
}

/* Selected Days Display */
#selectedDaysDisplay {
    max-width: 100%;
    overflow-wrap: break-word;
}



/* Date Section */
.date-section {
    padding: 15px;
    background: var(--light-bg);
    border-radius: 10px;
    border: 1px solid var(--border-dark);
}

.section-label {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 10px;
}

/* Date Mode Selector (Segmented Buttons) */
.date-mode-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 1rem;
}

.mode-btn {
    flex: 1;
    background: var(--card-bg);
    border: 2px solid var(--primary-color);
    color: var(--text-color);
    font-size: 14px;
    font-weight: 600;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
}

.mode-btn.active {
    background: var(--primary-color);
    color: var(--secondary-color);
    border-color: var(--primary-color);
    box-shadow: 0 2px 6px rgba(255, 193, 7, 0.3);
}

.mode-btn:hover {
    background: rgba(255, 193, 7, 0.1);
    transform: translateY(-1px);
}

.mode-btn.active:hover {
    background: #FFB300;
    transform: translateY(-1px);
}

/* Date Group (From/To, Specific Dates, Specific Days) */
.date-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 0;
    background: transparent;
    border: none;
}

.date-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;
    min-height: 40px;
}

.date-label {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-color);
    min-width: 60px;
    text-transform: capitalize;
}

.add-end-date {
    color: var(--primary-color);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: color 0.3s ease, transform 0.2s ease;
    padding: 6px 12px;
    border-radius: 6px;
    display: inline-block;
    margin-left: 8px;
    white-space: nowrap;
}

.add-end-date:hover {
    color: #FFB300;
    background: rgba(255, 193, 7, 0.2);
    transform: translateY(-1px);
}

.date-range-container {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.date-separator {
    color: var(--text-color);
    font-size: 14px;
    margin: 0 4px;
}

/* Responsive layout for mobile */
@media (max-width: 480px) {
    .date-row {
        flex-wrap: wrap;
        gap: 6px;
    }
    
    .add-end-date {
        margin-left: 4px;
        font-size: 12px;
        padding: 4px 8px;
    }
    
    .date-range-container {
        gap: 6px;
    }
}

.remove-btn {
    cursor: pointer;
    font-size: 16px;
    color: var(--danger-color);
    transition: color 0.3s ease, transform 0.1s ease;
}

.remove-btn:hover {
    color: #B71C1C;
    transform: scale(1.1);
}

/* Container for Day Buttons */
.day-buttons-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: flex-start;
    padding: 8px 0;
}


/* Day Buttons for Specific Days (Original Styles) */
.day-btn {
    position: relative;
    background: var(--light-bg);
    border: 2px solid var(--primary-color);
    color: var(--text-color);
    font-size: 14px;
    font-weight: 600;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
    min-width: 50px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(255, 193, 7, 0.1);
}

.day-btn.selected {
    background: var(--primary-color);
    color: var(--secondary-color);
    border-color: var(--primary-color);
    box-shadow: 0 3px 8px rgba(255, 193, 7, 0.3);
    transform: translateY(-1px);
}



.day-btn:hover {
    background: rgba(255, 193, 7, 0.1);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(255, 193, 7, 0.2);
}

.day-btn.selected:hover {
    background: #FFB300;
    color: var(--secondary-color);
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4);
}


</style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="header">
        <i class="fas fa-bars menu-icon"></i>
        <div class="title">Add Task</div>
        <span class="close-icon" onclick="closeAddTask()">✕</span>
    </div>

    <div class="content">
        <form id="addTaskForm">
            <div class="form-group-full">
                <label for="taskTitle"></label>
                <input type="text" id="taskTitle" placeholder="Enter task title" required>
            </div>
            <div class="form-group-full">
                <label for="taskNotes"></label>
                <textarea id="taskNotes" placeholder="Enter any additional notes"></textarea>
            </div>
            <div class="form-group room-section">
                <label>Room</label>
                <button type="button" id="selectRoom" class="select-btn">Select</button>
                <input type="hidden" id="roomSelection" value="">
            </div>
            
            
            <div class="form-group frequency-section">
                <label>Frequency</label>
                <button type="button" id="selectRepeat" class="select-btn">Select</button>
                <input type="hidden" id="repeatSelection" value="">
            </div>
            
            <!-- NEW: Times Per Day input (only shown when Daily is selected) -->
            <div class="form-group" id="timesPerDayGroup" style="display: none; background-color: rgba(255, 193, 7, 0.1); border: 2px solid var(--primary-color); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);">
                <label>Times per Day</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button type="button" id="decreaseTimesPerDay" style="width: 32px; height: 32px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); color: var(--text-color); font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">-</button>
                    <input type="number" id="timesPerDayInput" value="1" min="1" max="100"
                        style="width: 60px; text-align: center; padding: 8px; border: 2px solid var(--primary-color); border-radius: 8px; background: var(--light-bg); font-size: 16px; color: var(--text-color); font-weight: 400;">
                    <button type="button" id="increaseTimesPerDay" style="width: 32px; height: 32px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); color: var(--text-color); font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">+</button>
                </div>
            </div>



            <!-- Weekly Frequency Input -->
<div class="form-group" id="timesPerWeekGroup" style="display: none; background-color: rgba(255, 193, 7, 0.1); border: 2px solid var(--primary-color); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);">
    <label>Times per Week</label>
    <input type="text" id="timesPerWeekInput" value="1" readonly
    style="width: 60px; text-align: center; padding: 8px; border: 2px solid var(--primary-color); border-radius: 8px; background: var(--light-bg); font-size: 16px; cursor: pointer; color: var(--text-color); font-weight: 400;">
    

</div>

<!-- Monthly Frequency Input -->
<div class="form-group" id="timesPerMonthGroup" style="display: none; background-color: rgba(255, 193, 7, 0.1); border: 2px solid var(--primary-color); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);">
    <label>Times per Month</label>
    <input type="text" id="timesPerMonthInput" value="1" readonly
style="width: 60px; text-align: center; padding: 8px; border: 2px solid var(--primary-color); border-radius: 8px; background: var(--light-bg); font-size: 16px; cursor: pointer; color: var(--text-color); font-weight: 400;">


</div>

            

            <div class="form-group-full date-section">
                <div class="date-mode-selector">
                    <button type="button" class="mode-btn active" data-mode="date">Days</button>
                    <button type="button" class="mode-btn" data-mode="specific-dates">Specific Dates</button>
                    <input type="hidden" id="dateModeSelection" value="date">
                </div>
                
            
                <!-- Single Date UI for One Time tasks -->
                <div id="singleDateGroup" class="date-group" style="display: none;">
                    <div class="date-row">
                        <span class="date-label">Date</span>
                        <div class="date-display" id="singleDateDisplay">Select Date</div>
                    </div>
                </div>
                
                <!-- From - To Date UI -->
                <div id="fromToDateGroup" class="date-group active-section">
                    <div class="date-row">
                        <span class="date-label">From</span>
                        <div class="date-range-container">
                            <div id="dateDisplay" class="date-display">Today</div>
                            <span id="addEndDateBtn" class="add-end-date">+ Add End Date</span>
                            <span id="dateToWrapper" class="date-separator" style="display: none;">to</span>
                            <div id="dateDisplayTo" class="date-display" style="display: none;">To Date</div>
                            <span id="removeEndDateBtn" class="remove-btn" style="display: none;">✖</span>
                        </div>
                    </div>
                </div>
            
                <!-- Specific Dates UI -->
                <div id="specificDatesGroup" class="date-group inactive-section" style="display: none;">
                    <div class="date-row">
                        <span class="date-label">Dates</span>
                        <button type="button" id="selectSpecificDates" class="plus-btn">+</button>
                    </div>
                    <div id="selectedDatesContainer" style="margin-top: 10px;"></div>
                </div>
            
                <!-- Specific Days UI -->
<!-- Day Selection UI (for Date mode) -->
<div id="specificDaysGroup" class="date-group active-section">
    <div class="date-row">
        <div id="specificDaysButtons" class="day-buttons-container">
            <button type="button" class="day-btn" data-day="Any" id="anyAllButton">Any</button>
            <button type="button" class="day-btn" data-day="Mon">Mon</button>
            <button type="button" class="day-btn" data-day="Tue">Tue</button>
            <button type="button" class="day-btn" data-day="Wed">Wed</button>
            <button type="button" class="day-btn" data-day="Thu">Thu</button>
            <button type="button" class="day-btn" data-day="Fri">Fri</button>
            <button type="button" class="day-btn" data-day="Sat">Sat</button>
            <button type="button" class="day-btn" data-day="Sun">Sun</button>
        </div>
    </div>
</div>

            
                <!-- Hidden inputs -->
                <input type="text" id="taskDate" class="date-input" />
                <input type="text" id="taskDateTo" class="date-input" />
                <input type="text" id="singleTaskDate" class="date-input" />
                <input type="hidden" id="specificDatesInput" value="">
                <input type="hidden" id="specificDaysInput" value="">
            </div>
                
            
            
            <!-- COMMENTED OUT - REMINDERS FUNCTIONALITY (keep for later implementation)
            <div class="form-group">
                <label>Reminder</label>
                <label class="switch">
                    <input type="checkbox" id="taskReminder">
                    <span class="slider"></span>
                </label>
                <button type="button" id="addAlarmBtn" class="select-btn" style="display: none; margin-left: 10px;">+ Add Alarm</button>
            </div>
            <div id="alarmContainer" style="margin-top: 10px;"></div>
            -->

            <div class="form-group">
                <label>Due Time</label>
                <label class="switch">
                    <input type="checkbox" id="dueTimeToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="dueTimeContainer" style="margin-top: 10px; display: none;"></div>

            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 12px; position: relative;">
                    <label>Settings</label>
                    <i id="settingsInfo" style="
                        font-size: 14px; 
                        cursor: pointer; 
                        border: 2px solid var(--text-color); 
                        border-radius: 50%; 
                        width: 20px; 
                        height: 20px; 
                        min-width: 20px;
                        min-height: 20px;
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        font-style: normal; 
                        font-weight: bold; 
                        font-family: serif;
                        transition: all 0.2s ease;
                        background: var(--light-bg);
                        color: var(--text-color);
                        flex-shrink: 0;
                    " 
                    onmouseover="this.style.background='var(--primary-color)'; this.style.borderColor='var(--primary-color)'; this.style.color='var(--secondary-color)'" 
                    onmouseout="this.style.background='var(--light-bg)'; this.style.borderColor='var(--text-color)'; this.style.color='var(--text-color)'"
                    onclick="window.toggleSettingsPopup(event)">i</i>
                    
                    <!-- Floating Popup -->
                    <div id="settingsPopup" class="info-popup">
                        <strong>Task Settings</strong><br><br>
                        <strong>Rotation:</strong> Assign chores on a rotating basis, so each family member takes turns in a predefined order, ensuring fair distribution of tasks over time.<br><br>
                        <strong>Teamwork:</strong> Set up chores to be completed as a team, where everyone works together or tasks are dependent on each other, promoting cooperation and shared effort.<br><br>
                        <strong>Individual:</strong> Each assigned family member completes the task independently without rotation or teamwork requirements.
                    </div>
                </div>
                <button type="button" id="selectSettings" class="select-btn">Select</button>
                <input type="hidden" id="settingsSelection" value="">
            </div>

            <!-- Fair Rotation Options (separate section) -->
            <div id="fairRotationSection" style="display: none; background-color: rgba(255, 255, 255, 0.8); border: 2px solid var(--primary-color); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.15);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <label for="fairRotationToggle" style="color: var(--text-color); font-weight: 600; font-size: 16px; cursor: pointer;">Fair Rotation</label>
                    <label class="switch" style="margin: 0;">
                        <input type="checkbox" id="fairRotationToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <p style="font-size: 13px; color: rgba(109, 76, 65, 0.85); margin: 0 0 15px 0; line-height: 1.4;">
                    When enabled, assigns tasks to the person who has completed them the least, ensuring balanced workload distribution across all family members.
                </p>
                
                <!-- Advanced Fair Rotation Options -->
                <div id="fairRotationAdvanced" style="display: none; border-top: 1px solid rgba(255, 193, 7, 0.3); padding-top: 15px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <label for="fairRotationTimeBasedToggle" style="color: var(--text-color); font-weight: 500; font-size: 14px; cursor: pointer;">Time-based tie breaking</label>
                        <label class="switch" style="margin: 0; transform: scale(0.8);">
                            <input type="checkbox" id="fairRotationTimeBasedToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <p style="font-size: 11px; color: rgba(109, 76, 65, 0.7); margin: 0; line-height: 1.3;">
                        When users have equal completion counts, assign to whoever completed the task longest ago instead of using rotation order.
                    </p>
                </div>
            </div>

            <!-- Rotation Timing Options -->
            <div id="rotationOptions" style="display: none; background-color: rgba(255, 193, 7, 0.1); border: 2px solid var(--primary-color); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);">
                <label style="font-weight: 600; margin-bottom: 15px; display: block; color: var(--text-color);">Rotate after:</label>
                
                <!-- Option 1: After X occurrences -->
                <div style="margin-bottom: 15px; display: flex; flex-direction: column;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 0;">
                        <div style="position: relative; display: inline-block; width: 20px; height: 20px;">
                            <input type="radio" name="rotationType" value="occurrences" id="rotateOccurrences" checked style="position: absolute; opacity: 0; width: 100%; height: 100%; margin: 0; cursor: pointer;">
                            <div class="radio-custom" style="width: 20px; height: 20px; border: 2px solid var(--primary-color); border-radius: 50%; background: var(--light-bg); position: relative; transition: all 0.3s ease;"></div>
                        </div>
                        <span style="color: var(--text-color); font-weight: 500;">after</span>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <button type="button" id="decreaseOccurrences" style="width: 28px; height: 28px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); color: var(--text-color); font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">-</button>
                            <input type="number" id="occurrencesValue" value="1" min="1" max="100" style="width: 60px; text-align: center; padding: 6px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); font-size: 14px; color: var(--text-color);">
                            <button type="button" id="increaseOccurrences" style="width: 28px; height: 28px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); color: var(--text-color); font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">+</button>
                        </div>
                        <span style="color: var(--text-color); font-weight: 500;">occurrences</span>
                    </label>
                </div>

                <!-- Option 2: After X days/weeks -->
                <div style="margin-bottom: 15px; display: flex; flex-direction: column;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 0;">
                        <div style="position: relative; display: inline-block; width: 20px; height: 20px;">
                            <input type="radio" name="rotationType" value="time" id="rotateTime" style="position: absolute; opacity: 0; width: 100%; height: 100%; margin: 0; cursor: pointer;">
                            <div class="radio-custom" style="width: 20px; height: 20px; border: 2px solid var(--primary-color); border-radius: 50%; background: var(--light-bg); position: relative; transition: all 0.3s ease;"></div>
                        </div>
                        <span style="color: var(--text-color); font-weight: 500;">after</span>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <button type="button" id="decreaseTimeValue" style="width: 28px; height: 28px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); color: var(--text-color); font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">-</button>
                            <input type="number" id="timeValue" value="1" min="1" max="100" style="width: 60px; text-align: center; padding: 6px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); font-size: 14px; color: var(--text-color);">
                            <button type="button" id="increaseTimeValue" style="width: 28px; height: 28px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); color: var(--text-color); font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">+</button>
                        </div>
                        <select id="timeUnit" style="padding: 6px 8px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); font-size: 14px; color: var(--text-color);">
                            <option value="days">days</option>
                            <option value="weeks">weeks</option>
                        </select>
                    </label>
                </div>

                <!-- Option 3: After another family member completes -->
                <div style="margin-bottom: 8px; display: flex; flex-direction: column;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 0;">
                        <div style="position: relative; display: inline-block; width: 20px; height: 20px;">
                            <input type="radio" name="rotationType" value="completion" id="rotateCompletion" style="position: absolute; opacity: 0; width: 100%; height: 100%; margin: 0; cursor: pointer;">
                            <div class="radio-custom" style="width: 20px; height: 20px; border: 2px solid var(--primary-color); border-radius: 50%; background: var(--light-bg); position: relative; transition: all 0.3s ease;"></div>
                        </div>
                        <span style="color: var(--text-color); font-weight: 500;">after another family member completes</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Assign to:</label>
                <div id="userAvatarContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; align-items: center;">
                    <div id="userAvatarList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                </div>
                <input type="hidden" id="assignedToSelection" value="">
            </div>
            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label class="switch">
                        <input type="checkbox" id="buzzpointsToggle" checked>
                        <span class="slider"></span>
                    </label>
                    <label>Buzz Points:</label>
                </div>
                <div id="buzzpointsInputContainer" style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <button type="button" id="decreaseBuzzpoints" style="width: 32px; height: 32px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); color: var(--text-color); font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">-</button>
                        <input type="number" id="RewardValue" value="10" min="0" max="10000"
                            style="width: 80px; text-align: center; padding: 8px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); font-size: 14px; color: var(--text-color);">
                        <button type="button" id="increaseBuzzpoints" style="width: 32px; height: 32px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); color: var(--text-color); font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;">+</button>
                    </div>
                    <span style="font-size: 20px; color: var(--primary-color);">🍯</span>
                </div>
            </div>

            <!-- Parent Approval Toggle -->
            <div class="form-group">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1; position: relative;">
                        <label for="parentApprovalToggle" style="color: var(--text-color); font-weight: 600; cursor: pointer; flex: 1;">Parent Approval Required</label>
                        <i id="parentApprovalInfo" style="
                            font-size: 14px; 
                            cursor: pointer; 
                            border: 2px solid var(--text-color); 
                            border-radius: 50%; 
                            width: 20px; 
                            height: 20px; 
                            min-width: 20px;
                            min-height: 20px;
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            font-style: normal; 
                            font-weight: bold; 
                            font-family: serif;
                            transition: all 0.2s ease;
                            background: var(--light-bg);
                            color: var(--text-color);
                            flex-shrink: 0;
                        " 
                        onmouseover="this.style.background='var(--primary-color)'; this.style.borderColor='var(--primary-color)'; this.style.color='var(--secondary-color)'" 
                        onmouseout="this.style.background='var(--light-bg)'; this.style.borderColor='var(--text-color)'; this.style.color='var(--text-color)'"
                        onclick="window.toggleParentApprovalPopup(event)">i</i>
                        
                        <!-- Floating Popup -->
                        <div id="parentApprovalPopup" class="info-popup">
                            <strong>Parent Approval Required</strong><br><br>
                            <strong>ON:</strong> Tasks need parent approval before buzz points are awarded.<br><br>
                            <strong>OFF:</strong> Tasks are instantly completed and points awarded immediately.
                        </div>
                    </div>
                    <label class="switch" style="flex-shrink: 0; margin-left: 15px;">
                        <input type="checkbox" id="parentApprovalToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="button-row">
                <button type="submit" class="btn-save">SAVE</button>
                <button type="button" class="btn-cancel" onclick="handleCancel()">CANCEL</button>
            </div>
          

        </form>
    </div>


    <!-- Modals -->

    <div class="modal" id="roomModal">
        <div class="modal-content">
            <h3>Choose Rooms</h3>
            <ul id="roomList">
                <li data-value="Entire Home">Entire Home</li>
                <li data-value="Living Room">Living Room</li>
                <li data-value="Bedroom">Bedroom</li>
                <li data-value="Kitchen">Kitchen</li>
                <li data-value="Bathroom">Bathroom</li>
                <li data-value="Laundry">Laundry</li>
                <li data-value="Garden">Garden</li>
                <li data-value="Outside">Outside</li>
                <li data-value="Other">Other</li>
            </ul>
            <button class="close-btn" id="closeRoomModal">Save</button>
        </div>
    </div>
    



    <div class="modal" id="repeatModal">
        <div class="modal-content">
            <h3>Choose Repeat</h3>
            <ul>
                <li data-value="One Time">One Time</li>
                <li data-value="Daily">Daily</li>
                <li data-value="Weekly">Weekly</li>
                <li data-value="Monthly">Monthly</li>
            </ul>
        </div>
    </div>
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3>Choose Settings</h3>
            <ul>
                <li data-value="Rotation">Rotation</li>
                <li data-value="Team Work">Team Work</li>
                <li data-value="Individual">Individual</li>
            </ul>
        </div>
    </div>

    <div class="modal" id="timesPerDayModal">
        <div class="modal-content fancy-modal">
            <h3>How many times per day?</h3>
            <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 10px 0;">
                <button class="btn-save" data-value="1">1</button>
                <button class="btn-save" data-value="2">2</button>
                <button class="btn-save" data-value="3">3</button>
                <button class="btn-save" data-value="4">4</button>
                <button class="btn-save" data-value="5">5</button>
            </div>
            <input type="number" id="customTimesInput" placeholder="Or enter your own" min="1" class="fancy-input smaller-input">
            <div class="button-row">
                <button id="saveCustomTimesBtn" class="btn-save">SAVE</button>
                <button class="btn-cancel" id="closeTimesModal">CANCEL</button>
            </div>
        </div>
    </div>

    <div class="modal" id="timesPerWeekModal">
        <div class="modal-content fancy-modal">
            <h3>How many times per week?</h3>
            <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 10px 0;">
                <button class="btn-save" data-value="1">1</button>
                <button class="btn-save" data-value="2">2</button>
                <button class="btn-save" data-value="3">3</button>
                <button class="btn-save" data-value="4">4</button>
                <button class="btn-save" data-value="5">5</button>
            </div>
            <input type="number" id="customTimesWeekInput" placeholder="Or enter your own" min="1" class="fancy-input smaller-input">
            <div class="button-row">
                <button id="saveCustomTimesWeekBtn" class="btn-save">SAVE</button>
                <button id="closeTimesWeekModal" class="btn-cancel">CANCEL</button>
            </div>
        </div>
    </div>
    
<div class="modal" id="timesPerMonthModal">
    <div class="modal-content fancy-modal">
        <h3>How many times per month?</h3>
        <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 10px 0;">
            <button class="btn-save" data-value="1">1</button>
            <button class="btn-save" data-value="2">2</button>
            <button class="btn-save" data-value="3">3</button>
            <button class="btn-save" data-value="4">4</button>
            <button class="btn-save" data-value="5">5</button>
        </div>
        <input type="number" id="customTimesMonthInput" placeholder="Or enter your own" min="1" class="fancy-input smaller-input">
        <div class="button-row">
            <button id="saveCustomTimesMonthBtn" class="btn-save">SAVE</button>
            <button id="closeTimesMonthModal" class="btn-cancel">CANCEL</button>
        </div>
    </div>
</div>


<div class="modal" id="specificDatesModal">
    <div class="modal-content fancy-modal">
        <h3>Select Specific Dates</h3>
        <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 15px;">Choose dates for the task or leave empty for every day.</p>
        <div class="button-row">
            <button id="clearSpecificDates" class="btn-cancel">CLEAR</button>
            <button id="saveSpecificDates" class="btn-save">SAVE</button>
        </div>
        <div id="specificDatesCalendar" style="margin: 20px 0;"></div>
    </div>
</div>
   





    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="/BeeMazing-A1/shared/avatar-system.js"></script>
    <script src="/BeeMazing-A1/shared/taskrotations.js?t=${Date.now()}"></script>
    <script>


let editTaskFullDate = null; // Initialize as null

// Global variables for edit modes (accessible to form handler)
let isOccurrenceEdit = false;
let isFutureEdit = false;
let targetDate = null;
let splitDate = null;
let originalStartDate = null;
let editTask = null;

document.addEventListener("DOMContentLoaded", async () => {
    const currentAdmin = localStorage.getItem("currentAdminEmail");
    if (!currentAdmin) {
        alert("Admin not logged in!");
        return;
    }


    // Check if in edit mode via URL parameters or localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const editTitle = urlParams.get("editTitle");
    const editDate = urlParams.get("editDate");

    // Check for new editing modes from localStorage
    const editTaskData = localStorage.getItem("familyApp_editTask");
    const editTaskIndex = localStorage.getItem("familyApp_editTask_index");
    editTask = null;
    isOccurrenceEdit = false;
    isFutureEdit = false;
    targetDate = null;
    splitDate = null;
    originalStartDate = null;

    if (editTaskData) {
        try {
            editTask = JSON.parse(editTaskData);
            isOccurrenceEdit = editTask.isOccurrenceEdit || false;
            isFutureEdit = editTask.isFutureEdit || false;
            targetDate = editTask.targetDate || null;
            splitDate = editTask.splitDate || null;
            originalStartDate = editTask.originalStartDate || null;
            
            // Clear localStorage after reading
            localStorage.removeItem("familyApp_editTask");
            localStorage.removeItem("familyApp_editTask_index");
        } catch (error) {
            console.error("Error parsing edit task data:", error);
        }
    } else if (editTitle && editDate) {
        // Fetch all tasks from server and find the matching task
        try {
            const response = await fetch(`https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}`, {
                method: "GET",
                headers: { "Content-Type": "application/json" }
            });
            const data = await response.json();
            if (response.ok && data.tasks) {
                // Find task by title and date (date matches start date of range)
                editTask = data.tasks.find(task => task.title === editTitle && task.date.startsWith(editDate));
                if (!editTask) {
                    console.error(`Task not found: title=${editTitle}, date=${editDate}`);
                }
            } else {
                console.error("Failed to fetch tasks:", data.error || "No tasks returned");
            }
        } catch (error) {
            console.error("Error fetching tasks:", error);
        }
    }

    if (editTask) {
        // Set the full date range for the PUT request
        editTaskFullDate = editTask.date; // Assign value here
        // Populate form for editing
        document.getElementById("taskTitle").value = editTask.title || "";
        document.getElementById("taskNotes").value = editTask.notes || "";
        if (editTask.room) {
            selectedRooms = editTask.room.split(",").map(r => r.trim());
            document.getElementById("roomSelection").value = selectedRooms.join(", ");
            document.getElementById("selectRoom").textContent = selectedRooms.join(", ");
        }
        document.getElementById("repeatSelection").value = editTask.repeat || "";
        document.getElementById("selectRepeat").textContent = editTask.repeat || "Select";
        document.getElementById("settingsSelection").value = editTask.settings || "";
        document.getElementById("selectSettings").textContent = editTask.settings || "Select";
        
        // Handle rotation settings for edit mode
        if (editTask.settings === "Rotation") {
            document.getElementById("fairRotationSection").style.display = "block";
            document.getElementById("rotationOptions").style.display = "block";
            
            // Initialize rotation order from edit task
            if (editTask.rotationOrder) {
                rotationOrder = [...editTask.rotationOrder];
            } else if (editTask.users) {
                rotationOrder = [...editTask.users];
            }
            
            if (editTask.rotationSettings) {
                const rotationSettings = editTask.rotationSettings;
                
                if (rotationSettings.type === "occurrences") {
                    document.getElementById("rotateOccurrences").checked = true;
                    document.getElementById("occurrencesValue").value = rotationSettings.value || 1;
                } else if (rotationSettings.type === "time") {
                    document.getElementById("rotateTime").checked = true;
                    document.getElementById("timeValue").value = rotationSettings.value || 1;
                    document.getElementById("timeUnit").value = rotationSettings.unit || "days";
                } else if (rotationSettings.type === "completion") {
                    document.getElementById("rotateCompletion").checked = true;
                }
            }
        } else {
            document.getElementById("fairRotationSection").style.display = "none";
            document.getElementById("rotationOptions").style.display = "none";
            rotationOrder = [];
        }
        // COMMENTED OUT - REMINDERS
        // document.getElementById("taskReminder").checked = !!editTask.reminder;
        // document.getElementById("addAlarmBtn").style.display = editTask.reminder ? "inline-block" : "none";
        
        // Due Time functionality
        document.getElementById("dueTimeToggle").checked = !!editTask.dueTimes;
        document.getElementById("dueTimeContainer").style.display = editTask.dueTimes ? "block" : "none";
        document.getElementById("RewardValue").value = editTask.reward || "10";
        document.getElementById("buzzpointsToggle").checked = editTask.reward !== undefined && editTask.reward !== "";
        document.getElementById("buzzpointsInputContainer").style.display = (editTask.reward !== undefined && editTask.reward !== "") ? "flex" : "none";
        document.getElementById("fairRotationToggle").checked = editTask.fairRotation || false;
        document.getElementById("fairRotationTimeBasedToggle").checked = editTask.fairRotationTimeBased || false;
        document.getElementById("fairRotationAdvanced").style.display = editTask.fairRotation ? "block" : "none";
        document.getElementById("parentApprovalToggle").checked = editTask.parentApproval !== undefined ? editTask.parentApproval : true;

        // Handle times per day/week/month
        document.getElementById("timesPerDayInput").value = editTask.timesPerDay || "1";
        document.getElementById("timesPerWeekInput").value = editTask.timesPerWeek || "1";
        document.getElementById("timesPerMonthInput").value = editTask.timesPerMonth || "1";
        document.getElementById("timesPerDayGroup").style.display = editTask.repeat === "Daily" ? "flex" : "none";
        document.getElementById("timesPerWeekGroup").style.display = editTask.repeat === "Weekly" ? "flex" : "none";
        document.getElementById("timesPerMonthGroup").style.display = editTask.repeat === "Monthly" ? "flex" : "none";
        
        // Update section label and Any/All button based on frequency
        const sectionLabel = document.getElementById("sectionLabel");
        const anyAllButton = document.getElementById("anyAllButton");
        if (sectionLabel && anyAllButton) {
            if (editTask.repeat === "Daily") {
                sectionLabel.textContent = "Days";
                anyAllButton.textContent = "All";
                anyAllButton.setAttribute("data-day", "All");
            } else {
                sectionLabel.textContent = "Dates";
                anyAllButton.textContent = "Any";
                anyAllButton.setAttribute("data-day", "Any");
            }
        }

        // Handle date mode
        if (editTask.specificDates) {
            document.getElementById("dateModeSelection").value = "specific-dates";
            document.querySelectorAll(".mode-btn").forEach(btn => btn.classList.remove("active"));
            document.querySelector(".mode-btn[data-mode='specific-dates']").classList.add("active");
            document.getElementById("specificDatesGroup").style.display = "block";
            document.getElementById("fromToDateGroup").style.display = "none";
            document.getElementById("specificDaysGroup").style.display = "none";
            selectedDates = editTask.specificDates.split(",").map(date => new Date(date));
            specificDatesInput.value = editTask.specificDates;
            flatpickrSpecific.setDate(selectedDates);
            updateSelectedDatesDisplay();
        } else if (editTask.date) {
            document.getElementById("dateModeSelection").value = "date";
            document.querySelectorAll(".mode-btn").forEach(btn => btn.classList.remove("active"));
            document.querySelector(".mode-btn[data-mode='date']").classList.add("active");
            document.getElementById("fromToDateGroup").style.display = "block";
            document.getElementById("specificDatesGroup").style.display = "none";
            document.getElementById("specificDaysGroup").style.display = "block";

            const [from, to] = editTask.date.split(" to ");
            document.getElementById("taskDate").value = from || "";
            flatpickrFrom.setDate(from);
            document.getElementById("dateDisplay").textContent = new Date(from).toLocaleDateString(undefined, {
                month: "long",
                day: "numeric",
            });
            if (to && to !== "3000-01-01") {
                document.getElementById("taskDateTo").value = to;
                flatpickrTo.setDate(to);
                document.getElementById("dateDisplayTo").textContent = new Date(to).toLocaleDateString(undefined, {
                    month: "long",
                    day: "numeric",
                });
                document.getElementById("dateToWrapper").style.display = "inline";
                document.getElementById("dateDisplayTo").style.display = "inline-block";
                document.getElementById("removeEndDateBtn").style.display = "inline-block";
                addEndDateBtn.style.display = "none";
                dateMode = "from-to";
            } else {
                document.getElementById("taskDateTo").value = "";
                document.getElementById("dateDisplayTo").textContent = "To Date";
                document.getElementById("dateToWrapper").style.display = "none";
                document.getElementById("dateDisplayTo").style.display = "none";
                document.getElementById("removeEndDateBtn").style.display = "none";
                addEndDateBtn.style.display = "inline-block";
                dateMode = "from";
            }

            // Handle days of week for edit mode
            selectedDays = editTask.daysOfWeek || (editTask.repeat === "Daily" ? ["All"] : ["Any"]);
            updateSelectedDaysDisplay();
        }

        // Special handling for single occurrence and future edits
        if (isOccurrenceEdit && targetDate) {
            // For single occurrence edit, set the date to the target date and disable date changes
            document.getElementById("dateModeSelection").value = "date";
            document.getElementById("taskDate").value = targetDate;
            flatpickrFrom.setDate(targetDate);
            document.getElementById("dateDisplay").textContent = new Date(targetDate).toLocaleDateString(undefined, {
                month: "long",
                day: "numeric",
            });
            // Hide end date for single occurrence and disable date inputs
            document.getElementById("taskDateTo").value = "";
            dateToWrapper.style.display = "none";
            addEndDateBtn.style.display = "none";
            
            // Disable date changes for single occurrence
            document.getElementById("taskDate").disabled = true;
            document.getElementById("dateModeSelection").disabled = true;
            if (flatpickrFrom) flatpickrFrom.destroy();
            
            // Add notice
            const form = document.getElementById("addTaskForm");
            const notice = document.createElement("div");
            notice.style.background = "#ffeb3b";
            notice.style.color = "#333";
            notice.style.padding = "10px";
            notice.style.borderRadius = "8px";
            notice.style.marginBottom = "15px";
            notice.style.fontWeight = "bold";
            notice.innerHTML = `📅 Editing single occurrence for ${new Date(targetDate).toLocaleDateString()} - Date cannot be changed`;
            form.insertBefore(notice, form.firstChild);
            
        } else if (isFutureEdit && splitDate) {
            // For future edit, set the date from split date onwards
            document.getElementById("dateModeSelection").value = "date";
            document.getElementById("taskDate").value = splitDate;
            flatpickrFrom.setDate(splitDate);
            document.getElementById("dateDisplay").textContent = new Date(splitDate).toLocaleDateString(undefined, {
                month: "long",
                day: "numeric",
            });
            
            // Keep original end date if it exists
            const originalRange = editTask.date.split(" to ");
            const originalEnd = originalRange[1];
            if (originalEnd && originalEnd !== "3000-01-01") {
                document.getElementById("taskDateTo").value = originalEnd;
                flatpickrTo.setDate(originalEnd);
                document.getElementById("dateDisplayTo").textContent = new Date(originalEnd).toLocaleDateString(undefined, {
                    month: "long",
                    day: "numeric",
                });
                document.getElementById("dateToWrapper").style.display = "inline";
                document.getElementById("dateDisplayTo").style.display = "inline-block";
                document.getElementById("removeEndDateBtn").style.display = "inline-block";
                addEndDateBtn.style.display = "none";
            }
            
            // Add notice
            const form = document.getElementById("addTaskForm");
            const notice = document.createElement("div");
            notice.style.background = "#2196f3";
            notice.style.color = "white";
            notice.style.padding = "10px";
            notice.style.borderRadius = "8px";
            notice.style.marginBottom = "15px";
            notice.style.fontWeight = "bold";
            notice.innerHTML = `🔄 Editing from ${new Date(splitDate).toLocaleDateString()} onwards - Start date locked`;
            form.insertBefore(notice, form.firstChild);
            
            // Disable start date changes for future edit
            document.getElementById("taskDate").disabled = true;
        }

        if (editTask.users) {
            selectedUsers = [...editTask.users].map(u => u.trim()).filter(u => u);
            updateSelectedUsersDisplay();
            populateUsers();
        }

        // COMMENTED OUT - ALARMS
        /*
        if (editTask.alarms?.length) {
            alarms = [...editTask.alarms];
            alarms.forEach((time) => {
                const alarmWrapper = document.createElement("div");
                alarmWrapper.style.marginBottom = "10px";
                alarmWrapper.style.display = "flex";
                alarmWrapper.style.alignItems = "center";
                const alarmInput = document.createElement("input");
                alarmInput.type = "time";
                alarmInput.value = time;
                alarmInput.style.marginRight = "10px";
                alarmInput.style.padding = "10px";
                alarmInput.style.border = "2px solid var(--primary-color)";
                alarmInput.style.borderRadius = "8px";
                alarmInput.style.background = "var(--accent-color)";
                const removeButton = document.createElement("button");
                removeButton.textContent = "Remove";
                removeButton.style.padding = "5px 10px";
                removeButton.style.marginLeft = "10px";
                removeButton.addEventListener("click", () => {
                    alarmWrapper.remove();
                    alarms = alarms.filter((a) => a !== time);
                });
                alarmWrapper.appendChild(alarmInput);
                alarmWrapper.appendChild(removeButton);
                alarmContainer.appendChild(alarmWrapper);
            });
        }
        */

        // Due Time functionality for edit mode
        if (editTask.dueTimes?.length) {
            dueTimes = [...editTask.dueTimes];
            updateDueTimeDisplay();
        }
    } else {
        // Initialize form for new task
        populateUsers();
        document.getElementById("dateModeSelection").value = "date";
        document.querySelectorAll(".mode-btn").forEach(btn => btn.classList.remove("active"));
        document.querySelector(".mode-btn[data-mode='date']").classList.add("active");
        document.getElementById("fromToDateGroup").style.display = "block";
        document.getElementById("specificDatesGroup").style.display = "none";
        document.getElementById("specificDaysGroup").style.display = "block";
    }


});

// Global modal functions - moved outside DOMContentLoaded scope
function showModal(modal) {
    modal.classList.remove('hide');
    modal.classList.add('show');
    modal.style.display = 'flex';
}

// Hide modal with smooth transition
function hideModal(modal) {
    modal.classList.remove('show');
    modal.classList.add('hide');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

function setupTimesModal(inputEl, modalEl, closeBtnEl, customInputEl, saveBtnEl) {
    // Open modal on focus
    inputEl.addEventListener("focus", () => {
        customInputEl.value = "";
        showModal(modalEl);
    });

    // Setup quick select buttons
    modalEl.querySelectorAll('button[data-value]').forEach(btn => {
        btn.addEventListener("click", () => {
            inputEl.value = btn.getAttribute("data-value");
            hideModal(modalEl);
        });
    });

    // Save custom value
    saveBtnEl.addEventListener("click", () => {
        let val = parseInt(customInputEl.value.trim());
        if (val && val > 0) {
            val = Math.min(val, 100);
            inputEl.value = val;
            hideModal(modalEl);
        }
    });

    // Close modal
    closeBtnEl.addEventListener("click", () => {
        hideModal(modalEl);
    });
}

    
        // User Avatar Selection Logic
        const assignedToSelection = document.getElementById("assignedToSelection");

        let selectedUsers = [];
        let rotationOrder = []; // Track order of selection for rotation








        async function populateUsers() {
    const currentAdmin = localStorage.getItem("currentAdminEmail");
    if (!currentAdmin) {
        console.error("No admin email found in localStorage");
        return;
    }

    try {
        const response = await fetch(`https://beemazing1.onrender.com/get-users?adminEmail=${encodeURIComponent(currentAdmin)}`, {
            method: "GET",
            headers: { "Content-Type": "application/json" }
        });

        const data = await response.json();
        console.log("Fetched users:", data); // Debug log

        if (!response.ok || !data.success) {
            throw new Error(data.message || `HTTP ${response.status}`);
        }

        const { users = [], permissions = {} } = data;

        // Store users globally for other functions
        window.allUsers = users;

        // Update localStorage to sync with backend
        const allUserData = JSON.parse(localStorage.getItem("userData") || "{}");
        allUserData[currentAdmin] = allUserData[currentAdmin] || { users: [], permissions: {} };
        allUserData[currentAdmin].users = users;
        allUserData[currentAdmin].permissions = permissions;
        localStorage.setItem("userData", JSON.stringify(allUserData));

        // Get avatar container
        const userAvatarList = document.getElementById("userAvatarList");
        userAvatarList.innerHTML = "";

        // Initialize avatar system if not already done
        if (typeof window.avatarSystem === 'undefined') {
            window.avatarSystem = new AvatarSystem();
            await window.avatarSystem.initialize();
        }

        // Create "All" avatar button first
        const allAvatarContainer = document.createElement("div");
        allAvatarContainer.style.position = "relative";
        allAvatarContainer.style.cursor = "pointer";
        allAvatarContainer.id = "allUsersBtn";
        
        // Create All avatar with consistent styling
        const allAvatar = document.createElement("div");
        allAvatar.className = "user-avatar medium";
        allAvatar.style.background = "var(--primary-color)";
        allAvatar.style.color = "var(--secondary-color)";
        allAvatar.style.fontSize = "14px";
        allAvatar.style.fontWeight = "bold";
        allAvatar.style.width = "40px";
        allAvatar.style.height = "40px";
        allAvatar.style.borderRadius = "50%";
        allAvatar.style.display = "flex";
        allAvatar.style.alignItems = "center";
        allAvatar.style.justifyContent = "center";
        allAvatar.style.border = "2px solid rgba(255, 255, 255, 0.2)";
        allAvatar.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
        allAvatar.textContent = "All";
        allAvatar.title = "Select all users";
        allAvatar.style.transition = "all 0.3s ease";
        
        allAvatarContainer.appendChild(allAvatar);
        
        // All button click handler
        allAvatarContainer.addEventListener("click", () => {
            const currentSettings = document.getElementById("settingsSelection").value;
            
            if (allAvatarContainer.classList.contains('active')) {
                // Deselect All
                allAvatarContainer.classList.remove('active');
                selectedUsers = [];
                if (currentSettings === "Rotation") {
                    rotationOrder = [];
                }
            } else {
                // Select All
                allAvatarContainer.classList.add('active');
                selectedUsers = window.allUsers ? [...window.allUsers] : [];
                if (currentSettings === "Rotation") {
                    rotationOrder = window.allUsers ? [...window.allUsers] : [];
                }
            }
            updateSelectedUsersDisplay();
        });
        
        // Hover effects for All button
        allAvatarContainer.addEventListener("mouseenter", () => {
            allAvatar.style.transform = "scale(1.1)";
        });
        
        allAvatarContainer.addEventListener("mouseleave", () => {
            allAvatar.style.transform = "scale(1)";
        });
        
        userAvatarList.appendChild(allAvatarContainer);

        // Populate user avatars
        users.forEach((user, index) => {
            const avatarContainer = document.createElement("div");
            avatarContainer.style.position = "relative";
            avatarContainer.style.cursor = "pointer";
            
            // Generate avatar HTML
            const avatarHTML = window.avatarSystem.generateAvatarHTML(user, 'medium');
            avatarContainer.innerHTML = avatarHTML;
            
            const avatar = avatarContainer.querySelector('.user-avatar');
            if (avatar) {
                avatar.title = user; // Tooltip with username
                avatar.style.transition = 'all 0.3s ease';
                // Ensure perfect circle with consistent dimensions
                avatar.style.width = "40px";
                avatar.style.height = "40px";
                avatar.style.borderRadius = "50%";
                avatar.style.display = "flex";
                avatar.style.alignItems = "center";
                avatar.style.justifyContent = "center";
                avatar.style.fontSize = "14px";
                avatar.style.fontWeight = "bold";
                avatar.style.border = "2px solid rgba(255, 255, 255, 0.2)";
                avatar.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
                
                // Click handler for individual avatar
                avatarContainer.addEventListener("click", () => {
                    const allUsersBtn = document.getElementById("allUsersBtn");
                    const currentSettings = document.getElementById("settingsSelection").value;
                    
                    if (allUsersBtn.classList.contains('active')) {
                        // If "All" is currently selected, deselect it and select only this user
                        allUsersBtn.classList.remove('active');
                        selectedUsers = [user];
                        if (currentSettings === "Rotation") {
                            rotationOrder = [user];
                        }
                    } else {
                        // Normal toggle behavior
                        if (selectedUsers.includes(user)) {
                            // Deselect this user
                            selectedUsers = selectedUsers.filter(u => u !== user);
                            if (currentSettings === "Rotation") {
                                rotationOrder = rotationOrder.filter(u => u !== user);
                            }
                        } else {
                            // Select this user
                            selectedUsers.push(user);
                            if (currentSettings === "Rotation") {
                                rotationOrder.push(user);
                            }
                        }
                    }
                    updateSelectedUsersDisplay();
                });
                
                // Hover effects
                avatarContainer.addEventListener("mouseenter", () => {
                    avatar.style.transform = "scale(1.1)";
                });
                
                avatarContainer.addEventListener("mouseleave", () => {
                    avatar.style.transform = "scale(1)";
                });
            }
            
            userAvatarList.appendChild(avatarContainer);
        });

        // Update display
        updateSelectedUsersDisplay();

    } catch (error) {
        console.error("Error fetching users:", error);
    }
}








    
        const updateSelectedUsersDisplay = () => {
    // Clean the selectedUsers array just in case
    selectedUsers = selectedUsers.map(u => u.trim()).filter(u => u);

    // Set value for form submission
    assignedToSelection.value = selectedUsers.join(", ");
    
    // Validate rotation if it's selected
    const currentSettings = document.getElementById("settingsSelection").value;
    if (currentSettings === "Rotation") {
        validateRotationUsers();
    }
    
    // Update visual state of all avatars
    const userAvatarList = document.getElementById("userAvatarList");
    const avatarContainers = userAvatarList.querySelectorAll('div[style*="position: relative"]');
    const allUsersBtn = document.getElementById("allUsersBtn");
    
    // Check if all users are selected
    const allSelected = window.allUsers && window.allUsers.length > 0 && 
                       window.allUsers.every(user => selectedUsers.includes(user));
    
    // Update "All" button visual state
    const allAvatar = allUsersBtn ? allUsersBtn.querySelector('.user-avatar') : null;
    if (allUsersBtn && allAvatar) {
        // Remove existing checkmark if any
        const existingCheckmark = allUsersBtn.querySelector('.avatar-checkmark');
        if (existingCheckmark) {
            existingCheckmark.remove();
        }
        
        if (allSelected) {
            allUsersBtn.classList.add('active');
            allAvatar.style.boxShadow = '0 0 0 4px rgba(255, 193, 7, 0.9)';
            allAvatar.style.border = '3px solid var(--primary-color)';
            allAvatar.style.transform = 'scale(1.1)';
            allAvatar.style.filter = 'brightness(1.2)';
            
            // Add checkmark overlay to All button
            const checkmark = document.createElement('div');
            checkmark.className = 'avatar-checkmark';
            checkmark.innerHTML = '✓';
            checkmark.style.position = 'absolute';
            checkmark.style.top = '-5px';
            checkmark.style.right = '-5px';
            checkmark.style.width = '20px';
            checkmark.style.height = '20px';
            checkmark.style.backgroundColor = 'var(--primary-color)';
            checkmark.style.color = 'white';
            checkmark.style.borderRadius = '50%';
            checkmark.style.display = 'flex';
            checkmark.style.alignItems = 'center';
            checkmark.style.justifyContent = 'center';
            checkmark.style.fontSize = '12px';
            checkmark.style.fontWeight = 'bold';
            checkmark.style.border = '2px solid white';
            checkmark.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
            allUsersBtn.appendChild(checkmark);
        } else {
            allUsersBtn.classList.remove('active');
            allAvatar.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            allAvatar.style.border = '2px solid rgba(255, 255, 255, 0.2)';
            allAvatar.style.transform = 'scale(1)';
            allAvatar.style.filter = 'none';
        }
    }
    
    // Skip the first container (which is the All button) and process user avatars
    avatarContainers.forEach((container, index) => {
        if (index === 0) return; // Skip the All button
        const avatar = container.querySelector('.user-avatar');
        const user = window.allUsers ? window.allUsers[index - 1] : null; // Adjust index for All button
        
        // Remove existing checkmark/number if any
        const existingCheckmark = container.querySelector('.avatar-checkmark');
        if (existingCheckmark) {
            existingCheckmark.remove();
        }
        
        if (user && selectedUsers.includes(user) && !allSelected) {
            avatar.style.boxShadow = '0 0 0 4px rgba(255, 193, 7, 0.9)';
            avatar.style.border = '3px solid var(--primary-color)';
            avatar.style.transform = 'scale(1.1)';
            avatar.style.filter = 'brightness(1.2)';
            
            // Add rotation number or checkmark overlay
            const currentSettings = document.getElementById("settingsSelection").value;
            const indicator = document.createElement('div');
            indicator.className = 'avatar-checkmark';
            
            if (currentSettings === "Rotation") {
                const rotationIndex = rotationOrder.indexOf(user);
                indicator.innerHTML = rotationIndex !== -1 ? (rotationIndex + 1).toString() : '✓';
            } else {
                indicator.innerHTML = '✓';
            }
            
            indicator.style.position = 'absolute';
            indicator.style.top = '-5px';
            indicator.style.right = '-5px';
            indicator.style.width = '20px';
            indicator.style.height = '20px';
            indicator.style.backgroundColor = 'var(--primary-color)';
            indicator.style.color = 'white';
            indicator.style.borderRadius = '50%';
            indicator.style.display = 'flex';
            indicator.style.alignItems = 'center';
            indicator.style.justifyContent = 'center';
            indicator.style.fontSize = '12px';
            indicator.style.fontWeight = 'bold';
            indicator.style.border = '2px solid white';
            indicator.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
            container.appendChild(indicator);
        } else if (user && allSelected && document.getElementById("settingsSelection").value === "Rotation") {
            // Show rotation numbers when "All" is selected for rotation
            avatar.style.boxShadow = '0 0 0 4px rgba(255, 193, 7, 0.9)';
            avatar.style.border = '3px solid var(--primary-color)';
            avatar.style.transform = 'scale(1.1)';
            avatar.style.filter = 'brightness(1.2)';
            
            const indicator = document.createElement('div');
            indicator.className = 'avatar-checkmark';
            const rotationIndex = rotationOrder.indexOf(user);
            indicator.innerHTML = rotationIndex !== -1 ? (rotationIndex + 1).toString() : (index).toString();
            indicator.style.position = 'absolute';
            indicator.style.top = '-5px';
            indicator.style.right = '-5px';
            indicator.style.width = '20px';
            indicator.style.height = '20px';
            indicator.style.backgroundColor = 'var(--primary-color)';
            indicator.style.color = 'white';
            indicator.style.borderRadius = '50%';
            indicator.style.display = 'flex';
            indicator.style.alignItems = 'center';
            indicator.style.justifyContent = 'center';
            indicator.style.fontSize = '12px';
            indicator.style.fontWeight = 'bold';
            indicator.style.border = '2px solid white';
            indicator.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
            container.appendChild(indicator);
        } else {
            avatar.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            avatar.style.border = '2px solid rgba(255, 255, 255, 0.2)';
            avatar.style.transform = 'scale(1)';
            avatar.style.filter = 'none';
        }
    });
};


        // All button is now handled in populateUsers function
    
        // No modal needed for avatar selection
    
        // Buzzpoints Toggle and Stepper Logic
        const buzzpointsToggle = document.getElementById("buzzpointsToggle");
        const buzzpointsContainer = document.getElementById("buzzpointsInputContainer");
        const rewardValueInput = document.getElementById("RewardValue");
        const decreaseBuzzpoints = document.getElementById("decreaseBuzzpoints");
        const increaseBuzzpoints = document.getElementById("increaseBuzzpoints");

        // Fair Rotation Toggle Logic
        const fairRotationToggle = document.getElementById("fairRotationToggle");
        const fairRotationAdvanced = document.getElementById("fairRotationAdvanced");

        fairRotationToggle.addEventListener("change", () => {
            if (fairRotationToggle.checked) {
                fairRotationAdvanced.style.display = "block";
            } else {
                fairRotationAdvanced.style.display = "none";
                document.getElementById("fairRotationTimeBasedToggle").checked = false;
            }
        });

        buzzpointsToggle.addEventListener("change", () => {
            if (buzzpointsToggle.checked) {
                buzzpointsContainer.style.display = "flex";
                if (!rewardValueInput.value || rewardValueInput.value === "0") {
                    rewardValueInput.value = "10";
                }
            } else {
                buzzpointsContainer.style.display = "none";
            }
        });

        decreaseBuzzpoints.addEventListener("click", () => {
            let currentValue = parseInt(rewardValueInput.value) || 0;
            let decreaseAmount = currentValue >= 100 ? 50 : (currentValue >= 50 ? 10 : 5);
            let newValue = Math.max(0, currentValue - decreaseAmount);
            rewardValueInput.value = newValue;
        });

        increaseBuzzpoints.addEventListener("click", () => {
            let currentValue = parseInt(rewardValueInput.value) || 0;
            let increaseAmount = currentValue >= 100 ? 50 : (currentValue >= 50 ? 10 : 5);
            let newValue = Math.min(10000, currentValue + increaseAmount);
            rewardValueInput.value = newValue;
        });

        // Add hover effects for stepper buttons
        [decreaseBuzzpoints, increaseBuzzpoints].forEach(btn => {
            btn.addEventListener('mouseenter', () => {
                btn.style.background = 'var(--primary-color)';
                btn.style.color = 'var(--secondary-color)';
            });
            btn.addEventListener('mouseleave', () => {
                btn.style.background = 'var(--light-bg)';
                btn.style.color = 'var(--text-color)';
            });
        });

        // Validate input on change
        rewardValueInput.addEventListener("input", () => {
            let value = parseInt(rewardValueInput.value) || 0;
            if (value < 0) value = 0;
            if (value > 10000) value = 10000;
            rewardValueInput.value = value;
        });
    
        // Generic Modal Setup
        function setupModal(modalId, buttonId, inputId) {
            const modal = document.getElementById(modalId);
            const button = document.getElementById(buttonId);
            const input = document.getElementById(inputId);
    
            button.addEventListener('click', () => {
                showModal(modal);
            });
    
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideModal(modal);
                }
            });
    
            modal.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    input.value = e.target.getAttribute('data-value');
                    button.textContent = e.target.getAttribute('data-value');
                    hideModal(modal);
                }
            });
        }

        // Center popup in viewport function
        function positionPopup(popup, triggerElement) {
            const popupHeight = 200; // Estimated popup height
            const popupWidth = popup.offsetWidth || 300;
            const viewport = {
                width: window.innerWidth,
                height: window.innerHeight
            };
            const scrollY = window.scrollY;
            const scrollX = window.scrollX;
            
            // Center popup in the current viewport
            let top = scrollY + (viewport.height - popupHeight) / 2;
            let left = scrollX + (viewport.width - popupWidth) / 2;
            
            // Ensure minimum margins from edges
            if (left < scrollX + 20) {
                left = scrollX + 20;
            }
            if (left + popupWidth > scrollX + viewport.width - 20) {
                left = scrollX + viewport.width - popupWidth - 20;
            }
            
            if (top < scrollY + 20) {
                top = scrollY + 20;
            }
            if (top + popupHeight > scrollY + viewport.height - 20) {
                top = scrollY + viewport.height - popupHeight - 20;
            }
            
            // Apply positioning
            popup.style.top = top + 'px';
            popup.style.left = left + 'px';
            
            // Remove arrow classes since popup is centered
            popup.className = popup.className.replace(/arrow-\w+/g, '');
        }

        // Parent Approval Popup Toggle
        function toggleParentApprovalPopup(event) {
            event.stopPropagation();
            const popup = document.getElementById('parentApprovalPopup');
            const isShowing = popup.classList.contains('show');
            
            if (!isShowing) {
                positionPopup(popup, event.target);
            }
            
            popup.classList.toggle('show');
        }

        // Settings Popup Toggle
        function toggleSettingsPopup(event) {
            event.stopPropagation();
            const popup = document.getElementById('settingsPopup');
            const isShowing = popup.classList.contains('show');
            
            if (!isShowing) {
                positionPopup(popup, event.target);
            }
            
            popup.classList.toggle('show');
        }

        // Close popup when clicking outside
        document.addEventListener('click', function(event) {
            const parentPopup = document.getElementById('parentApprovalPopup');
            const parentIcon = document.getElementById('parentApprovalInfo');
            const settingsPopup = document.getElementById('settingsPopup');
            const settingsIcon = document.getElementById('settingsInfo');
            
            if (parentPopup && parentIcon && !parentPopup.contains(event.target) && !parentIcon.contains(event.target)) {
                parentPopup.classList.remove('show');
            }
            
            if (settingsPopup && settingsIcon && !settingsPopup.contains(event.target) && !settingsIcon.contains(event.target)) {
                settingsPopup.classList.remove('show');
            }
        });

        // Make functions globally available
        window.toggleParentApprovalPopup = toggleParentApprovalPopup;
        window.toggleSettingsPopup = toggleSettingsPopup;

        // Custom setup for settings modal to handle rotation options
        const settingsModal = document.getElementById('settingsModal');
        const settingsButton = document.getElementById('selectSettings');
        const settingsInput = document.getElementById('settingsSelection');
        const rotationOptions = document.getElementById('rotationOptions');

        settingsButton.addEventListener('click', () => {
            showModal(settingsModal);
        });

        window.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                hideModal(settingsModal);
            }
        });

        settingsModal.addEventListener('click', (e) => {
            if (e.target.tagName === 'LI') {
                const selectedValue = e.target.getAttribute('data-value');
                settingsInput.value = selectedValue;
                settingsButton.textContent = selectedValue;
                hideModal(settingsModal);
                
                // Show/hide rotation options based on selection
                if (selectedValue === 'Rotation') {
                    document.getElementById("fairRotationSection").style.display = 'block';
                    rotationOptions.style.display = 'block';
                    validateRotationUsers();
                    // Initialize rotation order for current selections
                    if (selectedUsers.length > 0) {
                        rotationOrder = [...selectedUsers];
                        updateSelectedUsersDisplay();
                    }
                } else {
                    document.getElementById("fairRotationSection").style.display = 'none';
                    rotationOptions.style.display = 'none';
                    rotationOrder = []; // Clear rotation order when not using rotation
                }
            }
        });

        // Rotation options stepper functionality
        const decreaseOccurrences = document.getElementById('decreaseOccurrences');
        const increaseOccurrences = document.getElementById('increaseOccurrences');
        const occurrencesValue = document.getElementById('occurrencesValue');
        const decreaseTimeValue = document.getElementById('decreaseTimeValue');
        const increaseTimeValue = document.getElementById('increaseTimeValue');
        const timeValue = document.getElementById('timeValue');

        // Occurrences stepper
        decreaseOccurrences.addEventListener('click', () => {
            let value = parseInt(occurrencesValue.value) || 1;
            if (value > 1) {
                occurrencesValue.value = value - 1;
            }
        });

        increaseOccurrences.addEventListener('click', () => {
            let value = parseInt(occurrencesValue.value) || 1;
            if (value < 100) {
                occurrencesValue.value = value + 1;
            }
        });

        // Time value stepper
        decreaseTimeValue.addEventListener('click', () => {
            let value = parseInt(timeValue.value) || 1;
            if (value > 1) {
                timeValue.value = value - 1;
            }
        });

        increaseTimeValue.addEventListener('click', () => {
            let value = parseInt(timeValue.value) || 1;
            if (value < 100) {
                timeValue.value = value + 1;
            }
        });

        // Input validation
        occurrencesValue.addEventListener('input', () => {
            let value = parseInt(occurrencesValue.value) || 1;
            if (value < 1) value = 1;
            if (value > 100) value = 100;
            occurrencesValue.value = value;
        });

        timeValue.addEventListener('input', () => {
            let value = parseInt(timeValue.value) || 1;
            if (value < 1) value = 1;
            if (value > 100) value = 100;
            timeValue.value = value;
        });

        // Custom radio button styling and functionality
        const radioButtons = document.querySelectorAll('input[name="rotationType"]');
        const radioCustoms = document.querySelectorAll('.radio-custom');

        function updateRadioButtons() {
            radioButtons.forEach((radio, index) => {
                const customRadio = radioCustoms[index];
                if (radio.checked) {
                    customRadio.style.background = 'var(--primary-color)';
                    customRadio.style.border = '2px solid var(--primary-color)';
                    // Add inner dot
                    if (!customRadio.querySelector('.radio-dot')) {
                        const dot = document.createElement('div');
                        dot.className = 'radio-dot';
                        dot.style.width = '8px';
                        dot.style.height = '8px';
                        dot.style.background = 'var(--secondary-color)';
                        dot.style.borderRadius = '50%';
                        dot.style.position = 'absolute';
                        dot.style.top = '50%';
                        dot.style.left = '50%';
                        dot.style.transform = 'translate(-50%, -50%)';
                        customRadio.appendChild(dot);
                    }
                } else {
                    customRadio.style.background = 'var(--light-bg)';
                    customRadio.style.border = '2px solid var(--primary-color)';
                    // Remove inner dot
                    const dot = customRadio.querySelector('.radio-dot');
                    if (dot) {
                        dot.remove();
                    }
                }
            });
        }

        radioButtons.forEach((radio) => {
            radio.addEventListener('change', updateRadioButtons);
        });

        // Initialize radio button styling
        updateRadioButtons();

        // Add hover effects for stepper buttons
        const stepperButtons = [decreaseOccurrences, increaseOccurrences, decreaseTimeValue, increaseTimeValue];
        stepperButtons.forEach(btn => {
            btn.addEventListener('mouseenter', () => {
                btn.style.background = 'var(--primary-color)';
                btn.style.color = 'var(--secondary-color)';
            });
            btn.addEventListener('mouseleave', () => {
                btn.style.background = 'var(--light-bg)';
                btn.style.color = 'var(--text-color)';
            });
        });

        // Validation for rotation requiring at least 2 users
        function validateRotationUsers() {
            const allUsersBtn = document.getElementById("allUsersBtn");
            const isAllSelected = allUsersBtn && allUsersBtn.classList.contains('active');
            const individualUsersSelected = selectedUsers.length;
            const totalUsersSelected = isAllSelected ? (window.allUsers ? window.allUsers.length : 0) : individualUsersSelected;
            
            const userAvatarContainer = document.getElementById("userAvatarContainer");
            const existingWarning = document.getElementById("rotationWarning");
            
            if (existingWarning) {
                existingWarning.remove();
            }
            
            if (totalUsersSelected < 2) {
                const warning = document.createElement('div');
                warning.id = 'rotationWarning';
                warning.style.color = 'var(--text-color)';
                warning.style.fontSize = '14px';
                warning.style.fontWeight = '500';
                warning.style.marginTop = '8px';
                warning.style.padding = '10px 12px';
                warning.style.backgroundColor = 'rgba(255, 193, 7, 0.15)';
                warning.style.border = '1px solid rgba(255, 193, 7, 0.4)';
                warning.style.borderRadius = '8px';
                warning.style.borderLeft = '4px solid var(--primary-color)';
                warning.innerHTML = '<span style="display: inline-block; width: 18px; height: 18px; background: var(--primary-color); color: var(--secondary-color); border-radius: 50%; text-align: center; line-height: 18px; font-size: 12px; font-weight: bold; margin-right: 8px; vertical-align: middle;">i</span>Choose at least 2 family members';
                userAvatarContainer.appendChild(warning);
            }
        }




        const roomModal = document.getElementById("roomModal");
const roomList = document.getElementById("roomList");
const roomInput = document.getElementById("roomSelection");
const roomButton = document.getElementById("selectRoom");
const closeRoomModal = document.getElementById("closeRoomModal");

let selectedRooms = [];

roomButton.addEventListener("click", () => {
    showModal(roomModal);
});

roomList.querySelectorAll("li").forEach(item => {
    item.style.cursor = "pointer";
    item.style.padding = "10px";
    item.style.margin = "5px 0";
    item.style.border = "1px solid var(--selection-border)";
    item.style.borderRadius = "8px";
    item.style.textAlign = "center";

    item.addEventListener("click", () => {
        const value = item.getAttribute("data-value");
        if (selectedRooms.includes(value)) {
            selectedRooms = selectedRooms.filter(r => r !== value);
            item.style.backgroundColor = "var(--light-bg)";
            item.style.color = "var(--text-color)";
        } else {
            selectedRooms.push(value);
            item.style.backgroundColor = "var(--primary-color)";
            item.style.color = "var(--secondary-color)";
        }
        roomInput.value = selectedRooms.join(", ");
        roomButton.textContent = selectedRooms.length > 0
            ? selectedRooms.join(", ")
            : "Select";
    });
});

closeRoomModal.addEventListener("click", () => {
    hideModal(roomModal);
});

window.addEventListener("click", (e) => {
    if (e.target === roomModal) {
        hideModal(roomModal);
    }
});

// Form submission handler - in global scope with access to global variables
document.addEventListener("DOMContentLoaded", () => {
document.getElementById("addTaskForm").addEventListener("submit", async function (event) {
event.preventDefault();

const title = document.getElementById("taskTitle").value.trim();
const notes = document.getElementById("taskNotes").value.trim();
const room = document.getElementById("roomSelection").value;
const repeat = document.getElementById("repeatSelection").value;
const settings = document.getElementById("settingsSelection").value;
let rotationSettings = undefined;

// Capture rotation settings if Rotation is selected
if (settings === "Rotation") {
    const rotationType = document.querySelector('input[name="rotationType"]:checked').value;
    
    if (rotationType === "occurrences") {
        rotationSettings = {
            type: "occurrences",
            value: parseInt(document.getElementById("occurrencesValue").value) || 1
        };
    } else if (rotationType === "time") {
        rotationSettings = {
            type: "time",
            value: parseInt(document.getElementById("timeValue").value) || 1,
            unit: document.getElementById("timeUnit").value
        };
    } else if (rotationType === "completion") {
        rotationSettings = {
            type: "completion"
        };
    }
}
const dateFrom = document.getElementById("taskDate").value;
const dateTo = document.getElementById("taskDateTo").value;
const singleDate = document.getElementById("singleTaskDate").value;
const dateMode = document.getElementById("dateModeSelection").value;
const dueTimeEnabled = document.getElementById("dueTimeToggle").checked;
const users = document.getElementById("assignedToSelection").value
    .split(",")
    .map(u => u.trim())
    .filter(u => u);

// Validate rotation settings require at least 2 users
if (settings === "Rotation") {
    const allUsersBtn = document.getElementById("allUsersBtn");
    const isAllSelected = allUsersBtn && allUsersBtn.classList.contains('active');
    const totalUsersSelected = isAllSelected ? (window.allUsers ? window.allUsers.length : 0) : users.length;
    
    if (totalUsersSelected < 2) {
        alert("⚠️ Rotation requires at least 2 family members to be assigned. Please select more users.");
        return;
    }
}

const reward = document.getElementById("buzzpointsToggle").checked ? document.getElementById("RewardValue").value : undefined;
let timesPerDay = parseInt(document.getElementById("timesPerDayInput").value) || null;
let timesPerWeek = parseInt(document.getElementById("timesPerWeekInput").value) || null;
let timesPerMonth = parseInt(document.getElementById("timesPerMonthInput").value) || null;
const specificDates = document.getElementById("specificDatesInput").value;

// Validations
if (!title) {
    alert("Task title is required!");
    return;
}
if (users.length === 0) {
    alert("Please assign at least one user.");
    return;
}
        
// Special validation for editing modes
if (isOccurrenceEdit && !targetDate) {
    alert("Invalid occurrence edit - missing target date.");
    return;
}
if (isFutureEdit && !splitDate) {
    alert("Invalid future edit - missing split date.");
    return;
}
        
if (!isOccurrenceEdit && !isFutureEdit) {
    if (repeat === "One Time" && !singleDate) {
        alert("Please select a date for this one-time task.");
        return;
    }
    if (dateMode === "date" && repeat !== "One Time" && !dateFrom) {
        alert("Please select a start date.");
        return;
    }
    if (dateMode === "specific-dates" && !specificDates) {
        alert("Please select at least one date.");
        return;
    }
}

// Cap and sanitize
if (timesPerDay > 100) timesPerDay = 100;
if (timesPerWeek > 100) timesPerWeek = 100;
if (timesPerMonth > 100) timesPerMonth = 100;
if (timesPerDay !== null && timesPerDay < 1) timesPerDay = 1;
if (timesPerWeek !== null && timesPerWeek < 1) timesPerWeek = 1;
if (timesPerMonth !== null && timesPerMonth < 1) timesPerMonth = 1;

let dateValue = "";
if (isOccurrenceEdit) {
    // For single occurrence, use target date as both start and end for clarity
    dateValue = `${targetDate} to ${targetDate}`;
} else if (isFutureEdit) {
    // For future edit, use split date as start
    const originalRange = editTask.date.split(" to ");
    const originalEnd = originalRange[1] || "3000-01-01";
    dateValue = `${splitDate} to ${originalEnd}`;
} else if (repeat === "One Time") {
    dateValue = `${singleDate} to ${singleDate}`;
} else if (dateMode === "date") {
    const fromDate = dateFrom;
    const toDate = dateTo || "3000-01-01";
    dateValue = `${fromDate} to ${toDate}`;
} else if (dateMode === "specific-dates" && specificDates) {
    const dates = specificDates.split(",").map(d => d.trim()).filter(d => d);
    dateValue = `${dates[0]} to ${dates[dates.length - 1]}`;
} else {
    const today = new Date().toISOString().split("T")[0];
    dateValue = `${today} to 3000-01-01`;
}

const task = {
    title,
    notes: notes || undefined,
    room: room || undefined,
    repeat: repeat || undefined,
    settings: settings || undefined,
    rotationSettings: rotationSettings,
    rotationOrder: settings === "Rotation" ? rotationOrder : undefined,
    date: dateValue,
    // reminder: reminder || undefined,  // COMMENTED OUT
    dueTimes: dueTimeEnabled && dueTimes.length > 0 ? dueTimes : undefined,
    users,
    reward: reward || undefined,
    fairRotation: document.getElementById("fairRotationToggle").checked || undefined,
    fairRotationTimeBased: (document.getElementById("fairRotationToggle").checked && document.getElementById("fairRotationTimeBasedToggle").checked) || undefined,
    parentApproval: document.getElementById("parentApprovalToggle").checked,
    // alarms: alarms.length > 0 ? alarms : undefined,  // COMMENTED OUT
    timesPerDay: repeat === "Daily" ? timesPerDay : undefined,
    timesPerWeek: repeat === "Weekly" ? timesPerWeek : undefined,
    timesPerMonth: repeat === "Monthly" ? timesPerMonth : undefined,
    specificDates: dateMode === "specific-dates" ? specificDates : undefined,
    daysOfWeek: dateMode === "date" ? (selectedDays.length > 0 ? (selectedDays.includes("All") ? ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] : selectedDays) : (repeat === "Daily" ? ["All"] : ["Any"])) : undefined
};

console.log("Task being saved:", JSON.stringify(task, null, 2));

const currentAdmin = localStorage.getItem("currentAdminEmail");
const urlParams = new URLSearchParams(window.location.search);
const editTitle = urlParams.get("editTitle");
const editDate = urlParams.get("editDate");
const from = urlParams.get("from");
const originalUser = urlParams.get("user") || localStorage.getItem("currentUser");

if (!originalUser) {
    alert("No user context available. Redirecting to user selection.");
    window.location.href = "/BeeMazing-A1/mobile/2-UserProfiles/userAdmin.html";
    return;
}

try {
    const url = "https://beemazing1.onrender.com/api/tasks";
    let body;
    let method = "POST";
    let endpoint = "https://beemazing1.onrender.com/api/tasks";

    if (isOccurrenceEdit && targetDate && originalStartDate && editTask) {
        // Single occurrence edit
        method = "PUT";
        endpoint = "https://beemazing1.onrender.com/api/tasks/occurrence";
        body = {
            adminEmail: currentAdmin,
            originalTitle: editTask.title,
            originalStartDate: originalStartDate,
            targetDate: targetDate,
            modifiedTask: task
        };
    } else if (isFutureEdit && splitDate && originalStartDate && editTask) {
        // Future occurrences edit (split task)
        method = "PUT";
        endpoint = "https://beemazing1.onrender.com/api/tasks/future";
        body = {
            adminEmail: currentAdmin,
            originalTitle: editTask.title,
            originalStartDate: originalStartDate,
            splitDate: splitDate,
            modifiedTask: task
        };
    } else if (editTitle && editDate) {
        // Original edit mode
        method = "PUT";
        body = {
            adminEmail: currentAdmin,
            task,
            originalTitle: editTitle,
            originalDate: editTaskFullDate
        };
    } else {
        // New task
        body = { adminEmail: currentAdmin, task };
    }

    const response = await fetch(endpoint, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || `HTTP error ${response.status}`);

    console.log("Server response:", data);

    if (isOccurrenceEdit) {
        alert("Single occurrence updated successfully!");
    } else if (isFutureEdit) {
        alert("Future occurrences updated successfully!");
    } else {
        alert("Task saved successfully!");
    }

    // Store task title in localStorage if coming from onboarding
    if (from === "onboarding") {
        const existingTitles = JSON.parse(localStorage.getItem("onboardingTaskTitles") || "[]");
        if (!existingTitles.includes(title)) {
            existingTitles.push(title);
            localStorage.setItem("onboardingTaskTitles", JSON.stringify(existingTitles));
        }
    }

    // Redirect back to the original user's tasks.html or onboarding
    const adminEmail = encodeURIComponent(currentAdmin || "");
    if (from === "onboarding") {
        window.location.href = `/BeeMazing-A1/onboarding.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}#step4`;
    } else if (isOccurrenceEdit || isFutureEdit) {
        // Redirect back to taskz.html for specific date views
        window.location.href = `/BeeMazing-A1/taskz.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}`;
    } else {
        window.location.href = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}`;
    }

} catch (error) {
    console.error("Error saving task:", error);
    alert(`Failed to save task: ${error.message}`);
}
});
});
    
    




        const repeatModal = document.getElementById('repeatModal');
const repeatButton = document.getElementById('selectRepeat');
const repeatInput = document.getElementById('repeatSelection');
const timesPerDayGroup = document.getElementById('timesPerDayGroup');
const timesPerWeekGroup = document.getElementById('timesPerWeekGroup');
const timesPerMonthGroup = document.getElementById('timesPerMonthGroup');


repeatButton.addEventListener('click', () => {
    showModal(repeatModal);
});

window.addEventListener('click', (e) => {
    if (e.target === repeatModal) {
        hideModal(repeatModal);
    }
});

repeatModal.addEventListener('click', (e) => {
    if (e.target.tagName === 'LI') {
        const selected = e.target.getAttribute('data-value');
        repeatInput.value = selected;
        repeatButton.textContent = selected;
        hideModal(repeatModal);

        // Show/hide correct "x times" groups and date sections
        timesPerDayGroup.style.display = selected === "Daily" ? "flex" : "none";
        timesPerWeekGroup.style.display = selected === "Weekly" ? "flex" : "none";
        timesPerMonthGroup.style.display = selected === "Monthly" ? "flex" : "none";
        
        // Update section label and Any/All button based on frequency
        const sectionLabel = document.getElementById("sectionLabel");
        const anyAllButton = document.getElementById("anyAllButton");
        if (sectionLabel && anyAllButton) {
            if (selected === "Daily") {
                sectionLabel.textContent = "Days";
                anyAllButton.textContent = "All";
                anyAllButton.setAttribute("data-day", "All");
                // Convert Any to All if it's currently selected, or set default
                if (selectedDays.includes("Any") || selectedDays.length === 0) {
                    selectedDays = ["All"];
                    updateSelectedDaysDisplay();
                }
            } else {
                sectionLabel.textContent = "Dates";
                anyAllButton.textContent = "Any";
                anyAllButton.setAttribute("data-day", "Any");
                // Convert All to Any if it's currently selected, or set default
                if (selectedDays.includes("All") || (selectedDays.length === 7 && ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"].every(day => selectedDays.includes(day)))) {
                    selectedDays = ["Any"];
                    updateSelectedDaysDisplay();
                }
            }
        }
        
        // Toggle date input sections based on frequency
        const singleDateGroup = document.getElementById("singleDateGroup");
        const fromToDateGroup = document.getElementById("fromToDateGroup");
        const specificDaysGroup = document.getElementById("specificDaysGroup");
        
        if (selected === "One Time") {
            singleDateGroup.style.display = "block";
            fromToDateGroup.style.display = "none";
            specificDaysGroup.style.display = "none";
        } else {
            singleDateGroup.style.display = "none";
            fromToDateGroup.style.display = "block";
            specificDaysGroup.style.display = "block";
        }

        // Set initial value to 1
        if (selected === "Daily") timesPerDayInput.value = "1";
        if (selected === "Weekly") document.getElementById("timesPerWeekInput").value = "1";
        if (selected === "Monthly") document.getElementById("timesPerMonthInput").value = "1";
    }
});


const timesPerDayInput = document.getElementById("timesPerDayInput");
const timesPerDayModal = document.getElementById("timesPerDayModal");
const closeTimesModal = document.getElementById("closeTimesModal");
const saveCustomTimesBtn = document.getElementById("saveCustomTimesBtn");
const customTimesInput = document.getElementById("customTimesInput");

// Direct input functionality for times per day (no modal needed)
const decreaseBtn = document.getElementById("decreaseTimesPerDay");
const increaseBtn = document.getElementById("increaseTimesPerDay");

decreaseBtn.addEventListener("click", () => {
    let currentValue = parseInt(timesPerDayInput.value) || 1;
    if (currentValue > 1) {
        timesPerDayInput.value = currentValue - 1;
        timesPerDayInput.dispatchEvent(new Event('change'));
    }
});

increaseBtn.addEventListener("click", () => {
    let currentValue = parseInt(timesPerDayInput.value) || 1;
    if (currentValue < 100) {
        timesPerDayInput.value = currentValue + 1;
        timesPerDayInput.dispatchEvent(new Event('change'));
    }
});

// Add hover effects for stepper buttons
decreaseBtn.addEventListener("mouseenter", () => {
    decreaseBtn.style.background = "var(--primary-color)";
    decreaseBtn.style.color = "var(--secondary-color)";
});
decreaseBtn.addEventListener("mouseleave", () => {
    decreaseBtn.style.background = "var(--light-bg)";
    decreaseBtn.style.color = "var(--text-color)";
});

increaseBtn.addEventListener("mouseenter", () => {
    increaseBtn.style.background = "var(--primary-color)";
    increaseBtn.style.color = "var(--secondary-color)";
});
increaseBtn.addEventListener("mouseleave", () => {
    increaseBtn.style.background = "var(--light-bg)";
    increaseBtn.style.color = "var(--text-color)";
});

// Validate input on change
timesPerDayInput.addEventListener("input", () => {
    let value = parseInt(timesPerDayInput.value) || 1;
    if (value < 1) value = 1;
    if (value > 100) value = 100;
    timesPerDayInput.value = value;
});


// OLD MODAL FUNCTIONALITY COMMENTED OUT - NO LONGER NEEDED FOR TIMES PER DAY
/*
// Quick pick buttons (1–5)
timesPerDayModal.querySelectorAll("button[data-value]").forEach(btn => {
    btn.addEventListener("click", () => {
        timesPerDayInput.value = btn.getAttribute("data-value");
        hideModal(timesPerDayModal);
    });
});

// Custom input save
saveCustomTimesBtn.addEventListener("click", () => {
    let val = customTimesInput.value.trim();
    if (val && parseInt(val) > 0) {
        val = Math.min(parseInt(val), 100); // cap at 100
        timesPerDayInput.value = val;
        hideModal(timesPerDayModal);
    }
});


// Close modal
closeTimesModal.addEventListener("click", () => {
    hideModal(timesPerDayModal);
});


// Existing setup for Daily
setupTimesModal(
    document.getElementById("timesPerDayInput"),
    document.getElementById("timesPerDayModal"),
    document.getElementById("closeTimesModal"),
    document.getElementById("customTimesInput"),
    document.getElementById("saveCustomTimesBtn")
);
*/

// Existing setup for Monthly
setupTimesModal(
    document.getElementById("timesPerMonthInput"),
    document.getElementById("timesPerMonthModal"),
    document.getElementById("closeTimesMonthModal"),
    document.getElementById("customTimesMonthInput"),
    document.getElementById("saveCustomTimesMonthBtn")
);

// NEW: Setup for Weekly
setupTimesModal(
    document.getElementById("timesPerWeekInput"),
    document.getElementById("timesPerWeekModal"),
    document.getElementById("closeTimesWeekModal"),
    document.getElementById("customTimesWeekInput"),
    document.getElementById("saveCustomTimesWeekBtn")
);

// Close times modals when clicking outside
window.addEventListener('click', (e) => {
    if (e.target === timesPerDayModal) hideModal(timesPerDayModal);
    if (e.target === document.getElementById("timesPerWeekModal")) hideModal(document.getElementById("timesPerWeekModal"));
    if (e.target === document.getElementById("timesPerMonthModal")) hideModal(document.getElementById("timesPerMonthModal"));
});




    
        // Date Mode Toggle Logic
        const dateDisplay = document.getElementById("dateDisplay");
const dateDisplayTo = document.getElementById("dateDisplayTo");
const dateInputFrom = document.getElementById("taskDate");
const dateInputTo = document.getElementById("taskDateTo");
const addEndDateBtn = document.getElementById("addEndDateBtn");

let dateMode = "from"; // default

const dateToWrapper = document.getElementById("dateToWrapper");
const removeEndDateBtn = document.getElementById("removeEndDateBtn");

addEndDateBtn.addEventListener("click", () => {
  flatpickrTo.open();
});


removeEndDateBtn.addEventListener("click", () => {
  dateMode = "from";
  document.getElementById("taskDateTo").value = "";
  document.getElementById("dateDisplayTo").textContent = "To Date";
  document.getElementById("dateToWrapper").style.display = "none";
  document.getElementById("dateDisplayTo").style.display = "none";
  document.getElementById("removeEndDateBtn").style.display = "none";
  addEndDateBtn.style.display = "inline-block";
});


    
        // Single date picker for One Time tasks
        const flatpickrSingle = flatpickr("#singleTaskDate", {
            dateFormat: "Y-m-d",
            defaultDate: "today",
            onChange: function(selectedDates, dateStr) {
                document.getElementById("singleDateDisplay").textContent = selectedDates[0] 
                    ? selectedDates[0].toLocaleDateString(undefined, { month: "long", day: "numeric" })
                    : "Select Date";
            }
        });
        
        document.getElementById("singleDateDisplay").addEventListener("click", () => {
            flatpickrSingle.open();
        });
        
        const flatpickrFrom = flatpickr("#taskDate", {
            dateFormat: "Y-m-d",
            defaultDate: "today",
            disableMobile: true,
            onChange: function (selectedDates) {
                const formatted = new Date(selectedDates[0]).toLocaleDateString(undefined, { month: 'long', day: 'numeric' });
                dateDisplay.textContent = formatted;
            },
            positionElement: dateDisplay,
            appendTo: document.body
        });
    
        const flatpickrTo = flatpickr("#taskDateTo", {
  dateFormat: "Y-m-d",
  disableMobile: true,
  onChange: function (selectedDates) {
    if (selectedDates.length > 0) {
      const toDate = selectedDates[0];
      const formatted = toDate.toLocaleDateString(undefined, { month: "long", day: "numeric" });
      dateInputTo.value = toDate.toISOString().split("T")[0];
      dateDisplayTo.textContent = formatted;
      document.getElementById("dateToWrapper").style.display = "inline";
      document.getElementById("dateDisplayTo").style.display = "inline-block";
      document.getElementById("removeEndDateBtn").style.display = "inline-block";
      addEndDateBtn.style.display = "none";
      dateMode = "from-to";
    }
  },
  positionElement: addEndDateBtn,
  appendTo: document.body
});



   
        



// Date Mode Logic
// Date Mode Logic
const dateModeInput = document.getElementById("dateModeSelection");
const modeButtons = document.querySelectorAll(".mode-btn");

modeButtons.forEach(button => {
    button.addEventListener("click", () => {
        const mode = button.getAttribute("data-mode");
        dateModeInput.value = mode;

        // Update active state
        modeButtons.forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");

        // Show/hide UI based on mode
        document.getElementById("fromToDateGroup").style.display = mode === "date" ? "block" : "none";
        document.getElementById("specificDatesGroup").style.display = mode === "specific-dates" ? "block" : "none";
        document.getElementById("specificDaysGroup").style.display = mode === "date" ? "block" : "none";

        // Clear irrelevant fields
        if (mode === "specific-dates") {
            document.getElementById("taskDate").value = "";
            document.getElementById("taskDateTo").value = "";
            document.getElementById("dateDisplay").textContent = "Today";
            document.getElementById("dateDisplayTo").textContent = "To Date";
            document.getElementById("dateToWrapper").style.display = "none";
            document.getElementById("dateDisplayTo").style.display = "none";
            document.getElementById("removeEndDateBtn").style.display = "none";
            document.getElementById("addEndDateBtn").style.display = "inline-block";
            selectedDays = [];
            updateSelectedDaysDisplay();
        } else if (mode === "date") {
            document.getElementById("specificDatesInput").value = "";
            selectedDates = [];
            flatpickrSpecific.clear();
            updateSelectedDatesDisplay();
        }
    });
});
   




// Specific Days Logic
const specificDaysInput = document.getElementById("specificDaysInput");
let selectedDays = []; // Will be set based on initial frequency

const dayMapping = {
    "Any": "Any",
    "All": "All",
    "Mon": "Monday",
    "Tue": "Tuesday",
    "Wed": "Wednesday",
    "Thu": "Thursday",
    "Fri": "Friday",
    "Sat": "Saturday",
    "Sun": "Sunday"
};

function updateSelectedDaysDisplay() {
    const buttons = document.querySelectorAll("#specificDaysButtons .day-btn");
    const repeatInput = document.getElementById("repeatSelection");
    const specificDaysInput = document.getElementById("specificDaysInput");
    
    if (!buttons.length) return; // Exit if no buttons found
    
    const isDaily = repeatInput && repeatInput.value === "Daily";
    
    buttons.forEach(button => {
        const shortDay = button.getAttribute("data-day");
        const fullDay = dayMapping[shortDay];
        
        if (!fullDay) return; // Skip if mapping not found
        
        // Check if this button should be selected
        let isSelected = false;
        
        if (fullDay === "Any" || fullDay === "All") {
            // For Any/All button - check if it's in selectedDays
            isSelected = selectedDays.includes(fullDay);
        } else {
            // For specific days - not selected if "All" or "Any" is active
            if (isDaily) {
                isSelected = selectedDays.includes(fullDay) && !selectedDays.includes("All");
            } else {
                isSelected = selectedDays.includes(fullDay) && !selectedDays.includes("Any");
            }
        }
        
        if (isSelected) {
            button.classList.add("selected");
        } else {
            button.classList.remove("selected");
        }
    });
    
    // Update the input value with better display text
    if (specificDaysInput) {
        if (isDaily && selectedDays.includes("All")) {
            specificDaysInput.value = "All days (Mon-Sun)";
        } else if (!isDaily && selectedDays.includes("Any")) {
            specificDaysInput.value = "Any day";
        } else if (selectedDays.length > 0) {
            specificDaysInput.value = selectedDays.join(", ");
        } else {
            specificDaysInput.value = isDaily ? "All days (Mon-Sun)" : "Any day";
        }
    }
}

// Add click event listeners to day buttons
document.querySelectorAll("#specificDaysButtons .day-btn").forEach(button => {
    button.addEventListener("click", () => {
        const shortDay = button.getAttribute("data-day");
        const fullDay = dayMapping[shortDay];
        const repeatInput = document.getElementById("repeatSelection");
        const isDaily = repeatInput && repeatInput.value === "Daily";

        if (fullDay === "Any" || fullDay === "All") {
            // Clicking Any/All button
            if (selectedDays.includes(fullDay)) {
                // If already selected, deselect it (but keep at least one day)
                if (isDaily) {
                    selectedDays = ["Monday"]; // Default to Monday for Daily
                } else {
                    selectedDays = ["Any"]; // Keep Any for non-Daily
                }
            } else {
                // Select Any/All and clear individual selections
                if (isDaily) {
                    selectedDays = ["All"];
                } else {
                    selectedDays = ["Any"];
                }
            }
        } else {
            // Clicking individual day button
            if (isDaily) {
                // For Daily frequency: when selecting individual days, remove "All"
                if (selectedDays.includes("All")) {
                    selectedDays = [fullDay]; // Replace "All" with this specific day
                } else {
                    // Toggle individual day
                    if (selectedDays.includes(fullDay)) {
                        selectedDays = selectedDays.filter(day => day !== fullDay);
                        // If no days left, default back to "All"
                        if (selectedDays.length === 0) {
                            selectedDays = ["All"];
                        }
                    } else {
                        selectedDays.push(fullDay);
                        // Check if all 7 days are now selected
                        const allDays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
                        if (allDays.every(day => selectedDays.includes(day))) {
                            selectedDays = ["All"];
                        }
                    }
                }
            } else {
                // For non-Daily frequencies: existing logic
                selectedDays = selectedDays.filter(day => day !== "Any" && day !== "All");
                
                if (selectedDays.includes(fullDay)) {
                    // Deselect this day
                    selectedDays = selectedDays.filter(day => day !== fullDay);
                    if (selectedDays.length === 0) {
                        // Re-select Any if none selected
                        selectedDays = ["Any"];
                    }
                } else {
                    // Select this day
                    selectedDays.push(fullDay);
                }
            }
        }
        updateSelectedDaysDisplay();
    });
});

// Initialize display
updateSelectedDaysDisplay();








        const specificDatesButton = document.getElementById("selectSpecificDates");
const specificDatesModal = document.getElementById("specificDatesModal");
const specificDatesInput = document.getElementById("specificDatesInput");
const selectedDatesContainer = document.getElementById("selectedDatesContainer");
const saveSpecificDatesBtn = document.getElementById("saveSpecificDates");
const clearSpecificDatesBtn = document.getElementById("clearSpecificDates");
const specificDatesGroup = document.getElementById("specificDatesGroup");

let selectedDates = [];
let isDragging = false;
let startDate = null;
let dragMode = null; // 'select' or 'deselect'
let selectedDatesAtDragStart = [];

const flatpickrSpecific = flatpickr("#specificDatesCalendar", {
    dateFormat: "Y-m-d",
    mode: "multiple",
    disableMobile: true,
    inline: true,
    enable: [
        function(date) {
            return true; // Allow all dates
        }
    ],
    onReady: function(_, __, instance) {
        const calendar = instance.calendarContainer;

        calendar.addEventListener("mousedown", (e) => {
            const dayElem = e.target.closest(".flatpickr-day");
            if (dayElem && !dayElem.classList.contains("disabled")) {
                isDragging = true;
                startDate = new Date(dayElem.getAttribute("aria-label"));
                const startIsSelected = selectedDates.some(d => d.getTime() === startDate.getTime());
                dragMode = startIsSelected ? "deselect" : "select";
                selectedDatesAtDragStart = [...selectedDates]; // snapshot current selection
                e.preventDefault();
                e.stopPropagation();
            }
        });

        calendar.addEventListener("mousemove", (e) => {
            if (!isDragging || !dragMode) return;
            const dayElem = e.target.closest(".flatpickr-day");
            if (dayElem && !dayElem.classList.contains("disabled")) {
                const endDate = new Date(dayElem.getAttribute("aria-label"));
                const datesInRange = getDatesInRange(startDate, endDate);

                let newDates = [...selectedDatesAtDragStart];
                if (dragMode === "select") {
                    newDates = [...new Set([
                        ...newDates,
                        ...datesInRange
                    ].map(d => d.getTime()))].map(t => new Date(t));
                } else if (dragMode === "deselect") {
                    newDates = newDates.filter(d =>
                        !datesInRange.some(r => r.getTime() === d.getTime())
                    );
                }

                selectedDates = newDates.sort((a, b) => a - b);
                instance.setDate(selectedDates, false);
            }
        });

        calendar.addEventListener("mouseup", (e) => {
            if (isDragging) {
                isDragging = false;
                startDate = null;
                dragMode = null;
                selectedDatesAtDragStart = [];
                e.stopPropagation();
            }
        });

        calendar.addEventListener("click", (e) => {
            const dayElem = e.target.closest(".flatpickr-day");
            if (dayElem && !dayElem.classList.contains("disabled")) {
                if (!isDragging && !startDate) {
                    const date = new Date(dayElem.getAttribute("aria-label"));
                    const index = selectedDates.findIndex(d => d.getTime() === date.getTime());
                    if (index >= 0) {
                        selectedDates.splice(index, 1);
                    } else {
                        selectedDates.push(date);
                    }
                    selectedDates.sort((a, b) => a - b);
                    instance.setDate(selectedDates, false);
                }
            }
        });
    },
    onChange: function(dates, text, instance) {
        if (!isDragging) {
            selectedDates = dates.sort((a, b) => a - b);
        }
    }
});

function getDatesInRange(start, end) {
    const dates = [];
    const current = new Date(Math.min(start, end));
    const max = new Date(Math.max(start, end));
    while (current <= max) {
        dates.push(new Date(current));
        current.setDate(current.getDate() + 1);
    }
    return dates;
}



function updateSelectedDatesDisplay() {
    selectedDatesContainer.innerHTML = "";
    console.log("Selected Dates (raw):", selectedDates); // Debug
    if (selectedDates.length === 0) {
        specificDatesInput.value = "";
        const placeholder = document.createElement("span");
        placeholder.textContent = "Every day";
        placeholder.style.color = "rgba(255, 255, 255, 0.7)";
        placeholder.style.fontSize = "14px";
        selectedDatesContainer.appendChild(placeholder);
    } else {
        specificDatesInput.value = selectedDates.map(date => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }).join(",");
        console.log("specificDatesInput.value:", specificDatesInput.value); // Debug
        selectedDates.forEach(date => {
            const chip = document.createElement("div");
            chip.className = "date-chip";
            const dateText = document.createElement("span");
            dateText.textContent = date.toLocaleDateString(undefined, { month: "short", day: "numeric" });
            const removeBtn = document.createElement("span");
            removeBtn.className = "date-chip-remove";
            removeBtn.textContent = "×";
            removeBtn.addEventListener("click", () => {
                selectedDates = selectedDates.filter(d => d.getTime() !== date.getTime());
                flatpickrSpecific.setDate(selectedDates);
                updateSelectedDatesDisplay();
            });
            chip.appendChild(dateText);
            chip.appendChild(removeBtn);
            selectedDatesContainer.appendChild(chip);
        });
    }
}





specificDatesButton.addEventListener("click", () => {
    showModal(specificDatesModal);
});

saveSpecificDatesBtn.addEventListener("click", () => {
    updateSelectedDatesDisplay();
    hideModal(specificDatesModal);
});

clearSpecificDatesBtn.addEventListener("click", () => {
    selectedDates = [];
    flatpickrSpecific.clear();
    updateSelectedDatesDisplay();
    hideModal(specificDatesModal);
});

window.addEventListener("click", (e) => {
    if (e.target === specificDatesModal) {
        hideModal(specificDatesModal);
    }
});
























    
        dateDisplay.addEventListener("click", () => {
            flatpickrFrom.open();
        });
    
        dateDisplayTo.addEventListener("click", () => {
            if (dateMode === "date") {
    const fromDate = dateFrom;
    const toDate = dateTo || "3000-01-01";
    dateValue = `${fromDate} to ${toDate}`;
}
       });
    
        // COMMENTED OUT - REMINDER AND ALARM LOGIC (keep for later implementation)
        /*
        const reminderToggle = document.getElementById('taskReminder');
        const addAlarmBtn = document.getElementById('addAlarmBtn');
        const alarmContainer = document.getElementById('alarmContainer');
        let alarms = [];

        reminderToggle.addEventListener('change', () => {
            if (reminderToggle.checked) {
                addAlarmBtn.style.display = 'inline-block';
            } else {
                addAlarmBtn.style.display = 'none';
                alarmContainer.innerHTML = '';
                alarms = [];
            }
        });

        addAlarmBtn.addEventListener('click', () => {
            const alarmWrapper = document.createElement('div');
            alarmWrapper.style.marginBottom = '10px';
            alarmWrapper.style.display = 'flex';
            alarmWrapper.style.alignItems = 'center';

            const alarmInput = document.createElement('input');
            alarmInput.type = 'time';
            alarmInput.style.marginRight = '10px';
            alarmInput.style.padding = '10px';
            alarmInput.style.border = '2px solid var(--primary-color)';
            alarmInput.style.borderRadius = '8px';
            alarmInput.style.background = 'var(--accent-color)';

            const removeButton = document.createElement('button');
            removeButton.textContent = 'Remove';
            removeButton.style.padding = '5px 10px';
            removeButton.style.marginLeft = '10px';

            removeButton.addEventListener('click', () => {
                alarmWrapper.remove();
                alarms = alarms.filter(a => a !== alarmInput.value);
            });

            alarmInput.addEventListener('input', () => {
                if (!alarms.includes(alarmInput.value)) {
                    alarms.push(alarmInput.value);
                }
            });

            alarmWrapper.appendChild(alarmInput);
            alarmWrapper.appendChild(removeButton);
            alarmContainer.appendChild(alarmWrapper);
        });
        */

        // Due Time Logic
        const dueTimeToggle = document.getElementById('dueTimeToggle');
        const dueTimeContainer = document.getElementById('dueTimeContainer');
        let dueTimes = [];

        function updateDueTimeDisplay() {
            dueTimeContainer.innerHTML = '';
            
            if (!dueTimeToggle.checked) {
                dueTimeContainer.style.display = 'none';
                return;
            }
            
            dueTimeContainer.style.display = 'block';
            
            const repeatInput = document.getElementById("repeatSelection");
            const timesPerDayInput = document.getElementById("timesPerDayInput");
            const isDaily = repeatInput && repeatInput.value === "Daily";
            const timesPerDay = isDaily ? parseInt(timesPerDayInput.value) || 1 : 1;
            
            // Ensure we have the right number of due times
            while (dueTimes.length < timesPerDay) {
                dueTimes.push("");
            }
            while (dueTimes.length > timesPerDay) {
                dueTimes.pop();
            }
            
            dueTimes.forEach((dueTime, index) => {
                const timeWrapper = document.createElement('div');
                timeWrapper.style.marginBottom = '10px';
                timeWrapper.style.display = 'flex';
                timeWrapper.style.alignItems = 'center';
                timeWrapper.style.gap = '10px';
                timeWrapper.style.flexWrap = 'nowrap';
                
                // Add ordinal text (1st, 2nd, 3rd, etc.) if more than one field
                if (timesPerDay > 1) {
                    const ordinalText = document.createElement('span');
                    const ordinals = ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th', '9th', '10th'];
                    ordinalText.textContent = ordinals[index] || `${index + 1}th`;
                    ordinalText.style.fontSize = '14px';
                    ordinalText.style.fontWeight = '600';
                    ordinalText.style.minWidth = '35px';
                    ordinalText.style.color = 'var(--text-color)';
                    timeWrapper.appendChild(ordinalText);
                }
                
                // Due Time input - made wider
                const dueTimeInput = document.createElement('input');
                dueTimeInput.type = 'time';
                dueTimeInput.value = dueTime || '';
                dueTimeInput.style.padding = '10px';
                dueTimeInput.style.border = '2px solid var(--primary-color)';
                dueTimeInput.style.borderRadius = '8px';
                dueTimeInput.style.background = 'rgba(255, 193, 7, 0.1)';
                dueTimeInput.style.color = 'var(--text-color)';
                dueTimeInput.style.fontSize = '16px';
                dueTimeInput.style.minWidth = '120px';
                dueTimeInput.style.flex = '1';
                dueTimeInput.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                
                // Remove button (only show if more than 1 time slot)
                let removeButton;
                if (timesPerDay > 1) {
                    removeButton = document.createElement('button');
                    removeButton.textContent = '✖';
                    removeButton.style.padding = '8px 10px';
                    removeButton.style.background = 'var(--danger-color)';
                    removeButton.style.color = 'white';
                    removeButton.style.border = 'none';
                    removeButton.style.borderRadius = '6px';
                    removeButton.style.cursor = 'pointer';
                    removeButton.style.fontSize = '12px';
                    removeButton.style.marginLeft = '5px';
                    removeButton.style.transition = 'background-color 0.3s ease, transform 0.2s ease';
                    removeButton.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                    
                    removeButton.addEventListener('click', () => {
                        timeWrapper.remove();
                        dueTimes.splice(index, 1);
                    });
                    
                    // Add hover effects for remove button
                    removeButton.addEventListener('mouseenter', () => {
                        removeButton.style.background = '#c62828';
                        removeButton.style.transform = 'translateY(-1px)';
                    });
                    
                    removeButton.addEventListener('mouseleave', () => {
                        removeButton.style.background = 'var(--danger-color)';
                        removeButton.style.transform = 'translateY(0)';
                    });
                }
                
                // Update dueTimes array when input changes
                dueTimeInput.addEventListener('change', () => {
                    dueTimes[index] = dueTimeInput.value;
                });
                
                // Add focus effects for input
                dueTimeInput.addEventListener('focus', () => {
                    dueTimeInput.style.borderColor = '#FFB300';
                    dueTimeInput.style.boxShadow = '0 4px 12px rgba(255, 193, 7, 0.3)';
                });
                
                dueTimeInput.addEventListener('blur', () => {
                    dueTimeInput.style.borderColor = 'var(--primary-color)';
                    dueTimeInput.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                });
                
                timeWrapper.appendChild(dueTimeInput);
                if (removeButton) {
                    timeWrapper.appendChild(removeButton);
                }
                
                dueTimeContainer.appendChild(timeWrapper);
            });
        }

        dueTimeToggle.addEventListener('change', () => {
            updateDueTimeDisplay();
        });

        // Update due time display when times per day changes
        document.getElementById("timesPerDayInput").addEventListener('change', () => {
            if (dueTimeToggle.checked) {
                updateDueTimeDisplay();
            }
        });

        // Update due time display when frequency changes
        document.getElementById("repeatSelection").addEventListener('change', () => {
            if (dueTimeToggle.checked) {
                updateDueTimeDisplay();
            }
        });
    











function handleCancel() {
    const urlParams = new URLSearchParams(window.location.search);
    const from = urlParams.get("from");
    const adminEmail = encodeURIComponent(localStorage.getItem("currentAdminEmail") || "");
    const originalUser = urlParams.get("user") || localStorage.getItem("currentUser");

    if (from === "onboarding") {
        window.location.href = `/BeeMazing-A1/onboarding.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}#step4`;
    } else if (originalUser) {
        window.location.href = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}`;
    } else {
        window.location.href = `/BeeMazing-A1/index.html`;
    }
}

function closeAddTask() {
    const urlParams = new URLSearchParams(window.location.search);
    const adminEmail = encodeURIComponent(localStorage.getItem("currentAdminEmail") || "");
    const originalUser = urlParams.get("user") || localStorage.getItem("currentUser");
    
    if (originalUser) {
        window.location.href = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}`;
    } else {
        window.location.href = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?admin=${adminEmail}`;
    }
}

// Initialize section label on page load
document.addEventListener("DOMContentLoaded", () => {
    const sectionLabel = document.getElementById("sectionLabel");
    const repeatInput = document.getElementById("repeatSelection");
    const anyAllButton = document.getElementById("anyAllButton");
    
    // Add delay to ensure all elements are loaded
    setTimeout(() => {
        // Initialize selectedDays if empty
        if (selectedDays.length === 0) {
            const currentRepeat = repeatInput ? repeatInput.value : "One Time";
            selectedDays = currentRepeat === "Daily" ? ["All"] : ["Any"];
        }
        
        // Set initial section label and Any/All button based on current frequency (default is "One Time")
        if (sectionLabel && anyAllButton) {
            if (repeatInput && repeatInput.value === "Daily") {
                sectionLabel.textContent = "Days";
                anyAllButton.textContent = "All";
                anyAllButton.setAttribute("data-day", "All");
                // Ensure "All" is selected for Daily by default
                if (selectedDays.includes("Any")) {
                    selectedDays = ["All"];
                }
            } else {
                sectionLabel.textContent = "Dates";
                anyAllButton.textContent = "Any";
                anyAllButton.setAttribute("data-day", "Any");
                // Ensure "Any" is selected for non-Daily by default
                if (selectedDays.includes("All")) {
                    selectedDays = ["Any"];
                }
            }
        }
        
        updateSelectedDaysDisplay();
    }, 100);
});

    </script>




</body>
</html>