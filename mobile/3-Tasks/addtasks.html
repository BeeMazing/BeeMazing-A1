<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>BeeMazing Add Task - v1.0.3</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
            rel="stylesheet"
        />
        <script src="/BeeMazing-A1/redirect-interceptor.js?v=1.0.3"></script>
        <!-- Cache buster: Force reload v1.0.3 - Fixed syntax errors -->
        <meta
            http-equiv="Cache-Control"
            content="no-cache, no-store, must-revalidate"
        />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --primary-color: #ffc107; /* bright yellow matching other pages */
                --secondary-color: #212121;
                --accent-color: #2c2f3a;
                --light-bg: #fffff8;
                --text-color: #6d4c41; /* brown text matching other pages */
                --card-bg: #ffffff; /* white card backgrounds */
                --danger-color: #d32f2f;
                --muted-button: #3a3d4b;
                --hover-accent: #3f4353;
                --border-dark: #444754;
                --selection-border: #555555;
                --selection-bg: #3a3d4b;
            }

            html,
            body {
                height: 100%;
                width: 100%;
                overflow-x: hidden;
                font-family: "Poppins", Arial, sans-serif;
                background-color: var(--light-bg);
                color: var(--text-color);
                display: flex;
                flex-direction: column;
            }

            .header {
                position: relative;
                display: flex;
                justify-content: center; /* Center the title */
                align-items: center;
                background: var(--primary-color);
                padding: 15px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            }

            .close-icon {
                position: absolute;
                right: 20px;
                font-size: 28px;
                color: #ffffff; /* white for close icon */
                cursor: pointer;
                transition: transform 0.2s ease;
                z-index: 10;
                font-weight: bold;
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            }

            .close-icon:hover {
                transform: scale(1.1);
                color: #ffcccc;
            }

            .title {
                font-size: 24px;
                font-weight: 600;
                color: var(--text-color); /* brown text for title */
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .content {
                padding: 20px;
                padding-bottom: 110px;
                flex: 1;
                overflow-y: auto;
            }

            .form-group,
            .form-group-full {
                padding: 8px 0;
                margin-bottom: 8px;
            }

            .form-group.room-section,
            .form-group.frequency-section,
            .form-group-full.date-section {
                background-color: rgba(255, 193, 7, 0.1);
                border: 2px solid var(--primary-color);
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
            }

            .form-group {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
            }

            .form-group label {
                margin-right: 12px; /* Adjust the spacing */
            }

            label {
                font-size: 16px;
                font-weight: 600;
                color: var(--text-color);
            }

            input,
            textarea {
                background: rgba(255, 193, 7, 0.1);
                color: var(--text-color);
                border: 2px solid var(--primary-color);
                border-radius: 8px;
                padding: 10px;
                font-size: 16px;
                width: 100%;
            }

            textarea {
                resize: vertical;
                height: 100px;
            }

            ::placeholder {
                color: rgba(109, 76, 65, 0.6);
            }

            .select-btn {
                background: var(--card-bg);
                border: 2px solid var(--primary-color);
                color: var(--text-color);
                font-size: 16px;
                font-weight: 600;
                padding: 8px 15px;
                border-radius: 8px;
                cursor: pointer;
                transition:
                    background-color 0.3s ease,
                    transform 0.2s ease;
            }

            .select-btn:hover {
                background: var(--primary-color);
                color: var(--secondary-color);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
            }

            /* New class for the circular + button */
            .plus-btn {
                background: var(--primary-color);
                border: none;
                color: var(--secondary-color);
                font-size: 20px;
                font-weight: 600;
                width: 32px;
                height: 32px;
                line-height: 32px; /* Centers the + vertically */
                border-radius: 50%; /* Fully circular */
                cursor: pointer;
                text-align: center;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                transition:
                    background-color 0.3s ease,
                    transform 0.2s ease,
                    box-shadow 0.3s ease;
            }

            .plus-btn:hover {
                background: #ffb300; /* Brighter gold on hover */
                transform: translateY(-2px); /* Slight lift */
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* Enhanced shadow */
            }

            .plus-btn:active {
                transform: translateY(0); /* Pressed effect */
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); /* Reduced shadow */
            }

            .date-display {
                background: var(--light-bg);
                border: 2px solid var(--primary-color);
                border-radius: 8px;
                padding: 8px 12px;
                font-size: 14px;
                font-weight: 600;
                color: var(--text-color);
                text-align: center;
                cursor: pointer;
                transition:
                    background-color 0.3s ease,
                    color 0.3s ease,
                    transform 0.2s ease;
                min-width: 80px;
                box-shadow: 0 1px 3px rgba(255, 193, 7, 0.1);
            }

            .date-display:hover {
                background: rgba(255, 193, 7, 0.15);
                transform: translateY(-1px);
                box-shadow: 0 3px 6px rgba(255, 193, 7, 0.2);
            }

            .date-flex-row {
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .date-flex-row label {
                width: 80px;
                margin: 0;
            }

            .date-controls {
                display: flex;
                align-items: center;
                gap: 15px;
                flex-wrap: wrap;
            }

            .date-input {
                display: none;
            }

            .save-btn {
                width: 100%;
                padding: 15px;
                margin-top: 20px;
                background: var(--primary-color);
                color: var(--secondary-color);
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }

            .save-btn:hover {
                background: #ffb300;
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }

            .modal.show {
                display: flex;
                animation: fadeIn 0.3s ease-out;
            }

            .modal.hide {
                animation: fadeOut 0.3s ease-out;
                pointer-events: none;
            }

            .modal-content {
                background: var(--card-bg);
                padding: 20px;
                border-radius: 15px;
                border: 2px solid var(--primary-color);
                width: 80%;
                max-width: 400px;
                text-align: center;
                box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
                color: var(--text-color);
            }

            .modal-content h3 {
                color: var(--text-color);
                font-weight: 600;
                margin-bottom: 15px;
            }

            .modal-content ul {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .modal-content ul li {
                padding: 10px;
                margin: 5px 0;
                background: var(--card-bg);
                color: var(--text-color);
                border: 2px solid var(--primary-color);
                border-radius: 8px;
                cursor: pointer;
                transition:
                    background-color 0.3s ease,
                    color 0.3s ease;
            }

            .modal-content ul li:hover {
                background: var(--primary-color);
                color: var(--secondary-color);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
            }

            .close-btn {
                margin-top: 15px;
                padding: 10px 20px;
                background: var(--primary-color);
                color: var(--text-color);
                border: 2px solid var(--text-color);
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 1px;
                box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
                transition: all 0.3s ease;
            }

            .close-btn:hover {
                background: #ffb300;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.5);
            }

            .footer {
                position: fixed;
                bottom: 0;
                width: 100%;
                display: flex;
                justify-content: space-around;
                background: var(--secondary-color); /* Changed to black */
                padding: 10px 0;
                box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
                z-index: 100;
                height: var(--footer-height);
            }

            .footer a {
                text-decoration: none;
                color: var(--accent-color); /* Changed to white for text */
                display: flex;
                flex-direction: column;
                align-items: center;
                transition: transform 0.3s ease;
            }

            .footer img {
                width: 40px;
                height: 40px;
                filter: invert(100%) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)); /* Default: white */
            }

            .switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 28px;
            }

            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: white;
                border: 2px solid #ccc;
                transition: 0.4s;
                border-radius: 28px;
            }

            .slider:before {
                position: absolute;
                content: "";
                height: 20px;
                width: 20px;
                left: 4px;
                bottom: 4px;
                background-color: #444;
                transition: 0.4s;
                border-radius: 50%;
            }

            input:checked + .slider {
                background-color: white;
                border-color: var(--primary-color);
            }

            input:checked + .slider:before {
                background-color: var(--primary-color);
                transform: translateX(22px);
            }

            .fancy-input {
                padding: 8px 12px;
                font-size: 14px;
                border: 2px solid var(--border-dark);
                border-radius: 8px;
                background: var(--light-bg);
                color: var(--text-color);
                width: 80%;
                margin: 0 auto;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .fancy-input:focus {
                border-color: #ffb300;
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.5);
                outline: none;
            }

            .button-row {
                display: flex;
                gap: 15px;
                margin-top: 20px;
                justify-content: space-between;
            }

            .btn-save {
                flex: 1;
                padding: 15px;
                background: var(--primary-color);
                color: var(--secondary-color);
                border: 2px solid var(--secondary-color);
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }

            .btn-save:hover {
                background: #ffb300;
            }

            .btn-cancel {
                flex: 1;
                padding: 15px;
                background: var(--muted-button);
                color: #ffffff;
                border: 2px solid var(--border-dark);
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }

            .btn-cancel:hover {
                background: var(--hover-accent);
            }

            @keyframes fadeIn {
                0% {
                    opacity: 0;
                    transform: scale(0.9);
                }
                100% {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            @keyframes fadeOut {
                0% {
                    opacity: 1;
                    transform: scale(1);
                }
                100% {
                    opacity: 0;
                    transform: scale(0.9);
                }
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            /* Info popup styles */
            .info-popup {
                position: fixed;
                background: var(--card-bg);
                border: 2px solid var(--primary-color);
                border-radius: 8px;
                padding: 15px;
                font-size: 14px;
                line-height: 1.4;
                color: var(--text-color);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                width: 300px;
                max-width: 90vw;
                opacity: 0;
                pointer-events: none;
                transition: all 0.3s ease;
            }

            @media (max-width: 480px) {
                .info-popup {
                    font-size: 16px;
                    line-height: 1.5;
                    padding: 18px;
                    width: 320px;
                }
            }

            .info-popup.show {
                opacity: 1;
                pointer-events: auto;
            }

            .info-popup::after {
                content: "";
                position: absolute;
                border: 8px solid transparent;
            }

            .info-popup::before {
                content: "";
                position: absolute;
                transform: translateY(-1px);
                border: 6px solid transparent;
            }

            /* Remove arrows for centered popups */
            .info-popup::after,
            .info-popup::before {
                display: none;
            }

            /* Styling for date chips */
            .date-chip {
                background: var(--accent-color);
                color: var(--text-color);
                padding: 6px 12px;
                border-radius: 16px;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 8px;
                border: 1px solid var(--border-dark);
                transition: background-color 0.3s ease;
            }

            .date-chip:hover {
                background: var(--hover-accent);
            }

            .date-chip-remove {
                cursor: pointer;
                color: var(--danger-color);
                font-size: 16px;
                line-height: 1;
            }

            .date-chip-remove:hover {
                color: #b71c1c;
            }

            /* Ensure calendar in modal is centered and sized appropriately */
            #specificDatesCalendar .flatpickr-calendar {
                background: var(--light-bg);
                border: 2px solid var(--primary-color);
                border-radius: 12px;
                width: 280px;
                max-width: 280px;
                margin: 0 auto;
                box-shadow: 0 6px 20px rgba(255, 193, 7, 0.2);
                font-size: 14px;
            }

            #specificDatesCalendar .flatpickr-day.selected,
            #specificDatesCalendar .flatpickr-day.startRange,
            #specificDatesCalendar .flatpickr-day.endRange {
                background: var(--primary-color);
                border-color: var(--primary-color);
                color: var(--secondary-color);
            }

            #specificDatesCalendar .flatpickr-day.inRange {
                background: rgba(
                    224,
                    176,
                    24,
                    0.3
                ); /* Semi-transparent gold for range */
                border-color: var(--border-dark);
                color: var(--text-color);
            }

            #specificDatesCalendar .flatpickr-day:hover {
                background: var(--hover-accent);
                border-color: var(--border-dark);
            }

            /* Additional flatpickr styling to match page theme */
            .flatpickr-calendar {
                background: var(--light-bg) !important;
                border: 2px solid var(--primary-color) !important;
                border-radius: 12px !important;
                box-shadow: 0 4px 15px rgba(255, 193, 7, 0.15) !important;
                font-family: inherit !important;
            }

            .flatpickr-months {
                background: var(--light-bg) !important;
                border-radius: 12px 12px 0 0 !important;
                border-bottom: 1px solid rgba(255, 193, 7, 0.2) !important;
                padding: 15px 0 !important;
            }

            .flatpickr-month {
                background: transparent !important;
                color: var(--text-color) !important;
            }

            .flatpickr-current-month .flatpickr-monthDropdown-months {
                background: var(--light-bg) !important;
                color: var(--text-color) !important;
                border: 1px solid var(--primary-color) !important;
                border-radius: 6px !important;
            }

            .flatpickr-current-month input.cur-year {
                background: var(--light-bg) !important;
                color: var(--text-color) !important;
                border: 1px solid var(--primary-color) !important;
                border-radius: 6px !important;
            }

            .flatpickr-prev-month,
            .flatpickr-next-month {
                color: var(--text-color) !important;
                border-radius: 6px !important;
            }

            .flatpickr-prev-month:hover,
            .flatpickr-next-month:hover {
                color: var(--primary-color) !important;
                background: rgba(255, 193, 7, 0.1) !important;
            }

            #specificDatesCalendar .flatpickr-weekdays {
                background: var(--light-bg) !important;
                color: var(--text-color) !important;
                border-bottom: 1px solid rgba(255, 193, 7, 0.2) !important;
                padding: 0 !important;
                width: 280px !important;
            }

            #specificDatesCalendar .flatpickr-weekday {
                background: transparent !important;
                color: var(--text-color) !important;
                font-weight: 600 !important;
                opacity: 0.8 !important;
                font-size: 13px !important;
                height: 30px !important;
                line-height: 30px !important;
                text-align: center !important;
                width: 40px !important;
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
            }

            #specificDatesCalendar .flatpickr-days {
                background: var(--light-bg) !important;
                padding: 0 !important;
                width: 280px !important;
            }

            #specificDatesCalendar .flatpickr-day {
                background: var(--light-bg) !important;
                color: var(--text-color) !important;
                border: 1px solid transparent !important;
                border-radius: 6px !important;
                margin: 0 !important;
                width: 40px !important;
                height: 30px !important;
                line-height: 30px !important;
                font-size: 13px !important;
                font-weight: 500 !important;
                text-align: center !important;
                box-sizing: border-box !important;
            }

            .flatpickr-day:hover {
                background: rgba(255, 193, 7, 0.15) !important;
                border-color: var(--primary-color) !important;
                color: var(--text-color) !important;
            }

            .flatpickr-day.selected {
                background: var(--primary-color) !important;
                border-color: var(--primary-color) !important;
                color: var(--secondary-color) !important;
                font-weight: 600 !important;
            }

            .flatpickr-day.today {
                border-color: var(--primary-color) !important;
                background: rgba(255, 193, 7, 0.1) !important;
                color: var(--text-color) !important;
                font-weight: 600 !important;
            }

            .flatpickr-day.today.selected {
                background: var(--primary-color) !important;
                color: var(--secondary-color) !important;
            }

            .flatpickr-day.prevMonthDay,
            .flatpickr-day.nextMonthDay {
                color: rgba(109, 76, 65, 0.3) !important;
                background: var(--light-bg) !important;
            }

            .flatpickr-day.prevMonthDay:hover,
            .flatpickr-day.nextMonthDay:hover {
                background: rgba(255, 193, 7, 0.05) !important;
            }

            /* Custom disabled state for weekly limit */
            .flatpickr-day.disabled-by-weekly-limit,
            .flatpickr-day[data-disabled-by-limit="true"] {
                background: rgba(109, 76, 65, 0.05) !important;
                color: rgba(109, 76, 65, 0.4) !important;
                cursor: not-allowed !important;
                opacity: 0.3 !important;
                pointer-events: auto !important;
                position: relative !important;
            }

            .flatpickr-day.disabled-by-weekly-limit:hover,
            .flatpickr-day[data-disabled-by-limit="true"]:hover {
                background: rgba(109, 76, 65, 0.05) !important;
                border-color: transparent !important;
                color: rgba(109, 76, 65, 0.4) !important;
            }

            .flatpickr-day.disabled-by-weekly-limit:before,
            .flatpickr-day[data-disabled-by-limit="true"]:before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: transparent;
                z-index: 10;
                cursor: not-allowed;
            }

            /* Center popup warning */
            .center-warning-popup {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--light-bg);
                border: 2px solid var(--primary-color);
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                max-width: 350px;
                text-align: center;
                animation: popupFadeIn 0.3s ease-out;
            }

            @keyframes popupFadeIn {
                from {
                    opacity: 0;
                    transform: translate(-50%, -50%) scale(0.8);
                }
                to {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
            }

            .center-warning-popup .warning-icon {
                display: inline-block;
                width: 24px;
                height: 24px;
                background: var(--primary-color);
                color: var(--secondary-color);
                border-radius: 50%;
                text-align: center;
                line-height: 24px;
                font-size: 14px;
                font-weight: bold;
                margin-bottom: 12px;
            }

            .center-warning-popup .warning-text {
                color: #6d4c41;
                font-size: 16px;
                font-weight: 500;
                line-height: 1.4;
                margin-bottom: 15px;
            }

            .center-warning-popup .warning-close {
                background: var(--primary-color);
                color: var(--secondary-color);
                border: none;
                border-radius: 6px;
                padding: 8px 16px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: opacity 0.2s;
            }

            .center-warning-popup .warning-close:hover {
                opacity: 0.9;
            }

            /* Custom radio button styling for monthly options */
            input[name="monthlyOption"]:checked + .custom-radio {
                background: var(--primary-color) !important;
                border-color: var(--primary-color) !important;
            }

            input[name="monthlyOption"]:checked + .custom-radio > div {
                opacity: 1 !important;
                background: var(--secondary-color) !important;
            }

            input[name="monthlyOption"]:not(:checked) + .custom-radio > div {
                opacity: 0 !important;
            }

            /* Monthly option container hover effects */
            .monthly-option-container:hover {
                border-color: var(--primary-color) !important;
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2) !important;
            }

            /* Force vertical layout for monthly options - override form-group flex */
            #timesPerMonthGroup {
                flex-direction: column !important;
                width: 100% !important;
                justify-content: flex-start !important;
            }

            /* Ensure monthly elements are hidden by default */
            #monthlyTimesDateGroup {
                display: none !important;
            }

            #monthlySchedulingOptions {
                display: none !important;
            }

            #timesPerMonthGroup > div {
                width: 100% !important;
                margin-bottom: 10px !important;
            }

            /* Remove any icons from modal headings */
            #specificDatesModal h3::before,
            #specificDatesModal h3::after,
            .fancy-modal h3::before,
            .fancy-modal h3::after {
                display: none !important;
                content: none !important;
            }

            .flatpickr-day.disabled {
                color: rgba(109, 76, 65, 0.2) !important;
                background: var(--light-bg) !important;
            }

            .flatpickr-time {
                background: var(--light-bg) !important;
                border-top: 1px solid var(--primary-color) !important;
            }

            .flatpickr-time input {
                background: var(--light-bg) !important;
                color: var(--text-color) !important;
            }

            /* Add spacing and alignment for the specific dates group */
            #specificDatesGroup {
                display: flex;
                flex-direction: column; /* Stack label, button, and chips vertically */
                align-items: flex-start; /* Align items to the left */
                gap: 15px; /* Space between label/button and chips */
            }

            /* Ensure the button and label are aligned nicely */
            #specificDatesGroup .button-wrapper {
                display: flex;
                align-items: center;
                gap: 10px; /* Space between label and + button */
            }

            /* Adjust container spacing */
            #selectedDatesContainer {
                margin-top: 15px; /* Increased from 10px for more breathing room */
                display: flex;
                flex-wrap: wrap;
                gap: 10px; /* Slightly more gap between chips */
                width: 100%; /* Full width for better alignment */
            }

            #removeEndDateBtn:hover {
                color: #b71c1c;
                transform: scale(1.1);
            }

            /* Date Mode Selector */
            #selectDateMode {
                width: 100%;
                text-align: left;
            }

            /* Specific Days Checkboxes */
            #specificDaysCheckboxes label {
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 16px;
                color: var(--text-color);
            }

            #specificDaysCheckboxes input[type="checkbox"] {
                width: 20px;
                height: 20px;
                accent-color: var(--primary-color);
                cursor: pointer;
            }

            /* Selected Days Display */
            #selectedDaysDisplay {
                max-width: 100%;
                overflow-wrap: break-word;
            }

            /* Date Section */
            .date-section {
                padding: 15px;
                background: var(--light-bg);
                border-radius: 10px;
                border: 1px solid var(--border-dark);
            }

            .section-label {
                font-size: 16px;
                font-weight: 600;
                color: var(--text-color);
                margin-bottom: 10px;
            }

            /* Date Mode Selector (Segmented Buttons) */
            .date-mode-selector {
                display: flex;
                gap: 8px;
                margin-bottom: 1rem;
            }

            .mode-btn {
                flex: 1;
                background: var(--card-bg);
                border: 2px solid var(--primary-color);
                color: var(--text-color);
                font-size: 14px;
                font-weight: 600;
                padding: 10px 15px;
                border-radius: 8px;
                cursor: pointer;
                transition:
                    background-color 0.3s ease,
                    color 0.3s ease,
                    transform 0.2s ease;
            }

            .mode-btn.active {
                background: var(--primary-color);
                color: var(--secondary-color);
                border-color: var(--primary-color);
                box-shadow: 0 2px 6px rgba(255, 193, 7, 0.3);
            }

            .mode-btn:hover {
                background: rgba(255, 193, 7, 0.1);
                transform: translateY(-1px);
            }

            .mode-btn.active:hover {
                background: #ffb300;
                transform: translateY(-1px);
            }

            /* Date Group (From/To, Specific Dates, Specific Days) */
            .date-group {
                display: flex;
                flex-direction: column;
                gap: 10px;
                padding: 0;
                background: transparent;
                border: none;
            }

            .date-row {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 8px;
                flex-wrap: wrap;
                min-height: 40px;
            }

            .date-label {
                font-size: 16px;
                font-weight: 600;
                color: var(--text-color);
                min-width: 60px;
                text-transform: capitalize;
            }

            .add-end-date {
                color: var(--primary-color);
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition:
                    color 0.3s ease,
                    transform 0.2s ease;
                padding: 6px 12px;
                border-radius: 6px;
                display: inline-block;
                margin-left: 8px;
                white-space: nowrap;
            }

            .add-end-date:hover {
                color: #ffb300;
                background: rgba(255, 193, 7, 0.2);
                transform: translateY(-1px);
            }

            .date-range-container {
                display: flex;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
            }

            .date-separator {
                color: var(--text-color);
                font-size: 14px;
                margin: 0 4px;
            }

            /* Responsive layout for mobile */
            @media (max-width: 480px) {
                .date-row {
                    flex-wrap: wrap;
                    gap: 6px;
                }

                .add-end-date {
                    margin-left: 4px;
                    font-size: 12px;
                    padding: 4px 8px;
                }

                .date-range-container {
                    gap: 6px;
                }
            }

            .remove-btn {
                cursor: pointer;
                font-size: 16px;
                color: var(--danger-color);
                transition:
                    color 0.3s ease,
                    transform 0.1s ease;
            }

            .remove-btn:hover {
                color: #b71c1c;
                transform: scale(1.1);
            }

            /* Container for Day Buttons */
            .day-buttons-container {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: flex-start;
                padding: 8px 0;
            }

            /* Day Buttons for Specific Days (Original Styles) */
            .day-btn {
                position: relative;
                background: var(--light-bg);
                border: 2px solid var(--primary-color);
                color: var(--text-color);
                font-size: 14px;
                font-weight: 600;
                padding: 8px 14px;
                border-radius: 8px;
                cursor: pointer;
                transition:
                    background-color 0.3s ease,
                    color 0.3s ease,
                    transform 0.2s ease;
                min-width: 50px;
                text-align: center;
                box-shadow: 0 1px 3px rgba(255, 193, 7, 0.1);
            }

            .day-btn.selected {
                background: var(--primary-color);
                color: var(--secondary-color);
                border-color: var(--primary-color);
                box-shadow: 0 3px 8px rgba(255, 193, 7, 0.3);
                transform: translateY(-1px);
            }

            .day-btn:hover {
                background: rgba(255, 193, 7, 0.1);
                transform: translateY(-1px);
                box-shadow: 0 2px 6px rgba(255, 193, 7, 0.2);
            }

            .day-btn.selected:hover {
                background: #ffb300;
                color: var(--secondary-color);
                transform: translateY(-1px);
                box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4);
            }
        </style>

        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
    </head>
    <body>
        <div class="header">
            <div class="title">Add Task</div>
            <span class="close-icon" onclick="closeAddTask()">✕</span>
        </div>

        <div class="content">
            <form id="addTaskForm">
                <div class="form-group-full" style="margin-bottom: 10px">
                    <label for="taskTitle"></label>
                    <input
                        type="text"
                        id="taskTitle"
                        placeholder="Enter task title"
                        required
                    />
                </div>
                <div
                    class="form-group-full"
                    style="
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        margin-bottom: 0px;
                    "
                >
                    <label class="switch">
                        <input type="checkbox" id="privateTask" />
                        <span class="slider"></span>
                    </label>
                    <label style="margin: 0; font-weight: 600"
                        >Private Task</label
                    >
                    <i
                        id="privateTaskInfo"
                        style="
                            font-size: 14px;
                            cursor: pointer;
                            border: 2px solid var(--text-color);
                            border-radius: 50%;
                            width: 20px;
                            height: 20px;
                            min-width: 20px;
                            min-height: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-style: normal;
                            font-weight: bold;
                            font-family: serif;
                            transition: all 0.2s ease;
                            background: var(--light-bg);
                            color: var(--text-color);
                            flex-shrink: 0;
                        "
                        onmouseover="this.style.background='var(--primary-color)'; this.style.borderColor='var(--primary-color)'; this.style.color='var(--secondary-color)'"
                        onmouseout="this.style.background='var(--light-bg)'; this.style.borderColor='var(--text-color)'; this.style.color='var(--text-color)'"
                        onclick="window.togglePrivateTaskPopup(event)"
                        >i</i
                    >

                    <!-- Private Task Info Popup -->
                    <div id="privateTaskPopup" class="info-popup">
                        <strong>Private Tasks</strong><br /><br />
                        Mark tasks such as "Brush Teeth," "Practice Piano," or
                        "Read Book" as private, and they won't appear in the
                        'All Tasks' list for everyone.
                    </div>
                </div>
                <div class="form-group-full" style="margin-top: 0px">
                    <button
                        type="button"
                        id="addNotesBtn"
                        style="
                            background: none;
                            border: none;
                            color: var(--primary-color);
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            padding: 8px 0;
                            text-decoration: none;
                        "
                        onclick="toggleNotesField()"
                    >
                        + Add notes/description
                    </button>
                    <div
                        id="notesContainer"
                        style="display: none; margin-top: 10px"
                    >
                        <label for="taskNotes"></label>
                        <textarea
                            id="taskNotes"
                            placeholder="Enter any additional notes"
                        ></textarea>
                    </div>
                </div>
                <div class="form-group room-section">
                    <label>Room</label>
                    <button type="button" id="selectRoom" class="select-btn">
                        Select
                    </button>
                    <input type="hidden" id="roomSelection" value="" />
                </div>

                <div class="form-group frequency-section">
                    <label
                        >Frequency
                        <i
                            style="
                                font-style: normal;
                                color: var(--text-color);
                                cursor: pointer;
                                font-size: 18px;
                                margin-left: 8px;
                                display: inline-flex;
                                align-items: center;
                                justify-content: center;
                                width: 20px;
                                height: 20px;
                                border: 2px solid var(--text-color);
                                border-radius: 50%;
                                transition: all 0.2s ease;
                                background: var(--light-bg);
                                color: var(--text-color);
                                flex-shrink: 0;
                            "
                            onmouseover="this.style.background='var(--primary-color)'; this.style.borderColor='var(--primary-color)'; this.style.color='var(--secondary-color)'"
                            onmouseout="this.style.background='var(--light-bg)'; this.style.borderColor='var(--text-color)'; this.style.color='var(--text-color)'"
                            onclick="window.toggleFrequencyInfoPopup(event)"
                            >i</i
                        >
                    </label>
                    <button type="button" id="selectRepeat" class="select-btn">
                        Select
                    </button>
                    <input type="hidden" id="repeatSelection" value="" />

                    <!-- Frequency Info Popup -->
                    <div id="frequencyInfoPopup" class="info-popup">
                        <strong>"Occasional" Frequency</strong><br /><br />
                        Choose "Occasional" frequency for tasks that occur
                        irregularly. Assign tasks like "Unload the Dishwasher"
                        or "Empty the Vacuum Cleaner" to family members and
                        activate them when necessary. Set a rotation to ensure
                        everyone takes their turn.
                    </div>
                </div>

                <!-- NEW: Times Per Day input (only shown when Daily is selected) -->
                <div
                    class="form-group"
                    id="timesPerDayGroup"
                    style="
                        display: none;
                        background-color: rgba(255, 193, 7, 0.1);
                        border: 2px solid var(--primary-color);
                        border-radius: 0.5rem;
                        padding: 1rem;
                        margin-bottom: 1rem;
                        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
                    "
                >
                    <label>Times per Day</label>
                    <div style="display: flex; align-items: center; gap: 8px">
                        <button
                            type="button"
                            id="decreaseTimesPerDay"
                            style="
                                width: 32px;
                                height: 32px;
                                border: 2px solid var(--primary-color);
                                border-radius: 6px;
                                background: var(--light-bg);
                                color: var(--text-color);
                                font-size: 18px;
                                font-weight: bold;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.3s ease;
                            "
                        >
                            -
                        </button>
                        <input
                            type="number"
                            id="timesPerDayInput"
                            value="1"
                            min="1"
                            max="100"
                            style="
                                width: 60px;
                                text-align: center;
                                padding: 8px;
                                border: 2px solid var(--primary-color);
                                border-radius: 8px;
                                background: var(--light-bg);
                                font-size: 16px;
                                color: var(--text-color);
                                font-weight: 400;
                            "
                        />
                        <button
                            type="button"
                            id="increaseTimesPerDay"
                            style="
                                width: 32px;
                                height: 32px;
                                border: 2px solid var(--primary-color);
                                border-radius: 6px;
                                background: var(--light-bg);
                                color: var(--text-color);
                                font-size: 18px;
                                font-weight: bold;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.3s ease;
                            "
                        >
                            +
                        </button>
                    </div>
                </div>

                <!-- Weekly Frequency Input -->
                <div
                    class="form-group"
                    id="timesPerWeekGroup"
                    style="
                        display: none;
                        background-color: rgba(255, 193, 7, 0.1);
                        border: 2px solid var(--primary-color);
                        border-radius: 0.5rem;
                        padding: 1rem;
                        margin-bottom: 1rem;
                        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
                    "
                >
                    <label>Times per Week</label>
                    <div
                        style="
                            display: flex;
                            flex-wrap: nowrap;
                            gap: 3px;
                            justify-content: center;
                            margin-top: 8px;
                            overflow-x: auto;
                        "
                    >
                        <button
                            type="button"
                            class="week-option-btn"
                            data-value="1"
                            style="
                                min-width: 28px;
                                width: 28px;
                                height: 28px;
                                border: 1px solid var(--primary-color);
                                border-radius: 6px;
                                background: var(--primary-color);
                                color: var(--secondary-color);
                                font-size: 12px;
                                font-weight: bold;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.2s;
                                flex-shrink: 0;
                            "
                        >
                            1
                        </button>
                        <button
                            type="button"
                            class="week-option-btn"
                            data-value="2"
                            style="
                                min-width: 28px;
                                width: 28px;
                                height: 28px;
                                border: 1px solid var(--primary-color);
                                border-radius: 6px;
                                background: var(--light-bg);
                                color: var(--text-color);
                                font-size: 12px;
                                font-weight: bold;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.2s;
                                flex-shrink: 0;
                            "
                        >
                            2
                        </button>
                        <button
                            type="button"
                            class="week-option-btn"
                            data-value="3"
                            style="
                                min-width: 28px;
                                width: 28px;
                                height: 28px;
                                border: 1px solid var(--primary-color);
                                border-radius: 6px;
                                background: var(--light-bg);
                                color: var(--text-color);
                                font-size: 12px;
                                font-weight: bold;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.2s;
                                flex-shrink: 0;
                            "
                        >
                            3
                        </button>
                        <button
                            type="button"
                            class="week-option-btn"
                            data-value="4"
                            style="
                                min-width: 28px;
                                width: 28px;
                                height: 28px;
                                border: 1px solid var(--primary-color);
                                border-radius: 6px;
                                background: var(--light-bg);
                                color: var(--text-color);
                                font-size: 12px;
                                font-weight: bold;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.2s;
                                flex-shrink: 0;
                            "
                        >
                            4
                        </button>
                        <button
                            type="button"
                            class="week-option-btn"
                            data-value="5"
                            style="
                                min-width: 28px;
                                width: 28px;
                                height: 28px;
                                border: 1px solid var(--primary-color);
                                border-radius: 6px;
                                background: var(--light-bg);
                                color: var(--text-color);
                                font-size: 12px;
                                font-weight: bold;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.2s;
                                flex-shrink: 0;
                            "
                        >
                            5
                        </button>
                        <button
                            type="button"
                            class="week-option-btn"
                            data-value="6"
                            style="
                                min-width: 28px;
                                width: 28px;
                                height: 28px;
                                border: 1px solid var(--primary-color);
                                border-radius: 6px;
                                background: var(--light-bg);
                                color: var(--text-color);
                                font-size: 12px;
                                font-weight: bold;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.2s;
                                flex-shrink: 0;
                            "
                        >
                            6
                        </button>
                        <button
                            type="button"
                            class="week-option-btn"
                            data-value="7"
                            style="
                                min-width: 28px;
                                width: 28px;
                                height: 28px;
                                border: 1px solid var(--primary-color);
                                border-radius: 6px;
                                background: var(--light-bg);
                                color: var(--text-color);
                                font-size: 12px;
                                font-weight: bold;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.2s;
                                flex-shrink: 0;
                            "
                        >
                            7
                        </button>
                    </div>
                    <input type="hidden" id="timesPerWeekInput" value="1" />
                </div>

                <!-- Monthly Frequency Input -->
                <div
                    class="form-group"
                    id="timesPerMonthGroup"
                    style="
                        display: none;
                        background-color: rgba(255, 193, 7, 0.1);
                        border: 2px solid var(--primary-color);
                        border-radius: 0.5rem;
                        padding: 1rem;
                        margin-bottom: 1rem;
                        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
                        flex-direction: column !important;
                        width: 100%;
                        justify-content: flex-start !important;
                    "
                >
                    <label
                        style="
                            font-weight: 600;
                            margin-bottom: 15px;
                            display: block;
                            text-align: center;
                            color: var(--text-color);
                            font-size: 16px;
                        "
                        >Monthly Options</label
                    >

                    <!-- Option 1: Times per month -->
                    <div
                        id="timesOption"
                        style="
                            background: var(--light-bg);
                            border: 2px solid var(--primary-color);
                            border-radius: 8px;
                            padding: 12px;
                            margin-bottom: 10px;
                            transition: all 0.2s;
                            box-shadow: 0 2px 6px rgba(255, 193, 7, 0.1);
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            width: 100%;
                            box-sizing: border-box;
                        "
                    >
                        <label
                            style="
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                cursor: pointer;
                                flex: 1;
                            "
                        >
                            <div
                                style="
                                    position: relative;
                                    width: 20px;
                                    height: 20px;
                                "
                            >
                                <input
                                    type="radio"
                                    name="monthlyOption"
                                    value="times"
                                    checked
                                    style="
                                        position: absolute;
                                        opacity: 0;
                                        width: 100%;
                                        height: 100%;
                                        cursor: pointer;
                                    "
                                />
                                <div
                                    class="custom-radio"
                                    style="
                                        width: 20px;
                                        height: 20px;
                                        border: 2px solid var(--primary-color);
                                        border-radius: 50%;
                                        background: var(--light-bg);
                                        position: relative;
                                        transition: all 0.2s;
                                    "
                                >
                                    <div
                                        style="
                                            width: 10px;
                                            height: 10px;
                                            background: var(--primary-color);
                                            border-radius: 50%;
                                            position: absolute;
                                            top: 50%;
                                            left: 50%;
                                            transform: translate(-50%, -50%);
                                            opacity: 1;
                                            transition: opacity 0.2s;
                                        "
                                    ></div>
                                </div>
                            </div>
                            <span
                                class="option-label"
                                style="
                                    font-weight: 600;
                                    font-size: 15px;
                                    color: var(--text-color);
                                "
                                >Times per month</span
                            >
                        </label>
                        <div
                            style="display: flex; align-items: center; gap: 8px"
                        >
                            <button
                                type="button"
                                id="decrementTimesMonth"
                                style="
                                    width: 32px;
                                    height: 32px;
                                    border: 2px solid var(--primary-color);
                                    border-radius: 6px;
                                    background: var(--light-bg);
                                    color: var(--text-color);
                                    font-size: 16px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.2s;
                                "
                            >
                                -
                            </button>
                            <input
                                type="number"
                                id="timesPerMonthInput"
                                value="1"
                                min="1"
                                max="31"
                                style="
                                    width: 60px;
                                    text-align: center;
                                    padding: 8px;
                                    border: 2px solid var(--primary-color);
                                    border-radius: 6px;
                                    background: var(--light-bg);
                                    font-size: 16px;
                                    color: var(--text-color);
                                    font-weight: 500;
                                "
                            />
                            <button
                                type="button"
                                id="incrementTimesMonth"
                                style="
                                    width: 32px;
                                    height: 32px;
                                    border: 2px solid var(--primary-color);
                                    border-radius: 6px;
                                    background: var(--light-bg);
                                    color: var(--text-color);
                                    font-size: 16px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.2s;
                                "
                            >
                                +
                            </button>
                        </div>
                    </div>

                    <!-- Option 2: Once every X months -->
                    <div
                        id="intervalOption"
                        style="
                            background: var(--light-bg);
                            border: 2px solid rgba(255, 193, 7, 0.3);
                            border-radius: 8px;
                            padding: 12px;
                            transition: all 0.2s;
                            box-shadow: 0 2px 6px rgba(255, 193, 7, 0.05);
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            width: 100%;
                            box-sizing: border-box;
                        "
                    >
                        <label
                            style="
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                cursor: pointer;
                                flex: 1;
                            "
                        >
                            <div
                                style="
                                    position: relative;
                                    width: 20px;
                                    height: 20px;
                                "
                            >
                                <input
                                    type="radio"
                                    name="monthlyOption"
                                    value="interval"
                                    style="
                                        position: absolute;
                                        opacity: 0;
                                        width: 100%;
                                        height: 100%;
                                        cursor: pointer;
                                    "
                                />
                                <div
                                    class="custom-radio"
                                    style="
                                        width: 20px;
                                        height: 20px;
                                        border: 2px solid var(--primary-color);
                                        border-radius: 50%;
                                        background: var(--light-bg);
                                        position: relative;
                                        transition: all 0.2s;
                                    "
                                >
                                    <div
                                        style="
                                            width: 10px;
                                            height: 10px;
                                            background: var(--primary-color);
                                            border-radius: 50%;
                                            position: absolute;
                                            top: 50%;
                                            left: 50%;
                                            transform: translate(-50%, -50%);
                                            opacity: 0;
                                            transition: opacity 0.2s;
                                        "
                                    ></div>
                                </div>
                            </div>
                            <span
                                class="option-label"
                                style="
                                    font-weight: 600;
                                    font-size: 15px;
                                    color: var(--text-color);
                                    opacity: 0.5;
                                "
                                >Once every</span
                            >
                        </label>
                        <div
                            style="display: flex; align-items: center; gap: 8px"
                        >
                            <button
                                type="button"
                                id="decrementMonthInterval"
                                style="
                                    width: 32px;
                                    height: 32px;
                                    border: 2px solid var(--primary-color);
                                    border-radius: 6px;
                                    background: var(--light-bg);
                                    color: var(--text-color);
                                    font-size: 16px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.2s;
                                    opacity: 0.5;
                                "
                                disabled
                            >
                                -
                            </button>
                            <input
                                type="number"
                                id="monthIntervalInput"
                                value="1"
                                min="1"
                                max="12"
                                style="
                                    width: 60px;
                                    text-align: center;
                                    padding: 8px;
                                    border: 2px solid var(--primary-color);
                                    border-radius: 6px;
                                    background: var(--light-bg);
                                    font-size: 16px;
                                    color: var(--text-color);
                                    font-weight: 500;
                                    opacity: 0.5;
                                "
                                disabled
                            />
                            <button
                                type="button"
                                id="incrementMonthInterval"
                                style="
                                    width: 32px;
                                    height: 32px;
                                    border: 2px solid var(--primary-color);
                                    border-radius: 6px;
                                    background: var(--light-bg);
                                    color: var(--text-color);
                                    font-size: 16px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.2s;
                                    opacity: 0.5;
                                "
                                disabled
                            >
                                +
                            </button>
                            <span
                                class="month-text"
                                style="
                                    color: var(--text-color);
                                    font-size: 15px;
                                    font-weight: 500;
                                    opacity: 0.5;
                                "
                                >month(s)</span
                            >
                        </div>
                    </div>
                </div>

                <div class="form-group-full date-section">
                    <!-- Default Select Dates Button -->
                    <div id="defaultDateSelector" style="display: block">
                        <button
                            type="button"
                            id="selectDatesBtn"
                            class="select-btn"
                            style="
                                width: 100%;
                                padding: 12px;
                                background: var(--light-bg);
                                border: 2px solid var(--primary-color);
                                border-radius: 8px;
                                color: var(--text-color);
                                font-size: 16px;
                                font-weight: 500;
                                cursor: pointer;
                                transition: all 0.2s;
                            "
                        >
                            Select Dates
                        </button>
                    </div>

                    <div
                        class="date-mode-selector"
                        id="generalDateModeSelector"
                        style="display: none"
                    >
                        <button
                            type="button"
                            class="mode-btn active"
                            data-mode="date"
                        >
                            Days
                        </button>
                        <button
                            type="button"
                            class="mode-btn"
                            data-mode="specific-dates"
                        >
                            Specific Dates
                        </button>
                        <input
                            type="hidden"
                            id="dateModeSelection"
                            value="date"
                        />
                    </div>

                    <!-- Single Date UI for One Time tasks -->
                    <div
                        id="singleDateGroup"
                        class="date-group"
                        style="display: none"
                    >
                        <div class="date-row">
                            <span class="date-label">Date</span>
                            <div class="date-display" id="singleDateDisplay">
                                Select Date
                            </div>
                        </div>
                    </div>

                    <!-- From - To Date UI -->
                    <div
                        id="fromToDateGroup"
                        class="date-group"
                        style="display: none"
                    >
                        <div class="date-row">
                            <span class="date-label">From</span>
                            <div class="date-range-container">
                                <div id="dateDisplay" class="date-display">
                                    Today
                                </div>
                                <span id="addEndDateBtn" class="add-end-date"
                                    >+ Add End Date</span
                                >
                                <span
                                    id="dateToWrapper"
                                    class="date-separator"
                                    style="display: none"
                                    >to</span
                                >
                                <div
                                    id="dateDisplayTo"
                                    class="date-display"
                                    style="display: none"
                                >
                                    To Date
                                </div>
                                <span
                                    id="removeEndDateBtn"
                                    class="remove-btn"
                                    style="display: none"
                                    >✖</span
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Specific Dates UI -->
                    <div
                        id="specificDatesGroup"
                        class="date-group"
                        style="display: none"
                    >
                        <div class="date-row">
                            <span class="date-label">Dates</span>
                            <button
                                type="button"
                                id="selectSpecificDates"
                                class="plus-btn"
                            >
                                +
                            </button>
                        </div>
                        <div
                            id="selectedDatesContainer"
                            style="margin-top: 10px"
                        ></div>
                    </div>

                    <!-- Specific Days UI -->
                    <div
                        id="specificDaysGroup"
                        class="date-group"
                        style="display: none"
                    >
                        <div class="date-row">
                            <div
                                id="specificDaysButtons"
                                class="day-buttons-container"
                            >
                                <button
                                    type="button"
                                    class="day-btn"
                                    data-day="Any"
                                    id="anyAllButton"
                                    title="Daily: All 7 days | Weekly: Any day"
                                >
                                    Any
                                </button>
                                <button
                                    type="button"
                                    class="day-btn"
                                    data-day="Mon"
                                >
                                    Mon
                                </button>
                                <button
                                    type="button"
                                    class="day-btn"
                                    data-day="Tue"
                                >
                                    Tue
                                </button>
                                <button
                                    type="button"
                                    class="day-btn"
                                    data-day="Wed"
                                >
                                    Wed
                                </button>
                                <button
                                    type="button"
                                    class="day-btn"
                                    data-day="Thu"
                                >
                                    Thu
                                </button>
                                <button
                                    type="button"
                                    class="day-btn"
                                    data-day="Fri"
                                >
                                    Fri
                                </button>
                                <button
                                    type="button"
                                    class="day-btn"
                                    data-day="Sat"
                                >
                                    Sat
                                </button>
                                <button
                                    type="button"
                                    class="day-btn"
                                    data-day="Sun"
                                >
                                    Sun
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Times Date Range UI -->
                    <div
                        id="monthlyTimesDateGroup"
                        class="date-group"
                        style="display: none"
                    >
                        <div class="date-row">
                            <span class="date-label">From</span>
                            <div class="date-range-container">
                                <div
                                    id="monthlyDateDisplay"
                                    class="date-display"
                                >
                                    Today
                                </div>
                                <span
                                    id="addMonthlyEndDateBtn"
                                    class="add-end-date"
                                    >+ Add End Date</span
                                >
                                <span
                                    id="monthlyDateToWrapper"
                                    class="date-separator"
                                    style="display: none"
                                    >to</span
                                >
                                <div
                                    id="monthlyDateDisplayTo"
                                    class="date-display"
                                    style="display: none"
                                >
                                    To Date
                                </div>
                                <span
                                    id="removeMonthlyEndDateBtn"
                                    class="remove-btn"
                                    style="display: none"
                                    >✖</span
                                >
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Scheduling Options -->
                    <div
                        id="monthlySchedulingOptions"
                        class="date-group"
                        style="
                            display: none;
                            flex-direction: column;
                            gap: 15px;
                            margin-top: 15px;
                        "
                    >
                        <div
                            style="
                                display: flex;
                                flex-direction: column;
                                gap: 10px;
                            "
                        >
                            <label
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    cursor: pointer;
                                "
                            >
                                <input
                                    type="checkbox"
                                    id="specificDaysOfMonthCheckbox"
                                    name="monthlySchedulingType"
                                    style="
                                        width: 18px;
                                        height: 18px;
                                        accent-color: var(--primary-color);
                                    "
                                />
                                <span
                                    style="
                                        font-weight: 500;
                                        color: var(--text-color);
                                    "
                                    >Specific days of the month</span
                                >
                            </label>
                            <label
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 10px;
                                    cursor: pointer;
                                "
                            >
                                <input
                                    type="checkbox"
                                    id="specificDaysOfWeekCheckbox"
                                    name="monthlySchedulingType"
                                    style="
                                        width: 18px;
                                        height: 18px;
                                        accent-color: var(--primary-color);
                                    "
                                />
                                <span
                                    style="
                                        font-weight: 500;
                                        color: var(--text-color);
                                    "
                                    >Specific days of the week</span
                                >
                            </label>
                        </div>

                        <!-- Days of Month Fields -->
                        <div
                            id="daysOfMonthFields"
                            style="
                                display: none;
                                flex-direction: column;
                                gap: 8px;
                            "
                        ></div>

                        <!-- Days of Week Fields -->
                        <div
                            id="daysOfWeekFields"
                            style="
                                display: none;
                                flex-direction: column;
                                gap: 8px;
                            "
                        ></div>
                    </div>

                    <!-- Hidden inputs -->
                    <input type="text" id="taskDate" class="date-input" />
                    <input type="text" id="taskDateTo" class="date-input" />
                    <input
                        type="text"
                        id="monthlyTaskDate"
                        class="date-input"
                    />
                    <input
                        type="text"
                        id="monthlyTaskDateTo"
                        class="date-input"
                    />
                    <input type="text" id="singleTaskDate" class="date-input" />
                    <input type="hidden" id="specificDatesInput" value="" />
                    <input type="hidden" id="specificDaysInput" value="" />
                    <input
                        type="hidden"
                        id="monthlyDaysOfMonthInput"
                        value=""
                    />
                    <input type="hidden" id="monthlyDaysOfWeekInput" value="" />
                </div>

                <!-- COMMENTED OUT - REMINDERS FUNCTIONALITY (keep for later implementation)
            <div class="form-group">
                <label>Reminder</label>
                <label class="switch">
                    <input type="checkbox" id="taskReminder">
                    <span class="slider"></span>
                </label>
                <button type="button" id="addAlarmBtn" class="select-btn" style="display: none; margin-left: 10px;">+ Add Alarm</button>
            </div>
            <div id="alarmContainer" style="margin-top: 10px;"></div>
            -->

                <div class="form-group">
                    <label>Due Time</label>
                    <label class="switch">
                        <input type="checkbox" id="dueTimeToggle" />
                        <span class="slider"></span>
                    </label>
                </div>
                <div
                    id="dueTimeContainer"
                    style="margin-top: 10px; display: none"
                ></div>

                <div class="form-group">
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            position: relative;
                        "
                    >
                        <label>Settings</label>
                        <i
                            id="settingsInfo"
                            style="
                                font-size: 14px;
                                cursor: pointer;
                                border: 2px solid var(--text-color);
                                border-radius: 50%;
                                width: 20px;
                                height: 20px;
                                min-width: 20px;
                                min-height: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-style: normal;
                                font-weight: bold;
                                font-family: serif;
                                transition: all 0.2s ease;
                                background: var(--light-bg);
                                color: var(--text-color);
                                flex-shrink: 0;
                            "
                            onmouseover="this.style.background='var(--primary-color)'; this.style.borderColor='var(--primary-color)'; this.style.color='var(--secondary-color)'"
                            onmouseout="this.style.background='var(--light-bg)'; this.style.borderColor='var(--text-color)'; this.style.color='var(--text-color)'"
                            onclick="window.toggleSettingsPopup(event)"
                            >i</i
                        >

                        <!-- Floating Popup -->
                        <div id="settingsPopup" class="info-popup">
                            <strong>Task Settings</strong><br /><br />
                            <strong>Rotation:</strong> Assign chores on a
                            rotating basis, so each family member takes turns in
                            a predefined order, ensuring fair distribution of
                            tasks over time.<br /><br />
                            <strong>Teamwork:</strong> Set up chores to be
                            completed as a team, where everyone works together
                            or tasks are dependent on each other, promoting
                            cooperation and shared effort.<br /><br />
                            <strong>Individual:</strong> Each assigned family
                            member completes the task independently without
                            rotation or teamwork requirements.
                        </div>
                    </div>
                    <button
                        type="button"
                        id="selectSettings"
                        class="select-btn"
                    >
                        Select
                    </button>
                    <input type="hidden" id="settingsSelection" value="" />
                </div>

                <!-- Fair Rotation Options (separate section) -->
                <div
                    id="fairRotationSection"
                    style="
                        display: none;
                        background-color: rgba(255, 255, 255, 0.8);
                        border: 2px solid var(--primary-color);
                        border-radius: 0.5rem;
                        padding: 1.5rem;
                        margin-bottom: 1.5rem;
                        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.15);
                    "
                >
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            margin-bottom: 12px;
                        "
                    >
                        <label
                            for="fairRotationToggle"
                            style="
                                color: var(--text-color);
                                font-weight: 600;
                                font-size: 16px;
                                cursor: pointer;
                            "
                            >Fair Rotation</label
                        >
                        <label class="switch" style="margin: 0">
                            <input type="checkbox" id="fairRotationToggle" />
                            <span class="slider"></span>
                        </label>
                    </div>
                    <p
                        style="
                            font-size: 13px;
                            color: rgba(109, 76, 65, 0.85);
                            margin: 0 0 15px 0;
                            line-height: 1.4;
                        "
                    >
                        When enabled, assigns tasks to the person who has
                        completed them the least, ensuring balanced workload
                        distribution across all family members.
                    </p>

                    <!-- Advanced Fair Rotation Options -->
                    <div
                        id="fairRotationAdvanced"
                        style="
                            display: none;
                            border-top: 1px solid rgba(255, 193, 7, 0.3);
                            padding-top: 15px;
                        "
                    >
                        <div
                            style="
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                margin-bottom: 8px;
                            "
                        >
                            <label
                                for="fairRotationTimeBasedToggle"
                                style="
                                    color: var(--text-color);
                                    font-weight: 500;
                                    font-size: 14px;
                                    cursor: pointer;
                                "
                                >Time-based tie breaking</label
                            >
                            <label
                                class="switch"
                                style="margin: 0; transform: scale(0.8)"
                            >
                                <input
                                    type="checkbox"
                                    id="fairRotationTimeBasedToggle"
                                />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <p
                            style="
                                font-size: 11px;
                                color: rgba(109, 76, 65, 0.7);
                                margin: 0;
                                line-height: 1.3;
                            "
                        >
                            When users have equal completion counts, assign to
                            whoever completed the task longest ago instead of
                            using rotation order.
                        </p>
                    </div>
                </div>

                <!-- Rotation Timing Options -->
                <div
                    id="rotationOptions"
                    style="
                        display: none;
                        background-color: rgba(255, 193, 7, 0.1);
                        border: 2px solid var(--primary-color);
                        border-radius: 0.5rem;
                        padding: 1rem;
                        margin-bottom: 1rem;
                        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
                    "
                >
                    <label
                        style="
                            font-weight: 600;
                            margin-bottom: 15px;
                            display: block;
                            color: var(--text-color);
                        "
                        >Rotate after:</label
                    >

                    <!-- Option 1: After X occurrences -->
                    <div
                        style="
                            margin-bottom: 15px;
                            display: flex;
                            flex-direction: column;
                        "
                    >
                        <label
                            style="
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                cursor: pointer;
                                padding: 8px 0;
                            "
                        >
                            <div
                                style="
                                    position: relative;
                                    display: inline-block;
                                    width: 20px;
                                    height: 20px;
                                "
                            >
                                <input
                                    type="radio"
                                    name="rotationType"
                                    value="occurrences"
                                    id="rotateOccurrences"
                                    checked
                                    style="
                                        position: absolute;
                                        opacity: 0;
                                        width: 100%;
                                        height: 100%;
                                        margin: 0;
                                        cursor: pointer;
                                    "
                                />
                                <div
                                    class="radio-custom"
                                    style="
                                        width: 20px;
                                        height: 20px;
                                        border: 2px solid var(--primary-color);
                                        border-radius: 50%;
                                        background: var(--light-bg);
                                        position: relative;
                                        transition: all 0.3s ease;
                                    "
                                ></div>
                            </div>
                            <span
                                style="
                                    color: var(--text-color);
                                    font-weight: 500;
                                "
                                >after</span
                            >
                            <div
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 6px;
                                "
                            >
                                <button
                                    type="button"
                                    id="decreaseOccurrences"
                                    style="
                                        width: 28px;
                                        height: 28px;
                                        border: 2px solid var(--primary-color);
                                        border-radius: 6px;
                                        background: var(--light-bg);
                                        color: var(--text-color);
                                        font-size: 16px;
                                        font-weight: bold;
                                        cursor: pointer;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        transition: all 0.3s ease;
                                    "
                                >
                                    -
                                </button>
                                <input
                                    type="number"
                                    id="occurrencesValue"
                                    value="1"
                                    min="1"
                                    max="100"
                                    style="
                                        width: 60px;
                                        text-align: center;
                                        padding: 6px;
                                        border: 2px solid var(--primary-color);
                                        border-radius: 6px;
                                        background: var(--light-bg);
                                        font-size: 14px;
                                        color: var(--text-color);
                                    "
                                />
                                <button
                                    type="button"
                                    id="increaseOccurrences"
                                    style="
                                        width: 28px;
                                        height: 28px;
                                        border: 2px solid var(--primary-color);
                                        border-radius: 6px;
                                        background: var(--light-bg);
                                        color: var(--text-color);
                                        font-size: 16px;
                                        font-weight: bold;
                                        cursor: pointer;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        transition: all 0.3s ease;
                                    "
                                >
                                    +
                                </button>
                            </div>
                            <span
                                style="
                                    color: var(--text-color);
                                    font-weight: 500;
                                "
                                >occurrences</span
                            >
                        </label>
                    </div>

                    <!-- Option 2: After X days/weeks -->
                    <div
                        style="
                            margin-bottom: 15px;
                            display: flex;
                            flex-direction: column;
                        "
                    >
                        <label
                            style="
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                cursor: pointer;
                                padding: 8px 0;
                            "
                        >
                            <div
                                style="
                                    position: relative;
                                    display: inline-block;
                                    width: 20px;
                                    height: 20px;
                                "
                            >
                                <input
                                    type="radio"
                                    name="rotationType"
                                    value="time"
                                    id="rotateTime"
                                    style="
                                        position: absolute;
                                        opacity: 0;
                                        width: 100%;
                                        height: 100%;
                                        margin: 0;
                                        cursor: pointer;
                                    "
                                />
                                <div
                                    class="radio-custom"
                                    style="
                                        width: 20px;
                                        height: 20px;
                                        border: 2px solid var(--primary-color);
                                        border-radius: 50%;
                                        background: var(--light-bg);
                                        position: relative;
                                        transition: all 0.3s ease;
                                    "
                                ></div>
                            </div>
                            <span
                                style="
                                    color: var(--text-color);
                                    font-weight: 500;
                                "
                                >after</span
                            >
                            <div
                                style="
                                    display: flex;
                                    align-items: center;
                                    gap: 6px;
                                "
                            >
                                <button
                                    type="button"
                                    id="decreaseTimeValue"
                                    style="
                                        width: 28px;
                                        height: 28px;
                                        border: 2px solid var(--primary-color);
                                        border-radius: 6px;
                                        background: var(--light-bg);
                                        color: var(--text-color);
                                        font-size: 16px;
                                        font-weight: bold;
                                        cursor: pointer;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        transition: all 0.3s ease;
                                    "
                                >
                                    -
                                </button>
                                <input
                                    type="number"
                                    id="timeValue"
                                    value="1"
                                    min="1"
                                    max="100"
                                    style="
                                        width: 60px;
                                        text-align: center;
                                        padding: 6px;
                                        border: 2px solid var(--primary-color);
                                        border-radius: 6px;
                                        background: var(--light-bg);
                                        font-size: 14px;
                                        color: var(--text-color);
                                    "
                                />
                                <button
                                    type="button"
                                    id="increaseTimeValue"
                                    style="
                                        width: 28px;
                                        height: 28px;
                                        border: 2px solid var(--primary-color);
                                        border-radius: 6px;
                                        background: var(--light-bg);
                                        color: var(--text-color);
                                        font-size: 16px;
                                        font-weight: bold;
                                        cursor: pointer;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        transition: all 0.3s ease;
                                    "
                                >
                                    +
                                </button>
                            </div>
                            <select
                                id="timeUnit"
                                style="
                                    padding: 6px 8px;
                                    border: 2px solid var(--primary-color);
                                    border-radius: 6px;
                                    background: var(--light-bg);
                                    font-size: 14px;
                                    color: var(--text-color);
                                "
                            >
                                <option value="days">days</option>
                                <option value="weeks">weeks</option>
                            </select>
                        </label>
                    </div>

                    <!-- Option 3: After another family member completes -->
                    <div
                        style="
                            margin-bottom: 8px;
                            display: flex;
                            flex-direction: column;
                        "
                    >
                        <label
                            style="
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                cursor: pointer;
                                padding: 8px 0;
                            "
                        >
                            <div
                                style="
                                    position: relative;
                                    display: inline-block;
                                    width: 20px;
                                    height: 20px;
                                "
                            >
                                <input
                                    type="radio"
                                    name="rotationType"
                                    value="completion"
                                    id="rotateCompletion"
                                    style="
                                        position: absolute;
                                        opacity: 0;
                                        width: 100%;
                                        height: 100%;
                                        margin: 0;
                                        cursor: pointer;
                                    "
                                />
                                <div
                                    class="radio-custom"
                                    style="
                                        width: 20px;
                                        height: 20px;
                                        border: 2px solid var(--primary-color);
                                        border-radius: 50%;
                                        background: var(--light-bg);
                                        position: relative;
                                        transition: all 0.3s ease;
                                    "
                                ></div>
                            </div>
                            <span
                                style="
                                    color: var(--text-color);
                                    font-weight: 500;
                                "
                                >after another family member completes</span
                            >
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Assign to:</label>
                    <div
                        id="userAvatarContainer"
                        style="
                            display: flex;
                            flex-wrap: wrap;
                            gap: 8px;
                            margin-top: 8px;
                            align-items: center;
                        "
                    >
                        <div
                            id="userAvatarList"
                            style="display: flex; flex-wrap: wrap; gap: 8px"
                        ></div>
                    </div>
                    <input type="hidden" id="assignedToSelection" value="" />
                </div>
                <div class="form-group">
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                        "
                    >
                        <div
                            style="
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            "
                        >
                            <label class="switch">
                                <input
                                    type="checkbox"
                                    id="buzzpointsToggle"
                                    checked
                                />
                                <span class="slider"></span>
                            </label>
                            <label
                                style="
                                    font-weight: 600;
                                    color: var(--text-color);
                                "
                                >Buzz Points:</label
                            >
                        </div>
                        <div
                            id="buzzpointsInputContainer"
                            style="display: flex; align-items: center; gap: 6px"
                        >
                            <button
                                type="button"
                                id="decreaseBuzzpoints"
                                style="
                                    width: 32px;
                                    height: 32px;
                                    border: 2px solid var(--primary-color);
                                    border-radius: 6px;
                                    background: var(--light-bg);
                                    color: var(--text-color);
                                    font-size: 16px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                "
                            >
                                -
                            </button>
                            <input
                                type="number"
                                id="RewardValue"
                                value="10"
                                min="0"
                                max="10000"
                                style="
                                    width: 60px;
                                    text-align: center;
                                    padding: 8px;
                                    border: 2px solid var(--primary-color);
                                    border-radius: 6px;
                                    background: var(--light-bg);
                                    font-size: 16px;
                                    color: var(--text-color);
                                    font-weight: 500;
                                "
                            />
                            <button
                                type="button"
                                id="increaseBuzzpoints"
                                style="
                                    width: 32px;
                                    height: 32px;
                                    border: 2px solid var(--primary-color);
                                    border-radius: 6px;
                                    background: var(--light-bg);
                                    color: var(--text-color);
                                    font-size: 16px;
                                    font-weight: bold;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.3s ease;
                                "
                            >
                                +
                            </button>
                            <span
                                style="
                                    font-size: 18px;
                                    color: var(--primary-color);
                                    margin-left: 4px;
                                "
                                >🍯</span
                            >
                        </div>
                    </div>
                </div>

                <!-- Parent Approval Toggle -->
                <div class="form-group">
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                        "
                    >
                        <label
                            class="switch"
                            style="flex-shrink: 0; margin-right: 15px"
                        >
                            <input
                                type="checkbox"
                                id="parentApprovalToggle"
                                checked
                            />
                            <span class="slider"></span>
                        </label>
                        <div
                            style="
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                flex: 1;
                                position: relative;
                            "
                        >
                            <label
                                for="parentApprovalToggle"
                                style="
                                    color: var(--text-color);
                                    font-weight: 600;
                                    cursor: pointer;
                                    flex: 1;
                                "
                                >Parent Approval Required</label
                            >
                            <i
                                id="parentApprovalInfo"
                                style="
                                    font-size: 14px;
                                    cursor: pointer;
                                    border: 2px solid var(--text-color);
                                    border-radius: 50%;
                                    width: 20px;
                                    height: 20px;
                                    min-width: 20px;
                                    min-height: 20px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-style: normal;
                                    font-weight: bold;
                                    font-family: serif;
                                    transition: all 0.2s ease;
                                    background: var(--light-bg);
                                    color: var(--text-color);
                                    flex-shrink: 0;
                                "
                                onmouseover="this.style.background='var(--primary-color)'; this.style.borderColor='var(--primary-color)'; this.style.color='var(--secondary-color)'"
                                onmouseout="this.style.background='var(--light-bg)'; this.style.borderColor='var(--text-color)'; this.style.color='var(--text-color)'"
                                onclick="window.toggleParentApprovalPopup(event)"
                                >i</i
                            >

                            <!-- Floating Popup -->
                            <div id="parentApprovalPopup" class="info-popup">
                                <strong>Parent Approval Required</strong
                                ><br /><br />
                                <strong>ON:</strong> Tasks need parent approval
                                before buzz points are awarded.<br /><br />
                                <strong>OFF:</strong> Tasks are instantly
                                completed and points awarded immediately.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- On-time Completion Important Toggle -->
                <div class="form-group">
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                        "
                    >
                        <label
                            class="switch"
                            style="flex-shrink: 0; margin-right: 15px"
                        >
                            <input
                                type="checkbox"
                                id="onTimeCompletionToggle"
                            />
                            <span class="slider"></span>
                        </label>
                        <div
                            style="
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                flex: 1;
                                position: relative;
                            "
                        >
                            <label
                                for="onTimeCompletionToggle"
                                style="
                                    color: var(--text-color);
                                    font-weight: 600;
                                    cursor: pointer;
                                    flex: 1;
                                "
                                >On-time completion important</label
                            >
                            <i
                                id="onTimeCompletionInfo"
                                style="
                                    font-size: 14px;
                                    cursor: pointer;
                                    border: 2px solid var(--text-color);
                                    border-radius: 50%;
                                    width: 20px;
                                    height: 20px;
                                    min-width: 20px;
                                    min-height: 20px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-style: normal;
                                    font-weight: bold;
                                    font-family: serif;
                                    transition: all 0.2s ease;
                                    background: var(--light-bg);
                                    color: var(--text-color);
                                    flex-shrink: 0;
                                "
                                onmouseover="this.style.background='var(--primary-color)'; this.style.borderColor='var(--primary-color)'; this.style.color='var(--secondary-color)'"
                                onmouseout="this.style.background='var(--light-bg)'; this.style.borderColor='var(--text-color)'; this.style.color='var(--text-color)'"
                                onclick="window.toggleOnTimeCompletionPopup(event)"
                                >i</i
                            >

                            <!-- Floating Popup -->
                            <div id="onTimeCompletionPopup" class="info-popup">
                                <strong>On-time completion important</strong
                                ><br /><br />
                                When you mark a task as 'On-time completion
                                important', it indicates that the task has a
                                strict deadline and should be completed by the
                                specified due date/due time. Tasks with this
                                label will appear in the 'Overdue' section if
                                they are not completed on time, as completing
                                them by the due date/time is critical.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button type="submit" class="btn-save">SAVE</button>
                    <button
                        type="button"
                        class="btn-cancel"
                        onclick="handleCancel()"
                    >
                        CANCEL
                    </button>
                </div>
            </form>
        </div>

        <!-- Modals -->

        <div class="modal" id="roomModal">
            <div class="modal-content">
                <h3>Choose Rooms</h3>
                <ul id="roomList">
                    <li data-value="Entire Home">Entire Home</li>
                    <li data-value="Living Room">Living Room</li>
                    <li data-value="Bedroom">Bedroom</li>
                    <li data-value="Kitchen">Kitchen</li>
                    <li data-value="Bathroom">Bathroom</li>
                    <li data-value="Laundry">Laundry</li>
                    <li data-value="Garden">Garden</li>
                    <li data-value="Outside">Outside</li>
                    <li data-value="Other">Other</li>
                </ul>
                <button class="close-btn" id="closeRoomModal">Save</button>
            </div>
        </div>

        <div class="modal" id="repeatModal">
            <div class="modal-content">
                <h3>Choose Repeat</h3>
                <ul>
                    <li data-value="One Time">One Time</li>
                    <li data-value="Daily">Daily</li>
                    <li data-value="Weekly">Weekly</li>
                    <li data-value="Monthly">Monthly</li>
                    <li data-value="Occasional">Occasional</li>
                </ul>
            </div>
        </div>
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <h3>Choose Settings</h3>
                <ul>
                    <li data-value="Rotation">Rotation</li>
                    <li data-value="Team Work">Team Work</li>
                    <li data-value="Individual">Individual</li>
                </ul>
            </div>
        </div>

        <div class="modal" id="timesPerDayModal">
            <div class="modal-content fancy-modal">
                <h3>How many times per day?</h3>
                <div
                    style="
                        display: flex;
                        justify-content: center;
                        flex-wrap: wrap;
                        gap: 10px;
                        margin: 10px 0;
                    "
                >
                    <button class="btn-save" data-value="1">1</button>
                    <button class="btn-save" data-value="2">2</button>
                    <button class="btn-save" data-value="3">3</button>
                    <button class="btn-save" data-value="4">4</button>
                    <button class="btn-save" data-value="5">5</button>
                </div>
                <input
                    type="number"
                    id="customTimesInput"
                    placeholder="Or enter your own"
                    min="1"
                    class="fancy-input smaller-input"
                />
                <div class="button-row">
                    <button id="saveCustomTimesBtn" class="btn-save">
                        SAVE
                    </button>
                    <button class="btn-cancel" id="closeTimesModal">
                        CANCEL
                    </button>
                </div>
            </div>
        </div>

        <div class="modal" id="timesPerMonthModal">
            <div class="modal-content fancy-modal">
                <h3>How many times per month?</h3>
                <div
                    style="
                        display: flex;
                        justify-content: center;
                        flex-wrap: wrap;
                        gap: 10px;
                        margin: 10px 0;
                    "
                >
                    <button class="btn-save" data-value="1">1</button>
                    <button class="btn-save" data-value="2">2</button>
                    <button class="btn-save" data-value="3">3</button>
                    <button class="btn-save" data-value="4">4</button>
                    <button class="btn-save" data-value="5">5</button>
                </div>
                <input
                    type="number"
                    id="customTimesMonthInput"
                    placeholder="Or enter your own"
                    min="1"
                    class="fancy-input smaller-input"
                />
                <div class="button-row">
                    <button id="saveCustomTimesMonthBtn" class="btn-save">
                        SAVE
                    </button>
                    <button id="closeTimesMonthModal" class="btn-cancel">
                        CANCEL
                    </button>
                </div>
            </div>
        </div>

        <div class="modal" id="specificDatesModal">
            <div
                class="modal-content fancy-modal"
                style="
                    max-width: 380px;
                    padding: 30px 25px;
                    text-align: center;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                "
            >
                <h3
                    style="
                        margin: 0 0 15px 0;
                        font-size: 20px;
                        color: var(--text-color);
                    "
                >
                    Select Specific Dates
                </h3>
                <div
                    id="specificDatesWarningContainer"
                    style="margin-bottom: 15px; width: 100%"
                ></div>
                <div
                    id="specificDatesCalendar"
                    style="
                        margin: 0 0 30px 0;
                        display: flex;
                        justify-content: center;
                    "
                ></div>
                <div
                    style="
                        display: flex;
                        gap: 15px;
                        width: 280px;
                        margin: 0;
                        padding-top: 10px;
                    "
                >
                    <button
                        id="clearSpecificDates"
                        class="btn-cancel"
                        style="flex: 1; padding: 12px 16px; font-weight: 600"
                    >
                        CLEAR
                    </button>
                    <button
                        id="saveSpecificDates"
                        class="btn-save"
                        style="flex: 1; padding: 12px 16px; font-weight: 600"
                    >
                        SAVE
                    </button>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script src="/BeeMazing-A1/shared/avatar-system.js"></script>
        <script src="/BeeMazing-A1/shared/taskrotations.js?t=${Date.now()}"></script>
        <script>
                        // Cache buster: v1.0.3 - Fixed all syntax errors and global function access
                        // Global function definitions for HTML onclick handlers - MUST be in global scope
                        console.log("🔧 Script loading - defining global functions");

                        // Define functions both ways to ensure accessibility
                        function handleCancel() {
                            console.log("🔧 handleCancel called");
                            const urlParams = new URLSearchParams(window.location.search);
                            const from = urlParams.get("from");
                            const adminEmail = encodeURIComponent(
                                localStorage.getItem("currentAdminEmail") || "",
                            );
                            const originalUser =
                                urlParams.get("user") ||
                                localStorage.getItem("currentUser");

                            if (from === "onboarding") {
                                window.location.href = `/BeeMazing-A1/onboarding.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}#step4`;
                            } else if (originalUser) {
                                window.location.href = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}`;
                            } else {
                                window.location.href = `/BeeMazing-A1/index.html`;
                            }
                        }

                        function closeAddTask() {
                            console.log("🔧 closeAddTask called");
                            const urlParams = new URLSearchParams(window.location.search);
                            const adminEmail = encodeURIComponent(
                                localStorage.getItem("currentAdminEmail") || "",
                            );
                            const originalUser =
                                urlParams.get("user") ||
                                localStorage.getItem("currentUser");

                            if (originalUser) {
                                window.location.href = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}`;
                            } else {
                                window.location.href = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?admin=${adminEmail}`;
                            }
                        }

                        // Also assign to window object for additional accessibility
                        window.handleCancel = handleCancel;
                        window.closeAddTask = closeAddTask;

                        // Immediate verification
                        console.log("🔧 Function verification:", {
                            handleCancel: typeof handleCancel,
                            closeAddTask: typeof closeAddTask,
                            windowHandleCancel: typeof window.handleCancel,
                            windowCloseAddTask: typeof window.closeAddTask,
                        });

                        // Add manual debugging function for testing deletion
                        window.debugDeleteOccurrences = async function (
                            originalTitle,
                            dateRange,
                        ) {
                            console.log("🚨 MANUAL DELETION TEST STARTED! 🚨");
                            console.log(
                                "🔧 Testing deletion for:",
                                originalTitle,
                                "on date:",
                                dateRange,
                            );

                            const currentAdmin = localStorage.getItem("currentAdminEmail");
                            if (!currentAdmin) {
                                console.error("🔧 No admin email found!");
                                return;
                            }

                            try {
                                // Fetch all related tasks
                                const fetchResponse = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                                    { cache: "no-store" },
                                );
                                if (!fetchResponse.ok) {
                                    throw new Error("Failed to fetch tasks for deletion");
                                }

                                const result = await fetchResponse.json();
                                const relatedTasks = result.tasks.filter(
                                    (t) =>
                                        (t.originalTitle === originalTitle ||
                                            t.title.startsWith(originalTitle + " - ")) &&
                                        t.date === dateRange,
                                );

                                console.log(
                                    "🔧 Found related tasks to delete:",
                                    relatedTasks.length,
                                );
                                console.log(
                                    "🔧 Tasks to delete:",
                                    relatedTasks.map((t) => ({
                                        title: t.title,
                                        date: t.date,
                                    })),
                                );

                                if (relatedTasks.length === 0) {
                                    console.log("🔧 No tasks found to delete");
                                    return;
                                }

                                // Delete each task
                                let deletedCount = 0;
                                for (const relatedTask of relatedTasks) {
                                    try {
                                        const startDate = relatedTask.date.split(" to ")[0]; // Extract start date only
                                        const deleteUrl = `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&title=${encodeURIComponent(relatedTask.title)}&date=${encodeURIComponent(startDate)}`;
                                        console.log(
                                            "🔧 Deleting:",
                                            relatedTask.title,
                                            "with URL:",
                                            deleteUrl,
                                        );

                                        const deleteResponse = await fetch(deleteUrl, {
                                            method: "DELETE",
                                            headers: { "Content-Type": "application/json" },
                                        });

                                        if (deleteResponse.ok) {
                                            console.log(
                                                "🔧 Successfully deleted:",
                                                relatedTask.title,
                                            );
                                            deletedCount++;
                                        } else {
                                            const errorData = await deleteResponse
                                                .json()
                                                .catch(() => ({}));
                                            console.error(
                                                "🔧 Failed to delete:",
                                                relatedTask.title,
                                                "Status:",
                                                deleteResponse.status,
                                                "Error:",
                                                errorData,
                                            );
                                        }
                                    } catch (err) {
                                        console.error(
                                            "🔧 Exception deleting:",
                                            relatedTask.title,
                                            err,
                                        );
                                    }
                                }

                                console.log(
                                    `🔧 Deletion complete: ${deletedCount}/${relatedTasks.length} tasks deleted`,
                                );

                                // Verify deletion
                                console.log("🔧 Verifying deletion...");
                                const verifyResponse = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                                    { cache: "no-store" },
                                );
                                if (verifyResponse.ok) {
                                    const verifyResult = await verifyResponse.json();
                                    const remainingTasks = verifyResult.tasks.filter(
                                        (t) =>
                                            (t.originalTitle === originalTitle ||
                                                t.title.startsWith(
                                                    originalTitle + " - ",
                                                )) &&
                                            t.date === dateRange,
                                    );
                                    console.log(
                                        "🔧 Verification: remaining tasks after deletion:",
                                        remainingTasks.length,
                                    );
                                    if (remainingTasks.length > 0) {
                                        console.warn(
                                            "🔧 WARNING: Some tasks were not deleted:",
                                            remainingTasks.map((t) => t.title),
                                        );
                                    } else {
                                        console.log("🔧 SUCCESS: All tasks deleted!");
                                    }
                                }
                            } catch (error) {
                                console.error("🔧 Manual deletion test failed:", error);
                            }
                        };

                        // Add function to check current task status
                        window.debugTaskStatus = async function (titlePattern) {
                            console.log("🚨 TASK STATUS CHECK! 🚨");

                            const currentAdmin = localStorage.getItem("currentAdminEmail");
                            if (!currentAdmin) {
                                console.error("🔧 No admin email found!");
                                return;
                            }

                            try {
                                const response = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                                    { cache: "no-store" },
                                );
                                if (!response.ok) {
                                    throw new Error("Failed to fetch tasks");
                                }

                                const result = await response.json();
                                const matchingTasks = result.tasks.filter((t) =>
                                    t.title.includes(titlePattern || "Multiple"),
                                );

                                console.log(
                                    `🔧 Found ${matchingTasks.length} tasks matching "${titlePattern || "Multiple"}"`,
                                );
                                matchingTasks.forEach((task) => {
                                    console.log("🔧 Task:", {
                                        title: task.title,
                                        date: task.date,
                                        originalTitle: task.originalTitle,
                                        occurrence: task.occurrence,
                                        totalOccurrences: task.totalOccurrences,
                                        timesPerDay: task.timesPerDay,
                                    });
                                });

                                return matchingTasks;
                            } catch (error) {
                                console.error("🔧 Status check failed:", error);
                            }
                        };

                        console.log("🔧 Added debugging functions:");
                        console.log(
                            "  - window.debugDeleteOccurrences(originalTitle, dateRange)",
                        );
                        console.log("  - window.debugTaskStatus(titlePattern)");
                        console.log(
                            "  - window.debugAllTasks() - shows all tasks in database",
                        );

                        // Add debug function to check all tasks in database
                        window.debugAllTasks = async function () {
                            try {
                                const adminEmail =
                                    localStorage.getItem("currentAdminEmail");
                                const response = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                                    {
                                        cache: "no-store",
                                    },
                                );

                                if (!response.ok) {
                                    console.error(
                                        "Failed to fetch tasks:",
                                        response.status,
                                    );
                                    return;
                                }

                                const result = await response.json();
                                const tasks = result.tasks || [];

                                console.log(`📋 Total tasks in database: ${tasks.length}`);

                                // Filter tasks related to "1111"
                                const relatedTasks = tasks.filter(
                                    (t) =>
                                        t.title === "1111" ||
                                        t.originalTitle === "1111" ||
                                        t.title.includes("1111"),
                                );

                                console.log(
                                    `🔍 Tasks related to "1111": ${relatedTasks.length}`,
                                );

                                relatedTasks.forEach((task, index) => {
                                    console.log(
                                        `${index + 1}. "${task.title}" - Date: ${task.date} - Users: ${JSON.stringify(task.users)} - Occurrence: ${task.occurrence}`,
                                    );
                                });

                                // Show all future tasks (after June 14)
                                const futureTasks = tasks.filter((t) => {
                                    const taskStart = t.date.split(" to ")[0];
                                    return new Date(taskStart) >= new Date("2025-06-14");
                                });

                                console.log(
                                    `📅 All future tasks (from June 14): ${futureTasks.length}`,
                                );
                                futureTasks.forEach((task, index) => {
                                    console.log(
                                        `${index + 1}. "${task.title}" - Date: ${task.date}`,
                                    );
                                });

                                return {
                                    allTasks: tasks.length,
                                    relatedTasks: relatedTasks.length,
                                    futureTasks: futureTasks.length,
                                };
                            } catch (error) {
                                console.error("Error fetching tasks:", error);
                                return null;
                            }
                        };

                        let editTaskFullDate = null; // Initialize as null

                        // Global variables for edit modes (accessible to form handler)
                        let isOccurrenceEdit = false;
                        let isFutureEdit = false;
                        let targetDate = null;
                        let splitDate = null;
                        let originalStartDate = null;
                        let editTask = null;
                        let editTitle = null; // Add to global scope
                        let editDate = null; // Add to global scope

                        document.addEventListener("DOMContentLoaded", async () => {
                            console.log(
                                "🔧 DOMContentLoaded - Starting form initialization",
                            );
                            const currentAdmin = localStorage.getItem("currentAdminEmail");
                            if (!currentAdmin) {
                                alert("Admin not logged in!");
                                return;
                            }

                            // Initialize flatpickr early to ensure it's available
                            window.flatpickrSingle = flatpickr("#singleTaskDate", {
                                dateFormat: "Y-m-d",
                                defaultDate: "today",
                                onChange: function (selectedDates, dateStr) {
                                    document.getElementById(
                                        "singleDateDisplay",
                                    ).textContent = selectedDates[0]
                                        ? selectedDates[0].toLocaleDateString(undefined, {
                                              month: "long",
                                              day: "numeric",
                                          })
                                        : "Select Date";
                                },
                            });

                            document
                                .getElementById("singleDateDisplay")
                                .addEventListener("click", () => {
                                    window.flatpickrSingle.open();
                                });

                            // Debug function availability
                            console.log("🔧 Functions available:", {
                                handleCancel: typeof window.handleCancel,
                                closeAddTask: typeof window.closeAddTask,
                            });

                            // Check if in edit mode via URL parameters or localStorage
                            const urlParams = new URLSearchParams(window.location.search);
                            editTitle = urlParams.get("editTitle");
                            editDate = urlParams.get("editDate");

                            // Check for new editing modes from localStorage
                            const editTaskData = localStorage.getItem("familyApp_editTask");
                            const editTaskIndex = localStorage.getItem(
                                "familyApp_editTask_index",
                            );
                            editTask = null;
                            isOccurrenceEdit = false;
                            isFutureEdit = false;
                            targetDate = null;
                            splitDate = null;
                            originalStartDate = null;

                            if (editTaskData) {
                                console.log("🔧 Found edit task data in localStorage");
                                try {
                                    editTask = JSON.parse(editTaskData);
                                    console.log("🔧 Parsed edit task:", editTask);
                                    isOccurrenceEdit = editTask.isOccurrenceEdit || false;
                                    isFutureEdit = editTask.isFutureEdit || false;
                                    targetDate = editTask.targetDate || null;
                                    splitDate = editTask.splitDate || null;
                                    originalStartDate = editTask.originalStartDate || null;

                                    // Don't clear localStorage immediately - wait until form is populated
                                    console.log(
                                        "🔧 Edit task data loaded, will clear localStorage after form population",
                                    );
                                } catch (error) {
                                    console.error("Error parsing edit task data:", error);
                                }
                            } else if (editTitle && editDate) {
                                // Fetch all tasks from server and find the matching task
                                try {
                                    const response = await fetch(
                                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}`,
                                        {
                                            method: "GET",
                                            headers: { "Content-Type": "application/json" },
                                        },
                                    );
                                    const data = await response.json();
                                    if (response.ok && data.tasks) {
                                        // Find task by title and date (date matches start date of range)
                                        editTask = data.tasks.find(
                                            (task) =>
                                                task.title === editTitle &&
                                                task.date.startsWith(editDate),
                                        );
                                        if (!editTask) {
                                            console.error(
                                                `Task not found: title=${editTitle}, date=${editDate}`,
                                            );
                                        }
                                    } else {
                                        console.error(
                                            "Failed to fetch tasks:",
                                            data.error || "No tasks returned",
                                        );
                                    }
                                } catch (error) {
                                    console.error("Error fetching tasks:", error);
                                }
                            }

                            if (editTask) {
                                console.log("🔧 Starting form population with edit task");
                                console.log(
                                    "🔧 Edit task data:",
                                    JSON.stringify(editTask, null, 2),
                                );

                                // Update page title based on edit mode
                                const pageTitle = document.querySelector(".title");
                                if (editTask.isOccurrenceGroupEdit) {
                                    pageTitle.textContent = "Edit All Occurrences";
                                } else if (isFutureEdit) {
                                    pageTitle.textContent = "Edit Future Occurrences";
                                } else if (isOccurrenceEdit) {
                                    pageTitle.textContent = "Edit This Occurrence";
                                } else {
                                    pageTitle.textContent = "Edit Task";
                                }

                                // Set the full date range for the PUT request
                                editTaskFullDate = editTask.date; // Assign value here

                                // Populate form for editing - use original title if this is an occurrence task
                                const titleToEdit =
                                    editTask.originalTitle || editTask.title || "";
                                console.log("🔧 Populating title field with:", titleToEdit);
                                const titleField = document.getElementById("taskTitle");
                                if (titleField) {
                                    titleField.value = titleToEdit;
                                    console.log("🔧 Title field populated successfully");
                                } else {
                                    console.error("🔧 Title field not found!");
                                }

                                // Populate notes
                                const notesField = document.getElementById("taskNotes");
                                if (notesField) {
                                    notesField.value = editTask.notes || "";
                                    console.log(
                                        "🔧 Notes field populated:",
                                        editTask.notes,
                                    );
                                }

                                // Populate room
                                if (editTask.room) {
                                    selectedRooms = editTask.room
                                        .split(",")
                                        .map((r) => r.trim());
                                    const roomField =
                                        document.getElementById("roomSelection");
                                    const roomDisplay =
                                        document.getElementById("selectRoom");
                                    if (roomField)
                                        roomField.value = selectedRooms.join(", ");
                                    if (roomDisplay)
                                        roomDisplay.textContent = selectedRooms.join(", ");
                                    console.log("🔧 Room field populated:", selectedRooms);
                                }

                                // Populate repeat
                                const repeatField =
                                    document.getElementById("repeatSelection");
                                const repeatDisplay =
                                    document.getElementById("selectRepeat");
                                if (repeatField) {
                                    repeatField.value = editTask.repeat || "";
                                    console.log(
                                        "🔧 Repeat field populated:",
                                        editTask.repeat,
                                    );
                                }
                                if (repeatDisplay) {
                                    repeatDisplay.textContent = editTask.repeat || "Select";
                                }

                                // Populate settings
                                const settingsField =
                                    document.getElementById("settingsSelection");
                                const settingsDisplay =
                                    document.getElementById("selectSettings");
                                if (settingsField) {
                                    settingsField.value = editTask.settings || "";
                                    console.log(
                                        "🔧 Settings field populated:",
                                        editTask.settings,
                                    );
                                }
                                if (settingsDisplay) {
                                    settingsDisplay.textContent =
                                        editTask.settings || "Select";
                                }

                                // Handle rotation settings for edit mode
                                if (
                                    editTask.settings === "Rotation" &&
                                    editTask.repeat !== "One Time"
                                ) {
                                    document.getElementById(
                                        "fairRotationSection",
                                    ).style.display = "block";
                                    document.getElementById(
                                        "rotationOptions",
                                    ).style.display = "block";

                                    // Initialize rotation order from edit task
                                    if (editTask.rotationOrder) {
                                        rotationOrder = [...editTask.rotationOrder];
                                    } else if (editTask.users) {
                                        rotationOrder = [...editTask.users];
                                    }

                                    if (editTask.rotationSettings) {
                                        const rotationSettings = editTask.rotationSettings;

                                        if (rotationSettings.type === "occurrences") {
                                            document.getElementById(
                                                "rotateOccurrences",
                                            ).checked = true;
                                            document.getElementById(
                                                "occurrencesValue",
                                            ).value = rotationSettings.value || 1;
                                        } else if (rotationSettings.type === "time") {
                                            document.getElementById("rotateTime").checked =
                                                true;
                                            document.getElementById("timeValue").value =
                                                rotationSettings.value || 1;
                                            document.getElementById("timeUnit").value =
                                                rotationSettings.unit || "days";
                                        } else if (rotationSettings.type === "completion") {
                                            document.getElementById(
                                                "rotateCompletion",
                                            ).checked = true;
                                        }
                                    }
                                } else {
                                    document.getElementById(
                                        "fairRotationSection",
                                    ).style.display = "none";
                                    document.getElementById(
                                        "rotationOptions",
                                    ).style.display = "none";
                                    rotationOrder = [];

                                    // If this is a One Time task with Rotation setting, change to Individual
                                    if (
                                        editTask.settings === "Rotation" &&
                                        editTask.repeat === "One Time"
                                    ) {
                                        document.getElementById("settingsSelection").value =
                                            "Individual";
                                        document.getElementById(
                                            "selectSettings",
                                        ).textContent = "Individual";
                                    }
                                }
                                // COMMENTED OUT - REMINDERS
                                // document.getElementById("taskReminder").checked = !!editTask.reminder;
                                // document.getElementById("addAlarmBtn").style.display = editTask.reminder ? "inline-block" : "none";

                                // Due Time functionality - enhanced with better detection
                                const hasDueTimes =
                                    (editTask.dueTimes &&
                                        (Array.isArray(editTask.dueTimes)
                                            ? editTask.dueTimes.length > 0
                                            : true)) ||
                                    editTask.dueTime ||
                                    editTask.time;

                                console.log("🔧 Due time detection:", {
                                    dueTimes: editTask.dueTimes,
                                    dueTime: editTask.dueTime,
                                    time: editTask.time,
                                    hasDueTimes: hasDueTimes,
                                });

                                document.getElementById("dueTimeToggle").checked =
                                    !!hasDueTimes;
                                document.getElementById("dueTimeContainer").style.display =
                                    hasDueTimes ? "block" : "none";
                                document.getElementById("RewardValue").value =
                                    editTask.reward || "10";
                                document.getElementById("buzzpointsToggle").checked =
                                    editTask.reward !== undefined && editTask.reward !== "";
                                document.getElementById(
                                    "buzzpointsInputContainer",
                                ).style.display =
                                    editTask.reward !== undefined && editTask.reward !== ""
                                        ? "flex"
                                        : "none";
                                document.getElementById("fairRotationToggle").checked =
                                    editTask.fairRotation || false;
                                document.getElementById(
                                    "fairRotationTimeBasedToggle",
                                ).checked = editTask.fairRotationTimeBased || false;
                                document.getElementById(
                                    "fairRotationAdvanced",
                                ).style.display = editTask.fairRotation ? "block" : "none";
                                document.getElementById("parentApprovalToggle").checked =
                                    editTask.parentApproval !== undefined
                                        ? editTask.parentApproval
                                        : true;
                                document.getElementById("onTimeCompletionToggle").checked =
                                    editTask.onTimeCompletion || false;

                                // Handle times per day/week/month - adjust for occurrence tasks
                                const timesPerDayValue =
                                    editTask.totalOccurrences ||
                                    editTask.timesPerDay ||
                                    "1";
                                console.log(
                                    "🔧 Setting timesPerDay input to:",
                                    timesPerDayValue,
                                    "from editTask:",
                                    {
                                        totalOccurrences: editTask.totalOccurrences,
                                        timesPerDay: editTask.timesPerDay,
                                    },
                                );
                                document.getElementById("timesPerDayInput").value =
                                    timesPerDayValue;
                                document.getElementById("timesPerWeekInput").value =
                                    editTask.timesPerWeek || "1";
                                document.getElementById("timesPerMonthInput").value =
                                    editTask.timesPerMonth || "1";
                                document.getElementById("monthIntervalInput").value =
                                    editTask.monthInterval || "1";

                                // Hide Select Dates button when editing
                                document.getElementById(
                                    "defaultDateSelector",
                                ).style.display = "none";

                                // Handle monthly option selection
                                if (editTask.monthlyOption === "interval") {
                                    const intervalRadio = document.querySelector(
                                        'input[name="monthlyOption"][value="interval"]',
                                    );
                                    intervalRadio.checked = true;
                                    intervalRadio.dispatchEvent(new Event("change"));
                                } else {
                                    const timesRadio = document.querySelector(
                                        'input[name="monthlyOption"][value="times"]',
                                    );
                                    timesRadio.checked = true;
                                    timesRadio.dispatchEvent(new Event("change"));

                                    // Handle monthly times scheduling data
                                    if (
                                        editTask.repeat === "Monthly" &&
                                        editTask.monthlyOption === "times"
                                    ) {
                                        // Set monthly dates
                                        const [from, to] = editTask.date.split(" to ");
                                        document.getElementById("monthlyTaskDate").value =
                                            from || "";
                                        if (typeof flatpickrMonthlyFrom !== "undefined") {
                                            flatpickrMonthlyFrom.setDate(from);
                                        }
                                        document.getElementById(
                                            "monthlyDateDisplay",
                                        ).textContent = new Date(from).toLocaleDateString(
                                            undefined,
                                            {
                                                month: "long",
                                                day: "numeric",
                                            },
                                        );

                                        if (to && to !== "3000-01-01") {
                                            document.getElementById(
                                                "monthlyTaskDateTo",
                                            ).value = to;
                                            if (typeof flatpickrMonthlyTo !== "undefined") {
                                                flatpickrMonthlyTo.setDate(to);
                                            }
                                            document.getElementById(
                                                "monthlyDateDisplayTo",
                                            ).textContent = new Date(to).toLocaleDateString(
                                                undefined,
                                                {
                                                    month: "long",
                                                    day: "numeric",
                                                },
                                            );
                                            document.getElementById(
                                                "monthlyDateToWrapper",
                                            ).style.display = "inline";
                                            document.getElementById(
                                                "monthlyDateDisplayTo",
                                            ).style.display = "inline-block";
                                            document.getElementById(
                                                "removeMonthlyEndDateBtn",
                                            ).style.display = "inline-block";
                                            document.getElementById(
                                                "addMonthlyEndDateBtn",
                                            ).style.display = "none";
                                        }

                                        // Handle monthly scheduling type
                                        if (
                                            editTask.monthlySchedulingType ===
                                                "daysOfMonth" &&
                                            editTask.monthlyDaysOfMonth
                                        ) {
                                            document.getElementById(
                                                "specificDaysOfMonthCheckbox",
                                            ).checked = true;
                                            document.getElementById(
                                                "daysOfMonthFields",
                                            ).style.display = "flex";
                                            setTimeout(() => {
                                                const daysData =
                                                    editTask.monthlyDaysOfMonth.split(",");
                                                const selects = document.querySelectorAll(
                                                    ".day-of-month-select",
                                                );
                                                selects.forEach((select, index) => {
                                                    if (daysData[index]) {
                                                        select.value = daysData[index];
                                                    }
                                                });
                                            }, 100);
                                        } else if (
                                            editTask.monthlySchedulingType ===
                                                "daysOfWeek" &&
                                            editTask.monthlyDaysOfWeek
                                        ) {
                                            document.getElementById(
                                                "specificDaysOfWeekCheckbox",
                                            ).checked = true;
                                            document.getElementById(
                                                "daysOfWeekFields",
                                            ).style.display = "flex";
                                            setTimeout(() => {
                                                const weeksData =
                                                    editTask.monthlyDaysOfWeek.split(",");
                                                const occurrenceSelects =
                                                    document.querySelectorAll(
                                                        ".week-occurrence-select",
                                                    );
                                                const weekdaySelects =
                                                    document.querySelectorAll(
                                                        ".weekday-select",
                                                    );
                                                weeksData.forEach((weekData, index) => {
                                                    const [occurrence, weekday] =
                                                        weekData.split(":");
                                                    if (
                                                        occurrenceSelects[index] &&
                                                        weekdaySelects[index]
                                                    ) {
                                                        occurrenceSelects[index].value =
                                                            occurrence;
                                                        weekdaySelects[index].value =
                                                            weekday;
                                                    }
                                                });
                                            }, 100);
                                        }
                                    }
                                }
                                // Show/hide frequency-specific fields
                                const timesPerDayGroup =
                                    document.getElementById("timesPerDayGroup");
                                const timesPerWeekGroup =
                                    document.getElementById("timesPerWeekGroup");
                                const timesPerMonthGroup =
                                    document.getElementById("timesPerMonthGroup");

                                if (timesPerDayGroup)
                                    timesPerDayGroup.style.display =
                                        editTask.repeat === "Daily" ? "flex" : "none";
                                if (timesPerWeekGroup)
                                    timesPerWeekGroup.style.display =
                                        editTask.repeat === "Weekly" ? "flex" : "none";
                                if (timesPerMonthGroup)
                                    timesPerMonthGroup.style.display =
                                        editTask.repeat === "Monthly" ? "flex" : "none";

                                console.log("🔧 Form population completed successfully");

                                // Clear localStorage after successful form population
                                setTimeout(() => {
                                    localStorage.removeItem("familyApp_editTask");
                                    localStorage.removeItem("familyApp_editTask_index");
                                    console.log(
                                        "🔧 localStorage cleared after form population",
                                    );
                                }, 100);

                                // Update section label and Any/All button based on frequency
                                const sectionLabel =
                                    document.getElementById("sectionLabel");
                                const anyAllButton =
                                    document.getElementById("anyAllButton");
                                if (sectionLabel && anyAllButton) {
                                    if (editTask.repeat === "Daily") {
                                        sectionLabel.textContent = "Days";
                                        anyAllButton.textContent = "All";
                                        anyAllButton.setAttribute("data-day", "All");
                                    } else {
                                        sectionLabel.textContent = "Dates";
                                        anyAllButton.textContent = "Any";
                                        anyAllButton.setAttribute("data-day", "Any");
                                    }
                                }

                                // Handle date mode (skip for monthly times option)
                                if (
                                    editTask.repeat === "Monthly" &&
                                    editTask.monthlyOption === "times"
                                ) {
                                    // Monthly times date handling is done above, skip regular date mode handling
                                } else if (editTask.specificDates) {
                                    // Show appropriate date UI for editing
                                    document.getElementById(
                                        "generalDateModeSelector",
                                    ).style.display = "flex";
                                    document.getElementById("dateModeSelection").value =
                                        "specific-dates";
                                    document
                                        .querySelectorAll(".mode-btn")
                                        .forEach((btn) => btn.classList.remove("active"));
                                    document
                                        .querySelector(
                                            ".mode-btn[data-mode='specific-dates']",
                                        )
                                        .classList.add("active");
                                    document.getElementById(
                                        "specificDatesGroup",
                                    ).style.display = "block";
                                    document.getElementById(
                                        "fromToDateGroup",
                                    ).style.display = "none";
                                    document.getElementById(
                                        "specificDaysGroup",
                                    ).style.display = "none";
                                    selectedDates = editTask.specificDates
                                        .split(",")
                                        .map((date) => new Date(date));
                                    specificDatesInput.value = editTask.specificDates;
                                    flatpickrSpecific.setDate(selectedDates);
                                    updateSelectedDatesDisplay();
                                } else if (editTask.date) {
                                    if (editTask.repeat === "One Time") {
                                        document.getElementById(
                                            "singleDateGroup",
                                        ).style.display = "block";
                                        document.getElementById(
                                            "fromToDateGroup",
                                        ).style.display = "none";
                                        document.getElementById(
                                            "specificDaysGroup",
                                        ).style.display = "none";
                                        document.getElementById(
                                            "generalDateModeSelector",
                                        ).style.display = "none";

                                        const [from] = editTask.date.split(" to ");
                                        document.getElementById("singleTaskDate").value =
                                            from || "";
                                        window.flatpickrSingle.setDate(from);

                                        // Update the display text manually since programmatic setDate might not trigger onChange
                                        if (from) {
                                            // Use retry logic for flatpickr initialization
                                            const updateSingleDateDisplay = (
                                                attempt = 0,
                                            ) => {
                                                if (attempt > 5) {
                                                    console.warn(
                                                        "🔧 Failed to update single date display after 5 attempts",
                                                    );
                                                    return;
                                                }

                                                try {
                                                    if (
                                                        window.flatpickrSingle &&
                                                        typeof window.flatpickrSingle
                                                            .setDate === "function"
                                                    ) {
                                                        window.flatpickrSingle.setDate(
                                                            from,
                                                        );
                                                        console.log(
                                                            "🔧 flatpickrSingle date set successfully",
                                                        );
                                                    } else {
                                                        console.log(
                                                            `🔧 Retrying single date update (attempt ${attempt + 1})`,
                                                        );
                                                        setTimeout(
                                                            () =>
                                                                updateSingleDateDisplay(
                                                                    attempt + 1,
                                                                ),
                                                            200,
                                                        );
                                                        return;
                                                    }
                                                } catch (error) {
                                                    console.error(
                                                        "🔧 Error updating single date:",
                                                        error,
                                                    );
                                                    setTimeout(
                                                        () =>
                                                            updateSingleDateDisplay(
                                                                attempt + 1,
                                                            ),
                                                        200,
                                                    );
                                                    return;
                                                }

                                                document.getElementById(
                                                    "singleDateDisplay",
                                                ).textContent = new Date(
                                                    from,
                                                ).toLocaleDateString(undefined, {
                                                    month: "long",
                                                    day: "numeric",
                                                });
                                                console.log(
                                                    "🔧 Single date display updated successfully",
                                                );
                                            };

                                            updateSingleDateDisplay();
                                        }
                                    } else {
                                        document.getElementById("dateModeSelection").value =
                                            "date";
                                        document
                                            .querySelectorAll(".mode-btn")
                                            .forEach((btn) =>
                                                btn.classList.remove("active"),
                                            );
                                        document
                                            .querySelector(".mode-btn[data-mode='date']")
                                            .classList.add("active");
                                        document.getElementById(
                                            "fromToDateGroup",
                                        ).style.display = "block";
                                        document.getElementById(
                                            "specificDatesGroup",
                                        ).style.display = "none";
                                        document.getElementById(
                                            "specificDaysGroup",
                                        ).style.display = "block";
                                        document.getElementById(
                                            "generalDateModeSelector",
                                        ).style.display = "flex";

                                        const [from, to] = editTask.date.split(" to ");
                                        document.getElementById("taskDate").value =
                                            from || "";

                                        // Enhanced date setting with retry logic for flatpickr
                                        const updateRecurringDates = (attempt = 0) => {
                                            if (attempt > 5) {
                                                console.warn(
                                                    "🔧 Failed to update recurring dates after 5 attempts",
                                                );
                                                return;
                                            }

                                            try {
                                                // Update from date
                                                if (
                                                    flatpickrFrom &&
                                                    typeof flatpickrFrom.setDate ===
                                                        "function"
                                                ) {
                                                    flatpickrFrom.setDate(from);
                                                    console.log(
                                                        "🔧 flatpickrFrom date set successfully",
                                                    );

                                                    document.getElementById(
                                                        "dateDisplay",
                                                    ).textContent = new Date(
                                                        from,
                                                    ).toLocaleDateString(undefined, {
                                                        month: "long",
                                                        day: "numeric",
                                                    });
                                                } else {
                                                    console.log(
                                                        `🔧 Retrying recurring date update (attempt ${attempt + 1})`,
                                                    );
                                                    setTimeout(
                                                        () =>
                                                            updateRecurringDates(
                                                                attempt + 1,
                                                            ),
                                                        200,
                                                    );
                                                    return;
                                                }

                                                // Handle to date
                                                if (to && to !== "3000-01-01") {
                                                    document.getElementById(
                                                        "taskDateTo",
                                                    ).value = to;

                                                    if (
                                                        flatpickrTo &&
                                                        typeof flatpickrTo.setDate ===
                                                            "function"
                                                    ) {
                                                        flatpickrTo.setDate(to);
                                                        console.log(
                                                            "🔧 flatpickrTo date set successfully",
                                                        );
                                                    }

                                                    document.getElementById(
                                                        "dateDisplayTo",
                                                    ).textContent = new Date(
                                                        to,
                                                    ).toLocaleDateString(undefined, {
                                                        month: "long",
                                                        day: "numeric",
                                                    });
                                                    document.getElementById(
                                                        "dateToWrapper",
                                                    ).style.display = "inline";
                                                    document.getElementById(
                                                        "dateDisplayTo",
                                                    ).style.display = "inline-block";
                                                    document.getElementById(
                                                        "removeEndDateBtn",
                                                    ).style.display = "inline-block";
                                                    addEndDateBtn.style.display = "none";
                                                    dateMode = "from-to";
                                                } else {
                                                    document.getElementById(
                                                        "taskDateTo",
                                                    ).value = "";
                                                    document.getElementById(
                                                        "dateDisplayTo",
                                                    ).textContent = "To Date";
                                                    document.getElementById(
                                                        "dateToWrapper",
                                                    ).style.display = "none";
                                                    document.getElementById(
                                                        "dateDisplayTo",
                                                    ).style.display = "none";
                                                    document.getElementById(
                                                        "removeEndDateBtn",
                                                    ).style.display = "none";
                                                    addEndDateBtn.style.display =
                                                        "inline-block";
                                                    dateMode = "from";
                                                }

                                                console.log(
                                                    "🔧 Recurring dates updated successfully",
                                                );
                                            } catch (error) {
                                                console.error(
                                                    "🔧 Error updating recurring dates:",
                                                    error,
                                                );
                                                setTimeout(
                                                    () => updateRecurringDates(attempt + 1),
                                                    200,
                                                );
                                            }
                                        };

                                        updateRecurringDates();
                                    }

                                    // Handle days of week for edit mode (not for monthly times)
                                    if (
                                        !(
                                            editTask.repeat === "Monthly" &&
                                            editTask.monthlyOption === "times"
                                        )
                                    ) {
                                        selectedDays =
                                            editTask.daysOfWeek ||
                                            (editTask.repeat === "Daily"
                                                ? ["All"]
                                                : ["Any"]);
                                        updateSelectedDaysDisplay();
                                    }

                                    // Update settings modal for edit mode
                                    setTimeout(() => updateSettingsModal(), 100);
                                }

                                // Special handling for single occurrence and future edits
                                if (isOccurrenceEdit && targetDate) {
                                    // For single occurrence edit, set the date to the target date and disable date changes
                                    document.getElementById("dateModeSelection").value =
                                        "date";
                                    document.getElementById("taskDate").value = targetDate;

                                    // Enhanced occurrence date setting with retry logic
                                    const updateOccurrenceDate = (attempt = 0) => {
                                        if (attempt > 3) {
                                            console.warn(
                                                "🔧 Failed to update occurrence date after 3 attempts",
                                            );
                                            return;
                                        }

                                        try {
                                            if (
                                                flatpickrFrom &&
                                                typeof flatpickrFrom.setDate === "function"
                                            ) {
                                                flatpickrFrom.setDate(targetDate);
                                                console.log(
                                                    "🔧 Occurrence date set successfully",
                                                );
                                            } else {
                                                setTimeout(
                                                    () => updateOccurrenceDate(attempt + 1),
                                                    200,
                                                );
                                                return;
                                            }
                                        } catch (error) {
                                            console.error(
                                                "🔧 Error setting occurrence date:",
                                                error,
                                            );
                                            setTimeout(
                                                () => updateOccurrenceDate(attempt + 1),
                                                200,
                                            );
                                            return;
                                        }

                                        document.getElementById("dateDisplay").textContent =
                                            new Date(targetDate).toLocaleDateString(
                                                undefined,
                                                {
                                                    month: "long",
                                                    day: "numeric",
                                                },
                                            );
                                    };

                                    updateOccurrenceDate();
                                    // Hide end date for single occurrence and disable date inputs
                                    document.getElementById("taskDateTo").value = "";
                                    dateToWrapper.style.display = "none";
                                    addEndDateBtn.style.display = "none";

                                    // Disable date changes for single occurrence
                                    document.getElementById("taskDate").disabled = true;
                                    document.getElementById("dateModeSelection").disabled =
                                        true;
                                    if (flatpickrFrom) flatpickrFrom.destroy();

                                    // Add notice
                                    const form = document.getElementById("addTaskForm");
                                    const notice = document.createElement("div");
                                    notice.style.background = "#ffeb3b";
                                    notice.style.color = "#333";
                                    notice.style.padding = "10px";
                                    notice.style.borderRadius = "8px";
                                    notice.style.marginBottom = "15px";
                                    notice.style.fontWeight = "bold";
                                    notice.innerHTML = `📅 Editing single occurrence for ${new Date(targetDate).toLocaleDateString()} - Date cannot be changed`;
                                    form.insertBefore(notice, form.firstChild);
                                } else if (isFutureEdit && splitDate) {
                                    // For future edit, set the date from split date onwards
                                    document.getElementById("dateModeSelection").value =
                                        "date";
                                    document.getElementById("taskDate").value = splitDate;

                                    // Enhanced future edit date setting with retry logic
                                    const updateFutureDate = (attempt = 0) => {
                                        if (attempt > 3) {
                                            console.warn(
                                                "🔧 Failed to update future edit date after 3 attempts",
                                            );
                                            return;
                                        }

                                        try {
                                            if (
                                                flatpickrFrom &&
                                                typeof flatpickrFrom.setDate === "function"
                                            ) {
                                                flatpickrFrom.setDate(splitDate);
                                                console.log(
                                                    "🔧 Future edit date set successfully",
                                                );
                                            } else {
                                                setTimeout(
                                                    () => updateFutureDate(attempt + 1),
                                                    200,
                                                );
                                                return;
                                            }
                                        } catch (error) {
                                            console.error(
                                                "🔧 Error setting future edit date:",
                                                error,
                                            );
                                            setTimeout(
                                                () => updateFutureDate(attempt + 1),
                                                200,
                                            );
                                            return;
                                        }

                                        document.getElementById("dateDisplay").textContent =
                                            new Date(splitDate).toLocaleDateString(
                                                undefined,
                                                {
                                                    month: "long",
                                                    day: "numeric",
                                                },
                                            );
                                    };

                                    updateFutureDate();

                                    // Keep original end date if it exists
                                    const originalRange = editTask.date.split(" to ");
                                    const originalEnd = originalRange[1];
                                    if (originalEnd && originalEnd !== "3000-01-01") {
                                        document.getElementById("taskDateTo").value =
                                            originalEnd;
                                        flatpickrTo.setDate(originalEnd);
                                        document.getElementById(
                                            "dateDisplayTo",
                                        ).textContent = new Date(
                                            originalEnd,
                                        ).toLocaleDateString(undefined, {
                                            month: "long",
                                            day: "numeric",
                                        });
                                        document.getElementById(
                                            "dateToWrapper",
                                        ).style.display = "inline";
                                        document.getElementById(
                                            "dateDisplayTo",
                                        ).style.display = "inline-block";
                                        document.getElementById(
                                            "removeEndDateBtn",
                                        ).style.display = "inline-block";
                                        addEndDateBtn.style.display = "none";
                                    }

                                    // Add notice
                                    const form = document.getElementById("addTaskForm");
                                    const notice = document.createElement("div");
                                    notice.style.background = "#2196f3";
                                    notice.style.color = "white";
                                    notice.style.padding = "10px";
                                    notice.style.borderRadius = "8px";
                                    notice.style.marginBottom = "15px";
                                    notice.style.fontWeight = "bold";
                                    notice.innerHTML = `🔄 Editing from ${new Date(splitDate).toLocaleDateString()} onwards - Start date locked`;
                                    form.insertBefore(notice, form.firstChild);

                                    // Disable start date changes for future edit
                                    document.getElementById("taskDate").disabled = true;
                                }

                                if (editTask.users) {
                                    selectedUsers = [...editTask.users]
                                        .map((u) => u.trim())
                                        .filter((u) => u);
                                    // First populate users to render avatars, then update display
                                    await populateUsers();
                                    updateSelectedUsersDisplay();
                                }

                                // COMMENTED OUT - ALARMS
                                /*
                    if (editTask.alarms?.length) {
                        alarms = [...editTask.alarms];
                        alarms.forEach((time) => {
                            const alarmWrapper = document.createElement("div");
                            alarmWrapper.style.marginBottom = "10px";
                            alarmWrapper.style.display = "flex";
                            alarmWrapper.style.alignItems = "center";
                            const alarmInput = document.createElement("input");
                            alarmInput.type = "time";
                            alarmInput.value = time;
                            alarmInput.style.marginRight = "10px";
                            alarmInput.style.padding = "10px";
                            alarmInput.style.border = "2px solid var(--primary-color)";
                            alarmInput.style.borderRadius = "8px";
                            alarmInput.style.background = "var(--accent-color)";
                            const removeButton = document.createElement("button");
                            removeButton.textContent = "Remove";
                            removeButton.style.padding = "5px 10px";
                            removeButton.style.marginLeft = "10px";
                            removeButton.addEventListener("click", () => {
                                alarmWrapper.remove();
                                alarms = alarms.filter((a) => a !== time);
                            });
                            alarmWrapper.appendChild(alarmInput);
                            alarmWrapper.appendChild(removeButton);
                            alarmContainer.appendChild(alarmWrapper);
                        });
                    }
                    */

                                // Due Time functionality for edit mode - enhanced with retry logic
                                console.log(
                                    "🔧 Processing due times for edit mode:",
                                    editTask.dueTimes,
                                );

                                let dueTimesToSet = [];

                                // Check for due times in various formats
                                if (editTask.dueTimes && Array.isArray(editTask.dueTimes)) {
                                    dueTimesToSet = editTask.dueTimes.filter(
                                        (time) => time && time.trim() !== "",
                                    );
                                } else if (editTask.dueTime) {
                                    dueTimesToSet = [editTask.dueTime];
                                } else if (editTask.time) {
                                    dueTimesToSet = [editTask.time];
                                }

                                if (dueTimesToSet.length > 0) {
                                    console.log("🔧 Setting due times:", dueTimesToSet);
                                    dueTimes = [...dueTimesToSet];

                                    // Use timeout to ensure DOM is ready
                                    setTimeout(() => {
                                        try {
                                            updateDueTimeDisplay();
                                            console.log(
                                                "🔧 updateDueTimeDisplay called successfully",
                                            );

                                            // Verify and populate inputs after display update
                                            setTimeout(() => {
                                                const timeInputs =
                                                    document.querySelectorAll(
                                                        '#dueTimeContainer input[type="time"]',
                                                    );
                                                console.log(
                                                    "🔧 Found time inputs:",
                                                    timeInputs.length,
                                                );

                                                timeInputs.forEach((input, index) => {
                                                    if (dueTimesToSet[index]) {
                                                        input.value = dueTimesToSet[index];
                                                        console.log(
                                                            `🔧 Set time input ${index} to:`,
                                                            dueTimesToSet[index],
                                                        );
                                                    }
                                                });
                                            }, 100);
                                        } catch (error) {
                                            console.error(
                                                "🔧 Error in updateDueTimeDisplay:",
                                                error,
                                            );
                                        }
                                    }, 200);
                                }
                            } else {
                                // Initialize form for new task
                                populateUsers();

                                // Hide all date-related UI by default, show only Select Dates button
                                document.getElementById(
                                    "defaultDateSelector",
                                ).style.display = "block";
                                document.getElementById(
                                    "generalDateModeSelector",
                                ).style.display = "none";
                                document.getElementById("fromToDateGroup").style.display =
                                    "none";
                                document.getElementById(
                                    "specificDatesGroup",
                                ).style.display = "none";
                                document.getElementById("specificDaysGroup").style.display =
                                    "none";
                                document.getElementById("singleDateGroup").style.display =
                                    "none";
                                document.getElementById(
                                    "timesPerMonthGroup",
                                ).style.display = "none";
                                document
                                    .getElementById("monthlyTimesDateGroup")
                                    .style.setProperty("display", "none", "important");
                                document
                                    .getElementById("monthlySchedulingOptions")
                                    .style.setProperty("display", "none", "important");

                                // Update settings modal for new tasks
                                setTimeout(() => updateSettingsModal(), 100);
                            }
                        });

                        // Global modal functions - moved outside DOMContentLoaded scope
                        function showModal(modal) {
                            modal.classList.remove("hide");
                            modal.classList.add("show");
                            modal.style.display = "flex";
                        }

                        // Hide modal with smooth transition
                        function hideModal(modal) {
                            modal.classList.remove("show");
                            modal.classList.add("hide");
                            setTimeout(() => {
                                modal.style.display = "none";
                            }, 300);
                        }

                        function setupTimesModal(
                            inputEl,
                            modalEl,
                            closeBtnEl,
                            customInputEl,
                            saveBtnEl,
                        ) {
                            // Open modal on focus
                            inputEl.addEventListener("focus", () => {
                                customInputEl.value = "";
                                showModal(modalEl);
                            });

                            // Setup quick select buttons
                            modalEl
                                .querySelectorAll("button[data-value]")
                                .forEach((btn) => {
                                    btn.addEventListener("click", () => {
                                        inputEl.value = btn.getAttribute("data-value");
                                        hideModal(modalEl);
                                    });
                                });

                            // Save custom value
                            saveBtnEl.addEventListener("click", () => {
                                let val = parseInt(customInputEl.value.trim());
                                if (val && val > 0) {
                                    val = Math.min(val, 100);
                                    inputEl.value = val;
                                    hideModal(modalEl);
                                }
                            });

                            // Close modal
                            closeBtnEl.addEventListener("click", () => {
                                hideModal(modalEl);
                            });
                        }

                        // User Avatar Selection Logic
                        const assignedToSelection = document.getElementById(
                            "assignedToSelection",
                        );

                        let selectedUsers = [];
                        let rotationOrder = []; // Track order of selection for rotation

                        async function populateUsers() {
                            const currentAdmin = localStorage.getItem("currentAdminEmail");
                            if (!currentAdmin) {
                                console.error("No admin email found in localStorage");
                                return;
                            }

                            try {
                                const response = await fetch(
                                    `https://beemazing1.onrender.com/get-users?adminEmail=${encodeURIComponent(currentAdmin)}`,
                                    {
                                        method: "GET",
                                        headers: { "Content-Type": "application/json" },
                                    },
                                );

                                const data = await response.json();
                                console.log("Fetched users:", data); // Debug log

                                if (!response.ok || !data.success) {
                                    throw new Error(
                                        data.message || `HTTP ${response.status}`,
                                    );
                                }

                                const { users = [], permissions = {} } = data;

                                // Store users globally for other functions
                                window.allUsers = users;

                                // Update localStorage to sync with backend
                                const allUserData = JSON.parse(
                                    localStorage.getItem("userData") || "{}",
                                );
                                allUserData[currentAdmin] = allUserData[currentAdmin] || {
                                    users: [],
                                    permissions: {},
                                };
                                allUserData[currentAdmin].users = users;
                                allUserData[currentAdmin].permissions = permissions;
                                localStorage.setItem(
                                    "userData",
                                    JSON.stringify(allUserData),
                                );

                                // Get avatar container
                                const userAvatarList =
                                    document.getElementById("userAvatarList");
                                userAvatarList.innerHTML = "";

                                // Initialize avatar system if not already done
                                if (typeof window.avatarSystem === "undefined") {
                                    window.avatarSystem = new AvatarSystem();
                                    await window.avatarSystem.initialize();
                                }

                                // Create "All" avatar button first
                                const allAvatarContainer = document.createElement("div");
                                allAvatarContainer.style.position = "relative";
                                allAvatarContainer.style.cursor = "pointer";
                                allAvatarContainer.id = "allUsersBtn";

                                // Create All avatar with consistent styling
                                const allAvatar = document.createElement("div");
                                allAvatar.className = "user-avatar medium";
                                allAvatar.style.background = "var(--primary-color)";
                                allAvatar.style.color = "var(--secondary-color)";
                                allAvatar.style.fontSize = "14px";
                                allAvatar.style.fontWeight = "bold";
                                allAvatar.style.width = "40px";
                                allAvatar.style.height = "40px";
                                allAvatar.style.borderRadius = "50%";
                                allAvatar.style.display = "flex";
                                allAvatar.style.alignItems = "center";
                                allAvatar.style.justifyContent = "center";
                                allAvatar.style.border =
                                    "2px solid rgba(255, 255, 255, 0.2)";
                                allAvatar.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
                                allAvatar.textContent = "All";
                                allAvatar.title = "Select all users";
                                allAvatar.style.transition = "all 0.3s ease";

                                allAvatarContainer.appendChild(allAvatar);

                                // All button click handler
                                allAvatarContainer.addEventListener("click", () => {
                                    const currentSettings =
                                        document.getElementById("settingsSelection").value;

                                    if (allAvatarContainer.classList.contains("active")) {
                                        // Deselect All
                                        allAvatarContainer.classList.remove("active");
                                        selectedUsers = [];
                                        if (currentSettings === "Rotation") {
                                            rotationOrder = [];
                                        }
                                    } else {
                                        // Select All
                                        allAvatarContainer.classList.add("active");
                                        selectedUsers = window.allUsers
                                            ? [...window.allUsers]
                                            : [];
                                        if (currentSettings === "Rotation") {
                                            rotationOrder = window.allUsers
                                                ? [...window.allUsers]
                                                : [];
                                        }
                                    }
                                    updateSelectedUsersDisplay();
                                });

                                // Hover effects for All button
                                allAvatarContainer.addEventListener("mouseenter", () => {
                                    allAvatar.style.transform = "scale(1.1)";
                                });

                                allAvatarContainer.addEventListener("mouseleave", () => {
                                    allAvatar.style.transform = "scale(1)";
                                });

                                userAvatarList.appendChild(allAvatarContainer);

                                // Populate user avatars
                                users.forEach((user, index) => {
                                    const avatarContainer = document.createElement("div");
                                    avatarContainer.style.position = "relative";
                                    avatarContainer.style.cursor = "pointer";

                                    // Generate avatar HTML
                                    const avatarHTML =
                                        window.avatarSystem.generateAvatarHTML(
                                            user,
                                            "medium",
                                        );
                                    avatarContainer.innerHTML = avatarHTML;

                                    const avatar =
                                        avatarContainer.querySelector(".user-avatar");
                                    if (avatar) {
                                        avatar.title = user; // Tooltip with username
                                        avatar.style.transition = "all 0.3s ease";
                                        // Ensure perfect circle with consistent dimensions
                                        avatar.style.width = "40px";
                                        avatar.style.height = "40px";
                                        avatar.style.borderRadius = "50%";
                                        avatar.style.display = "flex";
                                        avatar.style.alignItems = "center";
                                        avatar.style.justifyContent = "center";
                                        avatar.style.fontSize = "14px";
                                        avatar.style.fontWeight = "bold";
                                        avatar.style.border =
                                            "2px solid rgba(255, 255, 255, 0.2)";
                                        avatar.style.boxShadow =
                                            "0 2px 4px rgba(0,0,0,0.1)";

                                        // Click handler for individual avatar
                                        avatarContainer.addEventListener("click", () => {
                                            const allUsersBtn =
                                                document.getElementById("allUsersBtn");
                                            const currentSettings =
                                                document.getElementById(
                                                    "settingsSelection",
                                                ).value;

                                            if (allUsersBtn.classList.contains("active")) {
                                                // If "All" is currently selected, deselect it and select only this user
                                                allUsersBtn.classList.remove("active");
                                                selectedUsers = [user];
                                                if (currentSettings === "Rotation") {
                                                    rotationOrder = [user];
                                                }
                                            } else {
                                                // Normal toggle behavior
                                                if (selectedUsers.includes(user)) {
                                                    // Deselect this user
                                                    selectedUsers = selectedUsers.filter(
                                                        (u) => u !== user,
                                                    );
                                                    if (currentSettings === "Rotation") {
                                                        rotationOrder =
                                                            rotationOrder.filter(
                                                                (u) => u !== user,
                                                            );
                                                    }
                                                } else {
                                                    // Select this user
                                                    selectedUsers.push(user);
                                                    if (currentSettings === "Rotation") {
                                                        rotationOrder.push(user);
                                                    }
                                                }
                                            }
                                            updateSelectedUsersDisplay();
                                        });

                                        // Hover effects
                                        avatarContainer.addEventListener(
                                            "mouseenter",
                                            () => {
                                                avatar.style.transform = "scale(1.1)";
                                            },
                                        );

                                        avatarContainer.addEventListener(
                                            "mouseleave",
                                            () => {
                                                avatar.style.transform = "scale(1)";
                                            },
                                        );
                                    }

                                    userAvatarList.appendChild(avatarContainer);
                                });

                                // Update display
                                updateSelectedUsersDisplay();
                            } catch (error) {
                                console.error("Error fetching users:", error);
                            }
                        }

                        const updateSelectedUsersDisplay = () => {
                            // Clean the selectedUsers array just in case
                            selectedUsers = selectedUsers
                                .map((u) => u.trim())
                                .filter((u) => u);

                            // Set value for form submission
                            assignedToSelection.value = selectedUsers.join(", ");

                            // Validate settings if rotation or teamwork is selected
                            const currentSettings =
                                document.getElementById("settingsSelection").value;
                            if (currentSettings === "Rotation") {
                                validateRotationUsers();
                            } else if (currentSettings === "Team Work") {
                                validateTeamworkUsers();
                            }

                            // Update visual state of all avatars
                            const userAvatarList =
                                document.getElementById("userAvatarList");
                            const avatarContainers = userAvatarList.querySelectorAll(
                                'div[style*="position: relative"]',
                            );
                            const allUsersBtn = document.getElementById("allUsersBtn");

                            // Check if all users are selected
                            const allSelected =
                                window.allUsers &&
                                window.allUsers.length > 0 &&
                                window.allUsers.every((user) =>
                                    selectedUsers.includes(user),
                                );

                            // Update "All" button visual state
                            const allAvatar = allUsersBtn
                                ? allUsersBtn.querySelector(".user-avatar")
                                : null;
                            if (allUsersBtn && allAvatar) {
                                // Remove existing checkmark if any
                                const existingCheckmark =
                                    allUsersBtn.querySelector(".avatar-checkmark");
                                if (existingCheckmark) {
                                    existingCheckmark.remove();
                                }

                                if (allSelected) {
                                    allUsersBtn.classList.add("active");
                                    allAvatar.style.boxShadow =
                                        "0 0 0 4px rgba(255, 193, 7, 0.9)";
                                    allAvatar.style.border =
                                        "3px solid var(--primary-color)";
                                    allAvatar.style.transform = "scale(1.1)";
                                    allAvatar.style.filter = "brightness(1.2)";

                                    // Add checkmark overlay to All button
                                    const checkmark = document.createElement("div");
                                    checkmark.className = "avatar-checkmark";
                                    checkmark.innerHTML = "✓";
                                    checkmark.style.position = "absolute";
                                    checkmark.style.top = "-5px";
                                    checkmark.style.right = "-5px";
                                    checkmark.style.width = "20px";
                                    checkmark.style.height = "20px";
                                    checkmark.style.backgroundColor =
                                        "var(--primary-color)";
                                    checkmark.style.color = "white";
                                    checkmark.style.borderRadius = "50%";
                                    checkmark.style.display = "flex";
                                    checkmark.style.alignItems = "center";
                                    checkmark.style.justifyContent = "center";
                                    checkmark.style.fontSize = "12px";
                                    checkmark.style.fontWeight = "bold";
                                    checkmark.style.border = "2px solid white";
                                    checkmark.style.boxShadow = "0 2px 4px rgba(0,0,0,0.3)";
                                    allUsersBtn.appendChild(checkmark);
                                } else {
                                    allUsersBtn.classList.remove("active");
                                    allAvatar.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
                                    allAvatar.style.border =
                                        "2px solid rgba(255, 255, 255, 0.2)";
                                    allAvatar.style.transform = "scale(1)";
                                    allAvatar.style.filter = "none";
                                }
                            }

                            // Skip the first container (which is the All button) and process user avatars
                            avatarContainers.forEach((container, index) => {
                                if (index === 0) return; // Skip the All button
                                const avatar = container.querySelector(".user-avatar");
                                const user = window.allUsers
                                    ? window.allUsers[index - 1]
                                    : null; // Adjust index for All button

                                // Remove existing checkmark/number if any
                                const existingCheckmark =
                                    container.querySelector(".avatar-checkmark");
                                if (existingCheckmark) {
                                    existingCheckmark.remove();
                                }

                                if (user && selectedUsers.includes(user) && !allSelected) {
                                    avatar.style.boxShadow =
                                        "0 0 0 4px rgba(255, 193, 7, 0.9)";
                                    avatar.style.border = "3px solid var(--primary-color)";
                                    avatar.style.transform = "scale(1.1)";
                                    avatar.style.filter = "brightness(1.2)";

                                    // Add rotation number or checkmark overlay
                                    const currentSettings =
                                        document.getElementById("settingsSelection").value;
                                    const indicator = document.createElement("div");
                                    indicator.className = "avatar-checkmark";

                                    if (currentSettings === "Rotation") {
                                        const rotationIndex = rotationOrder.indexOf(user);
                                        indicator.innerHTML =
                                            rotationIndex !== -1
                                                ? (rotationIndex + 1).toString()
                                                : "✓";
                                    } else {
                                        indicator.innerHTML = "✓";
                                    }

                                    indicator.style.position = "absolute";
                                    indicator.style.top = "-5px";
                                    indicator.style.right = "-5px";
                                    indicator.style.width = "20px";
                                    indicator.style.height = "20px";
                                    indicator.style.backgroundColor =
                                        "var(--primary-color)";
                                    indicator.style.color = "white";
                                    indicator.style.borderRadius = "50%";
                                    indicator.style.display = "flex";
                                    indicator.style.alignItems = "center";
                                    indicator.style.justifyContent = "center";
                                    indicator.style.fontSize = "12px";
                                    indicator.style.fontWeight = "bold";
                                    indicator.style.border = "2px solid white";
                                    indicator.style.boxShadow = "0 2px 4px rgba(0,0,0,0.3)";
                                    container.appendChild(indicator);
                                } else if (
                                    user &&
                                    allSelected &&
                                    document.getElementById("settingsSelection").value ===
                                        "Rotation"
                                ) {
                                    // Show rotation numbers when "All" is selected for rotation
                                    avatar.style.boxShadow =
                                        "0 0 0 4px rgba(255, 193, 7, 0.9)";
                                    avatar.style.border = "3px solid var(--primary-color)";
                                    avatar.style.transform = "scale(1.1)";
                                    avatar.style.filter = "brightness(1.2)";

                                    const indicator = document.createElement("div");
                                    indicator.className = "avatar-checkmark";
                                    const rotationIndex = rotationOrder.indexOf(user);
                                    indicator.innerHTML =
                                        rotationIndex !== -1
                                            ? (rotationIndex + 1).toString()
                                            : index.toString();
                                    indicator.style.position = "absolute";
                                    indicator.style.top = "-5px";
                                    indicator.style.right = "-5px";
                                    indicator.style.width = "20px";
                                    indicator.style.height = "20px";
                                    indicator.style.backgroundColor =
                                        "var(--primary-color)";
                                    indicator.style.color = "white";
                                    indicator.style.borderRadius = "50%";
                                    indicator.style.display = "flex";
                                    indicator.style.alignItems = "center";
                                    indicator.style.justifyContent = "center";
                                    indicator.style.fontSize = "12px";
                                    indicator.style.fontWeight = "bold";
                                    indicator.style.border = "2px solid white";
                                    indicator.style.boxShadow = "0 2px 4px rgba(0,0,0,0.3)";
                                    container.appendChild(indicator);
                                } else {
                                    avatar.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
                                    avatar.style.border =
                                        "2px solid rgba(255, 255, 255, 0.2)";
                                    avatar.style.transform = "scale(1)";
                                    avatar.style.filter = "none";
                                }
                            });
                        };

                        // All button is now handled in populateUsers function

                        // No modal needed for avatar selection

                        // Buzzpoints Toggle and Stepper Logic
                        const buzzpointsToggle =
                            document.getElementById("buzzpointsToggle");
                        const buzzpointsContainer = document.getElementById(
                            "buzzpointsInputContainer",
                        );
                        const rewardValueInput = document.getElementById("RewardValue");
                        const decreaseBuzzpoints =
                            document.getElementById("decreaseBuzzpoints");
                        const increaseBuzzpoints =
                            document.getElementById("increaseBuzzpoints");

                        // Fair Rotation Toggle Logic
                        const fairRotationToggle =
                            document.getElementById("fairRotationToggle");
                        const fairRotationAdvanced = document.getElementById(
                            "fairRotationAdvanced",
                        );

                        fairRotationToggle.addEventListener("change", () => {
                            if (fairRotationToggle.checked) {
                                fairRotationAdvanced.style.display = "block";
                            } else {
                                fairRotationAdvanced.style.display = "none";
                                document.getElementById(
                                    "fairRotationTimeBasedToggle",
                                ).checked = false;
                            }
                        });

                        buzzpointsToggle.addEventListener("change", () => {
                            if (buzzpointsToggle.checked) {
                                buzzpointsContainer.style.display = "flex";
                                if (
                                    !rewardValueInput.value ||
                                    rewardValueInput.value === "0"
                                ) {
                                    rewardValueInput.value = "10";
                                }
                            } else {
                                buzzpointsContainer.style.display = "none";
                            }
                        });

                        decreaseBuzzpoints.addEventListener("click", () => {
                            let currentValue = parseInt(rewardValueInput.value) || 0;
                            let decreaseAmount =
                                currentValue >= 100 ? 50 : currentValue >= 50 ? 10 : 5;
                            let newValue = Math.max(0, currentValue - decreaseAmount);
                            rewardValueInput.value = newValue;
                        });

                        increaseBuzzpoints.addEventListener("click", () => {
                            let currentValue = parseInt(rewardValueInput.value) || 0;
                            let increaseAmount =
                                currentValue >= 100 ? 50 : currentValue >= 50 ? 10 : 5;
                            let newValue = Math.min(10000, currentValue + increaseAmount);
                            rewardValueInput.value = newValue;
                        });

                        // Add hover effects for stepper buttons
                        [decreaseBuzzpoints, increaseBuzzpoints].forEach((btn) => {
                            btn.addEventListener("mouseenter", () => {
                                btn.style.background = "var(--primary-color)";
                                btn.style.color = "var(--secondary-color)";
                            });
                            btn.addEventListener("mouseleave", () => {
                                btn.style.background = "var(--light-bg)";
                                btn.style.color = "var(--text-color)";
                            });
                        });

                        // Validate input on change
                        rewardValueInput.addEventListener("input", () => {
                            let value = parseInt(rewardValueInput.value) || 0;
                            if (value < 0) value = 0;
                            if (value > 10000) value = 10000;
                            rewardValueInput.value = value;
                        });

                        // Generic Modal Setup
                        function setupModal(modalId, buttonId, inputId) {
                            const modal = document.getElementById(modalId);
                            const button = document.getElementById(buttonId);
                            const input = document.getElementById(inputId);

                            button.addEventListener("click", () => {
                                showModal(modal);
                            });

                            window.addEventListener("click", (e) => {
                                if (e.target === modal) {
                                    hideModal(modal);
                                }
                            });

                            modal.addEventListener("click", (e) => {
                                if (e.target.tagName === "LI") {
                                    input.value = e.target.getAttribute("data-value");
                                    button.textContent =
                                        e.target.getAttribute("data-value");
                                    hideModal(modal);
                                }
                            });
                        }

                        // Center popup in viewport function
                        function positionPopup(popup, triggerElement) {
                            const popupHeight = 200; // Estimated popup height
                            const popupWidth = popup.offsetWidth || 300;
                            const viewport = {
                                width: window.innerWidth,
                                height: window.innerHeight,
                            };
                            const scrollY = window.scrollY;
                            const scrollX = window.scrollX;

                            // Center popup in the current viewport
                            let top = scrollY + (viewport.height - popupHeight) / 2;
                            let left = scrollX + (viewport.width - popupWidth) / 2;

                            // Ensure minimum margins from edges
                            if (left < scrollX + 20) {
                                left = scrollX + 20;
                            }
                            if (left + popupWidth > scrollX + viewport.width - 20) {
                                left = scrollX + viewport.width - popupWidth - 20;
                            }

                            if (top < scrollY + 20) {
                                top = scrollY + 20;
                            }
                            if (top + popupHeight > scrollY + viewport.height - 20) {
                                top = scrollY + viewport.height - popupHeight - 20;
                            }

                            // Apply positioning
                            popup.style.top = top + "px";
                            popup.style.left = left + "px";

                            // Remove arrow classes since popup is centered
                            popup.className = popup.className.replace(/arrow-\w+/g, "");
                        }

                        // Parent Approval Popup Toggle
                        function toggleParentApprovalPopup(event) {
                            event.stopPropagation();
                            const popup = document.getElementById("parentApprovalPopup");
                            const isShowing = popup.classList.contains("show");

                            if (!isShowing) {
                                positionPopup(popup, event.target);
                            }

                            popup.classList.toggle("show");
                        }

                        // On-time Completion Popup Toggle
                        function toggleOnTimeCompletionPopup(event) {
                            event.stopPropagation();
                            const popup = document.getElementById("onTimeCompletionPopup");
                            const isShowing = popup.classList.contains("show");

                            if (!isShowing) {
                                positionPopup(popup, event.target);
                            }

                            popup.classList.toggle("show");
                        }

                        // Settings Popup Toggle
                        function toggleSettingsPopup(event) {
                            event.stopPropagation();
                            const popup = document.getElementById("settingsPopup");
                            const isShowing = popup.classList.contains("show");

                            if (!isShowing) {
                                positionPopup(popup, event.target);
                            }

                            popup.classList.toggle("show");
                        }

                        // Close popup when clicking outside
                        document.addEventListener("click", function (event) {
                            const parentPopup = document.getElementById(
                                "parentApprovalPopup",
                            );
                            const parentIcon =
                                document.getElementById("parentApprovalInfo");
                            const settingsPopup = document.getElementById("settingsPopup");
                            const settingsIcon = document.getElementById("settingsInfo");
                            const onTimePopup = document.getElementById(
                                "onTimeCompletionPopup",
                            );
                            const onTimeIcon = document.getElementById(
                                "onTimeCompletionInfo",
                            );

                            if (
                                parentPopup &&
                                parentIcon &&
                                !parentPopup.contains(event.target) &&
                                !parentIcon.contains(event.target)
                            ) {
                                parentPopup.classList.remove("show");
                            }

                            if (
                                settingsPopup &&
                                settingsIcon &&
                                !settingsPopup.contains(event.target) &&
                                !settingsIcon.contains(event.target)
                            ) {
                                settingsPopup.classList.remove("show");
                            }

                            if (
                                onTimePopup &&
                                onTimeIcon &&
                                !onTimePopup.contains(event.target) &&
                                !onTimeIcon.contains(event.target)
                            ) {
                                onTimePopup.classList.remove("show");
                            }

                            const privatePopup =
                                document.getElementById("privateTaskPopup");
                            const privateIcon = document.getElementById("privateTaskInfo");
                            if (
                                privatePopup &&
                                privateIcon &&
                                !privatePopup.contains(event.target) &&
                                !privateIcon.contains(event.target)
                            ) {
                                privatePopup.classList.remove("show");
                            }
                        });

                        // Private Task Popup Toggle
                        function togglePrivateTaskPopup(event) {
                            event.stopPropagation();
                            const popup = document.getElementById("privateTaskPopup");
                            const isShowing = popup.classList.contains("show");

                            if (!isShowing) {
                                positionPopup(popup, event.target);
                            }

                            popup.classList.toggle("show");
                        }

                        // Frequency Info Popup Toggle
                        function toggleFrequencyInfoPopup(event) {
                            event.stopPropagation();
                            const popup = document.getElementById("frequencyInfoPopup");
                            const isShowing = popup.classList.contains("show");

                            if (!isShowing) {
                                positionPopup(popup, event.target);
                            }

                            popup.classList.toggle("show");
                        }

                        // Toggle notes field function
                        function toggleNotesField() {
                            const notesContainer =
                                document.getElementById("notesContainer");
                            const addNotesBtn = document.getElementById("addNotesBtn");

                            if (notesContainer.style.display === "none") {
                                notesContainer.style.display = "block";
                                addNotesBtn.textContent = "- Hide notes/description";
                            } else {
                                notesContainer.style.display = "none";
                                addNotesBtn.textContent = "+ Add notes/description";
                                document.getElementById("taskNotes").value = ""; // Clear the field when hidden
                            }
                        }

                        // Make functions globally available
                        window.toggleParentApprovalPopup = toggleParentApprovalPopup;
                        window.toggleSettingsPopup = toggleSettingsPopup;
                        window.toggleOnTimeCompletionPopup = toggleOnTimeCompletionPopup;
                        window.togglePrivateTaskPopup = togglePrivateTaskPopup;
                        window.toggleFrequencyInfoPopup = toggleFrequencyInfoPopup;
                        window.toggleNotesField = toggleNotesField;

                        // Custom setup for settings modal to handle rotation options
                        const settingsModal = document.getElementById("settingsModal");
                        const settingsButton = document.getElementById("selectSettings");
                        const settingsInput = document.getElementById("settingsSelection");
                        const rotationOptions = document.getElementById("rotationOptions");

                        settingsButton.addEventListener("click", () => {
                            updateSettingsModal();
                            showModal(settingsModal);
                        });

                        window.addEventListener("click", (e) => {
                            if (e.target === settingsModal) {
                                hideModal(settingsModal);
                            }
                        });

                        // Update settings modal options based on frequency selection
                        function updateSettingsModal() {
                            const currentFrequency =
                                document.getElementById("repeatSelection").value;
                            const rotationOption = settingsModal.querySelector(
                                '[data-value="Rotation"]',
                            );

                            if (currentFrequency === "One Time") {
                                // Hide rotation option for one-time tasks
                                if (rotationOption) {
                                    rotationOption.style.display = "none";
                                }
                                // If rotation was previously selected, reset to Individual
                                if (settingsInput.value === "Rotation") {
                                    settingsInput.value = "Individual";
                                    settingsButton.textContent = "Individual";
                                    document.getElementById(
                                        "fairRotationSection",
                                    ).style.display = "none";
                                    rotationOptions.style.display = "none";
                                    rotationOrder = [];
                                }
                            } else {
                                // Show rotation option for recurring tasks
                                if (rotationOption) {
                                    rotationOption.style.display = "block";
                                }
                            }
                        }

                        // Make function globally available
                        window.updateSettingsModal = updateSettingsModal;

                        settingsModal.addEventListener("click", (e) => {
                            if (e.target.tagName === "LI") {
                                const selectedValue = e.target.getAttribute("data-value");
                                settingsInput.value = selectedValue;
                                settingsButton.textContent = selectedValue;
                                hideModal(settingsModal);

                                // Show/hide rotation options based on selection
                                if (selectedValue === "Rotation") {
                                    document.getElementById(
                                        "fairRotationSection",
                                    ).style.display = "block";
                                    rotationOptions.style.display = "block";
                                    validateRotationUsers();
                                    // Initialize rotation order for current selections
                                    if (selectedUsers.length > 0) {
                                        rotationOrder = [...selectedUsers];
                                        updateSelectedUsersDisplay();
                                    }
                                } else {
                                    document.getElementById(
                                        "fairRotationSection",
                                    ).style.display = "none";
                                    rotationOptions.style.display = "none";
                                    rotationOrder = []; // Clear rotation order when not using rotation

                                    // Validate teamwork if selected
                                    if (selectedValue === "Team Work") {
                                        validateTeamworkUsers();
                                    }
                                }
                            }
                        });

                        // Rotation options stepper functionality
                        const decreaseOccurrences = document.getElementById(
                            "decreaseOccurrences",
                        );
                        const increaseOccurrences = document.getElementById(
                            "increaseOccurrences",
                        );
                        const occurrencesValue =
                            document.getElementById("occurrencesValue");
                        const decreaseTimeValue =
                            document.getElementById("decreaseTimeValue");
                        const increaseTimeValue =
                            document.getElementById("increaseTimeValue");
                        const timeValue = document.getElementById("timeValue");

                        // Occurrences stepper
                        decreaseOccurrences.addEventListener("click", () => {
                            let value = parseInt(occurrencesValue.value) || 1;
                            if (value > 1) {
                                occurrencesValue.value = value - 1;
                            }
                        });

                        increaseOccurrences.addEventListener("click", () => {
                            let value = parseInt(occurrencesValue.value) || 1;
                            if (value < 100) {
                                occurrencesValue.value = value + 1;
                            }
                        });

                        // Time value stepper
                        decreaseTimeValue.addEventListener("click", () => {
                            let value = parseInt(timeValue.value) || 1;
                            if (value > 1) {
                                timeValue.value = value - 1;
                            }
                        });

                        increaseTimeValue.addEventListener("click", () => {
                            let value = parseInt(timeValue.value) || 1;
                            if (value < 100) {
                                timeValue.value = value + 1;
                            }
                        });

                        // Input validation
                        occurrencesValue.addEventListener("input", () => {
                            let value = parseInt(occurrencesValue.value) || 1;
                            if (value < 1) value = 1;
                            if (value > 100) value = 100;
                            occurrencesValue.value = value;
                        });

                        timeValue.addEventListener("input", () => {
                            let value = parseInt(timeValue.value) || 1;
                            if (value < 1) value = 1;
                            if (value > 100) value = 100;
                            timeValue.value = value;
                        });

                        // Custom radio button styling and functionality
                        const radioButtons = document.querySelectorAll(
                            'input[name="rotationType"]',
                        );
                        const radioCustoms = document.querySelectorAll(".radio-custom");

                        function updateRadioButtons() {
                            radioButtons.forEach((radio, index) => {
                                const customRadio = radioCustoms[index];
                                if (radio.checked) {
                                    customRadio.style.background = "var(--primary-color)";
                                    customRadio.style.border =
                                        "2px solid var(--primary-color)";
                                    // Add inner dot
                                    if (!customRadio.querySelector(".radio-dot")) {
                                        const dot = document.createElement("div");
                                        dot.className = "radio-dot";
                                        dot.style.width = "8px";
                                        dot.style.height = "8px";
                                        dot.style.background = "var(--secondary-color)";
                                        dot.style.borderRadius = "50%";
                                        dot.style.position = "absolute";
                                        dot.style.top = "50%";
                                        dot.style.left = "50%";
                                        dot.style.transform = "translate(-50%, -50%)";
                                        customRadio.appendChild(dot);
                                    }
                                } else {
                                    customRadio.style.background = "var(--light-bg)";
                                    customRadio.style.border =
                                        "2px solid var(--primary-color)";
                                    // Remove inner dot
                                    const dot = customRadio.querySelector(".radio-dot");
                                    if (dot) {
                                        dot.remove();
                                    }
                                }
                            });
                        }

                        radioButtons.forEach((radio) => {
                            radio.addEventListener("change", updateRadioButtons);
                        });

                        // Initialize radio button styling
                        updateRadioButtons();

                        // Add hover effects for stepper buttons
                        const stepperButtons = [
                            decreaseOccurrences,
                            increaseOccurrences,
                            decreaseTimeValue,
                            increaseTimeValue,
                        ];
                        stepperButtons.forEach((btn) => {
                            btn.addEventListener("mouseenter", () => {
                                btn.style.background = "var(--primary-color)";
                                btn.style.color = "var(--secondary-color)";
                            });
                            btn.addEventListener("mouseleave", () => {
                                btn.style.background = "var(--light-bg)";
                                btn.style.color = "var(--text-color)";
                            });
                        });

                        // Validation for rotation requiring at least 2 users
                        function validateRotationUsers() {
                            const allUsersBtn = document.getElementById("allUsersBtn");
                            const isAllSelected =
                                allUsersBtn && allUsersBtn.classList.contains("active");
                            const individualUsersSelected = selectedUsers.length;
                            const totalUsersSelected = isAllSelected
                                ? window.allUsers
                                    ? window.allUsers.length
                                    : 0
                                : individualUsersSelected;

                            const userAvatarContainer = document.getElementById(
                                "userAvatarContainer",
                            );
                            const existingWarning =
                                document.getElementById("rotationWarning");

                            if (existingWarning) {
                                existingWarning.remove();
                            }

                            if (totalUsersSelected < 2) {
                                const warning = document.createElement("div");
                                warning.id = "rotationWarning";
                                warning.style.color = "#6D4C41";
                                warning.style.fontSize = "14px";
                                warning.style.fontWeight = "500";
                                warning.style.marginTop = "8px";
                                warning.style.padding = "10px 12px";
                                warning.style.backgroundColor = "rgba(255, 193, 7, 0.15)";
                                warning.style.border = "1px solid rgba(255, 193, 7, 0.4)";
                                warning.style.borderRadius = "8px";
                                warning.style.borderLeft = "4px solid var(--primary-color)";
                                warning.innerHTML =
                                    '<span style="display: inline-block; width: 18px; height: 18px; background: var(--primary-color); color: var(--secondary-color); border-radius: 50%; text-align: center; line-height: 18px; font-size: 12px; font-weight: bold; margin-right: 8px; vertical-align: middle;">i</span>Choose at least 2 family members';
                                userAvatarContainer.appendChild(warning);
                            }
                        }

                        // Validation for teamwork requiring at least 2 users
                        function validateTeamworkUsers() {
                            const allUsersBtn = document.getElementById("allUsersBtn");
                            const isAllSelected =
                                allUsersBtn && allUsersBtn.classList.contains("active");
                            const individualUsersSelected = selectedUsers.length;
                            const totalUsersSelected = isAllSelected
                                ? window.allUsers
                                    ? window.allUsers.length
                                    : 0
                                : individualUsersSelected;

                            const userAvatarContainer = document.getElementById(
                                "userAvatarContainer",
                            );
                            const existingWarning =
                                document.getElementById("teamworkWarning");

                            if (existingWarning) {
                                existingWarning.remove();
                            }

                            if (totalUsersSelected < 2) {
                                const warning = document.createElement("div");
                                warning.id = "teamworkWarning";
                                warning.style.color = "#6D4C41";
                                warning.style.fontSize = "14px";
                                warning.style.fontWeight = "500";
                                warning.style.marginTop = "8px";
                                warning.style.padding = "10px 12px";
                                warning.style.backgroundColor = "rgba(255, 193, 7, 0.15)";
                                warning.style.border = "1px solid rgba(255, 193, 7, 0.4)";
                                warning.style.borderRadius = "8px";
                                warning.style.borderLeft = "4px solid var(--primary-color)";
                                warning.innerHTML =
                                    '<span style="display: inline-block; width: 18px; height: 18px; background: var(--primary-color); color: var(--secondary-color); border-radius: 50%; text-align: center; line-height: 18px; font-size: 12px; font-weight: bold; margin-right: 8px; vertical-align: middle;">i</span>Choose at least 2 family members for teamwork';
                                userAvatarContainer.appendChild(warning);
                            }
                        }

                        const roomModal = document.getElementById("roomModal");
                        const roomList = document.getElementById("roomList");
                        const roomInput = document.getElementById("roomSelection");
                        const roomButton = document.getElementById("selectRoom");
                        const closeRoomModal = document.getElementById("closeRoomModal");

                        let selectedRooms = [];

                        roomButton.addEventListener("click", () => {
                            showModal(roomModal);
                        });

                        roomList.querySelectorAll("li").forEach((item) => {
                            item.style.cursor = "pointer";
                            item.style.padding = "10px";
                            item.style.margin = "5px 0";
                            item.style.border = "1px solid var(--selection-border)";
                            item.style.borderRadius = "8px";
                            item.style.textAlign = "center";

                            item.addEventListener("click", () => {
                                const value = item.getAttribute("data-value");
                                if (selectedRooms.includes(value)) {
                                    selectedRooms = selectedRooms.filter(
                                        (r) => r !== value,
                                    );
                                    item.style.backgroundColor = "var(--light-bg)";
                                    item.style.color = "var(--text-color)";
                                } else {
                                    selectedRooms.push(value);
                                    item.style.backgroundColor = "var(--primary-color)";
                                    item.style.color = "var(--secondary-color)";
                                }
                                roomInput.value = selectedRooms.join(", ");
                                roomButton.textContent =
                                    selectedRooms.length > 0
                                        ? selectedRooms.join(", ")
                                        : "Select";
                            });
                        });

                        closeRoomModal.addEventListener("click", () => {
                            hideModal(roomModal);
                        });

                        window.addEventListener("click", (e) => {
                            if (e.target === roomModal) {
                                hideModal(roomModal);
                            }
                        });

                        // Add global URL monitoring to catch any unexpected navigation
                        window.addEventListener("beforeunload", (e) => {
                            console.log(
                                "🔄 PAGE UNLOAD - Current URL:",
                                window.location.href,
                            );
                            if (window.location.href.includes("taskz.html")) {
                                console.error(
                                    "❌ LEAVING PAGE WITH taskz.html URL - This should not happen!",
                                );
                            }
                        });

                        // Monitor for any URL changes at the window level
                        let lastUrl = window.location.href;
                        new MutationObserver(() => {
                            const currentUrl = window.location.href;
                            if (currentUrl !== lastUrl) {
                                console.log("🔄 URL CHANGED:");
                                console.log("  - From:", lastUrl);
                                console.log("  - To:", currentUrl);
                                if (currentUrl.includes("taskz.html")) {
                                    console.error(
                                        "❌ URL CHANGED TO taskz.html - Attempting to fix...",
                                    );
                                    const correctUrl = currentUrl.replace(
                                        "taskz.html",
                                        "tasks.html",
                                    );
                                    window.location.replace(correctUrl);
                                }
                                lastUrl = currentUrl;
                            }
                        }).observe(document, { subtree: true, childList: true });

                        // Form submission handler - in global scope with access to global variables
                        document.addEventListener("DOMContentLoaded", () => {
                            const addTaskForm = document.getElementById("addTaskForm");
                            if (!addTaskForm) {
                                console.error("AddTask form not found!");
                                return;
                            }

                            addTaskForm.addEventListener("submit", async function (event) {
                                event.preventDefault();

                                // Prevent multiple submissions
                                const submitButton = document.querySelector(
                                    'button[type="submit"]',
                                );
                                if (submitButton.disabled) {
                                    return; // Already submitting
                                }
                                submitButton.disabled = true;
                                submitButton.textContent = "SAVING...";

                                try {
                                    console.log("🚨 FORM SUBMISSION STARTED! 🚨");
                                    console.log("🔧 Edit context check:", {
                                        hasEditTask: !!editTask,
                                        hasEditTitle: !!editTitle,
                                        hasEditDate: !!editDate,
                                        editTaskFullDate: editTaskFullDate,
                                        editTitleValue: editTitle,
                                        editDateValue: editDate,
                                        editTaskObject: editTask,
                                    });

                                    // Force debug all edit variables
                                    console.log("🔧 DEBUGGING EDIT VARIABLES:");
                                    console.log("  - editTitle:", editTitle);
                                    console.log("  - editDate:", editDate);
                                    console.log("  - editTask:", editTask);
                                    console.log("  - editTaskFullDate:", editTaskFullDate);

                                    const title = document
                                        .getElementById("taskTitle")
                                        .value.trim();
                                    const notes = document
                                        .getElementById("taskNotes")
                                        .value.trim();
                                    const room =
                                        document.getElementById("roomSelection").value;
                                    const repeat =
                                        document.getElementById("repeatSelection").value;
                                    const settings =
                                        document.getElementById("settingsSelection").value;
                                    let rotationSettings = undefined;

                                    // Capture rotation settings if Rotation is selected
                                    if (settings === "Rotation") {
                                        const rotationType = document.querySelector(
                                            'input[name="rotationType"]:checked',
                                        ).value;

                                        if (rotationType === "occurrences") {
                                            rotationSettings = {
                                                type: "occurrences",
                                                value:
                                                    parseInt(
                                                        document.getElementById(
                                                            "occurrencesValue",
                                                        ).value,
                                                    ) || 1,
                                            };
                                        } else if (rotationType === "time") {
                                            rotationSettings = {
                                                type: "time",
                                                value:
                                                    parseInt(
                                                        document.getElementById("timeValue")
                                                            .value,
                                                    ) || 1,
                                                unit: document.getElementById("timeUnit")
                                                    .value,
                                            };
                                        } else if (rotationType === "completion") {
                                            rotationSettings = {
                                                type: "completion",
                                            };
                                        }
                                    }
                                    const dateFrom =
                                        document.getElementById("taskDate").value;
                                    const dateTo =
                                        document.getElementById("taskDateTo").value;
                                    const singleDate =
                                        document.getElementById("singleTaskDate").value;
                                    const dateMode =
                                        document.getElementById("dateModeSelection").value;
                                    const monthlyDateFrom =
                                        document.getElementById("monthlyTaskDate").value;
                                    const monthlyDateTo =
                                        document.getElementById("monthlyTaskDateTo").value;
                                    const monthlyOption = document.querySelector(
                                        'input[name="monthlyOption"]:checked',
                                    ).value;
                                    const dueTimeEnabled =
                                        document.getElementById("dueTimeToggle").checked;
                                    const users = document
                                        .getElementById("assignedToSelection")
                                        .value.split(",")
                                        .map((u) => u.trim())
                                        .filter((u) => u);

                                    // Validate rotation settings require at least 2 users
                                    if (settings === "Rotation") {
                                        const allUsersBtn =
                                            document.getElementById("allUsersBtn");
                                        const isAllSelected =
                                            allUsersBtn &&
                                            allUsersBtn.classList.contains("active");
                                        const totalUsersSelected = isAllSelected
                                            ? window.allUsers
                                                ? window.allUsers.length
                                                : 0
                                            : users.length;

                                        if (totalUsersSelected < 2) {
                                            alert(
                                                "⚠️ Rotation requires at least 2 family members to be assigned. Please select more users.",
                                            );
                                            return;
                                        }
                                    }

                                    if (settings === "Team Work") {
                                        const allUsersBtn =
                                            document.getElementById("allUsersBtn");
                                        const isAllSelected =
                                            allUsersBtn &&
                                            allUsersBtn.classList.contains("active");
                                        const totalUsersSelected = isAllSelected
                                            ? window.allUsers
                                                ? window.allUsers.length
                                                : 0
                                            : users.length;

                                        if (totalUsersSelected < 2) {
                                            alert(
                                                "⚠️ Team Work requires at least 2 family members to be assigned. Please select more users.",
                                            );
                                            return;
                                        }
                                    }

                                    const reward = document.getElementById(
                                        "buzzpointsToggle",
                                    ).checked
                                        ? document.getElementById("RewardValue").value
                                        : undefined;
                                    let timesPerDay =
                                        parseInt(
                                            document.getElementById("timesPerDayInput")
                                                .value,
                                        ) || 1;
                                    let timesPerWeek =
                                        parseInt(
                                            document.getElementById("timesPerWeekInput")
                                                .value,
                                        ) || 1;
                                    let timesPerMonth =
                                        parseInt(
                                            document.getElementById("timesPerMonthInput")
                                                .value,
                                        ) || 1;

                                    console.log(
                                        "🔧 Form submission - timesPerDay value:",
                                        timesPerDay,
                                    );
                                    console.log("🔧 Edit mode context:", {
                                        isEdit: !!editTask,
                                        originalTimesPerDay: editTask?.timesPerDay,
                                        originalTotalOccurrences:
                                            editTask?.totalOccurrences,
                                        newTimesPerDay: timesPerDay,
                                        repeat: repeat,
                                    });
                                    let monthInterval =
                                        parseInt(
                                            document.getElementById("monthIntervalInput")
                                                .value,
                                        ) || 1;
                                    const specificDates =
                                        document.getElementById("specificDatesInput").value;

                                    // Validations
                                    if (!title) {
                                        alert("Task title is required!");
                                        return;
                                    }
                                    if (!repeat || repeat === "") {
                                        alert(
                                            "Please select a frequency option before saving the task!",
                                        );
                                        return;
                                    }
                                    if (repeat === "Monthly" && monthlyOption === "times") {
                                        const daysOfMonthChecked = document.getElementById(
                                            "specificDaysOfMonthCheckbox",
                                        ).checked;
                                        const daysOfWeekChecked = document.getElementById(
                                            "specificDaysOfWeekCheckbox",
                                        ).checked;

                                        if (!daysOfMonthChecked && !daysOfWeekChecked) {
                                            alert(
                                                "For monthly tasks, please select either 'Specific days of the month' or 'Specific days of the week' scheduling option.",
                                            );
                                            return;
                                        }

                                        if (daysOfMonthChecked) {
                                            const monthlyDaysData =
                                                getMonthlyDaysOfMonthData();
                                            if (
                                                !monthlyDaysData ||
                                                monthlyDaysData.trim() === ""
                                            ) {
                                                alert(
                                                    "Please select at least one day of the month for your monthly task.",
                                                );
                                                return;
                                            }
                                        }

                                        if (daysOfWeekChecked) {
                                            const monthlyWeeksData =
                                                getMonthlyDaysOfWeekData();
                                            if (
                                                !monthlyWeeksData ||
                                                monthlyWeeksData.trim() === ""
                                            ) {
                                                alert(
                                                    "Please select at least one week occurrence and day for your monthly task.",
                                                );
                                                return;
                                            }
                                        }
                                    }
                                    if (users.length === 0) {
                                        alert("Please assign at least one user.");
                                        return;
                                    }

                                    // Special validation for editing modes
                                    if (isOccurrenceEdit && !targetDate) {
                                        alert(
                                            "Invalid occurrence edit - missing target date.",
                                        );
                                        return;
                                    }
                                    if (isFutureEdit && !splitDate) {
                                        alert("Invalid future edit - missing split date.");
                                        return;
                                    }

                                    if (!isOccurrenceEdit && !isFutureEdit) {
                                        // Skip date validations for Occasional tasks
                                        if (repeat !== "Occasional") {
                                            if (repeat === "One Time" && !singleDate) {
                                                alert(
                                                    "Please select a date for this one-time task.",
                                                );
                                                return;
                                            }
                                            if (
                                                dateMode === "date" &&
                                                repeat !== "One Time" &&
                                                !dateFrom
                                            ) {
                                                alert("Please select a start date.");
                                                return;
                                            }
                                            if (
                                                dateMode === "specific-dates" &&
                                                !specificDates
                                            ) {
                                                alert("Please select at least one date.");
                                                return;
                                            }
                                        }
                                    }

                                    // Cap and sanitize
                                    if (timesPerDay > 100) timesPerDay = 100;
                                    if (timesPerWeek > 7) timesPerWeek = 7;
                                    if (timesPerMonth > 100) timesPerMonth = 100;
                                    if (timesPerDay !== null && timesPerDay < 1)
                                        timesPerDay = 1;
                                    if (timesPerWeek !== null && timesPerWeek < 1)
                                        timesPerWeek = 1;
                                    if (timesPerMonth !== null && timesPerMonth < 1)
                                        timesPerMonth = 1;

                                    let dateValue = "";
                                    if (isOccurrenceEdit) {
                                        // For single occurrence, use target date as both start and end for clarity
                                        dateValue = `${targetDate} to ${targetDate}`;
                                    } else if (isFutureEdit) {
                                        // For future edit, use split date as start
                                        const originalRange = editTask.date.split(" to ");
                                        const originalEnd =
                                            originalRange[1] || "3000-01-01";

                                        // If original task ends on or before split date, extend new tasks indefinitely
                                        const splitDateObj = new Date(splitDate);
                                        const originalEndObj = new Date(originalEnd);

                                        if (originalEndObj <= splitDateObj) {
                                            // Extend indefinitely for recurring tasks
                                            dateValue = `${splitDate} to 3000-01-01`;
                                        } else {
                                            // Use original end date
                                            dateValue = `${splitDate} to ${originalEnd}`;
                                        }
                                    } else if (repeat === "One Time") {
                                        dateValue = `${singleDate} to ${singleDate}`;
                                    } else if (repeat === "Occasional") {
                                        dateValue = ""; // No date for Occasional tasks
                                    } else if (
                                        repeat === "Monthly" &&
                                        monthlyOption === "times"
                                    ) {
                                        const fromDate =
                                            monthlyDateFrom ||
                                            new Date().toISOString().split("T")[0];
                                        const toDate = monthlyDateTo || "3000-01-01";
                                        dateValue = `${fromDate} to ${toDate}`;
                                    } else if (dateMode === "date") {
                                        const fromDate = dateFrom;
                                        const toDate = dateTo || "3000-01-01";
                                        dateValue = `${fromDate} to ${toDate}`;
                                    } else if (
                                        dateMode === "specific-dates" &&
                                        specificDates
                                    ) {
                                        const dates = specificDates
                                            .split(",")
                                            .map((d) => d.trim())
                                            .filter((d) => d);
                                        dateValue = `${dates[0]} to ${dates[dates.length - 1]}`;
                                    } else {
                                        const today = new Date()
                                            .toISOString()
                                            .split("T")[0];
                                        dateValue = `${today} to 3000-01-01`;
                                    }

                                    const task = {
                                        title,
                                        notes: notes || undefined,
                                        room: room || undefined,
                                        repeat: repeat || undefined,
                                        settings: settings || undefined,
                                        rotationSettings: rotationSettings,
                                        rotationOrder:
                                            settings === "Rotation"
                                                ? rotationOrder
                                                : undefined,
                                        date: dateValue,
                                        // reminder: reminder || undefined,  // COMMENTED OUT
                                        dueTimes:
                                            dueTimeEnabled && dueTimes.length > 0
                                                ? dueTimes
                                                : undefined,
                                        users,
                                        reward: reward || undefined,
                                        fairRotation:
                                            document.getElementById("fairRotationToggle")
                                                .checked,
                                        fairRotationTimeBased:
                                            document.getElementById(
                                                "fairRotationTimeBasedToggle",
                                            ).checked,
                                                ).checked) ||
                                            undefined,
                                        parentApproval: document.getElementById(
                                            "parentApprovalToggle",
                                        ).checked,
                                        onTimeCompletion: document.getElementById(
                                            "onTimeCompletionToggle",
                                        ).checked,
                                        isPrivate:
                                            document.getElementById("privateTask").checked,
                                        // alarms: alarms.length > 0 ? alarms : undefined,  // COMMENTED OUT
                                        timesPerDay:
                                            repeat === "Daily" ? timesPerDay : undefined,
                                        timesPerWeek:
                                            repeat === "Weekly" ? timesPerWeek : undefined,
                                        timesPerMonth:
                                            repeat === "Monthly" &&
                                            monthlyOption === "times"
                                                ? timesPerMonth
                                                : undefined,
                                        monthInterval:
                                            repeat === "Monthly" &&
                                            monthlyOption === "interval"
                                                ? monthInterval
                                                : undefined,
                                        monthlyOption:
                                            repeat === "Monthly"
                                                ? monthlyOption
                                                : undefined,
                                        monthlyDaysOfMonth:
                                            repeat === "Monthly" &&
                                            monthlyOption === "times" &&
                                            document.getElementById(
                                                "specificDaysOfMonthCheckbox",
                                            ).checked
                                                ? getMonthlyDaysOfMonthData()
                                                : undefined,
                                        monthlyDaysOfWeek:
                                            repeat === "Monthly" &&
                                            monthlyOption === "times" &&
                                            document.getElementById(
                                                "specificDaysOfWeekCheckbox",
                                            ).checked
                                                ? getMonthlyDaysOfWeekData()
                                                : undefined,
                                        monthlySchedulingType:
                                            repeat === "Monthly" &&
                                            monthlyOption === "times"
                                                ? document.getElementById(
                                                      "specificDaysOfMonthCheckbox",
                                                  ).checked
                                                    ? "daysOfMonth"
                                                    : document.getElementById(
                                                            "specificDaysOfWeekCheckbox",
                                                        ).checked
                                                      ? "daysOfWeek"
                                                      : null
                                                : undefined,
                                        specificDates:
                                            dateMode === "specific-dates"
                                                ? specificDates
                                                : undefined,
                                        daysOfWeek:
                                            dateMode === "date" &&
                                            repeat !== "Occasional" &&
                                            !(
                                                repeat === "Monthly" &&
                                                monthlyOption === "times"
                                            )
                                                ? selectedDays.length > 0
                                                    ? selectedDays.includes("All")
                                                        ? [
                                                              "Monday",
                                                              "Tuesday",
                                                              "Wednesday",
                                                              "Thursday",
                                                              "Friday",
                                                              "Saturday",
                                                              "Sunday",
                                                          ]
                                                        : selectedDays
                                                    : repeat === "Daily"
                                                      ? ["All"]
                                                      : ["Any"]
                                                : undefined,
                                        asNeeded:
                                            repeat === "Occasional" ? true : undefined,
                                        activated:
                                            repeat === "Occasional" ? false : undefined,
                                        currentTurnIndex:
                                            settings === "Rotation" ? 0 : undefined,
                                        completions:
                                            settings === "Rotation" ? {} : undefined,
                                        pendingCompletions:
                                            settings === "Rotation" ? {} : undefined,
                                    };

                                    // Generate separate tasks for multiple daily occurrences
                                    const tasksToSave = [];

                                    if (repeat === "Daily" && timesPerDay > 1) {
                                        // Create separate tasks for each daily occurrence
                                        console.log(
                                            "🔧 Creating multiple daily occurrences:",
                                            timesPerDay,
                                        );

                                        // For fair rotation, we need to get the current global occurrence index
                                        // from existing tasks to continue rotation across days
                                        const fairRotationEnabled =
                                            document.getElementById(
                                                "fairRotationToggle",
                                            ).checked;

                                        let globalOccurrenceIndex = 0;

                                        if (
                                            fairRotationEnabled &&
                                            settings === "Rotation"
                                        ) {
                                            // Get the next global occurrence index by checking existing tasks
                                            globalOccurrenceIndex =
                                                await getNextGlobalOccurrenceIndex(
                                                    task.title,
                                                    task.users,
                                                );
                                        }

                                        for (
                                            let occurrence = 1;
                                            occurrence <= timesPerDay;
                                            occurrence++
                                        ) {
                                            const occurenceTask = {
                                                ...task,
                                                title: `${task.title} - ${occurrence}${getOrdinalSuffix(occurrence)}`,
                                                originalTitle: task.title, // Store original title for grouping
                                                occurrence: occurrence,
                                                totalOccurrences: timesPerDay,
                                                timesPerDay: 1, // Each occurrence is now a single daily task
                                                originalTimesPerDay: timesPerDay, // Keep original for rotation context
                                                // Assign specific due time for this occurrence
                                                dueTimes:
                                                    task.dueTimes &&
                                                    task.dueTimes[occurrence - 1]
                                                        ? [task.dueTimes[occurrence - 1]]
                                                        : undefined,
                                                // For rotation tasks, keep all users for schedule-based assignment
                                                users: task.users,
                                                // Copy fair rotation settings to sub-tasks
                                                fairRotation: task.fairRotation,
                                                fairRotationTimeBased: task.fairRotationTimeBased,
                                                rotationSettings: task.rotationSettings,
                                                currentTurnIndex:
                                                    settings === "Rotation"
                                                        ? fairRotationEnabled
                                                            ? globalOccurrenceIndex %
                                                              task.users.length
                                                            : (occurrence - 1) %
                                                              task.users.length
                                                        : task.currentTurnIndex,
                                                // Store the global index for tracking fair rotation across days
                                                globalOccurrenceIndex:
                                                    settings === "Rotation" &&
                                                    fairRotationEnabled
                                                        ? globalOccurrenceIndex
                                                        : undefined,
                                            };
                                            console.log(
                                                `🔧 Created occurrence ${occurrence}:`,
                                                occurenceTask.title,
                                                fairRotationEnabled
                                                    ? `(Fair rotation - Global index: ${globalOccurrenceIndex}, User: ${occurenceTask.users[0]})`
                                                    : "",
                                            );
                                            tasksToSave.push(occurenceTask);
                                            if (
                                                fairRotationEnabled &&
                                                settings === "Rotation"
                                            ) {
                                                globalOccurrenceIndex++;
                                            }
                                        }
                                    );
                                } else {
                                    // Single task (no multiple daily occurrences)
                                    console.log(
                                        "🔧 Single task - no multiple occurrences",
                                    );
                                    tasksToSave.push(task);
                                }

                                // Initialize fair rotation schedule if enabled
                                if (settings === "Rotation" && task.fairRotation) {
                                    console.log("🔄 Initializing fair rotation schedule");

                                    // Calculate initial fair rotation schedule for the next 30 days
                                    const today = new Date().toISOString().split('T')[0];
                                    const fairSchedule = calculateFairRotationSchedule(task, today, 30);

                                    // Apply schedule to all tasks
                                    tasksToSave.forEach(taskToSave => {
                                        taskToSave.fairRotationSchedule = fairSchedule;
                                    });
                                }

                                    console.log(
                                        "🔧 Total tasks to save:",
                                        tasksToSave.length,
                                    );
                                    console.log(
                                        "🔧 Task titles:",
                                        tasksToSave.map((t) => t.title),
                                    );

                                    function getOrdinalSuffix(num) {
                                        // Handle special cases for 11th, 12th, 13th
                                        if (num % 100 >= 11 && num % 100 <= 13) {
                                            return "th";
                                        }

                                        // Handle regular cases
                                        switch (num % 10) {
                                            case 1:
                                                return "st";
                                            case 2:
                                                return "nd";
                                            case 3:
                                                return "rd";
                                            default:
                                                return "th";
                                        }
                                    }

                                    function getFairRotationUserForOccurrence(
                                        users,
                                        index,
                                        fairRotation,
                                    ) {
                                        // Both fair rotation and simple rotation use round-robin
                                        // The difference is in how the index is calculated
                                        return users[index % users.length];
                                    }

                                    // Function to get the next global occurrence index for fair rotation
                                    async function getNextGlobalOccurrenceIndex(
                                        taskTitle,
                                        users,
                                    ) {
                                        try {
                                            console.log(
                                                `🔍 Getting next global occurrence index for task: ${taskTitle}`,
                                            );

                                            // Fetch all existing tasks with the same original title
                                            const response = await fetch(
                                                `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                                                { cache: "no-store" },
                                            );

                                            if (!response.ok) {
                                                console.warn(
                                                    "Failed to fetch tasks for global index calculation, starting from 0",
                                                );
                                                return 0;
                                            }

                                            const data = await response.json();
                                            const allTasks = data.tasks || [];

                                            // Find all tasks with the same original title or base title
                                            const relatedTasks = allTasks.filter((task) => {
                                                const baseTitle =
                                                    task.originalTitle ||
                                                    task.title.replace(
                                                        / - \d+(st|nd|rd|th)$/,
                                                        "",
                                                    );
                                                const targetBaseTitle = taskTitle;
                                                return (
                                                    baseTitle === targetBaseTitle &&
                                                    task.fairRotation &&
                                                    Array.isArray(task.users) &&
                                                    JSON.stringify(
                                                        [...task.users].sort(),
                                                    ) === JSON.stringify([...users].sort())
                                                );
                                            });

                                            console.log(
                                                `📊 Found ${relatedTasks.length} related fair rotation tasks`,
                                            );

                                            if (relatedTasks.length === 0) {
                                                console.log(
                                                    "🆕 No existing tasks found, starting global index at 0",
                                                );
                                                return 0;
                                            }

                                            // Find the highest global occurrence index
                                            let maxGlobalIndex = -1;
                                            relatedTasks.forEach((task) => {
                                                if (
                                                    typeof task.globalOccurrenceIndex ===
                                                    "number"
                                                ) {
                                                    maxGlobalIndex = Math.max(
                                                        maxGlobalIndex,
                                                        task.globalOccurrenceIndex,
                                                    );
                                                }
                                            });

                                            const nextIndex = maxGlobalIndex + 1;
                                            console.log(
                                                `🔢 Next global occurrence index: ${nextIndex} (previous max: ${maxGlobalIndex})`,
                                            );

                                            return nextIndex;
                                        } catch (error) {
                                            console.error(
                                                "Error calculating global occurrence index:",
                                                error,
                                            );
                                            console.warn("Falling back to index 0");
                                            return 0;
                                        }
                                    }

                                    console.log(
                                        "Tasks being saved:",
                                        JSON.stringify(tasksToSave, null, 2),
                                    );
                                    console.log(
                                        "🐛 DEBUG SAVE: Generated",
                                        tasksToSave.length,
                                        "task(s) for",
                                        repeat,
                                        "frequency",
                                    );

                                    const currentAdmin =
                                        localStorage.getItem("currentAdminEmail");
                                    const from = new URLSearchParams(
                                        window.location.search,
                                    ).get("from");
                                    const originalUser =
                                        new URLSearchParams(window.location.search).get(
                                            "user",
                                        ) || localStorage.getItem("currentUser");

                                    if (!originalUser) {
                                        alert(
                                            "No user context available. Redirecting to user selection.",
                                        );
                                        window.location.href =
                                            "/BeeMazing-A1/mobile/2-UserProfiles/userAdmin.html";
                                        return;
                                    }

                                    const url = "https://beemazing1.onrender.com/api/tasks";

                                    if (
                                        isOccurrenceEdit &&
                                        targetDate &&
                                        originalStartDate &&
                                        editTask
                                    ) {
                                        // Single occurrence edit
                                        console.log(
                                            "🚨 OCCURRENCE EDIT PATH TRIGGERED! 🚨",
                                        );
                                        const response = await fetch(
                                            "https://beemazing1.onrender.com/api/tasks/occurrence",
                                            {
                                                method: "PUT",
                                                headers: {
                                                    "Content-Type": "application/json",
                                                },
                                                body: JSON.stringify({
                                                    adminEmail: currentAdmin,
                                                    originalTitle: editTask.title,
                                                    originalStartDate: originalStartDate,
                                                    targetDate: targetDate,
                                                    modifiedTask: tasksToSave[0], // Use first task from array
                                                }),
                                            },
                                        );

                                        const data = await response.json();
                                        if (!response.ok)
                                            throw new Error(
                                                data.error ||
                                                    `HTTP error ${response.status}`,
                                            );
                                        alert("Single occurrence updated successfully!");
                                    } else if (
                                        isFutureEdit &&
                                        splitDate &&
                                        originalStartDate &&
                                        editTask
                                    ) {
                                        // Future occurrences edit - smart approach
                                        console.log("🚨 FUTURE EDIT PATH TRIGGERED! 🚨");

                                        const originalTitle =
                                            editTask.originalTitle ||
                                            editTask.title.split(" - ")[0] ||
                                            editTask.title;
                                        const originalTimesPerDay =
                                            editTask.totalOccurrences ||
                                            editTask.timesPerDay ||
                                            1;
                                        const currentTimesPerDayField =
                                            parseInt(
                                                document.getElementById("timesPerDayInput")
                                                    .value,
                                            ) || 1;
                                        const newTimesPerDay = tasksToSave.length;

                                        console.log("🔧 Smart future edit detection:", {
                                            originalTitle,
                                            originalTimesPerDay,
                                            currentTimesPerDayField,
                                            newTimesPerDay,
                                            fieldChange:
                                                currentTimesPerDayField -
                                                originalTimesPerDay,
                                            splitDate,
                                        });

                                        // EMERGENCY SAFETY CHECK: Only delete if user actually changed the Times per Day field to a lower value
                                        // AND we have explicit confirmation that this was intentional
                                        const shouldDelete =
                                            currentTimesPerDayField < originalTimesPerDay &&
                                            currentTimesPerDayField === newTimesPerDay &&
                                            confirm(
                                                `⚠️ SAFETY CHECK ⚠️\n\nYou are about to REDUCE Times per Day from ${originalTimesPerDay} to ${currentTimesPerDayField}.\n\nThis will DELETE ALL future occurrences and recreate them.\n\nAre you sure you want to continue?`,
                                            );

                                        if (shouldDelete) {
                                            // DECREASED: End existing tasks and create new ones
                                            console.log(
                                                "🔧 User CONFIRMED decrease of Times per Day field - ending existing tasks and creating new ones",
                                            );

                                            // Function to end existing tasks at split date
                                            const endTasksAtSplitDate = async function (
                                                originalTitle,
                                                fromDate,
                                            ) {
                                                const adminEmail =
                                                    localStorage.getItem(
                                                        "currentAdminEmail",
                                                    );
                                                console.log(
                                                    "🗑️ Ending existing tasks at split date:",
                                                    { adminEmail, originalTitle, fromDate },
                                                );

                                                try {
                                                    const response = await fetch(
                                                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                                                        { cache: "no-store" },
                                                    );
                                                    if (!response.ok)
                                                        throw new Error(
                                                            "Failed to fetch tasks",
                                                        );

                                                    const result = await response.json();

                                                    // Calculate the day before split date
                                                    const splitDateObj = new Date(fromDate);
                                                    const dayBeforeSplit = new Date(
                                                        splitDateObj,
                                                    );
                                                    dayBeforeSplit.setDate(
                                                        dayBeforeSplit.getDate() - 1,
                                                    );
                                                    const dayBeforeSplitStr = dayBeforeSplit
                                                        .toISOString()
                                                        .split("T")[0];

                                                    const relatedTasks =
                                                        result.tasks.filter((t) => {
                                                            const taskRange =
                                                                t.date.split(" to ");
                                                            const taskEndDate = new Date(
                                                                taskRange[1] ||
                                                                    "3000-01-01",
                                                            );
                                                            const fromDateObj = new Date(
                                                                fromDate,
                                                            );

                                                            // Task is related if it matches the originalTitle
                                                            const isRelatedTask =
                                                                t.originalTitle ===
                                                                    originalTitle ||
                                                                t.title.startsWith(
                                                                    originalTitle + " - ",
                                                                );

                                                            // Task needs updating if it extends beyond the split date
                                                            const extendsBeyondSplitDate =
                                                                taskEndDate >= fromDateObj;

                                                            return (
                                                                isRelatedTask &&
                                                                extendsBeyondSplitDate
                                                            );
                                                        });

                                                    console.log(
                                                        "🗑️ Found tasks that extend beyond split date:",
                                                        relatedTasks.length,
                                                    );

                                                    // Update the end date to day before split
                                                    let updatedCount = 0;
                                                    for (const task of relatedTasks) {
                                                        try {
                                                            const taskRange =
                                                                task.date.split(" to ");
                                                            const newEndDate =
                                                                dayBeforeSplitStr;

                                                            // Only update if the task actually needs to be shortened
                                                            if (
                                                                new Date(
                                                                    taskRange[1] ||
                                                                        "3000-01-01",
                                                                ) >
                                                                new Date(dayBeforeSplitStr)
                                                            ) {
                                                                const updatedTask = {
                                                                    ...task,
                                                                    date: `${taskRange[0]} to ${newEndDate}`,
                                                                };

                                                                const updateResponse =
                                                                    await fetch(
                                                                        "https://beemazing1.onrender.com/api/tasks",
                                                                        {
                                                                            method: "PUT",
                                                                            headers: {
                                                                                "Content-Type":
                                                                                    "application/json",
                                                                            },
                                                                            body: JSON.stringify(
                                                                                {
                                                                                    adminEmail:
                                                                                        adminEmail,
                                                                                    task: updatedTask,
                                                                                    originalTitle:
                                                                                        task.title,
                                                                                    originalDate:
                                                                                        task.date,
                                                                                },
                                                                            ),
                                                                        },
                                                                    );

                                                                if (updateResponse.ok) {
                                                                    updatedCount++;
                                                                    console.log(
                                                                        "🗑️ Updated task end date:",
                                                                        task.title,
                                                                        "now ends on",
                                                                        newEndDate,
                                                                    );
                                                                } else {
                                                                    console.error(
                                                                        "🗑️ Failed to update task:",
                                                                        task.title,
                                                                    );
                                                                }
                                                            }
                                                        } catch (err) {
                                                            console.error(
                                                                "🗑️ Failed to update task:",
                                                                task.title,
                                                                err,
                                                            );
                                                        }
                                                    }

                                                    console.log(
                                                        `🗑️ Updated ${updatedCount}/${relatedTasks.length} tasks to end before split date`,
                                                    );
                                                    return updatedCount;
                                                } catch (error) {
                                                    console.error(
                                                        "🗑️ Update future occurrences failed:",
                                                        error,
                                                    );
                                                    throw error;
                                                }
                                            };

                                            // End existing tasks at split date
                                            await endTasksAtSplitDate(
                                                originalTitle,
                                                splitDate,
                                            );

                                            // Wait for updates to process
                                            console.log(
                                                "🔧 Waiting for task updates to process...",
                                            );
                                            await new Promise((resolve) =>
                                                setTimeout(resolve, 2000),
                                            );

                                            // Create new future occurrences
                                            console.log(
                                                "🔧 Creating",
                                                newTimesPerDay,
                                                "new future occurrences...",
                                            );
                                            let savedCount = 0;
                                            for (const taskToSave of tasksToSave) {
                                                try {
                                                    const saveResponse = await fetch(
                                                        "https://beemazing1.onrender.com/api/tasks",
                                                        {
                                                            method: "POST",
                                                            headers: {
                                                                "Content-Type":
                                                                    "application/json",
                                                            },
                                                            body: JSON.stringify({
                                                                adminEmail: currentAdmin,
                                                                task: taskToSave,
                                                            }),
                                                        },
                                                    );

                                                    if (saveResponse.ok) {
                                                        savedCount++;
                                                        console.log(
                                                            "🔧 Created future:",
                                                            taskToSave.title,
                                                        );
                                                    }
                                                } catch (err) {
                                                    console.error(
                                                        "🔧 Create future failed:",
                                                        taskToSave.title,
                                                        err,
                                                    );
                                                }
                                            }

                                            alert(
                                                `✅ Future occurrences updated successfully!\n\nReduced from ${originalTimesPerDay} to ${currentTimesPerDayField} occurrences\nUpdated existing tasks and created: ${savedCount} new future occurrences`,
                                            );
                                        } else {
                                            // INCREASED, SAME, or user cancelled: Use backend Edit Future API
                                            if (
                                                currentTimesPerDayField <
                                                originalTimesPerDay
                                            ) {
                                                console.log(
                                                    "🔧 User CANCELLED deletion - using backend Edit Future API",
                                                );
                                            } else {
                                                console.log(
                                                    "🔧 Times per Day unchanged or increased - using backend Edit Future API",
                                                );
                                            }
                                            console.log(
                                                "🔧 Using backend Edit Future API for proper splitting",
                                            );
                                            console.log(
                                                "🔧 DEBUG: tasksToSave array:",
                                                tasksToSave.map((t) => ({
                                                    title: t.title,
                                                    date: t.date,
                                                })),
                                            );

                                            let originalTitleToUse = editTask.title;
                                            let modifiedTaskToSend = tasksToSave[0];

                                            // Check if this is an occurrence group edit (existing or new)
                                            const isOccurrenceGroupEdit =
                                                (editTask.isOccurrenceGroupEdit &&
                                                    editTask.originalTitle) ||
                                                tasksToSave.length > 1;

                                            if (isOccurrenceGroupEdit) {
                                                console.log(
                                                    "🚀 FRONTEND: Setting up occurrence group edit",
                                                );
                                                originalTitleToUse =
                                                    editTask.originalTitle ||
                                                    editTask.title;

                                                // For multiple daily occurrences, send all generated tasks
                                                if (tasksToSave.length > 1) {
                                                    console.log(
                                                        `🚀 FRONTEND: Sending ${tasksToSave.length} occurrence tasks`,
                                                    );
                                                    modifiedTaskToSend = {
                                                        ...tasksToSave[0],
                                                        isOccurrenceGroupEdit: true,
                                                        totalOccurrences:
                                                            tasksToSave.length,
                                                        allOccurrences: tasksToSave, // Send all occurrence tasks
                                                    };
                                                } else {
                                                    modifiedTaskToSend = {
                                                        ...tasksToSave[0],
                                                        isOccurrenceGroupEdit: true,
                                                        totalOccurrences:
                                                            editTask.totalOccurrences,
                                                    };
                                                }

                                                console.log(
                                                    "🚀 FRONTEND: Group edit data:",
                                                    {
                                                        originalTitle: originalTitleToUse,
                                                        totalOccurrences:
                                                            modifiedTaskToSend.totalOccurrences,
                                                        isOccurrenceGroupEdit: true,
                                                        occurrenceCount: tasksToSave.length,
                                                    },
                                                );

                                                // Debug due times for each occurrence
                                                if (modifiedTaskToSend.allOccurrences) {
                                                    console.log(
                                                        "🚀 FRONTEND: Due times for each occurrence:",
                                                    );
                                                    modifiedTaskToSend.allOccurrences.forEach(
                                                        (occ, index) => {
                                                            console.log(
                                                                `  ${index + 1}. ${occ.title} - dueTimes:`,
                                                                occ.dueTimes,
                                                            );
                                                        },
                                                    );
                                                }
                                            } else {
                                                console.log(
                                                    "🚀 FRONTEND: Regular future edit",
                                                );
                                            }

                                            const requestBody = {
                                                adminEmail: currentAdmin,
                                                originalTitle: originalTitleToUse,
                                                originalStartDate: originalStartDate,
                                                splitDate: splitDate,
                                                modifiedTask: modifiedTaskToSend,
                                            };

                                            console.log(
                                                "🚀 FRONTEND: Sending future edit request:",
                                                JSON.stringify(requestBody, null, 2),
                                            );

                                            const response = await fetch(
                                                "https://beemazing1.onrender.com/api/tasks/future",
                                                {
                                                    method: "PUT",
                                                    headers: {
                                                        "Content-Type": "application/json",
                                                    },
                                                    body: JSON.stringify(requestBody),
                                                },
                                            );

                                            console.log(
                                                "🔧 DEBUG: Backend response status:",
                                                response.status,
                                            );
                                            const data = await response.json();
                                            console.log(
                                                "🔧 DEBUG: Backend response data:",
                                                data,
                                            );

                                            if (!response.ok) {
                                                console.error(
                                                    "🔧 DEBUG: Backend error:",
                                                    data,
                                                );
                                                throw new Error(
                                                    data.error ||
                                                        `HTTP error ${response.status}`,
                                                );
                                            }
                                            alert(
                                                editTask.isOccurrenceGroupEdit
                                                    ? "All future occurrences updated successfully!"
                                                    : "Future occurrences updated successfully!",
                                            );
                                        }
                                    } else if (
                                        (editTitle && editDate) ||
                                        (editTask && editTaskFullDate)
                                    ) {
                                        // Edit entire task mode - smart approach (handles both URL params and localStorage)
                                        console.log("🚨 EDIT ENTIRE TASK TRIGGERED! 🚨");

                                        // Handle both URL-based edits and localStorage-based edits
                                        const taskTitle = editTitle || editTask.title;
                                        const taskDate = editDate || editTaskFullDate;

                                        const originalTitle =
                                            editTask.originalTitle ||
                                            taskTitle.split(" - ")[0] ||
                                            taskTitle;
                                        const originalTimesPerDay =
                                            editTask.totalOccurrences ||
                                            editTask.timesPerDay ||
                                            1;
                                        const currentTimesPerDayField =
                                            parseInt(
                                                document.getElementById("timesPerDayInput")
                                                    .value,
                                            ) || 1;
                                        const newTimesPerDay = tasksToSave.length;

                                        console.log("🔧 Smart edit detection:", {
                                            originalTitle,
                                            originalTimesPerDay,
                                            currentTimesPerDayField,
                                            newTimesPerDay,
                                            fieldChange:
                                                currentTimesPerDayField -
                                                originalTimesPerDay,
                                        });

                                        // EMERGENCY SAFETY CHECK: Only delete if user actually changed the Times per Day field to a lower value
                                        // AND we have explicit confirmation that this was intentional
                                        const shouldDeleteEntire =
                                            currentTimesPerDayField < originalTimesPerDay &&
                                            currentTimesPerDayField === newTimesPerDay &&
                                            confirm(
                                                `⚠️ SAFETY CHECK ⚠️\n\nYou are about to REDUCE Times per Day from ${originalTimesPerDay} to ${currentTimesPerDayField}.\n\nThis will DELETE ALL occurrences and recreate them.\n\nAre you sure you want to continue?`,
                                            );

                                        if (shouldDeleteEntire) {
                                            // DECREASED: Use existing working deleteAllOccurrences function
                                            console.log(
                                                "🔧 User CONFIRMED decrease of Times per Day field - using proven deletion method",
                                            );

                                            // Import deleteAllOccurrences function from tasks.html
                                            const deleteAllOccurrences = async function (
                                                originalTitle,
                                                date,
                                            ) {
                                                const adminEmail =
                                                    localStorage.getItem(
                                                        "currentAdminEmail",
                                                    );
                                                console.log(
                                                    "🗑️ Deleting all occurrences for:",
                                                    { adminEmail, originalTitle, date },
                                                );

                                                try {
                                                    const response = await fetch(
                                                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                                                        { cache: "no-store" },
                                                    );
                                                    if (!response.ok)
                                                        throw new Error(
                                                            "Failed to fetch tasks",
                                                        );

                                                    const result = await response.json();
                                                    const relatedTasks =
                                                        result.tasks.filter(
                                                            (t) =>
                                                                (t.originalTitle ===
                                                                    originalTitle ||
                                                                    t.title.startsWith(
                                                                        originalTitle +
                                                                            " - ",
                                                                    )) &&
                                                                t.date === date,
                                                        );

                                                    console.log(
                                                        "🗑️ Found tasks to delete:",
                                                        relatedTasks.length,
                                                    );
                                                    let deletedCount = 0;

                                                    for (const task of relatedTasks) {
                                                        try {
                                                            const startDate =
                                                                date.split(" to ")[0]; // Extract start date only
                                                            const deleteUrl = `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&title=${encodeURIComponent(task.title)}&date=${encodeURIComponent(startDate)}`;

                                                            const deleteResponse =
                                                                await fetch(deleteUrl, {
                                                                    method: "DELETE",
                                                                    headers: {
                                                                        "Content-Type":
                                                                            "application/json",
                                                                    },
                                                                });

                                                            const deleteData =
                                                                await deleteResponse
                                                                    .json()
                                                                    .catch(() => ({}));

                                                            if (deleteResponse.ok) {
                                                                deletedCount++;
                                                                console.log(
                                                                    "🗑️ Deleted:",
                                                                    task.title,
                                                                );
                                                            } else {
                                                                console.error(
                                                                    "🗑️ Delete failed:",
                                                                    task.title,
                                                                    "Status:",
                                                                    deleteResponse.status,
                                                                    "Error:",
                                                                    deleteData,
                                                                );
                                                            }
                                                        } catch (err) {
                                                            console.error(
                                                                "🗑️ Failed to delete:",
                                                                task.title,
                                                                err,
                                                            );
                                                        }
                                                    }

                                                    console.log(
                                                        `🗑️ Deleted ${deletedCount}/${relatedTasks.length} tasks`,
                                                    );
                                                    return deletedCount;
                                                } catch (error) {
                                                    console.error(
                                                        "🗑️ Delete all occurrences failed:",
                                                        error,
                                                    );
                                                    throw error;
                                                }
                                            };

                                            // Delete all existing occurrences
                                            await deleteAllOccurrences(
                                                originalTitle,
                                                taskDate,
                                            );

                                            // Wait for deletion to process
                                            console.log(
                                                "🔧 Waiting for deletion to process...",
                                            );
                                            await new Promise((resolve) =>
                                                setTimeout(resolve, 2000),
                                            );

                                            // Create new occurrences
                                            console.log(
                                                "🔧 Creating",
                                                newTimesPerDay,
                                                "new occurrences...",
                                            );
                                            let savedCount = 0;
                                            for (const taskToSave of tasksToSave) {
                                                try {
                                                    const saveResponse = await fetch(
                                                        "https://beemazing1.onrender.com/api/tasks",
                                                        {
                                                            method: "POST",
                                                            headers: {
                                                                "Content-Type":
                                                                    "application/json",
                                                            },
                                                            body: JSON.stringify({
                                                                adminEmail: currentAdmin,
                                                                task: taskToSave,
                                                            }),
                                                        },
                                                    );

                                                    if (saveResponse.ok) {
                                                        savedCount++;
                                                        console.log(
                                                            "🔧 Created:",
                                                            taskToSave.title,
                                                        );
                                                    }
                                                } catch (err) {
                                                    console.error(
                                                        "🔧 Create failed:",
                                                        taskToSave.title,
                                                        err,
                                                    );
                                                }
                                            }

                                            alert(
                                                `✅ Task updated successfully!\n\nReduced from ${originalTimesPerDay} to ${currentTimesPerDayField} occurrences\nCreated: ${savedCount} new occurrences`,
                                            );
                                        } else if (
                                            currentTimesPerDayField > originalTimesPerDay
                                        ) {
                                            // INCREASED: Just create additional occurrences (existing approach works)
                                            console.log(
                                                "🔧 User INCREASED Times per Day field - creating additional tasks",
                                            );

                                            let savedCount = 0;
                                            for (const taskToSave of tasksToSave) {
                                                try {
                                                    const saveResponse = await fetch(
                                                        "https://beemazing1.onrender.com/api/tasks",
                                                        {
                                                            method: "POST",
                                                            headers: {
                                                                "Content-Type":
                                                                    "application/json",
                                                            },
                                                            body: JSON.stringify({
                                                                adminEmail: currentAdmin,
                                                                task: taskToSave,
                                                            }),
                                                        },
                                                    );

                                                    if (saveResponse.ok) {
                                                        savedCount++;
                                                        console.log(
                                                            "🔧 Created:",
                                                            taskToSave.title,
                                                        );
                                                    }
                                                } catch (err) {
                                                    console.error(
                                                        "🔧 Create failed:",
                                                        taskToSave.title,
                                                        err,
                                                    );
                                                }
                                            }

                                            alert(
                                                `✅ Task updated successfully!\n\nIncreased from ${originalTimesPerDay} to ${currentTimesPerDayField} occurrences\nCreated: ${savedCount} new occurrences`,
                                            );
                                        } else {
                                            // SAME COUNT or just changing other properties: Regular update
                                            if (
                                                currentTimesPerDayField <
                                                originalTimesPerDay
                                            ) {
                                                console.log(
                                                    "🔧 User CANCELLED deletion - using safe update instead",
                                                );
                                            } else {
                                                console.log(
                                                    "🔧 Times per Day unchanged - using regular update",
                                                );
                                            }
                                            console.log(
                                                "🔧 No deletion needed - just updating properties",
                                            );

                                            let taskToSend = tasksToSave[0];

                                            // Check if this is an occurrence group edit
                                            const isOccurrenceGroupEdit =
                                                editTask.isOccurrenceGroupEdit ||
                                                (editTask.originalTitle &&
                                                    editTask.totalOccurrences > 1) ||
                                                originalTimesPerDay > 1 ||
                                                tasksToSave.length > 1;

                                            if (isOccurrenceGroupEdit) {
                                                console.log(
                                                    "🚀 FRONTEND: Setting up entire occurrence group edit",
                                                );

                                                // For multiple daily occurrences, send all generated tasks
                                                if (tasksToSave.length > 1) {
                                                    console.log(
                                                        `🚀 FRONTEND: Sending ${tasksToSave.length} occurrence tasks for entire edit`,
                                                    );
                                                    taskToSend = {
                                                        ...tasksToSave[0],
                                                        isOccurrenceGroupEdit: true,
                                                        totalOccurrences:
                                                            tasksToSave.length,
                                                        allOccurrences: tasksToSave, // Send all occurrence tasks
                                                    };
                                                } else {
                                                    taskToSend = {
                                                        ...tasksToSave[0],
                                                        isOccurrenceGroupEdit: true,
                                                        totalOccurrences:
                                                            editTask.totalOccurrences ||
                                                            originalTimesPerDay ||
                                                            1,
                                                    };
                                                }
                                            }

                                            const titleToUse = isOccurrenceGroupEdit
                                                ? originalTitle
                                                : taskTitle;

                                            const response = await fetch(
                                                "https://beemazing1.onrender.com/api/tasks",
                                                {
                                                    method: "PUT",
                                                    headers: {
                                                        "Content-Type": "application/json",
                                                    },
                                                    body: JSON.stringify({
                                                        adminEmail: currentAdmin,
                                                        task: taskToSend,
                                                        originalTitle: titleToUse,
                                                        originalDate: taskDate,
                                                    }),
                                                },
                                            );

                                            const data = await response.json();
                                            if (!response.ok)
                                                throw new Error(
                                                    data.error ||
                                                        `HTTP error ${response.status}`,
                                                );
                                            alert(
                                                isOccurrenceGroupEdit
                                                    ? "All occurrences updated successfully!"
                                                    : "Task updated successfully!",
                                            );
                                        }
                                    } else {
                                        // New task(s) - save all generated tasks
                                        console.log("🚨 NEW TASK PATH TRIGGERED! 🚨");
                                        console.log("🔧 Not editing because:", {
                                            hasEditTitle: !!editTitle,
                                            hasEditDate: !!editDate,
                                            hasEditTask: !!editTask,
                                            isFutureEdit: !!isFutureEdit,
                                            isOccurrenceEdit: !!isOccurrenceEdit,
                                        });
                                        let savedCount = 0;
                                        for (const taskToSave of tasksToSave) {
                                            const response = await fetch(
                                                "https://beemazing1.onrender.com/api/tasks",
                                                {
                                                    method: "POST",
                                                    headers: {
                                                        "Content-Type": "application/json",
                                                    },
                                                    body: JSON.stringify({
                                                        adminEmail: currentAdmin,
                                                        task: taskToSave,
                                                    }),
                                                },
                                            );

                                            const data = await response.json();
                                            if (!response.ok)
                                                throw new Error(
                                                    data.error ||
                                                        `HTTP error ${response.status}`,
                                                );
                                            savedCount++;
                                        }

                                        if (tasksToSave.length > 1) {
                                            alert(
                                                `Tasks saved successfully! Created ${savedCount} daily occurrences.`,
                                            );
                                        } else {
                                            alert("Task saved successfully!");
                                        }
                                    }

                                    console.log(
                                        "Server response: All tasks saved successfully",
                                    );

                                    // Store task title in localStorage if coming from onboarding
                                    if (from === "onboarding") {
                                        const existingTitles = JSON.parse(
                                            localStorage.getItem("onboardingTaskTitles") ||
                                                "[]",
                                        );
                                        if (!existingTitles.includes(title)) {
                                            existingTitles.push(title);
                                            localStorage.setItem(
                                                "onboardingTaskTitles",
                                                JSON.stringify(existingTitles),
                                            );
                                        }
                                    }

                                    // Redirect back to the original user's tasks.html or onboarding
                                    const adminEmail = encodeURIComponent(
                                        currentAdmin || "",
                                    );

                                    let redirectUrl;
                                    if (from === "onboarding") {
                                        redirectUrl = `/BeeMazing-A1/onboarding.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}#step4`;
                                    } else if (isOccurrenceEdit || isFutureEdit) {
                                        // Redirect back to tasks.html for specific date views
                                        redirectUrl = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}`;
                                    } else {
                                        redirectUrl = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}`;
                                    }

                                    // Debug logging to track redirect
                                    console.log("🔄 REDIRECT DEBUG:");
                                    console.log("  - isOccurrenceEdit:", isOccurrenceEdit);
                                    console.log("  - isFutureEdit:", isFutureEdit);
                                    console.log("  - from:", from);
                                    console.log("  - adminEmail:", currentAdmin);
                                    console.log("  - originalUser:", originalUser);
                                    console.log("  - Final redirect URL:", redirectUrl);
                                    console.log("  - About to redirect to:", redirectUrl);

                                    // Add cache busting parameter to prevent browser caching issues
                                    const timestamp = Date.now();
                                    const separator = redirectUrl.includes("?") ? "&" : "?";
                                    const finalUrl = `${redirectUrl}${separator}t=${timestamp}`;

                                    console.log(
                                        "  - Final URL with cache busting:",
                                        finalUrl,
                                    );
                                    console.log(
                                        "  - Current page URL:",
                                        window.location.href,
                                    );

                                    // Monitor URL changes to detect if browser changes the URL
                                    const originalHref = window.location.href;
                                    let urlChangeDetected = false;

                                    // Set up monitoring before redirect
                                    const urlMonitor = setInterval(() => {
                                        if (
                                            window.location.href !== originalHref &&
                                            !urlChangeDetected
                                        ) {
                                            urlChangeDetected = true;
                                            console.log("🚨 URL CHANGE DETECTED:");
                                            console.log("  - Original:", originalHref);
                                            console.log(
                                                "  - Current:",
                                                window.location.href,
                                            );
                                            console.log("  - Expected:", finalUrl);

                                            if (
                                                window.location.href.includes("taskz.html")
                                            ) {
                                                console.error(
                                                    "❌ PROBLEM FOUND: Browser navigated to taskz.html instead of tasks.html!",
                                                );
                                                console.error(
                                                    "  - This suggests browser autocomplete or bookmark issue",
                                                );

                                                // Force correct redirect
                                                const correctUrl =
                                                    window.location.href.replace(
                                                        "taskz.html",
                                                        "tasks.html",
                                                    );
                                                console.log(
                                                    "  - Forcing redirect to correct URL:",
                                                    correctUrl,
                                                );
                                                window.location.replace(correctUrl);
                                            }
                                            clearInterval(urlMonitor);
                                        }
                                    }, 100);

                                    // Clear monitor after 5 seconds
                                    setTimeout(() => clearInterval(urlMonitor), 5000);

                                    console.log(
                                        "  - Setting window.location.href to:",
                                        finalUrl,
                                    );

                                    // Force correct URL by explicitly checking and preventing taskz.html
                                    if (finalUrl.includes("taskz.html")) {
                                        console.error(
                                            "❌ CRITICAL: finalUrl contains taskz.html - fixing immediately!",
                                        );
                                        finalUrl = finalUrl.replace(
                                            "taskz.html",
                                            "tasks.html",
                                        );
                                        console.log("  - Corrected finalUrl:", finalUrl);
                                    }

                                    // Use multiple redirect methods to ensure it works
                                    // First method: Direct assignment with validation
                                    const urlBeforeSet = window.location.href;
                                    window.location.href = finalUrl;

                                    // Immediate verification
                                    setTimeout(() => {
                                        if (window.location.href.includes("taskz.html")) {
                                            console.error(
                                                "❌ Method 1 failed - using replace method",
                                            );
                                            const correctUrl = finalUrl.replace(
                                                "taskz.html",
                                                "tasks.html",
                                            );
                                            window.location.replace(correctUrl);
                                        }
                                    }, 5);

                                    // Secondary verification
                                    setTimeout(() => {
                                        if (window.location.href.includes("taskz.html")) {
                                            console.error(
                                                "❌ Method 2 failed - forcing correct navigation",
                                            );
                                            // Build completely fresh URL to avoid any cached references
                                            const params = new URLSearchParams();
                                            params.append(
                                                "admin",
                                                encodeURIComponent(currentAdmin || ""),
                                            );
                                            params.append(
                                                "user",
                                                encodeURIComponent(originalUser),
                                            );
                                            params.append("t", Date.now().toString());

                                            const freshUrl = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?${params.toString()}`;
                                            console.log("  - Using fresh URL:", freshUrl);
                                            window.location.assign(freshUrl);
                                        }
                                    }, 50);
                                } catch (error) {
                                    console.error("Error saving task:", error);
                                    alert(`Failed to save task: ${error.message}`);
                                } finally {
                                    // Re-enable submit button
                                    submitButton.disabled = false;
                                    submitButton.textContent = "SAVE";
                                }
                            });
                        });

                        const repeatModal = document.getElementById("repeatModal");
                        const repeatButton = document.getElementById("selectRepeat");
                        const repeatInput = document.getElementById("repeatSelection");
                        const timesPerDayGroup =
                            document.getElementById("timesPerDayGroup");
                        const timesPerWeekGroup =
                            document.getElementById("timesPerWeekGroup");
                        const timesPerMonthGroup =
                            document.getElementById("timesPerMonthGroup");

                        repeatButton.addEventListener("click", () => {
                            showModal(repeatModal);
                        });

                        window.addEventListener("click", (e) => {
                            if (e.target === repeatModal) {
                                hideModal(repeatModal);
                            }
                        });

                        repeatModal.addEventListener("click", (e) => {
                            if (e.target.tagName === "LI") {
                                const selected = e.target.getAttribute("data-value");
                                repeatInput.value = selected;
                                repeatButton.textContent = selected;
                                hideModal(repeatModal);

                                // Show/hide correct "x times" groups and date sections
                                timesPerDayGroup.style.display =
                                    selected === "Daily" ? "flex" : "none";
                                timesPerWeekGroup.style.display =
                                    selected === "Weekly" ? "flex" : "none";
                                timesPerMonthGroup.style.display =
                                    selected === "Monthly" ? "flex" : "none";

                                // Hide due time for Occasional tasks
                                const dueTimeContainer =
                                    document.getElementById("dueTimeContainer");
                                const dueTimeToggle =
                                    document.getElementById("dueTimeToggle");
                                if (selected === "Occasional") {
                                    dueTimeToggle.checked = false;
                                    dueTimeContainer.style.display = "none";
                                }

                                // Show/hide date UI based on frequency selection
                                const monthlyTimesDateGroup = document.getElementById(
                                    "monthlyTimesDateGroup",
                                );
                                const monthlySchedulingOptions = document.getElementById(
                                    "monthlySchedulingOptions",
                                );
                                const generalDateModeSelector = document.getElementById(
                                    "generalDateModeSelector",
                                );
                                const fromToDateGroupEl =
                                    document.getElementById("fromToDateGroup");
                                const specificDaysGroupEl =
                                    document.getElementById("specificDaysGroup");
                                const specificDatesGroupEl =
                                    document.getElementById("specificDatesGroup");
                                const defaultDateSelector = document.getElementById(
                                    "defaultDateSelector",
                                );
                                const singleDateGroup =
                                    document.getElementById("singleDateGroup");

                                // Hide default selector when frequency is chosen
                                defaultDateSelector.style.display = "none";

                                if (selected === "One Time") {
                                    // Show single date UI for One Time tasks
                                    generalDateModeSelector.style.display = "none";
                                    singleDateGroup.style.display = "block";
                                    fromToDateGroupEl.style.display = "none";
                                    specificDaysGroupEl.style.display = "none";
                                    specificDatesGroupEl.style.display = "none";
                                    monthlyTimesDateGroup.style.setProperty(
                                        "display",
                                        "none",
                                        "important",
                                    );
                                    monthlySchedulingOptions.style.setProperty(
                                        "display",
                                        "none",
                                        "important",
                                    );

                                    // Initialize single date display with today's date
                                    const today = new Date();
                                    window.flatpickrSingle.setDate(today);
                                    document.getElementById(
                                        "singleDateDisplay",
                                    ).textContent = today.toLocaleDateString(undefined, {
                                        month: "long",
                                        day: "numeric",
                                    });
                                } else if (selected === "Occasional") {
                                    // Hide all date UI for Occasional tasks
                                    generalDateModeSelector.style.display = "none";
                                    singleDateGroup.style.display = "none";
                                    fromToDateGroupEl.style.display = "none";
                                    specificDaysGroupEl.style.display = "none";
                                    specificDatesGroupEl.style.display = "none";
                                    monthlyTimesDateGroup.style.setProperty(
                                        "display",
                                        "none",
                                        "important",
                                    );
                                    monthlySchedulingOptions.style.setProperty(
                                        "display",
                                        "none",
                                        "important",
                                    );
                                    // Keep defaultDateSelector hidden for Occasional
                                    defaultDateSelector.style.display = "none";
                                } else if (selected === "Monthly") {
                                    // Check which monthly option is selected
                                    const checkedMonthlyOption = document.querySelector(
                                        'input[name="monthlyOption"]:checked',
                                    );
                                    if (
                                        checkedMonthlyOption &&
                                        checkedMonthlyOption.value === "times"
                                    ) {
                                        // Show monthly times UI
                                        generalDateModeSelector.style.display = "none";
                                        fromToDateGroupEl.style.display = "none";
                                        specificDaysGroupEl.style.display = "none";
                                        specificDatesGroupEl.style.display = "none";
                                        monthlyTimesDateGroup.style.setProperty(
                                            "display",
                                            "block",
                                            "important",
                                        );
                                        monthlySchedulingOptions.style.setProperty(
                                            "display",
                                            "flex",
                                            "important",
                                        );
                                        generateMonthlySchedulingFields();
                                    } else {
                                        // Show regular interval UI
                                        generalDateModeSelector.style.display = "none";
                                        fromToDateGroupEl.style.display = "block";
                                        specificDaysGroupEl.style.display = "none";
                                        specificDatesGroupEl.style.display = "none";
                                        monthlyTimesDateGroup.style.setProperty(
                                            "display",
                                            "none",
                                            "important",
                                        );
                                        monthlySchedulingOptions.style.setProperty(
                                            "display",
                                            "none",
                                            "important",
                                        );
                                    }
                                } else {
                                    // Show regular date mode selector for Daily/Weekly frequencies
                                    monthlyTimesDateGroup.style.setProperty(
                                        "display",
                                        "none",
                                        "important",
                                    );
                                    monthlySchedulingOptions.style.setProperty(
                                        "display",
                                        "none",
                                        "important",
                                    );
                                    singleDateGroup.style.display = "none";
                                    generalDateModeSelector.style.display = "flex";
                                    fromToDateGroupEl.style.display = "block";
                                    specificDaysGroupEl.style.display = "block";
                                    specificDatesGroupEl.style.display = "none";
                                }

                                // Update section label and Any/All button based on frequency
                                const sectionLabel =
                                    document.getElementById("sectionLabel");
                                const anyAllButton =
                                    document.getElementById("anyAllButton");
                                // Ensure the day button update happens immediately
                                if (anyAllButton) {
                                    if (selected === "Daily") {
                                        anyAllButton.textContent = "All";
                                        anyAllButton.setAttribute("data-day", "All");
                                        anyAllButton.setAttribute(
                                            "title",
                                            "All 7 days (Mon-Sun)",
                                        );
                                        if (sectionLabel) sectionLabel.textContent = "Days";

                                        // Convert Any to All if it's currently selected, or set default
                                        if (
                                            selectedDays.includes("Any") ||
                                            selectedDays.length === 0
                                        ) {
                                            selectedDays = ["All"];
                                            updateSelectedDaysDisplay();
                                        }
                                    } else {
                                        anyAllButton.textContent = "Any";
                                        anyAllButton.setAttribute("data-day", "Any");
                                        anyAllButton.setAttribute(
                                            "title",
                                            "Any day (flexible scheduling)",
                                        );
                                        if (sectionLabel)
                                            sectionLabel.textContent = "Dates";

                                        // Convert All to Any if it's currently selected, or set default
                                        if (
                                            selectedDays.includes("All") ||
                                            (selectedDays.length === 7 &&
                                                [
                                                    "Monday",
                                                    "Tuesday",
                                                    "Wednesday",
                                                    "Thursday",
                                                    "Friday",
                                                    "Saturday",
                                                    "Sunday",
                                                ].every((day) =>
                                                    selectedDays.includes(day),
                                                ))
                                        ) {
                                            selectedDays = ["Any"];
                                            updateSelectedDaysDisplay();
                                        }
                                    }
                                }

                                // Date sections are now handled above in the main frequency logic

                                // Update settings modal to hide/show rotation option
                                updateSettingsModal();

                                // Set initial value to 1
                                if (selected === "Daily") timesPerDayInput.value = "1";
                                if (selected === "Weekly") {
                                    document.getElementById("timesPerWeekInput").value =
                                        "1";
                                    // Reset weekly button styles to show "1" selected
                                    weekOptionBtns.forEach((b) => {
                                        b.style.background = "var(--light-bg)";
                                        b.style.color = "var(--text-color)";
                                    });
                                    document.querySelector(
                                        '.week-option-btn[data-value="1"]',
                                    ).style.background = "var(--primary-color)";
                                    document.querySelector(
                                        '.week-option-btn[data-value="1"]',
                                    ).style.color = "var(--secondary-color)";
                                    // Update day selection for weekly
                                    updateDaySelectionForWeekly();
                                    // Also update specific dates validation
                                    updateSpecificDatesForWeekly();
                                }
                                if (selected === "Monthly") {
                                    document.getElementById("timesPerMonthInput").value =
                                        "1";
                                    document.getElementById("monthIntervalInput").value =
                                        "1";
                                    // Reset to "times per month" option
                                    const timesRadio = document.querySelector(
                                        'input[name="monthlyOption"][value="times"]',
                                    );
                                    timesRadio.checked = true;

                                    // Trigger change event to update visual states
                                    timesRadio.dispatchEvent(new Event("change"));
                                }
                            }
                        });

                        const timesPerDayInput =
                            document.getElementById("timesPerDayInput");
                        const timesPerDayModal =
                            document.getElementById("timesPerDayModal");
                        const closeTimesModal = document.getElementById("closeTimesModal");
                        const saveCustomTimesBtn =
                            document.getElementById("saveCustomTimesBtn");
                        const customTimesInput =
                            document.getElementById("customTimesInput");

                        // Direct input functionality for times per day (no modal needed)
                        const decreaseBtn = document.getElementById("decreaseTimesPerDay");
                        const increaseBtn = document.getElementById("increaseTimesPerDay");

                        decreaseBtn.addEventListener("click", () => {
                            let currentValue = parseInt(timesPerDayInput.value) || 1;
                            if (currentValue > 1) {
                                timesPerDayInput.value = currentValue - 1;
                                timesPerDayInput.dispatchEvent(new Event("change"));
                            }
                        });

                        increaseBtn.addEventListener("click", () => {
                            let currentValue = parseInt(timesPerDayInput.value) || 1;
                            if (currentValue < 100) {
                                timesPerDayInput.value = currentValue + 1;
                                timesPerDayInput.dispatchEvent(new Event("change"));
                            }
                        });

                        // Add hover effects for stepper buttons
                        decreaseBtn.addEventListener("mouseenter", () => {
                            decreaseBtn.style.background = "var(--primary-color)";
                            decreaseBtn.style.color = "var(--secondary-color)";
                        });
                        decreaseBtn.addEventListener("mouseleave", () => {
                            decreaseBtn.style.background = "var(--light-bg)";
                            decreaseBtn.style.color = "var(--text-color)";
                        });

                        increaseBtn.addEventListener("mouseenter", () => {
                            increaseBtn.style.background = "var(--primary-color)";
                            increaseBtn.style.color = "var(--secondary-color)";
                        });
                        increaseBtn.addEventListener("mouseleave", () => {
                            increaseBtn.style.background = "var(--light-bg)";
                            increaseBtn.style.color = "var(--text-color)";
                        });

                        // Validate input on change
                        timesPerDayInput.addEventListener("input", () => {
                            let value = parseInt(timesPerDayInput.value) || 1;
                            if (value < 1) value = 1;
                            if (value > 100) value = 100;
                            timesPerDayInput.value = value;
                        });

                        // OLD MODAL FUNCTIONALITY COMMENTED OUT - NO LONGER NEEDED FOR TIMES PER DAY
                        /*
            // Quick pick buttons (1–5)
            timesPerDayModal.querySelectorAll("button[data-value]").forEach(btn => {
                btn.addEventListener("click", () => {
                    timesPerDayInput.value = btn.getAttribute("data-value");
                    hideModal(timesPerDayModal);
                });
            });

            // Custom input save
            saveCustomTimesBtn.addEventListener("click", () => {
                let val = customTimesInput.value.trim();
                if (val && parseInt(val) > 0) {
                    val = Math.min(parseInt(val), 100); // cap at 100
                    timesPerDayInput.value = val;
                    hideModal(timesPerDayModal);
                }
            });


            // Close modal
            closeTimesModal.addEventListener("click", () => {
                hideModal(timesPerDayModal);
            });


            // Existing setup for Daily
            setupTimesModal(
                document.getElementById("timesPerDayInput"),
                document.getElementById("timesPerDayModal"),
                document.getElementById("closeTimesModal"),
                document.getElementById("customTimesInput"),
                document.getElementById("saveCustomTimesBtn")
            );
            */

                        // Existing setup for Monthly

                        // NEW: Setup for Weekly (button options)
                        const timesPerWeekInput =
                            document.getElementById("timesPerWeekInput");
                        const weekOptionBtns =
                            document.querySelectorAll(".week-option-btn");

                        weekOptionBtns.forEach((btn) => {
                            btn.addEventListener("click", () => {
                                const value = btn.getAttribute("data-value");
                                timesPerWeekInput.value = value;

                                // Update button styles
                                weekOptionBtns.forEach((b) => {
                                    b.style.background = "var(--light-bg)";
                                    b.style.color = "var(--text-color)";
                                });
                                btn.style.background = "var(--primary-color)";
                                btn.style.color = "var(--secondary-color)";

                                // Update day selection limit for weekly frequency
                                updateDaySelectionForWeekly();

                                // Also update specific dates validation if in specific dates mode
                                updateSpecificDatesForWeekly();
                            });
                        });

                        // Function to update day selection based on weekly frequency
                        function updateDaySelectionForWeekly() {
                            const repeatSelection =
                                document.getElementById("repeatSelection");
                            const timesPerWeekValue = parseInt(
                                document.getElementById("timesPerWeekInput").value,
                            );

                            if (
                                repeatSelection &&
                                repeatSelection.value === "Weekly" &&
                                timesPerWeekValue
                            ) {
                                // If we have more days selected than allowed, reset to "Any"
                                const nonSpecialDays = selectedDays.filter(
                                    (day) => day !== "Any" && day !== "All",
                                );
                                if (nonSpecialDays.length > timesPerWeekValue) {
                                    selectedDays = ["Any"];
                                    updateSelectedDaysDisplay();
                                }
                            }
                        }

                        // Function to update specific dates validation when weekly frequency changes
                        function updateSpecificDatesForWeekly() {
                            const repeatSelection =
                                document.getElementById("repeatSelection");
                            const dateModeSelection =
                                document.getElementById("dateModeSelection");

                            if (
                                repeatSelection &&
                                repeatSelection.value === "Weekly" &&
                                dateModeSelection &&
                                dateModeSelection.value === "specific-dates" &&
                                selectedDates.length > 0
                            ) {
                                // Validate current selection against new frequency limit
                                if (!validateWeeklyFrequencyForDates(selectedDates)) {
                                    // If validation fails, clear the selection
                                    selectedDates = [];
                                    if (typeof flatpickrSpecific !== "undefined") {
                                        flatpickrSpecific.clear();
                                    }
                                    updateSelectedDatesDisplay();
                                }
                            }
                        }

                        // Monthly option controls
                        const monthlyOptions = document.querySelectorAll(
                            'input[name="monthlyOption"]',
                        );
                        const decrementMonthBtn = document.getElementById(
                            "decrementMonthInterval",
                        );
                        const incrementMonthBtn = document.getElementById(
                            "incrementMonthInterval",
                        );
                        const decrementTimesMonthBtn = document.getElementById(
                            "decrementTimesMonth",
                        );
                        const incrementTimesMonthBtn = document.getElementById(
                            "incrementTimesMonth",
                        );
                        const monthIntervalInput =
                            document.getElementById("monthIntervalInput");
                        const timesPerMonthInput =
                            document.getElementById("timesPerMonthInput");

                        // Variable to store previous date mode when switching to interval
                        let previousDateMode = "date";

                        // Handle monthly option radio button changes
                        monthlyOptions.forEach((radio) => {
                            radio.addEventListener("change", () => {
                                const timesContainer =
                                    document.getElementById("timesOption");
                                const intervalContainer =
                                    document.getElementById("intervalOption");
                                const generalDateModeSelector = document.getElementById(
                                    "generalDateModeSelector",
                                );
                                const specificDaysGroup =
                                    document.getElementById("specificDaysGroup");
                                const specificDatesGroup =
                                    document.getElementById("specificDatesGroup");
                                const fromToDateGroup =
                                    document.getElementById("fromToDateGroup");
                                const monthlyTimesDateGroup = document.getElementById(
                                    "monthlyTimesDateGroup",
                                );
                                const monthlySchedulingOptions = document.getElementById(
                                    "monthlySchedulingOptions",
                                );
                                const dateModeInput =
                                    document.getElementById("dateModeSelection");

                                if (radio.value === "times") {
                                    // Enable times per month option
                                    timesPerMonthInput.disabled = false;
                                    decrementTimesMonthBtn.disabled = false;
                                    incrementTimesMonthBtn.disabled = false;
                                    monthIntervalInput.disabled = true;
                                    document.getElementById(
                                        "decrementMonthInterval",
                                    ).disabled = true;
                                    document.getElementById(
                                        "incrementMonthInterval",
                                    ).disabled = true;

                                    // Visual feedback
                                    timesPerMonthInput.style.opacity = "1";
                                    decrementTimesMonthBtn.style.opacity = "1";
                                    incrementTimesMonthBtn.style.opacity = "1";
                                    monthIntervalInput.style.opacity = "0.5";
                                    document.getElementById(
                                        "decrementMonthInterval",
                                    ).style.opacity = "0.5";
                                    document.getElementById(
                                        "incrementMonthInterval",
                                    ).style.opacity = "0.5";

                                    // Update label opacity
                                    timesContainer.querySelector(
                                        ".option-label",
                                    ).style.opacity = "1";
                                    intervalContainer.querySelector(
                                        ".option-label",
                                    ).style.opacity = "0.5";
                                    intervalContainer.querySelector(
                                        ".month-text",
                                    ).style.opacity = "0.5";

                                    // Container styling
                                    timesContainer.style.borderColor =
                                        "var(--primary-color)";
                                    timesContainer.style.boxShadow =
                                        "0 2px 6px rgba(255, 193, 7, 0.1)";
                                    intervalContainer.style.borderColor =
                                        "rgba(255, 193, 7, 0.3)";
                                    intervalContainer.style.boxShadow =
                                        "0 2px 6px rgba(255, 193, 7, 0.05)";

                                    // Hide general date mode selector and show monthly times UI
                                    generalDateModeSelector.style.display = "none";
                                    specificDaysGroup.style.display = "none";
                                    specificDatesGroup.style.display = "none";
                                    fromToDateGroup.style.display = "none";
                                    monthlyTimesDateGroup.style.setProperty(
                                        "display",
                                        "block",
                                        "important",
                                    );
                                    monthlySchedulingOptions.style.setProperty(
                                        "display",
                                        "flex",
                                        "important",
                                    );

                                    // Generate monthly scheduling fields based on current times per month value
                                    generateMonthlySchedulingFields();
                                } else {
                                    // Enable interval option (Once every)
                                    timesPerMonthInput.disabled = true;
                                    decrementTimesMonthBtn.disabled = true;
                                    incrementTimesMonthBtn.disabled = true;
                                    monthIntervalInput.disabled = false;
                                    document.getElementById(
                                        "decrementMonthInterval",
                                    ).disabled = false;
                                    document.getElementById(
                                        "incrementMonthInterval",
                                    ).disabled = false;

                                    // Visual feedback
                                    timesPerMonthInput.style.opacity = "0.5";
                                    decrementTimesMonthBtn.style.opacity = "0.5";
                                    incrementTimesMonthBtn.style.opacity = "0.5";
                                    monthIntervalInput.style.opacity = "1";
                                    document.getElementById(
                                        "decrementMonthInterval",
                                    ).style.opacity = "1";
                                    document.getElementById(
                                        "incrementMonthInterval",
                                    ).style.opacity = "1";

                                    // Update label opacity
                                    timesContainer.querySelector(
                                        ".option-label",
                                    ).style.opacity = "0.5";
                                    intervalContainer.querySelector(
                                        ".option-label",
                                    ).style.opacity = "1";
                                    intervalContainer.querySelector(
                                        ".month-text",
                                    ).style.opacity = "1";

                                    // Container styling
                                    intervalContainer.style.borderColor =
                                        "var(--primary-color)";
                                    intervalContainer.style.boxShadow =
                                        "0 2px 6px rgba(255, 193, 7, 0.1)";
                                    timesContainer.style.borderColor =
                                        "rgba(255, 193, 7, 0.3)";

                                    // Hide monthly times UI and show regular From/To date UI
                                    generalDateModeSelector.style.display = "none";
                                    specificDaysGroup.style.display = "none";
                                    specificDatesGroup.style.display = "none";
                                    monthlyTimesDateGroup.style.setProperty(
                                        "display",
                                        "none",
                                        "important",
                                    );
                                    monthlySchedulingOptions.style.setProperty(
                                        "display",
                                        "none",
                                        "important",
                                    );
                                    fromToDateGroup.style.display = "block";

                                    // Set date mode to 'date' for interval option
                                    dateModeInput.value = "date";
                                    document
                                        .querySelectorAll(".mode-btn")
                                        .forEach((btn) => btn.classList.remove("active"));
                                    document
                                        .querySelector('.mode-btn[data-mode="date"]')
                                        .classList.add("active");
                                    timesContainer.style.boxShadow =
                                        "0 2px 6px rgba(255, 193, 7, 0.05)";
                                }
                            });
                        });

                        // Increment/decrement controls for times per month
                        decrementTimesMonthBtn.addEventListener("click", () => {
                            let currentVal = parseInt(timesPerMonthInput.value) || 1;
                            if (currentVal > 1) {
                                timesPerMonthInput.value = currentVal - 1;
                                // Regenerate fields if times per month option is active
                                if (
                                    document.querySelector(
                                        'input[name="monthlyOption"]:checked',
                                    ).value === "times"
                                ) {
                                    generateMonthlySchedulingFields();
                                }
                            }
                        });

                        incrementTimesMonthBtn.addEventListener("click", () => {
                            let currentVal = parseInt(timesPerMonthInput.value) || 1;
                            if (currentVal < 31) {
                                timesPerMonthInput.value = currentVal + 1;
                                // Regenerate fields if times per month option is active
                                if (
                                    document.querySelector(
                                        'input[name="monthlyOption"]:checked',
                                    ).value === "times"
                                ) {
                                    generateMonthlySchedulingFields();
                                }
                            }
                        });

                        timesPerMonthInput.addEventListener("input", () => {
                            let val = parseInt(timesPerMonthInput.value);
                            if (isNaN(val) || val < 1) {
                                timesPerMonthInput.value = 1;
                            } else if (val > 31) {
                                timesPerMonthInput.value = 31;
                            }
                        });

                        // Increment/decrement controls for month interval
                        decrementMonthBtn.addEventListener("click", () => {
                            let currentVal = parseInt(monthIntervalInput.value) || 1;
                            if (currentVal > 1) {
                                monthIntervalInput.value = currentVal - 1;
                            }
                        });

                        incrementMonthBtn.addEventListener("click", () => {
                            let currentVal = parseInt(monthIntervalInput.value) || 1;
                            if (currentVal < 12) {
                                monthIntervalInput.value = currentVal + 1;
                            }
                        });

                        // Initialize monthly options state
                        // Function to generate monthly scheduling fields based on times per month
                        function generateMonthlySchedulingFields() {
                            const timesPerMonth =
                                parseInt(
                                    document.getElementById("timesPerMonthInput").value,
                                ) || 1;
                            const daysOfMonthContainer =
                                document.getElementById("daysOfMonthFields");
                            const daysOfWeekContainer =
                                document.getElementById("daysOfWeekFields");

                            // Clear existing fields
                            daysOfMonthContainer.innerHTML = "";
                            daysOfWeekContainer.innerHTML = "";

                            // Generate days of month fields
                            for (let i = 1; i <= timesPerMonth; i++) {
                                const ordinal = getOrdinal(i);
                                const fieldHtml = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="min-width: 35px; font-weight: 500; color: var(--text-color);">${ordinal}:</span>
                            <select class="day-of-month-select" data-index="${i}" style="flex: 1; padding: 6px 8px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); font-size: 14px; color: var(--text-color);">
                                <option value="1">1st</option>
                                <option value="2">2nd</option>
                                <option value="3">3rd</option>
                                <option value="4">4th</option>
                                <option value="5">5th</option>
                                <option value="6">6th</option>
                                <option value="7">7th</option>
                                <option value="8">8th</option>
                                <option value="9">9th</option>
                                <option value="10">10th</option>
                                <option value="11">11th</option>
                                <option value="12">12th</option>
                                <option value="13">13th</option>
                                <option value="14">14th</option>
                                <option value="15">15th</option>
                                <option value="16">16th</option>
                                <option value="17">17th</option>
                                <option value="18">18th</option>
                                <option value="19">19th</option>
                                <option value="20">20th</option>
                                <option value="21">21st</option>
                                <option value="22">22nd</option>
                                <option value="23">23rd</option>
                                <option value="24">24th</option>
                                <option value="25">25th</option>
                                <option value="26">26th</option>
                                <option value="27">27th</option>
                                <option value="28">28th</option>
                                <option value="29">29th</option>
                                <option value="30">30th</option>
                                <option value="31">31st</option>
                                <option value="last">Last</option>
                            </select>
                            <span style="color: var(--text-color);">day of the month</span>
                        </div>
                    `;
                                daysOfMonthContainer.insertAdjacentHTML(
                                    "beforeend",
                                    fieldHtml,
                                );
                            }

                            // Generate days of week fields
                            for (let i = 1; i <= timesPerMonth; i++) {
                                const ordinal = getOrdinal(i);
                                const fieldHtml = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="min-width: 35px; font-weight: 500; color: var(--text-color);">${ordinal}:</span>
                            <select class="week-occurrence-select" data-index="${i}" style="padding: 6px 8px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); font-size: 14px; color: var(--text-color);">
                                <option value="1">1st</option>
                                <option value="2">2nd</option>
                                <option value="3">3rd</option>
                                <option value="4">4th</option>
                                <option value="5">5th</option>
                                <option value="last">Last</option>
                            </select>
                            <select class="weekday-select" data-index="${i}" style="flex: 1; padding: 6px 8px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--light-bg); font-size: 14px; color: var(--text-color);">
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                    `;
                                daysOfWeekContainer.insertAdjacentHTML(
                                    "beforeend",
                                    fieldHtml,
                                );
                            }
                        }

                        // Helper function to get ordinal numbers
                        function getOrdinal(num) {
                            const suffixes = ["th", "st", "nd", "rd"];
                            const v = num % 100;
                            return (
                                num +
                                (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0])
                            );
                        }

                        // Handle monthly scheduling checkbox changes
                        // Handle monthly date display clicks
                        document
                            .getElementById("monthlyDateDisplay")
                            .addEventListener("click", () => {
                                flatpickrMonthlyFrom.open();
                            });

                        document
                            .getElementById("monthlyDateDisplayTo")
                            .addEventListener("click", () => {
                                flatpickrMonthlyTo.open();
                            });

                        // Handle monthly end date add/remove
                        document
                            .getElementById("addMonthlyEndDateBtn")
                            .addEventListener("click", () => {
                                document.getElementById(
                                    "monthlyDateToWrapper",
                                ).style.display = "inline";
                                document.getElementById(
                                    "monthlyDateDisplayTo",
                                ).style.display = "inline-block";
                                document.getElementById(
                                    "removeMonthlyEndDateBtn",
                                ).style.display = "inline";
                                document.getElementById(
                                    "addMonthlyEndDateBtn",
                                ).style.display = "none";
                                // Open calendar immediately
                                flatpickrMonthlyTo.open();
                            });

                        document
                            .getElementById("removeMonthlyEndDateBtn")
                            .addEventListener("click", () => {
                                document.getElementById("monthlyTaskDateTo").value = "";
                                document.getElementById(
                                    "monthlyDateDisplayTo",
                                ).textContent = "To Date";
                                document.getElementById(
                                    "monthlyDateToWrapper",
                                ).style.display = "none";
                                document.getElementById(
                                    "monthlyDateDisplayTo",
                                ).style.display = "none";
                                document.getElementById(
                                    "removeMonthlyEndDateBtn",
                                ).style.display = "none";
                                document.getElementById(
                                    "addMonthlyEndDateBtn",
                                ).style.display = "inline-block";
                                flatpickrMonthlyTo.clear();
                            });

                        document.addEventListener("change", (e) => {
                            if (e.target.id === "specificDaysOfMonthCheckbox") {
                                const daysOfWeekCheckbox = document.getElementById(
                                    "specificDaysOfWeekCheckbox",
                                );
                                const daysOfMonthFields =
                                    document.getElementById("daysOfMonthFields");
                                const daysOfWeekFields =
                                    document.getElementById("daysOfWeekFields");

                                if (e.target.checked) {
                                    daysOfWeekCheckbox.checked = false;
                                    daysOfMonthFields.style.display = "flex";
                                    daysOfWeekFields.style.display = "none";
                                } else {
                                    daysOfMonthFields.style.display = "none";
                                }
                            }

                            if (e.target.id === "specificDaysOfWeekCheckbox") {
                                const daysOfMonthCheckbox = document.getElementById(
                                    "specificDaysOfMonthCheckbox",
                                );
                                const daysOfMonthFields =
                                    document.getElementById("daysOfMonthFields");
                                const daysOfWeekFields =
                                    document.getElementById("daysOfWeekFields");

                                if (e.target.checked) {
                                    daysOfMonthCheckbox.checked = false;
                                    daysOfWeekFields.style.display = "flex";
                                    daysOfMonthFields.style.display = "none";
                                } else {
                                    daysOfWeekFields.style.display = "none";
                                }
                            }
                        });

                        // Functions to collect monthly scheduling data
                        function getMonthlyDaysOfMonthData() {
                            const selects = document.querySelectorAll(
                                ".day-of-month-select",
                            );
                            const data = [];
                            selects.forEach((select) => {
                                if (select.value) {
                                    data.push(select.value);
                                }
                            });
                            return data.join(",");
                        }

                        function getMonthlyDaysOfWeekData() {
                            const occurrenceSelects = document.querySelectorAll(
                                ".week-occurrence-select",
                            );
                            const weekdaySelects =
                                document.querySelectorAll(".weekday-select");
                            const data = [];

                            for (let i = 0; i < occurrenceSelects.length; i++) {
                                const occurrence = occurrenceSelects[i].value;
                                const weekday = weekdaySelects[i].value;
                                if (occurrence && weekday) {
                                    data.push(`${occurrence}:${weekday}`);
                                }
                            }
                            return data.join(",");
                        }

                        document.addEventListener("DOMContentLoaded", () => {
                            // Ensure monthly elements are hidden on load
                            document
                                .getElementById("monthlyTimesDateGroup")
                                .style.setProperty("display", "none", "important");
                            document
                                .getElementById("monthlySchedulingOptions")
                                .style.setProperty("display", "none", "important");

                            const timesRadio = document.querySelector(
                                'input[name="monthlyOption"][value="times"]',
                            );
                            const repeatSelection =
                                document.getElementById("repeatSelection");

                            // Only trigger change if Monthly is actually selected
                            if (
                                timesRadio &&
                                timesRadio.checked &&
                                repeatSelection &&
                                repeatSelection.value === "Monthly"
                            ) {
                                timesRadio.dispatchEvent(new Event("change"));
                            }

                            // Add click handler for Select Dates button
                            document
                                .getElementById("selectDatesBtn")
                                .addEventListener("click", () => {
                                    const repeatSelection =
                                        document.getElementById("repeatSelection");
                                    const currentFrequency = repeatSelection
                                        ? repeatSelection.value
                                        : "";

                                    if (!currentFrequency || currentFrequency === "") {
                                        // Show popup to select frequency first
                                        showFrequencyFirstPopup();
                                    } else if (currentFrequency === "Occasional") {
                                        // Show popup that Occasional tasks don't need date selection
                                        showOccasionalInfoPopup();
                                    } else {
                                        // Frequency is selected, trigger the appropriate date UI
                                        const event = new Event("click");
                                        const li = document.createElement("li");
                                        li.setAttribute("data-value", currentFrequency);
                                        li.dispatchEvent = () => {
                                            repeatSelection.dispatchEvent(
                                                new Event("change"),
                                            );
                                        };
                                        li.dispatchEvent();
                                    }
                                });
                        });

                        // Function to show popup asking user to select frequency first
                        function showFrequencyFirstPopup() {
                            const popup = document.createElement("div");
                            popup.className = "center-warning-popup";
                            popup.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: var(--light-bg);
                    border: 2px solid var(--primary-color);
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                    z-index: 10000;
                    text-align: center;
                    max-width: 300px;
                    width: 90%;
                `;

                            popup.innerHTML = `
                    <div style="font-size: 16px; font-weight: 600; color: var(--text-color); margin-bottom: 15px;">
                        Please select frequency first
                    </div>
                    <div style="font-size: 14px; color: var(--text-color); opacity: 0.8;">
                        Choose how often this task repeats, then date options will be available.
                    </div>
                `;

                            // Create backdrop overlay
                            const backdrop = document.createElement("div");
                            backdrop.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.3);
                    z-index: 9999;
                `;

                            // Make backdrop closable by clicking anywhere
                            backdrop.addEventListener("click", () => {
                                backdrop.remove();
                            });

                            // Prevent popup from closing when clicking on the popup itself
                            popup.addEventListener("click", (e) => {
                                e.stopPropagation();
                            });

                            backdrop.appendChild(popup);
                            document.body.appendChild(backdrop);

                            // Auto-remove after 3 seconds
                            setTimeout(() => {
                                if (popup.parentElement) {
                                    popup.remove();
                                }
                            }, 3000);
                        }

                        // Function to show info popup for Occasional tasks
                        function showOccasionalInfoPopup() {
                            const popup = document.createElement("div");
                            popup.className = "center-warning-popup";
                            popup.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: var(--light-bg);
                    border: 2px solid var(--primary-color);
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
                    z-index: 10000;
                    text-align: center;
                    max-width: 300px;
                    width: 90%;
                `;

                            popup.innerHTML = `
                    <div style="font-size: 16px; font-weight: 600; color: var(--text-color); margin-bottom: 15px;">
                        Occasional Tasks
                    </div>
                    <div style="font-size: 14px; color: var(--text-color); opacity: 0.8;">
                        No date selection needed. These tasks can be activated anytime as required.
                    </div>
                `;

                            // Create backdrop overlay
                            const backdrop = document.createElement("div");
                            backdrop.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.3);
                    z-index: 9999;
                `;

                            // Make backdrop closable by clicking anywhere
                            backdrop.addEventListener("click", () => {
                                backdrop.remove();
                            });

                            // Prevent popup from closing when clicking on the popup itself
                            popup.addEventListener("click", (e) => {
                                e.stopPropagation();
                            });

                            backdrop.appendChild(popup);
                            document.body.appendChild(backdrop);

                            // Auto-remove after 3 seconds
                            setTimeout(() => {
                                if (backdrop.parentElement) {
                                    backdrop.remove();
                                }
                            }, 3000);
                        }

                        monthIntervalInput.addEventListener("input", () => {
                            let val = parseInt(monthIntervalInput.value);
                            if (isNaN(val) || val < 1) {
                                monthIntervalInput.value = 1;
                            } else if (val > 12) {
                                monthIntervalInput.value = 12;
                            }
                        });

                        // Close times modals when clicking outside
                        window.addEventListener("click", (e) => {
                            if (e.target === timesPerDayModal) hideModal(timesPerDayModal);
                        });

                        // Date Mode Toggle Logic
                        const dateDisplay = document.getElementById("dateDisplay");
                        const dateDisplayTo = document.getElementById("dateDisplayTo");
                        const dateInputFrom = document.getElementById("taskDate");
                        const dateInputTo = document.getElementById("taskDateTo");
                        const addEndDateBtn = document.getElementById("addEndDateBtn");

                        let dateMode = "from"; // default

                        const dateToWrapper = document.getElementById("dateToWrapper");
                        const removeEndDateBtn =
                            document.getElementById("removeEndDateBtn");

                        addEndDateBtn.addEventListener("click", () => {
                            flatpickrTo.open();
                        });

                        removeEndDateBtn.addEventListener("click", () => {
                            dateMode = "from";
                            document.getElementById("taskDateTo").value = "";
                            document.getElementById("dateDisplayTo").textContent =
                                "To Date";
                            document.getElementById("dateToWrapper").style.display = "none";
                            document.getElementById("dateDisplayTo").style.display = "none";
                            document.getElementById("removeEndDateBtn").style.display =
                                "none";
                            addEndDateBtn.style.display = "inline-block";
                        });

                        // flatpickrSingle is now initialized early in DOMContentLoaded

                        const flatpickrFrom = flatpickr("#taskDate", {
                            dateFormat: "Y-m-d",
                            defaultDate: "today",
                            disableMobile: true,
                            onChange: function (selectedDates) {
                                const formatted = new Date(
                                    selectedDates[0],
                                ).toLocaleDateString(undefined, {
                                    month: "long",
                                    day: "numeric",
                                });
                                dateDisplay.textContent = formatted;
                            },
                            positionElement: dateDisplay,
                            appendTo: document.body,
                        });

                        const flatpickrTo = flatpickr("#taskDateTo", {
                            dateFormat: "Y-m-d",
                            disableMobile: true,
                            onChange: function (selectedDates) {
                                if (selectedDates.length > 0) {
                                    const toDate = selectedDates[0];
                                    const formatted = toDate.toLocaleDateString(undefined, {
                                        month: "long",
                                        day: "numeric",
                                    });
                                    dateInputTo.value = toDate.toISOString().split("T")[0];
                                    dateDisplayTo.textContent = formatted;
                                    document.getElementById("dateToWrapper").style.display =
                                        "inline";
                                    document.getElementById("dateDisplayTo").style.display =
                                        "inline-block";
                                    document.getElementById(
                                        "removeEndDateBtn",
                                    ).style.display = "inline-block";
                                    addEndDateBtn.style.display = "none";
                                    dateMode = "from-to";
                                }
                            },
                            positionElement: addEndDateBtn,
                            appendTo: document.body,
                        });

                        // Monthly date pickers
                        const flatpickrMonthlyFrom = flatpickr("#monthlyTaskDate", {
                            dateFormat: "Y-m-d",
                            defaultDate: "today",
                            disableMobile: true,
                            onChange: function (selectedDates) {
                                const formatted = new Date(
                                    selectedDates[0],
                                ).toLocaleDateString(undefined, {
                                    month: "long",
                                    day: "numeric",
                                });
                                document.getElementById("monthlyDateDisplay").textContent =
                                    formatted;
                            },
                            positionElement: document.getElementById("monthlyDateDisplay"),
                            appendTo: document.body,
                        });

                        const flatpickrMonthlyTo = flatpickr("#monthlyTaskDateTo", {
                            dateFormat: "Y-m-d",
                            disableMobile: true,
                            onChange: function (selectedDates) {
                                if (selectedDates.length > 0) {
                                    const toDate = selectedDates[0];
                                    const formatted = toDate.toLocaleDateString(undefined, {
                                        month: "long",
                                        day: "numeric",
                                    });
                                    document.getElementById("monthlyTaskDateTo").value =
                                        toDate.toISOString().split("T")[0];
                                    document.getElementById(
                                        "monthlyDateDisplayTo",
                                    ).textContent = formatted;
                                    document.getElementById(
                                        "monthlyDateToWrapper",
                                    ).style.display = "inline";
                                    document.getElementById(
                                        "monthlyDateDisplayTo",
                                    ).style.display = "inline-block";
                                    document.getElementById(
                                        "removeMonthlyEndDateBtn",
                                    ).style.display = "inline-block";
                                    document.getElementById(
                                        "addMonthlyEndDateBtn",
                                    ).style.display = "none";
                                }
                            },
                            positionElement: document.getElementById("monthlyDateDisplay"),
                            appendTo: document.body,
                        });

                        // Date Mode Logic
                        // Date Mode Logic
                        const dateModeInput = document.getElementById("dateModeSelection");
                        const modeButtons = document.querySelectorAll(".mode-btn");

                        modeButtons.forEach((button) => {
                            button.addEventListener("click", () => {
                                const mode = button.getAttribute("data-mode");
                                dateModeInput.value = mode;

                                // Update active state
                                modeButtons.forEach((btn) =>
                                    btn.classList.remove("active"),
                                );
                                button.classList.add("active");

                                // Show/hide UI based on mode
                                document.getElementById("fromToDateGroup").style.display =
                                    mode === "date" ? "block" : "none";
                                document.getElementById(
                                    "specificDatesGroup",
                                ).style.display =
                                    mode === "specific-dates" ? "block" : "none";
                                document.getElementById("specificDaysGroup").style.display =
                                    mode === "date" ? "block" : "none";

                                // Clear irrelevant fields
                                if (mode === "specific-dates") {
                                    document.getElementById("taskDate").value = "";
                                    document.getElementById("taskDateTo").value = "";
                                    document.getElementById("dateDisplay").textContent =
                                        "Today";
                                    document.getElementById("dateDisplayTo").textContent =
                                        "To Date";
                                    document.getElementById("dateToWrapper").style.display =
                                        "none";
                                    document.getElementById("dateDisplayTo").style.display =
                                        "none";
                                    document.getElementById(
                                        "removeEndDateBtn",
                                    ).style.display = "none";
                                    document.getElementById("addEndDateBtn").style.display =
                                        "inline-block";
                                    selectedDays = [];
                                    updateSelectedDaysDisplay();
                                } else if (mode === "date") {
                                    document.getElementById("specificDatesInput").value =
                                        "";
                                    selectedDates = [];
                                    flatpickrSpecific.clear();
                                    updateSelectedDatesDisplay();
                                }
                            });
                        });

                        // Specific Days Logic
                        const specificDaysInput =
                            document.getElementById("specificDaysInput");
                        let selectedDays = []; // Will be set based on initial frequency

                        const dayMapping = {
                            Any: "Any",
                            All: "All",
                            Mon: "Monday",
                            Tue: "Tuesday",
                            Wed: "Wednesday",
                            Thu: "Thursday",
                            Fri: "Friday",
                            Sat: "Saturday",
                            Sun: "Sunday",
                        };

                        function updateSelectedDaysDisplay() {
                            const buttons = document.querySelectorAll(
                                "#specificDaysButtons .day-btn",
                            );
                            const repeatInput = document.getElementById("repeatSelection");
                            const specificDaysInput =
                                document.getElementById("specificDaysInput");

                            if (!buttons.length) return; // Exit if no buttons found

                            const isDaily = repeatInput && repeatInput.value === "Daily";

                            buttons.forEach((button) => {
                                const shortDay = button.getAttribute("data-day");
                                const fullDay = dayMapping[shortDay];

                                if (!fullDay) return; // Skip if mapping not found

                                // Check if this button should be selected
                                let isSelected = false;

                                if (fullDay === "Any" || fullDay === "All") {
                                    // For Any/All button - check if it's in selectedDays
                                    isSelected = selectedDays.includes(fullDay);
                                } else {
                                    // For specific days - not selected if "All" or "Any" is active
                                    if (isDaily) {
                                        isSelected =
                                            selectedDays.includes(fullDay) &&
                                            !selectedDays.includes("All");
                                    } else {
                                        isSelected =
                                            selectedDays.includes(fullDay) &&
                                            !selectedDays.includes("Any");
                                    }
                                }

                                if (isSelected) {
                                    button.classList.add("selected");
                                } else {
                                    button.classList.remove("selected");
                                }
                            });

                            // Update the input value with better display text
                            if (specificDaysInput) {
                                if (isDaily && selectedDays.includes("All")) {
                                    specificDaysInput.value = "All days (Mon-Sun)";
                                } else if (!isDaily && selectedDays.includes("Any")) {
                                    specificDaysInput.value = "Any day";
                                } else if (selectedDays.length > 0) {
                                    specificDaysInput.value = selectedDays.join(", ");
                                } else {
                                    specificDaysInput.value = isDaily
                                        ? "All days (Mon-Sun)"
                                        : "Any day";
                                }
                            }
                        }

                        // Add click event listeners to day buttons
                        document
                            .querySelectorAll("#specificDaysButtons .day-btn")
                            .forEach((button) => {
                                button.addEventListener("click", () => {
                                    const shortDay = button.getAttribute("data-day");
                                    const fullDay = dayMapping[shortDay];
                                    const repeatInput =
                                        document.getElementById("repeatSelection");
                                    const isDaily =
                                        repeatInput && repeatInput.value === "Daily";

                                    if (fullDay === "Any" || fullDay === "All") {
                                        // Clicking Any/All button
                                        if (isDaily) {
                                            // For Daily tasks: "All" means every day (Mon-Sun)
                                            if (selectedDays.includes("All")) {
                                                // If "All" is already selected, deselect it and default to Monday
                                                selectedDays = ["Monday"];
                                            } else {
                                                // Select "All" and clear any individual day selections
                                                selectedDays = ["All"];
                                            }
                                        } else {
                                            // For non-Daily tasks: "Any" means any day is acceptable
                                            if (selectedDays.includes("Any")) {
                                                // If "Any" is already selected, keep it (don't deselect)
                                                selectedDays = ["Any"];
                                            } else {
                                                // Select "Any" and clear individual selections
                                                selectedDays = ["Any"];
                                            }
                                        }
                                    } else {
                                        // Clicking individual day button
                                        if (isDaily) {
                                            // For Daily frequency: individual days exclude "All"
                                            if (selectedDays.includes("All")) {
                                                // Replace "All" with this specific day
                                                selectedDays = [fullDay];
                                            } else {
                                                // Toggle individual day
                                                if (selectedDays.includes(fullDay)) {
                                                    selectedDays = selectedDays.filter(
                                                        (day) => day !== fullDay,
                                                    );
                                                    // If no days left, default back to "All"
                                                    if (selectedDays.length === 0) {
                                                        selectedDays = ["All"];
                                                    }
                                                } else {
                                                    selectedDays.push(fullDay);
                                                    // Check if all 7 days are now selected - convert to "All"
                                                    const allDays = [
                                                        "Monday",
                                                        "Tuesday",
                                                        "Wednesday",
                                                        "Thursday",
                                                        "Friday",
                                                        "Saturday",
                                                        "Sunday",
                                                    ];
                                                    if (
                                                        allDays.every((day) =>
                                                            selectedDays.includes(day),
                                                        )
                                                    ) {
                                                        selectedDays = ["All"];
                                                    }
                                                }
                                            }
                                        } else {
                                            // For non-Daily frequencies: check weekly limit and use "Any" logic
                                            const repeatSelection =
                                                document.getElementById("repeatSelection");
                                            const timesPerWeekValue = parseInt(
                                                document.getElementById("timesPerWeekInput")
                                                    .value,
                                            );
                                            const isWeeklyWithLimit =
                                                repeatSelection &&
                                                repeatSelection.value === "Weekly" &&
                                                timesPerWeekValue;

                                            // Remove "Any" when selecting individual days
                                            selectedDays = selectedDays.filter(
                                                (day) => day !== "Any" && day !== "All",
                                            );

                                            if (selectedDays.includes(fullDay)) {
                                                // Deselect this day
                                                selectedDays = selectedDays.filter(
                                                    (day) => day !== fullDay,
                                                );
                                                if (selectedDays.length === 0) {
                                                    // Re-select Any if none selected
                                                    selectedDays = ["Any"];
                                                }
                                            } else {
                                                // Check if we can select this day (weekly limit)
                                                if (
                                                    isWeeklyWithLimit &&
                                                    selectedDays.length >= timesPerWeekValue
                                                ) {
                                                    // Show warning that limit is reached
                                                    showDayLimitWarning(timesPerWeekValue);
                                                    return; // Don't add the day
                                                }
                                                // Select this day
                                                selectedDays.push(fullDay);
                                            }
                                        }
                                    }
                                    updateSelectedDaysDisplay();
                                });
                            });

                        // Function to show day limit warning
                        function showDayLimitWarning(maxDays) {
                            const specificDaysGroup =
                                document.getElementById("specificDaysGroup");
                            const existingWarning =
                                document.getElementById("dayLimitWarning");

                            if (existingWarning) {
                                existingWarning.remove();
                            }

                            const warning = document.createElement("div");
                            warning.id = "dayLimitWarning";
                            warning.style.color = "#6D4C41";
                            warning.style.fontSize = "14px";
                            warning.style.fontWeight = "500";
                            warning.style.marginTop = "8px";
                            warning.style.padding = "10px 12px";
                            warning.style.backgroundColor = "rgba(255, 193, 7, 0.15)";
                            warning.style.border = "1px solid rgba(255, 193, 7, 0.4)";
                            warning.style.borderRadius = "8px";
                            warning.style.borderLeft = "4px solid var(--primary-color)";
                            warning.innerHTML = `<span style="display: inline-block; width: 18px; height: 18px; background: var(--primary-color); color: var(--secondary-color); border-radius: 50%; text-align: center; line-height: 18px; font-size: 12px; font-weight: bold; margin-right: 8px; vertical-align: middle;">!</span>You can only select up to ${maxDays} day${maxDays > 1 ? "s" : ""} for ${maxDays} time${maxDays > 1 ? "s" : ""} per week`;

                            specificDaysGroup.appendChild(warning);

                            // Remove warning after 3 seconds
                            setTimeout(() => {
                                if (warning && warning.parentNode) {
                                    warning.remove();
                                }
                            }, 3000);
                        }

                        // Function to validate weekly frequency limit for specific dates
                        function validateWeeklyFrequencyForDates(
                            dates,
                            newDate = null,
                            isAdding = true,
                        ) {
                            const repeatSelection =
                                document.getElementById("repeatSelection");
                            const timesPerWeekValue = parseInt(
                                document.getElementById("timesPerWeekInput").value,
                            );

                            if (
                                !repeatSelection ||
                                repeatSelection.value !== "Weekly" ||
                                !timesPerWeekValue ||
                                dates.length === 0
                            ) {
                                return true; // No validation needed
                            }

                            // Group dates by week (Monday to Sunday)
                            const datesByWeek = {};

                            dates.forEach((date) => {
                                const weekStart = getWeekStart(date);
                                const weekKey = weekStart.toISOString().split("T")[0];

                                if (!datesByWeek[weekKey]) {
                                    datesByWeek[weekKey] = [];
                                }
                                datesByWeek[weekKey].push(date);
                            });

                            // Check if any week exceeds the limit
                            for (const weekKey in datesByWeek) {
                                const weekDates = datesByWeek[weekKey];
                                if (weekDates.length > timesPerWeekValue) {
                                    if (isAdding && newDate) {
                                        const newWeekStart = getWeekStart(newDate);
                                        const newWeekKey = newWeekStart
                                            .toISOString()
                                            .split("T")[0];
                                        if (weekKey === newWeekKey) {
                                            showWeeklyDateLimitWarning(
                                                timesPerWeekValue,
                                                weekKey,
                                                true,
                                            );
                                        } else {
                                            showWeeklyDateLimitWarning(
                                                timesPerWeekValue,
                                                weekKey,
                                                false,
                                            );
                                        }
                                    }
                                    return false;
                                }
                            }

                            return true;
                        }

                        // Function to get the start of week (Monday) for a given date
                        function getWeekStart(date) {
                            const d = new Date(date);
                            const day = d.getDay();
                            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
                            return new Date(d.setDate(diff));
                        }

                        // Function to show weekly date limit warning as center popup
                        function showWeeklyDateLimitWarning(
                            maxDates,
                            weekKey,
                            isCurrentWeek,
                        ) {
                            // Remove any existing center popup
                            const existingPopup =
                                document.getElementById("centerWarningPopup");
                            if (existingPopup) {
                                existingPopup.remove();
                            }

                            const weekStart = new Date(weekKey);
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekStart.getDate() + 6);

                            const weekStr =
                                weekStart.toLocaleDateString(undefined, {
                                    month: "short",
                                    day: "numeric",
                                }) +
                                " - " +
                                weekEnd.toLocaleDateString(undefined, {
                                    month: "short",
                                    day: "numeric",
                                });

                            const message = isCurrentWeek
                                ? `Cannot select this date. Week ${weekStr} already has ${maxDates} date${maxDates > 1 ? "s" : ""} selected (${maxDates} time${maxDates > 1 ? "s" : ""} per week limit). Remove a date from this week first to select a different one.`
                                : `Week ${weekStr} exceeds the limit. You can only select up to ${maxDates} date${maxDates > 1 ? "s" : ""} per week.`;

                            // Create center popup
                            const popup = document.createElement("div");
                            popup.id = "centerWarningPopup";
                            popup.className = "center-warning-popup";
                            popup.innerHTML = `
                    <div class="warning-icon">!</div>
                    <div class="warning-text">${message}</div>
                    <button class="warning-close" onclick="this.parentElement.remove()">OK</button>
                `;

                            document.body.appendChild(popup);

                            // Auto-remove after 5 seconds
                            setTimeout(() => {
                                if (popup && popup.parentNode) {
                                    popup.remove();
                                }
                            }, 5000);
                        }

                        // Initialize display
                        updateSelectedDaysDisplay();

                        const specificDatesButton = document.getElementById(
                            "selectSpecificDates",
                        );
                        const specificDatesModal =
                            document.getElementById("specificDatesModal");
                        const specificDatesInput =
                            document.getElementById("specificDatesInput");
                        const selectedDatesContainer = document.getElementById(
                            "selectedDatesContainer",
                        );
                        const saveSpecificDatesBtn =
                            document.getElementById("saveSpecificDates");
                        const clearSpecificDatesBtn =
                            document.getElementById("clearSpecificDates");
                        const specificDatesGroup =
                            document.getElementById("specificDatesGroup");

                        let selectedDates = [];
                        let isDragging = false;
                        let startDate = null;
                        let dragMode = null; // 'select' or 'deselect'
                        let selectedDatesAtDragStart = [];

                        const flatpickrSpecific = flatpickr("#specificDatesCalendar", {
                            dateFormat: "Y-m-d",
                            mode: "multiple",
                            disableMobile: true,
                            inline: true,
                            enable: [
                                function (date) {
                                    return true; // Allow all dates
                                },
                            ],
                            onReady: function (_, __, instance) {
                                const calendar = instance.calendarContainer;

                                // Initialize visual state when calendar is ready
                                setTimeout(() => {
                                    updateDaysVisualState(instance);
                                }, 100);

                                calendar.addEventListener("mousedown", (e) => {
                                    const dayElem = e.target.closest(".flatpickr-day");
                                    if (
                                        dayElem &&
                                        !dayElem.classList.contains("disabled")
                                    ) {
                                        isDragging = true;
                                        startDate = new Date(
                                            dayElem.getAttribute("aria-label"),
                                        );
                                        const startIsSelected = selectedDates.some(
                                            (d) => d.getTime() === startDate.getTime(),
                                        );
                                        dragMode = startIsSelected ? "deselect" : "select";
                                        selectedDatesAtDragStart = [...selectedDates]; // snapshot current selection
                                        e.preventDefault();
                                        e.stopPropagation();
                                    }
                                });

                                calendar.addEventListener("mousemove", (e) => {
                                    if (!isDragging || !dragMode) return;
                                    const dayElem = e.target.closest(".flatpickr-day");
                                    if (
                                        dayElem &&
                                        !dayElem.classList.contains("disabled")
                                    ) {
                                        const endDate = new Date(
                                            dayElem.getAttribute("aria-label"),
                                        );
                                        const datesInRange = getDatesInRange(
                                            startDate,
                                            endDate,
                                        );

                                        let newDates = [...selectedDatesAtDragStart];
                                        if (dragMode === "select") {
                                            newDates = [
                                                ...new Set(
                                                    [...newDates, ...datesInRange].map(
                                                        (d) => d.getTime(),
                                                    ),
                                                ),
                                            ].map((t) => new Date(t));
                                        } else if (dragMode === "deselect") {
                                            newDates = newDates.filter(
                                                (d) =>
                                                    !datesInRange.some(
                                                        (r) => r.getTime() === d.getTime(),
                                                    ),
                                            );
                                        }

                                        // Only validate if we're adding dates (selecting), not removing
                                        const isAdding = dragMode === "select";
                                        if (
                                            !isAdding ||
                                            validateWeeklyFrequencyForDates(newDates)
                                        ) {
                                            selectedDates = newDates.sort((a, b) => a - b);
                                            instance.setDate(selectedDates, false);
                                            // Clear warnings on successful selection
                                            const warningContainer =
                                                document.getElementById(
                                                    "specificDatesWarningContainer",
                                                );
                                            if (warningContainer) {
                                                warningContainer.innerHTML = "";
                                            }
                                        } else {
                                            // Validation failed - show visual feedback but don't change selection
                                            // The warning is already shown by validateWeeklyFrequencyForDates
                                        }
                                    }
                                });

                                calendar.addEventListener("mouseup", (e) => {
                                    if (isDragging) {
                                        isDragging = false;
                                        startDate = null;
                                        dragMode = null;
                                        selectedDatesAtDragStart = [];
                                        e.stopPropagation();
                                    }
                                });

                                calendar.addEventListener("click", (e) => {
                                    const dayElem = e.target.closest(".flatpickr-day");
                                    if (dayElem) {
                                        // FIRST: Check if this day is disabled by weekly limit
                                        if (
                                            dayElem.classList.contains(
                                                "disabled-by-weekly-limit",
                                            ) ||
                                            dayElem.getAttribute(
                                                "data-disabled-by-limit",
                                            ) === "true"
                                        ) {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            const date = new Date(
                                                dayElem.getAttribute("aria-label"),
                                            );
                                            const timesPerWeekValue = parseInt(
                                                document.getElementById("timesPerWeekInput")
                                                    .value,
                                            );
                                            const weekStart = getWeekStart(date);
                                            const weekKey = weekStart
                                                .toISOString()
                                                .split("T")[0];
                                            showWeeklyDateLimitWarning(
                                                timesPerWeekValue,
                                                weekKey,
                                                true,
                                            );
                                            return false;
                                        }

                                        if (!isDragging && !startDate) {
                                            e.preventDefault();
                                            e.stopPropagation();

                                            const date = new Date(
                                                dayElem.getAttribute("aria-label"),
                                            );

                                            // Skip if day is disabled by flatpickr itself
                                            if (dayElem.classList.contains("disabled")) {
                                                return;
                                            }

                                            const index = selectedDates.findIndex(
                                                (d) => d.getTime() === date.getTime(),
                                            );

                                            if (index >= 0) {
                                                // Always allow deselection
                                                selectedDates.splice(index, 1);
                                                // Clear warnings when deselecting
                                                const warningContainer =
                                                    document.getElementById(
                                                        "specificDatesWarningContainer",
                                                    );
                                                if (warningContainer) {
                                                    warningContainer.innerHTML = "";
                                                }
                                                selectedDates.sort((a, b) => a - b);
                                                instance.setDate(selectedDates, false);
                                                updateSelectedDatesDisplay();
                                                // Update visual state after deselection
                                                setTimeout(
                                                    () => updateDaysVisualState(instance),
                                                    50,
                                                );
                                            } else {
                                                // Check if this day is disabled by weekly limit
                                                const repeatSelection =
                                                    document.getElementById(
                                                        "repeatSelection",
                                                    );
                                                const timesPerWeekValue = parseInt(
                                                    document.getElementById(
                                                        "timesPerWeekInput",
                                                    ).value,
                                                );

                                                if (
                                                    repeatSelection &&
                                                    repeatSelection.value === "Weekly" &&
                                                    timesPerWeekValue
                                                ) {
                                                    // Check how many dates are already selected in this week
                                                    const weekStart = getWeekStart(date);
                                                    const weekKey = weekStart
                                                        .toISOString()
                                                        .split("T")[0];
                                                    const datesInThisWeek =
                                                        selectedDates.filter((d) => {
                                                            const dWeekStart =
                                                                getWeekStart(d);
                                                            return (
                                                                dWeekStart
                                                                    .toISOString()
                                                                    .split("T")[0] ===
                                                                weekKey
                                                            );
                                                        });

                                                    if (
                                                        datesInThisWeek.length >=
                                                        timesPerWeekValue
                                                    ) {
                                                        // Show warning for exceeding weekly limit
                                                        showWeeklyDateLimitWarning(
                                                            timesPerWeekValue,
                                                            weekKey,
                                                            true,
                                                        );
                                                        return;
                                                    }
                                                }

                                                // Add the date
                                                selectedDates.push(date);
                                                selectedDates.sort((a, b) => a - b);
                                                instance.setDate(selectedDates, false);
                                                updateSelectedDatesDisplay();

                                                // Clear warnings on successful addition
                                                const warningContainer =
                                                    document.getElementById(
                                                        "specificDatesWarningContainer",
                                                    );
                                                if (warningContainer) {
                                                    warningContainer.innerHTML = "";
                                                }

                                                // Update visual state after selection
                                                setTimeout(
                                                    () => updateDaysVisualState(instance),
                                                    50,
                                                );
                                            }
                                        }
                                    }
                                });
                            },
                            onChange: function (dates, text, instance) {
                                // Check if any new dates violate weekly limits and revert if needed
                                if (!isDragging) {
                                    const repeatSelection =
                                        document.getElementById("repeatSelection");
                                    const timesPerWeekValue = parseInt(
                                        document.getElementById("timesPerWeekInput").value,
                                    );

                                    if (
                                        repeatSelection &&
                                        repeatSelection.value === "Weekly" &&
                                        timesPerWeekValue
                                    ) {
                                        // Check if the new selection violates weekly limits
                                        const datesByWeek = {};
                                        dates.forEach((date) => {
                                            const weekStart = getWeekStart(date);
                                            const weekKey = weekStart
                                                .toISOString()
                                                .split("T")[0];
                                            if (!datesByWeek[weekKey]) {
                                                datesByWeek[weekKey] = [];
                                            }
                                            datesByWeek[weekKey].push(date);
                                        });

                                        // Check for violations
                                        let hasViolation = false;
                                        for (const weekKey in datesByWeek) {
                                            if (
                                                datesByWeek[weekKey].length >
                                                timesPerWeekValue
                                            ) {
                                                hasViolation = true;
                                                showWeeklyDateLimitWarning(
                                                    timesPerWeekValue,
                                                    weekKey,
                                                    true,
                                                );
                                                break;
                                            }
                                        }

                                        if (hasViolation) {
                                            // Revert to previous valid selection
                                            instance.setDate(selectedDates, false);
                                            return;
                                        }
                                    }

                                    selectedDates = dates.sort((a, b) => a - b);
                                    updateSelectedDatesDisplay();
                                    // Update visual state after any change
                                    setTimeout(() => updateDaysVisualState(instance), 50);
                                }
                            },
                        });

                        function getDatesInRange(start, end) {
                            const dates = [];
                            const current = new Date(Math.min(start, end));
                            const max = new Date(Math.max(start, end));
                            while (current <= max) {
                                dates.push(new Date(current));
                                current.setDate(current.getDate() + 1);
                            }
                            return dates;
                        }

                        function updateSelectedDatesDisplay() {
                            selectedDatesContainer.innerHTML = "";
                            console.log("Selected Dates (raw):", selectedDates); // Debug
                            if (selectedDates.length === 0) {
                                specificDatesInput.value = "";
                                const placeholder = document.createElement("span");
                                placeholder.textContent = "Every day";
                                placeholder.style.color = "rgba(255, 255, 255, 0.7)";
                                placeholder.style.fontSize = "14px";
                                selectedDatesContainer.appendChild(placeholder);
                            } else {
                                specificDatesInput.value = selectedDates
                                    .map((date) => {
                                        const year = date.getFullYear();
                                        const month = String(date.getMonth() + 1).padStart(
                                            2,
                                            "0",
                                        );
                                        const day = String(date.getDate()).padStart(2, "0");
                                        return `${year}-${month}-${day}`;
                                    })
                                    .join(",");
                                console.log(
                                    "specificDatesInput.value:",
                                    specificDatesInput.value,
                                ); // Debug
                                selectedDates.forEach((date) => {
                                    const chip = document.createElement("div");
                                    chip.className = "date-chip";
                                    chip.style.cssText =
                                        "display: inline-flex; align-items: center; gap: 8px; background: var(--primary-color); color: var(--secondary-color); padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 500; margin: 2px;";
                                    const dateText = document.createElement("span");
                                    dateText.textContent = date.toLocaleDateString(
                                        undefined,
                                        { month: "short", day: "numeric" },
                                    );
                                    const removeBtn = document.createElement("button");
                                    removeBtn.innerHTML = "×";
                                    removeBtn.style.cssText =
                                        "background: none; border: none; color: var(--secondary-color); font-size: 16px; font-weight: bold; cursor: pointer; padding: 0; margin: 0; line-height: 1;";
                                    removeBtn.addEventListener("click", () => {
                                        selectedDates = selectedDates.filter(
                                            (d) => d.getTime() !== date.getTime(),
                                        );
                                        flatpickrSpecific.setDate(selectedDates);
                                        updateSelectedDatesDisplay();
                                        updateDaysVisualState(flatpickrSpecific);
                                    });
                                    chip.appendChild(dateText);
                                    chip.appendChild(removeBtn);
                                    selectedDatesContainer.appendChild(chip);
                                });
                            }
                        }

                        // Function to update visual state of calendar days based on weekly limits
                        function updateDaysVisualState(instance) {
                            const repeatSelection =
                                document.getElementById("repeatSelection");
                            const timesPerWeekValue = parseInt(
                                document.getElementById("timesPerWeekInput").value,
                            );

                            if (
                                !repeatSelection ||
                                repeatSelection.value !== "Weekly" ||
                                !timesPerWeekValue ||
                                !instance
                            ) {
                                return; // No weekly limit to enforce
                            }

                            // Group selected dates by week
                            const datesByWeek = {};
                            selectedDates.forEach((date) => {
                                const weekStart = getWeekStart(date);
                                const weekKey = weekStart.toISOString().split("T")[0];
                                if (!datesByWeek[weekKey]) {
                                    datesByWeek[weekKey] = [];
                                }
                                datesByWeek[weekKey].push(date);
                            });

                            // Get all calendar day elements from the flatpickr instance
                            const calendar = instance.calendarContainer;
                            if (!calendar) return;

                            const calendarDays = calendar.querySelectorAll(
                                ".flatpickr-day:not(.prevMonthDay):not(.nextMonthDay)",
                            );

                            calendarDays.forEach((dayElem) => {
                                const dateStr = dayElem.getAttribute("aria-label");
                                if (!dateStr) return;

                                const dayDate = new Date(dateStr);
                                if (isNaN(dayDate.getTime())) return;

                                const weekStart = getWeekStart(dayDate);
                                const weekKey = weekStart.toISOString().split("T")[0];
                                const weekDates = datesByWeek[weekKey] || [];

                                const isSelected = selectedDates.some(
                                    (d) => d.getTime() === dayDate.getTime(),
                                );

                                // Reset styles first
                                dayElem.classList.remove("disabled-by-weekly-limit");
                                dayElem.removeAttribute("data-disabled-by-limit");

                                if (!isSelected && weekDates.length >= timesPerWeekValue) {
                                    // This day cannot be selected - week is full
                                    dayElem.classList.add("disabled-by-weekly-limit");
                                    dayElem.setAttribute("data-disabled-by-limit", "true");
                                }
                            });
                        }

                        specificDatesButton.addEventListener("click", () => {
                            // Clear any existing warnings when opening modal
                            const warningContainer = document.getElementById(
                                "specificDatesWarningContainer",
                            );
                            if (warningContainer) {
                                warningContainer.innerHTML = "";
                            }
                            showModal(specificDatesModal);
                            // Update visual state when modal opens
                            setTimeout(() => {
                                if (
                                    typeof flatpickrSpecific !== "undefined" &&
                                    flatpickrSpecific.calendarContainer
                                ) {
                                    updateDaysVisualState(flatpickrSpecific);
                                }
                            }, 200);
                        });

                        saveSpecificDatesBtn.addEventListener("click", () => {
                            // Validate before saving
                            if (!validateWeeklyFrequencyForDates(selectedDates)) {
                                // Don't close modal if validation fails
                                return;
                            }
                            // Clear warnings when saving
                            const warningContainer = document.getElementById(
                                "specificDatesWarningContainer",
                            );
                            if (warningContainer) {
                                warningContainer.innerHTML = "";
                            }
                            updateSelectedDatesDisplay();
                            hideModal(specificDatesModal);
                        });

                        clearSpecificDatesBtn.addEventListener("click", () => {
                            // Clear warnings when clearing dates
                            const warningContainer = document.getElementById(
                                "specificDatesWarningContainer",
                            );
                            if (warningContainer) {
                                warningContainer.innerHTML = "";
                            }
                            selectedDates = [];
                            flatpickrSpecific.clear();
                            updateSelectedDatesDisplay();
                            hideModal(specificDatesModal);
                        });

                        window.addEventListener("click", (e) => {
                            if (e.target === specificDatesModal) {
                                // Clear warnings when closing modal
                                const warningContainer = document.getElementById(
                                    "specificDatesWarningContainer",
                                );
                                if (warningContainer) {
                                    warningContainer.innerHTML = "";
                                }
                                hideModal(specificDatesModal);
                            }
                        });

                        dateDisplay.addEventListener("click", () => {
                            flatpickrFrom.open();
                        });

                        dateDisplayTo.addEventListener("click", () => {
                            if (dateMode === "date") {
                                const fromDate = dateFrom;
                                const toDate = dateTo || "3000-01-01";
                                dateValue = `${fromDate} to ${toDate}`;
                            }
                        });

                        // COMMENTED OUT - REMINDER AND ALARM LOGIC (keep for later implementation)
                        /*
                    const reminderToggle = document.getElementById('taskReminder');
                    const addAlarmBtn = document.getElementById('addAlarmBtn');
                    const alarmContainer = document.getElementById('alarmContainer');
                    let alarms = [];

                    reminderToggle.addEventListener('change', () => {
                        if (reminderToggle.checked) {
                            addAlarmBtn.style.display = 'inline-block';
                        } else {
                            addAlarmBtn.style.display = 'none';
                            alarmContainer.innerHTML = '';
                            alarms = [];
                        }
                    });

                    addAlarmBtn.addEventListener('click', () => {
                        const alarmWrapper = document.createElement('div');
                        alarmWrapper.style.marginBottom = '10px';
                        alarmWrapper.style.display = 'flex';
                        alarmWrapper.style.alignItems = 'center';

                        const alarmInput = document.createElement('input');
                        alarmInput.type = 'time';
                        alarmInput.style.marginRight = '10px';
                        alarmInput.style.padding = '10px';
                        alarmInput.style.border = '2px solid var(--primary-color)';
                        alarmInput.style.borderRadius = '8px';
                        alarmInput.style.background = 'var(--accent-color)';

                        const removeButton = document.createElement('button');
                        removeButton.textContent = 'Remove';
                        removeButton.style.padding = '5px 10px';
                        removeButton.style.marginLeft = '10px';

                        removeButton.addEventListener('click', () => {
                            alarmWrapper.remove();
                            alarms = alarms.filter(a => a !== alarmInput.value);
                        });

                        alarmInput.addEventListener('input', () => {
                            if (!alarms.includes(alarmInput.value)) {
                                alarms.push(alarmInput.value);
                            }
                        });

                        alarmWrapper.appendChild(alarmInput);
                        alarmWrapper.appendChild(removeButton);
                        alarmContainer.appendChild(alarmWrapper);
                    });
                    */

                        // Due Time Logic
                        const dueTimeToggle = document.getElementById("dueTimeToggle");
                        const dueTimeContainer =
                            document.getElementById("dueTimeContainer");
                        let dueTimes = [];

                        function updateDueTimeDisplay() {
                            dueTimeContainer.innerHTML = "";

                            if (!dueTimeToggle.checked) {
                                dueTimeContainer.style.display = "none";
                                return;
                            }

                            dueTimeContainer.style.display = "block";

                            const repeatInput = document.getElementById("repeatSelection");
                            const timesPerDayInput =
                                document.getElementById("timesPerDayInput");
                            const isDaily = repeatInput && repeatInput.value === "Daily";
                            const timesPerDay = isDaily
                                ? parseInt(timesPerDayInput.value) || 1
                                : 1;

                            // Ensure we have the right number of due times
                            while (dueTimes.length < timesPerDay) {
                                dueTimes.push("");
                            }
                            while (dueTimes.length > timesPerDay) {
                                dueTimes.pop();
                            }

                            dueTimes.forEach((dueTime, index) => {
                                const timeWrapper = document.createElement("div");
                                timeWrapper.style.marginBottom = "10px";
                                timeWrapper.style.display = "flex";
                                timeWrapper.style.alignItems = "center";
                                timeWrapper.style.gap = "10px";
                                timeWrapper.style.flexWrap = "nowrap";

                                // Add ordinal text (1st, 2nd, 3rd, etc.) if more than one field
                                if (timesPerDay > 1) {
                                    const ordinalText = document.createElement("span");
                                    const ordinals = [
                                        "1st",
                                        "2nd",
                                        "3rd",
                                        "4th",
                                        "5th",
                                        "6th",
                                        "7th",
                                        "8th",
                                        "9th",
                                        "10th",
                                    ];
                                    ordinalText.textContent =
                                        ordinals[index] || `${index + 1}th`;
                                    ordinalText.style.fontSize = "14px";
                                    ordinalText.style.fontWeight = "600";
                                    ordinalText.style.minWidth = "35px";
                                    ordinalText.style.color = "var(--text-color)";
                                    timeWrapper.appendChild(ordinalText);
                                }

                                // Due Time input - made wider
                                const dueTimeInput = document.createElement("input");
                                dueTimeInput.type = "time";
                                dueTimeInput.value = dueTime || "";
                                dueTimeInput.style.padding = "10px";
                                dueTimeInput.style.border =
                                    "2px solid var(--primary-color)";
                                dueTimeInput.style.borderRadius = "8px";
                                dueTimeInput.style.background = "rgba(255, 193, 7, 0.1)";
                                dueTimeInput.style.color = "var(--text-color)";
                                dueTimeInput.style.fontSize = "16px";
                                dueTimeInput.style.minWidth = "120px";
                                dueTimeInput.style.flex = "1";
                                dueTimeInput.style.boxShadow =
                                    "0 2px 4px rgba(0, 0, 0, 0.1)";

                                // Remove button (only show if more than 1 time slot)
                                let removeButton;
                                if (timesPerDay > 1) {
                                    removeButton = document.createElement("button");
                                    removeButton.textContent = "✖";
                                    removeButton.style.padding = "8px 10px";
                                    removeButton.style.background = "var(--danger-color)";
                                    removeButton.style.color = "white";
                                    removeButton.style.border = "none";
                                    removeButton.style.borderRadius = "6px";
                                    removeButton.style.cursor = "pointer";
                                    removeButton.style.fontSize = "12px";
                                    removeButton.style.marginLeft = "5px";
                                    removeButton.style.transition =
                                        "background-color 0.3s ease, transform 0.2s ease";
                                    removeButton.style.boxShadow =
                                        "0 2px 4px rgba(0, 0, 0, 0.1)";

                                    removeButton.addEventListener("click", () => {
                                        timeWrapper.remove();
                                        dueTimes.splice(index, 1);
                                    });

                                    // Add hover effects for remove button
                                    removeButton.addEventListener("mouseenter", () => {
                                        removeButton.style.background = "#c62828";
                                        removeButton.style.transform = "translateY(-1px)";
                                    });

                                    removeButton.addEventListener("mouseleave", () => {
                                        removeButton.style.background =
                                            "var(--danger-color)";
                                        removeButton.style.transform = "translateY(0)";
                                    });
                                }

                                // Update dueTimes array when input changes
                                dueTimeInput.addEventListener("change", () => {
                                    dueTimes[index] = dueTimeInput.value;
                                });

                                // Add focus effects for input
                                dueTimeInput.addEventListener("focus", () => {
                                    dueTimeInput.style.borderColor = "#FFB300";
                                    dueTimeInput.style.boxShadow =
                                        "0 4px 12px rgba(255, 193, 7, 0.3)";
                                });

                                dueTimeInput.addEventListener("blur", () => {
                                    dueTimeInput.style.borderColor = "var(--primary-color)";
                                    dueTimeInput.style.boxShadow =
                                        "0 2px 4px rgba(0, 0, 0, 0.1)";
                                });

                                timeWrapper.appendChild(dueTimeInput);
                                if (removeButton) {
                                    timeWrapper.appendChild(removeButton);
                                }

                                dueTimeContainer.appendChild(timeWrapper);
                            });
                        }

                        dueTimeToggle.addEventListener("change", () => {
                            updateDueTimeDisplay();
                        });

                        // Update due time display when times per day changes
                        document
                            .getElementById("timesPerDayInput")
                            .addEventListener("change", () => {
                                if (dueTimeToggle.checked) {
                                    updateDueTimeDisplay();
                                }
                            });

                        // Update due time display when frequency changes
                        document
                            .getElementById("repeatSelection")
                            .addEventListener("change", () => {
                                if (dueTimeToggle.checked) {
                                    updateDueTimeDisplay();
                                }
                            });

                        // Functions moved to global scope at beginning of script

                        // Initialize section label on page load
                        document.addEventListener("DOMContentLoaded", () => {
                            const sectionLabel = document.getElementById("sectionLabel");
                            const repeatInput = document.getElementById("repeatSelection");
                            const anyAllButton = document.getElementById("anyAllButton");

                            // Add delay to ensure all elements are loaded
                            setTimeout(() => {
                                // Initialize selectedDays if empty
                                if (selectedDays.length === 0) {
                                    const currentRepeat = repeatInput
                                        ? repeatInput.value
                                        : "One Time";
                                    selectedDays =
                                        currentRepeat === "Daily" ? ["All"] : ["Any"];
                                }

                                // Set initial section label and Any/All button based on current frequency (default is "One Time")
                                if (sectionLabel && anyAllButton) {
                                    if (repeatInput && repeatInput.value === "Daily") {
                                        sectionLabel.textContent = "Days";
                                        anyAllButton.textContent = "All";
                                        anyAllButton.setAttribute("data-day", "All");
                                        anyAllButton.setAttribute(
                                            "title",
                                            "All 7 days (Mon-Sun)",
                                        );

                                        // Ensure "All" is selected for Daily by default
                                        if (selectedDays.includes("Any")) {
                                            selectedDays = ["All"];
                                        }
                                    } else {
                                        sectionLabel.textContent = "Dates";
                                        anyAllButton.textContent = "Any";
                                        anyAllButton.setAttribute("data-day", "Any");
                                        anyAllButton.setAttribute(
                                            "title",
                                            "Any day (flexible scheduling)",
                                        );

                                        // Ensure "Any" is selected for non-Daily by default
                                        if (selectedDays.includes("All")) {
                                            selectedDays = ["Any"];
                                        }
                                    }
                                }

                                updateSelectedDaysDisplay();
                            }, 100);
                        });
        </script>
    </body>
</html>
