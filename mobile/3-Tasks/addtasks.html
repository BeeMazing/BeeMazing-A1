<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeMazing Add Task</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
    --primary-color: #FFC107; /* bright yellow matching other pages */
    --secondary-color: #212121;
    --accent-color: #2C2F3A;
    --light-bg: #FFFFF8;
    --text-color: #6D4C41; /* brown text matching other pages */
    --card-bg: #FFFFFF; /* white card backgrounds */
    --danger-color: #D32F2F;
    --muted-button: #3A3D4B;
    --hover-accent: #3F4353;
    --border-dark: #444754;
    --selection-border: #555555;
    --selection-bg: #3A3D4B;
}


    html, body {
        height: 100%;
        width: 100%;
        overflow-x: hidden;
        font-family: 'Poppins', Arial, sans-serif;
        background-color: var(--light-bg);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
    }

    .header {
    position: relative;
    display: flex;
    justify-content: center; /* Center the title */
    align-items: center;
    background: var(--primary-color);
    padding: 15px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
}

.menu-icon {
position: absolute;
left: 15px;
font-size: 24px;
color: #FFFFFF; /* white for menu icon */
cursor: pointer;
}

    .title {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-color); /* brown text for title */
    text-transform: uppercase;
    letter-spacing: 1px;
}

    .content {
        padding: 20px;
        padding-bottom: 110px;
        flex: 1;
        overflow-y: auto;
    }

    .form-group, .form-group-full {
    padding: 8px 0;
    margin-bottom: 8px;
}

    .form-group.room-section, .form-group.frequency-section, .form-group-full.date-section {
    background-color: rgba(255, 193, 7, 0.1);
    border: 2px solid var(--primary-color);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
}


    .form-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }


    .form-group label {
    margin-right: 12px; /* Adjust the spacing */
}




    label {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-color);
    }

    input, textarea {
    background: rgba(255, 193, 7, 0.1);
    color: var(--text-color);
    border: 2px solid var(--primary-color);
    border-radius: 8px;
    padding: 10px;
    font-size: 16px;
    width: 100%;
}


    textarea {
        resize: vertical;
        height: 100px;
    }

    ::placeholder {
        color: rgba(109, 76, 65, 0.6);
    }

    .select-btn {
    background: var(--card-bg);
    border: 2px solid var(--primary-color);
    color: var(--text-color);
    font-size: 16px;
    font-weight: 600;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
}

.select-btn:hover {
    background: rgba(255, 193, 7, 0.1);
    transform: translateY(-1px);
}

/* New class for the circular + button */
.plus-btn {
    background: var(--primary-color);
    border: none;
    color: var(--secondary-color);
    font-size: 20px;
    font-weight: 600;
    width: 32px;
    height: 32px;
    line-height: 32px; /* Centers the + vertically */
    border-radius: 50%; /* Fully circular */
    cursor: pointer;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
}

.plus-btn:hover {
    background: #FFB300; /* Brighter gold on hover */
    transform: translateY(-2px); /* Slight lift */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); /* Enhanced shadow */
}

.plus-btn:active {
    transform: translateY(0); /* Pressed effect */
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); /* Reduced shadow */
}

    .date-display {
        background: var(--light-bg);
        border: 2px solid var(--primary-color);
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-color);
        text-align: center;
        cursor: pointer;
        transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
        min-width: 120px;
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.1);
    }

    .date-display:hover {
        background: rgba(255, 193, 7, 0.15);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.2);
    }

    .date-flex-row {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .date-flex-row label {
        width: 80px;
        margin: 0;
    }

    .date-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .date-input {
        display: none;
    }

    .save-btn {
        width: 100%;
        padding: 15px;
        margin-top: 20px;
        background: var(--primary-color);
        color: var(--secondary-color);
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .save-btn:hover {
        background: #FFB300;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal.show {
        display: flex;
        animation: fadeIn 0.3s ease-out;
    }

    .modal.hide {
        animation: fadeOut 0.3s ease-out;
        pointer-events: none;
    }

    .modal-content {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 15px;
        border: 2px solid var(--primary-color);
        width: 80%;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
        color: var(--text-color);
    }

    .modal-content h3 {
        color: var(--text-color);
        font-weight: 600;
        margin-bottom: 15px;
    }

    .modal-content ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .modal-content ul li {
        padding: 10px;
        margin: 5px 0;
        background: var(--card-bg);
        color: var(--text-color);
        border: 2px solid var(--primary-color);
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .modal-content ul li:hover {
        background: rgba(255, 193, 7, 0.1);
        transform: translateY(-1px);
    }

    .close-btn {
        margin-top: 15px;
        padding: 10px 20px;
        background: var(--primary-color);
        color: var(--text-color);
        border: 2px solid var(--text-color);
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        transition: all 0.3s ease;
    }

    .close-btn:hover {
        background: #FFB300;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.5);
    }

    .footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    display: flex;
    justify-content: space-around;
    background: var(--secondary-color); /* Changed to black */
    padding: 10px 0;
    box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
    z-index: 100;
    height: var(--footer-height);
}

.footer a {
    text-decoration: none;
    color: var(--accent-color); /* Changed to white for text */
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.3s ease;
}




    .footer img {
        width: 40px;
        height: 40px;
        filter: invert(100%) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)); /* Default: white */
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 34px;
        height: 20px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #444;
        transition: 0.4s;
        border-radius: 20px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: var(--accent-color);
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--primary-color);
    }

    input:checked + .slider:before {
        transform: translateX(14px);
    }

    .fancy-input {
        padding: 8px 12px;
        font-size: 14px;
        border: 2px solid var(--border-dark);
        border-radius: 8px;
        background: var(--light-bg);
        color: var(--text-color);
        width: 80%;
        margin: 0 auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .fancy-input:focus {
        border-color: #FFB300;
        box-shadow: 0 4px 12px rgba(255, 193, 7, 0.5);
        outline: none;
    }

    .btn-save {
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 600;
        background: var(--primary-color);
        color: var(--secondary-color);
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: transform 0.2s ease, background-color 0.3s ease;
    }

    .btn-save:hover {
        transform: translateY(-3px);
        background: #FFB300;
    }

    .btn-cancel {
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 600;
        background: var(--danger-color);
        color: var(--text-color);
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .btn-cancel:hover {
        background: #B71C1C;
        transform: translateY(-3px);
    }

    @keyframes fadeIn {
        0% { opacity: 0; transform: scale(0.9); }
        100% { opacity: 1; transform: scale(1); }
    }

    @keyframes fadeOut {
        0% { opacity: 1; transform: scale(1); }
        100% { opacity: 0; transform: scale(0.9); }
    }

    @keyframes slideIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }


    /* Styling for date chips */
.date-chip {
    background: var(--accent-color);
    color: var(--text-color);
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1px solid var(--border-dark);
    transition: background-color 0.3s ease;
}

.date-chip:hover {
    background: var(--hover-accent);
}

.date-chip-remove {
    cursor: pointer;
    color: var(--danger-color);
    font-size: 16px;
    line-height: 1;
}

.date-chip-remove:hover {
    color: #B71C1C;
}

/* Ensure calendar in modal is centered and sized appropriately */
#specificDatesCalendar .flatpickr-calendar {
    background: var(--light-bg);
    border: 2px solid var(--border-dark);
    border-radius: 8px;
    width: 100%;
    max-width: 300px;
    margin: 0 auto;
}

#specificDatesCalendar .flatpickr-day.selected,
#specificDatesCalendar .flatpickr-day.startRange,
#specificDatesCalendar .flatpickr-day.endRange {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: var(--secondary-color);
}

#specificDatesCalendar .flatpickr-day.inRange {
    background: rgba(224, 176, 24, 0.3); /* Semi-transparent gold for range */
    border-color: var(--border-dark);
    color: var(--text-color);
}

#specificDatesCalendar .flatpickr-day:hover {
    background: var(--hover-accent);
    border-color: var(--border-dark);
}

/* Additional flatpickr styling to match page theme */
.flatpickr-calendar {
    background: var(--light-bg) !important;
    border: 2px solid var(--primary-color) !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2) !important;
}

.flatpickr-months {
    background: var(--primary-color) !important;
    border-radius: 8px 8px 0 0 !important;
}

.flatpickr-month {
    background: var(--primary-color) !important;
    color: var(--secondary-color) !important;
}

.flatpickr-current-month .flatpickr-monthDropdown-months {
    background: var(--primary-color) !important;
    color: var(--secondary-color) !important;
}

.flatpickr-current-month input.cur-year {
    background: var(--primary-color) !important;
    color: var(--secondary-color) !important;
}

.flatpickr-prev-month, .flatpickr-next-month {
    color: var(--secondary-color) !important;
}

.flatpickr-prev-month:hover, .flatpickr-next-month:hover {
    color: var(--text-color) !important;
    background: rgba(255, 255, 255, 0.2) !important;
}

.flatpickr-weekdays {
    background: var(--accent-color) !important;
    color: var(--text-color) !important;
}

.flatpickr-weekday {
    background: var(--accent-color) !important;
    color: var(--text-color) !important;
    font-weight: 600 !important;
}

.flatpickr-days {
    background: var(--light-bg) !important;
}

.flatpickr-day {
    background: var(--light-bg) !important;
    color: var(--text-color) !important;
    border: 1px solid transparent !important;
}

.flatpickr-day:hover {
    background: rgba(255, 193, 7, 0.1) !important;
    border-color: var(--primary-color) !important;
}

.flatpickr-day.selected {
    background: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
    color: var(--secondary-color) !important;
}

.flatpickr-day.today {
    border-color: var(--primary-color) !important;
    background: rgba(255, 193, 7, 0.1) !important;
    color: var(--text-color) !important;
    font-weight: 600 !important;
}

.flatpickr-day.today.selected {
    background: var(--primary-color) !important;
    color: var(--secondary-color) !important;
}

.flatpickr-day.prevMonthDay, .flatpickr-day.nextMonthDay {
    color: rgba(109, 76, 65, 0.4) !important;
    background: var(--light-bg) !important;
}

.flatpickr-day.prevMonthDay:hover, .flatpickr-day.nextMonthDay:hover {
    background: rgba(255, 193, 7, 0.05) !important;
}

.flatpickr-day.disabled {
    color: rgba(109, 76, 65, 0.2) !important;
    background: var(--light-bg) !important;
}

.flatpickr-time {
    background: var(--light-bg) !important;
    border-top: 1px solid var(--primary-color) !important;
}

.flatpickr-time input {
    background: var(--light-bg) !important;
    color: var(--text-color) !important;
}

/* Add spacing and alignment for the specific dates group */
#specificDatesGroup {
    display: flex;
    flex-direction: column; /* Stack label, button, and chips vertically */
    align-items: flex-start; /* Align items to the left */
    gap: 15px; /* Space between label/button and chips */
}

/* Ensure the button and label are aligned nicely */
#specificDatesGroup .button-wrapper {
    display: flex;
    align-items: center;
    gap: 10px; /* Space between label and + button */
}

/* Adjust container spacing */
#selectedDatesContainer {
    margin-top: 15px; /* Increased from 10px for more breathing room */
    display: flex;
    flex-wrap: wrap;
    gap: 10px; /* Slightly more gap between chips */
    width: 100%; /* Full width for better alignment */
}

#removeEndDateBtn:hover {
  color: #B71C1C;
  transform: scale(1.1);
}








/* Date Mode Selector */
#selectDateMode {
    width: 100%;
    text-align: left;
}

/* Specific Days Checkboxes */
#specificDaysCheckboxes label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
    color: var(--text-color);
}

#specificDaysCheckboxes input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--primary-color);
    cursor: pointer;
}

/* Selected Days Display */
#selectedDaysDisplay {
    max-width: 100%;
    overflow-wrap: break-word;
}



/* Date Section */
.date-section {
    padding: 15px;
    background: var(--light-bg);
    border-radius: 10px;
    border: 1px solid var(--border-dark);
}

.section-label {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 10px;
}

/* Date Mode Selector (Segmented Buttons) */
.date-mode-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    background: rgba(255, 255, 255, 0.05);
    padding: 8px;
    border-radius: 8px;
    border: 1px solid rgba(255, 193, 7, 0.2);
}

.mode-btn {
    flex: 1;
    background: var(--card-bg);
    border: 2px solid var(--primary-color);
    color: var(--text-color);
    font-size: 14px;
    font-weight: 600;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
}

.mode-btn.active {
    background: var(--primary-color);
    color: var(--secondary-color);
    border-color: var(--primary-color);
    box-shadow: 0 2px 6px rgba(255, 193, 7, 0.3);
}

.mode-btn:hover {
    background: rgba(255, 193, 7, 0.1);
    transform: translateY(-1px);
}

.mode-btn.active:hover {
    background: #FFB300;
    transform: translateY(-1px);
}

/* Date Group (From/To, Specific Dates, Specific Days) */
.date-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 0;
    background: transparent;
    border: none;
}

.date-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;
    min-height: 40px;
}

.date-label {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-color);
    min-width: 60px;
    text-transform: capitalize;
}

.add-end-date {
    color: var(--primary-color);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: color 0.3s ease, transform 0.2s ease;
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
    margin-left: 8px;
    white-space: nowrap;
    flex-shrink: 0;
}

.add-end-date:hover {
    color: #FFB300;
    background: rgba(255, 193, 7, 0.2);
    transform: translateY(-1px);
}

.date-range-container {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.date-separator {
    color: var(--text-color);
    font-size: 14px;
    margin: 0 4px;
}

/* Responsive layout for mobile */
@media (max-width: 480px) {
    .date-row {
        flex-wrap: wrap;
        gap: 6px;
    }
    
    .add-end-date {
        margin-left: 4px;
        font-size: 11px;
        padding: 3px 6px;
    }
    
    .date-range-container {
        gap: 6px;
    }
}

.remove-btn {
    cursor: pointer;
    font-size: 16px;
    color: var(--danger-color);
    transition: color 0.3s ease, transform 0.1s ease;
}

.remove-btn:hover {
    color: #B71C1C;
    transform: scale(1.1);
}

/* Container for Day Buttons */
.day-buttons-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: flex-start;
    padding: 8px 0;
}


/* Day Buttons for Specific Days (Original Styles) */
.day-btn {
    position: relative;
    background: var(--light-bg);
    border: 2px solid var(--primary-color);
    color: var(--text-color);
    font-size: 14px;
    font-weight: 600;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
    min-width: 50px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(255, 193, 7, 0.1);
}

.day-btn.selected {
    background: var(--primary-color);
    color: var(--secondary-color);
    border-color: var(--primary-color);
    box-shadow: 0 3px 8px rgba(255, 193, 7, 0.3);
    transform: translateY(-1px);
}



.day-btn:hover {
    background: rgba(255, 193, 7, 0.1);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(255, 193, 7, 0.2);
}

.day-btn.selected:hover {
    background: #FFB300;
    color: var(--secondary-color);
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4);
}


</style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="header">
        <i class="fas fa-bars menu-icon"></i>
        <div class="title">Add Task</div>
    </div>

    <div class="content">
        <form id="addTaskForm">
            <div class="form-group-full">
                <label for="taskTitle"></label>
                <input type="text" id="taskTitle" placeholder="Enter task title" required>
            </div>
            <div class="form-group-full">
                <label for="taskNotes"></label>
                <textarea id="taskNotes" placeholder="Enter any additional notes"></textarea>
            </div>
            <div class="form-group room-section">
                <label>Room</label>
                <button type="button" id="selectRoom" class="select-btn">Select</button>
                <input type="hidden" id="roomSelection" value="">
            </div>
            
            
            <div class="form-group frequency-section">
                <label>Frequency</label>
                <button type="button" id="selectRepeat" class="select-btn">Select</button>
                <input type="hidden" id="repeatSelection" value="">
            </div>
            
            <!-- NEW: Times Per Day input (only shown when Daily is selected) -->
            <div class="form-group" id="timesPerDayGroup" style="display: none; background-color: rgba(255, 193, 7, 0.1); border: 2px solid var(--primary-color); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);">
                <label>Times per Day</label>
                <input type="text" id="timesPerDayInput" value="1" readonly
    style="width: 60px; text-align: center; padding: 8px; border: 2px solid var(--primary-color); border-radius: 8px; background: var(--light-bg); font-size: 16px; cursor: pointer; color: var(--text-color); font-weight: 400;">
            </div>



            <!-- Weekly Frequency Input -->
<div class="form-group" id="timesPerWeekGroup" style="display: none; background-color: rgba(255, 193, 7, 0.1); border: 2px solid var(--primary-color); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);">
    <label>Times per Week</label>
    <input type="text" id="timesPerWeekInput" value="1" readonly
    style="width: 60px; text-align: center; padding: 8px; border: 2px solid var(--primary-color); border-radius: 8px; background: var(--light-bg); font-size: 16px; cursor: pointer; color: var(--text-color); font-weight: 400;">
    

</div>

<!-- Monthly Frequency Input -->
<div class="form-group" id="timesPerMonthGroup" style="display: none; background-color: rgba(255, 193, 7, 0.1); border: 2px solid var(--primary-color); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);">
    <label>Times per Month</label>
    <input type="text" id="timesPerMonthInput" value="1" readonly
style="width: 60px; text-align: center; padding: 8px; border: 2px solid var(--primary-color); border-radius: 8px; background: var(--light-bg); font-size: 16px; cursor: pointer; color: var(--text-color); font-weight: 400;">


</div>

            

            <div class="form-group-full date-section">
                <label class="section-label" id="sectionLabel">Dates</label>
                <div class="date-mode-selector">
                    <button type="button" class="mode-btn active" data-mode="date">üìÖ Date Range</button>
                    <button type="button" class="mode-btn" data-mode="specific-dates">üìÜ Specific Dates</button>
                    <input type="hidden" id="dateModeSelection" value="date">
                </div>
                <div style="margin-bottom: 8px; padding: 8px; background: rgba(255, 193, 7, 0.1); border-radius: 4px; font-size: 13px; color: rgba(255, 255, 255, 0.8);">
                    <span id="modeDescription">üìÖ Choose date range and days of the week for your task</span>
                </div>
                
            
                <!-- Single Date UI for One Time tasks -->
                <div id="singleDateGroup" class="date-group" style="display: none;">
                    <div class="date-row">
                        <span class="date-label">Date</span>
                        <div class="date-display" id="singleDateDisplay">Select Date</div>
                    </div>
                </div>
                
                <!-- From - To Date UI -->
                <div id="fromToDateGroup" class="date-group active-section">
                    <div class="date-row">
                        <span class="date-label">From</span>
                        <div class="date-range-container">
                            <div id="dateDisplay" class="date-display">Today</div>
                            <span id="addEndDateBtn" class="add-end-date">+ Add End Date</span>
                            <span id="dateToWrapper" class="date-separator" style="display: none;">to</span>
                            <div id="dateDisplayTo" class="date-display" style="display: none;">To Date</div>
                            <span id="removeEndDateBtn" class="remove-btn" style="display: none;">‚úñ</span>
                        </div>
                    </div>
                </div>
            
                <!-- Specific Dates UI -->
                <div id="specificDatesGroup" class="date-group inactive-section" style="display: none;">
                    <div class="date-row">
                        <span class="date-label">Dates</span>
                        <button type="button" id="selectSpecificDates" class="plus-btn">+</button>
                    </div>
                    <div id="selectedDatesContainer" style="margin-top: 10px;"></div>
                </div>
            
                <!-- Specific Days UI -->
<!-- Day Selection UI (for Date mode) -->
<div id="specificDaysGroup" class="date-group active-section">
    <div class="date-row">
        <span class="date-label">üìã Days of Week</span>
        <div id="specificDaysButtons" class="day-buttons-container">
            <button type="button" class="day-btn" data-day="Any" id="anyAllButton">Any</button>
            <button type="button" class="day-btn" data-day="Mon">Mon</button>
            <button type="button" class="day-btn" data-day="Tue">Tue</button>
            <button type="button" class="day-btn" data-day="Wed">Wed</button>
            <button type="button" class="day-btn" data-day="Thu">Thu</button>
            <button type="button" class="day-btn" data-day="Fri">Fri</button>
            <button type="button" class="day-btn" data-day="Sat">Sat</button>
            <button type="button" class="day-btn" data-day="Sun">Sun</button>
        </div>
    </div>
</div>

            
                <!-- Hidden inputs -->
                <input type="text" id="taskDate" class="date-input" />
                <input type="text" id="taskDateTo" class="date-input" />
                <input type="text" id="singleTaskDate" class="date-input" />
                <input type="hidden" id="specificDatesInput" value="">
                <input type="hidden" id="specificDaysInput" value="">
            </div>
                
            
            
            <div class="form-group">
                <label>Reminder</label>
                <label class="switch">
                    <input type="checkbox" id="taskReminder">
                    <span class="slider"></span>
                </label>
                <button type="button" id="addAlarmBtn" class="select-btn" style="display: none; margin-left: 10px;">+ Add Alarm</button>
            </div>
            <div id="alarmContainer" style="margin-top: 10px;"></div>

            <div class="form-group">
                <label>Settings</label>
                <button type="button" id="selectSettings" class="select-btn">Select</button>
                <input type="hidden" id="settingsSelection" value="">
            </div>

            <div class="form-group">
                <label>
                    <span id="assignedToDisplay" class="select-btn">Select users</span>
                    <input type="hidden" id="assignedToSelection" value="">
                </label>
            </div>
            <div class="form-group">
                <label>
                    <span id="selectReward" class="select-btn">Buzz Points</span>
                    <input type="hidden" id="RewardValue" value="">
                </label>
                <div class="modal" id="rewardModal">
                    <div class="modal-content fancy-modal">
                        <h3>Buzz Points üçØ</h3>
                        <input type="number" id="rewardInput" placeholder="      Enter Point Amount" min="1" class="fancy-input smaller-input">
                        <div style="margin-top: 10px;">
                            <button id="saveRewardBtn" class="btn-save">Save</button>
                            <button id="closeRewardModal" class="btn-cancel">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit" class="save-btn">Save</button>
           
            <button
            type="button"
            class="btn-cancel"
            style="width: 100%; margin-top: 10px;"
            onclick="handleCancel()"
          >
            Cancel
          </button>
          

        </form>
    </div>


    <!-- Modals -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <h3>Choose User</h3>
            <ul id="userList"></ul>
            <button class="close-btn" id="closeUserModal">Close</button>
        </div>
    </div>

    <div class="modal" id="roomModal">
        <div class="modal-content">
            <h3>Choose Rooms</h3>
            <ul id="roomList">
                <li data-value="Entire Home">Entire Home</li>
                <li data-value="Living Room">Living Room</li>
                <li data-value="Bedroom">Bedroom</li>
                <li data-value="Kitchen">Kitchen</li>
                <li data-value="Bathroom">Bathroom</li>
                <li data-value="Laundry">Laundry</li>
                <li data-value="Garden">Garden</li>
                <li data-value="Outside">Outside</li>
                <li data-value="Other">Other</li>
            </ul>
            <button class="close-btn" id="closeRoomModal">Save</button>
        </div>
    </div>
    



    <div class="modal" id="repeatModal">
        <div class="modal-content">
            <h3>Choose Repeat</h3>
            <ul>
                <li data-value="One Time">One Time</li>
                <li data-value="Daily">Daily</li>
                <li data-value="Weekly">Weekly</li>
                <li data-value="Monthly">Monthly</li>
            </ul>
        </div>
    </div>
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3>Choose Settings</h3>
            <ul>
                <li data-value="Rotation">Rotation</li>
                <li data-value="Team Work">Team Work</li>
                <li data-value="Individual">Individual</li>
            </ul>
        </div>
    </div>

    <div class="modal" id="timesPerDayModal">
        <div class="modal-content fancy-modal">
            <h3>How many times per day?</h3>
            <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 10px 0;">
                <button class="btn-save" data-value="1">1</button>
                <button class="btn-save" data-value="2">2</button>
                <button class="btn-save" data-value="3">3</button>
                <button class="btn-save" data-value="4">4</button>
                <button class="btn-save" data-value="5">5</button>
            </div>
            <input type="number" id="customTimesInput" placeholder="Or enter your own" min="1" class="fancy-input smaller-input">
            <div style="margin-top: 10px;">
                <button id="saveCustomTimesBtn" class="btn-save">Save</button>
                <button class="btn-cancel" id="closeTimesModal">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="timesPerWeekModal">
        <div class="modal-content fancy-modal">
            <h3>How many times per week?</h3>
            <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 10px 0;">
                <button class="btn-save" data-value="1">1</button>
                <button class="btn-save" data-value="2">2</button>
                <button class="btn-save" data-value="3">3</button>
                <button class="btn-save" data-value="4">4</button>
                <button class="btn-save" data-value="5">5</button>
            </div>
            <input type="number" id="customTimesWeekInput" placeholder="Or enter your own" min="1" class="fancy-input smaller-input">
            <div style="margin-top: 10px;">
                <button id="saveCustomTimesWeekBtn" class="btn-save">Save</button>
                <button id="closeTimesWeekModal" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>
    
<div class="modal" id="timesPerMonthModal">
    <div class="modal-content fancy-modal">
        <h3>How many times per month?</h3>
        <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 10px 0;">
            <button class="btn-save" data-value="1">1</button>
            <button class="btn-save" data-value="2">2</button>
            <button class="btn-save" data-value="3">3</button>
            <button class="btn-save" data-value="4">4</button>
            <button class="btn-save" data-value="5">5</button>
        </div>
        <input type="number" id="customTimesMonthInput" placeholder="Or enter your own" min="1" class="fancy-input smaller-input">
        <div style="margin-top: 10px;">
            <button id="saveCustomTimesMonthBtn" class="btn-save">Save</button>
            <button id="closeTimesMonthModal" class="btn-cancel">Cancel</button>
        </div>
    </div>
</div>


<div class="modal" id="specificDatesModal">
    <div class="modal-content fancy-modal">
        <h3>Select Specific Dates</h3>
        <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-bottom: 15px;">Choose dates for the task or leave empty for every day.</p>
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <button id="clearSpecificDates" class="btn-cancel">Clear</button>
            <button id="saveSpecificDates" class="btn-save">Save</button>
        </div>
        <div id="specificDatesCalendar" style="margin: 20px 0;"></div>
    </div>
</div>
   





    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="/BeeMazing-A1/shared/taskrotations.js?t=${Date.now()}"></script>
    <script>


let editTaskFullDate = null; // Initialize as null

// Global variables for edit modes (accessible to form handler)
let isOccurrenceEdit = false;
let isFutureEdit = false;
let targetDate = null;
let splitDate = null;
let originalStartDate = null;
let editTask = null;

document.addEventListener("DOMContentLoaded", async () => {
    const currentAdmin = localStorage.getItem("currentAdminEmail");
    if (!currentAdmin) {
        alert("Admin not logged in!");
        return;
    }


    // Check if in edit mode via URL parameters or localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const editTitle = urlParams.get("editTitle");
    const editDate = urlParams.get("editDate");

    // Check for new editing modes from localStorage
    const editTaskData = localStorage.getItem("familyApp_editTask");
    const editTaskIndex = localStorage.getItem("familyApp_editTask_index");
    editTask = null;
    isOccurrenceEdit = false;
    isFutureEdit = false;
    targetDate = null;
    splitDate = null;
    originalStartDate = null;

    if (editTaskData) {
        try {
            editTask = JSON.parse(editTaskData);
            isOccurrenceEdit = editTask.isOccurrenceEdit || false;
            isFutureEdit = editTask.isFutureEdit || false;
            targetDate = editTask.targetDate || null;
            splitDate = editTask.splitDate || null;
            originalStartDate = editTask.originalStartDate || null;
            
            // Clear localStorage after reading
            localStorage.removeItem("familyApp_editTask");
            localStorage.removeItem("familyApp_editTask_index");
        } catch (error) {
            console.error("Error parsing edit task data:", error);
        }
    } else if (editTitle && editDate) {
        // Fetch all tasks from server and find the matching task
        try {
            const response = await fetch(`https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}`, {
                method: "GET",
                headers: { "Content-Type": "application/json" }
            });
            const data = await response.json();
            if (response.ok && data.tasks) {
                // Find task by title and date (date matches start date of range)
                editTask = data.tasks.find(task => task.title === editTitle && task.date.startsWith(editDate));
                if (!editTask) {
                    console.error(`Task not found: title=${editTitle}, date=${editDate}`);
                }
            } else {
                console.error("Failed to fetch tasks:", data.error || "No tasks returned");
            }
        } catch (error) {
            console.error("Error fetching tasks:", error);
        }
    }

    if (editTask) {
        // Set the full date range for the PUT request
        editTaskFullDate = editTask.date; // Assign value here
        // Populate form for editing
        document.getElementById("taskTitle").value = editTask.title || "";
        document.getElementById("taskNotes").value = editTask.notes || "";
        if (editTask.room) {
            selectedRooms = editTask.room.split(",").map(r => r.trim());
            document.getElementById("roomSelection").value = selectedRooms.join(", ");
            document.getElementById("selectRoom").textContent = selectedRooms.join(", ");
        }
        document.getElementById("repeatSelection").value = editTask.repeat || "";
        document.getElementById("selectRepeat").textContent = editTask.repeat || "Select";
        document.getElementById("settingsSelection").value = editTask.settings || "";
        document.getElementById("selectSettings").textContent = editTask.settings || "Select";
        document.getElementById("taskReminder").checked = !!editTask.reminder;
        document.getElementById("addAlarmBtn").style.display = editTask.reminder ? "inline-block" : "none";
        document.getElementById("RewardValue").value = editTask.reward || "";
        document.getElementById("selectReward").textContent = editTask.reward ? `Buzz Points: ${editTask.reward} üçØ` : "Reward";

        // Handle times per day/week/month
        document.getElementById("timesPerDayInput").value = editTask.timesPerDay || "1";
        document.getElementById("timesPerWeekInput").value = editTask.timesPerWeek || "1";
        document.getElementById("timesPerMonthInput").value = editTask.timesPerMonth || "1";
        document.getElementById("timesPerDayGroup").style.display = editTask.repeat === "Daily" ? "flex" : "none";
        document.getElementById("timesPerWeekGroup").style.display = editTask.repeat === "Weekly" ? "flex" : "none";
        document.getElementById("timesPerMonthGroup").style.display = editTask.repeat === "Monthly" ? "flex" : "none";
        
        // Update section label and Any/All button based on frequency
        const sectionLabel = document.getElementById("sectionLabel");
        const anyAllButton = document.getElementById("anyAllButton");
        if (sectionLabel && anyAllButton) {
            if (editTask.repeat === "Daily") {
                sectionLabel.textContent = "Days";
                anyAllButton.textContent = "All";
                anyAllButton.setAttribute("data-day", "All");
            } else {
                sectionLabel.textContent = "Dates";
                anyAllButton.textContent = "Any";
                anyAllButton.setAttribute("data-day", "Any");
            }
        }

        // Handle date mode
        if (editTask.specificDates) {
            document.getElementById("dateModeSelection").value = "specific-dates";
            document.querySelectorAll(".mode-btn").forEach(btn => btn.classList.remove("active"));
            document.querySelector(".mode-btn[data-mode='specific-dates']").classList.add("active");
            document.getElementById("specificDatesGroup").style.display = "block";
            document.getElementById("fromToDateGroup").style.display = "none";
            document.getElementById("specificDaysGroup").style.display = "none";
            selectedDates = editTask.specificDates.split(",").map(date => new Date(date));
            specificDatesInput.value = editTask.specificDates;
            flatpickrSpecific.setDate(selectedDates);
            updateSelectedDatesDisplay();
        } else if (editTask.date) {
            document.getElementById("dateModeSelection").value = "date";
            document.querySelectorAll(".mode-btn").forEach(btn => btn.classList.remove("active"));
            document.querySelector(".mode-btn[data-mode='date']").classList.add("active");
            document.getElementById("fromToDateGroup").style.display = "block";
            document.getElementById("specificDatesGroup").style.display = "none";
            document.getElementById("specificDaysGroup").style.display = "block";

            const [from, to] = editTask.date.split(" to ");
            document.getElementById("taskDate").value = from || "";
            flatpickrFrom.setDate(from);
            document.getElementById("dateDisplay").textContent = new Date(from).toLocaleDateString(undefined, {
                month: "long",
                day: "numeric",
            });
            if (to && to !== "3000-01-01") {
                document.getElementById("taskDateTo").value = to;
                flatpickrTo.setDate(to);
                document.getElementById("dateDisplayTo").textContent = new Date(to).toLocaleDateString(undefined, {
                    month: "long",
                    day: "numeric",
                });
                document.getElementById("dateToWrapper").style.display = "inline";
                document.getElementById("dateDisplayTo").style.display = "inline-block";
                document.getElementById("removeEndDateBtn").style.display = "inline-block";
                addEndDateBtn.style.display = "none";
                dateMode = "from-to";
            } else {
                document.getElementById("taskDateTo").value = "";
                document.getElementById("dateDisplayTo").textContent = "To Date";
                document.getElementById("dateToWrapper").style.display = "none";
                document.getElementById("dateDisplayTo").style.display = "none";
                document.getElementById("removeEndDateBtn").style.display = "none";
                addEndDateBtn.style.display = "inline-block";
                dateMode = "from";
            }

            // Handle days of week for edit mode
            selectedDays = editTask.daysOfWeek || (editTask.repeat === "Daily" ? ["All"] : ["Any"]);
            updateSelectedDaysDisplay();
        }

        // Special handling for single occurrence and future edits
        if (isOccurrenceEdit && targetDate) {
            // For single occurrence edit, set the date to the target date and disable date changes
            document.getElementById("dateModeSelection").value = "date";
            document.getElementById("taskDate").value = targetDate;
            flatpickrFrom.setDate(targetDate);
            document.getElementById("dateDisplay").textContent = new Date(targetDate).toLocaleDateString(undefined, {
                month: "long",
                day: "numeric",
            });
            // Hide end date for single occurrence and disable date inputs
            document.getElementById("taskDateTo").value = "";
            dateToWrapper.style.display = "none";
            addEndDateBtn.style.display = "none";
            
            // Disable date changes for single occurrence
            document.getElementById("taskDate").disabled = true;
            document.getElementById("dateModeSelection").disabled = true;
            if (flatpickrFrom) flatpickrFrom.destroy();
            
            // Add notice
            const form = document.getElementById("addTaskForm");
            const notice = document.createElement("div");
            notice.style.background = "#ffeb3b";
            notice.style.color = "#333";
            notice.style.padding = "10px";
            notice.style.borderRadius = "8px";
            notice.style.marginBottom = "15px";
            notice.style.fontWeight = "bold";
            notice.innerHTML = `üìÖ Editing single occurrence for ${new Date(targetDate).toLocaleDateString()} - Date cannot be changed`;
            form.insertBefore(notice, form.firstChild);
            
        } else if (isFutureEdit && splitDate) {
            // For future edit, set the date from split date onwards
            document.getElementById("dateModeSelection").value = "date";
            document.getElementById("taskDate").value = splitDate;
            flatpickrFrom.setDate(splitDate);
            document.getElementById("dateDisplay").textContent = new Date(splitDate).toLocaleDateString(undefined, {
                month: "long",
                day: "numeric",
            });
            
            // Keep original end date if it exists
            const originalRange = editTask.date.split(" to ");
            const originalEnd = originalRange[1];
            if (originalEnd && originalEnd !== "3000-01-01") {
                document.getElementById("taskDateTo").value = originalEnd;
                flatpickrTo.setDate(originalEnd);
                document.getElementById("dateDisplayTo").textContent = new Date(originalEnd).toLocaleDateString(undefined, {
                    month: "long",
                    day: "numeric",
                });
                document.getElementById("dateToWrapper").style.display = "inline";
                document.getElementById("dateDisplayTo").style.display = "inline-block";
                document.getElementById("removeEndDateBtn").style.display = "inline-block";
                addEndDateBtn.style.display = "none";
            }
            
            // Add notice
            const form = document.getElementById("addTaskForm");
            const notice = document.createElement("div");
            notice.style.background = "#2196f3";
            notice.style.color = "white";
            notice.style.padding = "10px";
            notice.style.borderRadius = "8px";
            notice.style.marginBottom = "15px";
            notice.style.fontWeight = "bold";
            notice.innerHTML = `üîÑ Editing from ${new Date(splitDate).toLocaleDateString()} onwards - Start date locked`;
            form.insertBefore(notice, form.firstChild);
            
            // Disable start date changes for future edit
            document.getElementById("taskDate").disabled = true;
        }

        if (editTask.users) {
            selectedUsers = [...editTask.users].map(u => u.trim()).filter(u => u);
            updateSelectedUsersDisplay();
            populateUsers();
        }

        if (editTask.alarms?.length) {
            alarms = [...editTask.alarms];
            alarms.forEach((time) => {
                const alarmWrapper = document.createElement("div");
                alarmWrapper.style.marginBottom = "10px";
                alarmWrapper.style.display = "flex";
                alarmWrapper.style.alignItems = "center";
                const alarmInput = document.createElement("input");
                alarmInput.type = "time";
                alarmInput.value = time;
                alarmInput.style.marginRight = "10px";
                alarmInput.style.padding = "10px";
                alarmInput.style.border = "2px solid var(--primary-color)";
                alarmInput.style.borderRadius = "8px";
                alarmInput.style.background = "var(--accent-color)";
                const removeButton = document.createElement("button");
                removeButton.textContent = "Remove";
                removeButton.style.padding = "5px 10px";
                removeButton.style.backgroundColor = "var(--danger-color)";
                removeButton.style.color = "var(--accent-color)";
                removeButton.style.border = "none";
                removeButton.style.borderRadius = "8px";
                removeButton.addEventListener("click", () => {
                    alarmWrapper.remove();
                    alarms = alarms.filter((a) => a !== time);
                });
                alarmWrapper.appendChild(alarmInput);
                alarmWrapper.appendChild(removeButton);
                alarmContainer.appendChild(alarmWrapper);
            });
        }
    } else {
        // Initialize form for new task
        populateUsers();
        document.getElementById("dateModeSelection").value = "date";
        document.querySelectorAll(".mode-btn").forEach(btn => btn.classList.remove("active"));
        document.querySelector(".mode-btn[data-mode='date']").classList.add("active");
        document.getElementById("fromToDateGroup").style.display = "block";
        document.getElementById("specificDatesGroup").style.display = "none";
        document.getElementById("specificDaysGroup").style.display = "block";
    }


});

// Global modal functions - moved outside DOMContentLoaded scope
function showModal(modal) {
    modal.classList.remove('hide');
    modal.classList.add('show');
    modal.style.display = 'flex';
}

// Hide modal with smooth transition
function hideModal(modal) {
    modal.classList.remove('show');
    modal.classList.add('hide');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

function setupTimesModal(inputEl, modalEl, closeBtnEl, customInputEl, saveBtnEl) {
    // Open modal on focus
    inputEl.addEventListener("focus", () => {
        customInputEl.value = "";
        showModal(modalEl);
    });

    // Setup quick select buttons
    modalEl.querySelectorAll('button[data-value]').forEach(btn => {
        btn.addEventListener("click", () => {
            inputEl.value = btn.getAttribute("data-value");
            hideModal(modalEl);
        });
    });

    // Save custom value
    saveBtnEl.addEventListener("click", () => {
        let val = parseInt(customInputEl.value.trim());
        if (val && val > 0) {
            val = Math.min(val, 100);
            inputEl.value = val;
            hideModal(modalEl);
        }
    });

    // Close modal
    closeBtnEl.addEventListener("click", () => {
        hideModal(modalEl);
    });
}

    
        // User Modal Logic
        const userModal = document.getElementById("userModal");
        const assignedToDisplay = document.getElementById("assignedToDisplay");
        const userList = document.getElementById("userList");
        const assignedToSelection = document.getElementById("assignedToSelection");
    
        let selectedUsers = [];








        async function populateUsers() {
    const currentAdmin = localStorage.getItem("currentAdminEmail");
    if (!currentAdmin) {
        console.error("No admin email found in localStorage");
        assignedToDisplay.textContent = "Error: No admin logged in";
        return;
    }

    try {
        const response = await fetch(`https://beemazing1.onrender.com/get-users?adminEmail=${encodeURIComponent(currentAdmin)}`, {
            method: "GET",
            headers: { "Content-Type": "application/json" }
        });

        const data = await response.json();
        console.log("Fetched users:", data); // Debug log

        if (!response.ok || !data.success) {
            throw new Error(data.message || `HTTP ${response.status}`);
        }

        const { users = [], permissions = {} } = data;

        // Use all users (no filtering for Admin)
        const allUsers = users;

        // Update localStorage to sync with backend
        const allUserData = JSON.parse(localStorage.getItem("userData") || "{}");
        allUserData[currentAdmin] = allUserData[currentAdmin] || { users: [], permissions: {} };
        allUserData[currentAdmin].users = allUsers;
        allUserData[currentAdmin].permissions = permissions;
        localStorage.setItem("userData", JSON.stringify(allUserData));

        // Clear existing user list
        userList.innerHTML = "";

        // Populate user list
        allUsers.forEach(user => {
            const userItem = document.createElement("li");
            userItem.textContent = user; // Display only the user email
            userItem.style.padding = "10px";
            userItem.style.margin = "5px 0";
            userItem.style.border = "1px solid var(--selection-border)";
            userItem.style.borderRadius = "8px";
            userItem.style.cursor = "pointer";
            userItem.style.textAlign = "center";

            if (selectedUsers.includes(user)) {
                userItem.style.backgroundColor = "var(--primary-color)";
                userItem.style.color = "var(--secondary-color)";
            } else {
                userItem.style.backgroundColor = "var(--light-bg)";
                userItem.style.color = "var(--text-color)";
            }

            userItem.addEventListener("mouseover", () => {
                userItem.style.backgroundColor = "var(--primary-color)";
                userItem.style.color = "var(--secondary-color)";
            });
            userItem.addEventListener("mouseout", () => {
                if (selectedUsers.includes(user)) {
                    userItem.style.backgroundColor = "var(--primary-color)";
                    userItem.style.color = "var(--secondary-color)";
                } else {
                    userItem.style.backgroundColor = "var(--light-bg)";
                    userItem.style.color = "var(--text-color)";
                }
            });
            userItem.addEventListener("click", () => {
                if (selectedUsers.includes(user)) {
                    selectedUsers = selectedUsers.filter(u => u !== user);
                    userItem.style.backgroundColor = "var(--light-bg)";
                    userItem.style.color = "var(--text-color)";
                } else {
                    selectedUsers.push(user);
                    userItem.style.backgroundColor = "var(--primary-color)";
                    userItem.style.color = "var(--secondary-color)";
                }
                updateSelectedUsersDisplay();
            });
            userList.appendChild(userItem);
        });

        // Update display
        updateSelectedUsersDisplay();
        assignedToDisplay.textContent = allUsers.length ? "Select users" : "No users available";

    } catch (error) {
        console.error("Error fetching users:", error);
        assignedToDisplay.textContent = "Error loading users";
    }
}








    
        const updateSelectedUsersDisplay = () => {
    // Clean the selectedUsers array just in case
    selectedUsers = selectedUsers.map(u => u.trim()).filter(u => u);

    // Set value and display cleanly
    assignedToSelection.value = selectedUsers.join(", ");
    assignedToDisplay.textContent = selectedUsers.length > 0
        ? selectedUsers.join(", ")
        : "Select users";
};


    
        assignedToDisplay.addEventListener("click", () => {
            showModal(userModal);
        });
    
        window.addEventListener("click", (e) => {
            if (e.target === userModal) {
                hideModal(userModal);
            }
        });
    
        document.getElementById("closeUserModal").addEventListener("click", () => {
            hideModal(userModal);
        });
    
        // Reward Modal Logic
        const rewardModal = document.getElementById("rewardModal");
        const selectRewardButton = document.getElementById("selectReward");
        const rewardValueInput = document.getElementById("RewardValue");
        const rewardInput = document.getElementById("rewardInput");
        const saveRewardButton = document.getElementById("saveRewardBtn");
        const closeRewardButton = document.getElementById("closeRewardModal");
    
        selectRewardButton.addEventListener("click", () => {
            showModal(rewardModal);
        });
    
        saveRewardButton.addEventListener("click", (event) => {
            event.preventDefault();
            const reward = rewardInput.value;
            if (reward) {
                rewardValueInput.value = reward;
                selectRewardButton.textContent = `Buzz Points: ${reward} üçØ`;
            }
            hideModal(rewardModal);
        });
    
        closeRewardButton.addEventListener("click", () => {
            hideModal(rewardModal);
        });
    
        // Generic Modal Setup
        function setupModal(modalId, buttonId, inputId) {
            const modal = document.getElementById(modalId);
            const button = document.getElementById(buttonId);
            const input = document.getElementById(inputId);
    
            button.addEventListener('click', () => {
                showModal(modal);
            });
    
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideModal(modal);
                }
            });
    
            modal.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    input.value = e.target.getAttribute('data-value');
                    button.textContent = e.target.getAttribute('data-value');
                    hideModal(modal);
                }
            });
        }
    
        setupModal('settingsModal', 'selectSettings', 'settingsSelection');




        const roomModal = document.getElementById("roomModal");
const roomList = document.getElementById("roomList");
const roomInput = document.getElementById("roomSelection");
const roomButton = document.getElementById("selectRoom");
const closeRoomModal = document.getElementById("closeRoomModal");

let selectedRooms = [];

roomButton.addEventListener("click", () => {
    showModal(roomModal);
});

roomList.querySelectorAll("li").forEach(item => {
    item.style.cursor = "pointer";
    item.style.padding = "10px";
    item.style.margin = "5px 0";
    item.style.border = "1px solid var(--selection-border)";
    item.style.borderRadius = "8px";
    item.style.textAlign = "center";

    item.addEventListener("click", () => {
        const value = item.getAttribute("data-value");
        if (selectedRooms.includes(value)) {
            selectedRooms = selectedRooms.filter(r => r !== value);
            item.style.backgroundColor = "var(--light-bg)";
            item.style.color = "var(--text-color)";
        } else {
            selectedRooms.push(value);
            item.style.backgroundColor = "var(--primary-color)";
            item.style.color = "var(--secondary-color)";
        }
        roomInput.value = selectedRooms.join(", ");
        roomButton.textContent = selectedRooms.length > 0
            ? selectedRooms.join(", ")
            : "Select";
    });
});

closeRoomModal.addEventListener("click", () => {
    hideModal(roomModal);
});

window.addEventListener("click", (e) => {
    if (e.target === roomModal) {
        hideModal(roomModal);
    }
});

// Form submission handler - in global scope with access to global variables
document.addEventListener("DOMContentLoaded", () => {
document.getElementById("addTaskForm").addEventListener("submit", async function (event) {
event.preventDefault();

const title = document.getElementById("taskTitle").value.trim();
const notes = document.getElementById("taskNotes").value.trim();
const room = document.getElementById("roomSelection").value;
const repeat = document.getElementById("repeatSelection").value;
const settings = document.getElementById("settingsSelection").value;
const dateFrom = document.getElementById("taskDate").value;
const dateTo = document.getElementById("taskDateTo").value;
const singleDate = document.getElementById("singleTaskDate").value;
const dateMode = document.getElementById("dateModeSelection").value;
const reminder = document.getElementById("taskReminder").checked;
const users = document.getElementById("assignedToSelection").value
    .split(",")
    .map(u => u.trim())
    .filter(u => u);
const reward = document.getElementById("RewardValue").value;
let timesPerDay = parseInt(document.getElementById("timesPerDayInput").value) || null;
let timesPerWeek = parseInt(document.getElementById("timesPerWeekInput").value) || null;
let timesPerMonth = parseInt(document.getElementById("timesPerMonthInput").value) || null;
const specificDates = document.getElementById("specificDatesInput").value;

// Validations
if (!title) {
    alert("Task title is required!");
    return;
}
if (users.length === 0) {
    alert("Please assign at least one user.");
    return;
}
        
// Special validation for editing modes
if (isOccurrenceEdit && !targetDate) {
    alert("Invalid occurrence edit - missing target date.");
    return;
}
if (isFutureEdit && !splitDate) {
    alert("Invalid future edit - missing split date.");
    return;
}
        
if (!isOccurrenceEdit && !isFutureEdit) {
    if (repeat === "One Time" && !singleDate) {
        alert("Please select a date for this one-time task.");
        return;
    }
    if (dateMode === "date" && repeat !== "One Time" && !dateFrom) {
        alert("Please select a start date.");
        return;
    }
    if (dateMode === "specific-dates" && !specificDates) {
        alert("Please select at least one date.");
        return;
    }
}

// Cap and sanitize
if (timesPerDay > 100) timesPerDay = 100;
if (timesPerWeek > 100) timesPerWeek = 100;
if (timesPerMonth > 100) timesPerMonth = 100;
if (timesPerDay !== null && timesPerDay < 1) timesPerDay = 1;
if (timesPerWeek !== null && timesPerWeek < 1) timesPerWeek = 1;
if (timesPerMonth !== null && timesPerMonth < 1) timesPerMonth = 1;

let dateValue = "";
if (isOccurrenceEdit) {
    // For single occurrence, use target date as both start and end for clarity
    dateValue = `${targetDate} to ${targetDate}`;
} else if (isFutureEdit) {
    // For future edit, use split date as start
    const originalRange = editTask.date.split(" to ");
    const originalEnd = originalRange[1] || "3000-01-01";
    dateValue = `${splitDate} to ${originalEnd}`;
} else if (repeat === "One Time") {
    dateValue = `${singleDate} to ${singleDate}`;
} else if (dateMode === "date") {
    const fromDate = dateFrom;
    const toDate = dateTo || "3000-01-01";
    dateValue = `${fromDate} to ${toDate}`;
} else if (dateMode === "specific-dates" && specificDates) {
    const dates = specificDates.split(",").map(d => d.trim()).filter(d => d);
    dateValue = `${dates[0]} to ${dates[dates.length - 1]}`;
} else {
    const today = new Date().toISOString().split("T")[0];
    dateValue = `${today} to 3000-01-01`;
}

const task = {
    title,
    notes: notes || undefined,
    room: room || undefined,
    repeat: repeat || undefined,
    settings: settings || undefined,
    date: dateValue,
    reminder: reminder || undefined,
    users,
    reward: reward || undefined,
    alarms: alarms.length > 0 ? alarms : undefined,
    timesPerDay: repeat === "Daily" ? timesPerDay : undefined,
    timesPerWeek: repeat === "Weekly" ? timesPerWeek : undefined,
    timesPerMonth: repeat === "Monthly" ? timesPerMonth : undefined,
    specificDates: dateMode === "specific-dates" ? specificDates : undefined,
    daysOfWeek: dateMode === "date" ? (selectedDays.length > 0 ? (selectedDays.includes("All") ? ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] : selectedDays) : (repeat === "Daily" ? ["All"] : ["Any"])) : undefined
};

console.log("Task being saved:", JSON.stringify(task, null, 2));

const currentAdmin = localStorage.getItem("currentAdminEmail");
const urlParams = new URLSearchParams(window.location.search);
const editTitle = urlParams.get("editTitle");
const editDate = urlParams.get("editDate");
const from = urlParams.get("from");
const originalUser = urlParams.get("user") || localStorage.getItem("currentUser");

if (!originalUser) {
    alert("No user context available. Redirecting to user selection.");
    window.location.href = "/BeeMazing-A1/mobile/2-UserProfiles/userAdmin.html";
    return;
}

try {
    const url = "https://beemazing1.onrender.com/api/tasks";
    let body;
    let method = "POST";
    let endpoint = "https://beemazing1.onrender.com/api/tasks";

    if (isOccurrenceEdit && targetDate && originalStartDate && editTask) {
        // Single occurrence edit
        method = "PUT";
        endpoint = "https://beemazing1.onrender.com/api/tasks/occurrence";
        body = {
            adminEmail: currentAdmin,
            originalTitle: editTask.title,
            originalStartDate: originalStartDate,
            targetDate: targetDate,
            modifiedTask: task
        };
    } else if (isFutureEdit && splitDate && originalStartDate && editTask) {
        // Future occurrences edit (split task)
        method = "PUT";
        endpoint = "https://beemazing1.onrender.com/api/tasks/future";
        body = {
            adminEmail: currentAdmin,
            originalTitle: editTask.title,
            originalStartDate: originalStartDate,
            splitDate: splitDate,
            modifiedTask: task
        };
    } else if (editTitle && editDate) {
        // Original edit mode
        method = "PUT";
        body = {
            adminEmail: currentAdmin,
            task,
            originalTitle: editTitle,
            originalDate: editTaskFullDate
        };
    } else {
        // New task
        body = { adminEmail: currentAdmin, task };
    }

    const response = await fetch(endpoint, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    const data = await response.json();
    if (!response.ok) throw new Error(data.error || `HTTP error ${response.status}`);

    console.log("Server response:", data);

    if (isOccurrenceEdit) {
        alert("Single occurrence updated successfully!");
    } else if (isFutureEdit) {
        alert("Future occurrences updated successfully!");
    } else {
        alert("Task saved successfully!");
    }

    // Store task title in localStorage if coming from onboarding
    if (from === "onboarding") {
        const existingTitles = JSON.parse(localStorage.getItem("onboardingTaskTitles") || "[]");
        if (!existingTitles.includes(title)) {
            existingTitles.push(title);
            localStorage.setItem("onboardingTaskTitles", JSON.stringify(existingTitles));
        }
    }

    // Redirect back to the original user's tasks.html or onboarding
    const adminEmail = encodeURIComponent(currentAdmin || "");
    if (from === "onboarding") {
        window.location.href = `/BeeMazing-A1/onboarding.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}#step4`;
    } else if (isOccurrenceEdit || isFutureEdit) {
        // Redirect back to taskz.html for specific date views
        window.location.href = `/BeeMazing-A1/taskz.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}`;
    } else {
        window.location.href = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}`;
    }

} catch (error) {
    console.error("Error saving task:", error);
    alert(`Failed to save task: ${error.message}`);
}
});
});
    
    




        const repeatModal = document.getElementById('repeatModal');
const repeatButton = document.getElementById('selectRepeat');
const repeatInput = document.getElementById('repeatSelection');
const timesPerDayGroup = document.getElementById('timesPerDayGroup');
const timesPerWeekGroup = document.getElementById('timesPerWeekGroup');
const timesPerMonthGroup = document.getElementById('timesPerMonthGroup');


repeatButton.addEventListener('click', () => {
    showModal(repeatModal);
});

window.addEventListener('click', (e) => {
    if (e.target === repeatModal) {
        hideModal(repeatModal);
    }
});

repeatModal.addEventListener('click', (e) => {
    if (e.target.tagName === 'LI') {
        const selected = e.target.getAttribute('data-value');
        repeatInput.value = selected;
        repeatButton.textContent = selected;
        hideModal(repeatModal);

        // Show/hide correct "x times" groups and date sections
        timesPerDayGroup.style.display = selected === "Daily" ? "flex" : "none";
        timesPerWeekGroup.style.display = selected === "Weekly" ? "flex" : "none";
        timesPerMonthGroup.style.display = selected === "Monthly" ? "flex" : "none";
        
        // Update section label and Any/All button based on frequency
        const sectionLabel = document.getElementById("sectionLabel");
        const anyAllButton = document.getElementById("anyAllButton");
        if (sectionLabel && anyAllButton) {
            if (selected === "Daily") {
                sectionLabel.textContent = "Days";
                anyAllButton.textContent = "All";
                anyAllButton.setAttribute("data-day", "All");
                // Convert Any to All if it's currently selected, or set default
                if (selectedDays.includes("Any") || selectedDays.length === 0) {
                    selectedDays = ["All"];
                    updateSelectedDaysDisplay();
                }
            } else {
                sectionLabel.textContent = "Dates";
                anyAllButton.textContent = "Any";
                anyAllButton.setAttribute("data-day", "Any");
                // Convert All to Any if it's currently selected, or set default
                if (selectedDays.includes("All") || (selectedDays.length === 7 && ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"].every(day => selectedDays.includes(day)))) {
                    selectedDays = ["Any"];
                    updateSelectedDaysDisplay();
                }
            }
        }
        
        // Toggle date input sections based on frequency
        const singleDateGroup = document.getElementById("singleDateGroup");
        const fromToDateGroup = document.getElementById("fromToDateGroup");
        const specificDaysGroup = document.getElementById("specificDaysGroup");
        
        if (selected === "One Time") {
            singleDateGroup.style.display = "block";
            fromToDateGroup.style.display = "none";
            specificDaysGroup.style.display = "none";
        } else {
            singleDateGroup.style.display = "none";
            fromToDateGroup.style.display = "block";
            specificDaysGroup.style.display = "block";
        }

        // Set initial value to 1
        if (selected === "Daily") timesPerDayInput.value = "1";
        if (selected === "Weekly") document.getElementById("timesPerWeekInput").value = "1";
        if (selected === "Monthly") document.getElementById("timesPerMonthInput").value = "1";
    }
});


const timesPerDayInput = document.getElementById("timesPerDayInput");
const timesPerDayModal = document.getElementById("timesPerDayModal");
const closeTimesModal = document.getElementById("closeTimesModal");
const saveCustomTimesBtn = document.getElementById("saveCustomTimesBtn");
const customTimesInput = document.getElementById("customTimesInput");

// Open modal when input clicked
timesPerDayInput.addEventListener("focus", () => {
    customTimesInput.value = ""; // Clear previous custom input
    showModal(timesPerDayModal);
});


// Quick pick buttons (1‚Äì5)
timesPerDayModal.querySelectorAll("button[data-value]").forEach(btn => {
    btn.addEventListener("click", () => {
        timesPerDayInput.value = btn.getAttribute("data-value");
        hideModal(timesPerDayModal);
    });
});

// Custom input save
saveCustomTimesBtn.addEventListener("click", () => {
    let val = customTimesInput.value.trim();
    if (val && parseInt(val) > 0) {
        val = Math.min(parseInt(val), 100); // cap at 100
        timesPerDayInput.value = val;
        hideModal(timesPerDayModal);
    }
});


// Close modal
closeTimesModal.addEventListener("click", () => {
    hideModal(timesPerDayModal);
});


// Existing setup for Daily
setupTimesModal(
    document.getElementById("timesPerDayInput"),
    document.getElementById("timesPerDayModal"),
    document.getElementById("closeTimesModal"),
    document.getElementById("customTimesInput"),
    document.getElementById("saveCustomTimesBtn")
);

// Existing setup for Monthly
setupTimesModal(
    document.getElementById("timesPerMonthInput"),
    document.getElementById("timesPerMonthModal"),
    document.getElementById("closeTimesMonthModal"),
    document.getElementById("customTimesMonthInput"),
    document.getElementById("saveCustomTimesMonthBtn")
);

// NEW: Setup for Weekly
setupTimesModal(
    document.getElementById("timesPerWeekInput"),
    document.getElementById("timesPerWeekModal"),
    document.getElementById("closeTimesWeekModal"),
    document.getElementById("customTimesWeekInput"),
    document.getElementById("saveCustomTimesWeekBtn")
);

// Close times modals when clicking outside
window.addEventListener('click', (e) => {
    if (e.target === timesPerDayModal) hideModal(timesPerDayModal);
    if (e.target === document.getElementById("timesPerWeekModal")) hideModal(document.getElementById("timesPerWeekModal"));
    if (e.target === document.getElementById("timesPerMonthModal")) hideModal(document.getElementById("timesPerMonthModal"));
});




    
        // Date Mode Toggle Logic
        const dateDisplay = document.getElementById("dateDisplay");
const dateDisplayTo = document.getElementById("dateDisplayTo");
const dateInputFrom = document.getElementById("taskDate");
const dateInputTo = document.getElementById("taskDateTo");
const addEndDateBtn = document.getElementById("addEndDateBtn");

let dateMode = "from"; // default

const dateToWrapper = document.getElementById("dateToWrapper");
const removeEndDateBtn = document.getElementById("removeEndDateBtn");

addEndDateBtn.addEventListener("click", () => {
  flatpickrTo.open();
});


removeEndDateBtn.addEventListener("click", () => {
  dateMode = "from";
  document.getElementById("taskDateTo").value = "";
  document.getElementById("dateDisplayTo").textContent = "To Date";
  document.getElementById("dateToWrapper").style.display = "none";
  document.getElementById("dateDisplayTo").style.display = "none";
  document.getElementById("removeEndDateBtn").style.display = "none";
  addEndDateBtn.style.display = "inline-block";
});


    
        // Single date picker for One Time tasks
        const flatpickrSingle = flatpickr("#singleTaskDate", {
            dateFormat: "Y-m-d",
            defaultDate: "today",
            onChange: function(selectedDates, dateStr) {
                document.getElementById("singleDateDisplay").textContent = selectedDates[0] 
                    ? selectedDates[0].toLocaleDateString(undefined, { month: "long", day: "numeric" })
                    : "Select Date";
            }
        });
        
        document.getElementById("singleDateDisplay").addEventListener("click", () => {
            flatpickrSingle.open();
        });
        
        const flatpickrFrom = flatpickr("#taskDate", {
            dateFormat: "Y-m-d",
            defaultDate: "today",
            disableMobile: true,
            onChange: function (selectedDates) {
                const formatted = new Date(selectedDates[0]).toLocaleDateString(undefined, { month: 'long', day: 'numeric' });
                dateDisplay.textContent = formatted;
            },
            positionElement: dateDisplay,
            appendTo: document.body
        });
    
        const flatpickrTo = flatpickr("#taskDateTo", {
  dateFormat: "Y-m-d",
  disableMobile: true,
  onChange: function (selectedDates) {
    if (selectedDates.length > 0) {
      const toDate = selectedDates[0];
      const formatted = toDate.toLocaleDateString(undefined, { month: "long", day: "numeric" });
      dateInputTo.value = toDate.toISOString().split("T")[0];
      dateDisplayTo.textContent = formatted;
      document.getElementById("dateToWrapper").style.display = "inline";
      document.getElementById("dateDisplayTo").style.display = "inline-block";
      document.getElementById("removeEndDateBtn").style.display = "inline-block";
      addEndDateBtn.style.display = "none";
      dateMode = "from-to";
    }
  },
  positionElement: addEndDateBtn,
  appendTo: document.body
});



   
        



// Date Mode Logic
// Date Mode Logic
const dateModeInput = document.getElementById("dateModeSelection");
const modeButtons = document.querySelectorAll(".mode-btn");

modeButtons.forEach(button => {
    button.addEventListener("click", () => {
        const mode = button.getAttribute("data-mode");
        dateModeInput.value = mode;

        // Update active state
        modeButtons.forEach(btn => btn.classList.remove("active"));
        button.classList.add("active");

        // Show/hide UI based on mode
        document.getElementById("fromToDateGroup").style.display = mode === "date" ? "block" : "none";
        document.getElementById("specificDatesGroup").style.display = mode === "specific-dates" ? "block" : "none";
        document.getElementById("specificDaysGroup").style.display = mode === "date" ? "block" : "none";

        // Clear irrelevant fields
        if (mode === "specific-dates") {
            document.getElementById("taskDate").value = "";
            document.getElementById("taskDateTo").value = "";
            document.getElementById("dateDisplay").textContent = "Today";
            document.getElementById("dateDisplayTo").textContent = "To Date";
            document.getElementById("dateToWrapper").style.display = "none";
            document.getElementById("dateDisplayTo").style.display = "none";
            document.getElementById("removeEndDateBtn").style.display = "none";
            document.getElementById("addEndDateBtn").style.display = "inline-block";
            selectedDays = [];
            updateSelectedDaysDisplay();
        } else if (mode === "date") {
            document.getElementById("specificDatesInput").value = "";
            selectedDates = [];
            flatpickrSpecific.clear();
            updateSelectedDatesDisplay();
        }
    });
});
   




// Specific Days Logic
const specificDaysInput = document.getElementById("specificDaysInput");
let selectedDays = ["Any"]; // Default selected

const dayMapping = {
    "Any": "Any",
    "All": "All",
    "Mon": "Monday",
    "Tue": "Tuesday",
    "Wed": "Wednesday",
    "Thu": "Thursday",
    "Fri": "Friday",
    "Sat": "Saturday",
    "Sun": "Sunday"
};

function updateSelectedDaysDisplay() {
    const buttons = document.querySelectorAll("#specificDaysButtons .day-btn");
    const repeatInput = document.getElementById("repeatSelection");
    const specificDaysInput = document.getElementById("specificDaysInput");
    
    if (!buttons.length) return; // Exit if no buttons found
    
    const isDaily = repeatInput && repeatInput.value === "Daily";
    
    buttons.forEach(button => {
        const shortDay = button.getAttribute("data-day");
        const fullDay = dayMapping[shortDay];
        
        if (!fullDay) return; // Skip if mapping not found
        
        // Check if this button should be selected
        let isSelected = false;
        
        if (fullDay === "Any" || fullDay === "All") {
            // For Any/All button - check if it's in selectedDays
            isSelected = selectedDays.includes(fullDay);
        } else {
            // For specific days
            isSelected = selectedDays.includes(fullDay);
        }
        
        if (isSelected) {
            button.classList.add("selected");
        } else {
            button.classList.remove("selected");
        }
    });
    
    // Update the input value with better display text
    if (specificDaysInput) {
        if (isDaily && selectedDays.includes("All")) {
            specificDaysInput.value = "All days (Mon-Sun)";
        } else if (!isDaily && selectedDays.includes("Any")) {
            specificDaysInput.value = "Any day";
        } else if (selectedDays.length > 0) {
            specificDaysInput.value = selectedDays.join(", ");
        } else {
            specificDaysInput.value = isDaily ? "All days (Mon-Sun)" : "Any day";
        }
    }
}

// Add click event listeners to day buttons
document.querySelectorAll("#specificDaysButtons .day-btn").forEach(button => {
    button.addEventListener("click", () => {
        const shortDay = button.getAttribute("data-day");
        const fullDay = dayMapping[shortDay];
        const repeatInput = document.getElementById("repeatSelection");
        const isDaily = repeatInput && repeatInput.value === "Daily";

        if (fullDay === "Any" || fullDay === "All") {
            // Clicking Any/All button
            if (selectedDays.includes(fullDay)) {
                // If already selected, deselect it (but keep at least one day)
                if (isDaily) {
                    selectedDays = ["Monday"]; // Default to Monday for Daily
                } else {
                    selectedDays = ["Any"]; // Keep Any for non-Daily
                }
            } else {
                // Select Any/All and clear individual selections
                if (isDaily) {
                    selectedDays = ["All"];
                } else {
                    selectedDays = ["Any"];
                }
            }
        } else {
            // Clicking individual day button
            // Remove Any/All if selecting specific day
            selectedDays = selectedDays.filter(day => day !== "Any" && day !== "All");
            
            if (selectedDays.includes(fullDay)) {
                // Deselect this day
                selectedDays = selectedDays.filter(day => day !== fullDay);
                if (selectedDays.length === 0) {
                    // Re-select Any/All if none selected
                    selectedDays = isDaily ? ["All"] : ["Any"];
                }
            } else {
                // Select this day
                selectedDays.push(fullDay);
                
                // Check if all 7 days are now selected for Daily frequency
                if (isDaily) {
                    const allDays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
                    if (allDays.every(day => selectedDays.includes(day))) {
                        // All individual days selected, switch to "All"
                        selectedDays = ["All"];
                    }
                }
            }
        }
        updateSelectedDaysDisplay();
    });
});

// Initialize display
updateSelectedDaysDisplay();








        const specificDatesButton = document.getElementById("selectSpecificDates");
const specificDatesModal = document.getElementById("specificDatesModal");
const specificDatesInput = document.getElementById("specificDatesInput");
const selectedDatesContainer = document.getElementById("selectedDatesContainer");
const saveSpecificDatesBtn = document.getElementById("saveSpecificDates");
const clearSpecificDatesBtn = document.getElementById("clearSpecificDates");
const specificDatesGroup = document.getElementById("specificDatesGroup");

let selectedDates = [];
let isDragging = false;
let startDate = null;
let dragMode = null; // 'select' or 'deselect'
let selectedDatesAtDragStart = [];

const flatpickrSpecific = flatpickr("#specificDatesCalendar", {
    dateFormat: "Y-m-d",
    mode: "multiple",
    disableMobile: true,
    inline: true,
    enable: [
        function(date) {
            return true; // Allow all dates
        }
    ],
    onReady: function(_, __, instance) {
        const calendar = instance.calendarContainer;

        calendar.addEventListener("mousedown", (e) => {
            const dayElem = e.target.closest(".flatpickr-day");
            if (dayElem && !dayElem.classList.contains("disabled")) {
                isDragging = true;
                startDate = new Date(dayElem.getAttribute("aria-label"));
                const startIsSelected = selectedDates.some(d => d.getTime() === startDate.getTime());
                dragMode = startIsSelected ? "deselect" : "select";
                selectedDatesAtDragStart = [...selectedDates]; // snapshot current selection
                e.preventDefault();
                e.stopPropagation();
            }
        });

        calendar.addEventListener("mousemove", (e) => {
            if (!isDragging || !dragMode) return;
            const dayElem = e.target.closest(".flatpickr-day");
            if (dayElem && !dayElem.classList.contains("disabled")) {
                const endDate = new Date(dayElem.getAttribute("aria-label"));
                const datesInRange = getDatesInRange(startDate, endDate);

                let newDates = [...selectedDatesAtDragStart];
                if (dragMode === "select") {
                    newDates = [...new Set([
                        ...newDates,
                        ...datesInRange
                    ].map(d => d.getTime()))].map(t => new Date(t));
                } else if (dragMode === "deselect") {
                    newDates = newDates.filter(d =>
                        !datesInRange.some(r => r.getTime() === d.getTime())
                    );
                }

                selectedDates = newDates.sort((a, b) => a - b);
                instance.setDate(selectedDates, false);
            }
        });

        calendar.addEventListener("mouseup", (e) => {
            if (isDragging) {
                isDragging = false;
                startDate = null;
                dragMode = null;
                selectedDatesAtDragStart = [];
                e.stopPropagation();
            }
        });

        calendar.addEventListener("click", (e) => {
            const dayElem = e.target.closest(".flatpickr-day");
            if (dayElem && !dayElem.classList.contains("disabled")) {
                if (!isDragging && !startDate) {
                    const date = new Date(dayElem.getAttribute("aria-label"));
                    const index = selectedDates.findIndex(d => d.getTime() === date.getTime());
                    if (index >= 0) {
                        selectedDates.splice(index, 1);
                    } else {
                        selectedDates.push(date);
                    }
                    selectedDates.sort((a, b) => a - b);
                    instance.setDate(selectedDates, false);
                }
            }
        });
    },
    onChange: function(dates, text, instance) {
        if (!isDragging) {
            selectedDates = dates.sort((a, b) => a - b);
        }
    }
});

function getDatesInRange(start, end) {
    const dates = [];
    const current = new Date(Math.min(start, end));
    const max = new Date(Math.max(start, end));
    while (current <= max) {
        dates.push(new Date(current));
        current.setDate(current.getDate() + 1);
    }
    return dates;
}



function updateSelectedDatesDisplay() {
    selectedDatesContainer.innerHTML = "";
    console.log("Selected Dates (raw):", selectedDates); // Debug
    if (selectedDates.length === 0) {
        specificDatesInput.value = "";
        const placeholder = document.createElement("span");
        placeholder.textContent = "Every day";
        placeholder.style.color = "rgba(255, 255, 255, 0.7)";
        placeholder.style.fontSize = "14px";
        selectedDatesContainer.appendChild(placeholder);
    } else {
        specificDatesInput.value = selectedDates.map(date => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }).join(",");
        console.log("specificDatesInput.value:", specificDatesInput.value); // Debug
        selectedDates.forEach(date => {
            const chip = document.createElement("div");
            chip.className = "date-chip";
            const dateText = document.createElement("span");
            dateText.textContent = date.toLocaleDateString(undefined, { month: "short", day: "numeric" });
            const removeBtn = document.createElement("span");
            removeBtn.className = "date-chip-remove";
            removeBtn.textContent = "√ó";
            removeBtn.addEventListener("click", () => {
                selectedDates = selectedDates.filter(d => d.getTime() !== date.getTime());
                flatpickrSpecific.setDate(selectedDates);
                updateSelectedDatesDisplay();
            });
            chip.appendChild(dateText);
            chip.appendChild(removeBtn);
            selectedDatesContainer.appendChild(chip);
        });
    }
}





specificDatesButton.addEventListener("click", () => {
    showModal(specificDatesModal);
});

saveSpecificDatesBtn.addEventListener("click", () => {
    updateSelectedDatesDisplay();
    hideModal(specificDatesModal);
});

clearSpecificDatesBtn.addEventListener("click", () => {
    selectedDates = [];
    flatpickrSpecific.clear();
    updateSelectedDatesDisplay();
    hideModal(specificDatesModal);
});

window.addEventListener("click", (e) => {
    if (e.target === specificDatesModal) {
        hideModal(specificDatesModal);
    }
});
























    
        dateDisplay.addEventListener("click", () => {
            flatpickrFrom.open();
        });
    
        dateDisplayTo.addEventListener("click", () => {
            if (dateMode === "date") {
    const fromDate = dateFrom;
    const toDate = dateTo || "3000-01-01";
    dateValue = `${fromDate} to ${toDate}`;
}
       });
    
        // Reminder and Alarm Logic
        const reminderToggle = document.getElementById('taskReminder');
        const addAlarmBtn = document.getElementById('addAlarmBtn');
        const alarmContainer = document.getElementById('alarmContainer');
        let alarms = [];
    
        reminderToggle.addEventListener('change', () => {
            if (reminderToggle.checked) {
                addAlarmBtn.style.display = 'inline-block';
            } else {
                addAlarmBtn.style.display = 'none';
                alarmContainer.innerHTML = '';
                alarms = [];
            }
        });
    
        addAlarmBtn.addEventListener('click', () => {
            const alarmWrapper = document.createElement('div');
            alarmWrapper.style.marginBottom = '10px';
            alarmWrapper.style.display = 'flex';
            alarmWrapper.style.alignItems = 'center';
    
            const alarmInput = document.createElement('input');
            alarmInput.type = 'time';
            alarmInput.style.marginRight = '10px';
            alarmInput.style.padding = '10px';
            alarmInput.style.border = '2px solid var(--primary-color)';
            alarmInput.style.borderRadius = '8px';
            alarmInput.style.background = 'var(--accent-color)';
    
            const removeButton = document.createElement('button');
            removeButton.textContent = 'Remove';
            removeButton.style.padding = '5px 10px';
            removeButton.style.backgroundColor = 'var(--danger-color)';
            removeButton.style.color = 'var(--accent-color)';
            removeButton.style.border = 'none';
            removeButton.style.borderRadius = '8px';
    
            removeButton.addEventListener('click', () => {
                alarmWrapper.remove();
                alarms = alarms.filter(a => a !== alarmInput.value);
            });
    
            alarmInput.addEventListener('input', () => {
                if (!alarms.includes(alarmInput.value)) {
                    alarms.push(alarmInput.value);
                }
            });
    
            alarmWrapper.appendChild(alarmInput);
            alarmWrapper.appendChild(removeButton);
            alarmContainer.appendChild(alarmWrapper);
        });
    











function handleCancel() {
    const urlParams = new URLSearchParams(window.location.search);
    const from = urlParams.get("from");
    const adminEmail = encodeURIComponent(localStorage.getItem("currentAdminEmail") || "");
    const originalUser = urlParams.get("user") || localStorage.getItem("currentUser");

    if (from === "onboarding") {
        window.location.href = `/BeeMazing-A1/onboarding.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}#step4`;
    } else if (originalUser) {
        window.location.href = `/BeeMazing-A1/mobile/3-Tasks/tasks.html?admin=${adminEmail}&user=${encodeURIComponent(originalUser)}`;
    } else {
        alert("User information missing. Please return to the user selection page.");
        window.location.href = "/BeeMazing-A1/mobile/2-UserProfiles/userAdmin.html";
    }
}

// Initialize section label on page load
document.addEventListener("DOMContentLoaded", () => {
    const sectionLabel = document.getElementById("sectionLabel");
    const repeatInput = document.getElementById("repeatSelection");
    const anyAllButton = document.getElementById("anyAllButton");
    
    // Add delay to ensure all elements are loaded
    setTimeout(() => {
        // Set initial section label and Any/All button based on current frequency (default is "One Time")
        if (sectionLabel && anyAllButton) {
            if (repeatInput && repeatInput.value === "Daily") {
                sectionLabel.textContent = "Days";
                anyAllButton.textContent = "All";
                anyAllButton.setAttribute("data-day", "All");
                // Set default selection for Daily to "All"
                if (selectedDays.length === 0 || selectedDays.includes("Any")) {
                    selectedDays = ["All"];
                    updateSelectedDaysDisplay();
                }
            } else {
                sectionLabel.textContent = "Dates";
                anyAllButton.textContent = "Any";
                anyAllButton.setAttribute("data-day", "Any");
                // Set default selection for non-Daily to "Any"
                if (selectedDays.length === 0 || selectedDays.includes("All")) {
                    selectedDays = ["Any"];
                    updateSelectedDaysDisplay();
                }
            }
        }
    }, 100);
});

    </script>




</body>
</html>