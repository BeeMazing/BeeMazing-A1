<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>BeeMazing</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
            rel="stylesheet"
        />
        <script src="/BeeMazing-A1/redirect-interceptor.js"></script>
        <script>
            // Add debugging functions immediately for console access
            window.debugTaskStatus = async function (titlePattern) {
                console.log("🚨 TASK STATUS CHECK! 🚨");

                const currentAdmin = localStorage.getItem("currentAdminEmail");
                if (!currentAdmin) {
                    console.error("🔧 No admin email found!");
                    return;
                }

                try {
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (!response.ok) {
                        throw new Error("Failed to fetch tasks");
                    }

                    const result = await response.json();
                    const matchingTasks = result.tasks.filter((t) =>
                        t.title.includes(titlePattern || "Multiple"),
                    );

                    console.log(
                        `🔧 Found ${matchingTasks.length} tasks matching "${titlePattern || "Multiple"}"`,
                    );
                    matchingTasks.forEach((task) => {
                        console.log("🔧 Task:", {
                            title: task.title,
                            date: task.date,
                            originalTitle: task.originalTitle,
                            occurrence: task.occurrence,
                            totalOccurrences: task.totalOccurrences,
                            timesPerDay: task.timesPerDay,
                        });
                    });

                    return matchingTasks;
                } catch (error) {
                    console.error("🔧 Status check failed:", error);
                }
            };

            window.debugDeleteOccurrences = async function (
                originalTitle,
                dateRange,
            ) {
                console.log("🚨 MANUAL DELETION TEST STARTED! 🚨");
                console.log(
                    "🔧 Testing deletion for:",
                    originalTitle,
                    "on date:",
                    dateRange,
                );

                const currentAdmin = localStorage.getItem("currentAdminEmail");
                if (!currentAdmin) {
                    console.error("🔧 No admin email found!");
                    return;
                }

                try {
                    // Fetch all related tasks
                    const fetchResponse = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (!fetchResponse.ok) {
                        throw new Error("Failed to fetch tasks for deletion");
                    }

                    const result = await fetchResponse.json();
                    const relatedTasks = result.tasks.filter(
                        (t) =>
                            (t.originalTitle === originalTitle ||
                                t.title.startsWith(originalTitle + " - ")) &&
                            t.date === dateRange,
                    );

                    console.log(
                        "🔧 Found related tasks to delete:",
                        relatedTasks.length,
                    );
                    console.log(
                        "🔧 Tasks to delete:",
                        relatedTasks.map((t) => ({
                            title: t.title,
                            date: t.date,
                        })),
                    );

                    if (relatedTasks.length === 0) {
                        console.log("🔧 No tasks found to delete");
                        return;
                    }

                    // Delete each task
                    let deletedCount = 0;
                    for (const relatedTask of relatedTasks) {
                        try {
                            const startDate = dateRange.split(" to ")[0]; // Extract start date only
                            const deleteUrl = `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&title=${encodeURIComponent(relatedTask.title)}&date=${encodeURIComponent(startDate)}`;
                            console.log(
                                "🔧 Deleting:",
                                relatedTask.title,
                                "with URL:",
                                deleteUrl,
                            );

                            const deleteResponse = await fetch(deleteUrl, {
                                method: "DELETE",
                                headers: { "Content-Type": "application/json" },
                            });

                            const responseText = await deleteResponse.text();
                            console.log(
                                "🔧 Raw response for",
                                relatedTask.title,
                                ":",
                                responseText,
                            );

                            if (deleteResponse.ok) {
                                console.log(
                                    "🔧 Successfully deleted:",
                                    relatedTask.title,
                                );
                                deletedCount++;
                            } else {
                                try {
                                    const errorData = JSON.parse(responseText);
                                    console.error(
                                        "🔧 Failed to delete:",
                                        relatedTask.title,
                                        "Status:",
                                        deleteResponse.status,
                                        "Error:",
                                        errorData,
                                    );
                                } catch (e) {
                                    console.error(
                                        "🔧 Failed to delete:",
                                        relatedTask.title,
                                        "Status:",
                                        deleteResponse.status,
                                        "Raw response:",
                                        responseText,
                                    );
                                }
                            }
                        } catch (err) {
                            console.error(
                                "🔧 Exception deleting:",
                                relatedTask.title,
                                err,
                            );
                        }
                    }

                    console.log(
                        `🔧 Deletion complete: ${deletedCount}/${relatedTasks.length} tasks deleted`,
                    );

                    // Verify deletion
                    console.log("🔧 Verifying deletion...");
                    const verifyResponse = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (verifyResponse.ok) {
                        const verifyResult = await verifyResponse.json();
                        const remainingTasks = verifyResult.tasks.filter(
                            (t) =>
                                (t.originalTitle === originalTitle ||
                                    t.title.startsWith(
                                        originalTitle + " - ",
                                    )) &&
                                t.date === dateRange,
                        );
                        console.log(
                            "🔧 Verification: remaining tasks after deletion:",
                            remainingTasks.length,
                        );
                        if (remainingTasks.length > 0) {
                            console.warn(
                                "🔧 WARNING: Some tasks were not deleted:",
                                remainingTasks.map((t) => t.title),
                            );
                        } else {
                            console.log("🔧 SUCCESS: All tasks deleted!");
                        }
                    }
                } catch (error) {
                    console.error("🔧 Manual deletion test failed:", error);
                }
            };

            // Enhanced cleanup function for duplicate tasks
            window.debugCleanupDuplicates = async function () {
                console.log("🧹 COMPREHENSIVE DUPLICATE CLEANUP STARTED! 🧹");

                const currentAdmin = localStorage.getItem("currentAdminEmail");
                if (!currentAdmin) {
                    console.error("🔧 No admin email found!");
                    return;
                }

                try {
                    // Fetch all tasks
                    const fetchResponse = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (!fetchResponse.ok) {
                        throw new Error("Failed to fetch tasks for cleanup");
                    }

                    const result = await fetchResponse.json();
                    const allTasks = result.tasks;

                    console.log("🧹 Total tasks found:", allTasks.length);

                    // Group tasks by title and date
                    const taskGroups = {};
                    allTasks.forEach((task) => {
                        const key = `${task.title}|${task.date}`;
                        if (!taskGroups[key]) {
                            taskGroups[key] = [];
                        }
                        taskGroups[key].push(task);
                    });

                    // Find duplicates
                    const duplicateGroups = Object.entries(taskGroups).filter(
                        ([key, tasks]) => tasks.length > 1,
                    );
                    console.log(
                        "🧹 Found duplicate groups:",
                        duplicateGroups.length,
                    );

                    let totalDeleted = 0;

                    // Delete duplicates (keep only the first one)
                    for (const [key, tasks] of duplicateGroups) {
                        const [title, date] = key.split("|");
                        console.log(
                            `🧹 Processing duplicates for "${title}" on ${date}: ${tasks.length} copies`,
                        );

                        // Keep the first task, delete the rest
                        const tasksToDelete = tasks.slice(1);

                        for (const task of tasksToDelete) {
                            try {
                                const deleteUrl = `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&title=${encodeURIComponent(task.title)}&date=${encodeURIComponent(task.date)}`;

                                const deleteResponse = await fetch(deleteUrl, {
                                    method: "DELETE",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                });

                                if (deleteResponse.ok) {
                                    console.log(
                                        "🧹 Deleted duplicate:",
                                        task.title,
                                        "on",
                                        task.date,
                                    );
                                    totalDeleted++;
                                } else {
                                    console.error(
                                        "🧹 Failed to delete duplicate:",
                                        task.title,
                                        "Status:",
                                        deleteResponse.status,
                                    );
                                }
                            } catch (err) {
                                console.error(
                                    "🧹 Exception deleting duplicate:",
                                    task.title,
                                    err,
                                );
                            }
                        }
                    }

                    console.log(
                        `🧹 CLEANUP COMPLETE: ${totalDeleted} duplicate tasks deleted`,
                    );

                    // Verification
                    console.log("🧹 Verifying cleanup...");
                    const verifyResponse = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (verifyResponse.ok) {
                        const verifyResult = await verifyResponse.json();
                        console.log(
                            "🧹 Tasks remaining after cleanup:",
                            verifyResult.tasks.length,
                        );

                        // Check for remaining duplicates
                        const remainingGroups = {};
                        verifyResult.tasks.forEach((task) => {
                            const key = `${task.title}|${task.date}`;
                            if (!remainingGroups[key]) {
                                remainingGroups[key] = [];
                            }
                            remainingGroups[key].push(task);
                        });

                        const remainingDuplicates = Object.entries(
                            remainingGroups,
                        ).filter(([key, tasks]) => tasks.length > 1);
                        if (remainingDuplicates.length > 0) {
                            console.warn(
                                "🧹 WARNING: Still have duplicates:",
                                remainingDuplicates.length,
                                "groups",
                            );
                        } else {
                            console.log("🧹 SUCCESS: No duplicates remaining!");
                        }
                    }
                } catch (error) {
                    console.error("🧹 Cleanup failed:", error);
                }
            };

            // Delete all tasks with specific pattern
            window.debugDeleteAllMatching = async function (titlePattern) {
                console.log("🗑️ MASS DELETION STARTED! 🗑️");
                console.log(
                    "🗑️ Deleting all tasks matching pattern:",
                    titlePattern,
                );

                const currentAdmin = localStorage.getItem("currentAdminEmail");
                if (!currentAdmin) {
                    console.error("🔧 No admin email found!");
                    return;
                }

                try {
                    // Fetch all tasks
                    const fetchResponse = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (!fetchResponse.ok) {
                        throw new Error(
                            "Failed to fetch tasks for mass deletion",
                        );
                    }

                    const result = await fetchResponse.json();
                    const tasksToDelete = result.tasks.filter(
                        (t) =>
                            t.title
                                .toLowerCase()
                                .includes(titlePattern.toLowerCase()) ||
                            (t.originalTitle &&
                                t.originalTitle
                                    .toLowerCase()
                                    .includes(titlePattern.toLowerCase())),
                    );

                    console.log(
                        "🗑️ Found tasks to delete:",
                        tasksToDelete.length,
                    );
                    console.log(
                        "🗑️ Tasks:",
                        tasksToDelete.map((t) => ({
                            title: t.title,
                            date: t.date,
                        })),
                    );

                    if (tasksToDelete.length === 0) {
                        console.log("🗑️ No matching tasks found");
                        return;
                    }

                    let deletedCount = 0;
                    for (const task of tasksToDelete) {
                        try {
                            const deleteUrl = `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&title=${encodeURIComponent(task.title)}&date=${encodeURIComponent(task.date)}`;

                            const deleteResponse = await fetch(deleteUrl, {
                                method: "DELETE",
                                headers: { "Content-Type": "application/json" },
                            });

                            if (deleteResponse.ok) {
                                console.log(
                                    "🗑️ Deleted:",
                                    task.title,
                                    "on",
                                    task.date,
                                );
                                deletedCount++;
                            } else {
                                console.error(
                                    "🗑️ Failed to delete:",
                                    task.title,
                                    "Status:",
                                    deleteResponse.status,
                                );
                            }
                        } catch (err) {
                            console.error(
                                "🗑️ Exception deleting:",
                                task.title,
                                err,
                            );
                        }
                    }

                    console.log(
                        `🗑️ MASS DELETION COMPLETE: ${deletedCount}/${tasksToDelete.length} tasks deleted`,
                    );
                } catch (error) {
                    console.error("🗑️ Mass deletion failed:", error);
                }
            };

            // Debug function to check why tasks aren't displaying
            window.debugDisplayIssue = async function () {
                console.log("🔍 DEBUGGING DISPLAY ISSUE 🔍");

                const currentAdmin = localStorage.getItem("currentAdminEmail");
                if (!currentAdmin) {
                    console.error("🔧 No admin email found!");
                    return;
                }

                try {
                    // Get current date being viewed
                    const currentDate = new Date().toISOString().split("T")[0];
                    console.log("🔍 Current date:", currentDate);

                    // Fetch all tasks
                    const fetchResponse = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (!fetchResponse.ok) {
                        throw new Error("Failed to fetch tasks");
                    }

                    const result = await fetchResponse.json();
                    console.log(
                        "🔍 Total tasks in database:",
                        result.tasks.length,
                    );

                    // Check what tasks should show for today
                    const todayTasks = result.tasks.filter((task) => {
                        const taskDate = task.date;
                        console.log(
                            `🔍 Task "${task.title}" - Date: ${taskDate}, Today: ${currentDate}, Match: ${taskDate === currentDate}`,
                        );
                        return taskDate === currentDate;
                    });

                    console.log(
                        "🔍 Tasks that should show today:",
                        todayTasks.length,
                    );
                    todayTasks.forEach((task) => {
                        console.log(`  - ${task.title} (${task.date})`);
                    });

                    // Check what's actually rendered in the DOM
                    const taskElements = document.querySelectorAll(
                        ".task-item, .task-card, [data-task]",
                    );
                    console.log(
                        "🔍 Task elements found in DOM:",
                        taskElements.length,
                    );

                    // Show all unique dates in the database
                    const allDates = [
                        ...new Set(result.tasks.map((t) => t.date)),
                    ].sort();
                    console.log("🔍 All dates with tasks:", allDates);

                    // Show tasks by date
                    allDates.forEach((date) => {
                        const tasksForDate = result.tasks.filter(
                            (t) => t.date === date,
                        );
                        console.log(
                            `🔍 ${date}: ${tasksForDate.length} tasks - ${tasksForDate.map((t) => t.title).join(", ")}`,
                        );
                    });
                } catch (error) {
                    console.error("🔍 Display debug failed:", error);
                }
            };

            console.log("🔧 Debug functions loaded! Available functions:");
            console.log(
                "  - debugTaskStatus('Multiple') - Check current tasks",
            );
            console.log(
                "  - debugDeleteOccurrences(originalTitle, dateRange) - Test deletion",
            );
            console.log(
                "  - debugCleanupDuplicates() - Remove duplicate tasks",
            );
            console.log(
                "  - debugDeleteAllMatching('pattern') - Delete all tasks matching pattern",
            );
            console.log(
                "  - debugDisplayIssue() - Check why tasks aren't showing in UI",
            );
        </script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            :root {
                --primary-color: #131312;
                --secondary-color: #e4e3e0;
                --accent-color: #ffffff;
                --light-bg: #fffff8;
                --text-color: #000000;
                --danger-color: #d32f2f;
                --modal-bg: rgba(33, 33, 33, 0.7);
                --footer-height: 70px;
                --add-btn-height: 80px; /* 60px button + 20px buffer */
                --border-dark: #444754; /* same as in addtasks.html */
                --header-height: 68px;
                --card-bg: #2a2b32;
            }

            html,
            body {
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }

            body {
                font-family: "Poppins", Arial, sans-serif;
                background-color: var(--light-bg);
                color: #ffffff;
            }

            .date-header {
                background: #fff6e9;
                position: fixed;
                top: 0;
                width: 100%;
                z-index: 50;
                padding: 5px 0;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                color: black;
            }

            /* Profile Icon */
            .profile-icon {
                position: fixed;
                top: 10px;
                right: 20px;
                width: 40px;
                height: 40px;
                cursor: pointer;
                z-index: 202;
                transition: transform 0.3s ease;
                background: #fbb740;
                border-radius: 50%;
                padding: 8px;
                box-sizing: border-box;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
            }

            .profile-icon:hover {
                transform: scale(1.1);
            }

            .logout-container {
                position: fixed;
                top: 10px;
                left: 10px;
                z-index: 150;
            }

            #logoutBtn {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 8px;
                background: #fbb740;
                border: none;
                cursor: pointer;
                border-radius: 8px;
                width: 40px;
                height: 40px;
                box-sizing: border-box;
                transition: transform 0.3s ease;
            }

            #logoutBtn:hover {
                transform: scale(1.1);
            }

            .logout-icon {
                width: 24px;
                height: 24px;
                filter: brightness(0) saturate(100%) invert(100%);
                transition: transform 0.3s ease;
            }

            .logout-icon:hover {
                transform: scale(1.1);
            }

            .content {
                position: absolute;
                top: calc(
                    var(--header-height) + 45px
                ); /* was 110px — now much tighter */
                bottom: var(--footer-height);
                left: 0;
                right: 0;
                padding: 20px;
                overflow-y: auto;
                background-color: var(--light-bg);
                background-image: url('data:image/svg+xml,%3Csvg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"%3E%3Ccircle cx="20" cy="20" r="2" fill="%23FFC107" fill-opacity="0.1"/%3E%3C/svg%3E');
                background-repeat: repeat;
            }

            .task-item {
                padding: 12px 14px;
                background: #ffffff;
                color: #5d4e41;
                border: 2px solid #fbb740;
                border-radius: 12px;
                margin-bottom: 10px;
                cursor: pointer;
                position: relative;
                transition:
                    transform 0.3s ease,
                    box-shadow 0.3s ease;
                touch-action: pan-y;
                overflow: hidden;
                min-height: 60px;
            }

            .task-header {
                margin-bottom: 8px;
            }

            .task-title {
                font-weight: bold;
                font-size: 16px;
                line-height: 1.2;
                flex: 1;
                min-width: 0;
            }

            .task-due-time {
                color: #666;
                font-size: 13px;
                font-weight: 600;
                white-space: nowrap;
                background: #f0f0f0;
                padding: 2px 6px;
                border-radius: 4px;
                margin-left: auto;
                flex-shrink: 0;
            }

            .task-status-icon {
                font-size: 16px;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                flex-shrink: 0;
            }

            .task-status-icon.complete {
                background: #d4edda;
                border: 1px solid #c3e6cb;
            }

            .task-status-icon.pending {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
            }

            .task-status-icon.incomplete {
                background: #f8d7da;
                border: 1px solid #f5c6cb;
            }

            .original-user-avatar {
                width: 20px !important;
                height: 20px !important;
                border: 2px solid #fbb740 !important;
                margin-left: 4px;
                opacity: 0.8;
                position: relative;
            }

            .original-user-avatar::after {
                content: "↩";
                position: absolute;
                bottom: -2px;
                right: -2px;
                font-size: 8px;
                background: #fbb740;
                color: white;
                border-radius: 50%;
                width: 10px;
                height: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                line-height: 1;
            }

            .task-title-row {
                display: flex;
                align-items: center;
                gap: 8px;
                justify-content: space-between;
                width: 100%;
            }

            .task-avatars {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 4px;
                flex-wrap: wrap;
                margin-top: 4px;
            }

            .team-icon {
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                margin-right: 4px;
                flex-shrink: 0;
            }

            .rotation-icon {
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                margin-right: 4px;
                flex-shrink: 0;
            }

            .task-avatar {
                width: 24px;
                height: 24px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                color: white;
                font-size: 10px;
                text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
                margin-right: 2px;
                flex-shrink: 0;
            }

            .task-next-label {
                color: #666;
                font-size: 10px;
                margin: 0 2px;
            }

            .task-avatars-section {
                display: flex;
                align-items: center;
                gap: 4px;
                flex-wrap: wrap;
                flex: 1;
            }

            .task-reward {
                display: flex;
                align-items: center;
                gap: 4px;
                color: #fbb740;
                font-weight: bold;
                font-size: 15px;
            }

            .honey-icon {
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                flex-shrink: 0;
            }

            .task-item.swiped-left {
                transform: translateX(-100px);
            }

            .task-item .delete-btn {
                position: absolute;
                top: 0;
                right: 0; /* Always aligned right */
                width: 100px;
                height: 100%;
                background: var(--danger-color);
                color: white;
                border: none;
                border-radius: 0 12px 12px 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 16px;
                cursor: pointer;
                transform: translateX(100%); /* 🐝 Start hidden to right */
                transition: transform 0.3s ease;
            }

            .task-item.swiped-left .delete-btn {
                transform: translateX(0);
                display: flex; /* ✅ stay flex so text stays centered vertically */
                align-items: center; /* ✅ re-apply just in case */
                justify-content: center; /* ✅ re-apply just in case */
                right: 0;
            }

            .task-item .delete-btn:hover {
                background-color: #b71c1c;
            }

            .task-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 3px 8px rgba(251, 183, 64, 0.3);
                border-color: #5d4e41;
            }

            .task-progress {
                font-size: 12px;
                color: #fbb740;
                margin-top: 3px;
            }

            .footer {
                position: fixed;
                bottom: 0;
                width: 100%;
                left: 0;
                display: flex;
                justify-content: space-around;
                align-items: center;
                background: #fbb740;
                padding: 10px 0;
                box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
                z-index: 100;
                height: var(--footer-height);
            }
            .footer a {
                text-decoration: none;
                color: #ffffff;
                display: flex;
                flex-direction: column;
                align-items: center;
                transition: transform 0.3s ease;
            }
            .footer a:hover {
                transform: scale(1.1);
            }

            .footer-icon img,
            .footer-icon svg {
                width: 40px;
                height: 40px;
                filter: brightness(0) saturate(100%) invert(100%);
                transition: filter 0.3s ease;
            }

            .footer a.active svg,
            .footer a[aria-label="Tasks"] svg,
            a[href="/BeeMazing-A1/mobile/3-Tasks/tasks.html"] svg {
                filter: brightness(0) saturate(100%) invert(30%) sepia(20%)
                    saturate(2000%) hue-rotate(15deg) brightness(0.8)
                    contrast(1.2) !important;
                color: #5d4e41 !important;
                width: 40px !important;
                height: 40px !important;
            }

            .footer a.active img {
                filter: brightness(0) saturate(100%) invert(30%) sepia(20%)
                    saturate(2000%) hue-rotate(15deg) brightness(0.8)
                    contrast(1.2) !important;
            }

            .footer a.active span {
                color: #ffffff;
            }

            .footer-icon span {
                font-size: 12px;
                margin-top: 5px;
                font-weight: 600;
            }
            .add-task-btn {
                position: fixed;
                bottom: calc(var(--footer-height) + 10px); /* Above footer */
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 60px;
                background: #fbb740;
                color: #ffffff;
                border: 3px solid #ffffff;
                border-radius: 50%;
                font-size: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                cursor: pointer;
                transition: all 0.3s ease;
                text-decoration: none;
                z-index: 99; /* Below footer but above content */
            }
            .add-task-btn:hover {
                background: #5d4e41;
                color: #ffffff;
                transform: translateX(-50%) scale(1.1);
            }
            .task-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(19, 19, 18, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                animation: fadeIn 0.3s ease-out;
                padding: 20px;
                box-sizing: border-box;
            }
            @keyframes fadeIn {
                0% {
                    opacity: 0;
                }
                100% {
                    opacity: 1;
                }
            }
            .modal-content {
                background: #fffff8;
                padding: 25px;
                border-radius: 12px;
                width: 100%;
                max-width: 420px;
                max-height: 85vh;
                overflow-y: auto;
                text-align: left;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                border: 2px solid #fbb740;
                color: #5d4e41;
                font-family: "Poppins", Arial, sans-serif;
            }
            .modal-content strong {
                color: #5d4e41;
                font-weight: 600;
                font-size: 12px;
            }
            .modal-content h2 {
                color: #5d4e41;
                margin: 0 0 12px 0;
                font-size: 16px;
                font-weight: 600;
                border-bottom: 2px solid #fbb740;
                padding-bottom: 6px;
            }
            .task-info-row {
                padding: 8px 0;
                border-bottom: 1px solid #fff6e9;
                font-size: 12px;
                display: flex;
                align-items: center;
                flex-wrap: wrap;
                gap: 4px;
                min-height: 32px;
            }
            .task-info-row:last-child {
                border-bottom: none;
            }
            .task-progress {
                background: #fff6e9;
                padding: 10px 12px;
                border-radius: 6px;
                margin: 10px 0;
                font-weight: 500;
                color: #5d4e41;
                border-left: 3px solid #fbb740;
            }
            .modal-content em {
                color: #d32f2f;
                font-style: italic;
                background: #ffebee;
                padding: 6px 10px;
                border-radius: 4px;
                display: inline-block;
                margin: 5px 0;
                border-left: 2px solid #d32f2f;
            }

            @media (max-width: 600px) {
                .add-task-btn {
                    width: 50px;
                    height: 50px;
                    font-size: 28px;
                    bottom: calc(
                        var(--footer-height) + 10px
                    ); /* Consistent on mobile */
                }
                .footer-icon img {
                    width: 35px;
                    height: 35px;
                }
            }

            .date-header {
                background: #fff6e9;
                position: fixed;
                top: 0;
                width: 100%;
                z-index: 50;
                padding: 5px 0;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                color: black;
            }

            .month-nav {
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 18px;
                font-weight: bold;
                width: 100%;
                padding: 5px 0;
                color: #5d4e41;
            }
            .month-nav button {
                margin: 0 10px;
                background: #fbb740;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 8px;
                cursor: pointer;
                transition: transform 0.3s ease;
                font-weight: bold;
            }
            .month-nav button:hover {
                transform: scale(1.1);
            }

            /* Date picker start point */

            .day-scroll-wrapper {
                display: flex;
                align-items: center;
                padding: 5px 0;
                overflow: hidden;
            }
            .day-scroll {
                display: flex;
                overflow-x: auto;
                gap: 8px;
                padding: 5px 10px;
            }
            .day-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 38px;
            }
            .day-label {
                font-size: 10px;
                color: #5d4e41;
                text-align: center;
                margin-bottom: 2px;
                font-weight: 600;
            }
            .day {
                width: 38px;
                height: 38px;
                line-height: 38px;
                text-align: center;
                border-radius: 50%;
                background: transparent;
                color: #5d4e41;
                font-weight: bold;
                cursor: pointer;
            }
            .day.selected {
                background: #fbb740;
                color: #fff;
            }
            .day.today {
                border: 2px solid #fbb740;
                font-weight: bold;
            }
            .day.today.selected {
                background: #fbb740;
                color: #fff;
                border: 2px solid #fff;
            }
            .day-scroll::-webkit-scrollbar {
                display: none;
            }
            .day-scroll {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            /* Date picker end point */

            .scroll-btn {
                background: #e4e3e0;
                color: #181816;
                border: none;
                font-size: 20px;
                padding: 5px 10px;
                cursor: pointer;
                flex-shrink: 0;
            }

            .scroll-btn:hover {
                background: var(--primary-color);
            }

            /* User Selection Modal Styles - Bottom Sheet */
            .bottom-sheet {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(19, 19, 18, 0.4);
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease-in-out;
            }
            .bottom-sheet.show {
                display: block;
                opacity: 1;
            }
            .bottom-sheet-content {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                max-height: none;
                background: #fffff8;
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
                box-shadow: 0 -4px 20px rgba(19, 19, 18, 0.2);
                border: 2px solid #e4e3e0;
                transform: translateY(100%);
                transition: transform 0.3s ease-in-out;
            }
            .bottom-sheet.show .bottom-sheet-content {
                transform: translateY(0);
            }
            .bottom-sheet-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                border-bottom: 2px solid #e4e3e0;
                background: #ffffff;
            }
            .bottom-sheet-header h3 {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
                color: #5d4e41 !important;
            }
            .bottom-sheet-header .close-btn {
                background: none;
                border: none;
                color: #f5f5dc !important;
                font-size: 24px;
                cursor: pointer;
                padding: 5px;
            }
            .bottom-sheet-header .close-btn:hover {
                color: #ffffff;
            }
            .user-list {
                list-style: none;
                padding: 0;
                margin: 0;
                height: auto !important;
                max-height: none !important;
                overflow-y: visible !important;
                min-height: 48px;
            }

            .user-list li {
                font-size: 14px;
                padding: 12px 15px;
                border-bottom: 1px solid #e4e3e0;
                color: #5d4e41 !important;
                cursor: pointer;
                transition: background 0.2s ease;
                background: #fffff8 !important;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .user-list li:hover {
                background: #e4e3e0 !important;
            }

            .user-list li.active-user {
                background: rgb(251, 183, 64) !important;
                color: #5d4e41 !important;
                font-weight: 600 !important;
            }

            .user-list li:last-child {
                border-bottom: none;
            }

            .user-list-item {
                display: flex;
                align-items: center;
                gap: 8px;
                flex: 1;
            }

            .user-list-actions {
                display: flex;
                gap: 8px;
            }

            .user-list::-webkit-scrollbar {
                width: 8px;
            }
            .user-list::-webkit-scrollbar-track {
                background: #fffff8;
            }
            .user-list::-webkit-scrollbar-thumb {
                background: #131312;
                border-radius: 4px;
            }
            .user-list::-webkit-scrollbar-thumb:hover {
                background: #000000;
            }

            /* Position for swipe to delete feature */

            .draggable-user {
                padding: 8px 10px;
                margin: 4px 0;
                background: #2a2b32;
                color: #ffffff;
                border: 1px solid var(--primary-color);
                border-radius: 6px;
                cursor: grab;
                transition:
                    transform 0.2s ease,
                    box-shadow 0.2s ease;
                touch-action: none;
            }

            .draggable-user:active {
                cursor: grabbing;
            }

            .draggable-user.dragging {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
                z-index: 10;
            }
        </style>
        <!-- Remove FontAwesome to avoid CORS issues -->
    </head>
    <body>
        <div class="date-header">
            <div id="profileIcon" class="profile-icon">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-6"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                    />
                </svg>
            </div>

            <div id="logoutContainer" class="logout-container">
                <button id="logoutBtn" aria-label="Logout" title="Logout">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="size-6 logout-icon"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H15"
                        />
                    </svg>
                </button>
            </div>
            <div class="month-nav">
                <button id="prevMonth">&lt;</button>
                <span id="monthLabel">April 2025</span>
                <button id="nextMonth">&gt;</button>
            </div>
            <div class="day-scroll-wrapper">
                <button class="scroll-btn" id="scrollLeft">&lt;</button>
                <div class="day-scroll" id="dayScrollContainer">
                    <!-- Days will be injected dynamically -->
                </div>
                <button class="scroll-btn" id="scrollRight">&gt;</button>
            </div>
        </div>

        <div
            style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin: 10px 20px;
                gap: 10px;
            "
        >
            <div style="color: #5d4e41; font-weight: 600; font-size: 16px">
                Today's Tasks
            </div>
            <button
                class="refresh-btn"
                onclick="forceRefreshTasks()"
                style="
                    background: #fbb740;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: transform 0.2s;
                    font-size: 16px;
                "
                title="Refresh Tasks"
            >
                🔄
            </button>
        </div>

        <div class="content" id="taskList">
            <!-- Tasks will be loaded dynamically here -->
        </div>

        <a href="#" class="add-task-btn" aria-label="Add Task" id="addTaskBtn"
            >+</a
        >

        <div class="footer">
            <a
                href="/BeeMazing-A1/mobile/2-UserProfiles/userAdmin.html"
                class="footer-icon"
                id="homeLink"
                aria-label="Home"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-6"
                    style="width: 24px; height: 24px"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"
                    />
                </svg>
                <span></span>
            </a>
            <a
                href="/BeeMazing-A1/mobile/3-Tasks/tasks.html"
                class="footer-icon active"
                aria-label="Tasks"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-6"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"
                    />
                </svg>
            </a>
            <a
                href="/BeeMazing-A1/mobile/4-Market/market.html"
                class="footer-icon"
                aria-label="Market"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-6"
                    style="width: 24px; height: 24px"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 0 0 2.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 0 1 2.916.52 6.003 6.003 0 0 1-5.395 4.972m0 0a6.726 6.726 0 0 1-2.749 1.35m0 0a6.772 6.772 0 0 1-3.044 0"
                    />
                </svg>
            </a>
        </div>

        <!-- User Selection Modal -->
        <div
            class="bottom-sheet"
            id="userSelectModal"
            style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(19, 19, 18, 0.4);
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease-in-out;
            "
        >
            <div
                class="bottom-sheet-content"
                style="
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    max-height: none;
                    background: #fffff8;
                    border-top-left-radius: 20px;
                    border-top-right-radius: 20px;
                    box-shadow: 0 -4px 20px rgba(19, 19, 18, 0.2);
                    border: 2px solid #e4e3e0;
                    transform: translateY(100%);
                    transition: transform 0.3s ease-in-out;
                "
            >
                <div
                    class="bottom-sheet-header"
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 15px 20px;
                        border-bottom: 2px solid #e4e3e0;
                        background: #ffffff;
                    "
                >
                    <div
                        class="header-title"
                        style="display: flex; align-items: center; gap: 10px"
                    >
                        <h3
                            style="
                                color: #5d4e41 !important;
                                margin: 0;
                                font-size: 18px;
                                font-weight: 600;
                                display: inline-block;
                            "
                        >
                            Add User
                        </h3>
                        <button
                            class="add-user-btn"
                            id="addUserBtn"
                            style="
                                background: rgb(251, 183, 64) !important;
                                color: rgb(245, 245, 220) !important;
                                border: none !important;
                                border-radius: 50% !important;
                                width: 24px !important;
                                height: 24px !important;
                                font-size: 16px !important;
                                font-weight: bold !important;
                                cursor: pointer !important;
                                display: inline-flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                margin-left: 10px;
                            "
                            onmouseover="this.style.setProperty('background', '#5D4E41', 'important'); this.style.setProperty('background-color', '#5D4E41', 'important');"
                            onmouseout="this.style.setProperty('background', 'rgb(251, 183, 64)', 'important'); this.style.setProperty('background-color', 'rgb(251, 183, 64)', 'important');"
                        >
                            +
                        </button>
                    </div>
                    <button
                        id="closeModalBtn"
                        class="close-btn"
                        aria-label="Close"
                        style="
                            background: none;
                            border: none;
                            color: #f5f5dc !important;
                            font-size: 24px;
                            cursor: pointer;
                            padding: 5px;
                        "
                    >
                        ✕
                    </button>
                </div>
                <ul
                    id="userList"
                    class="user-list"
                    style="
                        list-style: none;
                        padding: 0;
                        margin: 0;
                        height: auto !important;
                        max-height: none !important;
                        overflow-y: visible !important;
                        min-height: 48px;
                    "
                ></ul>
            </div>
        </div>

        <!-- Confirm Delete Modal -->
        <div
            class="modal"
            id="confirmModal"
            style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(19, 19, 18, 0.4);
                z-index: 1001;
                justify-content: center;
                align-items: center;
            "
        >
            <div
                class="modal-content"
                style="
                    background: #2a2b32;
                    padding: 25px;
                    border-radius: 15px;
                    width: 85%;
                    max-width: 400px;
                    text-align: center;
                    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
                    border: 2px solid #444754;
                    color: #ffffff;
                "
            >
                <p style="color: #ffffff; margin-bottom: 20px; font-size: 16px">
                    Are you sure you want to delete this user?
                </p>
                <div
                    class="modal-actions"
                    style="display: flex; gap: 10px; justify-content: center"
                >
                    <button
                        id="confirmYesBtn"
                        style="
                            background: rgb(251, 183, 64);
                            color: #212121;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        "
                    >
                        Yes
                    </button>
                    <button
                        id="confirmNoBtn"
                        style="
                            background: #444754;
                            color: #ffffff;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        "
                    >
                        No
                    </button>
                </div>
            </div>
        </div>

        <!-- Permission Modal -->
        <div
            class="modal"
            id="permissionModal"
            style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(19, 19, 18, 0.4);
                z-index: 1001;
                justify-content: center;
                align-items: center;
            "
        >
            <div
                class="modal-content"
                style="
                    background: #fffff8;
                    padding: 25px;
                    border-radius: 15px;
                    width: 85%;
                    max-width: 400px;
                    text-align: center;
                    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
                    border: 2px solid #e4e3e0;
                    color: #5d4e41;
                "
            >
                <h3
                    id="permissionModalUser"
                    style="
                        color: #5d4e41;
                        margin-bottom: 15px;
                        font-weight: 600;
                    "
                >
                    Edit Bee
                </h3>
                <input
                    type="text"
                    id="editUserNameInput"
                    placeholder="Bee name"
                    style="
                        width: 100%;
                        padding: 10px 12px;
                        margin: 10px 0;
                        background: #fffff8;
                        color: #5d4e41;
                        border: 2px solid #e4e3e0;
                        border-radius: 8px;
                        font-size: 16px;
                        outline: none;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                    "
                />
                <div class="radio-group" style="margin-top: 15px">
                    <label
                        class="radio-option"
                        style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 12px;
                            font-size: 16px;
                            cursor: pointer;
                            gap: 10px;
                            color: #5d4e41;
                        "
                    >
                        <input
                            type="radio"
                            name="editBeeRole"
                            value="Admin"
                            id="editAdminRole"
                            style="
                                accent-color: rgb(251, 183, 64);
                                width: 18px;
                                height: 18px;
                                cursor: pointer;
                            "
                        />
                        <span>Parent Bee</span>
                    </label>
                    <label
                        class="radio-option"
                        style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 12px;
                            font-size: 16px;
                            cursor: pointer;
                            gap: 10px;
                            color: #5d4e41;
                        "
                    >
                        <input
                            type="radio"
                            name="editBeeRole"
                            value="User"
                            id="editUserRole"
                            style="
                                accent-color: rgb(251, 183, 64);
                                width: 18px;
                                height: 18px;
                                cursor: pointer;
                            "
                        />
                        <span>Child Bee</span>
                    </label>
                </div>
                <p
                    id="editErrorMessage"
                    style="color: #d32f2f; font-size: 14px; display: none"
                >
                    Please enter a valid name
                </p>
                <div
                    class="modal-actions"
                    style="
                        display: flex;
                        gap: 10px;
                        justify-content: center;
                        margin-top: 20px;
                    "
                >
                    <button
                        id="savePermissionBtn"
                        style="
                            background: rgb(251, 183, 64);
                            color: #5d4e41;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        "
                    >
                        Save
                    </button>
                    <button
                        id="cancelEditBtn"
                        style="
                            background: #e4e3e0;
                            color: #5d4e41;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        "
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Add User Modal -->
        <div
            class="modal"
            id="addUserModal"
            style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(19, 19, 18, 0.4);
                z-index: 1001;
                justify-content: center;
                align-items: center;
            "
        >
            <div
                class="modal-content"
                style="
                    background: #fffff8;
                    padding: 25px;
                    border-radius: 15px;
                    width: 85%;
                    max-width: 400px;
                    text-align: center;
                    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
                    border: 2px solid #e4e3e0;
                    color: #5d4e41;
                "
            >
                <h3
                    style="
                        color: #5d4e41;
                        margin-bottom: 15px;
                        font-weight: 600;
                    "
                >
                    Add a Bee
                </h3>
                <input
                    type="text"
                    id="usernameInput"
                    placeholder="Bee name"
                    style="
                        width: 100%;
                        padding: 10px 12px;
                        margin: 10px 0;
                        background: #fffff8;
                        color: #5d4e41;
                        border: 2px solid #e4e3e0;
                        border-radius: 8px;
                        font-size: 16px;
                        outline: none;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                    "
                />
                <div class="radio-group" style="margin-top: 15px">
                    <label
                        class="radio-option"
                        style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 12px;
                            font-size: 16px;
                            cursor: pointer;
                            gap: 10px;
                            color: #5d4e41;
                        "
                    >
                        <input
                            type="radio"
                            name="beeRole"
                            value="Admin"
                            style="
                                accent-color: rgb(251, 183, 64);
                                width: 18px;
                                height: 18px;
                                cursor: pointer;
                            "
                        />
                        <span>Parent Bee</span>
                    </label>
                    <label
                        class="radio-option"
                        style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 12px;
                            font-size: 16px;
                            cursor: pointer;
                            gap: 10px;
                            color: #5d4e41;
                        "
                    >
                        <input
                            type="radio"
                            name="beeRole"
                            value="User"
                            checked
                            style="
                                accent-color: rgb(251, 183, 64);
                                width: 18px;
                                height: 18px;
                                cursor: pointer;
                            "
                        />
                        <span>Child Bee</span>
                    </label>
                </div>
                <p
                    id="errorMessage"
                    style="color: #d32f2f; font-size: 14px; display: none"
                >
                    Please enter a valid name
                </p>
                <div
                    class="modal-actions"
                    style="
                        display: flex;
                        gap: 10px;
                        justify-content: center;
                        margin-top: 20px;
                    "
                >
                    <button
                        id="submitUserBtn"
                        style="
                            background: rgb(251, 183, 64);
                            color: #5d4e41;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        "
                    >
                        Add
                    </button>
                    <button
                        id="cancelUserBtn"
                        style="
                            background: #e4e3e0;
                            color: #5d4e41;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        "
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <script src="/BeeMazing-A1/shared/taskrotations.js?t=${Date.now()}"></script>
        <script src="/BeeMazing-A1/shared/predicted-schedule-system.js?t=${Date.now()}"></script>
        <script src="/BeeMazing-A1/local-fair-rotation-system.js?t=${Date.now()}"></script>
        <script src="/BeeMazing-A1/enhanced-fair-rotation-system.js?t=${Date.now()}"></script>
        <script src="/BeeMazing-A1/shared/avatar-system.js"></script>

        <script>
            // Append admin and user query parameters to Home link
            document.addEventListener("DOMContentLoaded", async () => {
                const homeLink = document.getElementById("homeLink");
                const urlParams = new URLSearchParams(window.location.search);
                let admin =
                    urlParams.get("admin") ||
                    localStorage.getItem("currentAdminEmail");
                let user =
                    urlParams.get("user") ||
                    localStorage.getItem("currentUser");

                if (admin) localStorage.setItem("currentAdminEmail", admin);
                if (user) localStorage.setItem("currentUser", user);

                // Initialize avatar system
                if (typeof window.avatarSystem === "undefined") {
                    window.avatarSystem = new AvatarSystem();
                    await window.avatarSystem.initialize(admin);
                }

                // Ensure avatar system is fully initialized before proceeding
                window.ensureAvatarSystemReady = async function () {
                    if (!window.avatarSystem) {
                        const admin = localStorage.getItem("currentAdminEmail");
                        window.avatarSystem = new AvatarSystem();
                        await window.avatarSystem.initialize(admin);
                    }
                };

                // AUTO-EDIT FUNCTIONS FOR OVERDUE TASKS
                async function checkAndTriggerOverdueEdit(targetDate) {
                    // Check localStorage for edit data
                    const editOverdueData = localStorage.getItem(
                        "familyApp_editOverdueTask",
                    );
                    const autoTrigger = localStorage.getItem(
                        "familyApp_autoTriggerEdit",
                    );

                    if (!editOverdueData || autoTrigger !== "true") {
                        console.log(
                            "No overdue edit data found or auto-trigger disabled",
                        );
                        return;
                    }

                    try {
                        const editData = JSON.parse(editOverdueData);
                        console.log(
                            "🔧 Processing overdue task edit:",
                            editData,
                        );

                        if (
                            editData.source === "overdueTaskEdit" &&
                            editData.taskTitle
                        ) {
                            // Clear the localStorage items to prevent repeat triggers
                            localStorage.removeItem(
                                "familyApp_editOverdueTask",
                            );
                            localStorage.removeItem(
                                "familyApp_autoTriggerEdit",
                            );

                            // Set the correct date if provided
                            if (targetDate || editData.specificDate) {
                                const dateToSelect =
                                    targetDate || editData.specificDate;
                                await selectDateAndFindTask(
                                    dateToSelect,
                                    editData.taskTitle,
                                );
                            } else {
                                await findAndEditTask(editData.taskTitle);
                            }
                        }
                    } catch (error) {
                        console.error(
                            "Error processing overdue edit data:",
                            error,
                        );
                        // Clean up localStorage on error
                        localStorage.removeItem("familyApp_editOverdueTask");
                        localStorage.removeItem("familyApp_autoTriggerEdit");
                        removeLoadingOverlay();
                    }
                }

                async function selectDateAndFindTask(targetDate, taskTitle) {
                    console.log(
                        `🔧 Selecting date ${targetDate} and finding task: ${taskTitle}`,
                    );

                    // First, select the correct date
                    const dayElements = document.querySelectorAll(".day");
                    let dateSelected = false;

                    dayElements.forEach((dayEl) => {
                        if (dayEl.dataset.date === targetDate) {
                            // Remove previous selection
                            document
                                .querySelectorAll(".day.selected")
                                .forEach((el) =>
                                    el.classList.remove("selected"),
                                );
                            // Select the target date
                            dayEl.classList.add("selected");
                            dateSelected = true;
                            console.log(`📅 Selected date: ${targetDate}`);
                        }
                    });

                    if (!dateSelected) {
                        console.warn(
                            `Date ${targetDate} not found in calendar`,
                        );
                    }

                    // Wait for tasks to load for the selected date
                    if (typeof window.loadTasksForDate === "function") {
                        await window.loadTasksForDate(targetDate);
                        console.log("📋 Tasks loaded for selected date");
                    }

                    // Wait a bit more for DOM to update
                    setTimeout(() => {
                        findAndEditTask(taskTitle);
                    }, 1000);
                }

                async function findAndEditTask(taskTitle) {
                    console.log(`🔍 Looking for task: ${taskTitle}`);

                    // Find task elements using multiple selectors
                    const taskSelectors = [
                        ".task-item",
                        ".task-card",
                        "[data-task-title]",
                        ".task",
                    ];

                    let targetTask = null;

                    for (const selector of taskSelectors) {
                        const taskElements =
                            document.querySelectorAll(selector);
                        console.log(
                            `🔍 Found ${taskElements.length} elements with selector: ${selector}`,
                        );

                        taskElements.forEach((taskEl) => {
                            // Try multiple ways to find the task title
                            const titleSelectors = [
                                ".task-title",
                                ".task-name",
                                "h3",
                                "h2",
                                "[data-task-title]",
                            ];

                            let titleElement = null;
                            let titleText = "";

                            // Try to find title element
                            for (const titleSelector of titleSelectors) {
                                titleElement =
                                    taskEl.querySelector(titleSelector);
                                if (titleElement) {
                                    titleText = titleElement.textContent.trim();
                                    break;
                                }
                            }

                            // Also check dataset
                            if (!titleText && taskEl.dataset.taskTitle) {
                                titleText = taskEl.dataset.taskTitle.trim();
                            }

                            // Also check if the task element itself contains the title
                            if (!titleText) {
                                titleText = taskEl.textContent.trim();
                            }

                            console.log(
                                `🔍 Checking task with title: "${titleText}"`,
                            );

                            if (
                                titleText === taskTitle ||
                                titleText.includes(taskTitle)
                            ) {
                                targetTask = taskEl;
                                console.log(
                                    `✅ Found matching task: ${titleText}`,
                                );
                            }
                        });

                        if (targetTask) break;
                    }

                    if (targetTask) {
                        console.log(
                            "🎯 Target task found, opening task card...",
                        );

                        // Click on the task to open its modal/card (but keep it hidden)
                        targetTask.click();

                        // Wait for modal to open, then find and click "Edit This Day"
                        setTimeout(() => {
                            triggerEditThisDay();
                        }, 800);
                    } else {
                        console.error(`❌ Task not found: "${taskTitle}"`);
                        console.log(
                            "Available tasks:",
                            Array.from(
                                document.querySelectorAll(".task-item"),
                            ).map((el) => {
                                const title = el.querySelector(".task-title");
                                return title
                                    ? title.textContent.trim()
                                    : "No title found";
                            }),
                        );

                        removeLoadingOverlay();
                        alert(
                            `Task "${taskTitle}" not found. Please make sure you're viewing the correct date.`,
                        );
                    }
                }

                function triggerEditThisDay() {
                    console.log('🔧 Looking for "Edit This Day" button...');

                    // Wait for modal to be fully rendered
                    const waitForModal = (attempts = 0) => {
                        if (attempts > 10) {
                            console.error("❌ Modal took too long to load");
                            alert(
                                'Edit This Day button not found. The task card may have opened, please click "Edit This Day" manually.',
                            );
                            return;
                        }

                        // Check if modal exists
                        const modal = document.querySelector(".task-modal");
                        if (!modal) {
                            console.log(
                                `🔧 Waiting for modal... attempt ${attempts + 1}`,
                            );
                            setTimeout(() => waitForModal(attempts + 1), 200);
                            return;
                        }

                        // Hide the modal from user view
                        modal.style.display = "none";
                        console.log(
                            "✅ Modal found and hidden, looking for Edit This Day button...",
                        );

                        // Multiple selectors for the Edit This Day button (removed invalid :contains selector)
                        const editButtonSelectors = [
                            "#editOccurrenceBtn",
                            'button[id="editOccurrenceBtn"]',
                            ".edit-this-day-btn",
                            ".edit-occurrence-btn",
                        ];

                        let editButton = null;

                        // First try standard selectors
                        for (const selector of editButtonSelectors) {
                            editButton = modal.querySelector(selector);
                            if (editButton) {
                                console.log(
                                    `✅ Found Edit This Day button with selector: ${selector}`,
                                );
                                break;
                            }
                        }

                        // If not found by selector, search by text content
                        if (!editButton) {
                            console.log(
                                "🔧 Searching buttons by text content...",
                            );
                            const allButtons = modal.querySelectorAll("button");
                            console.log(
                                `🔧 Found ${allButtons.length} buttons in modal`,
                            );

                            allButtons.forEach((btn, index) => {
                                const btnText = btn.textContent
                                    .trim()
                                    .toLowerCase();
                                console.log(
                                    `🔧 Button ${index + 1}: "${btn.textContent.trim()}" (ID: ${btn.id})`,
                                );

                                if (
                                    btnText.includes("edit this day") ||
                                    btnText === "edit this day"
                                ) {
                                    editButton = btn;
                                    console.log(
                                        "✅ Found Edit This Day button by text content",
                                    );
                                }
                            });
                        }

                        if (editButton) {
                            console.log(
                                '🎯 Clicking "Edit This Day" button...',
                            );
                            editButton.click();

                            // Wait for edit form to load, then remove overlay
                            setTimeout(() => {
                                console.log(
                                    "✅ Auto-edit process completed successfully!",
                                );
                                // Clean up hidden modal
                                const hiddenModal = document.querySelector(
                                    '.task-modal[style*="display: none"]',
                                );
                                if (hiddenModal) {
                                    hiddenModal.remove();
                                }
                                removeLoadingOverlay();
                            }, 1000);
                        } else {
                            console.error(
                                '❌ "Edit This Day" button not found in modal',
                            );
                            console.log(
                                "Available buttons in modal:",
                                Array.from(
                                    modal.querySelectorAll("button"),
                                ).map(
                                    (btn) =>
                                        `"${btn.textContent.trim()}" (ID: ${btn.id})`,
                                ),
                            );

                            removeLoadingOverlay();
                            alert(
                                'Edit This Day button not found. The task card may have opened, please click "Edit This Day" manually.',
                            );
                        }
                    };

                    // Start the modal waiting process
                    waitForModal();
                }

                // Function to create loading overlay
                function createLoadingOverlay() {
                    const overlay = document.createElement("div");
                    overlay.id = "autoEditOverlay";
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: #FFFFFF;
                        z-index: 9999;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        font-family: 'Poppins', sans-serif;
                    `;

                    overlay.innerHTML = `
                        <div style="text-align: center;">
                            <div style="width: 60px; height: 60px; border: 4px solid #FFC107; border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                            <h3 style="color: #6D4C41; margin: 0 0 10px 0; font-size: 18px; font-weight: 600;">Opening Task Editor</h3>
                            <p style="color: #795548; margin: 0; font-size: 14px;">Please wait...</p>
                        </div>
                        <style>
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        </style>
                    `;

                    document.body.appendChild(overlay);
                }

                function removeLoadingOverlay() {
                    const overlay = document.getElementById("autoEditOverlay");
                    if (overlay) {
                        overlay.remove();
                    }
                }

                console.log(
                    "🔧 Auto-edit functionality loaded for overdue tasks",
                );

                // AUTO-EDIT FUNCTIONALITY FOR OVERDUE TASKS
                // Check URL parameters for auto-edit trigger
                const autoEdit = urlParams.get("autoEdit");
                const targetDate = urlParams.get("date");

                if (autoEdit === "true") {
                    // Hide the page content and show loading overlay
                    createLoadingOverlay();

                    // Wait for page to fully load, then check for overdue task edit
                    setTimeout(() => {
                        checkAndTriggerOverdueEdit(targetDate);
                    }, 1500);
                }

                // Add debugging functions for testing task deletion
                window.debugTaskStatus = async function (titlePattern) {
                    console.log("🚨 TASK STATUS CHECK! 🚨");

                    const currentAdmin =
                        localStorage.getItem("currentAdminEmail");
                    if (!currentAdmin) {
                        console.error("🔧 No admin email found!");
                        return;
                    }

                    try {
                        const response = await fetch(
                            `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                            { cache: "no-store" },
                        );
                        if (!response.ok) {
                            throw new Error("Failed to fetch tasks");
                        }

                        const result = await response.json();
                        const matchingTasks = result.tasks.filter((t) =>
                            t.title.includes(titlePattern || "Multiple"),
                        );

                        console.log(
                            `🔧 Found ${matchingTasks.length} tasks matching "${titlePattern || "Multiple"}"`,
                        );
                        matchingTasks.forEach((task) => {
                            console.log("🔧 Task:", {
                                title: task.title,
                                date: task.date,
                                originalTitle: task.originalTitle,
                                occurrence: task.occurrence,
                                totalOccurrences: task.totalOccurrences,
                                timesPerDay: task.timesPerDay,
                            });
                        });

                        return matchingTasks;
                    } catch (error) {
                        console.error("🔧 Status check failed:", error);
                    }
                };

                console.log("🔧 Added debugging functions:");
                console.log(
                    "  - debugTaskStatus(titlePattern) - Check current tasks",
                );
                console.log(
                    "  - debugDeleteOccurrences(originalTitle, dateRange) - Test deletion",
                );
                console.log(
                    "  - debugCleanupDuplicates() - Remove duplicate tasks",
                );
                console.log(
                    "  - debugDeleteAllMatching('pattern') - Delete all tasks matching pattern",
                );
                console.log(
                    "  - debugDisplayIssue() - Check why tasks aren't showing in UI",
                );

                // fallback if still missing
                if (!admin || !user) {
                    console.warn("Missing admin or user in query or storage.");
                }

                if (admin && user) {
                    homeLink.href = `/BeeMazing-A1/mobile/2-UserProfiles/userAdmin.html?admin=${encodeURIComponent(admin)}&user=${encodeURIComponent(user)}`;
                } else {
                    console.warn("Admin or user missing for homeLink", {
                        admin,
                        user,
                    });
                }

                const logoutBtn = document.getElementById("logoutBtn");
                if (logoutBtn) {
                    console.log("Logout button found, adding event listener");
                    logoutBtn.addEventListener("click", () => {
                        console.log("Logout button clicked");
                        // Only remove login session info
                        localStorage.removeItem("isAdmin");
                        localStorage.removeItem("userData");
                        localStorage.removeItem("adminPassword");
                        // Keep currentAdminEmail as per home.js
                        window.location.href = "/BeeMazing-A1/login.html";
                    });
                } else {
                    console.log("Logout button not found");
                }

                // Profile icon functionality
                const profileIcon = document.getElementById("profileIcon");
                const userSelectModal =
                    document.getElementById("userSelectModal");
                const userList = document.getElementById("userList");
                const closeModalBtn = document.getElementById("closeModalBtn");

                if (profileIcon) {
                    profileIcon.addEventListener("click", async (event) => {
                        event.preventDefault();
                        event.stopPropagation();

                        if (!admin) {
                            alert(
                                "Admin email not found. Please log in again.",
                            );
                            return;
                        }

                        try {
                            const res = await fetch(
                                `https://beemazing1.onrender.com/get-users?adminEmail=${encodeURIComponent(admin)}`,
                            );
                            const data = await res.json();
                            if (!res.ok || !data.users)
                                throw new Error("Failed to fetch users");

                            const allUserData =
                                JSON.parse(localStorage.getItem("userData")) ||
                                {};
                            const userPermissions =
                                allUserData[admin]?.permissions ||
                                data.permissions ||
                                {};

                            userList.innerHTML = "";

                            data.users.forEach((userName) => {
                                const li = document.createElement("li");
                                li.style.setProperty(
                                    "color",
                                    "#5D4E41",
                                    "important",
                                );

                                const nameContainer =
                                    document.createElement("div");
                                nameContainer.classList.add("user-list-item");
                                const userNameSpan =
                                    document.createElement("span");
                                userNameSpan.textContent = userName;
                                userNameSpan.style.setProperty(
                                    "color",
                                    "#5D4E41",
                                    "important",
                                );
                                nameContainer.appendChild(userNameSpan);

                                if (userPermissions[userName] === "Admin") {
                                    const checkmark =
                                        document.createElement("span");
                                    checkmark.textContent = "✓";
                                    checkmark.style.color = "#00C4B4";
                                    checkmark.style.fontSize = "16px";
                                    checkmark.style.fontWeight = "bold";
                                    checkmark.title = "Admin";
                                    nameContainer.appendChild(checkmark);
                                }

                                li.appendChild(nameContainer);

                                // Add settings and delete buttons
                                const isLoggedInAsAdmin =
                                    localStorage.getItem("isAdmin") === "true";
                                if (isLoggedInAsAdmin) {
                                    const actionsContainer =
                                        document.createElement("div");
                                    actionsContainer.style.setProperty(
                                        "display",
                                        "flex",
                                        "important",
                                    );
                                    actionsContainer.style.setProperty(
                                        "gap",
                                        "8px",
                                        "important",
                                    );

                                    const editBtn =
                                        document.createElement("button");
                                    editBtn.innerHTML = "⚙️";
                                    editBtn.style.setProperty(
                                        "background",
                                        "rgb(251, 183, 64)",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "color",
                                        "rgb(245, 245, 220)",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "border",
                                        "none",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "border-radius",
                                        "50%",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "width",
                                        "30px",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "height",
                                        "30px",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "font-size",
                                        "14px",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "cursor",
                                        "pointer",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "display",
                                        "flex",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "align-items",
                                        "center",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "justify-content",
                                        "center",
                                        "important",
                                    );
                                    editBtn.onmouseover = function () {
                                        this.style.setProperty(
                                            "background",
                                            "#5D4E41",
                                            "important",
                                        );
                                        this.style.setProperty(
                                            "background-color",
                                            "#5D4E41",
                                            "important",
                                        );
                                    };
                                    editBtn.onmouseout = function () {
                                        this.style.setProperty(
                                            "background",
                                            "rgb(251, 183, 64)",
                                            "important",
                                        );
                                        this.style.setProperty(
                                            "background-color",
                                            "rgb(251, 183, 64)",
                                            "important",
                                        );
                                    };
                                    editBtn.addEventListener(
                                        "click",
                                        (event) => {
                                            event.stopPropagation();
                                            showPermissionModal(userName);
                                        },
                                    );

                                    const removeBtn =
                                        document.createElement("button");
                                    removeBtn.textContent = "X";
                                    removeBtn.style.setProperty(
                                        "background",
                                        "rgb(251, 183, 64)",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "color",
                                        "rgb(245, 245, 220)",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "border",
                                        "none",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "border-radius",
                                        "50%",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "width",
                                        "30px",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "height",
                                        "30px",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "font-size",
                                        "14px",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "font-weight",
                                        "bold",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "cursor",
                                        "pointer",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "display",
                                        "flex",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "align-items",
                                        "center",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "justify-content",
                                        "center",
                                        "important",
                                    );
                                    removeBtn.onmouseover = function () {
                                        this.style.setProperty(
                                            "background",
                                            "#5D4E41",
                                            "important",
                                        );
                                        this.style.setProperty(
                                            "background-color",
                                            "#5D4E41",
                                            "important",
                                        );
                                    };
                                    removeBtn.onmouseout = function () {
                                        this.style.setProperty(
                                            "background",
                                            "rgb(251, 183, 64)",
                                            "important",
                                        );
                                        this.style.setProperty(
                                            "background-color",
                                            "rgb(251, 183, 64)",
                                            "important",
                                        );
                                    };
                                    removeBtn.addEventListener(
                                        "click",
                                        (event) => {
                                            event.stopPropagation();
                                            showConfirmModal(userName);
                                        },
                                    );

                                    actionsContainer.appendChild(editBtn);
                                    actionsContainer.appendChild(removeBtn);
                                    li.appendChild(actionsContainer);
                                }

                                // Highlight current user
                                if (userName === user) {
                                    li.classList.add("active-user");
                                    li.style.setProperty(
                                        "background-color",
                                        "rgb(251, 183, 64)",
                                        "important",
                                    );
                                    li.style.setProperty(
                                        "background",
                                        "rgb(251, 183, 64)",
                                        "important",
                                    );
                                    li.style.setProperty(
                                        "color",
                                        "#5D4E41",
                                        "important",
                                    );
                                    li.style.setProperty(
                                        "font-weight",
                                        "600",
                                        "important",
                                    );
                                }

                                li.addEventListener("click", async () => {
                                    const isAdminUser =
                                        userPermissions[userName] === "Admin";
                                    const basePath = "/BeeMazing-A1/mobile";
                                    const isLoggedInAsAdmin =
                                        localStorage.getItem("isAdmin") ===
                                        "true";

                                    if (isAdminUser) {
                                        if (isLoggedInAsAdmin) {
                                            window.location.href = `${basePath}/2-UserProfiles/userAdmin.html?admin=${encodeURIComponent(admin)}&user=${encodeURIComponent(userName)}`;
                                        } else {
                                            const enteredPassword = prompt(
                                                "Enter Parent Password to access Admin profile:",
                                            );
                                            if (!enteredPassword) {
                                                alert(
                                                    "Password is required to access Admin profile.",
                                                );
                                                return;
                                            }
                                            try {
                                                const res = await fetch(
                                                    `https://beemazing1.onrender.com/verify-admin-password`,
                                                    {
                                                        method: "POST",
                                                        headers: {
                                                            "Content-Type":
                                                                "application/json",
                                                        },
                                                        body: JSON.stringify({
                                                            email: admin,
                                                            password:
                                                                enteredPassword,
                                                        }),
                                                    },
                                                );
                                                const data = await res.json();
                                                if (res.ok && data.success) {
                                                    window.location.href = `${basePath}/2-UserProfiles/userAdmin.html?admin=${encodeURIComponent(admin)}&user=${encodeURIComponent(userName)}`;
                                                } else {
                                                    alert(
                                                        data.message ||
                                                            "Incorrect password. Access denied.",
                                                    );
                                                }
                                            } catch (err) {
                                                console.error(
                                                    "Error verifying admin password:",
                                                    err,
                                                );
                                                alert(
                                                    "Failed to verify password. Please check your connection.",
                                                );
                                            }
                                        }
                                    } else {
                                        window.location.href = `${basePath}/2-UserProfiles/users.html?admin=${encodeURIComponent(admin)}&user=${encodeURIComponent(userName)}`;
                                    }
                                });

                                userList.appendChild(li);
                            });

                            // Show modal with force inline styles
                            userSelectModal.style.display = "block";
                            userSelectModal.style.opacity = "1";
                            userSelectModal.classList.add("show");

                            const bottomSheetContent =
                                userSelectModal.querySelector(
                                    ".bottom-sheet-content",
                                );
                            if (bottomSheetContent) {
                                bottomSheetContent.style.transform =
                                    "translateY(0)";
                            }
                        } catch (err) {
                            console.error("Failed to load users:", err);
                            userList.innerHTML =
                                '<li style="padding: 15px; color: #D32F2F;">Failed to load users</li>';
                            userSelectModal.style.display = "block";
                            userSelectModal.style.opacity = "1";
                            userSelectModal.classList.add("show");
                        }
                    });
                }

                // Modal close functionality
                if (userSelectModal) {
                    userSelectModal.addEventListener("click", (e) => {
                        if (e.target === userSelectModal) {
                            userSelectModal.style.display = "none";
                            userSelectModal.style.opacity = "0";
                            userSelectModal.classList.remove("show");
                            const bottomSheetContent =
                                userSelectModal.querySelector(
                                    ".bottom-sheet-content",
                                );
                            if (bottomSheetContent) {
                                bottomSheetContent.style.transform =
                                    "translateY(100%)";
                            }
                        }
                    });
                }

                if (closeModalBtn) {
                    closeModalBtn.addEventListener("click", () => {
                        userSelectModal.style.display = "none";
                        userSelectModal.style.opacity = "0";
                        userSelectModal.classList.remove("show");
                        const bottomSheetContent =
                            userSelectModal.querySelector(
                                ".bottom-sheet-content",
                            );
                        if (bottomSheetContent) {
                            bottomSheetContent.style.transform =
                                "translateY(100%)";
                        }
                    });
                }

                // Global variables for modal functionality
                let userToRemove = null;
                let selectedUserForPermission = null;

                // Modal functionality functions
                function showConfirmModal(username) {
                    userToRemove = username;
                    const confirmModal =
                        document.getElementById("confirmModal");
                    confirmModal.style.display = "flex";
                }

                function showPermissionModal(username) {
                    selectedUserForPermission = username;
                    const permissionModalUser = document.getElementById(
                        "permissionModalUser",
                    );
                    const editUserNameInput =
                        document.getElementById("editUserNameInput");
                    const editAdminRole =
                        document.getElementById("editAdminRole");
                    const editUserRole =
                        document.getElementById("editUserRole");
                    const editErrorMessage =
                        document.getElementById("editErrorMessage");

                    permissionModalUser.textContent = `Edit Bee`;
                    editUserNameInput.value = username;
                    editErrorMessage.style.display = "none";

                    const allUserData =
                        JSON.parse(localStorage.getItem("userData")) || {};
                    const userPermissions =
                        allUserData[admin]?.permissions || {};
                    const currentRole = userPermissions[username] || "User";

                    if (currentRole === "Admin") {
                        editAdminRole.checked = true;
                    } else {
                        editUserRole.checked = true;
                    }

                    const permissionModal =
                        document.getElementById("permissionModal");
                    permissionModal.style.display = "flex";
                }

                // Delete user from server function
                async function deleteUserFromServer(username) {
                    try {
                        const res = await fetch(
                            `https://beemazing1.onrender.com/delete-user?adminEmail=${encodeURIComponent(admin)}&username=${encodeURIComponent(username)}`,
                            {
                                method: "DELETE",
                                headers: { "Content-Type": "application/json" },
                            },
                        );
                        const result = await res.json();
                        if (result.success) {
                            // Update localStorage after successful server deletion
                            const allUserData =
                                JSON.parse(localStorage.getItem("userData")) ||
                                {};
                            let users = allUserData[admin]?.users || [];
                            users = users.filter((user) => user !== username);
                            if (!allUserData[admin]) {
                                allUserData[admin] = {
                                    users: [],
                                    permissions: {},
                                };
                            }
                            allUserData[admin].users = users;
                            localStorage.setItem(
                                "userData",
                                JSON.stringify(allUserData),
                            );
                            return true;
                        } else {
                            alert(
                                "Failed to delete user from server: " +
                                    result.message,
                            );
                            return false;
                        }
                    } catch (err) {
                        alert("Error deleting user. Please try again.");
                        return false;
                    }
                }

                // Add User button functionality
                const addUserBtnInModal = document.getElementById("addUserBtn");
                const addUserModal = document.getElementById("addUserModal");
                const submitUserBtn = document.getElementById("submitUserBtn");
                const cancelUserBtn = document.getElementById("cancelUserBtn");
                const usernameInput = document.getElementById("usernameInput");
                const errorMessage = document.getElementById("errorMessage");

                if (addUserBtnInModal) {
                    addUserBtnInModal.addEventListener("click", () => {
                        addUserModal.style.display = "flex";
                        usernameInput.value = "";
                        errorMessage.style.display = "none";
                        document.querySelector(
                            'input[name="beeRole"][value="User"]',
                        ).checked = true;
                    });
                }

                if (cancelUserBtn) {
                    cancelUserBtn.addEventListener("click", () => {
                        addUserModal.style.display = "none";
                    });
                }

                // Add user modal click outside to close
                if (addUserModal) {
                    addUserModal.addEventListener("click", (e) => {
                        if (e.target === addUserModal) {
                            addUserModal.style.display = "none";
                        }
                    });
                }

                // Submit new user
                if (submitUserBtn) {
                    submitUserBtn.addEventListener("click", async () => {
                        const username = usernameInput.value.trim();

                        if (!username) {
                            errorMessage.style.display = "block";
                            return;
                        }

                        if (!admin) {
                            alert(
                                "Error: Admin session expired. Please log in again.",
                            );
                            window.location.href = "/BeeMazing-A1/login.html";
                            return;
                        }

                        errorMessage.style.display = "none";
                        const selectedRole =
                            document.querySelector(
                                'input[name="beeRole"]:checked',
                            )?.value || "User";

                        try {
                            const res = await fetch(
                                "https://beemazing1.onrender.com/add-user",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        adminEmail: admin,
                                        newUser: username,
                                        role: selectedRole,
                                    }),
                                },
                            );

                            const result = await res.json();

                            if (result.success) {
                                const allUserData =
                                    JSON.parse(
                                        localStorage.getItem("userData"),
                                    ) || {};
                                if (!allUserData[admin]) {
                                    allUserData[admin] = {
                                        users: [],
                                        permissions: {},
                                    };
                                }

                                allUserData[admin].users.push(username);
                                allUserData[admin].permissions[username] =
                                    selectedRole;
                                localStorage.setItem(
                                    "userData",
                                    JSON.stringify(allUserData),
                                );

                                addUserModal.style.display = "none";
                                alert(
                                    `${username} has been added as a ${selectedRole}!`,
                                );

                                // Refresh the user list by clicking profile icon again
                                profileIcon.click();
                            } else {
                                alert("Failed to add user: " + result.message);
                            }
                        } catch (err) {
                            alert("Error adding user. Please try again.");
                        }
                    });
                }

                // Confirm Delete Modal event listeners
                const confirmModal = document.getElementById("confirmModal");
                const confirmYesBtn = document.getElementById("confirmYesBtn");
                const confirmNoBtn = document.getElementById("confirmNoBtn");

                confirmYesBtn.addEventListener("click", async () => {
                    if (userToRemove) {
                        const success =
                            await deleteUserFromServer(userToRemove);
                        if (success) {
                            userToRemove = null;
                            confirmModal.style.display = "none";
                            // Refresh the user list by clicking profile icon again
                            profileIcon.click();
                        }
                    }
                });

                confirmNoBtn.addEventListener("click", () => {
                    userToRemove = null;
                    confirmModal.style.display = "none";
                });

                confirmModal.addEventListener("click", (e) => {
                    if (e.target === confirmModal) {
                        userToRemove = null;
                        confirmModal.style.display = "none";
                    }
                });

                // Permission Modal event listeners
                const permissionModal =
                    document.getElementById("permissionModal");
                const savePermissionBtn =
                    document.getElementById("savePermissionBtn");

                if (savePermissionBtn) {
                    savePermissionBtn.addEventListener("click", async () => {
                        if (selectedUserForPermission) {
                            const editUserNameInput =
                                document.getElementById("editUserNameInput");
                            const editErrorMessage =
                                document.getElementById("editErrorMessage");
                            const newName = editUserNameInput.value.trim();

                            if (!newName) {
                                editErrorMessage.style.display = "block";
                                return;
                            }

                            editErrorMessage.style.display = "none";
                            const newPermission =
                                document.querySelector(
                                    'input[name="editBeeRole"]:checked',
                                )?.value || "User";
                            const oldName = selectedUserForPermission;

                            try {
                                const roleText =
                                    newPermission === "Admin"
                                        ? "Parent Bee"
                                        : "Child Bee";

                                // If name changed, delete old user and add new one
                                if (oldName !== newName) {
                                    // Delete old user
                                    const deleteRes = await fetch(
                                        `https://beemazing1.onrender.com/delete-user?adminEmail=${encodeURIComponent(admin)}&username=${encodeURIComponent(oldName)}`,
                                        {
                                            method: "DELETE",
                                            headers: {
                                                "Content-Type":
                                                    "application/json",
                                            },
                                        },
                                    );
                                    const addRes = await fetch(
                                        "https://beemazing1.onrender.com/add-user",
                                        {
                                            method: "POST",
                                            headers: {
                                                "Content-Type":
                                                    "application/json",
                                            },
                                            body: JSON.stringify({
                                                adminEmail: admin,
                                                newUser: newName,
                                                role: newPermission,
                                            }),
                                        },
                                    );

                                    const addResult = await addRes.json();
                                    if (addResult.success) {
                                        alert(
                                            `User updated! Name changed to "${newName}" and role set to ${roleText}.`,
                                        );
                                    } else {
                                        alert(
                                            "Failed to update user name: " +
                                                addResult.message,
                                        );
                                    }
                                } else {
                                    // Only role changed, update permissions
                                    const allUserData =
                                        JSON.parse(
                                            localStorage.getItem("userData"),
                                        ) || {};
                                    if (!allUserData[admin]) {
                                        allUserData[admin] = {
                                            users: [],
                                            permissions: {},
                                        };
                                    }
                                    allUserData[admin].permissions[newName] =
                                        newPermission;
                                    localStorage.setItem(
                                        "userData",
                                        JSON.stringify(allUserData),
                                    );

                                    const res = await fetch(
                                        "https://beemazing1.onrender.com/save-permissions",
                                        {
                                            method: "POST",
                                            headers: {
                                                "Content-Type":
                                                    "application/json",
                                            },
                                            body: JSON.stringify({
                                                adminEmail: admin,
                                                permissions:
                                                    allUserData[admin]
                                                        .permissions,
                                            }),
                                        },
                                    );
                                    const result = await res.json();

                                    if (result.success) {
                                        alert(
                                            `User updated! ${newName} is now a ${roleText}.`,
                                        );
                                    } else {
                                        alert(
                                            `Local changes saved. Role updated to ${roleText}.`,
                                        );
                                    }
                                }

                                // Update localStorage regardless
                                const allUserData =
                                    JSON.parse(
                                        localStorage.getItem("userData"),
                                    ) || {};
                                if (!allUserData[admin]) {
                                    allUserData[admin] = {
                                        users: [],
                                        permissions: {},
                                    };
                                }

                                if (oldName !== newName) {
                                    const userIndex =
                                        allUserData[admin].users.indexOf(
                                            oldName,
                                        );
                                    if (userIndex !== -1) {
                                        allUserData[admin].users[userIndex] =
                                            newName;
                                    }
                                    delete allUserData[admin].permissions[
                                        oldName
                                    ];
                                }
                                allUserData[admin].permissions[newName] =
                                    newPermission;
                                localStorage.setItem(
                                    "userData",
                                    JSON.stringify(allUserData),
                                );
                            } catch (err) {
                                const roleText =
                                    newPermission === "Admin"
                                        ? "Parent Bee"
                                        : "Child Bee";
                                alert(`Error updating user. Please try again.`);
                            }

                            selectedUserForPermission = null;
                            permissionModal.style.display = "none";
                            profileIcon.click();
                        }
                    });
                }

                // Cancel edit button
                const cancelEditBtn = document.getElementById("cancelEditBtn");
                if (cancelEditBtn) {
                    cancelEditBtn.addEventListener("click", () => {
                        selectedUserForPermission = null;
                        permissionModal.style.display = "none";
                    });
                }

                permissionModal.addEventListener("click", (e) => {
                    if (e.target === permissionModal) {
                        selectedUserForPermission = null;
                        permissionModal.style.display = "none";
                    }
                });
            });

            document
                .getElementById("addTaskBtn")
                .addEventListener("click", () => {
                    localStorage.removeItem("familyApp_editTask");
                    localStorage.removeItem("familyApp_editTask_index");
                    const admin = localStorage.getItem("currentAdminEmail");
                    const user = localStorage.getItem("currentUser");
                    if (admin && user) {
                        window.location.href = `/BeeMazing-A1/mobile/3-Tasks/addtasks.html?admin=${encodeURIComponent(admin)}&user=${encodeURIComponent(user)}`;
                    } else {
                        alert(
                            "Admin or user information missing. Please log in again.",
                        );
                    }
                });

            // Verify taskrotations.js load
            fetch("/BeeMazing-A1/shared/taskrotations.js?t=" + Date.now(), {
                method: "HEAD",
            })
                .then((response) => {
                    if (!response.ok) {
                        console.error(
                            `Failed to fetch taskrotations.js: HTTP ${response.status}`,
                        );
                    } else {
                        console.log("taskrotations.js is accessible");
                    }
                })
                .catch((err) =>
                    console.error("Error fetching taskrotations.js:", err),
                );

            if (
                typeof mixedTurnData === "undefined" ||
                typeof individualTurnData === "undefined" ||
                typeof filterTasksForDate === "undefined"
            ) {
                console.error(
                    "taskrotations.js failed to load or does not contain required functions (mixedTurnData/individualTurnData/filterTasksForDate)",
                );
            } else {
                console.log(
                    "taskrotations.js loaded successfully with all required functions",
                );
            }

            // Dynamically highlight the active footer icon
            document.querySelectorAll(".footer a").forEach((link) => {
                const currentPath = window.location.pathname.replace(/\/$/, "");
                const linkPath = new URL(link.href).pathname.replace(/\/$/, "");
                if (currentPath === linkPath) {
                    link.classList.add("active");
                } else {
                    link.classList.remove("active");
                }
            });

            // Helper to format dates as YYYY-MM-DD
            const formatDate = (d) => d.toISOString().split("T")[0];

            // addtasks.html Settings: Rotation //////////////////////////////////////////////////////////////////////////////////////////

            // Load tasks for a specific date
            async function loadTasksForDate(selectedDate) {
                // Ensure avatar system is ready before loading tasks
                if (window.ensureAvatarSystemReady) {
                    await window.ensureAvatarSystemReady();
                }

                // Ensure Enhanced Fair Rotation System is ready
                if (window.enhancedFairRotationSystem) {
                    console.log(
                        "✅ Enhanced Fair Rotation System available for task loading",
                    );
                } else {
                    console.log(
                        "⚠️ Enhanced Fair Rotation System not available - will use fallback rotation methods",
                    );
                }

                const adminEmail = localStorage.getItem("currentAdminEmail");
                if (!adminEmail) {
                    document.getElementById("taskList").innerHTML =
                        `<div style="text-align:center; margin-top: 40px; color: #ccc;">No admin email found 🌙</div>`;
                    return;
                }

                try {
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({
                            error: `HTTP error ${response.status}`,
                        }));
                        throw new Error(
                            `Failed to fetch tasks: ${errorData.error || response.statusText}`,
                        );
                    }
                    const result = await response.json();
                    const tasks = result.tasks || [];

                    // Enhanced debugging for raw backend response
                    console.log(`🔍 RAW BACKEND RESPONSE for ${selectedDate}:`);
                    console.log(`📡 Response status: ${response.status}`);
                    console.log(`📡 Total tasks in response: ${tasks.length}`);
                    tasks.forEach((task) => {
                        if (task.title && task.title.includes("final")) {
                            console.log(`📡 RAW Task "${task.title}":`, task);
                            console.log(
                                `📡 RAW completions:`,
                                task.completions,
                            );
                            console.log(
                                `📡 RAW pendingCompletions:`,
                                task.pendingCompletions,
                            );
                        }
                    });

                    // Enhanced debugging for completion data
                    console.log(
                        `🔍 COMPLETION DATA DEBUG for ${selectedDate}:`,
                    );
                    console.log(`📊 Total tasks received: ${tasks.length}`);
                    tasks.forEach((task) => {
                        const completions = task.completions || {};
                        const todayCompletions =
                            completions[selectedDate] || [];
                        if (todayCompletions.length > 0) {
                            console.log(
                                `  ✅ Task "${task.title}" has ${todayCompletions.length} completion(s):`,
                                todayCompletions,
                            );
                            // Check if completions are pending or approved
                            const pending = todayCompletions.filter(
                                (c) => c.isPending,
                            );
                            const approved = todayCompletions.filter(
                                (c) => !c.isPending,
                            );
                            console.log(
                                `    - Pending: ${pending.length}, Approved: ${approved.length}`,
                            );
                        } else {
                            console.log(
                                `  ❌ Task "${task.title}" has NO completions for ${selectedDate}`,
                            );
                            // Show if there are completions for other dates
                            const otherDates = Object.keys(completions);
                            if (otherDates.length > 0) {
                                console.log(
                                    `    - Has completions for other dates: ${otherDates.join(", ")}`,
                                );
                            }
                        }
                    });

                    // Debug functions - available in console
                    window.debugTaskCompletion = function (
                        taskTitle,
                        userName,
                        date,
                    ) {
                        console.log(
                            `🧪 DEBUG: Testing task completion for "${taskTitle}"`,
                        );
                        const adminEmail =
                            localStorage.getItem("currentAdminEmail");
                        const testDate = date || selectedDate;
                        const testUser =
                            userName || localStorage.getItem("currentUser");

                        fetch(
                            "https://beemazing1.onrender.com/api/complete-task",
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    adminEmail: adminEmail,
                                    taskTitle: taskTitle,
                                    user: testUser,
                                    date: testDate,
                                    parentApproval: false,
                                }),
                            },
                        )
                            .then((response) => {
                                console.log(
                                    `📊 Response status: ${response.status}`,
                                );
                                return response.json().then((data) => ({
                                    status: response.status,
                                    data,
                                }));
                            })
                            .then(({ status, data }) => {
                                console.log(`📊 Response data:`, data);
                                if (status >= 400) {
                                    console.log(
                                        `❌ Error response - this might indicate task is already complete`,
                                    );
                                } else {
                                    console.log(`✅ Success response`);
                                }

                                // Refresh tasks after test
                                setTimeout(
                                    () => loadTasksForDate(testDate),
                                    500,
                                );
                            })
                            .catch((error) => {
                                console.error(`❌ Request failed:`, error);
                            });
                    };

                    window.debugTaskData = function (taskTitle) {
                        const task = tasks.find((t) => t.title === taskTitle);
                        if (task) {
                            console.log(
                                `🔍 Task data for "${taskTitle}":`,
                                task,
                            );
                            console.log(`🔍 Completions:`, task.completions);
                            console.log(
                                `🔍 Completions for ${selectedDate}:`,
                                task.completions?.[selectedDate],
                            );
                        } else {
                            console.log(`❌ Task "${taskTitle}" not found`);
                            console.log(
                                `Available tasks:`,
                                tasks.map((t) => t.title),
                            );
                        }
                    };

                    // Force refresh function for manual testing
                    window.forceRefreshTasks = function () {
                        console.log(
                            "🔄 FORCE REFRESH: Manually refreshing all task data",
                        );
                        const selectedDateElement =
                            document.querySelector(".day.selected");
                        const currentSelectedDate = selectedDateElement
                            ? selectedDateElement.dataset.date
                            : new Date().toISOString().split("T")[0];

                        // Add visual feedback
                        const refreshBtn =
                            document.querySelector(".refresh-btn");
                        if (refreshBtn) {
                            refreshBtn.style.transform =
                                "scale(0.95) rotate(180deg)";
                            setTimeout(() => {
                                refreshBtn.style.transform = "";
                            }, 300);
                        }

                        loadTasksForDate(currentSelectedDate);
                    };

                    // Comprehensive debugging function for completion flow
                    window.debugCompletionFlow = function (taskTitle) {
                        console.log(
                            "🔍 DEBUGGING COMPLETION FLOW for:",
                            taskTitle,
                        );
                        const selectedDateElement =
                            document.querySelector(".day.selected");
                        const selectedDate = selectedDateElement
                            ? selectedDateElement.dataset.date
                            : new Date().toISOString().split("T")[0];
                        const adminEmail =
                            localStorage.getItem("currentAdminEmail");

                        // Check current task status with forced fresh fetch
                        fetch(
                            `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                            {
                                cache: "no-store",
                                headers: {
                                    "Cache-Control": "no-cache",
                                    Pragma: "no-cache",
                                },
                            },
                        )
                            .then((response) => {
                                console.log("📡 RAW BACKEND RESPONSE:");
                                console.log(
                                    "📡 Response status:",
                                    response.status,
                                );
                                return response.json();
                            })
                            .then((result) => {
                                console.log(
                                    "📡 Total tasks in response:",
                                    result.tasks.length,
                                );

                                const task = result.tasks.find(
                                    (t) => t.title === taskTitle,
                                );
                                if (task) {
                                    console.log("📡 RAW Task data:", task);
                                    console.log(
                                        "📡 RAW completions:",
                                        task.completions,
                                    );
                                    console.log(
                                        "📡 RAW pendingCompletions:",
                                        task.pendingCompletions,
                                    );

                                    console.log(
                                        "📊 BEFORE - Task found:",
                                        task.title,
                                    );
                                    console.log(
                                        "📊 BEFORE - All completions:",
                                        task.completions,
                                    );
                                    console.log(
                                        "📊 BEFORE - Completions for",
                                        selectedDate,
                                        ":",
                                        task.completions?.[selectedDate] || [],
                                    );

                                    const completions =
                                        task.completions?.[selectedDate] || [];
                                    const pending = completions.filter(
                                        (c) => c.isPending,
                                    );
                                    const approved = completions.filter(
                                        (c) => !c.isPending,
                                    );
                                    console.log(
                                        "📊 BEFORE - Status: Pending:",
                                        pending.length,
                                        "Approved:",
                                        approved.length,
                                    );

                                    // Check UI status icon
                                    const taskCards =
                                        document.querySelectorAll(".task-item");
                                    taskCards.forEach((card) => {
                                        if (
                                            card
                                                .querySelector(".task-title")
                                                .textContent.includes(taskTitle)
                                        ) {
                                            const statusIcon =
                                                card.querySelector(
                                                    ".task-status-icon",
                                                );
                                            console.log(
                                                "📊 BEFORE - UI Status Icon:",
                                                statusIcon
                                                    ? statusIcon.textContent
                                                    : "not found",
                                            );
                                        }
                                    });
                                } else {
                                    console.log(
                                        "❌ Task not found:",
                                        taskTitle,
                                    );
                                    console.log(
                                        "Available tasks:",
                                        result.tasks.map((t) => t.title),
                                    );
                                }
                            })
                            .catch((error) =>
                                console.error(
                                    "❌ Error checking task status:",
                                    error,
                                ),
                            );
                    };

                    // Check completion after marking complete
                    window.checkCompletionAfter = function (
                        taskTitle,
                        delayMs = 1000,
                    ) {
                        console.log(
                            "⏰ Checking completion status after",
                            delayMs,
                            "ms delay",
                        );
                        setTimeout(() => {
                            window.debugCompletionFlow(taskTitle);
                        }, delayMs);
                    };

                    // List all available task names for easy copy-paste
                    window.listAllTasks = function () {
                        console.log("📋 ALL AVAILABLE TASKS:");
                        tasks.forEach((task, index) => {
                            console.log(`  ${index + 1}. "${task.title}"`);
                        });
                        console.log(
                            "💡 Copy the exact task name and use: debugCompletionFlow('Task Name Here')",
                        );
                        console.log(
                            "💡 OR hold Shift and click any task to debug it instantly!",
                        );
                    };
                    for (const task of tasks) {
                        if (
                            !task.title ||
                            !Array.isArray(task.users) ||
                            task.users.length === 0
                        ) {
                            console.warn("Found invalid task, skipping:", task);
                            continue; // Skip instead of delete
                        }
                        // Don't validate date field - As Needed tasks have empty dates
                    }

                    // Initialize predicted schedules for fair rotation tasks
                    if (
                        window.PredictedScheduleSystem &&
                        typeof window.PredictedScheduleSystem
                            .initializePredictedSchedules === "function"
                    ) {
                        console.log(
                            `🔮 Initializing predicted schedules for ${tasks.length} tasks`,
                        );
                        window.PredictedScheduleSystem.initializePredictedSchedules(
                            tasks,
                            selectedDate,
                        );
                    } else if (
                        typeof initializeFairRotationSchedules === "function"
                    ) {
                        // Fallback to direct function call
                        initializeFairRotationSchedules(tasks, selectedDate);
                    }

                    const taskList = document.getElementById("taskList");
                    taskList.innerHTML = "";

                    let visibleTasks;
                    if (typeof filterTasksForDate === "function") {
                        visibleTasks = filterTasksForDate(tasks, selectedDate);
                    } else {
                        console.error(
                            "filterTasksForDate function not available - using fallback filtering",
                        );
                        // Fallback: robust filtering that handles new task types
                        visibleTasks = tasks.filter((task) => {
                            // Handle As Needed tasks - always show them
                            if (task.asNeeded || task.repeat === "As Needed") {
                                return true;
                            }

                            // Handle tasks without dates - show them as "as needed" tasks
                            if (!task.date) return true;

                            // Handle specific dates
                            if (task.specificDates) {
                                const specificDates = task.specificDates
                                    .split(",")
                                    .map((d) => d.trim());
                                return specificDates.includes(selectedDate);
                            }

                            // Handle date ranges
                            const range = task.date.split(" to ");
                            const from = new Date(range[0]);
                            const to = range[1]
                                ? new Date(range[1])
                                : new Date(3000, 0, 1);
                            const selected = new Date(selectedDate);
                            return selected >= from && selected <= to;
                        });
                    }

                    // Migrate existing fair rotation tasks to have rotation.enabled property
                    visibleTasks.forEach((task) => {
                        if (task.fairRotation && !task.rotation) {
                            task.rotation = {
                                enabled: true,
                                type: "fair",
                            };
                            console.log(
                                `🔄 Migrated fair rotation task "${task.title}" to have rotation.enabled`,
                            );
                        }
                    });

                    // Initialize Enhanced Fair Rotation System for fair rotation tasks
                    if (window.enhancedFairRotationSystem) {
                        console.log(
                            `🔍 Checking ${visibleTasks.length} visible tasks for Enhanced Fair Rotation initialization`,
                        );

                        // Group subtasks by base name for Enhanced Fair Rotation
                        const taskGroups = new Map();

                        visibleTasks.forEach((task) => {
                            console.log(`🔍 Task "${task.title}" analysis:`, {
                                fairRotation: task.fairRotation,
                                settings: task.settings,
                                rotation: task.rotation,
                                hasRotationSetting:
                                    task.settings?.includes("Rotation"),
                                users: task.users,
                                taskStructure: Object.keys(task),
                            });

                            // Check multiple conditions for fair rotation tasks
                            const isFairRotation = task.fairRotation === true;
                            const hasRotationSetting = Array.isArray(
                                task.settings,
                            )
                                ? task.settings.includes("Rotation")
                                : typeof task.settings === "string" &&
                                  task.settings.includes("Rotation");
                            const hasRotationProperty =
                                task.rotation?.enabled === true;
                            const isFairRotationType =
                                task.rotation?.type === "fair";

                            if (
                                isFairRotation ||
                                isFairRotationType ||
                                (hasRotationSetting &&
                                    task.fairRotation !== false)
                            ) {
                                console.log(
                                    `✅ Task "${task.title}" identified as fair rotation task (type: ${task.rotation?.type || "legacy"})`,
                                );

                                // Extract base task name (remove " - 1st", " - 2nd", etc.)
                                const baseTaskName = task.title.replace(
                                    / - \d+(?:st|nd|rd|th)$/,
                                    "",
                                );

                                // Group tasks by base name
                                if (!taskGroups.has(baseTaskName)) {
                                    taskGroups.set(baseTaskName, []);
                                }
                                taskGroups.get(baseTaskName).push(task);
                            } else {
                                console.log(
                                    `❌ Task "${task.title}" not identified as fair rotation task`,
                                );
                            }
                        });

                        // Initialize each task group
                        taskGroups.forEach((subtasks, baseTaskName) => {
                            try {
                                if (
                                    !window.enhancedFairRotationSystem.taskUsers.has(
                                        baseTaskName,
                                    )
                                ) {
                                    console.log(
                                        `🔄 Initializing Enhanced Fair Rotation for task group: ${baseTaskName} (${subtasks.length} subtasks)`,
                                    );

                                    // Use first subtask for basic info
                                    const firstTask = subtasks[0];

                                    // Collect all completion history from all subtasks
                                    const combinedCompletions = {};
                                    subtasks.forEach((subtask) => {
                                        if (subtask.completions) {
                                            Object.keys(
                                                subtask.completions,
                                            ).forEach((date) => {
                                                if (
                                                    !combinedCompletions[date]
                                                ) {
                                                    combinedCompletions[date] =
                                                        [];
                                                }
                                                combinedCompletions[date].push(
                                                    ...(subtask.completions[
                                                        date
                                                    ] || []),
                                                );
                                            });
                                        }
                                    });

                                    window.enhancedFairRotationSystem.initializeTask(
                                        baseTaskName,
                                        firstTask.users || [],
                                        {
                                            frequency:
                                                firstTask.frequency || "daily",
                                            timesPerDay: subtasks.length, // Number of subtasks = occurrences per day
                                        },
                                    );

                                    // Import existing completion history
                                    if (
                                        Object.keys(combinedCompletions)
                                            .length > 0
                                    ) {
                                        console.log(
                                            `📊 Importing ${Object.keys(combinedCompletions).length} days of completion history for ${baseTaskName}`,
                                        );
                                        Object.keys(
                                            combinedCompletions,
                                        ).forEach((date) => {
                                            combinedCompletions[date].forEach(
                                                (completion) => {
                                                    if (!completion.isPending) {
                                                        // Add to approved completions
                                                        const history =
                                                            window.enhancedFairRotationSystem.completionHistory.get(
                                                                baseTaskName,
                                                            );
                                                        if (history) {
                                                            history.approved.push(
                                                                {
                                                                    user: completion.user,
                                                                    occurrence: 1, // Will be adjusted by system
                                                                    date: date,
                                                                    timestamp:
                                                                        completion.timestamp ||
                                                                        new Date().toISOString(),
                                                                },
                                                            );
                                                        }
                                                    }
                                                },
                                            );
                                        });

                                        // Recalculate assignments with imported history
                                        window.enhancedFairRotationSystem.recalculateAssignments(
                                            baseTaskName,
                                            false,
                                        );
                                    }

                                    console.log(
                                        `✅ Successfully initialized Enhanced Fair Rotation for: ${baseTaskName}`,
                                    );
                                } else {
                                    console.log(
                                        `ℹ️ Task group "${baseTaskName}" already initialized in Enhanced Fair Rotation System`,
                                    );
                                }
                            } catch (error) {
                                console.error(
                                    `❌ Failed to initialize Enhanced Fair Rotation for ${baseTaskName}:`,
                                    error,
                                );
                            }
                        });

                        // Summary after initialization
                        const initializedCount =
                            window.enhancedFairRotationSystem.taskUsers.size;
                        console.log(
                            `📊 Enhanced Fair Rotation System now has ${initializedCount} task groups initialized`,
                        );
                    }

                    if (visibleTasks.length === 0) {
                        taskList.innerHTML = `<div style="text-align:center; margin-top: 40px; color: #ccc;">No tasks for this day 🌙</div>`;
                        return;
                    }

                    // Comprehensive task sorting
                    visibleTasks.sort((a, b) => {
                        // Helper functions
                        const isAsNeeded = (task) =>
                            task.asNeeded ||
                            task.repeat === "As Needed" ||
                            !task.date;
                        const getDueTime = (task) =>
                            task.dueTimes && task.dueTimes.length > 0
                                ? task.dueTimes[0]
                                : null;
                        const getTaskStatus = (task) => {
                            const completedUsers = Array.isArray(
                                task.completions?.[selectedDate],
                            )
                                ? task.completions[selectedDate]
                                : [];
                            const pendingUsers = completedUsers.filter(
                                (c) => c.isPending,
                            );
                            const approvedUsers = completedUsers.filter(
                                (c) => !c.isPending,
                            );

                            if (approvedUsers.length > 0) return "completed";
                            if (pendingUsers.length > 0) return "pending";
                            return "active";
                        };

                        const aIsAsNeeded = isAsNeeded(a);
                        const bIsAsNeeded = isAsNeeded(b);
                        const aStatus = getTaskStatus(a);
                        const bStatus = getTaskStatus(b);
                        const aDueTime = getDueTime(a);
                        const bDueTime = getDueTime(b);

                        // Priority order: active(due time) -> active(no due time) -> pending -> completed -> as needed
                        const statusPriority = {
                            active: 1,
                            pending: 2,
                            completed: 3,
                        };

                        // As needed tasks always go last
                        if (aIsAsNeeded && !bIsAsNeeded) return 1;
                        if (!aIsAsNeeded && bIsAsNeeded) return -1;
                        if (aIsAsNeeded && bIsAsNeeded) return 0; // Maintain order for as needed tasks

                        // Both are regular tasks - sort by status first
                        if (
                            statusPriority[aStatus] !== statusPriority[bStatus]
                        ) {
                            return (
                                statusPriority[aStatus] -
                                statusPriority[bStatus]
                            );
                        }

                        // Same status - handle active tasks with due times
                        if (aStatus === "active" && bStatus === "active") {
                            // Both have due times - sort by time (earlier first)
                            if (aDueTime && bDueTime) {
                                return aDueTime.localeCompare(bDueTime);
                            }
                            // Tasks with due times go before tasks without due times
                            if (aDueTime && !bDueTime) return -1;
                            if (!aDueTime && bDueTime) return 1;
                        }

                        // Same status and due time situation - maintain original order
                        return 0;
                    });

                    visibleTasks.forEach((task) => {
                        const taskDiv = document.createElement("div");
                        taskDiv.className = "task-item";
                        taskDiv.dataset.taskTitle = task.title;
                        taskDiv.dataset.taskDate = task.date;

                        if (
                            !Array.isArray(task.users) ||
                            task.users.length === 0
                        ) {
                            task.users = ["Unknown"];
                        }

                        // Remove modification indicator - not needed in compact view
                        const modificationIndicator = "";

                        // Show occurrence indicator if this is a multi-occurrence task
                        const occurrenceIndicator =
                            task.occurrence && task.totalOccurrences > 1
                                ? ` <span style="color: #666; font-size: 12px;">(${task.occurrence}/${task.totalOccurrences})</span>`
                                : "";

                        // Remove clock icon - due times are shown separately
                        const approvalIcon = "";

                        // Generate compact task card HTML
                        let taskHTML = "";
                        let turnData = {
                            turns: [],
                            completedCount: 0,
                            requiredTimes: 1,
                        };

                        // Header with title and due time
                        // For occurrence tasks, each should have its own specific due time
                        const dueTimeHTML =
                            task.dueTimes && task.dueTimes.length > 0
                                ? `<div class="task-due-time">${task.dueTimes[0]}</div>`
                                : "";

                        // Calculate task status for this card
                        const completedUsers = Array.isArray(
                            task.completions?.[selectedDate],
                        )
                            ? task.completions[selectedDate]
                            : [];
                        const pendingUsers = completedUsers.filter(
                            (c) => c.isPending,
                        );
                        const approvedUsers = completedUsers.filter(
                            (c) => !c.isPending,
                        );

                        let statusIcon = "";
                        let originalUserIcon = "";

                        if (approvedUsers.length > 0) {
                            statusIcon =
                                '<div class="task-status-icon complete" title="Complete">✅</div>';

                            // Check if completed by different user and add original user icon
                            const completedByUsers = [
                                ...new Set(approvedUsers.map((c) => c.user)),
                            ];
                            const assignedUsers = task.users || [];
                            const isCompletedByDifferentUser =
                                completedByUsers.some(
                                    (user) => !assignedUsers.includes(user),
                                );

                            if (
                                isCompletedByDifferentUser &&
                                assignedUsers.length > 0
                            ) {
                                // Show the original assigned user icon
                                if (
                                    window.avatarSystem &&
                                    typeof window.avatarSystem
                                        .generateAvatarHTML === "function"
                                ) {
                                    originalUserIcon =
                                        window.avatarSystem.generateAvatarHTML(
                                            assignedUsers[0],
                                            20,
                                            "original-user-avatar",
                                            `Originally assigned to ${assignedUsers[0]}`,
                                        );
                                } else {
                                    // Fallback when avatar system not available
                                    const initials = assignedUsers[0]
                                        .substring(0, 2)
                                        .toUpperCase();
                                    originalUserIcon = `<div class="original-user-avatar" style="width: 20px; height: 20px; border: 2px solid #fbb740; border-radius: 50%; background: #FF8A50; color: white; font-size: 8px; display: flex; align-items: center; justify-content: center; margin-left: 4px; opacity: 0.8; position: relative;" title="Originally assigned to ${assignedUsers[0]}">${initials}<div style="content: '↩'; position: absolute; bottom: -2px; right: -2px; font-size: 8px; background: #fbb740; color: white; border-radius: 50%; width: 10px; height: 10px; display: flex; align-items: center; justify-content: center; line-height: 1;">↩</div></div>`;
                                }
                            }
                        } else if (pendingUsers.length > 0) {
                            statusIcon =
                                '<div class="task-status-icon pending" title="Pending Approval">⏳</div>';

                            // Check if pending by different user and add original user icon
                            const pendingByUsers = [
                                ...new Set(pendingUsers.map((c) => c.user)),
                            ];
                            const assignedUsers = task.users || [];
                            const isPendingByDifferentUser =
                                pendingByUsers.some(
                                    (user) => !assignedUsers.includes(user),
                                );

                            if (
                                isPendingByDifferentUser &&
                                assignedUsers.length > 0
                            ) {
                                // Show the original assigned user icon
                                if (
                                    window.avatarSystem &&
                                    typeof window.avatarSystem
                                        .generateAvatarHTML === "function"
                                ) {
                                    originalUserIcon =
                                        window.avatarSystem.generateAvatarHTML(
                                            assignedUsers[0],
                                            20,
                                            "original-user-avatar",
                                            `Originally assigned to ${assignedUsers[0]}`,
                                        );
                                } else {
                                    // Fallback when avatar system not available
                                    const initials = assignedUsers[0]
                                        .substring(0, 2)
                                        .toUpperCase();
                                    originalUserIcon = `<div class="original-user-avatar" style="width: 20px; height: 20px; border: 2px solid #fbb740; border-radius: 50%; background: #FF8A50; color: white; font-size: 8px; display: flex; align-items: center; justify-content: center; margin-left: 4px; opacity: 0.8; position: relative;" title="Originally assigned to ${assignedUsers[0]}">${initials}<div style="content: '↩'; position: absolute; bottom: -2px; right: -2px; font-size: 8px; background: #fbb740; color: white; border-radius: 50%; width: 10px; height: 10px; display: flex; align-items: center; justify-content: center; line-height: 1;">↩</div></div>`;
                                }
                            }
                        } else {
                            statusIcon =
                                '<div class="task-status-icon incomplete" title="Incomplete">⭕</div>';

                            // Check if this task was reassigned (check tempTurnReplacement or exceptions)
                            const assignedUsers = task.users || [];
                            const currentDate = selectedDate;
                            let hasReassignment = false;
                            let originalAssignee = null;

                            // Check if there are temp turn replacements
                            if (
                                task.tempTurnReplacement &&
                                task.tempTurnReplacement[currentDate]
                            ) {
                                hasReassignment = true;
                                // Get the first original user that was replaced
                                const replacements =
                                    task.tempTurnReplacement[currentDate];
                                for (const [
                                    index,
                                    replacementUser,
                                ] of Object.entries(replacements)) {
                                    const originalIndex = parseInt(index);
                                    if (
                                        task.users &&
                                        task.users[originalIndex]
                                    ) {
                                        originalAssignee =
                                            task.users[originalIndex];
                                        break;
                                    }
                                }
                            }

                            // Check if there are exceptions indicating reassignment
                            if (
                                !hasReassignment &&
                                task.exceptions &&
                                task.exceptions[currentDate] &&
                                task.exceptions[currentDate].task &&
                                task.exceptions[currentDate].task.users
                            ) {
                                const exceptionUsers =
                                    task.exceptions[currentDate].task.users;
                                const originalUsers = task.users;

                                // If exception users are different from original users, it's a reassignment
                                if (
                                    JSON.stringify(exceptionUsers) !==
                                    JSON.stringify(originalUsers)
                                ) {
                                    hasReassignment = true;
                                    originalAssignee =
                                        originalUsers && originalUsers[0];
                                }
                            }

                            if (hasReassignment && originalAssignee) {
                                // Show the original assigned user icon
                                if (
                                    window.avatarSystem &&
                                    typeof window.avatarSystem
                                        .generateAvatarHTML === "function"
                                ) {
                                    originalUserIcon =
                                        window.avatarSystem.generateAvatarHTML(
                                            originalAssignee,
                                            20,
                                            "original-user-avatar",
                                            `Originally assigned to ${originalAssignee}`,
                                        );
                                } else {
                                    // Fallback when avatar system not available
                                    const initials = originalAssignee
                                        .substring(0, 2)
                                        .toUpperCase();
                                    originalUserIcon = `<div class="original-user-avatar" style="width: 20px; height: 20px; border: 2px solid #fbb740; border-radius: 50%; background: #FF8A50; color: white; font-size: 8px; display: flex; align-items: center; justify-content: center; margin-left: 4px; opacity: 0.8; position: relative;" title="Originally assigned to ${originalAssignee}">${initials}<div style="content: '↩'; position: absolute; bottom: -2px; right: -2px; font-size: 8px; background: #fbb740; color: white; border-radius: 50%; width: 10px; height: 10px; display: flex; align-items: center; justify-content: center; line-height: 1;">↩</div></div>`;
                                }
                            }
                        }

                        taskHTML += `
                                <div class="task-header">
                                    <div class="task-title-row">
                                        ${statusIcon}${originalUserIcon}
                                        <div class="task-title">${task.title}${occurrenceIndicator}${approvalIcon}${modificationIndicator}</div>
                                        ${dueTimeHTML}
                                    </div>
                                </div>
                            `;

                        // Generate avatars section with buzz points on same line
                        let avatarsHTML = '<div class="task-avatars">';
                        avatarsHTML += '<div class="task-avatars-section">';

                        // Add team icon for Team Work tasks
                        const hasTeamWorkSetting = Array.isArray(task.settings)
                            ? task.settings.includes("Team Work")
                            : typeof task.settings === "string" &&
                              task.settings.includes("Team Work");
                        if (hasTeamWorkSetting) {
                            avatarsHTML += '<div class="team-icon">👥</div>';
                        }

                        // Add rotation icon for Rotation tasks
                        const hasRotationSetting = Array.isArray(task.settings)
                            ? task.settings.includes("Rotation")
                            : typeof task.settings === "string" &&
                              task.settings.includes("Rotation");
                        if (hasRotationSetting) {
                            avatarsHTML +=
                                '<div class="rotation-icon">🔄</div>';
                        }

                        if (hasRotationSetting) {
                            try {
                                // First priority: Enhanced Fair Rotation System for actual assignments
                                let enhancedAssignment = null;
                                const isFairRotationType =
                                    task.rotation?.type === "fair";
                                if (
                                    (task.fairRotation || isFairRotationType) &&
                                    window.enhancedFairRotationSystem
                                ) {
                                    // Extract base task name for Enhanced Fair Rotation lookup
                                    const baseTaskName = task.title.replace(
                                        / - \d+(?:st|nd|rd|th)$/,
                                        "",
                                    );
                                    const occurrenceMatch = task.title.match(
                                        / - (\d+)(?:st|nd|rd|th)$/,
                                    );
                                    const occurrenceNumber = occurrenceMatch
                                        ? parseInt(occurrenceMatch[1])
                                        : 1;

                                    // Initialize task in Enhanced Fair Rotation System if not already done
                                    if (
                                        !window.enhancedFairRotationSystem.taskUsers.has(
                                            baseTaskName,
                                        )
                                    ) {
                                        console.log(
                                            `🔄 Initializing Enhanced Fair Rotation for base task: ${baseTaskName}`,
                                        );
                                        window.enhancedFairRotationSystem.initializeTask(
                                            baseTaskName,
                                            task.users || [],
                                            {
                                                frequency:
                                                    task.frequency || "daily",
                                                timesPerDay:
                                                    task.timesPerDay || 1,
                                            },
                                        );
                                    }

                                    // Get actual Enhanced Fair Rotation assignment using base name
                                    enhancedAssignment =
                                        window.enhancedFairRotationSystem.getAssignmentInfo(
                                            baseTaskName,
                                            selectedDate,
                                            occurrenceNumber,
                                        );

                                    if (enhancedAssignment) {
                                        console.log(
                                            `✅ Using Enhanced Fair Rotation assignment for ${task.title}: ${enhancedAssignment.assignedUser}`,
                                        );

                                        // Create turn data structure compatible with existing UI
                                        turnData = {
                                            turns: [
                                                {
                                                    user: enhancedAssignment.assignedUser,
                                                    isCompleted: false,
                                                    isPending: false,
                                                    isEnhanced: true, // Flag to indicate this is from Enhanced Fair Rotation
                                                },
                                            ],
                                            completedCount: 0,
                                            requiredTimes: 1,
                                        };
                                    } else {
                                        console.log(
                                            `⚠️ No Enhanced Fair Rotation assignment found for ${task.title} on ${selectedDate}, falling back to prediction systems`,
                                        );
                                    }
                                }

                                // Fallback systems if Enhanced Fair Rotation doesn't have assignment
                                if (!enhancedAssignment) {
                                    // Use Local Fair Rotation System first, then fallback to other systems
                                    if (
                                        task.fairRotation &&
                                        window.localFairRotationSystem
                                    ) {
                                        console.log(
                                            `🔄 Using Local Fair Rotation System for task: ${task.title}`,
                                        );

                                        // Use local fair rotation system
                                        turnData =
                                            window.localFairRotationSystem.getLocalTurnData(
                                                task,
                                                selectedDate,
                                            );
                                    } else if (
                                        (task.fairRotation ||
                                            isFairRotationType) &&
                                        window.PredictedScheduleSystem
                                            ?.mixedTurnDataWithPrediction
                                    ) {
                                        console.log(
                                            `🔮 Using PredictedScheduleSystem for fair rotation task: ${task.title}`,
                                        );

                                        // Use predicted schedule system for fair rotation
                                        turnData =
                                            window.PredictedScheduleSystem.mixedTurnDataWithPrediction(
                                                task,
                                                selectedDate,
                                            );
                                    } else if (
                                        typeof mixedTurnData === "function"
                                    ) {
                                        // For regular rotation tasks, use turnData logic
                                        turnData = mixedTurnData(
                                            task,
                                            selectedDate,
                                        );
                                    }
                                }

                                // Process turn data for display (both predicted and regular)
                                if (turnData?.turns?.length > 0) {
                                    // Show current turn avatar
                                    const currentTurn = turnData.turns.find(
                                        (t) => !t.isCompleted && !t.isPending,
                                    );

                                    if (
                                        currentTurn &&
                                        currentTurn.user !== "All done!"
                                    ) {
                                        if (
                                            window.avatarSystem
                                                ?.generateAvatarHTML
                                        ) {
                                            avatarsHTML +=
                                                window.avatarSystem.generateAvatarHTML(
                                                    currentTurn.user,
                                                    24,
                                                    "task-avatar",
                                                );
                                        } else {
                                            const initials = currentTurn.user
                                                .substring(0, 2)
                                                .toUpperCase();
                                            avatarsHTML += `<div class="task-avatar" title="${currentTurn.user}">${initials}</div>`;
                                        }

                                        // Add indicator for enhanced or predicted assignments
                                        if (currentTurn.isEnhanced) {
                                            console.log(
                                                `✅ Showing Enhanced Fair Rotation assignment for ${task.title}: ${currentTurn.user}`,
                                            );
                                        } else if (currentTurn.isPredicted) {
                                            console.log(
                                                `🔮 Showing predicted assignment for ${task.title}: ${currentTurn.user}`,
                                            );
                                        }
                                    }

                                    // Show "Next:" label and upcoming avatars for regular rotation
                                    // (Skip for occurrence-based tasks)
                                    if (
                                        !task.occurrence &&
                                        turnData.turns.length > 1
                                    ) {
                                        const nextTurns = turnData.turns
                                            .filter(
                                                (t) =>
                                                    !t.isCompleted &&
                                                    !t.isPending,
                                            )
                                            .filter(
                                                (t) =>
                                                    t.user !==
                                                    currentTurn?.user,
                                            )
                                            .slice(0, 1); // Show next 1 only

                                        if (nextTurns.length > 0) {
                                            avatarsHTML +=
                                                '<span class="task-next-label">Next:</span>';
                                            nextTurns.forEach((turn) => {
                                                if (
                                                    window.avatarSystem
                                                        ?.generateAvatarHTML
                                                ) {
                                                    avatarsHTML +=
                                                        window.avatarSystem.generateAvatarHTML(
                                                            turn.user,
                                                            24,
                                                            "task-avatar",
                                                        );
                                                } else {
                                                    const initials = turn.user
                                                        .substring(0, 2)
                                                        .toUpperCase();
                                                    avatarsHTML += `<div class="task-avatar" title="${turn.user}">${initials}</div>`;
                                                }
                                            });
                                        }
                                    }
                                } else {
                                    // No turn data available - show all users as fallback
                                    console.warn(
                                        `No turn data for rotation task: ${task.title}`,
                                    );
                                    task.users?.forEach((user) => {
                                        if (
                                            window.avatarSystem
                                                ?.generateAvatarHTML
                                        ) {
                                            avatarsHTML +=
                                                window.avatarSystem.generateAvatarHTML(
                                                    user,
                                                    24,
                                                    "task-avatar",
                                                );
                                        } else {
                                            const initials = user
                                                .substring(0, 2)
                                                .toUpperCase();
                                            avatarsHTML += `<div class="task-avatar" title="${user}">${initials}</div>`;
                                        }
                                    });
                                }
                            } catch (err) {
                                console.error(
                                    `Error processing Rotation task "${task.title}":`,
                                    err,
                                );

                                // Robust fallback handling - try Enhanced Fair Rotation System first
                                const isFairRotationType =
                                    task.rotation?.type === "fair";
                                if (
                                    (task.fairRotation || isFairRotationType) &&
                                    window.enhancedFairRotationSystem
                                ) {
                                    // For fair rotation tasks, try Enhanced Fair Rotation System first in fallback
                                    console.log(
                                        `🔄 Using Enhanced Fair Rotation fallback for: ${task.title}`,
                                    );

                                    try {
                                        // Extract base task name for Enhanced Fair Rotation lookup
                                        const baseTaskName = task.title.replace(
                                            / - \d+(?:st|nd|rd|th)$/,
                                            "",
                                        );
                                        const occurrenceMatch =
                                            task.title.match(
                                                / - (\d+)(?:st|nd|rd|th)$/,
                                            );
                                        const occurrenceNumber = occurrenceMatch
                                            ? parseInt(occurrenceMatch[1])
                                            : 1;

                                        // Initialize task if not already done
                                        if (
                                            !window.enhancedFairRotationSystem.taskUsers.has(
                                                baseTaskName,
                                            )
                                        ) {
                                            window.enhancedFairRotationSystem.initializeTask(
                                                baseTaskName,
                                                task.users || [],
                                                {
                                                    frequency:
                                                        task.frequency ||
                                                        "daily",
                                                    timesPerDay:
                                                        task.timesPerDay || 1,
                                                },
                                            );
                                        }

                                        // Try to get assignment using base name
                                        const assignment =
                                            window.enhancedFairRotationSystem.getAssignmentInfo(
                                                baseTaskName,
                                                selectedDate,
                                                occurrenceNumber,
                                            );

                                        if (
                                            assignment &&
                                            assignment.assignedUser
                                        ) {
                                            const assignedUser =
                                                assignment.assignedUser;
                                            if (
                                                window.avatarSystem
                                                    ?.generateAvatarHTML
                                            ) {
                                                avatarsHTML +=
                                                    window.avatarSystem.generateAvatarHTML(
                                                        assignedUser,
                                                        24,
                                                        "task-avatar",
                                                    );
                                            } else {
                                                const initials = assignedUser
                                                    .substring(0, 2)
                                                    .toUpperCase();
                                                avatarsHTML += `<div class="task-avatar" title="${assignedUser}">${initials}</div>`;
                                            }
                                            console.log(
                                                `✅ Fallback Enhanced Fair Rotation assignment: ${assignedUser}`,
                                            );
                                        }
                                    } catch (enhancedError) {
                                        console.error(
                                            `❌ Enhanced Fair Rotation fallback failed:`,
                                            enhancedError,
                                        );
                                    }
                                } else if (
                                    (task.fairRotation || isFairRotationType) &&
                                    window.localFairRotationSystem
                                ) {
                                    // Secondary fallback: local fair rotation system
                                    console.log(
                                        `🔄 Using local fair rotation fallback for: ${task.title}`,
                                    );

                                    // Calculate assignment for first occurrence as fallback
                                    const assignment =
                                        window.localFairRotationSystem.calculateAssignee(
                                            task,
                                            selectedDate,
                                            0,
                                        );

                                    if (assignment && assignment.user) {
                                        const assignedUser = assignment.user;
                                        if (
                                            window.avatarSystem
                                                ?.generateAvatarHTML
                                        ) {
                                            avatarsHTML +=
                                                window.avatarSystem.generateAvatarHTML(
                                                    assignedUser,
                                                    24,
                                                    "task-avatar",
                                                );
                                        } else {
                                            const initials = assignedUser
                                                .substring(0, 2)
                                                .toUpperCase();
                                            avatarsHTML += `<div class="task-avatar" title="${assignedUser}">${initials}</div>`;
                                        }
                                        console.log(
                                            `✅ Fallback local fair rotation assignment: ${assignedUser}`,
                                        );
                                    }
                                } else if (
                                    (task.fairRotation || isFairRotationType) &&
                                    typeof calculateGlobalOccurrenceNumber ===
                                        "function"
                                ) {
                                    // Tertiary fallback: global occurrence logic
                                    console.log(
                                        `🔄 Using global occurrence fallback for fair rotation: ${task.title}`,
                                    );

                                    // Calculate assignment for first occurrence as fallback
                                    const globalOccurrence =
                                        calculateGlobalOccurrenceNumber(
                                            task,
                                            selectedDate,
                                            0,
                                        );
                                    const userIndex =
                                        (globalOccurrence - 1) %
                                        task.users.length;
                                    const assignedUser = task.users[userIndex];

                                    if (assignedUser) {
                                        if (
                                            window.avatarSystem
                                                ?.generateAvatarHTML
                                        ) {
                                            avatarsHTML +=
                                                window.avatarSystem.generateAvatarHTML(
                                                    assignedUser,
                                                    24,
                                                    "task-avatar",
                                                );
                                        } else {
                                            const initials = assignedUser
                                                .substring(0, 2)
                                                .toUpperCase();
                                            avatarsHTML += `<div class="task-avatar" title="${assignedUser}">${initials}</div>`;
                                        }
                                        console.log(
                                            `✅ Fallback global occurrence assignment: ${assignedUser}`,
                                        );
                                    }
                                } else {
                                    // For regular rotation tasks, show all users as fallback
                                    task.users?.forEach((user) => {
                                        if (
                                            window.avatarSystem
                                                ?.generateAvatarHTML
                                        ) {
                                            avatarsHTML +=
                                                window.avatarSystem.generateAvatarHTML(
                                                    user,
                                                    28,
                                                    "task-avatar",
                                                );
                                        } else {
                                            const initials = user
                                                .substring(0, 2)
                                                .toUpperCase();
                                            avatarsHTML += `<div class="task-avatar" title="${user}">${initials}</div>`;
                                        }
                                    });
                                }
                            }
                        } else {
                            // Individual/Team Work tasks - check for fair rotation first
                            if (
                                task.fairRotation &&
                                window.localFairRotationSystem
                            ) {
                                try {
                                    // Get current assignee for fair rotation tasks
                                    const assignment =
                                        window.localFairRotationSystem.calculateAssignee(
                                            task,
                                            selectedDate,
                                            (task.occurrence || 1) - 1, // Convert to 0-based index
                                        );

                                    if (assignment && assignment.user) {
                                        console.log(
                                            `🔄 Fair rotation assignee for "${task.title}": ${assignment.user}`,
                                        );
                                        avatarsHTML +=
                                            window.avatarSystem.generateAvatarHTML(
                                                assignment.user,
                                                24,
                                                "task-avatar",
                                            );
                                    } else {
                                        // Fallback to showing all users
                                        task.users.forEach((user) => {
                                            avatarsHTML +=
                                                window.avatarSystem.generateAvatarHTML(
                                                    user,
                                                    24,
                                                    "task-avatar",
                                                );
                                        });
                                    }
                                } catch (error) {
                                    console.warn(
                                        `⚠️ Fair rotation assignment failed for "${task.title}":`,
                                        error,
                                    );
                                    // Fallback to showing all users
                                    task.users.forEach((user) => {
                                        avatarsHTML +=
                                            window.avatarSystem.generateAvatarHTML(
                                                user,
                                                24,
                                                "task-avatar",
                                            );
                                    });
                                }
                            } else if (
                                task.fairRotation &&
                                typeof window.getUniversalTaskAssignee ===
                                    "function"
                            ) {
                                try {
                                    // Try universal assignee function for fair rotation
                                    const currentAssignee =
                                        window.getUniversalTaskAssignee(
                                            task,
                                            selectedDate,
                                            (task.occurrence || 1) - 1, // Convert to 0-based index
                                        );

                                    if (currentAssignee) {
                                        console.log(
                                            `🔄 Universal assignee for fair rotation "${task.title}": ${currentAssignee}`,
                                        );
                                        avatarsHTML +=
                                            window.avatarSystem.generateAvatarHTML(
                                                currentAssignee,
                                                24,
                                                "task-avatar",
                                            );
                                    } else {
                                        // Fallback to showing all users
                                        task.users.forEach((user) => {
                                            avatarsHTML +=
                                                window.avatarSystem.generateAvatarHTML(
                                                    user,
                                                    24,
                                                    "task-avatar",
                                                );
                                        });
                                    }
                                } catch (error) {
                                    console.warn(
                                        `⚠️ Universal assignee failed for "${task.title}":`,
                                        error,
                                    );
                                    // Fallback to showing all users
                                    task.users.forEach((user) => {
                                        avatarsHTML +=
                                            window.avatarSystem.generateAvatarHTML(
                                                user,
                                                24,
                                                "task-avatar",
                                            );
                                    });
                                }
                            } else {
                                // Regular tasks - show all assigned users
                                task.users.forEach((user) => {
                                    avatarsHTML +=
                                        window.avatarSystem.generateAvatarHTML(
                                            user,
                                            24,
                                            "task-avatar",
                                        );
                                });
                            }
                        }

                        avatarsHTML += "</div>"; // Close task-avatars-section

                        // Add buzz points on same line
                        const rewardHTML = task.reward
                            ? `<div class="task-reward">${task.reward} <div class="honey-icon">🍯</div></div>`
                            : "";

                        avatarsHTML += rewardHTML;
                        avatarsHTML += "</div>"; // Close task-avatars
                        taskHTML += avatarsHTML;

                        taskDiv.innerHTML =
                            taskHTML + `<div class="delete-btn">Delete</div>`;

                        taskDiv.addEventListener("click", async (e) => {
                            console.log("🔍 DEBUG: Task clicked!", task.title);
                            if (taskDiv.dataset.swiping === "true") {
                                taskDiv.dataset.swiping = "false";
                                return;
                            }

                            if (!e.target.classList.contains("delete-btn")) {
                                // Hold Shift + click to debug completion flow
                                if (e.shiftKey) {
                                    e.preventDefault();
                                    console.log(
                                        "🔍 SHIFT+CLICK DEBUG for task:",
                                        task.title,
                                    );
                                    if (
                                        typeof window.debugCompletionFlow ===
                                        "function"
                                    ) {
                                        window.debugCompletionFlow(task.title);
                                    }
                                    return;
                                }

                                console.log(
                                    "🔍 DEBUG: Fetching latest task data for:",
                                    task.title,
                                );
                                const latest = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                                    { cache: "no-store" },
                                );
                                const latestResult = await latest.json();
                                // Use the original task reference if this is a modified occurrence
                                console.log(
                                    "🔍 DEBUG: Looking for task in response...",
                                );
                                const latestTask =
                                    task.originalTask ||
                                    latestResult.tasks.find(
                                        (t) =>
                                            t.title === task.title &&
                                            t.date === task.date,
                                    );
                                if (latestTask) {
                                    console.log(
                                        "🔍 DEBUG: About to call showTaskDetails with:",
                                        latestTask,
                                    );
                                    console.log(
                                        "🔍 DEBUG: showTaskDetails function exists:",
                                        typeof showTaskDetails === "function",
                                    );
                                    try {
                                        showTaskDetails(latestTask);
                                        console.log(
                                            "✅ DEBUG: showTaskDetails called successfully",
                                        );
                                    } catch (error) {
                                        console.error(
                                            "❌ DEBUG: Error calling showTaskDetails:",
                                            error,
                                        );
                                    }
                                } else {
                                    console.error(
                                        "❌ DEBUG: No latestTask found for:",
                                        task.title,
                                    );
                                }
                            }
                        });

                        taskDiv
                            .querySelector(".delete-btn")
                            .addEventListener("click", async (e) => {
                                e.stopPropagation();

                                // Prevent multiple clicks
                                const deleteBtn = e.target;
                                if (deleteBtn.disabled) {
                                    return;
                                }
                                deleteBtn.disabled = true;
                                const originalText = deleteBtn.textContent;
                                deleteBtn.textContent = "Deleting...";

                                try {
                                    console.log("🗑️ DELETE BUTTON CLICKED:");
                                    console.log("  - Task Title:", task.title);
                                    console.log("  - Task Date:", task.date);
                                    console.log("  - Task Users:", task.users);
                                    console.log(
                                        "  - Task Settings:",
                                        task.settings,
                                    );
                                    console.log(
                                        "  - Task Occurrence:",
                                        task.occurrence,
                                    );
                                    console.log(
                                        "  - Task Total Occurrences:",
                                        task.totalOccurrences,
                                    );
                                    console.log(
                                        "  - Task Repeat:",
                                        task.repeat,
                                    );
                                    console.log(
                                        "  - Task AsNeeded:",
                                        task.asNeeded,
                                    );
                                    console.log("  - Full Task Object:", task);
                                    console.log(
                                        "  - All tasks on this date before delete:",
                                        visibleTasks.map((t) => ({
                                            title: t.title,
                                            repeat: t.repeat,
                                            asNeeded: t.asNeeded,
                                            date: t.date,
                                        })),
                                    );

                                    // Check if multiple tasks have the same date
                                    const tasksWithSameDate =
                                        visibleTasks.filter(
                                            (t) => t.date === task.date,
                                        );
                                    console.log(
                                        "  - Tasks with same date range:",
                                        tasksWithSameDate.map((t) => ({
                                            title: t.title,
                                            date: t.date,
                                        })),
                                    );

                                    // Check if multiple tasks have similar start dates
                                    const taskStartDate = task.date
                                        ? task.date.split(" to ")[0]
                                        : null;
                                    if (taskStartDate) {
                                        const tasksWithSameStartDate =
                                            visibleTasks.filter((t) => {
                                                const tStartDate = t.date
                                                    ? t.date.split(" to ")[0]
                                                    : null;
                                                return (
                                                    tStartDate === taskStartDate
                                                );
                                            });
                                        console.log(
                                            "  - Tasks with same START date (" +
                                                taskStartDate +
                                                "):",
                                            tasksWithSameStartDate.map((t) => ({
                                                title: t.title,
                                                date: t.date,
                                            })),
                                        );
                                    }

                                    // Check for occurrence-based tasks (multiple daily occurrences)
                                    const isOccurrenceTask =
                                        task.occurrence &&
                                        task.totalOccurrences > 1;
                                    const isOccurrenceByTitle =
                                        task.title.includes(" - ") &&
                                        /\d+(st|nd|rd|th)$/.test(
                                            task.title.split(" - ")[1],
                                        );

                                    console.log(
                                        "  - Is Occurrence Task:",
                                        isOccurrenceTask,
                                    );
                                    console.log(
                                        "  - Is Occurrence By Title:",
                                        isOccurrenceByTitle,
                                    );

                                    if (
                                        isOccurrenceTask ||
                                        isOccurrenceByTitle
                                    ) {
                                        // For occurrence tasks, ask if they want to delete all occurrences
                                        const originalTitle =
                                            task.originalTitle ||
                                            task.title.split(" - ")[0];
                                        const deleteAll = confirm(
                                            `This is part of "${originalTitle}" with multiple daily occurrences.\n\nDo you want to delete ALL occurrences of this task?\n\nClick OK to delete ALL occurrences, or Cancel to delete only this specific occurrence.`,
                                        );

                                        if (deleteAll) {
                                            console.log(
                                                "🗑️ User chose: Delete all occurrences for:",
                                                originalTitle,
                                            );
                                            await deleteAllOccurrences(
                                                originalTitle,
                                                task.date,
                                            );
                                        } else {
                                            console.log(
                                                "🗑️ User chose: Delete single occurrence:",
                                                task.title,
                                            );
                                            await deleteTaskFromBackend(
                                                task.title,
                                                task.date,
                                            );
                                        }
                                    } else {
                                        // Regular single task delete
                                        if (
                                            confirm(
                                                `Are you sure you want to delete "${task.title}"?\n\nThis will delete the entire task and affect all past and future occurrences.`,
                                            )
                                        ) {
                                            console.log(
                                                "🗑️ User confirmed: Delete entire task:",
                                                task.title,
                                            );
                                            await deleteTaskFromBackend(
                                                task.title,
                                                task.date,
                                            );
                                        } else {
                                            console.log(
                                                "🗑️ User cancelled deletion",
                                            );
                                        }
                                    }
                                } catch (error) {
                                    console.error(
                                        "🚨 Error during delete process:",
                                        error,
                                    );
                                    alert(
                                        `Delete failed: ${error.message}\n\nPlease try refreshing the page and attempting again.`,
                                    );
                                } finally {
                                    // Re-enable delete button
                                    deleteBtn.disabled = false;
                                    deleteBtn.textContent = originalText;
                                }
                            });

                        taskList.appendChild(taskDiv);
                        enableSwipeToDelete(taskDiv);
                    });
                } catch (error) {
                    console.error("Error loading tasks:", error, {
                        adminEmail,
                        selectedDate,
                    });

                    // Try offline mode with mock data
                    if (
                        error.message.includes("Failed to fetch") ||
                        error.message.includes("CORS")
                    ) {
                        console.log(
                            "🔄 Switching to offline mode with mock data",
                        );
                        loadOfflineMode(selectedDate);
                    } else {
                        // Show detailed error message with retry option
                        const errorHTML = `
                            <div class="error-message" style="text-align: center; padding: 20px; color: #d32f2f;">
                                <h3>⚠️ Unable to Load Tasks</h3>
                                <p><strong>Error:</strong> ${error.message}</p>
                                <div style="margin: 15px 0;">
                                    <p>This might be due to:</p>
                                    <ul style="text-align: left; display: inline-block;">
                                        <li>Server temporarily unavailable</li>
                                        <li>Network connectivity issues</li>
                                        <li>CORS policy restrictions</li>
                                    </ul>
                                </div>
                                <button onclick="loadTasksForDate('${selectedDate}')"
                                        style="background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
                                    🔄 Retry
                                </button>
                                <button onclick="loadOfflineMode('${selectedDate}')"
                                        style="background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
                                    📱 Offline Mode
                                </button>
                                <button onclick="location.reload()"
                                        style="background: #757575; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
                                    🔃 Refresh Page
                                </button>
                            </div>
                        `;

                        document.getElementById("task-list").innerHTML =
                            errorHTML;
                    }
                }
            }

            // Offline mode with mock data
            function loadOfflineMode(selectedDate) {
                console.log("🔄 Loading offline mode for date:", selectedDate);

                const mockTasks = [
                    {
                        title: "Demo Task - Rotation Example",
                        users: ["Linda", "John", "Alice"],
                        settings: ["Rotation"],
                        occurrence: "2025-06-15",
                        currentTurnIndex: 0,
                        reward: 5,
                        dueTime: "09:00",
                        status: "incomplete",
                        completionStatus: "incomplete",
                    },
                    {
                        title: "Demo Task - Team Work Example",
                        users: ["Linda", "John"],
                        settings: ["Team Work"],
                        reward: 10,
                        dueTime: "14:00",
                        status: "incomplete",
                        completionStatus: "incomplete",
                    },
                    {
                        title: "Demo Task - Individual Example",
                        users: ["Linda"],
                        settings: ["Individual"],
                        reward: 3,
                        dueTime: "18:00",
                        status: "incomplete",
                        completionStatus: "incomplete",
                    },
                ];

                // Show offline mode header
                const offlineHeader = `
                    <div style="background: #ff9800; color: white; padding: 10px; text-align: center; margin-bottom: 20px; border-radius: 5px;">
                        📱 <strong>Offline Mode</strong> - Server unavailable. Showing demo tasks.
                        <button onclick="loadTasksForDate('${selectedDate}')"
                                style="background: white; color: #ff9800; border: none; padding: 5px 10px; border-radius: 3px; margin-left: 10px; cursor: pointer;">
                            🔄 Try Online
                        </button>
                    </div>
                `;

                document.getElementById("task-list").innerHTML = offlineHeader;
                const taskList = document.getElementById("task-list");

                // Process mock tasks using existing logic
                mockTasks.forEach((task, index) => {
                    // Create task card using existing styling
                    const taskDiv = document.createElement("div");
                    taskDiv.className = "task-card";
                    taskDiv.dataset.index = index;

                    // Generate status icon
                    const statusIcon =
                        task.completionStatus === "incomplete"
                            ? '<div class="task-status task-status-incomplete">⏳</div>'
                            : '<div class="task-status task-status-complete">✅</div>';

                    // Generate due time
                    const dueTimeHTML = task.dueTime
                        ? `<div class="task-due-time">${task.dueTime}</div>`
                        : "";

                    // Generate occurrence indicator
                    const occurrenceIndicator = task.occurrence
                        ? `<span class="occurrence-indicator" title="Occurrence: ${task.occurrence}">📅</span>`
                        : "";

                    // Generate avatars
                    let avatarsHTML =
                        '<div class="task-avatars"><div class="task-avatars-section">';

                    // Add icons based on task type
                    if (task.settings?.includes("Team Work")) {
                        avatarsHTML += '<div class="team-icon">👥</div>';
                    }
                    if (task.settings?.includes("Rotation")) {
                        avatarsHTML += '<div class="rotation-icon">🔄</div>';
                    }

                    // Add user avatars
                    if (
                        task.settings?.includes("Rotation") &&
                        task.occurrence &&
                        typeof task.currentTurnIndex !== "undefined"
                    ) {
                        // For occurrence tasks, show assigned user
                        const assignedUser = task.users[task.currentTurnIndex];
                        if (assignedUser) {
                            const initials = assignedUser
                                .substring(0, 2)
                                .toUpperCase();
                            avatarsHTML += `<div class="task-avatar" title="${assignedUser}">${initials}</div>`;
                        }
                    } else {
                        // For other tasks, show all users
                        task.users.forEach((user) => {
                            const initials = user.substring(0, 2).toUpperCase();
                            avatarsHTML += `<div class="task-avatar" title="${user}">${initials}</div>`;
                        });
                    }

                    avatarsHTML += "</div>";

                    // Add reward
                    if (task.reward) {
                        avatarsHTML += `<div class="task-reward">🍯 ${task.reward}</div>`;
                    }

                    avatarsHTML += "</div>";

                    // Build task HTML
                    taskDiv.innerHTML = `
                        <div class="task-header">
                            <div class="task-title-row">
                                ${statusIcon}
                                <div class="task-title">${task.title}${occurrenceIndicator}</div>
                                ${dueTimeHTML}
                            </div>
                        </div>
                        ${avatarsHTML}
                    `;

                    // Add click handler for demo
                    taskDiv.addEventListener("click", () => {
                        alert(
                            `Demo Task: ${task.title}\n\nThis is offline mode. Task interactions are limited.\n\nUsers: ${task.users.join(", ")}\nSettings: ${task.settings.join(", ")}\nReward: ${task.reward || 0} 🍯`,
                        );
                    });

                    taskList.appendChild(taskDiv);
                });

                console.log("✅ Offline mode loaded successfully");
            }

            async function showTaskDetails(task) {
                const selectedDate =
                    document.querySelector(".day.selected")?.dataset.date;
                if (!selectedDate) return;

                // Skip fresh data fetching for reconstructed master tasks
                let freshTask = task;
                const userName =
                    localStorage.getItem("currentUser") || "Unknown";
                const adminEmail = localStorage.getItem("currentAdminEmail");

                if (!task._isReconstructedMaster) {
                    // Fetch fresh task data to ensure completion status is current
                    try {
                        const cacheBreaker = `t=${Date.now()}&r=${Math.random()}&bust=${performance.now()}`;
                        const response = await fetch(
                            `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&${cacheBreaker}`,
                            {
                                cache: "no-store",
                                headers: {
                                    "Cache-Control":
                                        "no-cache, no-store, must-revalidate",
                                    Pragma: "no-cache",
                                    Expires: "0",
                                },
                            },
                        );
                        if (response.ok) {
                            const result = await response.json();
                            // Enhanced task matching to handle edited tasks
                            let latestTask = null;

                            // Method 1: Try exact match first
                            latestTask = result.tasks.find(
                                (t) =>
                                    t.title === freshTask.title &&
                                    t.date === freshTask.date,
                            );

                            // Method 2: If task has an ID, try ID-based matching
                            if (!latestTask && freshTask.id) {
                                latestTask = result.tasks.find(
                                    (t) => t.id === freshTask.id,
                                );
                            }

                            // Method 3: For occurrence tasks, try original title matching
                            if (
                                !latestTask &&
                                (freshTask.originalTitle ||
                                    freshTask.occurrence)
                            ) {
                                const originalTitle =
                                    freshTask.originalTitle ||
                                    freshTask.title.split(" - ")[0];
                                latestTask = result.tasks.find(
                                    (t) =>
                                        (t.originalTitle === originalTitle ||
                                            t.title === originalTitle) &&
                                        t.date === freshTask.date,
                                );
                            }

                            // Method 4: Try matching by creation pattern
                            if (!latestTask) {
                                const candidateTasks = result.tasks.filter(
                                    (t) => {
                                        const dateMatch =
                                            t.date === freshTask.date ||
                                            t.date.includes(
                                                freshTask.date.split(" to ")[0],
                                            ) ||
                                            freshTask.date.includes(
                                                t.date.split(" to ")[0],
                                            );
                                        return dateMatch;
                                    },
                                );

                                if (candidateTasks.length === 1) {
                                    latestTask = candidateTasks[0];
                                } else if (candidateTasks.length > 1) {
                                    const originalUsers = freshTask.users || [];
                                    latestTask = candidateTasks.find((t) => {
                                        const taskUsers = t.users || [];
                                        return originalUsers.some((user) =>
                                            taskUsers.includes(user),
                                        );
                                    });
                                }
                            }

                            if (latestTask) {
                                freshTask = latestTask;
                                console.log(
                                    "🔄 Using fresh task data for modal",
                                );
                            }
                        }
                    } catch (error) {
                        console.error("Error fetching fresh task data:", error);
                    }
                } else {
                    console.log(
                        "⚡ Using reconstructed master task without fetching fresh data",
                    );
                }

                // Use freshTask instead of task from here on
                const isRotation = freshTask.settings?.includes("Rotation");
                let turnData;

                if (freshTask._isReconstructedMaster) {
                    // For reconstructed master tasks, don't calculate specific turns
                    turnData = {
                        turns: [],
                        completedCount: 0,
                        requiredTimes: 1,
                    };
                    console.log("⚡ Skipping turn calculation for master task");
                } else if (isRotation) {
                    if (typeof mixedTurnData !== "function") {
                        console.error(
                            `mixedTurnData is not defined for task: ${freshTask.title}`,
                        );
                        turnData = {
                            turns: [],
                            completedCount: 0,
                            requiredTimes: 1,
                        };
                    } else {
                        turnData = mixedTurnData(task, selectedDate);
                    }
                } else {
                    if (typeof individualTurnData !== "function") {
                        console.error(
                            `individualTurnData is not defined for task: ${freshTask.title}`,
                        );
                        turnData = {
                            turns: [],
                            completedCount: 0,
                            requiredTimes: 1,
                        };
                    } else {
                        try {
                            turnData = individualTurnData(task, selectedDate);
                        } catch (error) {
                            console.error(
                                `Error in individualTurnData for task ${freshTask.title}:`,
                                error,
                            );
                            turnData = {
                                turns: [],
                                completedCount: 0,
                                requiredTimes: 1,
                            };
                        }
                    }
                }

                const userTurns = turnData.turns.filter(
                    (turn) => turn.user === userName,
                );
                const userTotal = userTurns.reduce(
                    (sum, turn) =>
                        sum + (turn.isCompleted || turn.isPending ? 1 : 0),
                    0,
                );
                const userRequiredTimes = isRotation
                    ? userTurns.length
                    : turnData.requiredTimes;

                // Determine task status and symbol
                let statusSymbol = "";
                let isOverdue = false;
                let isPending = false;
                let isApproved = false;

                // Check if task is overdue
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();
                const currentDate = new Date().toLocaleDateString("sv-SE");

                if (selectedDate === currentDate) {
                    if (freshTask.dueTimes && freshTask.dueTimes.length > 0) {
                        // Tasks with specific due times - check if any due time has passed
                        for (const timeStr of freshTask.dueTimes) {
                            const [hours, minutes] = timeStr
                                .split(":")
                                .map(Number);
                            const dueTime = hours * 60 + minutes;
                            if (currentTime > dueTime) {
                                isOverdue = true;
                                break;
                            }
                        }
                    } else {
                        // Tasks without due times - overdue after midnight if not completed
                        const hasCompletions = turnData.completedCount > 0;
                        if (!hasCompletions && currentTime > 0) {
                            // It's past midnight and task is not completed
                            isOverdue = true;
                        }
                    }
                } else if (selectedDate < currentDate) {
                    // Task is from a previous date and not completed
                    const hasCompletions = turnData.completedCount > 0;
                    if (!hasCompletions) {
                        isOverdue = true;
                    }
                }

                // Check completion status using proper completion data
                const hasCompletions = turnData.completedCount > 0;
                if (hasCompletions && freshTask.parentApproval === true) {
                    // Check pending and approved users using same logic as main code
                    const pendingUsers = [];
                    const approvedUsers = [];

                    // Check ALL completions (including cross-completions)
                    const allCompletions = [];

                    // Get all completions from completedDates format
                    if (
                        freshTask.completedDates &&
                        freshTask.completedDates[selectedDate]
                    ) {
                        allCompletions.push(
                            ...freshTask.completedDates[selectedDate],
                        );
                    }
                    // Fallback to completions format
                    else if (
                        freshTask.completions &&
                        freshTask.completions[selectedDate]
                    ) {
                        allCompletions.push(
                            ...freshTask.completions[selectedDate].filter(
                                (c) => c.isCompleted || !c.isPending,
                            ),
                        );
                    }

                    // Update isPending status from completions data
                    if (
                        freshTask.completions &&
                        freshTask.completions[selectedDate]
                    ) {
                        const completionsData =
                            freshTask.completions[selectedDate];
                        allCompletions.forEach((completion) => {
                            const matchingCompletion = completionsData.find(
                                (c) => c.user === completion.user,
                            );
                            if (matchingCompletion) {
                                completion.isPending =
                                    matchingCompletion.isPending;
                            }
                        });
                    }

                    // Process all completions
                    allCompletions.forEach((completion) => {
                        const user = completion.user;
                        if (completion.isPending === true) {
                            if (!pendingUsers.includes(user)) {
                                pendingUsers.push(user);
                            }
                        } else {
                            if (!approvedUsers.includes(user)) {
                                approvedUsers.push(user);
                            }
                        }
                    });

                    if (pendingUsers.length > 0 && approvedUsers.length === 0) {
                        isPending = true;
                    } else if (approvedUsers.length > 0) {
                        isApproved = true;
                    }
                } else if (hasCompletions) {
                    // Non-approval tasks are approved when completed
                    isApproved = true;
                }

                // Set status symbol
                if (isOverdue) {
                    statusSymbol =
                        ' <span style="display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; width: 20px; height: 20px; border-radius: 50%; background: #d32f2f; color: white; font-size: 14px; font-weight: bold;">!</span>';
                } else if (isPending) {
                    statusSymbol =
                        ' <span style="display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; width: 20px; height: 20px; border-radius: 50%; background: var(--primary-color);"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6,2V8H6V8L10,12L6,16V16H6V22H18V16H18V16L14,12L18,8V8H18V2H6M16,16.5V20H8V16.5L12,12.5L16,16.5M12,11.5L8,7.5V4H16V7.5L12,11.5Z" fill="white"/></svg></span>';
                } else if (isApproved) {
                    statusSymbol =
                        ' <span style="display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; width: 20px; height: 20px; border-radius: 50%; background: #28a745; color: white; font-size: 14px; font-weight: bold;">✓</span>';
                }

                let modalHTML = `<h2>${freshTask.title}${statusSymbol}</h2>`;

                // Variables needed for admin buttons (declared early to fix initialization order)
                const currentUser = localStorage.getItem("currentUser");
                const currentUserEmail =
                    localStorage.getItem("currentUserEmail") || adminEmail;
                const isParent = currentUserEmail === adminEmail;
                const canComplete =
                    !freshTask.asNeeded &&
                    freshTask.users &&
                    freshTask.users.length > 0;
                const completedUsersForButton = Array.isArray(
                    freshTask.completions?.[selectedDate],
                )
                    ? freshTask.completions[selectedDate]
                    : [];
                const pendingUsersForButton = completedUsersForButton.filter(
                    (c) => c.isPending,
                );
                const approvedUsersForButton = completedUsersForButton.filter(
                    (c) => !c.isPending,
                );
                const isTaskComplete =
                    approvedUsersForButton.length > 0 ||
                    pendingUsersForButton.length > 0;

                // Check if this is an occurrence task and add master task button
                if (
                    freshTask.originalTitle &&
                    freshTask.occurrence &&
                    freshTask.totalOccurrences
                ) {
                    // Store the task data globally for the View Full Task button
                    window.currentOccurrenceTask = freshTask;

                    modalHTML += `<div style="border-bottom: 1px solid var(--primary-color); padding: 3px 0; margin-bottom: 6px; font-size: 12px; line-height: 1;">`;
                    modalHTML += `<strong style="margin: 0; padding: 0; line-height: 1;">This is occurrence ${freshTask.occurrence} of ${freshTask.totalOccurrences}</strong> `;
                    modalHTML += `<button type="button" onclick="showMasterTaskDetails('${freshTask.originalTitle}', '${selectedDate}')" style="
                                            margin-left: 8px;
                                            padding: 8px 16px;
                                            background: #ffc107;
                                            color: #212121;
                                            border: none;
                                            border-radius: 6px;
                                            font-size: 14px;
                                            font-weight: 600;
                                            cursor: pointer;
                                            transition: all 0.2s;
                                            vertical-align: middle;
                                        " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                                            View Full Task
                                        </button>`;
                    modalHTML += `</div>`;
                }

                modalHTML += `
                <div style="margin-top: 10px; margin-bottom: 15px; padding: 10px 0; border-bottom: 1px solid #FBB740;">
                    <!-- Compact Single Line Button Layout -->
                    <div style="display: flex; gap: 8px; justify-content: center; align-items: center; flex-wrap: wrap;">
                        ${
                            canComplete && !isTaskComplete
                                ? `<button id="completeTaskBtn" style="padding: 8px 16px; background: #28a745; color: white; font-weight: 600; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; white-space: nowrap;">✓ Done</button>`
                                : ""
                        }

                        <div style="position: relative;">
                            <button id="editDropdownBtn" style="padding: 8px 16px; background: #FBB740; color: #5D4E41; font-weight: 600; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                                Edit
                                <span style="font-size: 10px;">▼</span>
                            </button>
                            <div id="editDropdown" style="display: none; position: absolute; top: 100%; left: 0; min-width: 140px; background: white; border: 2px solid #FBB740; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1001; margin-top: 3px;">
                                <button id="editOccurrenceBtn" style="width: 100%; padding: 10px 12px; background: none; border: none; color: #5D4E41; cursor: pointer; font-size: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; font-weight: 500;" onmouseover="this.style.background='#FFF6E9'" onmouseout="this.style.background='none'">
                                    This Day
                                </button>
                                <button id="editFutureBtn" style="width: 100%; padding: 10px 12px; background: none; border: none; color: #5D4E41; cursor: pointer; font-size: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; font-weight: 500;" onmouseover="this.style.background='#FFF6E9'" onmouseout="this.style.background='none'">
                                    Future
                                </button>
                                <button id="editTaskBtn" style="width: 100%; padding: 10px 12px; background: none; border: none; color: #5D4E41; cursor: pointer; font-size: 12px; text-align: left; font-weight: 500;" onmouseover="this.style.background='#FFF6E9'" onmouseout="this.style.background='none'">
                                    Entire Task
                                </button>
                            </div>
                        </div>

                        <div style="position: relative;">
                            <button id="deleteDropdownBtn" style="padding: 8px 16px; background: #D32F2F; color: white; font-weight: 600; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                                Delete
                                <span style="font-size: 10px;">▼</span>
                            </button>
                            <div id="deleteDropdown" style="display: none; position: absolute; top: 100%; left: 0; min-width: 140px; background: white; border: 2px solid #D32F2F; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1001; margin-top: 3px;">
                                <button id="deleteOccurrenceBtn" style="width: 100%; padding: 10px 12px; background: none; border: none; color: #D32F2F; cursor: pointer; font-size: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; font-weight: 500;" onmouseover="this.style.background='#ffe6e6'" onmouseout="this.style.background='none'">
                                    This Day
                                </button>
                                <button id="deleteFutureBtn" style="width: 100%; padding: 10px 12px; background: none; border: none; color: #D32F2F; cursor: pointer; font-size: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; font-weight: 500;" onmouseover="this.style.background='#ffe6e6'" onmouseout="this.style.background='none'">
                                    Future
                                </button>
                                <button id="deleteEntireTaskBtn" style="width: 100%; padding: 10px 12px; background: none; border: none; color: #D32F2F; cursor: pointer; font-size: 12px; text-align: left; font-weight: 500;" onmouseover="this.style.background='#ffe6e6'" onmouseout="this.style.background='none'">
                                    Entire Task
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                // Buzz Points
                modalHTML += `<div class="task-info-row"><strong>Buzz Points:</strong> ${freshTask.reward || 0} 🍯</div>`;

                // Status (simple)
                let statusDisplay = "";
                if (isOverdue && !isApproved && !isPending) {
                    statusDisplay = "Overdue";
                } else if (isApproved) {
                    statusDisplay = "Approved";
                } else if (isPending) {
                    statusDisplay = "Pending";
                } else {
                    statusDisplay = "Active";
                }
                modalHTML += `<div class="task-info-row"><strong>Status:</strong> ${statusDisplay}</div>`;

                // Completion Details (separate section)
                let completionTime = "";
                let completerUser = "";

                if (
                    (isApproved || isPending) &&
                    freshTask.completedDates &&
                    freshTask.completedDates[selectedDate] &&
                    freshTask.completedDates[selectedDate].length > 0
                ) {
                    const latestCompletion =
                        freshTask.completedDates[selectedDate][
                            freshTask.completedDates[selectedDate].length - 1
                        ];
                    if (latestCompletion.completedAt) {
                        const completedTimeObj = new Date(
                            latestCompletion.completedAt,
                        );
                        completionTime = completedTimeObj.toLocaleTimeString(
                            "en-US",
                            {
                                hour: "2-digit",
                                minute: "2-digit",
                                hour12: true,
                            },
                        );
                        completerUser = latestCompletion.user;
                    }
                }

                if (completionTime && completerUser) {
                    let avatarHTML = "";
                    if (
                        window.avatarSystem &&
                        typeof window.avatarSystem.generateAvatarHTML ===
                            "function"
                    ) {
                        avatarHTML = window.avatarSystem.generateAvatarHTML(
                            completerUser,
                            24,
                            "completer-avatar",
                            "",
                        );
                    }
                    modalHTML += `<div class="task-info-row"><strong>Completion Details:</strong> ${completionTime} by ${avatarHTML}</div>`;
                }

                // Notes (if present)
                if (freshTask.notes) {
                    modalHTML += `<div class="task-info-row"><strong>Notes:</strong> ${freshTask.notes}</div>`;
                }

                // Room (if present)
                if (freshTask.room) {
                    modalHTML += `<div class="task-info-row"><strong>Room:</strong> ${freshTask.room}</div>`;
                }

                // Frequency (simple)
                let frequencyDisplay = freshTask.repeat || "Daily";
                modalHTML += `<div class="task-info-row"><strong>Frequency:</strong> ${frequencyDisplay}</div>`;

                // Additional Settings (when applicable)
                if (freshTask.repeat && freshTask.repeat !== "One time") {
                    let additionalSettings = [];

                    if (freshTask.repeat === "Daily") {
                        // Check for times per day
                        if (
                            freshTask.timesPerDay &&
                            freshTask.timesPerDay > 1
                        ) {
                            additionalSettings.push(
                                `${freshTask.timesPerDay} times per day`,
                            );
                        }
                        // Check for specific days of week
                        if (
                            freshTask.daysOfWeek &&
                            freshTask.daysOfWeek.length > 0
                        ) {
                            if (
                                freshTask.daysOfWeek.includes("All") ||
                                freshTask.daysOfWeek.length === 7
                            ) {
                                additionalSettings.push("All days");
                            } else if (!freshTask.daysOfWeek.includes("Any")) {
                                // Filter out day names that are actually day names
                                const validDays = freshTask.daysOfWeek.filter(
                                    (day) =>
                                        typeof day === "string" &&
                                        [
                                            "Monday",
                                            "Tuesday",
                                            "Wednesday",
                                            "Thursday",
                                            "Friday",
                                            "Saturday",
                                            "Sunday",
                                        ].includes(day),
                                );
                                if (validDays.length > 0) {
                                    const shortDays = validDays.map((day) =>
                                        day.substring(0, 3),
                                    );
                                    additionalSettings.push(
                                        shortDays.join(", "),
                                    );
                                }
                            }
                        }
                    } else if (freshTask.repeat === "Weekly") {
                        // Check for times per week
                        if (
                            freshTask.timesPerWeek &&
                            freshTask.timesPerWeek > 1
                        ) {
                            additionalSettings.push(
                                `${freshTask.timesPerWeek} times per week`,
                            );
                        }
                        // Check for specific days of week
                        if (
                            freshTask.daysOfWeek &&
                            freshTask.daysOfWeek.length > 0
                        ) {
                            if (!freshTask.daysOfWeek.includes("Any")) {
                                const validDays = freshTask.daysOfWeek.filter(
                                    (day) =>
                                        typeof day === "string" &&
                                        [
                                            "Monday",
                                            "Tuesday",
                                            "Wednesday",
                                            "Thursday",
                                            "Friday",
                                            "Saturday",
                                            "Sunday",
                                        ].includes(day),
                                );
                                if (validDays.length > 0) {
                                    const shortDays = validDays.map((day) =>
                                        day.substring(0, 3),
                                    );
                                    additionalSettings.push(
                                        shortDays.join(", "),
                                    );
                                }
                            }
                        }
                    } else if (freshTask.repeat === "Monthly") {
                        // Handle new monthly options structure
                        if (freshTask.monthlyOption === "times") {
                            // Check for times per month
                            if (
                                freshTask.timesPerMonth &&
                                freshTask.timesPerMonth > 1
                            ) {
                                additionalSettings.push(
                                    `${freshTask.timesPerMonth} times per month`,
                                );
                            }

                            // Handle specific days of the month
                            if (
                                freshTask.monthlySchedulingType ===
                                    "daysOfMonth" &&
                                freshTask.monthlyDaysOfMonth
                            ) {
                                const days =
                                    freshTask.monthlyDaysOfMonth.split(",");
                                const dayNames = days.map((day) => {
                                    if (day === "last") return "Last";
                                    const num = parseInt(day);
                                    if (num === 1) return "1st";
                                    if (num === 2) return "2nd";
                                    if (num === 3) return "3rd";
                                    if (num === 21) return "21st";
                                    if (num === 22) return "22nd";
                                    if (num === 23) return "23rd";
                                    if (num === 31) return "31st";
                                    return `${num}th`;
                                });
                                additionalSettings.push(
                                    `Days: ${dayNames.join(", ")}`,
                                );
                            }

                            // Handle specific days of the week patterns
                            if (
                                freshTask.monthlySchedulingType ===
                                    "daysOfWeek" &&
                                freshTask.monthlyDaysOfWeek
                            ) {
                                const patterns =
                                    freshTask.monthlyDaysOfWeek.split(",");
                                const patternNames = patterns.map((pattern) => {
                                    const [occurrence, weekday] =
                                        pattern.split(":");
                                    const occurrenceNames = {
                                        1: "1st",
                                        2: "2nd",
                                        3: "3rd",
                                        4: "4th",
                                        last: "Last",
                                    };
                                    return `${occurrenceNames[occurrence]} ${weekday}`;
                                });
                                additionalSettings.push(
                                    `Patterns: ${patternNames.join(", ")}`,
                                );
                            }
                        } else if (freshTask.monthlyOption === "interval") {
                            const interval = freshTask.monthInterval || 1;
                            additionalSettings.push(
                                interval === 1
                                    ? "Every month"
                                    : `Every ${interval} months`,
                            );
                        }
                        // Legacy support for old format
                        else if (freshTask.monthlyOption === "specific") {
                            additionalSettings.push(
                                `Day ${freshTask.monthlyDay}`,
                            );
                        } else if (
                            freshTask.monthlyOption === "pattern" &&
                            freshTask.monthlyWeek &&
                            freshTask.monthlyWeekday
                        ) {
                            const weekNames = [
                                "First",
                                "Second",
                                "Third",
                                "Fourth",
                                "Last",
                            ];
                            const dayNames = [
                                "Sun",
                                "Mon",
                                "Tue",
                                "Wed",
                                "Thu",
                                "Fri",
                                "Sat",
                            ];
                            additionalSettings.push(
                                `${weekNames[freshTask.monthlyWeek - 1]} ${dayNames[freshTask.monthlyWeekday]}`,
                            );
                        }
                    }

                    if (additionalSettings.length > 0) {
                        modalHTML += `<div class="task-info-row"><strong>Additional Settings:</strong> ${additionalSettings.join(", ")}</div>`;
                    }
                }

                // Date
                const [fromDate, toDate] = (freshTask.date || "").split(" to ");
                let dateDisplay = "";
                if (freshTask.repeat === "Occasional") {
                    dateDisplay = "No fixed date";
                } else if (!fromDate) {
                    dateDisplay = "Unknown";
                } else if (
                    !toDate ||
                    toDate === "3000-01-01" ||
                    toDate === fromDate
                ) {
                    dateDisplay = fromDate;
                } else {
                    dateDisplay = `From ${fromDate} to ${toDate}`;
                }
                modalHTML += `<div class="task-info-row"><strong>Date:</strong> ${dateDisplay}</div>`;

                // Due Time
                if (freshTask.dueTimes && freshTask.dueTimes.length > 0) {
                    modalHTML += `<div class="task-info-row"><strong>Due Time:</strong> ${freshTask.dueTimes.join(", ")}</div>`;
                }

                // Setting
                let settingDisplay = "Individual";
                if (freshTask.settings?.includes("Rotation")) {
                    settingDisplay = "Rotational";
                } else if (freshTask.settings?.includes("Teamwork")) {
                    settingDisplay = "Teamwork";
                }
                modalHTML += `<div class="task-info-row"><strong>Setting:</strong> ${settingDisplay}</div>`;

                // Additional Details for Rotational
                if (freshTask.settings?.includes("Rotation")) {
                    let rotationDetails = [];
                    if (freshTask.fairRotation) {
                        rotationDetails.push("Fair Task Rotation");
                    }
                    if (rotationDetails.length > 0) {
                        modalHTML += `<div class="task-info-row"><strong>Additional Details:</strong> ${rotationDetails.join(", ")}</div>`;
                    }
                }

                // Assigned To (avatars only)
                console.log("🔍 DEBUG: freshTask.users:", freshTask.users);
                console.log(
                    "🔍 DEBUG: freshTask.settings:",
                    freshTask.settings,
                );
                console.log(
                    "🔍 DEBUG: freshTask._isReconstructedMaster:",
                    freshTask._isReconstructedMaster,
                );
                console.log("🔍 DEBUG: freshTask.title:", freshTask.title);

                let assignedDisplay = "";
                if (freshTask.settings?.includes("Teamwork")) {
                    // For teamwork, list all avatars
                    freshTask.users.forEach((user) => {
                        if (
                            window.avatarSystem &&
                            typeof window.avatarSystem.generateAvatarHTML ===
                                "function"
                        ) {
                            assignedDisplay +=
                                window.avatarSystem.generateAvatarHTML(
                                    user,
                                    24,
                                    "assigned-avatar",
                                    "margin-right: 2px;",
                                );
                        }
                    });
                } else if (freshTask.settings?.includes("Rotation")) {
                    // For rotation tasks
                    if (freshTask._isReconstructedMaster) {
                        // For master task view: show all users in rotation order
                        const rotationUsers =
                            freshTask.rotationOrder || freshTask.users || [];
                        console.log(
                            "🔄 Showing all users for master rotation task:",
                            rotationUsers,
                        );
                        console.log(
                            "🔍 DEBUG: users array length:",
                            freshTask.users?.length,
                        );
                        console.log(
                            "🔍 DEBUG: rotationOrder from task:",
                            freshTask.rotationOrder,
                        );
                        console.log(
                            "🔍 DEBUG: all task properties:",
                            Object.keys(freshTask),
                        );
                        rotationUsers.forEach((user, index) => {
                            if (
                                window.avatarSystem &&
                                typeof window.avatarSystem
                                    .generateAvatarHTML === "function"
                            ) {
                                // First user gets special styling to indicate rotation starts with them
                                const styling =
                                    index === 0
                                        ? "margin-right: 2px; border: 2px solid var(--primary-color);"
                                        : "margin-right: 2px;";
                                const className =
                                    index === 0
                                        ? "rotation-start-avatar"
                                        : "rotation-avatar";

                                assignedDisplay +=
                                    window.avatarSystem.generateAvatarHTML(
                                        user,
                                        24,
                                        className,
                                        styling,
                                    );
                            }
                        });
                    } else {
                        // For occurrence task view: show actual rotation order from current occurrence forward
                        const actualRotationOrder =
                            await getActualRotationOrder(
                                freshTask,
                                selectedDate,
                            );
                        console.log(
                            "🔄 Actual rotation order for occurrence:",
                            actualRotationOrder,
                        );

                        actualRotationOrder.forEach((user, index) => {
                            if (
                                window.avatarSystem &&
                                typeof window.avatarSystem
                                    .generateAvatarHTML === "function"
                            ) {
                                // First user (current) gets special styling
                                const styling =
                                    index === 0
                                        ? "margin-right: 2px; border: 2px solid var(--primary-color);"
                                        : "margin-right: 2px;";
                                const className =
                                    index === 0
                                        ? "current-avatar"
                                        : "rotation-avatar";

                                assignedDisplay +=
                                    window.avatarSystem.generateAvatarHTML(
                                        user,
                                        24,
                                        className,
                                        styling,
                                    );
                            }
                        });
                    }
                } else {
                    // For individual, list all assigned users
                    freshTask.users.forEach((user) => {
                        if (
                            window.avatarSystem &&
                            typeof window.avatarSystem.generateAvatarHTML ===
                                "function"
                        ) {
                            assignedDisplay +=
                                window.avatarSystem.generateAvatarHTML(
                                    user,
                                    24,
                                    "assigned-avatar",
                                    "margin-right: 2px;",
                                );
                        }
                    });
                }
                modalHTML += `<div class="task-info-row"><strong>Assigned To:</strong> <div class="avatar-container" style="display: inline-flex; flex-wrap: wrap; align-items: center; gap: 2px; max-width: calc(100% - 120px);">${assignedDisplay}</div></div>`;

                // Reassigned To (if applicable)
                let reassignedUser = null;
                if (
                    freshTask.tempTurnReplacement &&
                    freshTask.tempTurnReplacement[selectedDate]
                ) {
                    const replacements =
                        freshTask.tempTurnReplacement[selectedDate];
                    for (const [index, replacementUser] of Object.entries(
                        replacements,
                    )) {
                        if (
                            freshTask.users &&
                            freshTask.users[parseInt(index)]
                        ) {
                            reassignedUser = replacementUser;
                            break;
                        }
                    }
                }

                if (reassignedUser) {
                    let reassignedAvatar = "";
                    if (
                        window.avatarSystem &&
                        typeof window.avatarSystem.generateAvatarHTML ===
                            "function"
                    ) {
                        reassignedAvatar =
                            window.avatarSystem.generateAvatarHTML(
                                reassignedUser,
                                24,
                                "reassigned-avatar",
                                "",
                            );
                    }
                    modalHTML += `<div class="task-info-row"><strong>Reassigned To:</strong><div class="avatar-container">${reassignedAvatar}</div></div>`;
                }

                // Parental Approval
                const approvalDisplay =
                    freshTask.parentApproval === true ? "Yes" : "No";
                modalHTML += `<div class="task-info-row"><strong>Parental Approval:</strong> ${approvalDisplay}</div>`;

                // On-time Completion
                const onTimeDisplay =
                    freshTask.onTimeCompletion === true ? "Yes" : "No";
                modalHTML += `<div class="task-info-row"><strong>On-time Completion:</strong> ${onTimeDisplay}</div>`;

                // Privacy Status
                const privacyDisplay =
                    freshTask.isPrivate === true
                        ? "Private"
                        : "Visible to all users";
                modalHTML += `<div class="task-info-row"><strong>Privacy Status:</strong> ${privacyDisplay}</div>`;

                // ADMIN BUTTONS SECTION - START
                // Check if task can be completed - anyone can complete any task

                // Admin buttons section (add to modal HTML)

                // ADMIN BUTTONS SECTION - END

                console.log("🔍 DEBUG: Creating modal element...");
                const modal = document.createElement("div");
                console.log("🔍 DEBUG: Modal element created:", modal);
                modal.className = "task-modal";
                modal.innerHTML = `<div class="modal-content">${modalHTML}</div>`;
                console.log(
                    "🔍 DEBUG: Modal HTML set, content length:",
                    modal.innerHTML.length,
                );
                console.log(
                    "🔍 DEBUG: Modal HTML preview:",
                    modal.innerHTML.substring(0, 200) + "...",
                );
                console.log("🔍 DEBUG: Appending modal to document.body...");
                document.body.appendChild(modal);
                console.log("🔍 DEBUG: Modal appended to body");
                console.log(
                    "🔍 DEBUG: Modal in DOM:",
                    document.body.contains(modal),
                );
                console.log(
                    "🔍 DEBUG: Modal display style:",
                    window.getComputedStyle(modal).display,
                );
                console.log(
                    "🔍 DEBUG: Modal visibility:",
                    window.getComputedStyle(modal).visibility,
                );
                console.log(
                    "🔍 DEBUG: Modal opacity:",
                    window.getComputedStyle(modal).opacity,
                );
                console.log(
                    "🔍 DEBUG: Modal z-index:",
                    window.getComputedStyle(modal).zIndex,
                );

                // Dropdown functionality for Edit/Delete buttons
                const editDropdownBtn = modal.querySelector("#editDropdownBtn");
                const editDropdown = modal.querySelector("#editDropdown");
                const deleteDropdownBtn =
                    modal.querySelector("#deleteDropdownBtn");
                const deleteDropdown = modal.querySelector("#deleteDropdown");

                if (editDropdownBtn && editDropdown) {
                    editDropdownBtn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        editDropdown.style.display =
                            editDropdown.style.display === "none"
                                ? "block"
                                : "none";
                        deleteDropdown.style.display = "none"; // Close other dropdown
                    });
                }

                if (deleteDropdownBtn && deleteDropdown) {
                    deleteDropdownBtn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        deleteDropdown.style.display =
                            deleteDropdown.style.display === "none"
                                ? "block"
                                : "none";
                        editDropdown.style.display = "none"; // Close other dropdown
                    });
                }

                // Close dropdowns when clicking outside
                modal.addEventListener("click", (e) => {
                    if (
                        !e.target.closest("#editDropdownBtn") &&
                        !e.target.closest("#editDropdown")
                    ) {
                        editDropdown.style.display = "none";
                    }
                    if (
                        !e.target.closest("#deleteDropdownBtn") &&
                        !e.target.closest("#deleteDropdown")
                    ) {
                        deleteDropdown.style.display = "none";
                    }

                    if (e.target.classList.contains("task-modal")) {
                        modal.remove();
                    }
                });

                // Complete task button logic (preserved from original tasks.html)
                const completeBtn = modal.querySelector("#completeTaskBtn");
                if (completeBtn) {
                    completeBtn.addEventListener("click", async () => {
                        if (completeBtn.disabled) return;
                        completeBtn.disabled = true;
                        const originalText = completeBtn.innerHTML;
                        completeBtn.innerHTML = "⏳ Processing...";

                        try {
                            // First, refresh task data to get latest completion status
                            try {
                                const response = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                                    { cache: "no-store" },
                                );
                                if (response.ok) {
                                    const result = await response.json();
                                    const latestTask = result.tasks.find(
                                        (t) =>
                                            t.title === task.title &&
                                            t.date === task.date,
                                    );
                                    if (latestTask) {
                                        const latestCompletedUsers =
                                            Array.isArray(
                                                latestTask.completions?.[
                                                    selectedDate
                                                ],
                                            )
                                                ? latestTask.completions[
                                                      selectedDate
                                                  ]
                                                : [];
                                        const latestApprovedUsers =
                                            latestCompletedUsers.filter(
                                                (c) => !c.isPending,
                                            );

                                        if (latestApprovedUsers.length > 0) {
                                            alert(
                                                "This task has already been completed!",
                                            );
                                            modal.remove();
                                            const selectedDateElement =
                                                document.querySelector(
                                                    ".day.selected",
                                                );
                                            const currentSelectedDate =
                                                selectedDateElement
                                                    ? selectedDateElement
                                                          .dataset.date
                                                    : new Date()
                                                          .toISOString()
                                                          .split("T")[0];
                                            loadTasksForDate(
                                                currentSelectedDate,
                                            );
                                            return;
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error(
                                    "Error refreshing task data:",
                                    error,
                                );
                            }
                            const currentUserEmail =
                                localStorage.getItem("currentUserEmail") ||
                                adminEmail;
                            const isParent = currentUserEmail === adminEmail;

                            if (isParent) {
                                await showUserSelectionModal(
                                    freshTask,
                                    selectedDate,
                                    modal,
                                );
                            } else {
                                await completeTaskForUser(
                                    freshTask,
                                    selectedDate,
                                    currentUser,
                                    modal,
                                );
                            }
                        } catch (error) {
                            console.error("Error in task completion:", error);
                            alert(`Failed to complete task: ${error.message}`);
                        } finally {
                            completeBtn.disabled = false;
                            completeBtn.innerHTML = originalText;
                        }
                    });
                }

                // Get all family users
                async function getAllFamilyUsers() {
                    try {
                        const adminEmail =
                            localStorage.getItem("currentAdminEmail");
                        const response = await fetch(
                            `https://beemazing1.onrender.com/api/users?adminEmail=${encodeURIComponent(adminEmail)}`,
                        );
                        if (response.ok) {
                            const result = await response.json();
                            return result.users || [];
                        }
                    } catch (error) {
                        console.error("Error fetching family users:", error);
                    }
                    return [];
                }

                // User selection modal for task completion
                async function showUserSelectionModal(
                    task,
                    selectedDate,
                    parentModal,
                ) {
                    const userModal = document.createElement("div");
                    userModal.className = "task-modal";
                    userModal.style.zIndex = "1001";

                    const allUsers = await getAllFamilyUsers();
                    const usersToShow =
                        allUsers.length > 0 ? allUsers : task.users;

                    let userOptionsHtml = "";
                    usersToShow.forEach((user) => {
                        const isAssigned = task.users.includes(user);
                        const buttonStyle = isAssigned
                            ? "background: #FFF6E9; border: 2px solid #FBB740;"
                            : "background: #f8f9fa; border: 2px solid #e4e3e0;";

                        userOptionsHtml += `
                                    <button class="user-option-btn" data-user="${user}" style="
                                        display: block;
                                        width: 100%;
                                        padding: 12px;
                                        margin: 8px 0;
                                        ${buttonStyle}
                                        border-radius: 8px;
                                        color: #5D4E41;
                                        font-weight: 500;
                                        cursor: pointer;
                                        text-align: center;
                                        transition: all 0.2s ease;
                                    " onmouseover="this.style.background='#FBB740'; this.style.color='white';" onmouseout="this.style.background='${isAssigned ? "#FFF6E9" : "#f8f9fa"}'; this.style.color='#5D4E41';">
                                        ${user} ${isAssigned ? "(assigned)" : "(helped out)"}
                                    </button>
                                `;
                    });

                    userModal.innerHTML = `
                                <div class="modal-content">
                                    <h2>Who completed this task?</h2>
                                    <div style="margin: 15px 0; padding: 10px; background: #FFF6E9; border-radius: 6px; font-size: 13px; color: #5D4E41;">
                                        💡 The buzz points will go to whoever you select
                                    </div>
                                    <div style="margin: 20px 0;">
                                        ${userOptionsHtml}
                                    </div>
                                    <div style="text-align: center; margin-top: 20px;">
                                        <button id="cancelUserSelection" style="padding: 8px 16px; background: #e4e3e0; color: #5D4E41; font-weight: 500; border-radius: 6px; border: none; cursor: pointer;">Cancel</button>
                                    </div>
                                </div>
                            `;

                    document.body.appendChild(userModal);

                    userModal
                        .querySelectorAll(".user-option-btn")
                        .forEach((btn) => {
                            btn.addEventListener("click", async () => {
                                if (btn.disabled) return;
                                btn.disabled = true;
                                const originalText = btn.textContent;
                                btn.textContent = "Processing...";

                                try {
                                    const selectedUser = btn.dataset.user;
                                    userModal.remove();
                                    await completeTaskForUser(
                                        task,
                                        selectedDate,
                                        selectedUser,
                                        parentModal,
                                    );
                                } catch (error) {
                                    console.error(
                                        "Error in user selection:",
                                        error,
                                    );
                                    btn.disabled = false;
                                    btn.textContent = originalText;
                                    alert(
                                        `Failed to complete task: ${error.message}`,
                                    );
                                }
                            });
                        });

                    document
                        .getElementById("cancelUserSelection")
                        .addEventListener("click", () => {
                            userModal.remove();
                        });

                    userModal.addEventListener("click", (e) => {
                        if (e.target.classList.contains("task-modal")) {
                            userModal.remove();
                        }
                    });
                }

                // Complete task for specific user
                async function completeTaskForUser(
                    task,
                    selectedDate,
                    userName,
                    modal,
                ) {
                    const adminEmail =
                        localStorage.getItem("currentAdminEmail");

                    try {
                        const requestBody = {
                            adminEmail: adminEmail,
                            taskTitle: task.title,
                            user: userName,
                            date: selectedDate,
                            parentApproval: task.parentApproval,
                            taskUsers: task.users,
                        };

                        const response = await fetch(
                            "https://beemazing1.onrender.com/api/complete-task",
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(requestBody),
                            },
                        );

                        if (!response.ok) {
                            const errorData = await response
                                .json()
                                .catch(() => ({
                                    error: `HTTP error ${response.status}`,
                                }));
                            throw new Error(
                                `Failed to complete task: ${errorData.error || response.statusText}`,
                            );
                        }

                        const result = await response.json();
                        console.log("✅ Task completed successfully:", result);

                        // Trigger both local and server-based fair rotation recalculation
                        if (task.fairRotation) {
                            // Use local fair rotation system for immediate updates
                            if (window.onLocalFairRotationTaskCompleted) {
                                console.log(
                                    `🔄 Triggering local fair rotation recalculation for task: ${task.title}`,
                                );

                                // Determine occurrence index for this specific task
                                let occurrenceIndex = 0;
                                if (task.occurrence && task.totalOccurrences) {
                                    occurrenceIndex = task.occurrence - 1; // Convert to 0-based
                                }

                                window.onLocalFairRotationTaskCompleted(
                                    task.title,
                                    userName,
                                    selectedDate,
                                    occurrenceIndex,
                                );
                            }

                            // Also use server-based system for persistent tracking
                            if (
                                window.PredictedScheduleSystem &&
                                typeof window.PredictedScheduleSystem
                                    .triggerScheduleRecalculation === "function"
                            ) {
                                console.log(
                                    `🔮 Triggering server-based schedule recalculation for task: ${task.title}`,
                                );
                                try {
                                    window.PredictedScheduleSystem.triggerScheduleRecalculation(
                                        task,
                                        selectedDate,
                                        `task completed by ${userName}`,
                                    );
                                } catch (error) {
                                    console.warn(
                                        "Server-based recalculation failed:",
                                        error,
                                    );
                                }
                            } else if (
                                typeof shouldRecalculateSchedule ===
                                    "function" &&
                                shouldRecalculateSchedule(
                                    task,
                                    selectedDate,
                                    userName,
                                )
                            ) {
                                console.log(
                                    `🔄 Fallback recalculation for fair rotation task: ${task.title}`,
                                );
                                if (
                                    typeof recalculateFairRotationSchedule ===
                                    "function"
                                ) {
                                    recalculateFairRotationSchedule(
                                        task,
                                        selectedDate,
                                    );
                                }
                            }
                        }

                        modal.remove();

                        if (typeof loadTasksForDate === "function") {
                            setTimeout(() => {
                                const selectedDateElement =
                                    document.querySelector(".day.selected");
                                const currentSelectedDate = selectedDateElement
                                    ? selectedDateElement.dataset.date
                                    : new Date().toISOString().split("T")[0];
                                loadTasksForDate(currentSelectedDate);
                            }, 500);
                        }
                    } catch (error) {
                        console.error("❌ Error completing task:", error);
                        alert(`Failed to complete task: ${error.message}`);
                    }
                }

                // Edit single occurrence (preserved from original tasks.html)
                const editOccurrenceBtn =
                    modal.querySelector("#editOccurrenceBtn");
                if (editOccurrenceBtn) {
                    editOccurrenceBtn.addEventListener("click", async () => {
                        const isOccurrenceTask =
                            freshTask.originalTitle &&
                            freshTask.totalOccurrences;
                        const isOccurrenceByTitle =
                            freshTask.title.includes(" - ") &&
                            (freshTask.title.includes("1st") ||
                                freshTask.title.includes("2nd") ||
                                freshTask.title.includes("3rd"));

                        let modifiedTask = { ...freshTask };

                        if (
                            freshTask.exceptions &&
                            freshTask.exceptions[selectedDate] &&
                            freshTask.exceptions[selectedDate].task
                        ) {
                            const exceptionTask =
                                freshTask.exceptions[selectedDate].task;
                            modifiedTask = {
                                ...freshTask,
                                ...exceptionTask,
                                exceptions: freshTask.exceptions,
                                completions: freshTask.completions,
                            };
                        }

                        if (isOccurrenceTask || isOccurrenceByTitle) {
                            const originalTitle =
                                freshTask.originalTitle ||
                                freshTask.title.split(" - ")[0];
                            const adminEmail =
                                localStorage.getItem("currentAdminEmail");

                            try {
                                const response = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                                    { cache: "no-store" },
                                );
                                if (response.ok) {
                                    const result = await response.json();
                                    const allOccurrences = result.tasks.filter(
                                        (t) =>
                                            (t.originalTitle ===
                                                originalTitle ||
                                                t.title.startsWith(
                                                    originalTitle + " - ",
                                                )) &&
                                            t.date === freshTask.date,
                                    );

                                    if (allOccurrences.length > 0) {
                                        allOccurrences.sort(
                                            (a, b) =>
                                                (a.occurrence || 1) -
                                                (b.occurrence || 1),
                                        );

                                        modifiedTask = {
                                            ...allOccurrences[0],
                                            title: originalTitle,
                                            timesPerDay: allOccurrences.length,
                                            totalOccurrences:
                                                allOccurrences.length,
                                            users: [
                                                ...new Set(
                                                    allOccurrences.flatMap(
                                                        (occ) =>
                                                            occ.users || [],
                                                    ),
                                                ),
                                            ],
                                            dueTimes: allOccurrences
                                                .map((occ) =>
                                                    occ.dueTimes &&
                                                    occ.dueTimes[0]
                                                        ? occ.dueTimes[0]
                                                        : "",
                                                )
                                                .filter((time) => time),
                                            occurrence: freshTask.occurrence,
                                            originalTitle:
                                                freshTask.originalTitle,
                                        };
                                    }
                                }
                            } catch (error) {
                                console.error(
                                    "Error fetching occurrence data for occurrence edit:",
                                    error,
                                );
                            }
                        }

                        modifiedTask.isOccurrenceEdit = true;
                        modifiedTask.targetDate = selectedDate;
                        modifiedTask.originalStartDate =
                            freshTask.date.split(" to ")[0];
                        localStorage.setItem(
                            "familyApp_editTask",
                            JSON.stringify(modifiedTask),
                        );
                        localStorage.setItem(
                            "familyApp_editTask_index",
                            freshTask.title +
                                "-" +
                                freshTask.date +
                                "-occurrence",
                        );
                        window.location.href =
                            "/BeeMazing-A1/mobile/3-Tasks/addtasks.html";
                    });
                }

                // Edit future occurrences (preserved from original tasks.html)
                const editFutureBtn = modal.querySelector("#editFutureBtn");
                if (editFutureBtn) {
                    editFutureBtn.addEventListener("click", async () => {
                        const isOccurrenceTask =
                            freshTask.originalTitle &&
                            freshTask.totalOccurrences;
                        const isOccurrenceByTitle =
                            freshTask.title.includes(" - ") &&
                            (freshTask.title.includes("1st") ||
                                freshTask.title.includes("2nd") ||
                                freshTask.title.includes("3rd"));

                        let modifiedTask = { ...freshTask };

                        if (
                            freshTask.exceptions &&
                            freshTask.exceptions[selectedDate] &&
                            freshTask.exceptions[selectedDate].task
                        ) {
                            const exceptionTask =
                                freshTask.exceptions[selectedDate].task;
                            modifiedTask = {
                                ...freshTask,
                                ...exceptionTask,
                                exceptions: freshTask.exceptions,
                                completions: freshTask.completions,
                            };
                        }

                        if (isOccurrenceTask || isOccurrenceByTitle) {
                            const originalTitle =
                                freshTask.originalTitle ||
                                freshTask.title.split(" - ")[0];
                            const adminEmail =
                                localStorage.getItem("currentAdminEmail");

                            try {
                                const response = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                                    { cache: "no-store" },
                                );
                                if (response.ok) {
                                    const result = await response.json();
                                    const allOccurrences = result.tasks.filter(
                                        (t) =>
                                            (t.originalTitle ===
                                                originalTitle ||
                                                t.title.startsWith(
                                                    originalTitle + " - ",
                                                )) &&
                                            t.date === freshTask.date,
                                    );

                                    if (allOccurrences.length > 0) {
                                        allOccurrences.sort(
                                            (a, b) =>
                                                (a.occurrence || 1) -
                                                (b.occurrence || 1),
                                        );

                                        modifiedTask = {
                                            ...allOccurrences[0],
                                            title: originalTitle,
                                            timesPerDay: allOccurrences.length,
                                            totalOccurrences:
                                                allOccurrences.length,
                                            users: [
                                                ...new Set(
                                                    allOccurrences.flatMap(
                                                        (occ) =>
                                                            occ.users || [],
                                                    ),
                                                ),
                                            ],
                                            dueTimes: allOccurrences
                                                .map((occ) =>
                                                    occ.dueTimes &&
                                                    occ.dueTimes[0]
                                                        ? occ.dueTimes[0]
                                                        : "",
                                                )
                                                .filter((time) => time),
                                            occurrence: undefined,
                                            originalTitle: undefined,
                                        };
                                    }
                                }
                            } catch (error) {
                                console.error(
                                    "Error fetching occurrence data for future edit:",
                                    error,
                                );
                            }

                            modifiedTask.isFutureEdit = true;
                            modifiedTask.isOccurrenceGroupEdit = true;
                            modifiedTask.splitDate = selectedDate;
                            modifiedTask.originalStartDate =
                                freshTask.date.split(" to ")[0];
                            modifiedTask.originalTitle = originalTitle;
                            modifiedTask.totalOccurrences =
                                modifiedTask.totalOccurrences ||
                                freshTask.totalOccurrences ||
                                3;

                            localStorage.setItem(
                                "familyApp_editTask",
                                JSON.stringify(modifiedTask),
                            );
                            localStorage.setItem(
                                "familyApp_editTask_index",
                                originalTitle +
                                    "-" +
                                    freshTask.date +
                                    "-future-group",
                            );
                        } else {
                            modifiedTask.isFutureEdit = true;
                            modifiedTask.splitDate = selectedDate;
                            modifiedTask.originalStartDate =
                                freshTask.date.split(" to ")[0];
                            localStorage.setItem(
                                "familyApp_editTask",
                                JSON.stringify(modifiedTask),
                            );
                            localStorage.setItem(
                                "familyApp_editTask_index",
                                freshTask.title +
                                    "-" +
                                    freshTask.date +
                                    "-future",
                            );
                        }

                        window.location.href =
                            "/BeeMazing-A1/mobile/3-Tasks/addtasks.html";
                    });
                }

                // Edit entire task (preserved from original tasks.html)
                const editTaskBtn = modal.querySelector("#editTaskBtn");
                if (editTaskBtn) {
                    editTaskBtn.addEventListener("click", async () => {
                        const isOccurrenceTask =
                            freshTask.originalTitle &&
                            freshTask.totalOccurrences;
                        const isOccurrenceByTitle =
                            freshTask.title.includes(" - ") &&
                            (freshTask.title.includes("1st") ||
                                freshTask.title.includes("2nd") ||
                                freshTask.title.includes("3rd"));

                        let taskDataToEdit = { ...freshTask };

                        if (
                            freshTask.exceptions &&
                            freshTask.exceptions[selectedDate] &&
                            freshTask.exceptions[selectedDate].task
                        ) {
                            const exceptionTask =
                                freshTask.exceptions[selectedDate].task;
                            taskDataToEdit = {
                                ...freshTask,
                                ...exceptionTask,
                                exceptions: freshTask.exceptions,
                                completions: freshTask.completions,
                            };
                        }

                        if (isOccurrenceTask || isOccurrenceByTitle) {
                            const originalTitle =
                                freshTask.originalTitle ||
                                freshTask.title.split(" - ")[0];
                            const adminEmail =
                                localStorage.getItem("currentAdminEmail");

                            try {
                                await new Promise((resolve) =>
                                    setTimeout(resolve, 3000),
                                );

                                let response;
                                let attempts = 0;
                                const maxAttempts = 3;

                                while (attempts < maxAttempts) {
                                    attempts++;
                                    const cacheBuster = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}_attempt${attempts}`;

                                    response = await fetch(
                                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${cacheBuster}&refresh=true&force=true`,
                                        {
                                            cache: "no-store",
                                            headers: {
                                                "Cache-Control":
                                                    "no-cache, no-store, must-revalidate",
                                                Pragma: "no-cache",
                                                Expires: "0",
                                                "X-Force-Refresh": "true",
                                            },
                                        },
                                    );

                                    if (response.ok) {
                                        break;
                                    }

                                    if (attempts < maxAttempts) {
                                        await new Promise((resolve) =>
                                            setTimeout(resolve, 1000),
                                        );
                                    }
                                }

                                if (response.ok) {
                                    const result = await response.json();
                                    const allOccurrences = result.tasks.filter(
                                        (t) =>
                                            (t.originalTitle ===
                                                originalTitle ||
                                                t.title.startsWith(
                                                    originalTitle + " - ",
                                                )) &&
                                            t.date === freshTask.date,
                                    );

                                    if (allOccurrences.length > 0) {
                                        allOccurrences.sort(
                                            (a, b) =>
                                                (a.occurrence || 1) -
                                                (b.occurrence || 1),
                                        );

                                        taskDataToEdit = {
                                            ...allOccurrences[0],
                                            title: originalTitle,
                                            timesPerDay: allOccurrences.length,
                                            totalOccurrences:
                                                allOccurrences.length,
                                            users: [
                                                ...new Set(
                                                    allOccurrences.flatMap(
                                                        (occ) =>
                                                            occ.users || [],
                                                    ),
                                                ),
                                            ],
                                            dueTimes: allOccurrences
                                                .map((occ) =>
                                                    occ.dueTimes &&
                                                    occ.dueTimes[0]
                                                        ? occ.dueTimes[0]
                                                        : "",
                                                )
                                                .filter((time) => time),
                                            originalTitle: originalTitle,
                                            isOccurrenceGroupEdit: true,
                                            occurrence: undefined,
                                        };
                                    }
                                }
                            } catch (error) {
                                console.error(
                                    "Error fetching occurrence data:",
                                    error,
                                );
                            }
                        }

                        localStorage.setItem(
                            "familyApp_editTask",
                            JSON.stringify(taskDataToEdit),
                        );
                        localStorage.setItem(
                            "familyApp_editTask_index",
                            taskDataToEdit.title +
                                "-" +
                                freshTask.date +
                                "-entire",
                        );

                        const admin = localStorage.getItem("currentAdminEmail");
                        const user = localStorage.getItem("currentUser");

                        if (admin && user) {
                            const targetUrl = `/BeeMazing-A1/mobile/3-Tasks/addtasks.html?admin=${encodeURIComponent(admin)}&user=${encodeURIComponent(user)}`;
                            window.location.href = targetUrl;
                        } else {
                            alert(
                                "Admin or user information missing. Please log in again.",
                            );
                        }
                    });
                }

                // Delete single occurrence (preserved from original tasks.html)
                const deleteOccurrenceBtn = modal.querySelector(
                    "#deleteOccurrenceBtn",
                );
                if (deleteOccurrenceBtn) {
                    deleteOccurrenceBtn.addEventListener("click", async () => {
                        if (deleteOccurrenceBtn.disabled) return;
                        deleteOccurrenceBtn.disabled = true;
                        const originalText = deleteOccurrenceBtn.textContent;
                        deleteOccurrenceBtn.textContent = "Deleting...";

                        try {
                            if (
                                confirm(
                                    `Are you sure you want to delete this task occurrence on ${selectedDate}? This will only affect this specific date.`,
                                )
                            ) {
                                modal.remove();
                                await deleteSingleOccurrence(
                                    freshTask.title,
                                    selectedDate,
                                    freshTask.date.split(" to ")[0],
                                );
                                loadTasksForDate(selectedDate);
                            }
                        } finally {
                            deleteOccurrenceBtn.disabled = false;
                            deleteOccurrenceBtn.textContent = originalText;
                        }
                    });
                }

                // Delete future occurrences (preserved from original tasks.html)
                const deleteFutureBtn = modal.querySelector("#deleteFutureBtn");
                if (deleteFutureBtn) {
                    deleteFutureBtn.addEventListener("click", async () => {
                        if (deleteFutureBtn.disabled) return;
                        deleteFutureBtn.disabled = true;
                        const originalText = deleteFutureBtn.textContent;
                        deleteFutureBtn.textContent = "Deleting...";

                        try {
                            const isOccurrenceTask =
                                freshTask.originalTitle &&
                                freshTask.totalOccurrences;
                            const isOccurrenceByTitle =
                                freshTask.title.includes(" - ") &&
                                (freshTask.title.includes("1st") ||
                                    freshTask.title.includes("2nd") ||
                                    freshTask.title.includes("3rd"));

                            let titleToUse;
                            let confirmMessage;

                            if (isOccurrenceTask || isOccurrenceByTitle) {
                                titleToUse =
                                    freshTask.originalTitle ||
                                    freshTask.title.split(" - ")[0];
                                confirmMessage = `Are you sure you want to delete ALL occurrences of "${titleToUse}" from ${selectedDate} forward?\n\nThis will delete all daily occurrences (1st, 2nd, 3rd, etc.) from today and all future dates.`;
                            } else {
                                titleToUse = freshTask.title;
                                confirmMessage = `Are you sure you want to delete "${titleToUse}" from ${selectedDate} forward?\n\nThis will affect all future occurrences.`;
                            }

                            if (confirm(confirmMessage)) {
                                modal.remove();

                                if (isOccurrenceTask || isOccurrenceByTitle) {
                                    await deleteAllOccurrencesFuture(
                                        titleToUse,
                                        selectedDate,
                                    );
                                } else {
                                    await deleteFutureOccurrences(
                                        titleToUse,
                                        selectedDate,
                                        freshTask.date.split(" to ")[0],
                                    );
                                }

                                loadTasksForDate(selectedDate);
                            }
                        } finally {
                            deleteFutureBtn.disabled = false;
                            deleteFutureBtn.textContent = originalText;
                        }
                    });
                }

                // Delete entire task (preserved from original tasks.html)
                const deleteEntireTaskBtn = modal.querySelector(
                    "#deleteEntireTaskBtn",
                );
                if (deleteEntireTaskBtn) {
                    deleteEntireTaskBtn.addEventListener("click", async () => {
                        if (deleteEntireTaskBtn.disabled) return;
                        deleteEntireTaskBtn.disabled = true;
                        const originalText = deleteEntireTaskBtn.textContent;
                        deleteEntireTaskBtn.textContent = "Deleting...";

                        try {
                            const isOccurrenceTask =
                                freshTask.originalTitle &&
                                freshTask.totalOccurrences;
                            const isOccurrenceByTitle =
                                freshTask.title.includes(" - ") &&
                                (freshTask.title.includes("1st") ||
                                    freshTask.title.includes("2nd") ||
                                    freshTask.title.includes("3rd"));
                            const isReconstructedMaster =
                                freshTask._isReconstructedMaster;

                            // Debug logging for delete detection
                            console.log("🗑️ DELETE DETECTION DEBUG:", {
                                isOccurrenceTask,
                                isOccurrenceByTitle,
                                isReconstructedMaster,
                                taskTitle: freshTask.title,
                                originalTitle: freshTask.originalTitle,
                                totalOccurrences: freshTask.totalOccurrences,
                                _isReconstructedMaster:
                                    freshTask._isReconstructedMaster,
                            });

                            let titleToUse;
                            let confirmMessage;

                            if (
                                isOccurrenceTask ||
                                isOccurrenceByTitle ||
                                isReconstructedMaster
                            ) {
                                titleToUse =
                                    freshTask.originalTitle ||
                                    freshTask.title.split(" - ")[0] ||
                                    freshTask.title;
                                confirmMessage = `Are you sure you want to delete ALL occurrences of "${titleToUse}"?\n\nThis will delete all daily occurrences (1st, 2nd, 3rd, etc.) across all past and future dates.`;
                            } else {
                                titleToUse = freshTask.title;
                                confirmMessage = `Are you sure you want to delete "${titleToUse}"?\n\nThis will delete the entire task and affect all past and future occurrences.`;
                            }

                            if (confirm(confirmMessage)) {
                                modal.remove();

                                if (
                                    isOccurrenceTask ||
                                    isOccurrenceByTitle ||
                                    isReconstructedMaster
                                ) {
                                    // Check if this is a reconstructed master task
                                    if (isReconstructedMaster) {
                                        console.log(
                                            "🗑️ Using deleteAllOccurrencesAllDates for master task:",
                                            titleToUse,
                                        );
                                        await deleteAllOccurrencesAllDates(
                                            titleToUse,
                                        );
                                    } else {
                                        console.log(
                                            "🗑️ Using deleteAllOccurrences for individual task:",
                                            titleToUse,
                                            freshTask.date,
                                        );
                                        await deleteAllOccurrences(
                                            titleToUse,
                                            freshTask.date,
                                        );
                                    }
                                } else {
                                    console.log(
                                        "🗑️ Using deleteTaskFromBackend for regular task:",
                                        titleToUse,
                                        freshTask.date,
                                    );
                                    await deleteTaskFromBackend(
                                        titleToUse,
                                        freshTask.date,
                                    );
                                }

                                loadTasksForDate(selectedDate);
                            }
                        } finally {
                            deleteEntireTaskBtn.disabled = false;
                            deleteEntireTaskBtn.textContent = originalText;
                        }
                    });
                }
            }

            // Function to get actual rotation order from current occurrence forward
            async function getActualRotationOrder(task, selectedDate) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                const originalTitle =
                    task.originalTitle || task.title.split(" - ")[0];
                const totalUsers =
                    task.rotationOrder?.length || task.users?.length || 1;
                const actualOrder = [];

                try {
                    // Fetch all tasks to find occurrences
                    const cacheBuster = `t=${Date.now()}&r=${Math.random()}`;
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&${cacheBuster}`,
                        {
                            cache: "no-store",
                            headers: {
                                "Cache-Control":
                                    "no-cache, no-store, must-revalidate",
                                Pragma: "no-cache",
                                Expires: "0",
                            },
                        },
                    );

                    if (response.ok) {
                        const result = await response.json();

                        // Find current occurrence
                        const currentOccurrence = result.tasks.find(
                            (t) =>
                                (t.originalTitle === originalTitle ||
                                    t.title.startsWith(
                                        originalTitle + " - ",
                                    )) &&
                                t.date === task.date &&
                                t.occurrence === task.occurrence,
                        );

                        if (
                            currentOccurrence &&
                            currentOccurrence.users &&
                            currentOccurrence.users.length > 0
                        ) {
                            actualOrder.push(currentOccurrence.users[0]);
                            console.log(
                                `🎯 Current occurrence user: ${currentOccurrence.users[0]}`,
                            );
                        }

                        // Find subsequent occurrences for the same date
                        const sameeDateOccurrences = result.tasks
                            .filter(
                                (t) =>
                                    (t.originalTitle === originalTitle ||
                                        t.title.startsWith(
                                            originalTitle + " - ",
                                        )) &&
                                    t.date === task.date &&
                                    t.occurrence > task.occurrence,
                            )
                            .sort((a, b) => a.occurrence - b.occurrence);

                        sameeDateOccurrences.forEach((occ) => {
                            if (
                                occ.users &&
                                occ.users.length > 0 &&
                                !actualOrder.includes(occ.users[0])
                            ) {
                                actualOrder.push(occ.users[0]);
                                console.log(
                                    `➡️ Same date next user: ${occ.users[0]}`,
                                );
                            }
                        });

                        // If we need more users, look at next day(s)
                        if (actualOrder.length < totalUsers) {
                            const currentDate = new Date(selectedDate);

                            for (
                                let dayOffset = 1;
                                dayOffset <= 7 &&
                                actualOrder.length < totalUsers;
                                dayOffset++
                            ) {
                                const nextDate = new Date(currentDate);
                                nextDate.setDate(
                                    currentDate.getDate() + dayOffset,
                                );
                                const nextDateStr = nextDate
                                    .toISOString()
                                    .split("T")[0];

                                const nextDayOccurrences = result.tasks
                                    .filter(
                                        (t) =>
                                            (t.originalTitle ===
                                                originalTitle ||
                                                t.title.startsWith(
                                                    originalTitle + " - ",
                                                )) &&
                                            t.date.includes(nextDateStr),
                                    )
                                    .sort(
                                        (a, b) =>
                                            (a.occurrence || 1) -
                                            (b.occurrence || 1),
                                    );

                                nextDayOccurrences.forEach((occ) => {
                                    if (
                                        occ.users &&
                                        occ.users.length > 0 &&
                                        !actualOrder.includes(occ.users[0]) &&
                                        actualOrder.length < totalUsers
                                    ) {
                                        actualOrder.push(occ.users[0]);
                                        console.log(
                                            `📅 Next day user: ${occ.users[0]} (${nextDateStr})`,
                                        );
                                    }
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.error(
                        "Error fetching actual rotation order:",
                        error,
                    );
                }

                // Fallback to original rotation order if we couldn't get actual order
                if (actualOrder.length === 0) {
                    console.log("⚠️ Falling back to original rotation order");
                    return task.rotationOrder || task.users || [];
                }

                console.log(
                    `✅ Built actual rotation order: ${actualOrder.join(" → ")}`,
                );
                return actualOrder;
            }

            // Function to show master task details for occurrence tasks
            async function showMasterTaskDetails(originalTitle, selectedDate) {
                console.log(
                    "🔍 showMasterTaskDetails called with:",
                    originalTitle,
                    selectedDate,
                );

                // Get the current task from global variable
                const currentTask = window.currentOccurrenceTask;
                if (!currentTask) {
                    console.error("❌ No currentTask available");
                    console.log("🔍 Window object keys:", Object.keys(window));
                    return;
                }
                console.log("✅ Using currentTask:", currentTask);
                console.log("🔍 Current task type:", typeof currentTask);
                console.log("🔍 Current task keys:", Object.keys(currentTask));
                console.log(
                    "👥 Current task users (original):",
                    currentTask.users,
                );
                console.log(
                    "👥 Current task users count:",
                    currentTask.users?.length,
                );
                console.log("🎯 Current task title:", currentTask.title);
                console.log("🔄 Current task settings:", currentTask.settings);
                console.log(
                    "📋 Current task occurrence:",
                    currentTask.occurrence,
                );
                console.log(
                    "📊 Current task totalOccurrences:",
                    currentTask.totalOccurrences,
                );

                // Fetch all tasks to find all occurrences of this task group
                const adminEmail = localStorage.getItem("currentAdminEmail");
                let allDueTimes = [];
                let allOccurrences = [];
                let uniqueUsers = [];

                try {
                    const cacheBuster = `t=${Date.now()}&r=${Math.random()}`;
                    const res = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&${cacheBuster}`,
                        {
                            cache: "no-store",
                            headers: {
                                "Cache-Control":
                                    "no-cache, no-store, must-revalidate",
                                Pragma: "no-cache",
                                Expires: "0",
                            },
                        },
                    );
                    const data = await res.json();
                    if (res.ok && data.tasks) {
                        console.log(
                            `🔍 Total tasks fetched: ${data.tasks.length}`,
                        );
                        console.log(
                            `🎯 Looking for originalTitle: "${originalTitle}"`,
                        );
                        console.log(
                            `🎯 Looking for titles starting with: "${originalTitle} - "`,
                        );

                        // Log some sample tasks for debugging
                        const sampleTasks = data.tasks.slice(0, 3).map((t) => ({
                            title: t.title,
                            originalTitle: t.originalTitle,
                            occurrence: t.occurrence,
                            totalOccurrences: t.totalOccurrences,
                        }));
                        console.log("📝 Sample tasks:", sampleTasks);

                        // Find all occurrences of this task group
                        allOccurrences = data.tasks.filter(
                            (t) =>
                                t.originalTitle === originalTitle ||
                                (t.title &&
                                    t.title.startsWith(originalTitle + " - ")),
                        );

                        console.log(
                            `📋 Found ${allOccurrences.length} occurrences for ${originalTitle}`,
                        );

                        if (allOccurrences.length > 0) {
                            console.log(
                                "🔍 Found occurrences:",
                                allOccurrences.map((t) => ({
                                    title: t.title,
                                    originalTitle: t.originalTitle,
                                    occurrence: t.occurrence,
                                    dueTimes: t.dueTimes,
                                    users: t.users,
                                })),
                            );

                            // Debug each occurrence individually
                            allOccurrences.forEach((occ, index) => {
                                console.log(
                                    `🔍 Occurrence ${index + 1}:`,
                                    occ.title,
                                );
                                console.log(
                                    `👤 Users in occurrence ${index + 1}:`,
                                    occ.users,
                                );
                                console.log(
                                    `👤 Users length:`,
                                    occ.users?.length,
                                );
                                if (occ.users?.length > 1) {
                                    console.log(
                                        `✅ This occurrence has multiple users!`,
                                    );
                                } else {
                                    console.log(
                                        `⚠️ This occurrence only has ${occ.users?.length || 0} user(s)`,
                                    );
                                }
                            });
                        } else {
                            console.warn(
                                "⚠️ No occurrences found! This might be why the master task looks the same.",
                            );
                        }

                        // Collect all due times and all users from occurrences
                        const allUsers = [];
                        allOccurrences.forEach((occurrence) => {
                            if (
                                occurrence.dueTimes &&
                                occurrence.dueTimes.length > 0
                            ) {
                                allDueTimes.push(...occurrence.dueTimes);
                            }
                            if (
                                occurrence.users &&
                                occurrence.users.length > 0
                            ) {
                                allUsers.push(...occurrence.users);
                            }
                        });

                        // Get unique users and preserve order
                        const uniqueUsers = [...new Set(allUsers)];
                        console.log("👥 Raw allUsers array:", allUsers);
                        console.log(
                            "👥 All users collected from occurrences:",
                            uniqueUsers,
                        );
                        console.log(
                            "👥 Unique users count:",
                            uniqueUsers.length,
                        );

                        // Sort due times chronologically
                        allDueTimes = [...new Set(allDueTimes)].sort();
                    }
                } catch (err) {
                    console.error(
                        "Failed to fetch tasks for master details:",
                        err,
                    );
                    // Fallback to current task's due times and users
                    allDueTimes = currentTask.dueTimes || [];
                    uniqueUsers = currentTask.users || [];
                }

                // Reconstruct master task from the current occurrence task data
                const masterTask = {
                    ...currentTask,
                    title: originalTitle,
                    timesPerDay: currentTask.totalOccurrences || 1,
                    dueTimes:
                        allDueTimes.length > 0
                            ? allDueTimes
                            : currentTask.dueTimes,
                    users:
                        uniqueUsers.length > 0
                            ? uniqueUsers
                            : currentTask.rotationOrder || currentTask.users,
                    rotationOrder: currentTask.rotationOrder || uniqueUsers,
                    // Remove occurrence-specific fields
                    occurrence: undefined,
                    totalOccurrences: undefined,
                    originalTitle: undefined,
                };

                console.log("🎯 Master task reconstructed:", masterTask);
                console.log("📝 Original title:", originalTitle);
                console.log("📅 Current task title:", currentTask.title);
                console.log("🔢 Times per day:", masterTask.timesPerDay);
                console.log("⏰ Due times:", masterTask.dueTimes);
                console.log("👥 Master task users:", masterTask.users);
                console.log(
                    "👥 Master task users count:",
                    masterTask.users?.length,
                );
                console.log(
                    "🔍 Current task users (original):",
                    currentTask.users,
                );
                console.log(
                    "🏷️ Current task occurrence:",
                    currentTask.occurrence,
                );
                console.log(
                    "📊 Current task totalOccurrences:",
                    currentTask.totalOccurrences,
                );
                console.log(
                    "🔍 Current task originalTitle:",
                    currentTask.originalTitle,
                );
                console.log(
                    "🆚 Master vs Current title:",
                    masterTask.title,
                    "vs",
                    currentTask.title,
                );
                console.log(
                    "🆚 Master vs Current timesPerDay:",
                    masterTask.timesPerDay,
                    "vs",
                    currentTask.timesPerDay,
                );

                // Check if master task is actually different
                if (
                    masterTask.title === currentTask.title &&
                    masterTask.timesPerDay === currentTask.timesPerDay &&
                    JSON.stringify(masterTask.dueTimes) ===
                        JSON.stringify(currentTask.dueTimes)
                ) {
                    console.warn(
                        "⚠️ Master task appears identical to current task!",
                    );
                }

                // Close current modal
                const existingModal = document.querySelector(".task-modal");
                if (existingModal) {
                    existingModal.remove();
                }

                console.log(
                    "🎯 About to show master task details:",
                    masterTask.title,
                );

                // Ensure the selected date is set correctly
                console.log("🎯 Selected date for master task:", selectedDate);

                // Find and set the selected date in the calendar if needed
                const dayElements = document.querySelectorAll(".day");
                dayElements.forEach((day) => {
                    day.classList.remove("selected");
                    if (day.dataset.date === selectedDate) {
                        day.classList.add("selected");
                        console.log(
                            "✅ Set selected date in calendar:",
                            selectedDate,
                        );
                    }
                });

                // Wait a moment for modal to close, then show master task details
                setTimeout(() => {
                    console.log(
                        "🚀 About to call showTaskDetails with master task",
                    );
                    // Mark this as a reconstructed master task to skip fresh data fetching
                    masterTask._isReconstructedMaster = true;
                    showTaskDetails(masterTask);
                }, 100);
            }

            // addtasks.html Settings: Rotation //////////////////////////////////////////////////////////////////////////////////////////

            // Handle task completion and turn advancement
            // ✅ Handle task completion and turn advancement
            async function finishTask(userName, task, button, selectedDate) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                const todayStr =
                    selectedDate || new Date().toISOString().split("T")[0];

                try {
                    const res = await fetch(
                        "https://beemazing1.onrender.com/api/complete-task",
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                adminEmail,
                                taskTitle: task.title,
                                user: userName,
                                date: todayStr,
                                parentApproval: task.parentApproval,
                            }),
                        },
                    );

                    const result = await res.json();
                    if (!res.ok)
                        throw new Error(
                            result.error || "Failed to complete task",
                        );

                    // Trigger enhanced fair rotation recalculation (provisional state)
                    if (task.fairRotation) {
                        // Use enhanced fair rotation system for comprehensive tracking
                        if (window.onEnhancedFairRotationTaskCompleted) {
                            console.log(
                                `🔄 Triggering enhanced fair rotation recalculation for task: ${task.title}`,
                            );

                            // Determine occurrence number for this specific task
                            let occurrenceNumber = 1;
                            if (task.occurrence) {
                                occurrenceNumber = task.occurrence;
                            } else {
                                // Extract occurrence from title if present (e.g., "Task - 2nd")
                                const occurrenceMatch =
                                    task.title.match(/- (\d+)\w+$/);
                                if (occurrenceMatch) {
                                    occurrenceNumber = parseInt(
                                        occurrenceMatch[1],
                                    );
                                }
                            }

                            // Store pending completion data for approval workflow
                            const fairRotationResult =
                                await window.onEnhancedFairRotationTaskCompleted(
                                    task.originalTitle || task.title,
                                    userName,
                                    todayStr,
                                    occurrenceNumber,
                                );

                            // Store pending ID for approval/rejection workflow
                            if (
                                fairRotationResult.success &&
                                fairRotationResult.pendingId
                            ) {
                                // Store in localStorage for later approval/rejection handling
                                const pendingData = {
                                    taskTitle: task.originalTitle || task.title,
                                    pendingId: fairRotationResult.pendingId,
                                    completingUser: userName,
                                    date: todayStr,
                                    occurrence: occurrenceNumber,
                                    timestamp: new Date().toISOString(),
                                };

                                // Store pending completion data
                                let pendingCompletions = JSON.parse(
                                    localStorage.getItem(
                                        "pendingFairRotationCompletions",
                                    ) || "[]",
                                );
                                pendingCompletions.push(pendingData);
                                localStorage.setItem(
                                    "pendingFairRotationCompletions",
                                    JSON.stringify(pendingCompletions),
                                );

                                console.log(
                                    `✅ Fair rotation completion stored as pending: ${fairRotationResult.pendingId}`,
                                );
                            }
                        }

                        // Fallback to existing systems if enhanced system not available
                        else if (window.onLocalFairRotationTaskCompleted) {
                            console.log(
                                `🔄 Falling back to local fair rotation recalculation for task: ${task.title}`,
                            );

                            let occurrenceIndex = 0;
                            if (task.occurrence && task.totalOccurrences) {
                                occurrenceIndex = task.occurrence - 1;
                            }

                            window.onLocalFairRotationTaskCompleted(
                                task.title,
                                userName,
                                todayStr,
                                occurrenceIndex,
                            );
                        }
                    }

                    const rewardAmount = result.updatedTask.reward || 0;
                    const parentApprovalRequired =
                        task.parentApproval !== false; // Default to true if not specified

                    // ✅ Trigger reward animation or approval message based on setting
                    if (parentApprovalRequired) {
                        // Show pending approval message
                        if (rewardAmount > 0) {
                            alert(
                                `Task completed! 🎉\n\nYour task is waiting for parent approval.\nOnce approved, you'll receive ${rewardAmount} 🍯 buzz points!`,
                            );
                        } else {
                            alert(
                                `Task completed! 🎉\n\nYour task is waiting for parent approval.`,
                            );
                        }
                    } else {
                        // Instant completion - trigger reward animation
                        if (
                            typeof triggerHoneyRain === "function" &&
                            rewardAmount > 0
                        ) {
                            triggerHoneyRain(rewardAmount);
                        }
                        if (rewardAmount > 0) {
                            alert(
                                `Task completed! 🎉\n\nYou instantly received ${rewardAmount} 🍯 buzz points!`,
                            );
                        } else {
                            alert(`Task completed! 🎉`);
                        }
                    }

                    // ✅ Refresh task and user data after slight delay to allow DB sync
                    if (typeof loadTasksForDate === "function") {
                        setTimeout(() => loadTasksForDate(todayStr), 150);
                    }
                    if (typeof loadUserTasks === "function")
                        loadUserTasks(userName, todayStr);
                    if (typeof loadUserReward === "function")
                        loadUserReward(userName);
                } catch (err) {
                    console.error("❌ Error completing task:", err);
                    alert("Failed to finish task. Please try again.");
                }
            }

            // Delete all occurrences of a task group
            async function deleteAllOccurrences(originalTitle, date) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                console.log("🗑️ Deleting all occurrences for:", {
                    adminEmail,
                    originalTitle,
                    date,
                });

                if (!adminEmail) {
                    alert("No admin email found.");
                    return;
                }

                try {
                    // First, get all tasks to find related occurrences
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    const result = await response.json();
                    const allTasks = result.tasks || [];

                    // Debug: Log all tasks to see what we're working with
                    console.log(
                        "🔍 DEBUG: Total tasks in database:",
                        allTasks.length,
                    );
                    console.log(
                        "🔍 DEBUG: All tasks:",
                        allTasks.map((t) => ({
                            title: t.title,
                            originalTitle: t.originalTitle,
                            date: t.date,
                        })),
                    );

                    // Find all related occurrence tasks
                    const startDate = date.split(" to ")[0];
                    console.log(
                        "🔍 DEBUG: Looking for tasks with startDate:",
                        startDate,
                    );
                    console.log(
                        "🔍 DEBUG: Looking for originalTitle:",
                        originalTitle,
                    );

                    const relatedTasks = allTasks.filter((task) => {
                        if (!task.date) return false;
                        const taskStartDate = task.date.split(" to ")[0];
                        const matchesOriginalTitle =
                            task.originalTitle === originalTitle;
                        const matchesTitlePattern =
                            task.title &&
                            task.title.startsWith(originalTitle + " - ");
                        const matchesDate = taskStartDate === startDate;

                        console.log(
                            `🔍 DEBUG: Checking task "${task.title}":`,
                            {
                                taskStartDate,
                                matchesOriginalTitle,
                                matchesTitlePattern,
                                matchesDate,
                                isMatch:
                                    (matchesOriginalTitle ||
                                        matchesTitlePattern) &&
                                    matchesDate,
                            },
                        );

                        return (
                            (matchesOriginalTitle || matchesTitlePattern) &&
                            matchesDate
                        );
                    });

                    console.log(
                        "🗑️ Found related tasks to delete:",
                        relatedTasks.length,
                    );
                    console.log(
                        "🗑️ Related tasks details:",
                        relatedTasks.map((t) => ({
                            title: t.title,
                            originalTitle: t.originalTitle,
                            date: t.date,
                        })),
                    );

                    if (relatedTasks.length === 0) {
                        alert("No related occurrences found to delete.");
                        return;
                    }

                    // Confirm before deleting multiple tasks
                    if (
                        !confirm(
                            `Are you sure you want to delete ${relatedTasks.length} related task occurrences?`,
                        )
                    ) {
                        return;
                    }

                    // Delete each related task
                    let deletedCount = 0;
                    for (const task of relatedTasks) {
                        console.log("🗑️ Deleting occurrence:", task.title);
                        try {
                            await deleteTaskFromBackend(task.title, task.date);
                            deletedCount++;
                        } catch (error) {
                            console.error(
                                "Failed to delete task:",
                                task.title,
                                error,
                            );
                        }
                    }

                    alert(
                        `Successfully deleted ${deletedCount} out of ${relatedTasks.length} related occurrences!`,
                    );
                } catch (error) {
                    console.error("Error deleting occurrence group:", error);
                    alert(
                        "Failed to delete occurrence group. Please try again.",
                    );
                }
            }

            // Delete a task from the backend
            async function deleteTaskFromBackend(title, date) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                console.log("🗑️ DETAILED DELETE DEBUG:");
                console.log("  - Admin Email:", adminEmail);
                console.log("  - Task Title:", title);
                console.log("  - Task Date:", date);
                console.log(
                    "  - Current tasks before delete:",
                    await getAllCurrentTasks(),
                );

                if (!adminEmail) {
                    alert(
                        "❌ Delete failed: No admin email found. Please refresh and try again.",
                    );
                    return;
                }

                if (!title) {
                    alert(
                        "❌ Delete failed: Missing task title. Please refresh and try again.",
                    );
                    return;
                }

                // Handle "as needed" tasks without dates
                let deleteUrl;
                if (!date) {
                    console.log("  - Deleting 'as needed' task without date");
                    deleteUrl = `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&title=${encodeURIComponent(title)}`;
                } else {
                    const startDate = date.split(" to ")[0];
                    console.log("  - Start Date:", startDate);
                    console.log(
                        "  - Encoded Start Date:",
                        encodeURIComponent(startDate),
                    );
                    console.log(
                        "  - Encoded Title:",
                        encodeURIComponent(title),
                    );
                    console.log(
                        "  - Encoded Admin Email:",
                        encodeURIComponent(adminEmail),
                    );
                    deleteUrl = `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&title=${encodeURIComponent(title)}&date=${encodeURIComponent(startDate)}`;
                }
                console.log("  - Delete URL:", deleteUrl);
                console.log(
                    "  - WARNING: This will delete the specific task with title '",
                    title,
                    "' and date '",
                    date,
                    "'",
                );

                const maxRetries = 3;
                let attempt = 0;

                while (attempt <= maxRetries) {
                    console.log(
                        `🔄 Delete attempt ${attempt + 1}/${maxRetries + 1}`,
                    );
                    const controller = new AbortController();
                    const timeoutId = setTimeout(
                        () => controller.abort(),
                        120000,
                    ); // 2 minutes timeout

                    try {
                        const response = await fetch(deleteUrl, {
                            method: "DELETE",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            signal: controller.signal,
                        });

                        clearTimeout(timeoutId);
                        console.log("  - Response status:", response.status);
                        console.log("  - Response OK:", response.ok);

                        if (!response.ok) {
                            let errorData;
                            try {
                                errorData = await response.json();
                            } catch (e) {
                                errorData = {
                                    error: `HTTP ${response.status}: ${response.statusText}`,
                                };
                            }
                            console.error("  - Server error:", errorData);
                            throw new Error(
                                `Server error: ${errorData.error || response.statusText} (Status: ${response.status})`,
                            );
                        }

                        const result = await response.json();
                        console.log("✅ Task deleted successfully:", result);
                        console.log(
                            "  - Tasks remaining after delete:",
                            await getAllCurrentTasks(),
                        );

                        // Refresh the task list immediately for the currently selected date
                        if (typeof loadTasksForDate === "function") {
                            setTimeout(() => {
                                const selectedDateElement =
                                    document.querySelector(".day.selected");
                                const currentSelectedDate = selectedDateElement
                                    ? selectedDateElement.dataset.date
                                    : new Date().toISOString().split("T")[0];
                                loadTasksForDate(currentSelectedDate);
                            }, 100);
                        }
                        return;
                    } catch (error) {
                        clearTimeout(timeoutId);
                        console.error(
                            `❌ Delete attempt ${attempt + 1} failed:`,
                            error.message,
                        );
                        attempt++;

                        if (attempt > maxRetries) {
                            console.error("🚨 All delete attempts failed!");
                            const errorMsg = `Failed to delete task "${title}" after ${maxRetries + 1} attempts.\n\nError: ${error.message}\n\nPossible causes:\n• Network connection issues\n• Server is busy\n• Task data corruption\n• Permission issues\n\nTry refreshing the page and attempting again.`;
                            alert(errorMsg);
                            return;
                        }

                        const waitTime = Math.min(2000 * attempt, 10000); // Progressive backoff, max 10s
                        console.log(`⏳ Waiting ${waitTime}ms before retry...`);
                        await new Promise((resolve) =>
                            setTimeout(resolve, waitTime),
                        );
                    }
                }
            }

            // Get all current tasks for debugging
            async function getAllCurrentTasks() {
                try {
                    const adminEmail =
                        localStorage.getItem("currentAdminEmail");
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    const result = await response.json();
                    return (result.tasks || []).map((t) => ({
                        title: t.title,
                        date: t.date,
                        repeat: t.repeat,
                        asNeeded: t.asNeeded,
                    }));
                } catch (error) {
                    console.error("Error getting current tasks:", error);
                    return [];
                }
            }

            async function deleteSingleOccurrence(
                title,
                date,
                originalStartDate,
            ) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                console.log("🗑️ SINGLE OCCURRENCE DELETE DEBUG:");
                console.log("  - Admin Email:", adminEmail);
                console.log("  - Task Title:", title);
                console.log("  - Target Date:", date);
                console.log("  - Original Start Date:", originalStartDate);

                if (!adminEmail) {
                    alert("❌ Delete failed: No admin email found.");
                    return;
                }

                if (!title || !date || !originalStartDate) {
                    alert(
                        "❌ Delete failed: Missing required data. Please refresh and try again.",
                    );
                    return;
                }

                const deleteUrl = `https://beemazing1.onrender.com/api/tasks/occurrence?adminEmail=${encodeURIComponent(adminEmail)}&title=${encodeURIComponent(title)}&date=${encodeURIComponent(date)}&originalStartDate=${encodeURIComponent(originalStartDate)}`;
                console.log("  - Delete URL:", deleteUrl);

                const maxRetries = 3;
                let attempt = 0;

                while (attempt <= maxRetries) {
                    console.log(
                        `🔄 Single occurrence delete attempt ${attempt + 1}/${maxRetries + 1}`,
                    );
                    const controller = new AbortController();
                    const timeoutId = setTimeout(
                        () => controller.abort(),
                        120000,
                    );

                    try {
                        const response = await fetch(deleteUrl, {
                            method: "DELETE",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            signal: controller.signal,
                        });

                        clearTimeout(timeoutId);
                        console.log("  - Response status:", response.status);

                        if (!response.ok) {
                            let errorData;
                            try {
                                errorData = await response.json();
                            } catch (e) {
                                errorData = {
                                    error: `HTTP ${response.status}: ${response.statusText}`,
                                };
                            }
                            console.error("  - Server error:", errorData);
                            throw new Error(
                                `Server error: ${errorData.error || response.statusText} (Status: ${response.status})`,
                            );
                        }

                        console.log("Task occurrence deleted successfully");
                        alert("Task occurrence deleted successfully");
                        return;
                    } catch (error) {
                        clearTimeout(timeoutId);
                        attempt++;
                        if (attempt > maxRetries) {
                            console.error(
                                "Error deleting task occurrence after retries:",
                                error,
                            );
                            alert(
                                `Failed to delete task occurrence: ${error.message}`,
                            );
                            return;
                        }
                        console.log(
                            `Retrying delete occurrence request (${attempt}/${maxRetries})...`,
                        );
                        await new Promise((resolve) =>
                            setTimeout(resolve, 2000),
                        );
                    }
                }
            }

            // Delete all occurrences of a task group across ALL dates (for master task view)
            async function deleteAllOccurrencesAllDates(originalTitle) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                console.log(
                    "🗑️ Deleting ALL occurrences across all dates for:",
                    {
                        adminEmail,
                        originalTitle,
                    },
                );

                if (!adminEmail) {
                    alert("❌ Delete failed: No admin email found.");
                    return;
                }

                try {
                    // First, get all tasks to find related occurrences
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    const result = await response.json();
                    const allTasks = result.tasks || [];

                    // Find all related occurrence tasks across ALL dates
                    const relatedTasks = allTasks.filter((task) => {
                        if (!task || !task.date) return false;

                        const matchesOriginalTitle =
                            task.originalTitle === originalTitle;
                        const matchesTitlePattern =
                            task.title &&
                            task.title.startsWith(originalTitle + " - ");

                        return matchesOriginalTitle || matchesTitlePattern;
                    });

                    console.log(
                        `🗑️ Found ${relatedTasks.length} related tasks across all dates to delete`,
                    );

                    if (relatedTasks.length === 0) {
                        alert("No related occurrences found to delete.");
                        return;
                    }

                    // Confirm before deleting multiple tasks
                    if (
                        !confirm(
                            `Are you sure you want to delete ${relatedTasks.length} related task occurrences across ALL dates?`,
                        )
                    ) {
                        return;
                    }

                    // Delete each related task
                    let deletedCount = 0;
                    for (const task of relatedTasks) {
                        try {
                            await deleteTaskFromBackend(task.title, task.date);
                            deletedCount++;
                        } catch (error) {
                            console.error(
                                "Failed to delete task:",
                                task.title,
                                error,
                            );
                        }
                    }

                    alert(
                        `Successfully deleted ${deletedCount} out of ${relatedTasks.length} related occurrences across all dates!`,
                    );
                } catch (error) {
                    console.error("Error deleting all occurrences:", error);
                    alert(
                        "Failed to delete all occurrences. Please try again.",
                    );
                }
            }

            // Delete all occurrences of a task from a specific date forward
            async function deleteAllOccurrencesFuture(originalTitle, fromDate) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                console.log("🗑️ Deleting all occurrences from date forward:", {
                    adminEmail,
                    originalTitle,
                    fromDate,
                });

                if (!adminEmail) {
                    alert("❌ Delete failed: No admin email found.");
                    return;
                }

                try {
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks/occurrences-future?adminEmail=${encodeURIComponent(adminEmail)}&originalTitle=${encodeURIComponent(originalTitle)}&fromDate=${encodeURIComponent(fromDate)}`,
                        {
                            method: "DELETE",
                            headers: { "Content-Type": "application/json" },
                        },
                    );

                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }

                    const result = await response.json();
                    console.log(
                        "✅ Future occurrences deleted successfully:",
                        result,
                    );
                    alert(
                        `Successfully deleted future occurrences from ${fromDate} forward!`,
                    );
                } catch (error) {
                    console.error("Error deleting future occurrences:", error);
                    alert(
                        "Failed to delete future occurrences. Please try again.",
                    );
                }
            }

            // Delete regular task from a specific date forward
            async function deleteFutureOccurrences(
                title,
                fromDate,
                originalStartDate,
            ) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                console.log("🗑️ Deleting future occurrences:", {
                    adminEmail,
                    title,
                    fromDate,
                    originalStartDate,
                });

                if (!adminEmail) {
                    alert("❌ Delete failed: No admin email found.");
                    return;
                }

                try {
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks/future?adminEmail=${encodeURIComponent(adminEmail)}&title=${encodeURIComponent(title)}&fromDate=${encodeURIComponent(fromDate)}&originalStartDate=${encodeURIComponent(originalStartDate)}`,
                        {
                            method: "DELETE",
                            headers: { "Content-Type": "application/json" },
                        },
                    );

                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }

                    const result = await response.json();
                    console.log(
                        "✅ Future task occurrences deleted successfully:",
                        result,
                    );
                    alert(
                        `Successfully deleted task from ${fromDate} forward!`,
                    );
                } catch (error) {
                    console.error(
                        "Error deleting future task occurrences:",
                        error,
                    );
                    alert(
                        "Failed to delete future task occurrences. Please try again.",
                    );
                }
            }

            // Save a task to the backend
            async function saveTaskToBackend(task) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                if (!adminEmail) {
                    alert("No admin email found.");
                    return;
                }

                try {
                    const response = await fetch(
                        "https://beemazing1.onrender.com/api/tasks",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                adminEmail,
                                task,
                            }),
                        },
                    );

                    if (!response.ok) {
                        throw new Error("Failed to save task to backend");
                    }
                } catch (error) {
                    console.error("Error saving task:", error);
                    alert("Failed to save task. Please try again.");
                }
            }

            // Expose loadTasksForDate globally for Enhanced Fair Rotation System
            window.loadTasksForDate = loadTasksForDate;

            // Debug function to test Enhanced Fair Rotation System assignments
            window.testEnhancedFairRotation = function (
                taskTitle,
                date,
                occurrence,
            ) {
                console.log(
                    `🧪 Testing Enhanced Fair Rotation for: ${taskTitle}`,
                );

                if (!window.enhancedFairRotationSystem) {
                    console.log(
                        "❌ Enhanced Fair Rotation System not available",
                    );
                    return;
                }

                const testDate = date || new Date().toISOString().split("T")[0];
                const testOccurrence = occurrence || 1;

                // Extract base task name if it looks like a subtask
                const baseTaskName = taskTitle.replace(
                    / - \d+(?:st|nd|rd|th)$/,
                    "",
                );
                const occurrenceMatch = taskTitle.match(
                    / - (\d+)(?:st|nd|rd|th)$/,
                );
                const actualOccurrence = occurrenceMatch
                    ? parseInt(occurrenceMatch[1])
                    : testOccurrence;

                console.log(
                    `🔍 Looking for base task: ${baseTaskName}, occurrence: ${actualOccurrence}`,
                );

                // Get assignment info using base task name
                const assignment =
                    window.enhancedFairRotationSystem.getAssignmentInfo(
                        baseTaskName,
                        testDate,
                        actualOccurrence,
                    );

                if (assignment) {
                    console.log(
                        `✅ Enhanced Fair Rotation assignment found:`,
                        assignment,
                    );
                    console.log(
                        `   👤 Assigned User: ${assignment.assignedUser}`,
                    );
                    console.log(`   📅 Date: ${assignment.date}`);
                    console.log(`   🔢 Occurrence: ${assignment.occurrence}`);
                    console.log(`   💭 Reason: ${assignment.assignmentReason}`);
                } else {
                    console.log(
                        `❌ No Enhanced Fair Rotation assignment found for ${baseTaskName} on ${testDate}, occurrence ${actualOccurrence}`,
                    );
                }

                // Get debug info using base task name
                const debugInfo =
                    window.enhancedFairRotationSystem.getDebugInfo(
                        baseTaskName,
                    );
                console.log(`🔍 Debug info:`, debugInfo);

                // Test if task is initialized using base task name
                const isInitialized =
                    window.enhancedFairRotationSystem.taskUsers.has(
                        baseTaskName,
                    );
                console.log(`📋 Base task initialized: ${isInitialized}`);

                if (isInitialized) {
                    const users =
                        window.enhancedFairRotationSystem.taskUsers.get(
                            baseTaskName,
                        );
                    console.log(`👥 Task users:`, users);
                }
            };

            // Helper function to list all Enhanced Fair Rotation tasks
            window.listEnhancedFairRotationTasks = function () {
                console.log("🔄 Enhanced Fair Rotation Task Groups:");

                if (!window.enhancedFairRotationSystem) {
                    console.log(
                        "❌ Enhanced Fair Rotation System not available",
                    );
                    return;
                }

                const taskUsers = window.enhancedFairRotationSystem.taskUsers;
                if (taskUsers.size === 0) {
                    console.log(
                        "   📋 No task groups initialized in Enhanced Fair Rotation System",
                    );
                    return;
                }

                console.log(
                    `   📊 Total initialized task groups: ${taskUsers.size}`,
                );

                taskUsers.forEach((users, baseTaskName) => {
                    console.log(`   🎯 "${baseTaskName}" (base task)`);
                    console.log(`      👥 Users: [${users.join(", ")}]`);

                    // Show current assignments for today (multiple occurrences)
                    const today = new Date().toISOString().split("T")[0];
                    const scheduleInfo =
                        window.enhancedFairRotationSystem.taskSchedules.get(
                            baseTaskName,
                        );
                    const timesPerDay = scheduleInfo?.timesPerDay || 1;

                    console.log(`      🔄 Occurrences per day: ${timesPerDay}`);

                    for (let occ = 1; occ <= timesPerDay; occ++) {
                        const assignment =
                            window.enhancedFairRotationSystem.getAssignmentInfo(
                                baseTaskName,
                                today,
                                occ,
                            );

                        if (assignment) {
                            console.log(
                                `      👤 Today's occ ${occ}: ${assignment.assignedUser}`,
                            );
                        } else {
                            console.log(
                                `      ❌ No assignment found for today occ ${occ}`,
                            );
                        }
                    }
                });

                console.log(
                    "💡 Use testEnhancedFairRotation('Base Task Name', date, occurrence) to test specific assignments",
                );
            };

            // Debug function to analyze all tasks for fair rotation properties
            window.debugAllTasksForFairRotation = async function () {
                console.log("🔍 ANALYZING ALL TASKS FOR FAIR ROTATION:");

                const adminEmail = localStorage.getItem("currentAdminEmail");
                if (!adminEmail) {
                    console.log("❌ No admin email found");
                    return;
                }

                try {
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    const result = await response.json();
                    const tasks = result.tasks || [];

                    console.log(`📊 Total tasks found: ${tasks.length}`);

                    let fairRotationCount = 0;
                    let rotationSettingCount = 0;
                    let bothCount = 0;

                    tasks.forEach((task, index) => {
                        const hasFairRotation = task.fairRotation === true;
                        const hasRotationSetting =
                            task.settings?.includes("Rotation");
                        const hasRotationProperty =
                            task.rotation?.enabled === true;

                        if (hasFairRotation) fairRotationCount++;
                        if (hasRotationSetting) rotationSettingCount++;
                        if (hasFairRotation && hasRotationSetting) bothCount++;

                        // Show all tasks that might be relevant
                        console.log(`\n🎯 Task ${index + 1}: "${task.title}"`);
                        console.log(`   fairRotation: ${task.fairRotation}`);
                        console.log(
                            `   settings: ${JSON.stringify(task.settings) || "none"}`,
                        );
                        console.log(
                            `   rotation: ${JSON.stringify(task.rotation)}`,
                        );
                        console.log(
                            `   users: [${task.users?.join(", ") || "none"}]`,
                        );
                        console.log(`   date: ${task.date}`);
                        console.log(`   frequency: ${task.frequency}`);
                        console.log(`   timesPerDay: ${task.timesPerDay}`);

                        // Check if it would be initialized
                        const isFairRotationType =
                            task.rotation?.type === "fair";
                        const wouldBeInitialized =
                            hasFairRotation ||
                            isFairRotationType ||
                            (hasRotationSetting && task.fairRotation !== false);
                        console.log(
                            `   ✅ Would be initialized: ${wouldBeInitialized}`,
                        );

                        if (
                            hasFairRotation ||
                            hasRotationSetting ||
                            hasRotationProperty
                        ) {
                            console.log(`   🔄 This is a rotation task!`);
                        }
                    });

                    console.log(`\n📊 SUMMARY:`);
                    console.log(
                        `   Tasks with fairRotation=true: ${fairRotationCount}`,
                    );
                    console.log(
                        `   Tasks with Rotation setting: ${rotationSettingCount}`,
                    );
                    console.log(`   Tasks with both: ${bothCount}`);

                    // Try to initialize them manually
                    if (window.enhancedFairRotationSystem) {
                        console.log(`\n🔄 MANUAL INITIALIZATION ATTEMPT:`);
                        let initCount = 0;

                        tasks.forEach((task) => {
                            const hasFairRotation = task.fairRotation === true;
                            const hasRotationSetting = Array.isArray(
                                task.settings,
                            )
                                ? task.settings.includes("Rotation")
                                : typeof task.settings === "string" &&
                                  task.settings.includes("Rotation");
                            const isFairRotationType =
                                task.rotation?.type === "fair";

                            if (
                                hasFairRotation ||
                                isFairRotationType ||
                                (hasRotationSetting &&
                                    task.fairRotation !== false)
                            ) {
                                try {
                                    if (
                                        !window.enhancedFairRotationSystem.taskUsers.has(
                                            task.title,
                                        )
                                    ) {
                                        window.enhancedFairRotationSystem.initializeTask(
                                            task.title,
                                            task.users || [],
                                            {
                                                frequency:
                                                    task.frequency || "daily",
                                                timesPerDay:
                                                    task.timesPerDay || 1,
                                            },
                                        );
                                        initCount++;
                                        console.log(
                                            `   ✅ Initialized: ${task.title}`,
                                        );
                                    }
                                } catch (error) {
                                    console.log(
                                        `   ❌ Failed to initialize ${task.title}:`,
                                        error.message,
                                    );
                                }
                            }
                        });

                        console.log(
                            `\n📊 Manually initialized ${initCount} tasks`,
                        );
                        console.log(
                            `📊 Enhanced Fair Rotation System now has ${window.enhancedFairRotationSystem.taskUsers.size} tasks`,
                        );
                    }
                } catch (error) {
                    console.error("❌ Error fetching tasks:", error);
                }
            };

            // Function to manually refresh Enhanced Fair Rotation assignments
            window.refreshEnhancedFairRotationUI = function (taskTitle) {
                console.log(
                    "🔄 Manually refreshing Enhanced Fair Rotation UI",
                    taskTitle ? `for: ${taskTitle}` : "for all tasks",
                );

                if (!window.enhancedFairRotationSystem) {
                    console.log(
                        "❌ Enhanced Fair Rotation System not available",
                    );
                    return;
                }

                try {
                    if (taskTitle) {
                        // Refresh specific task
                        window.enhancedFairRotationSystem.refreshFrontendAvatars(
                            taskTitle,
                            false,
                        );
                    } else {
                        // Refresh all Enhanced Fair Rotation tasks
                        const taskUsers =
                            window.enhancedFairRotationSystem.taskUsers;
                        taskUsers.forEach((users, title) => {
                            window.enhancedFairRotationSystem.refreshFrontendAvatars(
                                title,
                                false,
                            );
                        });
                    }

                    console.log(
                        "✅ Enhanced Fair Rotation UI refresh triggered",
                    );
                } catch (error) {
                    console.error(
                        "❌ Error refreshing Enhanced Fair Rotation UI:",
                        error,
                    );
                }
            };

            function generateScrollableDates(monthOffset = 0) {
                const container = document.getElementById("dayScrollContainer");
                container.innerHTML = "";

                const today = new Date();
                today.setDate(1);
                today.setMonth(today.getMonth() + monthOffset);

                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const daysInMonth = new Date(
                    currentYear,
                    currentMonth + 1,
                    0,
                ).getDate();

                document.getElementById("monthLabel").textContent =
                    today.toLocaleDateString(undefined, {
                        month: "long",
                        year: "numeric",
                    });

                const todayStr = formatDate(new Date());
                const dayAbbreviations = [
                    "S",
                    "Mo",
                    "Tu",
                    "We",
                    "Th",
                    "Fr",
                    "St",
                ];

                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(currentYear, currentMonth, i);
                    const dayOfWeek = dayAbbreviations[date.getDay()]; // Get day abbreviation

                    const containerDiv = document.createElement("div");
                    containerDiv.className = "day-container";

                    const label = document.createElement("span");
                    label.className = "day-label";
                    label.textContent = dayOfWeek;

                    const btn = document.createElement("div");
                    btn.className = "day";
                    btn.textContent = i;
                    btn.dataset.date = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;

                    btn.addEventListener("click", () => {
                        document
                            .querySelectorAll(".day")
                            .forEach((d) => d.classList.remove("selected"));
                        btn.classList.add("selected");
                        loadTasksForDate(btn.dataset.date);
                    });

                    if (btn.dataset.date === todayStr) {
                        btn.classList.add("today");
                        btn.classList.add("selected");
                    }

                    containerDiv.appendChild(label);
                    containerDiv.appendChild(btn);
                    container.appendChild(containerDiv);
                }

                setTimeout(() => {
                    const selected = document.querySelector(".day.selected");
                    if (selected) {
                        selected.scrollIntoView({
                            behavior: "smooth",
                            inline: "center",
                        });
                        loadTasksForDate(selected.dataset.date);
                    }
                }, 50);
            }

            // Initialize date navigation
            let monthOffset = 0;
            document
                .getElementById("prevMonth")
                .addEventListener("click", () => {
                    monthOffset--;
                    generateScrollableDates(monthOffset);
                });

            document
                .getElementById("nextMonth")
                .addEventListener("click", () => {
                    monthOffset++;
                    generateScrollableDates(monthOffset);
                });

            if (!localStorage.getItem("currentAdminEmail")) {
                const email = prompt("Please enter your admin email:");
                if (email) {
                    localStorage.setItem("currentAdminEmail", email.trim());
                }
            }

            generateScrollableDates();

            document
                .getElementById("scrollLeft")
                .addEventListener("click", () => {
                    document.getElementById("dayScrollContainer").scrollBy({
                        left: -200,
                        behavior: "smooth",
                    });
                });

            document
                .getElementById("scrollRight")
                .addEventListener("click", () => {
                    document.getElementById("dayScrollContainer").scrollBy({
                        left: 200,
                        behavior: "smooth",
                    });
                });

            function enableSwipeToDelete(taskElement) {
                let startX = 0;
                let currentX = 0;
                let isSwiping = false;
                let isTap = true;
                let startTime = 0;

                const swipeThreshold = 80; // 🐝 Now needs to move 80px left to trigger swipe (was too small before)
                const tapMoveThreshold = 10; // small movements = tap
                const maxTapTime = 300; // milliseconds

                const onStart = (x) => {
                    startX = x;
                    currentX = x;
                    isSwiping = true;
                    isTap = true;
                    startTime = Date.now();
                    taskElement.style.transition = "none";
                };

                const onMove = (x, e) => {
                    if (!isSwiping) return;
                    currentX = x;
                    const deltaX = currentX - startX;

                    if (Math.abs(deltaX) > tapMoveThreshold) {
                        isTap = false;
                        e.preventDefault(); // stop scrolling
                        taskElement.dataset.swiping = "true"; // 🐝 Mark swiping
                    }

                    if (deltaX < 0) {
                        // Only allow swipe left
                        taskElement.style.transform = `translateX(${deltaX}px)`;
                    }
                };

                const onEnd = (e) => {
                    if (!isSwiping) return;
                    isSwiping = false;

                    const deltaX = currentX - startX;
                    const elapsedTime = Date.now() - startTime;
                    taskElement.style.transition = "transform 0.2s ease";

                    if (deltaX < -swipeThreshold) {
                        // Real swipe left detected
                        taskElement.classList.add("swiped-left");
                        taskElement.style.transform = "translateX(-100px)";
                    } else {
                        // Not enough swipe, snap back
                        taskElement.classList.remove("swiped-left");
                        taskElement.style.transform = "translateX(0)";
                    }

                    // If tap, and clicked on delete-btn, trigger it
                    if (
                        isTap &&
                        elapsedTime < maxTapTime &&
                        e.target.classList.contains("delete-btn")
                    ) {
                        e.target.click();
                    }
                };

                // Touch Events
                taskElement.addEventListener("touchstart", (e) =>
                    onStart(e.touches[0].clientX),
                );
                taskElement.addEventListener("touchmove", (e) =>
                    onMove(e.touches[0].clientX, e),
                );
                taskElement.addEventListener("touchend", (e) => onEnd(e));

                // Mouse Events (Desktop)
                taskElement.addEventListener("mousedown", (e) => {
                    e.preventDefault();
                    onStart(e.clientX);
                });
                taskElement.addEventListener("mousemove", (e) => {
                    if (e.buttons === 1) onMove(e.clientX, e);
                });
                taskElement.addEventListener("mouseup", (e) => onEnd(e));
                taskElement.addEventListener("mouseleave", () => {
                    if (isSwiping) onEnd({});
                });
            }

            async function deleteInvalidTask(task) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                if (!adminEmail) return;

                const startDate = task.date?.split(" to ")[0] || "";
                try {
                    await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&title=${encodeURIComponent(task.title || "")}&date=${encodeURIComponent(startDate)}`,
                        {
                            method: "DELETE",
                            headers: { "Content-Type": "application/json" },
                        },
                    );
                    console.log("Deleted invalid task:", task.title);
                } catch (error) {
                    console.error("Error deleting invalid task:", error);
                }
            }
        </script>
    </body>
</html>
