<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>BeeMazing</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
            rel="stylesheet"
        />
        <script src="/BeeMazing-A1/redirect-interceptor.js"></script>
        <script>
            // Add debugging functions immediately for console access
            window.debugTaskStatus = async function (titlePattern) {
                console.log("üö® TASK STATUS CHECK! üö®");

                const currentAdmin = localStorage.getItem("currentAdminEmail");
                if (!currentAdmin) {
                    console.error("üîß No admin email found!");
                    return;
                }

                try {
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (!response.ok) {
                        throw new Error("Failed to fetch tasks");
                    }

                    const result = await response.json();
                    const matchingTasks = result.tasks.filter((t) =>
                        t.title.includes(titlePattern || "Multiple"),
                    );

                    console.log(
                        `üîß Found ${matchingTasks.length} tasks matching "${titlePattern || "Multiple"}"`,
                    );
                    matchingTasks.forEach((task) => {
                        console.log("üîß Task:", {
                            title: task.title,
                            date: task.date,
                            originalTitle: task.originalTitle,
                            occurrence: task.occurrence,
                            totalOccurrences: task.totalOccurrences,
                            timesPerDay: task.timesPerDay,
                        });
                    });

                    return matchingTasks;
                } catch (error) {
                    console.error("üîß Status check failed:", error);
                }
            };

            window.debugDeleteOccurrences = async function (
                originalTitle,
                dateRange,
            ) {
                console.log("üö® MANUAL DELETION TEST STARTED! üö®");
                console.log(
                    "üîß Testing deletion for:",
                    originalTitle,
                    "on date:",
                    dateRange,
                );

                const currentAdmin = localStorage.getItem("currentAdminEmail");
                if (!currentAdmin) {
                    console.error("üîß No admin email found!");
                    return;
                }

                try {
                    // Fetch all related tasks
                    const fetchResponse = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (!fetchResponse.ok) {
                        throw new Error("Failed to fetch tasks for deletion");
                    }

                    const result = await fetchResponse.json();
                    const relatedTasks = result.tasks.filter(
                        (t) =>
                            (t.originalTitle === originalTitle ||
                                t.title.startsWith(originalTitle + " - ")) &&
                            t.date === dateRange,
                    );

                    console.log(
                        "üîß Found related tasks to delete:",
                        relatedTasks.length,
                    );
                    console.log(
                        "üîß Tasks to delete:",
                        relatedTasks.map((t) => ({
                            title: t.title,
                            date: t.date,
                        })),
                    );

                    if (relatedTasks.length === 0) {
                        console.log("üîß No tasks found to delete");
                        return;
                    }

                    // Delete each task
                    let deletedCount = 0;
                    for (const relatedTask of relatedTasks) {
                        try {
                            const startDate = dateRange.split(" to ")[0]; // Extract start date only
                            const deleteUrl = `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&title=${encodeURIComponent(relatedTask.title)}&date=${encodeURIComponent(startDate)}`;
                            console.log(
                                "üîß Deleting:",
                                relatedTask.title,
                                "with URL:",
                                deleteUrl,
                            );

                            const deleteResponse = await fetch(deleteUrl, {
                                method: "DELETE",
                                headers: { "Content-Type": "application/json" },
                            });

                            const responseText = await deleteResponse.text();
                            console.log(
                                "üîß Raw response for",
                                relatedTask.title,
                                ":",
                                responseText,
                            );

                            if (deleteResponse.ok) {
                                console.log(
                                    "üîß Successfully deleted:",
                                    relatedTask.title,
                                );
                                deletedCount++;
                            } else {
                                try {
                                    const errorData = JSON.parse(responseText);
                                    console.error(
                                        "üîß Failed to delete:",
                                        relatedTask.title,
                                        "Status:",
                                        deleteResponse.status,
                                        "Error:",
                                        errorData,
                                    );
                                } catch (e) {
                                    console.error(
                                        "üîß Failed to delete:",
                                        relatedTask.title,
                                        "Status:",
                                        deleteResponse.status,
                                        "Raw response:",
                                        responseText,
                                    );
                                }
                            }
                        } catch (err) {
                            console.error(
                                "üîß Exception deleting:",
                                relatedTask.title,
                                err,
                            );
                        }
                    }

                    console.log(
                        `üîß Deletion complete: ${deletedCount}/${relatedTasks.length} tasks deleted`,
                    );

                    // Verify deletion
                    console.log("üîß Verifying deletion...");
                    const verifyResponse = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (verifyResponse.ok) {
                        const verifyResult = await verifyResponse.json();
                        const remainingTasks = verifyResult.tasks.filter(
                            (t) =>
                                (t.originalTitle === originalTitle ||
                                    t.title.startsWith(
                                        originalTitle + " - ",
                                    )) &&
                                t.date === dateRange,
                        );
                        console.log(
                            "üîß Verification: remaining tasks after deletion:",
                            remainingTasks.length,
                        );
                        if (remainingTasks.length > 0) {
                            console.warn(
                                "üîß WARNING: Some tasks were not deleted:",
                                remainingTasks.map((t) => t.title),
                            );
                        } else {
                            console.log("üîß SUCCESS: All tasks deleted!");
                        }
                    }
                } catch (error) {
                    console.error("üîß Manual deletion test failed:", error);
                }
            };

            // Enhanced cleanup function for duplicate tasks
            window.debugCleanupDuplicates = async function () {
                console.log("üßπ COMPREHENSIVE DUPLICATE CLEANUP STARTED! üßπ");

                const currentAdmin = localStorage.getItem("currentAdminEmail");
                if (!currentAdmin) {
                    console.error("üîß No admin email found!");
                    return;
                }

                try {
                    // Fetch all tasks
                    const fetchResponse = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (!fetchResponse.ok) {
                        throw new Error("Failed to fetch tasks for cleanup");
                    }

                    const result = await fetchResponse.json();
                    const allTasks = result.tasks;

                    console.log("üßπ Total tasks found:", allTasks.length);

                    // Group tasks by title and date
                    const taskGroups = {};
                    allTasks.forEach((task) => {
                        const key = `${task.title}|${task.date}`;
                        if (!taskGroups[key]) {
                            taskGroups[key] = [];
                        }
                        taskGroups[key].push(task);
                    });

                    // Find duplicates
                    const duplicateGroups = Object.entries(taskGroups).filter(
                        ([key, tasks]) => tasks.length > 1,
                    );
                    console.log(
                        "üßπ Found duplicate groups:",
                        duplicateGroups.length,
                    );

                    let totalDeleted = 0;

                    // Delete duplicates (keep only the first one)
                    for (const [key, tasks] of duplicateGroups) {
                        const [title, date] = key.split("|");
                        console.log(
                            `üßπ Processing duplicates for "${title}" on ${date}: ${tasks.length} copies`,
                        );

                        // Keep the first task, delete the rest
                        const tasksToDelete = tasks.slice(1);

                        for (const task of tasksToDelete) {
                            try {
                                const deleteUrl = `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&title=${encodeURIComponent(task.title)}&date=${encodeURIComponent(task.date)}`;

                                const deleteResponse = await fetch(deleteUrl, {
                                    method: "DELETE",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                });

                                if (deleteResponse.ok) {
                                    console.log(
                                        "üßπ Deleted duplicate:",
                                        task.title,
                                        "on",
                                        task.date,
                                    );
                                    totalDeleted++;
                                } else {
                                    console.error(
                                        "üßπ Failed to delete duplicate:",
                                        task.title,
                                        "Status:",
                                        deleteResponse.status,
                                    );
                                }
                            } catch (err) {
                                console.error(
                                    "üßπ Exception deleting duplicate:",
                                    task.title,
                                    err,
                                );
                            }
                        }
                    }

                    console.log(
                        `üßπ CLEANUP COMPLETE: ${totalDeleted} duplicate tasks deleted`,
                    );

                    // Verification
                    console.log("üßπ Verifying cleanup...");
                    const verifyResponse = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (verifyResponse.ok) {
                        const verifyResult = await verifyResponse.json();
                        console.log(
                            "üßπ Tasks remaining after cleanup:",
                            verifyResult.tasks.length,
                        );

                        // Check for remaining duplicates
                        const remainingGroups = {};
                        verifyResult.tasks.forEach((task) => {
                            const key = `${task.title}|${task.date}`;
                            if (!remainingGroups[key]) {
                                remainingGroups[key] = [];
                            }
                            remainingGroups[key].push(task);
                        });

                        const remainingDuplicates = Object.entries(
                            remainingGroups,
                        ).filter(([key, tasks]) => tasks.length > 1);
                        if (remainingDuplicates.length > 0) {
                            console.warn(
                                "üßπ WARNING: Still have duplicates:",
                                remainingDuplicates.length,
                                "groups",
                            );
                        } else {
                            console.log("üßπ SUCCESS: No duplicates remaining!");
                        }
                    }
                } catch (error) {
                    console.error("üßπ Cleanup failed:", error);
                }
            };

            // Delete all tasks with specific pattern
            window.debugDeleteAllMatching = async function (titlePattern) {
                console.log("üóëÔ∏è MASS DELETION STARTED! üóëÔ∏è");
                console.log(
                    "üóëÔ∏è Deleting all tasks matching pattern:",
                    titlePattern,
                );

                const currentAdmin = localStorage.getItem("currentAdminEmail");
                if (!currentAdmin) {
                    console.error("üîß No admin email found!");
                    return;
                }

                try {
                    // Fetch all tasks
                    const fetchResponse = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (!fetchResponse.ok) {
                        throw new Error(
                            "Failed to fetch tasks for mass deletion",
                        );
                    }

                    const result = await fetchResponse.json();
                    const tasksToDelete = result.tasks.filter(
                        (t) =>
                            t.title
                                .toLowerCase()
                                .includes(titlePattern.toLowerCase()) ||
                            (t.originalTitle &&
                                t.originalTitle
                                    .toLowerCase()
                                    .includes(titlePattern.toLowerCase())),
                    );

                    console.log(
                        "üóëÔ∏è Found tasks to delete:",
                        tasksToDelete.length,
                    );
                    console.log(
                        "üóëÔ∏è Tasks:",
                        tasksToDelete.map((t) => ({
                            title: t.title,
                            date: t.date,
                        })),
                    );

                    if (tasksToDelete.length === 0) {
                        console.log("üóëÔ∏è No matching tasks found");
                        return;
                    }

                    let deletedCount = 0;
                    for (const task of tasksToDelete) {
                        try {
                            const deleteUrl = `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&title=${encodeURIComponent(task.title)}&date=${encodeURIComponent(task.date)}`;

                            const deleteResponse = await fetch(deleteUrl, {
                                method: "DELETE",
                                headers: { "Content-Type": "application/json" },
                            });

                            if (deleteResponse.ok) {
                                console.log(
                                    "üóëÔ∏è Deleted:",
                                    task.title,
                                    "on",
                                    task.date,
                                );
                                deletedCount++;
                            } else {
                                console.error(
                                    "üóëÔ∏è Failed to delete:",
                                    task.title,
                                    "Status:",
                                    deleteResponse.status,
                                );
                            }
                        } catch (err) {
                            console.error(
                                "üóëÔ∏è Exception deleting:",
                                task.title,
                                err,
                            );
                        }
                    }

                    console.log(
                        `üóëÔ∏è MASS DELETION COMPLETE: ${deletedCount}/${tasksToDelete.length} tasks deleted`,
                    );
                } catch (error) {
                    console.error("üóëÔ∏è Mass deletion failed:", error);
                }
            };

            // Debug function to check why tasks aren't displaying
            window.debugDisplayIssue = async function () {
                console.log("üîç DEBUGGING DISPLAY ISSUE üîç");

                const currentAdmin = localStorage.getItem("currentAdminEmail");
                if (!currentAdmin) {
                    console.error("üîß No admin email found!");
                    return;
                }

                try {
                    // Get current date being viewed
                    const currentDate = new Date().toISOString().split("T")[0];
                    console.log("üîç Current date:", currentDate);

                    // Fetch all tasks
                    const fetchResponse = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (!fetchResponse.ok) {
                        throw new Error("Failed to fetch tasks");
                    }

                    const result = await fetchResponse.json();
                    console.log(
                        "üîç Total tasks in database:",
                        result.tasks.length,
                    );

                    // Check what tasks should show for today
                    const todayTasks = result.tasks.filter((task) => {
                        const taskDate = task.date;
                        console.log(
                            `üîç Task "${task.title}" - Date: ${taskDate}, Today: ${currentDate}, Match: ${taskDate === currentDate}`,
                        );
                        return taskDate === currentDate;
                    });

                    console.log(
                        "üîç Tasks that should show today:",
                        todayTasks.length,
                    );
                    todayTasks.forEach((task) => {
                        console.log(`  - ${task.title} (${task.date})`);
                    });

                    // Check what's actually rendered in the DOM
                    const taskElements = document.querySelectorAll(
                        ".task-item, .task-card, [data-task]",
                    );
                    console.log(
                        "üîç Task elements found in DOM:",
                        taskElements.length,
                    );

                    // Show all unique dates in the database
                    const allDates = [
                        ...new Set(result.tasks.map((t) => t.date)),
                    ].sort();
                    console.log("üîç All dates with tasks:", allDates);

                    // Show tasks by date
                    allDates.forEach((date) => {
                        const tasksForDate = result.tasks.filter(
                            (t) => t.date === date,
                        );
                        console.log(
                            `üîç ${date}: ${tasksForDate.length} tasks - ${tasksForDate.map((t) => t.title).join(", ")}`,
                        );
                    });
                } catch (error) {
                    console.error("üîç Display debug failed:", error);
                }
            };

            console.log("üîß Debug functions loaded! Available functions:");
            console.log(
                "  - debugTaskStatus('Multiple') - Check current tasks",
            );
            console.log(
                "  - debugDeleteOccurrences(originalTitle, dateRange) - Test deletion",
            );
            console.log(
                "  - debugCleanupDuplicates() - Remove duplicate tasks",
            );
            console.log(
                "  - debugDeleteAllMatching('pattern') - Delete all tasks matching pattern",
            );
            console.log(
                "  - debugDisplayIssue() - Check why tasks aren't showing in UI",
            );
        </script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            :root {
                --primary-color: #131312;
                --secondary-color: #e4e3e0;
                --accent-color: #ffffff;
                --light-bg: #fffff8;
                --text-color: #000000;
                --danger-color: #d32f2f;
                --modal-bg: rgba(33, 33, 33, 0.7);
                --footer-height: 70px;
                --add-btn-height: 80px; /* 60px button + 20px buffer */
                --border-dark: #444754; /* same as in addtasks.html */
                --header-height: 68px;
                --card-bg: #2a2b32;
            }

            html,
            body {
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }

            body {
                font-family: "Poppins", Arial, sans-serif;
                background-color: var(--light-bg);
                color: #ffffff;
            }

            .date-header {
                background: #fff6e9;
                position: fixed;
                top: 0;
                width: 100%;
                z-index: 50;
                padding: 5px 0;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                color: black;
            }

            /* Profile Icon */
            .profile-icon {
                position: fixed;
                top: 10px;
                right: 20px;
                width: 40px;
                height: 40px;
                cursor: pointer;
                z-index: 202;
                transition: transform 0.3s ease;
                background: #fbb740;
                border-radius: 50%;
                padding: 8px;
                box-sizing: border-box;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
            }

            .profile-icon:hover {
                transform: scale(1.1);
            }

            .logout-container {
                position: fixed;
                top: 10px;
                left: 10px;
                z-index: 150;
            }

            #logoutBtn {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 8px;
                background: #fbb740;
                border: none;
                cursor: pointer;
                border-radius: 8px;
                width: 40px;
                height: 40px;
                box-sizing: border-box;
                transition: transform 0.3s ease;
            }

            #logoutBtn:hover {
                transform: scale(1.1);
            }

            .logout-icon {
                width: 24px;
                height: 24px;
                filter: brightness(0) saturate(100%) invert(100%);
                transition: transform 0.3s ease;
            }

            .logout-icon:hover {
                transform: scale(1.1);
            }

            .content {
                position: absolute;
                top: calc(
                    var(--header-height) + 45px
                ); /* was 110px ‚Äî now much tighter */
                bottom: var(--footer-height);
                left: 0;
                right: 0;
                padding: 20px;
                overflow-y: auto;
                background-color: var(--light-bg);
                background-image: url('data:image/svg+xml,%3Csvg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"%3E%3Ccircle cx="20" cy="20" r="2" fill="%23FFC107" fill-opacity="0.1"/%3E%3C/svg%3E');
                background-repeat: repeat;
            }

            .task-item {
                padding: 12px 14px;
                background: #ffffff;
                color: #5d4e41;
                border: 2px solid #fbb740;
                border-radius: 12px;
                margin-bottom: 10px;
                cursor: pointer;
                position: relative;
                transition:
                    transform 0.3s ease,
                    box-shadow 0.3s ease;
                touch-action: pan-y;
                overflow: hidden;
                min-height: 60px;
            }

            .task-header {
                margin-bottom: 8px;
            }

            .task-title {
                font-weight: bold;
                font-size: 16px;
                line-height: 1.2;
                flex: 1;
                min-width: 0;
            }

            .task-due-time {
                color: #666;
                font-size: 13px;
                font-weight: 600;
                white-space: nowrap;
                background: #f0f0f0;
                padding: 2px 6px;
                border-radius: 4px;
                margin-left: auto;
                flex-shrink: 0;
            }

            .task-status-icon {
                font-size: 16px;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                flex-shrink: 0;
            }

            .task-status-icon.complete {
                background: #d4edda;
                border: 1px solid #c3e6cb;
            }

            .task-status-icon.pending {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
            }

            .task-status-icon.incomplete {
                background: #f8d7da;
                border: 1px solid #f5c6cb;
            }

            .original-user-avatar {
                width: 20px !important;
                height: 20px !important;
                border: 2px solid #fbb740 !important;
                margin-left: 4px;
                opacity: 0.8;
                position: relative;
            }

            .original-user-avatar::after {
                content: "‚Ü©";
                position: absolute;
                bottom: -2px;
                right: -2px;
                font-size: 8px;
                background: #fbb740;
                color: white;
                border-radius: 50%;
                width: 10px;
                height: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                line-height: 1;
            }

            .task-title-row {
                display: flex;
                align-items: center;
                gap: 8px;
                justify-content: space-between;
                width: 100%;
            }

            .task-avatars {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 4px;
                flex-wrap: wrap;
                margin-top: 4px;
            }

            .team-icon {
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                margin-right: 4px;
                flex-shrink: 0;
            }

            .rotation-icon {
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                margin-right: 4px;
                flex-shrink: 0;
            }

            .task-avatar {
                width: 24px;
                height: 24px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                color: white;
                font-size: 10px;
                text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
                margin-right: 2px;
                flex-shrink: 0;
            }

            .task-next-label {
                color: #666;
                font-size: 10px;
                margin: 0 2px;
            }

            .task-avatars-section {
                display: flex;
                align-items: center;
                gap: 4px;
                flex-wrap: wrap;
                flex: 1;
            }

            .task-reward {
                display: flex;
                align-items: center;
                gap: 4px;
                color: #fbb740;
                font-weight: bold;
                font-size: 15px;
            }

            .honey-icon {
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                flex-shrink: 0;
            }

            .task-item.swiped-left {
                transform: translateX(-100px);
            }

            .task-item .delete-btn {
                position: absolute;
                top: 0;
                right: 0; /* Always aligned right */
                width: 100px;
                height: 100%;
                background: var(--danger-color);
                color: white;
                border: none;
                border-radius: 0 12px 12px 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 16px;
                cursor: pointer;
                transform: translateX(100%); /* üêù Start hidden to right */
                transition: transform 0.3s ease;
            }

            .task-item.swiped-left .delete-btn {
                transform: translateX(0);
                display: flex; /* ‚úÖ stay flex so text stays centered vertically */
                align-items: center; /* ‚úÖ re-apply just in case */
                justify-content: center; /* ‚úÖ re-apply just in case */
                right: 0;
            }

            .task-item .delete-btn:hover {
                background-color: #b71c1c;
            }

            .task-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 3px 8px rgba(251, 183, 64, 0.3);
                border-color: #5d4e41;
            }

            .task-progress {
                font-size: 12px;
                color: #fbb740;
                margin-top: 3px;
            }

            .footer {
                position: fixed;
                bottom: 0;
                width: 100%;
                left: 0;
                display: flex;
                justify-content: space-around;
                align-items: center;
                background: #fbb740;
                padding: 10px 0;
                box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
                z-index: 100;
                height: var(--footer-height);
            }
            .footer a {
                text-decoration: none;
                color: #ffffff;
                display: flex;
                flex-direction: column;
                align-items: center;
                transition: transform 0.3s ease;
            }
            .footer a:hover {
                transform: scale(1.1);
            }

            .footer-icon img,
            .footer-icon svg {
                width: 40px;
                height: 40px;
                filter: brightness(0) saturate(100%) invert(100%);
                transition: filter 0.3s ease;
            }

            .footer a.active svg,
            .footer a[aria-label="Tasks"] svg,
            a[href="/BeeMazing-A1/mobile/3-Tasks/tasks.html"] svg {
                filter: brightness(0) saturate(100%) invert(30%) sepia(20%)
                    saturate(2000%) hue-rotate(15deg) brightness(0.8)
                    contrast(1.2) !important;
                color: #5d4e41 !important;
                width: 40px !important;
                height: 40px !important;
            }

            .footer a.active img {
                filter: brightness(0) saturate(100%) invert(30%) sepia(20%)
                    saturate(2000%) hue-rotate(15deg) brightness(0.8)
                    contrast(1.2) !important;
            }

            .footer a.active span {
                color: #ffffff;
            }

            .footer-icon span {
                font-size: 12px;
                margin-top: 5px;
                font-weight: 600;
            }
            .add-task-btn {
                position: fixed;
                bottom: calc(var(--footer-height) + 10px); /* Above footer */
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 60px;
                background: #fbb740;
                color: #ffffff;
                border: 3px solid #ffffff;
                border-radius: 50%;
                font-size: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                cursor: pointer;
                transition: all 0.3s ease;
                text-decoration: none;
                z-index: 99; /* Below footer but above content */
            }
            .add-task-btn:hover {
                background: #5d4e41;
                color: #ffffff;
                transform: translateX(-50%) scale(1.1);
            }
            .task-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(19, 19, 18, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                animation: fadeIn 0.3s ease-out;
                padding: 20px;
                box-sizing: border-box;
            }
            @keyframes fadeIn {
                0% {
                    opacity: 0;
                }
                100% {
                    opacity: 1;
                }
            }
            .modal-content {
                background: #fffff8;
                padding: 25px;
                border-radius: 12px;
                width: 100%;
                max-width: 420px;
                max-height: 85vh;
                overflow-y: auto;
                text-align: left;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                border: 2px solid #fbb740;
                color: #5d4e41;
                font-family: "Poppins", Arial, sans-serif;
            }
            .modal-content strong {
                color: #5d4e41;
                font-weight: 600;
                font-size: 14px;
            }
            .modal-content h2 {
                color: #5d4e41;
                margin: 0 0 20px 0;
                font-size: 20px;
                font-weight: 600;
                border-bottom: 2px solid #fbb740;
                padding-bottom: 10px;
            }
            .task-info-row {
                padding: 8px 0;
                border-bottom: 1px solid #fff6e9;
            }
            .task-info-row:last-child {
                border-bottom: none;
            }
            .task-progress {
                background: #fff6e9;
                padding: 10px 12px;
                border-radius: 6px;
                margin: 10px 0;
                font-weight: 500;
                color: #5d4e41;
                border-left: 3px solid #fbb740;
            }
            .modal-content em {
                color: #d32f2f;
                font-style: italic;
                background: #ffebee;
                padding: 6px 10px;
                border-radius: 4px;
                display: inline-block;
                margin: 5px 0;
                border-left: 2px solid #d32f2f;
            }

            @media (max-width: 600px) {
                .add-task-btn {
                    width: 50px;
                    height: 50px;
                    font-size: 28px;
                    bottom: calc(
                        var(--footer-height) + 10px
                    ); /* Consistent on mobile */
                }
                .footer-icon img {
                    width: 35px;
                    height: 35px;
                }
            }

            .date-header {
                background: #fff6e9;
                position: fixed;
                top: 0;
                width: 100%;
                z-index: 50;
                padding: 5px 0;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                color: black;
            }

            .month-nav {
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 18px;
                font-weight: bold;
                width: 100%;
                padding: 5px 0;
                color: #5d4e41;
            }
            .month-nav button {
                margin: 0 10px;
                background: #fbb740;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 8px;
                cursor: pointer;
                transition: transform 0.3s ease;
                font-weight: bold;
            }
            .month-nav button:hover {
                transform: scale(1.1);
            }

            /* Date picker start point */

            .day-scroll-wrapper {
                display: flex;
                align-items: center;
                padding: 5px 0;
                overflow: hidden;
            }
            .day-scroll {
                display: flex;
                overflow-x: auto;
                gap: 8px;
                padding: 5px 10px;
            }
            .day-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 38px;
            }
            .day-label {
                font-size: 10px;
                color: #5d4e41;
                text-align: center;
                margin-bottom: 2px;
                font-weight: 600;
            }
            .day {
                width: 38px;
                height: 38px;
                line-height: 38px;
                text-align: center;
                border-radius: 50%;
                background: transparent;
                color: #5d4e41;
                font-weight: bold;
                cursor: pointer;
            }
            .day.selected {
                background: #fbb740;
                color: #fff;
            }
            .day.today {
                border: 2px solid #fbb740;
                font-weight: bold;
            }
            .day.today.selected {
                background: #fbb740;
                color: #fff;
                border: 2px solid #fff;
            }
            .day-scroll::-webkit-scrollbar {
                display: none;
            }
            .day-scroll {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            /* Date picker end point */

            .scroll-btn {
                background: #e4e3e0;
                color: #181816;
                border: none;
                font-size: 20px;
                padding: 5px 10px;
                cursor: pointer;
                flex-shrink: 0;
            }

            .scroll-btn:hover {
                background: var(--primary-color);
            }

            /* User Selection Modal Styles - Bottom Sheet */
            .bottom-sheet {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(19, 19, 18, 0.4);
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease-in-out;
            }
            .bottom-sheet.show {
                display: block;
                opacity: 1;
            }
            .bottom-sheet-content {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                max-height: none;
                background: #fffff8;
                border-top-left-radius: 20px;
                border-top-right-radius: 20px;
                box-shadow: 0 -4px 20px rgba(19, 19, 18, 0.2);
                border: 2px solid #e4e3e0;
                transform: translateY(100%);
                transition: transform 0.3s ease-in-out;
            }
            .bottom-sheet.show .bottom-sheet-content {
                transform: translateY(0);
            }
            .bottom-sheet-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                border-bottom: 2px solid #e4e3e0;
                background: #ffffff;
            }
            .bottom-sheet-header h3 {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
                color: #5d4e41 !important;
            }
            .bottom-sheet-header .close-btn {
                background: none;
                border: none;
                color: #f5f5dc !important;
                font-size: 24px;
                cursor: pointer;
                padding: 5px;
            }
            .bottom-sheet-header .close-btn:hover {
                color: #ffffff;
            }
            .user-list {
                list-style: none;
                padding: 0;
                margin: 0;
                height: auto !important;
                max-height: none !important;
                overflow-y: visible !important;
                min-height: 48px;
            }

            .user-list li {
                font-size: 14px;
                padding: 12px 15px;
                border-bottom: 1px solid #e4e3e0;
                color: #5d4e41 !important;
                cursor: pointer;
                transition: background 0.2s ease;
                background: #fffff8 !important;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .user-list li:hover {
                background: #e4e3e0 !important;
            }

            .user-list li.active-user {
                background: rgb(251, 183, 64) !important;
                color: #5d4e41 !important;
                font-weight: 600 !important;
            }

            .user-list li:last-child {
                border-bottom: none;
            }

            .user-list-item {
                display: flex;
                align-items: center;
                gap: 8px;
                flex: 1;
            }

            .user-list-actions {
                display: flex;
                gap: 8px;
            }

            .user-list::-webkit-scrollbar {
                width: 8px;
            }
            .user-list::-webkit-scrollbar-track {
                background: #fffff8;
            }
            .user-list::-webkit-scrollbar-thumb {
                background: #131312;
                border-radius: 4px;
            }
            .user-list::-webkit-scrollbar-thumb:hover {
                background: #000000;
            }

            /* Position for swipe to delete feature */

            .draggable-user {
                padding: 8px 10px;
                margin: 4px 0;
                background: #2a2b32;
                color: #ffffff;
                border: 1px solid var(--primary-color);
                border-radius: 6px;
                cursor: grab;
                transition:
                    transform 0.2s ease,
                    box-shadow 0.2s ease;
                touch-action: none;
            }

            .draggable-user:active {
                cursor: grabbing;
            }

            .draggable-user.dragging {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
                z-index: 10;
            }
        </style>
        <!-- Remove FontAwesome to avoid CORS issues -->
    </head>
    <body>
        <div class="date-header">
            <div id="profileIcon" class="profile-icon">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-6"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                    />
                </svg>
            </div>

            <div id="logoutContainer" class="logout-container">
                <button id="logoutBtn" aria-label="Logout" title="Logout">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="size-6 logout-icon"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H15"
                        />
                    </svg>
                </button>
            </div>
            <div class="month-nav">
                <button id="prevMonth">&lt;</button>
                <span id="monthLabel">April 2025</span>
                <button id="nextMonth">&gt;</button>
            </div>
            <div class="day-scroll-wrapper">
                <button class="scroll-btn" id="scrollLeft">&lt;</button>
                <div class="day-scroll" id="dayScrollContainer">
                    <!-- Days will be injected dynamically -->
                </div>
                <button class="scroll-btn" id="scrollRight">&gt;</button>
            </div>
        </div>

        <div
            style="
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin: 10px 20px;
                gap: 10px;
            "
        >
            <div style="color: #5d4e41; font-weight: 600; font-size: 16px">
                Today's Tasks
            </div>
            <button
                class="refresh-btn"
                onclick="forceRefreshTasks()"
                style="
                    background: #fbb740;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: transform 0.2s;
                    font-size: 16px;
                "
                title="Refresh Tasks"
            >
                üîÑ
            </button>
        </div>

        <div class="content" id="taskList">
            <!-- Tasks will be loaded dynamically here -->
        </div>

        <a href="#" class="add-task-btn" aria-label="Add Task" id="addTaskBtn"
            >+</a
        >

        <div class="footer">
            <a
                href="/BeeMazing-A1/mobile/2-UserProfiles/userAdmin.html"
                class="footer-icon"
                id="homeLink"
                aria-label="Home"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-6"
                    style="width: 24px; height: 24px"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"
                    />
                </svg>
                <span></span>
            </a>
            <a
                href="/BeeMazing-A1/mobile/3-Tasks/tasks.html"
                class="footer-icon active"
                aria-label="Tasks"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-6"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"
                    />
                </svg>
            </a>
            <a
                href="/BeeMazing-A1/mobile/4-Market/market.html"
                class="footer-icon"
                aria-label="Market"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="size-6"
                    style="width: 24px; height: 24px"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M16.5 18.75h-9m9 0a3 3 0 0 1 3 3h-15a3 3 0 0 1 3-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 0 1-.982-3.172M9.497 14.25a7.454 7.454 0 0 0 .981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 0 0 7.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 0 0 2.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 0 1 2.916.52 6.003 6.003 0 0 1-5.395 4.972m0 0a6.726 6.726 0 0 1-2.749 1.35m0 0a6.772 6.772 0 0 1-3.044 0"
                    />
                </svg>
            </a>
        </div>

        <!-- User Selection Modal -->
        <div
            class="bottom-sheet"
            id="userSelectModal"
            style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(19, 19, 18, 0.4);
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease-in-out;
            "
        >
            <div
                class="bottom-sheet-content"
                style="
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    max-height: none;
                    background: #fffff8;
                    border-top-left-radius: 20px;
                    border-top-right-radius: 20px;
                    box-shadow: 0 -4px 20px rgba(19, 19, 18, 0.2);
                    border: 2px solid #e4e3e0;
                    transform: translateY(100%);
                    transition: transform 0.3s ease-in-out;
                "
            >
                <div
                    class="bottom-sheet-header"
                    style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 15px 20px;
                        border-bottom: 2px solid #e4e3e0;
                        background: #ffffff;
                    "
                >
                    <div
                        class="header-title"
                        style="display: flex; align-items: center; gap: 10px"
                    >
                        <h3
                            style="
                                color: #5d4e41 !important;
                                margin: 0;
                                font-size: 18px;
                                font-weight: 600;
                                display: inline-block;
                            "
                        >
                            Add User
                        </h3>
                        <button
                            class="add-user-btn"
                            id="addUserBtn"
                            style="
                                background: rgb(251, 183, 64) !important;
                                color: rgb(245, 245, 220) !important;
                                border: none !important;
                                border-radius: 50% !important;
                                width: 24px !important;
                                height: 24px !important;
                                font-size: 16px !important;
                                font-weight: bold !important;
                                cursor: pointer !important;
                                display: inline-flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                margin-left: 10px;
                            "
                            onmouseover="this.style.setProperty('background', '#5D4E41', 'important'); this.style.setProperty('background-color', '#5D4E41', 'important');"
                            onmouseout="this.style.setProperty('background', 'rgb(251, 183, 64)', 'important'); this.style.setProperty('background-color', 'rgb(251, 183, 64)', 'important');"
                        >
                            +
                        </button>
                    </div>
                    <button
                        id="closeModalBtn"
                        class="close-btn"
                        aria-label="Close"
                        style="
                            background: none;
                            border: none;
                            color: #f5f5dc !important;
                            font-size: 24px;
                            cursor: pointer;
                            padding: 5px;
                        "
                    >
                        ‚úï
                    </button>
                </div>
                <ul
                    id="userList"
                    class="user-list"
                    style="
                        list-style: none;
                        padding: 0;
                        margin: 0;
                        height: auto !important;
                        max-height: none !important;
                        overflow-y: visible !important;
                        min-height: 48px;
                    "
                ></ul>
            </div>
        </div>

        <!-- Confirm Delete Modal -->
        <div
            class="modal"
            id="confirmModal"
            style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(19, 19, 18, 0.4);
                z-index: 1001;
                justify-content: center;
                align-items: center;
            "
        >
            <div
                class="modal-content"
                style="
                    background: #2a2b32;
                    padding: 25px;
                    border-radius: 15px;
                    width: 85%;
                    max-width: 400px;
                    text-align: center;
                    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
                    border: 2px solid #444754;
                    color: #ffffff;
                "
            >
                <p style="color: #ffffff; margin-bottom: 20px; font-size: 16px">
                    Are you sure you want to delete this user?
                </p>
                <div
                    class="modal-actions"
                    style="display: flex; gap: 10px; justify-content: center"
                >
                    <button
                        id="confirmYesBtn"
                        style="
                            background: rgb(251, 183, 64);
                            color: #212121;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        "
                    >
                        Yes
                    </button>
                    <button
                        id="confirmNoBtn"
                        style="
                            background: #444754;
                            color: #ffffff;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        "
                    >
                        No
                    </button>
                </div>
            </div>
        </div>

        <!-- Permission Modal -->
        <div
            class="modal"
            id="permissionModal"
            style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(19, 19, 18, 0.4);
                z-index: 1001;
                justify-content: center;
                align-items: center;
            "
        >
            <div
                class="modal-content"
                style="
                    background: #fffff8;
                    padding: 25px;
                    border-radius: 15px;
                    width: 85%;
                    max-width: 400px;
                    text-align: center;
                    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
                    border: 2px solid #e4e3e0;
                    color: #5d4e41;
                "
            >
                <h3
                    id="permissionModalUser"
                    style="
                        color: #5d4e41;
                        margin-bottom: 15px;
                        font-weight: 600;
                    "
                >
                    Edit Bee
                </h3>
                <input
                    type="text"
                    id="editUserNameInput"
                    placeholder="Bee name"
                    style="
                        width: 100%;
                        padding: 10px 12px;
                        margin: 10px 0;
                        background: #fffff8;
                        color: #5d4e41;
                        border: 2px solid #e4e3e0;
                        border-radius: 8px;
                        font-size: 16px;
                        outline: none;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                    "
                />
                <div class="radio-group" style="margin-top: 15px">
                    <label
                        class="radio-option"
                        style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 12px;
                            font-size: 16px;
                            cursor: pointer;
                            gap: 10px;
                            color: #5d4e41;
                        "
                    >
                        <input
                            type="radio"
                            name="editBeeRole"
                            value="Admin"
                            id="editAdminRole"
                            style="
                                accent-color: rgb(251, 183, 64);
                                width: 18px;
                                height: 18px;
                                cursor: pointer;
                            "
                        />
                        <span>Parent Bee</span>
                    </label>
                    <label
                        class="radio-option"
                        style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 12px;
                            font-size: 16px;
                            cursor: pointer;
                            gap: 10px;
                            color: #5d4e41;
                        "
                    >
                        <input
                            type="radio"
                            name="editBeeRole"
                            value="User"
                            id="editUserRole"
                            style="
                                accent-color: rgb(251, 183, 64);
                                width: 18px;
                                height: 18px;
                                cursor: pointer;
                            "
                        />
                        <span>Child Bee</span>
                    </label>
                </div>
                <p
                    id="editErrorMessage"
                    style="color: #d32f2f; font-size: 14px; display: none"
                >
                    Please enter a valid name
                </p>
                <div
                    class="modal-actions"
                    style="
                        display: flex;
                        gap: 10px;
                        justify-content: center;
                        margin-top: 20px;
                    "
                >
                    <button
                        id="savePermissionBtn"
                        style="
                            background: rgb(251, 183, 64);
                            color: #5d4e41;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        "
                    >
                        Save
                    </button>
                    <button
                        id="cancelEditBtn"
                        style="
                            background: #e4e3e0;
                            color: #5d4e41;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        "
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Add User Modal -->
        <div
            class="modal"
            id="addUserModal"
            style="
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(19, 19, 18, 0.4);
                z-index: 1001;
                justify-content: center;
                align-items: center;
            "
        >
            <div
                class="modal-content"
                style="
                    background: #fffff8;
                    padding: 25px;
                    border-radius: 15px;
                    width: 85%;
                    max-width: 400px;
                    text-align: center;
                    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
                    border: 2px solid #e4e3e0;
                    color: #5d4e41;
                "
            >
                <h3
                    style="
                        color: #5d4e41;
                        margin-bottom: 15px;
                        font-weight: 600;
                    "
                >
                    Add a Bee
                </h3>
                <input
                    type="text"
                    id="usernameInput"
                    placeholder="Bee name"
                    style="
                        width: 100%;
                        padding: 10px 12px;
                        margin: 10px 0;
                        background: #fffff8;
                        color: #5d4e41;
                        border: 2px solid #e4e3e0;
                        border-radius: 8px;
                        font-size: 16px;
                        outline: none;
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                    "
                />
                <div class="radio-group" style="margin-top: 15px">
                    <label
                        class="radio-option"
                        style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 12px;
                            font-size: 16px;
                            cursor: pointer;
                            gap: 10px;
                            color: #5d4e41;
                        "
                    >
                        <input
                            type="radio"
                            name="beeRole"
                            value="Admin"
                            style="
                                accent-color: rgb(251, 183, 64);
                                width: 18px;
                                height: 18px;
                                cursor: pointer;
                            "
                        />
                        <span>Parent Bee</span>
                    </label>
                    <label
                        class="radio-option"
                        style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 12px;
                            font-size: 16px;
                            cursor: pointer;
                            gap: 10px;
                            color: #5d4e41;
                        "
                    >
                        <input
                            type="radio"
                            name="beeRole"
                            value="User"
                            checked
                            style="
                                accent-color: rgb(251, 183, 64);
                                width: 18px;
                                height: 18px;
                                cursor: pointer;
                            "
                        />
                        <span>Child Bee</span>
                    </label>
                </div>
                <p
                    id="errorMessage"
                    style="color: #d32f2f; font-size: 14px; display: none"
                >
                    Please enter a valid name
                </p>
                <div
                    class="modal-actions"
                    style="
                        display: flex;
                        gap: 10px;
                        justify-content: center;
                        margin-top: 20px;
                    "
                >
                    <button
                        id="submitUserBtn"
                        style="
                            background: rgb(251, 183, 64);
                            color: #5d4e41;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        "
                    >
                        Add
                    </button>
                    <button
                        id="cancelUserBtn"
                        style="
                            background: #e4e3e0;
                            color: #5d4e41;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        "
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <script src="/BeeMazing-A1/shared/taskrotations.js?t=${Date.now()}"></script>
        <script src="/BeeMazing-A1/shared/avatar-system.js"></script>

        <script>
            // Append admin and user query parameters to Home link
            document.addEventListener("DOMContentLoaded", async () => {
                const homeLink = document.getElementById("homeLink");
                const urlParams = new URLSearchParams(window.location.search);
                let admin =
                    urlParams.get("admin") ||
                    localStorage.getItem("currentAdminEmail");
                let user =
                    urlParams.get("user") ||
                    localStorage.getItem("currentUser");

                if (admin) localStorage.setItem("currentAdminEmail", admin);
                if (user) localStorage.setItem("currentUser", user);

                // Initialize avatar system
                if (typeof window.avatarSystem === "undefined") {
                    window.avatarSystem = new AvatarSystem();
                    await window.avatarSystem.initialize(admin);
                }

                // Ensure avatar system is fully initialized before proceeding
                window.ensureAvatarSystemReady = async function () {
                    if (!window.avatarSystem) {
                        const admin = localStorage.getItem("currentAdminEmail");
                        window.avatarSystem = new AvatarSystem();
                        await window.avatarSystem.initialize(admin);
                    }
                };

                // AUTO-EDIT FUNCTIONS FOR OVERDUE TASKS
                async function checkAndTriggerOverdueEdit(targetDate) {
                    // Check localStorage for edit data
                    const editOverdueData = localStorage.getItem(
                        "familyApp_editOverdueTask",
                    );
                    const autoTrigger = localStorage.getItem(
                        "familyApp_autoTriggerEdit",
                    );

                    if (!editOverdueData || autoTrigger !== "true") {
                        console.log(
                            "No overdue edit data found or auto-trigger disabled",
                        );
                        return;
                    }

                    try {
                        const editData = JSON.parse(editOverdueData);
                        console.log(
                            "üîß Processing overdue task edit:",
                            editData,
                        );

                        if (
                            editData.source === "overdueTaskEdit" &&
                            editData.taskTitle
                        ) {
                            // Clear the localStorage items to prevent repeat triggers
                            localStorage.removeItem(
                                "familyApp_editOverdueTask",
                            );
                            localStorage.removeItem(
                                "familyApp_autoTriggerEdit",
                            );

                            // Set the correct date if provided
                            if (targetDate || editData.specificDate) {
                                const dateToSelect =
                                    targetDate || editData.specificDate;
                                await selectDateAndFindTask(
                                    dateToSelect,
                                    editData.taskTitle,
                                );
                            } else {
                                await findAndEditTask(editData.taskTitle);
                            }
                        }
                    } catch (error) {
                        console.error(
                            "Error processing overdue edit data:",
                            error,
                        );
                        // Clean up localStorage on error
                        localStorage.removeItem("familyApp_editOverdueTask");
                        localStorage.removeItem("familyApp_autoTriggerEdit");
                        removeLoadingOverlay();
                    }
                }

                async function selectDateAndFindTask(targetDate, taskTitle) {
                    console.log(
                        `üîß Selecting date ${targetDate} and finding task: ${taskTitle}`,
                    );

                    // First, select the correct date
                    const dayElements = document.querySelectorAll(".day");
                    let dateSelected = false;

                    dayElements.forEach((dayEl) => {
                        if (dayEl.dataset.date === targetDate) {
                            // Remove previous selection
                            document
                                .querySelectorAll(".day.selected")
                                .forEach((el) =>
                                    el.classList.remove("selected"),
                                );
                            // Select the target date
                            dayEl.classList.add("selected");
                            dateSelected = true;
                            console.log(`üìÖ Selected date: ${targetDate}`);
                        }
                    });

                    if (!dateSelected) {
                        console.warn(
                            `Date ${targetDate} not found in calendar`,
                        );
                    }

                    // Wait for tasks to load for the selected date
                    if (typeof window.loadTasksForDate === "function") {
                        await window.loadTasksForDate(targetDate);
                        console.log("üìã Tasks loaded for selected date");
                    }

                    // Wait a bit more for DOM to update
                    setTimeout(() => {
                        findAndEditTask(taskTitle);
                    }, 1000);
                }

                async function findAndEditTask(taskTitle) {
                    console.log(`üîç Looking for task: ${taskTitle}`);

                    // Find task elements using multiple selectors
                    const taskSelectors = [
                        ".task-item",
                        ".task-card",
                        "[data-task-title]",
                        ".task",
                    ];

                    let targetTask = null;

                    for (const selector of taskSelectors) {
                        const taskElements =
                            document.querySelectorAll(selector);
                        console.log(
                            `üîç Found ${taskElements.length} elements with selector: ${selector}`,
                        );

                        taskElements.forEach((taskEl) => {
                            // Try multiple ways to find the task title
                            const titleSelectors = [
                                ".task-title",
                                ".task-name",
                                "h3",
                                "h2",
                                "[data-task-title]",
                            ];

                            let titleElement = null;
                            let titleText = "";

                            // Try to find title element
                            for (const titleSelector of titleSelectors) {
                                titleElement =
                                    taskEl.querySelector(titleSelector);
                                if (titleElement) {
                                    titleText = titleElement.textContent.trim();
                                    break;
                                }
                            }

                            // Also check dataset
                            if (!titleText && taskEl.dataset.taskTitle) {
                                titleText = taskEl.dataset.taskTitle.trim();
                            }

                            // Also check if the task element itself contains the title
                            if (!titleText) {
                                titleText = taskEl.textContent.trim();
                            }

                            console.log(
                                `üîç Checking task with title: "${titleText}"`,
                            );

                            if (
                                titleText === taskTitle ||
                                titleText.includes(taskTitle)
                            ) {
                                targetTask = taskEl;
                                console.log(
                                    `‚úÖ Found matching task: ${titleText}`,
                                );
                            }
                        });

                        if (targetTask) break;
                    }

                    if (targetTask) {
                        console.log(
                            "üéØ Target task found, opening task card...",
                        );

                        // Click on the task to open its modal/card (but keep it hidden)
                        targetTask.click();

                        // Wait for modal to open, then find and click "Edit This Day"
                        setTimeout(() => {
                            triggerEditThisDay();
                        }, 800);
                    } else {
                        console.error(`‚ùå Task not found: "${taskTitle}"`);
                        console.log(
                            "Available tasks:",
                            Array.from(
                                document.querySelectorAll(".task-item"),
                            ).map((el) => {
                                const title = el.querySelector(".task-title");
                                return title
                                    ? title.textContent.trim()
                                    : "No title found";
                            }),
                        );

                        removeLoadingOverlay();
                        alert(
                            `Task "${taskTitle}" not found. Please make sure you're viewing the correct date.`,
                        );
                    }
                }

                function triggerEditThisDay() {
                    console.log('üîß Looking for "Edit This Day" button...');

                    // Wait for modal to be fully rendered
                    const waitForModal = (attempts = 0) => {
                        if (attempts > 10) {
                            console.error("‚ùå Modal took too long to load");
                            alert(
                                'Edit This Day button not found. The task card may have opened, please click "Edit This Day" manually.',
                            );
                            return;
                        }

                        // Check if modal exists
                        const modal = document.querySelector(".task-modal");
                        if (!modal) {
                            console.log(
                                `üîß Waiting for modal... attempt ${attempts + 1}`,
                            );
                            setTimeout(() => waitForModal(attempts + 1), 200);
                            return;
                        }

                        // Hide the modal from user view
                        modal.style.display = "none";
                        console.log(
                            "‚úÖ Modal found and hidden, looking for Edit This Day button...",
                        );

                        // Multiple selectors for the Edit This Day button (removed invalid :contains selector)
                        const editButtonSelectors = [
                            "#editOccurrenceBtn",
                            'button[id="editOccurrenceBtn"]',
                            ".edit-this-day-btn",
                            ".edit-occurrence-btn",
                        ];

                        let editButton = null;

                        // First try standard selectors
                        for (const selector of editButtonSelectors) {
                            editButton = modal.querySelector(selector);
                            if (editButton) {
                                console.log(
                                    `‚úÖ Found Edit This Day button with selector: ${selector}`,
                                );
                                break;
                            }
                        }

                        // If not found by selector, search by text content
                        if (!editButton) {
                            console.log(
                                "üîß Searching buttons by text content...",
                            );
                            const allButtons = modal.querySelectorAll("button");
                            console.log(
                                `üîß Found ${allButtons.length} buttons in modal`,
                            );

                            allButtons.forEach((btn, index) => {
                                const btnText = btn.textContent
                                    .trim()
                                    .toLowerCase();
                                console.log(
                                    `üîß Button ${index + 1}: "${btn.textContent.trim()}" (ID: ${btn.id})`,
                                );

                                if (
                                    btnText.includes("edit this day") ||
                                    btnText === "edit this day"
                                ) {
                                    editButton = btn;
                                    console.log(
                                        "‚úÖ Found Edit This Day button by text content",
                                    );
                                }
                            });
                        }

                        if (editButton) {
                            console.log(
                                'üéØ Clicking "Edit This Day" button...',
                            );
                            editButton.click();

                            // Wait for edit form to load, then remove overlay
                            setTimeout(() => {
                                console.log(
                                    "‚úÖ Auto-edit process completed successfully!",
                                );
                                // Clean up hidden modal
                                const hiddenModal = document.querySelector(
                                    '.task-modal[style*="display: none"]',
                                );
                                if (hiddenModal) {
                                    hiddenModal.remove();
                                }
                                removeLoadingOverlay();
                            }, 1000);
                        } else {
                            console.error(
                                '‚ùå "Edit This Day" button not found in modal',
                            );
                            console.log(
                                "Available buttons in modal:",
                                Array.from(
                                    modal.querySelectorAll("button"),
                                ).map(
                                    (btn) =>
                                        `"${btn.textContent.trim()}" (ID: ${btn.id})`,
                                ),
                            );

                            removeLoadingOverlay();
                            alert(
                                'Edit This Day button not found. The task card may have opened, please click "Edit This Day" manually.',
                            );
                        }
                    };

                    // Start the modal waiting process
                    waitForModal();
                }

                // Function to create loading overlay
                function createLoadingOverlay() {
                    const overlay = document.createElement("div");
                    overlay.id = "autoEditOverlay";
                    overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #FFFFFF;
                z-index: 9999;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                font-family: 'Poppins', sans-serif;
            `;

                    overlay.innerHTML = `
                <div style="text-align: center;">
                    <div style="width: 60px; height: 60px; border: 4px solid #FFC107; border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <h3 style="color: #6D4C41; margin: 0 0 10px 0; font-size: 18px; font-weight: 600;">Opening Task Editor</h3>
                    <p style="color: #795548; margin: 0; font-size: 14px;">Please wait...</p>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;

                    document.body.appendChild(overlay);
                }

                function removeLoadingOverlay() {
                    const overlay = document.getElementById("autoEditOverlay");
                    if (overlay) {
                        overlay.remove();
                    }
                }

                console.log(
                    "üîß Auto-edit functionality loaded for overdue tasks",
                );

                // AUTO-EDIT FUNCTIONALITY FOR OVERDUE TASKS
                // Check URL parameters for auto-edit trigger
                const autoEdit = urlParams.get("autoEdit");
                const targetDate = urlParams.get("date");

                if (autoEdit === "true") {
                    // Hide the page content and show loading overlay
                    createLoadingOverlay();

                    // Wait for page to fully load, then check for overdue task edit
                    setTimeout(() => {
                        checkAndTriggerOverdueEdit(targetDate);
                    }, 1500);
                }

                // Add debugging functions for testing task deletion
                window.debugTaskStatus = async function (titlePattern) {
                    console.log("üö® TASK STATUS CHECK! üö®");

                    const currentAdmin =
                        localStorage.getItem("currentAdminEmail");
                    if (!currentAdmin) {
                        console.error("üîß No admin email found!");
                        return;
                    }

                    try {
                        const response = await fetch(
                            `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(currentAdmin)}&t=${Date.now()}`,
                            { cache: "no-store" },
                        );
                        if (!response.ok) {
                            throw new Error("Failed to fetch tasks");
                        }

                        const result = await response.json();
                        const matchingTasks = result.tasks.filter((t) =>
                            t.title.includes(titlePattern || "Multiple"),
                        );

                        console.log(
                            `üîß Found ${matchingTasks.length} tasks matching "${titlePattern || "Multiple"}"`,
                        );
                        matchingTasks.forEach((task) => {
                            console.log("üîß Task:", {
                                title: task.title,
                                date: task.date,
                                originalTitle: task.originalTitle,
                                occurrence: task.occurrence,
                                totalOccurrences: task.totalOccurrences,
                                timesPerDay: task.timesPerDay,
                            });
                        });

                        return matchingTasks;
                    } catch (error) {
                        console.error("üîß Status check failed:", error);
                    }
                };

                console.log("üîß Added debugging functions:");
                console.log(
                    "  - debugTaskStatus(titlePattern) - Check current tasks",
                );
                console.log(
                    "  - debugDeleteOccurrences(originalTitle, dateRange) - Test deletion",
                );
                console.log(
                    "  - debugCleanupDuplicates() - Remove duplicate tasks",
                );
                console.log(
                    "  - debugDeleteAllMatching('pattern') - Delete all tasks matching pattern",
                );
                console.log(
                    "  - debugDisplayIssue() - Check why tasks aren't showing in UI",
                );

                // fallback if still missing
                if (!admin || !user) {
                    console.warn("Missing admin or user in query or storage.");
                }

                if (admin && user) {
                    homeLink.href = `/BeeMazing-A1/mobile/2-UserProfiles/userAdmin.html?admin=${encodeURIComponent(admin)}&user=${encodeURIComponent(user)}`;
                } else {
                    console.warn("Admin or user missing for homeLink", {
                        admin,
                        user,
                    });
                }

                const logoutBtn = document.getElementById("logoutBtn");
                if (logoutBtn) {
                    console.log("Logout button found, adding event listener");
                    logoutBtn.addEventListener("click", () => {
                        console.log("Logout button clicked");
                        // Only remove login session info
                        localStorage.removeItem("isAdmin");
                        localStorage.removeItem("userData");
                        localStorage.removeItem("adminPassword");
                        // Keep currentAdminEmail as per home.js
                        window.location.href = "/BeeMazing-A1/login.html";
                    });
                } else {
                    console.log("Logout button not found");
                }

                // Profile icon functionality
                const profileIcon = document.getElementById("profileIcon");
                const userSelectModal =
                    document.getElementById("userSelectModal");
                const userList = document.getElementById("userList");
                const closeModalBtn = document.getElementById("closeModalBtn");

                if (profileIcon) {
                    profileIcon.addEventListener("click", async (event) => {
                        event.preventDefault();
                        event.stopPropagation();

                        if (!admin) {
                            alert(
                                "Admin email not found. Please log in again.",
                            );
                            return;
                        }

                        try {
                            const res = await fetch(
                                `https://beemazing1.onrender.com/get-users?adminEmail=${encodeURIComponent(admin)}`,
                            );
                            const data = await res.json();
                            if (!res.ok || !data.users)
                                throw new Error("Failed to fetch users");

                            const allUserData =
                                JSON.parse(localStorage.getItem("userData")) ||
                                {};
                            const userPermissions =
                                allUserData[admin]?.permissions ||
                                data.permissions ||
                                {};

                            userList.innerHTML = "";

                            data.users.forEach((userName) => {
                                const li = document.createElement("li");
                                li.style.setProperty(
                                    "color",
                                    "#5D4E41",
                                    "important",
                                );

                                const nameContainer =
                                    document.createElement("div");
                                nameContainer.classList.add("user-list-item");
                                const userNameSpan =
                                    document.createElement("span");
                                userNameSpan.textContent = userName;
                                userNameSpan.style.setProperty(
                                    "color",
                                    "#5D4E41",
                                    "important",
                                );
                                nameContainer.appendChild(userNameSpan);

                                if (userPermissions[userName] === "Admin") {
                                    const checkmark =
                                        document.createElement("span");
                                    checkmark.textContent = "‚úì";
                                    checkmark.style.color = "#00C4B4";
                                    checkmark.style.fontSize = "16px";
                                    checkmark.style.fontWeight = "bold";
                                    checkmark.title = "Admin";
                                    nameContainer.appendChild(checkmark);
                                }

                                li.appendChild(nameContainer);

                                // Add settings and delete buttons
                                const isLoggedInAsAdmin =
                                    localStorage.getItem("isAdmin") === "true";
                                if (isLoggedInAsAdmin) {
                                    const actionsContainer =
                                        document.createElement("div");
                                    actionsContainer.style.setProperty(
                                        "display",
                                        "flex",
                                        "important",
                                    );
                                    actionsContainer.style.setProperty(
                                        "gap",
                                        "8px",
                                        "important",
                                    );

                                    const editBtn =
                                        document.createElement("button");
                                    editBtn.innerHTML = "‚öôÔ∏è";
                                    editBtn.style.setProperty(
                                        "background",
                                        "rgb(251, 183, 64)",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "color",
                                        "rgb(245, 245, 220)",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "border",
                                        "none",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "border-radius",
                                        "50%",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "width",
                                        "30px",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "height",
                                        "30px",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "font-size",
                                        "14px",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "cursor",
                                        "pointer",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "display",
                                        "flex",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "align-items",
                                        "center",
                                        "important",
                                    );
                                    editBtn.style.setProperty(
                                        "justify-content",
                                        "center",
                                        "important",
                                    );
                                    editBtn.onmouseover = function () {
                                        this.style.setProperty(
                                            "background",
                                            "#5D4E41",
                                            "important",
                                        );
                                        this.style.setProperty(
                                            "background-color",
                                            "#5D4E41",
                                            "important",
                                        );
                                    };
                                    editBtn.onmouseout = function () {
                                        this.style.setProperty(
                                            "background",
                                            "rgb(251, 183, 64)",
                                            "important",
                                        );
                                        this.style.setProperty(
                                            "background-color",
                                            "rgb(251, 183, 64)",
                                            "important",
                                        );
                                    };
                                    editBtn.addEventListener(
                                        "click",
                                        (event) => {
                                            event.stopPropagation();
                                            showPermissionModal(userName);
                                        },
                                    );

                                    const removeBtn =
                                        document.createElement("button");
                                    removeBtn.textContent = "X";
                                    removeBtn.style.setProperty(
                                        "background",
                                        "rgb(251, 183, 64)",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "color",
                                        "rgb(245, 245, 220)",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "border",
                                        "none",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "border-radius",
                                        "50%",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "width",
                                        "30px",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "height",
                                        "30px",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "font-size",
                                        "14px",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "font-weight",
                                        "bold",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "cursor",
                                        "pointer",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "display",
                                        "flex",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "align-items",
                                        "center",
                                        "important",
                                    );
                                    removeBtn.style.setProperty(
                                        "justify-content",
                                        "center",
                                        "important",
                                    );
                                    removeBtn.onmouseover = function () {
                                        this.style.setProperty(
                                            "background",
                                            "#5D4E41",
                                            "important",
                                        );
                                        this.style.setProperty(
                                            "background-color",
                                            "#5D4E41",
                                            "important",
                                        );
                                    };
                                    removeBtn.onmouseout = function () {
                                        this.style.setProperty(
                                            "background",
                                            "rgb(251, 183, 64)",
                                            "important",
                                        );
                                        this.style.setProperty(
                                            "background-color",
                                            "rgb(251, 183, 64)",
                                            "important",
                                        );
                                    };
                                    removeBtn.addEventListener(
                                        "click",
                                        (event) => {
                                            event.stopPropagation();
                                            showConfirmModal(userName);
                                        },
                                    );

                                    actionsContainer.appendChild(editBtn);
                                    actionsContainer.appendChild(removeBtn);
                                    li.appendChild(actionsContainer);
                                }

                                // Highlight current user
                                if (userName === user) {
                                    li.classList.add("active-user");
                                    li.style.setProperty(
                                        "background-color",
                                        "rgb(251, 183, 64)",
                                        "important",
                                    );
                                    li.style.setProperty(
                                        "background",
                                        "rgb(251, 183, 64)",
                                        "important",
                                    );
                                    li.style.setProperty(
                                        "color",
                                        "#5D4E41",
                                        "important",
                                    );
                                    li.style.setProperty(
                                        "font-weight",
                                        "600",
                                        "important",
                                    );
                                }

                                li.addEventListener("click", async () => {
                                    const isAdminUser =
                                        userPermissions[userName] === "Admin";
                                    const basePath = "/BeeMazing-A1/mobile";
                                    const isLoggedInAsAdmin =
                                        localStorage.getItem("isAdmin") ===
                                        "true";

                                    if (isAdminUser) {
                                        if (isLoggedInAsAdmin) {
                                            window.location.href = `${basePath}/2-UserProfiles/userAdmin.html?admin=${encodeURIComponent(admin)}&user=${encodeURIComponent(userName)}`;
                                        } else {
                                            const enteredPassword = prompt(
                                                "Enter Parent Password to access Admin profile:",
                                            );
                                            if (!enteredPassword) {
                                                alert(
                                                    "Password is required to access Admin profile.",
                                                );
                                                return;
                                            }
                                            try {
                                                const res = await fetch(
                                                    `https://beemazing1.onrender.com/verify-admin-password`,
                                                    {
                                                        method: "POST",
                                                        headers: {
                                                            "Content-Type":
                                                                "application/json",
                                                        },
                                                        body: JSON.stringify({
                                                            email: admin,
                                                            password:
                                                                enteredPassword,
                                                        }),
                                                    },
                                                );
                                                const data = await res.json();
                                                if (res.ok && data.success) {
                                                    window.location.href = `${basePath}/2-UserProfiles/userAdmin.html?admin=${encodeURIComponent(admin)}&user=${encodeURIComponent(userName)}`;
                                                } else {
                                                    alert(
                                                        data.message ||
                                                            "Incorrect password. Access denied.",
                                                    );
                                                }
                                            } catch (err) {
                                                console.error(
                                                    "Error verifying admin password:",
                                                    err,
                                                );
                                                alert(
                                                    "Failed to verify password. Please check your connection.",
                                                );
                                            }
                                        }
                                    } else {
                                        window.location.href = `${basePath}/2-UserProfiles/users.html?admin=${encodeURIComponent(admin)}&user=${encodeURIComponent(userName)}`;
                                    }
                                });

                                userList.appendChild(li);
                            });

                            // Show modal with force inline styles
                            userSelectModal.style.display = "block";
                            userSelectModal.style.opacity = "1";
                            userSelectModal.classList.add("show");

                            const bottomSheetContent =
                                userSelectModal.querySelector(
                                    ".bottom-sheet-content",
                                );
                            if (bottomSheetContent) {
                                bottomSheetContent.style.transform =
                                    "translateY(0)";
                            }
                        } catch (err) {
                            console.error("Failed to load users:", err);
                            userList.innerHTML =
                                '<li style="padding: 15px; color: #D32F2F;">Failed to load users</li>';
                            userSelectModal.style.display = "block";
                            userSelectModal.style.opacity = "1";
                            userSelectModal.classList.add("show");
                        }
                    });
                }

                // Modal close functionality
                if (userSelectModal) {
                    userSelectModal.addEventListener("click", (e) => {
                        if (e.target === userSelectModal) {
                            userSelectModal.style.display = "none";
                            userSelectModal.style.opacity = "0";
                            userSelectModal.classList.remove("show");
                            const bottomSheetContent =
                                userSelectModal.querySelector(
                                    ".bottom-sheet-content",
                                );
                            if (bottomSheetContent) {
                                bottomSheetContent.style.transform =
                                    "translateY(100%)";
                            }
                        }
                    });
                }

                if (closeModalBtn) {
                    closeModalBtn.addEventListener("click", () => {
                        userSelectModal.style.display = "none";
                        userSelectModal.style.opacity = "0";
                        userSelectModal.classList.remove("show");
                        const bottomSheetContent =
                            userSelectModal.querySelector(
                                ".bottom-sheet-content",
                            );
                        if (bottomSheetContent) {
                            bottomSheetContent.style.transform =
                                "translateY(100%)";
                        }
                    });
                }

                // Global variables for modal functionality
                let userToRemove = null;
                let selectedUserForPermission = null;

                // Modal functionality functions
                function showConfirmModal(username) {
                    userToRemove = username;
                    const confirmModal =
                        document.getElementById("confirmModal");
                    confirmModal.style.display = "flex";
                }

                function showPermissionModal(username) {
                    selectedUserForPermission = username;
                    const permissionModalUser = document.getElementById(
                        "permissionModalUser",
                    );
                    const editUserNameInput =
                        document.getElementById("editUserNameInput");
                    const editAdminRole =
                        document.getElementById("editAdminRole");
                    const editUserRole =
                        document.getElementById("editUserRole");
                    const editErrorMessage =
                        document.getElementById("editErrorMessage");

                    permissionModalUser.textContent = `Edit Bee`;
                    editUserNameInput.value = username;
                    editErrorMessage.style.display = "none";

                    const allUserData =
                        JSON.parse(localStorage.getItem("userData")) || {};
                    const userPermissions =
                        allUserData[admin]?.permissions || {};
                    const currentRole = userPermissions[username] || "User";

                    if (currentRole === "Admin") {
                        editAdminRole.checked = true;
                    } else {
                        editUserRole.checked = true;
                    }

                    const permissionModal =
                        document.getElementById("permissionModal");
                    permissionModal.style.display = "flex";
                }

                // Delete user from server function
                async function deleteUserFromServer(username) {
                    try {
                        const res = await fetch(
                            `https://beemazing1.onrender.com/delete-user?adminEmail=${encodeURIComponent(admin)}&username=${encodeURIComponent(username)}`,
                            {
                                method: "DELETE",
                                headers: { "Content-Type": "application/json" },
                            },
                        );
                        const result = await res.json();
                        if (result.success) {
                            // Update localStorage after successful server deletion
                            const allUserData =
                                JSON.parse(localStorage.getItem("userData")) ||
                                {};
                            let users = allUserData[admin]?.users || [];
                            users = users.filter((user) => user !== username);
                            if (!allUserData[admin]) {
                                allUserData[admin] = {
                                    users: [],
                                    permissions: {},
                                };
                            }
                            allUserData[admin].users = users;
                            localStorage.setItem(
                                "userData",
                                JSON.stringify(allUserData),
                            );
                            return true;
                        } else {
                            alert(
                                "Failed to delete user from server: " +
                                    result.message,
                            );
                            return false;
                        }
                    } catch (err) {
                        alert("Error deleting user. Please try again.");
                        return false;
                    }
                }

                // Add User button functionality
                const addUserBtnInModal = document.getElementById("addUserBtn");
                const addUserModal = document.getElementById("addUserModal");
                const submitUserBtn = document.getElementById("submitUserBtn");
                const cancelUserBtn = document.getElementById("cancelUserBtn");
                const usernameInput = document.getElementById("usernameInput");
                const errorMessage = document.getElementById("errorMessage");

                if (addUserBtnInModal) {
                    addUserBtnInModal.addEventListener("click", () => {
                        addUserModal.style.display = "flex";
                        usernameInput.value = "";
                        errorMessage.style.display = "none";
                        document.querySelector(
                            'input[name="beeRole"][value="User"]',
                        ).checked = true;
                    });
                }

                if (cancelUserBtn) {
                    cancelUserBtn.addEventListener("click", () => {
                        addUserModal.style.display = "none";
                    });
                }

                // Add user modal click outside to close
                if (addUserModal) {
                    addUserModal.addEventListener("click", (e) => {
                        if (e.target === addUserModal) {
                            addUserModal.style.display = "none";
                        }
                    });
                }

                // Submit new user
                if (submitUserBtn) {
                    submitUserBtn.addEventListener("click", async () => {
                        const username = usernameInput.value.trim();

                        if (!username) {
                            errorMessage.style.display = "block";
                            return;
                        }

                        if (!admin) {
                            alert(
                                "Error: Admin session expired. Please log in again.",
                            );
                            window.location.href = "/BeeMazing-A1/login.html";
                            return;
                        }

                        errorMessage.style.display = "none";
                        const selectedRole =
                            document.querySelector(
                                'input[name="beeRole"]:checked',
                            )?.value || "User";

                        try {
                            const res = await fetch(
                                "https://beemazing1.onrender.com/add-user",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        adminEmail: admin,
                                        newUser: username,
                                        role: selectedRole,
                                    }),
                                },
                            );

                            const result = await res.json();

                            if (result.success) {
                                const allUserData =
                                    JSON.parse(
                                        localStorage.getItem("userData"),
                                    ) || {};
                                if (!allUserData[admin]) {
                                    allUserData[admin] = {
                                        users: [],
                                        permissions: {},
                                    };
                                }

                                allUserData[admin].users.push(username);
                                allUserData[admin].permissions[username] =
                                    selectedRole;
                                localStorage.setItem(
                                    "userData",
                                    JSON.stringify(allUserData),
                                );

                                addUserModal.style.display = "none";
                                alert(
                                    `${username} has been added as a ${selectedRole}!`,
                                );

                                // Refresh the user list by clicking profile icon again
                                profileIcon.click();
                            } else {
                                alert("Failed to add user: " + result.message);
                            }
                        } catch (err) {
                            alert("Error adding user. Please try again.");
                        }
                    });
                }

                // Confirm Delete Modal event listeners
                const confirmModal = document.getElementById("confirmModal");
                const confirmYesBtn = document.getElementById("confirmYesBtn");
                const confirmNoBtn = document.getElementById("confirmNoBtn");

                confirmYesBtn.addEventListener("click", async () => {
                    if (userToRemove) {
                        const success =
                            await deleteUserFromServer(userToRemove);
                        if (success) {
                            userToRemove = null;
                            confirmModal.style.display = "none";
                            // Refresh the user list by clicking profile icon again
                            profileIcon.click();
                        }
                    }
                });

                confirmNoBtn.addEventListener("click", () => {
                    userToRemove = null;
                    confirmModal.style.display = "none";
                });

                confirmModal.addEventListener("click", (e) => {
                    if (e.target === confirmModal) {
                        userToRemove = null;
                        confirmModal.style.display = "none";
                    }
                });

                // Permission Modal event listeners
                const permissionModal =
                    document.getElementById("permissionModal");
                const savePermissionBtn =
                    document.getElementById("savePermissionBtn");

                if (savePermissionBtn) {
                    savePermissionBtn.addEventListener("click", async () => {
                        if (selectedUserForPermission) {
                            const editUserNameInput =
                                document.getElementById("editUserNameInput");
                            const editErrorMessage =
                                document.getElementById("editErrorMessage");
                            const newName = editUserNameInput.value.trim();

                            if (!newName) {
                                editErrorMessage.style.display = "block";
                                return;
                            }

                            editErrorMessage.style.display = "none";
                            const newPermission =
                                document.querySelector(
                                    'input[name="editBeeRole"]:checked',
                                )?.value || "User";
                            const oldName = selectedUserForPermission;

                            try {
                                const roleText =
                                    newPermission === "Admin"
                                        ? "Parent Bee"
                                        : "Child Bee";

                                // If name changed, delete old user and add new one
                                if (oldName !== newName) {
                                    // Delete old user
                                    const deleteRes = await fetch(
                                        `https://beemazing1.onrender.com/delete-user?adminEmail=${encodeURIComponent(admin)}&username=${encodeURIComponent(oldName)}`,
                                        {
                                            method: "DELETE",
                                            headers: {
                                                "Content-Type":
                                                    "application/json",
                                            },
                                        },
                                    );
                                    const addRes = await fetch(
                                        "https://beemazing1.onrender.com/add-user",
                                        {
                                            method: "POST",
                                            headers: {
                                                "Content-Type":
                                                    "application/json",
                                            },
                                            body: JSON.stringify({
                                                adminEmail: admin,
                                                newUser: newName,
                                                role: newPermission,
                                            }),
                                        },
                                    );

                                    const addResult = await addRes.json();
                                    if (addResult.success) {
                                        alert(
                                            `User updated! Name changed to "${newName}" and role set to ${roleText}.`,
                                        );
                                    } else {
                                        alert(
                                            "Failed to update user name: " +
                                                addResult.message,
                                        );
                                    }
                                } else {
                                    // Only role changed, update permissions
                                    const allUserData =
                                        JSON.parse(
                                            localStorage.getItem("userData"),
                                        ) || {};
                                    if (!allUserData[admin]) {
                                        allUserData[admin] = {
                                            users: [],
                                            permissions: {},
                                        };
                                    }
                                    allUserData[admin].permissions[newName] =
                                        newPermission;
                                    localStorage.setItem(
                                        "userData",
                                        JSON.stringify(allUserData),
                                    );

                                    const res = await fetch(
                                        "https://beemazing1.onrender.com/save-permissions",
                                        {
                                            method: "POST",
                                            headers: {
                                                "Content-Type":
                                                    "application/json",
                                            },
                                            body: JSON.stringify({
                                                adminEmail: admin,
                                                permissions:
                                                    allUserData[admin]
                                                        .permissions,
                                            }),
                                        },
                                    );
                                    const result = await res.json();

                                    if (result.success) {
                                        alert(
                                            `User updated! ${newName} is now a ${roleText}.`,
                                        );
                                    } else {
                                        alert(
                                            `Local changes saved. Role updated to ${roleText}.`,
                                        );
                                    }
                                }

                                // Update localStorage regardless
                                const allUserData =
                                    JSON.parse(
                                        localStorage.getItem("userData"),
                                    ) || {};
                                if (!allUserData[admin]) {
                                    allUserData[admin] = {
                                        users: [],
                                        permissions: {},
                                    };
                                }

                                if (oldName !== newName) {
                                    const userIndex =
                                        allUserData[admin].users.indexOf(
                                            oldName,
                                        );
                                    if (userIndex !== -1) {
                                        allUserData[admin].users[userIndex] =
                                            newName;
                                    }
                                    delete allUserData[admin].permissions[
                                        oldName
                                    ];
                                }
                                allUserData[admin].permissions[newName] =
                                    newPermission;
                                localStorage.setItem(
                                    "userData",
                                    JSON.stringify(allUserData),
                                );
                            } catch (err) {
                                const roleText =
                                    newPermission === "Admin"
                                        ? "Parent Bee"
                                        : "Child Bee";
                                alert(`Error updating user. Please try again.`);
                            }

                            selectedUserForPermission = null;
                            permissionModal.style.display = "none";
                            profileIcon.click();
                        }
                    });
                }

                // Cancel edit button
                const cancelEditBtn = document.getElementById("cancelEditBtn");
                if (cancelEditBtn) {
                    cancelEditBtn.addEventListener("click", () => {
                        selectedUserForPermission = null;
                        permissionModal.style.display = "none";
                    });
                }

                permissionModal.addEventListener("click", (e) => {
                    if (e.target === permissionModal) {
                        selectedUserForPermission = null;
                        permissionModal.style.display = "none";
                    }
                });
            });

            document
                .getElementById("addTaskBtn")
                .addEventListener("click", () => {
                    localStorage.removeItem("familyApp_editTask");
                    localStorage.removeItem("familyApp_editTask_index");
                    const admin = localStorage.getItem("currentAdminEmail");
                    const user = localStorage.getItem("currentUser");
                    if (admin && user) {
                        window.location.href = `/BeeMazing-A1/mobile/3-Tasks/addtasks.html?admin=${encodeURIComponent(admin)}&user=${encodeURIComponent(user)}`;
                    } else {
                        alert(
                            "Admin or user information missing. Please log in again.",
                        );
                    }
                });

            // Verify taskrotations.js load
            fetch("/BeeMazing-A1/shared/taskrotations.js?t=" + Date.now(), {
                method: "HEAD",
            })
                .then((response) => {
                    if (!response.ok) {
                        console.error(
                            `Failed to fetch taskrotations.js: HTTP ${response.status}`,
                        );
                    } else {
                        console.log("taskrotations.js is accessible");
                    }
                })
                .catch((err) =>
                    console.error("Error fetching taskrotations.js:", err),
                );

            if (
                typeof mixedTurnData === "undefined" ||
                typeof individualTurnData === "undefined" ||
                typeof filterTasksForDate === "undefined"
            ) {
                console.error(
                    "taskrotations.js failed to load or does not contain required functions (mixedTurnData/individualTurnData/filterTasksForDate)",
                );
            } else {
                console.log(
                    "taskrotations.js loaded successfully with all required functions",
                );
            }

            // Dynamically highlight the active footer icon
            document.querySelectorAll(".footer a").forEach((link) => {
                const currentPath = window.location.pathname.replace(/\/$/, "");
                const linkPath = new URL(link.href).pathname.replace(/\/$/, "");
                if (currentPath === linkPath) {
                    link.classList.add("active");
                } else {
                    link.classList.remove("active");
                }
            });

            // Helper to format dates as YYYY-MM-DD
            const formatDate = (d) => d.toISOString().split("T")[0];

            // addtasks.html Settings: Rotation //////////////////////////////////////////////////////////////////////////////////////////

            // Load tasks for a specific date
            async function loadTasksForDate(selectedDate) {
                // Ensure avatar system is ready before loading tasks
                if (window.ensureAvatarSystemReady) {
                    await window.ensureAvatarSystemReady();
                }

                const adminEmail = localStorage.getItem("currentAdminEmail");
                if (!adminEmail) {
                    document.getElementById("taskList").innerHTML =
                        `<div style="text-align:center; margin-top: 40px; color: #ccc;">No admin email found üåô</div>`;
                    return;
                }

                try {
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({
                            error: `HTTP error ${response.status}`,
                        }));
                        throw new Error(
                            `Failed to fetch tasks: ${errorData.error || response.statusText}`,
                        );
                    }
                    const result = await response.json();
                    const tasks = result.tasks || [];

                    // Enhanced debugging for raw backend response
                    console.log(`üîç RAW BACKEND RESPONSE for ${selectedDate}:`);
                    console.log(`üì° Response status: ${response.status}`);
                    console.log(`üì° Total tasks in response: ${tasks.length}`);
                    tasks.forEach((task) => {
                        if (task.title && task.title.includes("final")) {
                            console.log(`üì° RAW Task "${task.title}":`, task);
                            console.log(
                                `üì° RAW completions:`,
                                task.completions,
                            );
                            console.log(
                                `üì° RAW pendingCompletions:`,
                                task.pendingCompletions,
                            );
                        }
                    });

                    // Enhanced debugging for completion data
                    console.log(
                        `üîç COMPLETION DATA DEBUG for ${selectedDate}:`,
                    );
                    console.log(`üìä Total tasks received: ${tasks.length}`);
                    tasks.forEach((task) => {
                        const completions = task.completions || {};
                        const todayCompletions =
                            completions[selectedDate] || [];
                        if (todayCompletions.length > 0) {
                            console.log(
                                `  ‚úÖ Task "${task.title}" has ${todayCompletions.length} completion(s):`,
                                todayCompletions,
                            );
                            // Check if completions are pending or approved
                            const pending = todayCompletions.filter(
                                (c) => c.isPending,
                            );
                            const approved = todayCompletions.filter(
                                (c) => !c.isPending,
                            );
                            console.log(
                                `    - Pending: ${pending.length}, Approved: ${approved.length}`,
                            );
                        } else {
                            console.log(
                                `  ‚ùå Task "${task.title}" has NO completions for ${selectedDate}`,
                            );
                            // Show if there are completions for other dates
                            const otherDates = Object.keys(completions);
                            if (otherDates.length > 0) {
                                console.log(
                                    `    - Has completions for other dates: ${otherDates.join(", ")}`,
                                );
                            }
                        }
                    });

                    // Debug functions - available in console
                    window.debugTaskCompletion = function (
                        taskTitle,
                        userName,
                        date,
                    ) {
                        console.log(
                            `üß™ DEBUG: Testing task completion for "${taskTitle}"`,
                        );
                        const adminEmail =
                            localStorage.getItem("currentAdminEmail");
                        const testDate = date || selectedDate;
                        const testUser =
                            userName || localStorage.getItem("currentUser");

                        fetch(
                            "https://beemazing1.onrender.com/api/complete-task",
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    adminEmail: adminEmail,
                                    taskTitle: taskTitle,
                                    user: testUser,
                                    date: testDate,
                                    parentApproval: false,
                                }),
                            },
                        )
                            .then((response) => {
                                console.log(
                                    `üìä Response status: ${response.status}`,
                                );
                                return response.json().then((data) => ({
                                    status: response.status,
                                    data,
                                }));
                            })
                            .then(({ status, data }) => {
                                console.log(`üìä Response data:`, data);
                                if (status >= 400) {
                                    console.log(
                                        `‚ùå Error response - this might indicate task is already complete`,
                                    );
                                } else {
                                    console.log(`‚úÖ Success response`);
                                }

                                // Refresh tasks after test
                                setTimeout(
                                    () => loadTasksForDate(testDate),
                                    500,
                                );
                            })
                            .catch((error) => {
                                console.error(`‚ùå Request failed:`, error);
                            });
                    };

                    window.debugTaskData = function (taskTitle) {
                        const task = tasks.find((t) => t.title === taskTitle);
                        if (task) {
                            console.log(
                                `üîç Task data for "${taskTitle}":`,
                                task,
                            );
                            console.log(`üîç Completions:`, task.completions);
                            console.log(
                                `üîç Completions for ${selectedDate}:`,
                                task.completions?.[selectedDate],
                            );
                        } else {
                            console.log(`‚ùå Task "${taskTitle}" not found`);
                            console.log(
                                `Available tasks:`,
                                tasks.map((t) => t.title),
                            );
                        }
                    };

                    // Force refresh function for manual testing
                    window.forceRefreshTasks = function () {
                        console.log(
                            "üîÑ FORCE REFRESH: Manually refreshing all task data",
                        );
                        const selectedDateElement =
                            document.querySelector(".day.selected");
                        const currentSelectedDate = selectedDateElement
                            ? selectedDateElement.dataset.date
                            : new Date().toISOString().split("T")[0];

                        // Add visual feedback
                        const refreshBtn =
                            document.querySelector(".refresh-btn");
                        if (refreshBtn) {
                            refreshBtn.style.transform =
                                "scale(0.95) rotate(180deg)";
                            setTimeout(() => {
                                refreshBtn.style.transform = "";
                            }, 300);
                        }

                        loadTasksForDate(currentSelectedDate);
                    };

                    // Comprehensive debugging function for completion flow
                    window.debugCompletionFlow = function (taskTitle) {
                        console.log(
                            "üîç DEBUGGING COMPLETION FLOW for:",
                            taskTitle,
                        );
                        const selectedDateElement =
                            document.querySelector(".day.selected");
                        const selectedDate = selectedDateElement
                            ? selectedDateElement.dataset.date
                            : new Date().toISOString().split("T")[0];
                        const adminEmail =
                            localStorage.getItem("currentAdminEmail");

                        // Check current task status with forced fresh fetch
                        fetch(
                            `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                            {
                                cache: "no-store",
                                headers: {
                                    "Cache-Control": "no-cache",
                                    Pragma: "no-cache",
                                },
                            },
                        )
                            .then((response) => {
                                console.log("üì° RAW BACKEND RESPONSE:");
                                console.log(
                                    "üì° Response status:",
                                    response.status,
                                );
                                return response.json();
                            })
                            .then((result) => {
                                console.log(
                                    "üì° Total tasks in response:",
                                    result.tasks.length,
                                );

                                const task = result.tasks.find(
                                    (t) => t.title === taskTitle,
                                );
                                if (task) {
                                    console.log("üì° RAW Task data:", task);
                                    console.log(
                                        "üì° RAW completions:",
                                        task.completions,
                                    );
                                    console.log(
                                        "üì° RAW pendingCompletions:",
                                        task.pendingCompletions,
                                    );

                                    console.log(
                                        "üìä BEFORE - Task found:",
                                        task.title,
                                    );
                                    console.log(
                                        "üìä BEFORE - All completions:",
                                        task.completions,
                                    );
                                    console.log(
                                        "üìä BEFORE - Completions for",
                                        selectedDate,
                                        ":",
                                        task.completions?.[selectedDate] || [],
                                    );

                                    const completions =
                                        task.completions?.[selectedDate] || [];
                                    const pending = completions.filter(
                                        (c) => c.isPending,
                                    );
                                    const approved = completions.filter(
                                        (c) => !c.isPending,
                                    );
                                    console.log(
                                        "üìä BEFORE - Status: Pending:",
                                        pending.length,
                                        "Approved:",
                                        approved.length,
                                    );

                                    // Check UI status icon
                                    const taskCards =
                                        document.querySelectorAll(".task-item");
                                    taskCards.forEach((card) => {
                                        if (
                                            card
                                                .querySelector(".task-title")
                                                .textContent.includes(taskTitle)
                                        ) {
                                            const statusIcon =
                                                card.querySelector(
                                                    ".task-status-icon",
                                                );
                                            console.log(
                                                "üìä BEFORE - UI Status Icon:",
                                                statusIcon
                                                    ? statusIcon.textContent
                                                    : "not found",
                                            );
                                        }
                                    });
                                } else {
                                    console.log(
                                        "‚ùå Task not found:",
                                        taskTitle,
                                    );
                                    console.log(
                                        "Available tasks:",
                                        result.tasks.map((t) => t.title),
                                    );
                                }
                            })
                            .catch((error) =>
                                console.error(
                                    "‚ùå Error checking task status:",
                                    error,
                                ),
                            );
                    };

                    // Check completion after marking complete
                    window.checkCompletionAfter = function (
                        taskTitle,
                        delayMs = 1000,
                    ) {
                        console.log(
                            "‚è∞ Checking completion status after",
                            delayMs,
                            "ms delay",
                        );
                        setTimeout(() => {
                            window.debugCompletionFlow(taskTitle);
                        }, delayMs);
                    };

                    // List all available task names for easy copy-paste
                    window.listAllTasks = function () {
                        console.log("üìã ALL AVAILABLE TASKS:");
                        tasks.forEach((task, index) => {
                            console.log(`  ${index + 1}. "${task.title}"`);
                        });
                        console.log(
                            "üí° Copy the exact task name and use: debugCompletionFlow('Task Name Here')",
                        );
                        console.log(
                            "üí° OR hold Shift and click any task to debug it instantly!",
                        );
                    };
                    for (const task of tasks) {
                        if (
                            !task.title ||
                            !Array.isArray(task.users) ||
                            task.users.length === 0
                        ) {
                            console.warn("Found invalid task, skipping:", task);
                            continue; // Skip instead of delete
                        }
                        // Don't validate date field - As Needed tasks have empty dates
                    }

                    const taskList = document.getElementById("taskList");
                    taskList.innerHTML = "";

                    let visibleTasks;
                    if (typeof filterTasksForDate === "function") {
                        visibleTasks = filterTasksForDate(tasks, selectedDate);
                    } else {
                        console.error(
                            "filterTasksForDate function not available - using fallback filtering",
                        );
                        // Fallback: robust filtering that handles new task types
                        visibleTasks = tasks.filter((task) => {
                            // Handle As Needed tasks - always show them
                            if (task.asNeeded || task.repeat === "As Needed") {
                                return true;
                            }

                            // Handle tasks without dates - show them as "as needed" tasks
                            if (!task.date) return true;

                            // Handle specific dates
                            if (task.specificDates) {
                                const specificDates = task.specificDates
                                    .split(",")
                                    .map((d) => d.trim());
                                return specificDates.includes(selectedDate);
                            }

                            // Handle date ranges
                            const range = task.date.split(" to ");
                            const from = new Date(range[0]);
                            const to = range[1]
                                ? new Date(range[1])
                                : new Date(3000, 0, 1);
                            const selected = new Date(selectedDate);
                            return selected >= from && selected <= to;
                        });
                    }

                    if (visibleTasks.length === 0) {
                        taskList.innerHTML = `<div style="text-align:center; margin-top: 40px; color: #ccc;">No tasks for this day üåô</div>`;
                        return;
                    }

                    // Comprehensive task sorting
                    visibleTasks.sort((a, b) => {
                        // Helper functions
                        const isAsNeeded = (task) =>
                            task.asNeeded ||
                            task.repeat === "As Needed" ||
                            !task.date;
                        const getDueTime = (task) =>
                            task.dueTimes && task.dueTimes.length > 0
                                ? task.dueTimes[0]
                                : null;
                        const getTaskStatus = (task) => {
                            const completedUsers = Array.isArray(
                                task.completions?.[selectedDate],
                            )
                                ? task.completions[selectedDate]
                                : [];
                            const pendingUsers = completedUsers.filter(
                                (c) => c.isPending,
                            );
                            const approvedUsers = completedUsers.filter(
                                (c) => !c.isPending,
                            );

                            if (approvedUsers.length > 0) return "completed";
                            if (pendingUsers.length > 0) return "pending";
                            return "active";
                        };

                        const aIsAsNeeded = isAsNeeded(a);
                        const bIsAsNeeded = isAsNeeded(b);
                        const aStatus = getTaskStatus(a);
                        const bStatus = getTaskStatus(b);
                        const aDueTime = getDueTime(a);
                        const bDueTime = getDueTime(b);

                        // Priority order: active(due time) -> active(no due time) -> pending -> completed -> as needed
                        const statusPriority = {
                            active: 1,
                            pending: 2,
                            completed: 3,
                        };

                        // As needed tasks always go last
                        if (aIsAsNeeded && !bIsAsNeeded) return 1;
                        if (!aIsAsNeeded && bIsAsNeeded) return -1;
                        if (aIsAsNeeded && bIsAsNeeded) return 0; // Maintain order for as needed tasks

                        // Both are regular tasks - sort by status first
                        if (
                            statusPriority[aStatus] !== statusPriority[bStatus]
                        ) {
                            return (
                                statusPriority[aStatus] -
                                statusPriority[bStatus]
                            );
                        }

                        // Same status - handle active tasks with due times
                        if (aStatus === "active" && bStatus === "active") {
                            // Both have due times - sort by time (earlier first)
                            if (aDueTime && bDueTime) {
                                return aDueTime.localeCompare(bDueTime);
                            }
                            // Tasks with due times go before tasks without due times
                            if (aDueTime && !bDueTime) return -1;
                            if (!aDueTime && bDueTime) return 1;
                        }

                        // Same status and due time situation - maintain original order
                        return 0;
                    });

                    visibleTasks.forEach((task) => {
                        const taskDiv = document.createElement("div");
                        taskDiv.className = "task-item";
                        taskDiv.dataset.taskTitle = task.title;
                        taskDiv.dataset.taskDate = task.date;

                        if (
                            !Array.isArray(task.users) ||
                            task.users.length === 0
                        ) {
                            task.users = ["Unknown"];
                        }

                        // Remove modification indicator - not needed in compact view
                        const modificationIndicator = "";

                        // Show occurrence indicator if this is a multi-occurrence task
                        const occurrenceIndicator =
                            task.occurrence && task.totalOccurrences > 1
                                ? ` <span style="color: #666; font-size: 12px;">(${task.occurrence}/${task.totalOccurrences})</span>`
                                : "";

                        // Remove clock icon - due times are shown separately
                        const approvalIcon = "";

                        // Generate compact task card HTML
                        let taskHTML = "";
                        let turnData = {
                            turns: [],
                            completedCount: 0,
                            requiredTimes: 1,
                        };

                        // Header with title and due time
                        // For occurrence tasks, each should have its own specific due time
                        const dueTimeHTML =
                            task.dueTimes && task.dueTimes.length > 0
                                ? `<div class="task-due-time">${task.dueTimes[0]}</div>`
                                : "";

                        // Calculate task status for this card
                        const completedUsers = Array.isArray(
                            task.completions?.[selectedDate],
                        )
                            ? task.completions[selectedDate]
                            : [];
                        const pendingUsers = completedUsers.filter(
                            (c) => c.isPending,
                        );
                        const approvedUsers = completedUsers.filter(
                            (c) => !c.isPending,
                        );

                        let statusIcon = "";
                        let originalUserIcon = "";

                        if (approvedUsers.length > 0) {
                            statusIcon =
                                '<div class="task-status-icon complete" title="Complete">‚úÖ</div>';

                            // Check if completed by different user and add original user icon
                            const completedByUsers = [
                                ...new Set(approvedUsers.map((c) => c.user)),
                            ];
                            const assignedUsers = task.users || [];
                            const isCompletedByDifferentUser =
                                completedByUsers.some(
                                    (user) => !assignedUsers.includes(user),
                                );

                            if (
                                isCompletedByDifferentUser &&
                                assignedUsers.length > 0
                            ) {
                                // Show the original assigned user icon
                                if (
                                    window.avatarSystem &&
                                    typeof window.avatarSystem
                                        .generateAvatarHTML === "function"
                                ) {
                                    originalUserIcon =
                                        window.avatarSystem.generateAvatarHTML(
                                            assignedUsers[0],
                                            20,
                                            "original-user-avatar",
                                            `Originally assigned to ${assignedUsers[0]}`,
                                        );
                                } else {
                                    // Fallback when avatar system not available
                                    const initials = assignedUsers[0]
                                        .substring(0, 2)
                                        .toUpperCase();
                                    originalUserIcon = `<div class="original-user-avatar" style="width: 20px; height: 20px; border: 2px solid #fbb740; border-radius: 50%; background: #FF8A50; color: white; font-size: 8px; display: flex; align-items: center; justify-content: center; margin-left: 4px; opacity: 0.8; position: relative;" title="Originally assigned to ${assignedUsers[0]}">${initials}<div style="content: '‚Ü©'; position: absolute; bottom: -2px; right: -2px; font-size: 8px; background: #fbb740; color: white; border-radius: 50%; width: 10px; height: 10px; display: flex; align-items: center; justify-content: center; line-height: 1;">‚Ü©</div></div>`;
                                }
                            }
                        } else if (pendingUsers.length > 0) {
                            statusIcon =
                                '<div class="task-status-icon pending" title="Pending Approval">‚è≥</div>';

                            // Check if pending by different user and add original user icon
                            const pendingByUsers = [
                                ...new Set(pendingUsers.map((c) => c.user)),
                            ];
                            const assignedUsers = task.users || [];
                            const isPendingByDifferentUser =
                                pendingByUsers.some(
                                    (user) => !assignedUsers.includes(user),
                                );

                            if (
                                isPendingByDifferentUser &&
                                assignedUsers.length > 0
                            ) {
                                // Show the original assigned user icon
                                if (
                                    window.avatarSystem &&
                                    typeof window.avatarSystem
                                        .generateAvatarHTML === "function"
                                ) {
                                    originalUserIcon =
                                        window.avatarSystem.generateAvatarHTML(
                                            assignedUsers[0],
                                            20,
                                            "original-user-avatar",
                                            `Originally assigned to ${assignedUsers[0]}`,
                                        );
                                } else {
                                    // Fallback when avatar system not available
                                    const initials = assignedUsers[0]
                                        .substring(0, 2)
                                        .toUpperCase();
                                    originalUserIcon = `<div class="original-user-avatar" style="width: 20px; height: 20px; border: 2px solid #fbb740; border-radius: 50%; background: #FF8A50; color: white; font-size: 8px; display: flex; align-items: center; justify-content: center; margin-left: 4px; opacity: 0.8; position: relative;" title="Originally assigned to ${assignedUsers[0]}">${initials}<div style="content: '‚Ü©'; position: absolute; bottom: -2px; right: -2px; font-size: 8px; background: #fbb740; color: white; border-radius: 50%; width: 10px; height: 10px; display: flex; align-items: center; justify-content: center; line-height: 1;">‚Ü©</div></div>`;
                                }
                            }
                        } else {
                            statusIcon =
                                '<div class="task-status-icon incomplete" title="Incomplete">‚≠ï</div>';

                            // Check if this task was reassigned (check tempTurnReplacement or exceptions)
                            const assignedUsers = task.users || [];
                            const currentDate = selectedDate;
                            let hasReassignment = false;
                            let originalAssignee = null;

                            // Check if there are temp turn replacements
                            if (
                                task.tempTurnReplacement &&
                                task.tempTurnReplacement[currentDate]
                            ) {
                                hasReassignment = true;
                                // Get the first original user that was replaced
                                const replacements =
                                    task.tempTurnReplacement[currentDate];
                                for (const [
                                    index,
                                    replacementUser,
                                ] of Object.entries(replacements)) {
                                    const originalIndex = parseInt(index);
                                    if (
                                        task.users &&
                                        task.users[originalIndex]
                                    ) {
                                        originalAssignee =
                                            task.users[originalIndex];
                                        break;
                                    }
                                }
                            }

                            // Check if there are exceptions indicating reassignment
                            if (
                                !hasReassignment &&
                                task.exceptions &&
                                task.exceptions[currentDate] &&
                                task.exceptions[currentDate].task &&
                                task.exceptions[currentDate].task.users
                            ) {
                                const exceptionUsers =
                                    task.exceptions[currentDate].task.users;
                                const originalUsers = task.users;

                                // If exception users are different from original users, it's a reassignment
                                if (
                                    JSON.stringify(exceptionUsers) !==
                                    JSON.stringify(originalUsers)
                                ) {
                                    hasReassignment = true;
                                    originalAssignee =
                                        originalUsers && originalUsers[0];
                                }
                            }

                            if (hasReassignment && originalAssignee) {
                                // Show the original assigned user icon
                                if (
                                    window.avatarSystem &&
                                    typeof window.avatarSystem
                                        .generateAvatarHTML === "function"
                                ) {
                                    originalUserIcon =
                                        window.avatarSystem.generateAvatarHTML(
                                            originalAssignee,
                                            20,
                                            "original-user-avatar",
                                            `Originally assigned to ${originalAssignee}`,
                                        );
                                } else {
                                    // Fallback when avatar system not available
                                    const initials = originalAssignee
                                        .substring(0, 2)
                                        .toUpperCase();
                                    originalUserIcon = `<div class="original-user-avatar" style="width: 20px; height: 20px; border: 2px solid #fbb740; border-radius: 50%; background: #FF8A50; color: white; font-size: 8px; display: flex; align-items: center; justify-content: center; margin-left: 4px; opacity: 0.8; position: relative;" title="Originally assigned to ${originalAssignee}">${initials}<div style="content: '‚Ü©'; position: absolute; bottom: -2px; right: -2px; font-size: 8px; background: #fbb740; color: white; border-radius: 50%; width: 10px; height: 10px; display: flex; align-items: center; justify-content: center; line-height: 1;">‚Ü©</div></div>`;
                                }
                            }
                        }

                        taskHTML += `
                        <div class="task-header">
                            <div class="task-title-row">
                                ${statusIcon}${originalUserIcon}
                                <div class="task-title">${task.title}${occurrenceIndicator}${approvalIcon}${modificationIndicator}</div>
                                ${dueTimeHTML}
                            </div>
                        </div>
                    `;

                        // Generate avatars section with buzz points on same line
                        let avatarsHTML = '<div class="task-avatars">';
                        avatarsHTML += '<div class="task-avatars-section">';

                        // Add team icon for Team Work tasks
                        if (task.settings?.includes("Team Work")) {
                            avatarsHTML += '<div class="team-icon">üë•</div>';
                        }

                        // Add rotation icon for Rotation tasks
                        if (task.settings?.includes("Rotation")) {
                            avatarsHTML +=
                                '<div class="rotation-icon">üîÑ</div>';
                        }

                        if (task.settings?.includes("Rotation")) {
                            if (typeof mixedTurnData === "function") {
                                try {
                                    turnData = mixedTurnData(
                                        task,
                                        selectedDate,
                                    );
                                    if (turnData.turns.length > 0) {
                                        // Show current turn avatar
                                        const currentTurn = turnData.turns.find(
                                            (t) =>
                                                !t.isCompleted && !t.isPending,
                                        );
                                        if (
                                            currentTurn &&
                                            currentTurn.user !== "All done!"
                                        ) {
                                            avatarsHTML +=
                                                window.avatarSystem.generateAvatarHTML(
                                                    currentTurn.user,
                                                    24,
                                                    "task-avatar",
                                                );
                                        }

                                        // Show "Next:" label and upcoming avatars
                                        const nextTurns = turnData.turns
                                            .filter(
                                                (t) =>
                                                    !t.isCompleted &&
                                                    !t.isPending,
                                            )
                                            .slice(1, 2); // Show next 1 only
                                        if (nextTurns.length > 0) {
                                            avatarsHTML +=
                                                '<span class="task-next-label">Next:</span>';
                                            nextTurns.forEach((turn) => {
                                                avatarsHTML +=
                                                    window.avatarSystem.generateAvatarHTML(
                                                        turn.user,
                                                        24,
                                                        "task-avatar",
                                                    );
                                            });
                                        }
                                    }
                                } catch (err) {
                                    console.error(
                                        `Error processing Rotation task "${task.title}":`,
                                        err,
                                    );
                                    // Show all users as fallback
                                    task.users.forEach((user) => {
                                        avatarsHTML +=
                                            window.avatarSystem.generateAvatarHTML(
                                                user,
                                                28,
                                                "task-avatar",
                                            );
                                    });
                                }
                            } else {
                                // Fallback: show all users
                                task.users.forEach((user) => {
                                    avatarsHTML +=
                                        window.avatarSystem.generateAvatarHTML(
                                            user,
                                            24,
                                            "task-avatar",
                                        );
                                });
                            }
                        } else {
                            // Individual/Team Work tasks - show all assigned users
                            task.users.forEach((user) => {
                                avatarsHTML +=
                                    window.avatarSystem.generateAvatarHTML(
                                        user,
                                        24,
                                        "task-avatar",
                                    );
                            });
                        }

                        avatarsHTML += "</div>"; // Close task-avatars-section

                        // Add buzz points on same line
                        const rewardHTML = task.reward
                            ? `<div class="task-reward">${task.reward} <div class="honey-icon">üçØ</div></div>`
                            : "";

                        avatarsHTML += rewardHTML;
                        avatarsHTML += "</div>"; // Close task-avatars
                        taskHTML += avatarsHTML;

                        taskDiv.innerHTML =
                            taskHTML + `<div class="delete-btn">Delete</div>`;

                        taskDiv.addEventListener("click", async (e) => {
                            if (taskDiv.dataset.swiping === "true") {
                                taskDiv.dataset.swiping = "false";
                                return;
                            }

                            if (!e.target.classList.contains("delete-btn")) {
                                // Hold Shift + click to debug completion flow
                                if (e.shiftKey) {
                                    e.preventDefault();
                                    console.log(
                                        "üîç SHIFT+CLICK DEBUG for task:",
                                        task.title,
                                    );
                                    if (
                                        typeof window.debugCompletionFlow ===
                                        "function"
                                    ) {
                                        window.debugCompletionFlow(task.title);
                                    }
                                    return;
                                }

                                const latest = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                                    { cache: "no-store" },
                                );
                                const latestResult = await latest.json();
                                // Use the original task reference if this is a modified occurrence
                                const latestTask =
                                    task.originalTask ||
                                    latestResult.tasks.find(
                                        (t) =>
                                            t.title === task.title &&
                                            t.date === task.date,
                                    );
                                if (latestTask) showTaskDetails(latestTask);
                            }
                        });

                        taskDiv
                            .querySelector(".delete-btn")
                            .addEventListener("click", async (e) => {
                                e.stopPropagation();

                                // Prevent multiple clicks
                                const deleteBtn = e.target;
                                if (deleteBtn.disabled) {
                                    return;
                                }
                                deleteBtn.disabled = true;
                                const originalText = deleteBtn.textContent;
                                deleteBtn.textContent = "Deleting...";

                                try {
                                    console.log("üóëÔ∏è DELETE BUTTON CLICKED:");
                                    console.log("  - Task Title:", task.title);
                                    console.log("  - Task Date:", task.date);
                                    console.log("  - Task Users:", task.users);
                                    console.log(
                                        "  - Task Settings:",
                                        task.settings,
                                    );
                                    console.log(
                                        "  - Task Occurrence:",
                                        task.occurrence,
                                    );
                                    console.log(
                                        "  - Task Total Occurrences:",
                                        task.totalOccurrences,
                                    );
                                    console.log(
                                        "  - Task Repeat:",
                                        task.repeat,
                                    );
                                    console.log(
                                        "  - Task AsNeeded:",
                                        task.asNeeded,
                                    );
                                    console.log("  - Full Task Object:", task);
                                    console.log(
                                        "  - All tasks on this date before delete:",
                                        visibleTasks.map((t) => ({
                                            title: t.title,
                                            repeat: t.repeat,
                                            asNeeded: t.asNeeded,
                                            date: t.date,
                                        })),
                                    );

                                    // Check if multiple tasks have the same date
                                    const tasksWithSameDate =
                                        visibleTasks.filter(
                                            (t) => t.date === task.date,
                                        );
                                    console.log(
                                        "  - Tasks with same date range:",
                                        tasksWithSameDate.map((t) => ({
                                            title: t.title,
                                            date: t.date,
                                        })),
                                    );

                                    // Check if multiple tasks have similar start dates
                                    const taskStartDate = task.date
                                        ? task.date.split(" to ")[0]
                                        : null;
                                    if (taskStartDate) {
                                        const tasksWithSameStartDate =
                                            visibleTasks.filter((t) => {
                                                const tStartDate = t.date
                                                    ? t.date.split(" to ")[0]
                                                    : null;
                                                return (
                                                    tStartDate === taskStartDate
                                                );
                                            });
                                        console.log(
                                            "  - Tasks with same START date (" +
                                                taskStartDate +
                                                "):",
                                            tasksWithSameStartDate.map((t) => ({
                                                title: t.title,
                                                date: t.date,
                                            })),
                                        );
                                    }

                                    // Check for occurrence-based tasks (multiple daily occurrences)
                                    const isOccurrenceTask =
                                        task.occurrence &&
                                        task.totalOccurrences > 1;
                                    const isOccurrenceByTitle =
                                        task.title.includes(" - ") &&
                                        /\d+(st|nd|rd|th)$/.test(
                                            task.title.split(" - ")[1],
                                        );

                                    console.log(
                                        "  - Is Occurrence Task:",
                                        isOccurrenceTask,
                                    );
                                    console.log(
                                        "  - Is Occurrence By Title:",
                                        isOccurrenceByTitle,
                                    );

                                    if (
                                        isOccurrenceTask ||
                                        isOccurrenceByTitle
                                    ) {
                                        // For occurrence tasks, ask if they want to delete all occurrences
                                        const originalTitle =
                                            task.originalTitle ||
                                            task.title.split(" - ")[0];
                                        const deleteAll = confirm(
                                            `This is part of "${originalTitle}" with multiple daily occurrences.\n\nDo you want to delete ALL occurrences of this task?\n\nClick OK to delete ALL occurrences, or Cancel to delete only this specific occurrence.`,
                                        );

                                        if (deleteAll) {
                                            console.log(
                                                "üóëÔ∏è User chose: Delete all occurrences for:",
                                                originalTitle,
                                            );
                                            await deleteAllOccurrences(
                                                originalTitle,
                                                task.date,
                                            );
                                        } else {
                                            console.log(
                                                "üóëÔ∏è User chose: Delete single occurrence:",
                                                task.title,
                                            );
                                            await deleteTaskFromBackend(
                                                task.title,
                                                task.date,
                                            );
                                        }
                                    } else {
                                        // Regular single task delete
                                        if (
                                            confirm(
                                                `Are you sure you want to delete "${task.title}"?\n\nThis will delete the entire task and affect all past and future occurrences.`,
                                            )
                                        ) {
                                            console.log(
                                                "üóëÔ∏è User confirmed: Delete entire task:",
                                                task.title,
                                            );
                                            await deleteTaskFromBackend(
                                                task.title,
                                                task.date,
                                            );
                                        } else {
                                            console.log(
                                                "üóëÔ∏è User cancelled deletion",
                                            );
                                        }
                                    }
                                } catch (error) {
                                    console.error(
                                        "üö® Error during delete process:",
                                        error,
                                    );
                                    alert(
                                        `Delete failed: ${error.message}\n\nPlease try refreshing the page and attempting again.`,
                                    );
                                } finally {
                                    // Re-enable delete button
                                    deleteBtn.disabled = false;
                                    deleteBtn.textContent = originalText;
                                }
                            });

                        taskList.appendChild(taskDiv);
                        enableSwipeToDelete(taskDiv);
                    });
                } catch (err) {
                    console.error("Error loading tasks:", err, {
                        adminEmail,
                        selectedDate,
                    });
                    document.getElementById("taskList").innerHTML =
                        `<div style="text-align:center; margin-top: 40px; color: #ccc;">Error loading tasks: ${err.message}</div>`;
                }
                // Fixed syntax structure - no more duplicates
            }

            async function showTaskDetails(task) {
                const selectedDate =
                    document.querySelector(".day.selected")?.dataset.date;
                if (!selectedDate) return;

                // Fetch fresh task data to ensure completion status is current
                const adminEmail = localStorage.getItem("currentAdminEmail");
                let freshTask = task;
                try {
                    // Force cache busting with multiple cache-breaking parameters
                    const cacheBreaker = `t=${Date.now()}&r=${Math.random()}&bust=${performance.now()}`;
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&${cacheBreaker}`,
                        {
                            cache: "no-store",
                            headers: {
                                "Cache-Control":
                                    "no-cache, no-store, must-revalidate",
                                Pragma: "no-cache",
                                Expires: "0",
                            },
                        },
                    );
                    if (response.ok) {
                        const result = await response.json();
                        console.log("üîÑ Fresh task data response:", result);

                        // Enhanced task matching to handle edited tasks
                        let latestTask = null;

                        // Method 1: Try exact match first (for unchanged tasks)
                        latestTask = result.tasks.find(
                            (t) =>
                                t.title === task.title && t.date === task.date,
                        );

                        // Method 2: If task has an ID, try ID-based matching
                        if (!latestTask && task.id) {
                            latestTask = result.tasks.find(
                                (t) => t.id === task.id,
                            );
                            console.log(
                                "üîÑ Trying ID-based matching:",
                                task.id,
                            );
                        }

                        // Method 3: For occurrence tasks, try original title matching
                        if (
                            !latestTask &&
                            (task.originalTitle || task.occurrence)
                        ) {
                            const originalTitle =
                                task.originalTitle ||
                                task.title.split(" - ")[0];
                            latestTask = result.tasks.find(
                                (t) =>
                                    (t.originalTitle === originalTitle ||
                                        t.title === originalTitle) &&
                                    t.date === task.date,
                            );
                            console.log(
                                "üîÑ Trying original title matching:",
                                originalTitle,
                            );
                        }

                        // Method 4: Try matching by creation pattern (for recently edited tasks)
                        if (!latestTask) {
                            // Look for tasks with similar characteristics on the same date
                            const candidateTasks = result.tasks.filter((t) => {
                                const dateMatch =
                                    t.date === task.date ||
                                    t.date.includes(
                                        task.date.split(" to ")[0],
                                    ) ||
                                    task.date.includes(t.date.split(" to ")[0]);
                                return dateMatch;
                            });

                            if (candidateTasks.length === 1) {
                                latestTask = candidateTasks[0];
                                console.log(
                                    "üîÑ Found single candidate task on same date",
                                );
                            } else if (candidateTasks.length > 1) {
                                // If multiple candidates, try to find the one with most similar users
                                const originalUsers = task.users || [];
                                latestTask = candidateTasks.find((t) => {
                                    const taskUsers = t.users || [];
                                    return originalUsers.some((user) =>
                                        taskUsers.includes(user),
                                    );
                                });
                                console.log(
                                    "üîÑ Found task with matching users",
                                );
                            }
                        }

                        if (latestTask) {
                            console.log("üîÑ Found fresh task:", latestTask);
                            console.log(
                                "üîÑ Fresh task completions:",
                                latestTask.completions,
                            );
                            console.log(
                                "üîÑ Fresh task users:",
                                latestTask.users,
                            );
                            console.log(
                                "üîÑ Fresh task dueTimes:",
                                latestTask.dueTimes,
                            );
                            freshTask = latestTask;
                            console.log("üîÑ Using fresh task data for modal");
                        } else {
                            console.log(
                                "üîÑ No matching fresh task found - using original task data",
                            );
                            console.log(
                                "üîÑ Original task for reference:",
                                task,
                            );
                            console.log(
                                "üîÑ Available tasks in response:",
                                result.tasks.map((t) => ({
                                    title: t.title,
                                    date: t.date,
                                    users: t.users,
                                })),
                            );
                        }
                    } else {
                        console.log(
                            "üîÑ Fresh data request failed:",
                            response.status,
                        );
                    }
                } catch (error) {
                    console.error("Error fetching fresh task data:", error);
                    console.log(
                        "üîß Falling back to original task data due to fetch error",
                    );
                }

                // Additional debug logging for troubleshooting
                console.log("üîß FINAL DATA COMPARISON:");
                console.log("   Original task:", {
                    title: task.title,
                    users: task.users,
                    dueTimes: task.dueTimes,
                });
                console.log("   Fresh task:   ", {
                    title: task.title,
                    users: task.users,
                    dueTimes: task.dueTimes,
                });
                console.log(
                    "   Data updated: ",
                    freshTask !== task ? "YES" : "NO",
                );

                const userOrder =
                    task.users && Array.isArray(task.users)
                        ? [...task.users]
                        : [];

                // Add occurrence info if applicable
                const occurrenceInfo =
                    task.occurrence && task.totalOccurrences > 1
                        ? `<strong>Occurrence:</strong> ${task.occurrence} of ${task.totalOccurrences} daily occurrences<br>`
                        : "";

                // Show original title if this is an occurrence
                const originalTitleInfo =
                    task.originalTitle && task.originalTitle !== task.title
                        ? `<strong>Original Title:</strong> ${task.originalTitle}<br>`
                        : "";

                let taskDetails = ``;

                // Add status information first (right after title)
                const completedUsers = Array.isArray(
                    task.completions?.[selectedDate],
                )
                    ? task.completions[selectedDate]
                    : [];
                const pendingUsers = completedUsers.filter((c) => c.isPending);
                const approvedUsers = completedUsers.filter(
                    (c) => !c.isPending,
                );

                console.log("üîç STATUS DEBUG for task:", task.title);
                console.log("  - Selected date:", selectedDate);
                console.log("  - All task completions:", task.completions);
                console.log("  - Completions for this date:", completedUsers);
                console.log("  - Pending users:", pendingUsers);
                console.log("  - Approved users:", approvedUsers);

                if (approvedUsers.length > 0) {
                    // Task is completed
                    const completedByUsers = [
                        ...new Set(approvedUsers.map((c) => c.user)),
                    ];
                    const assignedUsers = task.users || [];
                    const isCompletedByDifferentUser = completedByUsers.some(
                        (user) => !assignedUsers.includes(user),
                    );

                    console.log("  - Completed by users:", completedByUsers);
                    console.log("  - Assigned users:", assignedUsers);
                    console.log(
                        "  - Is completed by different user:",
                        isCompletedByDifferentUser,
                    );

                    if (
                        isCompletedByDifferentUser ||
                        completedByUsers.length !== assignedUsers.length
                    ) {
                        taskDetails += `<div class="task-info-row"><strong>Status:</strong> <span style="color: #28a745;">‚úÖ Done by: ${completedByUsers.join(", ")}</span></div>`;
                    } else {
                        taskDetails += `<div class="task-info-row"><strong>Status:</strong> <span style="color: #28a745;">‚úÖ Done</span></div>`;
                    }
                } else if (pendingUsers.length > 0) {
                    // Task is pending approval
                    const pendingByUsers = [
                        ...new Set(pendingUsers.map((c) => c.user)),
                    ];
                    console.log("  - Pending by users:", pendingByUsers);
                    taskDetails += `<div class="task-info-row"><strong>Status:</strong> <span style="color: #ff9800;">‚è≥ Pending approval (${pendingByUsers.join(", ")})</span></div>`;
                } else {
                    // Task is incomplete
                    console.log(
                        "  - Task appears incomplete - no approved or pending users found",
                    );
                    taskDetails += `<div class="task-info-row"><strong>Status:</strong> <span style="color: #6c757d;">‚≠ï Incomplete</span></div>`;
                }

                // Add original title info if exists
                if (task.originalTitle && task.originalTitle !== task.title) {
                    taskDetails += `<div class="task-info-row"><strong>Original Title:</strong> ${task.originalTitle}</div>`;
                }

                // Add occurrence info if exists
                if (task.occurrence && task.totalOccurrences > 1) {
                    taskDetails += `<div class="task-info-row"><strong>Occurrence:</strong> ${task.occurrence} of ${task.totalOccurrences} daily occurrences</div>`;
                }

                // Add notes if they exist
                if (task.notes && task.notes.trim()) {
                    taskDetails += `<div class="task-info-row"><strong>Notes:</strong> ${task.notes}</div>`;
                }

                // Add frequency
                let frequencyText = task.repeat || "Daily";
                if (task.repeat === "Daily" && task.timesPerDay) {
                    frequencyText += ` - ${task.timesPerDay} time(s)/day`;
                } else if (task.repeat === "Weekly" && task.timesPerWeek) {
                    frequencyText += ` - ${task.timesPerWeek} time(s)/week`;
                } else if (task.repeat === "Monthly" && task.timesPerMonth) {
                    frequencyText += ` - ${task.timesPerMonth} time(s)/month`;
                }
                taskDetails += `<div class="task-info-row"><strong>Frequency:</strong> ${frequencyText}</div>`;

                // Add date range if it exists
                if (task.date) {
                    const [fromDate, toDate] = task.date.split(" to ");
                    if (fromDate) {
                        let dateText = fromDate;
                        if (
                            toDate &&
                            toDate !== "3000-01-01" &&
                            toDate !== fromDate
                        ) {
                            dateText += ` to ${toDate}`;
                        }
                        taskDetails += `<div class="task-info-row"><strong>Date Range:</strong> ${dateText}</div>`;
                    }
                }

                // Add room if it exists
                if (task.room && task.room.trim()) {
                    taskDetails += `<div class="task-info-row"><strong>Room:</strong> ${task.room}</div>`;
                }

                // Add assigned users
                if (userOrder && userOrder.length > 0) {
                    taskDetails += `<div class="task-info-row"><strong>Assigned to:</strong> ${userOrder.join(", ")}</div>`;
                }

                // Add reward if it exists
                if (task.reward && task.reward !== "0") {
                    taskDetails += `<div class="task-info-row"><strong>Reward:</strong> ${task.reward} üçØ</div>`;
                }

                // Add settings only if they differ from defaults
                let hasSettings = false;
                let settingsHtml = "";

                if (task.parentApproval !== false) {
                    settingsHtml += `<div class="task-info-row"><strong>Parent Approval:</strong> Required</div>`;
                    hasSettings = true;
                }

                if (task.onTimeCompletion) {
                    settingsHtml += `<div class="task-info-row"><strong>On-time completion:</strong> Important</div>`;
                    hasSettings = true;
                }

                if (hasSettings) {
                    taskDetails += settingsHtml;
                }

                let turnData = {
                    turns: [],
                    completedCount: 0,
                    requiredTimes: 1,
                };
                if (task.settings?.includes("Rotation")) {
                    if (typeof mixedTurnData !== "function") {
                        console.error(
                            `mixedTurnData is not defined for task: ${task.title}. Check if taskrotations.js loaded and inspect console for errors.`,
                        );
                        taskDetails += `<em style="color:#ff4444;">Error: Rotation calculation unavailable. See console for details.</em><br>`;
                    } else {
                        let rotationError = null;
                        if (!task.date || typeof task.date !== "string") {
                            console.error("‚ùå Task date is missing or invalid");
                        } else if (
                            !task.users ||
                            !Array.isArray(task.users) ||
                            task.users.length === 0
                        ) {
                            console.error(
                                "‚ùå Task users are missing or invalid",
                            );
                        } else if (
                            task.repeat === "Daily" &&
                            (!Number.isInteger(task.timesPerDay) ||
                                task.timesPerDay <= 0)
                        ) {
                            console.error(
                                "‚ùå Invalid timesPerDay for Daily task",
                            );
                            rotationError =
                                "Invalid times per day for Daily task";
                        }

                        if (rotationError) {
                            console.error(
                                `Error processing Rotation task "${freshTask.title}" on ${selectedDate} in showTaskDetails: ${rotationError}`,
                                freshTask,
                            );
                            taskDetails += `<em style="color:#ff4444;">Error: ${rotationError}. See console for details.</em><br>`;
                        } else {
                            try {
                                turnData = mixedTurnData(
                                    freshTask,
                                    selectedDate,
                                );
                                console.log(
                                    `Rotation task "${task.title}" details on ${selectedDate}:`,
                                    turnData,
                                );
                                if (turnData.turns.length === 0) {
                                    taskDetails += `<em style="color:#ff4444;">Error: No rotation turns available. Check task configuration.</em><br>`;
                                } else {
                                    const currentTurn =
                                        turnData.turns.find(
                                            (t) =>
                                                !t.isCompleted && !t.isPending,
                                        )?.user || "All done!";
                                    const nextTurnIndex =
                                        turnData.turns.findIndex(
                                            (t) =>
                                                !t.isCompleted && !t.isPending,
                                        ) + 1;
                                    const nextUser =
                                        nextTurnIndex < turnData.turns.length
                                            ? turnData.turns[nextTurnIndex]
                                                  ?.user
                                            : "‚Äî";
                                    const fairRotationText = task.fairRotation
                                        ? task.fairRotationTimeBased
                                            ? " (Fair Rotation - Time Based)"
                                            : " (Fair Rotation)"
                                        : "";
                                    taskDetails += `
                                    <div style="margin: 15px 0; padding: 12px 0; border-top: 1px solid #FBB740;">
                                        <div class="task-info-row"><strong>Settings:</strong> Rotation${fairRotationText}</div>
                                        <div class="task-info-row"><strong>Current Turn:</strong> ${currentTurn}</div>
                                        <div class="task-info-row"><strong>Next:</strong> ${nextUser}</div>
                                        <div class="task-progress">Progress: ${turnData.completedCount}/${turnData.requiredTimes}</div>
                                    </div>
                                `;
                                }
                            } catch (err) {
                                console.error(
                                    `Error processing Rotation task "${task.title}" on ${selectedDate} in showTaskDetails:`,
                                    err,
                                    task,
                                );
                                taskDetails += `<em style="color:#ff4444;">Error: Unable to calculate rotation (${err.message}). See console for details.</em><br>`;
                            }
                        }
                    }
                } else if (task.settings?.includes("Individual")) {
                    if (typeof individualTurnData !== "function") {
                        console.error(
                            `individualTurnData is not defined for task: ${task.title}`,
                        );
                        taskDetails += `<em style="color:#ff4444;">Error: Progress calculation unavailable</em><br>`;
                    } else {
                        try {
                            turnData = individualTurnData(
                                freshTask,
                                selectedDate,
                            );
                            taskDetails += `
                            <div style="margin: 15px 0; padding: 12px 0; border-top: 1px solid #FBB740;">
                                <div class="task-info-row"><strong>Settings:</strong> Individual</div>
                            </div>
                        `;
                        } catch (individualError) {
                            console.error(
                                `Error processing Individual task "${task.title}" on ${selectedDate} in showTaskDetails:`,
                                individualError,
                                task,
                            );
                            taskDetails += `<em>Error: Unable to calculate progress (${individualError.message}). See console for details.</em>`;
                        }
                    }
                } else if (freshTask.settings?.includes("Team Work")) {
                    taskDetails += `
                    <div style="margin: 15px 0; padding: 12px 0; border-top: 1px solid #FBB740;">
                        <div class="task-info-row"><strong>Settings:</strong> Team Work</div>
                    </div>
                `;
                }

                // Check if task can be completed - anyone can complete any task
                const currentUser = localStorage.getItem("currentUser");
                const currentUserEmail =
                    localStorage.getItem("currentUserEmail") || adminEmail;
                const isParent = currentUserEmail === adminEmail;
                const canComplete =
                    !freshTask.asNeeded &&
                    freshTask.users &&
                    freshTask.users.length > 0;
                const completedUsersForButton = Array.isArray(
                    freshTask.completions?.[selectedDate],
                )
                    ? freshTask.completions[selectedDate]
                    : [];
                const pendingUsersForButton = completedUsersForButton.filter(
                    (c) => c.isPending,
                );
                const approvedUsersForButton = completedUsersForButton.filter(
                    (c) => !c.isPending,
                );
                const isTaskComplete =
                    approvedUsersForButton.length > 0 ||
                    pendingUsersForButton.length > 0;

                console.log("üêõ COMPLETION DEBUG:");
                console.log("  - Task:", freshTask.title);
                console.log("  - Task users:", freshTask.users);
                console.log("  - Current user:", currentUser);
                console.log("  - Admin email:", adminEmail);
                console.log("  - Current user email:", currentUserEmail);
                console.log("  - Is parent:", isParent);
                console.log(
                    "  - LocalStorage keys:",
                    Object.keys(localStorage),
                );
                console.log(
                    "  - All localStorage data:",
                    JSON.stringify(localStorage, null, 2),
                );
                console.log("  - Can complete:", canComplete);
                console.log("  - Is task complete:", isTaskComplete);
                console.log(
                    "  - Pending users:",
                    pendingUsersForButton.map((c) => c.user),
                );
                console.log(
                    "  - Approved users:",
                    approvedUsersForButton.map((c) => c.user),
                );

                taskDetails += `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #FBB740;">
                    ${
                        canComplete && !isTaskComplete
                            ? `
                        <div style="margin-bottom: 15px; text-align: center;">
                            <button id="completeTaskBtn" style="padding: 10px 20px; background: #28a745; color: white; font-weight: 600; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; margin: 0 auto;">
                                ‚úì Mark as Done
                            </button>
                        </div>
                    `
                            : ""
                    }
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                        <button id="editOccurrenceBtn" style="padding: 8px 16px; background: #FBB740; color: #5D4E41; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; font-size: 13px;">Edit This Day</button>
                        <button id="editFutureBtn" style="padding: 8px 16px; background: #e4e3e0; color: #5D4E41; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; font-size: 13px;">Edit Future</button>
                        <button id="editTaskBtn" style="padding: 8px 16px; background: #e4e3e0; color: #5D4E41; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; font-size: 13px;">Edit Entire Task</button>
                        <button id="deleteOccurrenceBtn" style="padding: 8px 16px; background: #D32F2F; color: white; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; font-size: 13px;">Delete This Day</button>
                        <button id="deleteFutureBtn" style="padding: 8px 16px; background: #D32F2F; color: white; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; font-size: 13px;">Delete Future</button>
                        <button id="deleteEntireTaskBtn" style="padding: 8px 16px; background: #D32F2F; color: white; font-weight: 500; border-radius: 6px; border: none; cursor: pointer; font-size: 13px;">Delete Entire Task</button>

                    </div>
                </div>
            `;

                const modal = document.createElement("div");
                modal.className = "task-modal";
                modal.innerHTML = `<div class="modal-content"><h2>${freshTask.title}</h2>${taskDetails}</div>`;
                document.body.appendChild(modal);

                modal.addEventListener("click", (e) => {
                    if (e.target.classList.contains("task-modal"))
                        modal.remove();
                });

                // Complete task button logic
                const completeBtn = modal.querySelector("#completeTaskBtn");
                if (completeBtn) {
                    completeBtn.addEventListener("click", async () => {
                        // Prevent multiple clicks
                        if (completeBtn.disabled) {
                            return;
                        }
                        completeBtn.disabled = true;
                        const originalText = completeBtn.innerHTML;
                        completeBtn.innerHTML = "‚è≥ Processing...";

                        try {
                            // First, refresh task data to get latest completion status
                            try {
                                const response = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                                    { cache: "no-store" },
                                );
                                if (response.ok) {
                                    const result = await response.json();
                                    const latestTask = result.tasks.find(
                                        (t) =>
                                            t.title === task.title &&
                                            t.date === task.date,
                                    );
                                    if (latestTask) {
                                        // Check if task is already complete with fresh data
                                        const latestCompletedUsers =
                                            Array.isArray(
                                                latestTask.completions?.[
                                                    selectedDate
                                                ],
                                            )
                                                ? latestTask.completions[
                                                      selectedDate
                                                  ]
                                                : [];
                                        const latestApprovedUsers =
                                            latestCompletedUsers.filter(
                                                (c) => !c.isPending,
                                            );

                                        if (latestApprovedUsers.length > 0) {
                                            alert(
                                                "This task has already been completed!",
                                            );
                                            modal.remove();
                                            // Refresh the task list to show updated status
                                            const selectedDateElement =
                                                document.querySelector(
                                                    ".day.selected",
                                                );
                                            const currentSelectedDate =
                                                selectedDateElement
                                                    ? selectedDateElement
                                                          .dataset.date
                                                    : new Date()
                                                          .toISOString()
                                                          .split("T")[0];
                                            loadTasksForDate(
                                                currentSelectedDate,
                                            );
                                            return;
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error(
                                    "Error refreshing task data:",
                                    error,
                                );
                            }

                            const currentUser =
                                localStorage.getItem("currentUser");
                            const currentUserEmail =
                                localStorage.getItem("currentUserEmail") ||
                                adminEmail;
                            const isParent = currentUserEmail === adminEmail;

                            console.log("üîò COMPLETE BUTTON CLICKED:");
                            console.log("  - Current user:", currentUser);
                            console.log("  - Admin email:", adminEmail);
                            console.log("  - Is parent:", isParent);
                            console.log(
                                "  - Task assigned users:",
                                freshTask.users,
                            );

                            if (isParent) {
                                // Parent can choose who completed the task
                                await showUserSelectionModal(
                                    freshTask,
                                    selectedDate,
                                    modal,
                                );
                            } else {
                                // Child marks task as done for themselves
                                await completeTaskForUser(
                                    freshTask,
                                    selectedDate,
                                    currentUser,
                                    modal,
                                );
                            }
                        } catch (error) {
                            console.error("Error in task completion:", error);
                            alert(`Failed to complete task: ${error.message}`);
                        } finally {
                            // Re-enable button
                            completeBtn.disabled = false;
                            completeBtn.innerHTML = originalText;
                        }
                    });
                }

                // Get all family users
                async function getAllFamilyUsers() {
                    try {
                        const adminEmail =
                            localStorage.getItem("currentAdminEmail");
                        const response = await fetch(
                            `https://beemazing1.onrender.com/api/users?adminEmail=${encodeURIComponent(adminEmail)}`,
                        );
                        if (response.ok) {
                            const result = await response.json();
                            return result.users || [];
                        }
                    } catch (error) {
                        console.error("Error fetching family users:", error);
                    }
                    return [];
                }

                // User selection modal for task completion
                async function showUserSelectionModal(
                    task,
                    selectedDate,
                    parentModal,
                ) {
                    const userModal = document.createElement("div");
                    userModal.className = "task-modal";
                    userModal.style.zIndex = "1001";

                    // Get all users in the family, not just assigned users
                    const allUsers = await getAllFamilyUsers();
                    const usersToShow =
                        allUsers.length > 0 ? allUsers : task.users;

                    let userOptionsHtml = "";
                    usersToShow.forEach((user) => {
                        const isAssigned = task.users.includes(user);
                        const buttonStyle = isAssigned
                            ? "background: #FFF6E9; border: 2px solid #FBB740;"
                            : "background: #f8f9fa; border: 2px solid #e4e3e0;";

                        userOptionsHtml += `
                        <button class="user-option-btn" data-user="${user}" style="
                            display: block;
                            width: 100%;
                            padding: 12px;
                            margin: 8px 0;
                            ${buttonStyle}
                            border-radius: 8px;
                            color: #5D4E41;
                            font-weight: 500;
                            cursor: pointer;
                            text-align: center;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='#FBB740'; this.style.color='white';" onmouseout="this.style.background='${isAssigned ? "#FFF6E9" : "#f8f9fa"}'; this.style.color='#5D4E41';">
                            ${user} ${isAssigned ? "(assigned)" : "(helped out)"}
                        </button>
                    `;
                    });

                    userModal.innerHTML = `
                    <div class="modal-content">
                        <h2>Who completed this task?</h2>
                        <div style="margin: 15px 0; padding: 10px; background: #FFF6E9; border-radius: 6px; font-size: 13px; color: #5D4E41;">
                            üí° The buzz points will go to whoever you select
                        </div>
                        <div style="margin: 20px 0;">
                            ${userOptionsHtml}
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button id="cancelUserSelection" style="padding: 8px 16px; background: #e4e3e0; color: #5D4E41; font-weight: 500; border-radius: 6px; border: none; cursor: pointer;">Cancel</button>
                        </div>
                    </div>
                `;

                    document.body.appendChild(userModal);

                    // Handle user selection
                    userModal
                        .querySelectorAll(".user-option-btn")
                        .forEach((btn) => {
                            btn.addEventListener("click", async () => {
                                // Prevent multiple clicks
                                if (btn.disabled) {
                                    return;
                                }
                                btn.disabled = true;
                                const originalText = btn.textContent;
                                btn.textContent = "Processing...";

                                try {
                                    const selectedUser = btn.dataset.user;
                                    userModal.remove();
                                    await completeTaskForUser(
                                        task,
                                        selectedDate,
                                        selectedUser,
                                        parentModal,
                                    );
                                } catch (error) {
                                    console.error(
                                        "Error in user selection:",
                                        error,
                                    );
                                    btn.disabled = false;
                                    btn.textContent = originalText;
                                    alert(
                                        `Failed to complete task: ${error.message}`,
                                    );
                                }
                            });
                        });

                    // Handle cancel
                    document
                        .getElementById("cancelUserSelection")
                        .addEventListener("click", () => {
                            userModal.remove();
                        });

                    // Handle click outside
                    userModal.addEventListener("click", (e) => {
                        if (e.target.classList.contains("task-modal")) {
                            userModal.remove();
                        }
                    });
                }

                // Complete task for specific user
                async function completeTaskForUser(
                    task,
                    selectedDate,
                    userName,
                    modal,
                ) {
                    const adminEmail =
                        localStorage.getItem("currentAdminEmail");

                    console.log("üìù COMPLETING TASK:");
                    console.log("  - Task title:", task.title);
                    console.log("  - User name:", userName);
                    console.log("  - Selected date:", selectedDate);
                    console.log("  - Admin email:", adminEmail);
                    console.log("  - Parent approval:", task.parentApproval);

                    try {
                        const requestBody = {
                            adminEmail: adminEmail,
                            taskTitle: task.title,
                            user: userName,
                            date: selectedDate,
                            parentApproval: task.parentApproval,
                            taskUsers: task.users,
                        };

                        console.log(
                            "  - Request body:",
                            JSON.stringify(requestBody, null, 2),
                        );

                        const response = await fetch(
                            "https://beemazing1.onrender.com/api/complete-task",
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(requestBody),
                            },
                        );

                        console.log("  - Response status:", response.status);
                        console.log("  - Response OK:", response.ok);

                        if (!response.ok) {
                            const errorData = await response
                                .json()
                                .catch(() => ({
                                    error: `HTTP error ${response.status}`,
                                }));
                            console.log("  - Error data:", errorData);
                            throw new Error(
                                `Failed to complete task: ${errorData.error || response.statusText}`,
                            );
                        }

                        const result = await response.json();
                        console.log("‚úÖ Task completed successfully:", result);

                        // Enhanced debugging for completion data
                        console.log("üîç COMPLETION DEBUG - Before UI refresh:");
                        console.log(
                            "  - Updated task from backend:",
                            result.updatedTask,
                        );
                        console.log(
                            "  - Updated completions:",
                            result.updatedTask?.completions,
                        );
                        console.log(
                            "  - Completions for today:",
                            result.updatedTask?.completions?.[selectedDate],
                        );

                        // Store task title for debugging
                        const completedTaskTitle = task.title;

                        // IMMEDIATE CHECK: Verify backend actually saved the data
                        console.log(
                            "üîç IMMEDIATE BACKEND CHECK - Fetching fresh data to verify completion was saved...",
                        );
                        setTimeout(async () => {
                            try {
                                const verifyResponse = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                                    { cache: "no-store" },
                                );
                                if (verifyResponse.ok) {
                                    const verifyResult =
                                        await verifyResponse.json();
                                    const verifyTask = verifyResult.tasks.find(
                                        (t) => t.title === completedTaskTitle,
                                    );
                                    if (verifyTask) {
                                        console.log(
                                            "üîç VERIFICATION - Fresh task data:",
                                            verifyTask.title,
                                        );
                                        console.log(
                                            "üîç VERIFICATION - Fresh completions:",
                                            verifyTask.completions,
                                        );
                                        console.log(
                                            "üîç VERIFICATION - Fresh completions for",
                                            selectedDate,
                                            ":",
                                            verifyTask.completions?.[
                                                selectedDate
                                            ] || [],
                                        );

                                        const freshCompletions =
                                            verifyTask.completions?.[
                                                selectedDate
                                            ] || [];
                                        if (freshCompletions.length === 0) {
                                            console.error(
                                                "‚ùå BACKEND ISSUE: Completion data NOT saved! Backend returned empty array after successful completion.",
                                            );
                                            console.error(
                                                "‚ùå This confirms the backend /api/complete-task endpoint is not properly saving completion data.",
                                            );
                                        } else {
                                            console.log(
                                                "‚úÖ BACKEND OK: Completion data found:",
                                                freshCompletions,
                                            );
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error(
                                    "‚ùå Error verifying completion data:",
                                    error,
                                );
                            }
                        }, 100);

                        // Close modal and refresh
                        modal.remove();

                        // Add longer delay to ensure backend data is updated
                        if (typeof loadTasksForDate === "function") {
                            console.log(
                                "üîÑ Refreshing task list after completion...",
                            );
                            setTimeout(() => {
                                const selectedDateElement =
                                    document.querySelector(".day.selected");
                                const currentSelectedDate = selectedDateElement
                                    ? selectedDateElement.dataset.date
                                    : new Date().toISOString().split("T")[0];
                                console.log(
                                    "üîÑ Loading tasks for date:",
                                    currentSelectedDate,
                                );
                                loadTasksForDate(currentSelectedDate);

                                // Auto-check completion status after refresh
                                setTimeout(() => {
                                    console.log(
                                        "üîç AUTO-CHECKING completion status after refresh...",
                                    );
                                    window.debugCompletionFlow(
                                        completedTaskTitle,
                                    );
                                }, 1000);
                            }, 500); // Increased delay to 500ms
                        }
                    } catch (error) {
                        console.error("‚ùå Error completing task:", error);
                        alert(`Failed to complete task: ${error.message}`);
                    }
                }

                // Edit single occurrence
                const editOccurrenceBtn =
                    modal.querySelector("#editOccurrenceBtn");
                if (editOccurrenceBtn) {
                    editOccurrenceBtn.addEventListener("click", async () => {
                        // üîß DEBUG: Verify we're using fresh task data
                        console.log("üîß Edit button using freshTask:", {
                            title: freshTask.title,
                            date: freshTask.date,
                            users: freshTask.users,
                            dueTimes: freshTask.dueTimes,
                            originalTitle: freshTask.originalTitle,
                            totalOccurrences: freshTask.totalOccurrences,
                        });
                        // Check if this is an occurrence task (part of multiple daily occurrences)
                        const isOccurrenceTask =
                            freshTask.originalTitle &&
                            freshTask.totalOccurrences;
                        const isOccurrenceByTitle =
                            freshTask.title.includes(" - ") &&
                            (freshTask.title.includes("1st") ||
                                freshTask.title.includes("2nd") ||
                                freshTask.title.includes("3rd"));

                        let modifiedTask = { ...freshTask };

                        // Check if this date has exception data (modified task data)
                        if (
                            freshTask.exceptions &&
                            freshTask.exceptions[selectedDate] &&
                            freshTask.exceptions[selectedDate].task
                        ) {
                            console.log(
                                "üîß Found exception data for selected date:",
                                selectedDate,
                            );
                            const exceptionTask =
                                freshTask.exceptions[selectedDate].task;

                            // Use the exception data as the base, but keep original task structure
                            modifiedTask = {
                                ...freshTask,
                                ...exceptionTask,
                                // Preserve important edit metadata
                                exceptions: freshTask.exceptions,
                                completions: freshTask.completions,
                            };

                            console.log("üîß Using exception data for edit:", {
                                originalUsers: freshTask.users,
                                exceptionUsers: exceptionTask.users,
                                originalDueTimes: freshTask.dueTimes,
                                exceptionDueTimes: exceptionTask.dueTimes,
                            });
                        }

                        if (isOccurrenceTask || isOccurrenceByTitle) {
                            // For occurrence tasks, reconstruct the original complete task data
                            const originalTitle =
                                freshTask.originalTitle ||
                                freshTask.title.split(" - ")[0];
                            const adminEmail =
                                localStorage.getItem("currentAdminEmail");

                            try {
                                // Fetch all tasks to find all related occurrences
                                const response = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                                    { cache: "no-store" },
                                );
                                if (response.ok) {
                                    const result = await response.json();
                                    const allOccurrences = result.tasks.filter(
                                        (t) =>
                                            (t.originalTitle ===
                                                originalTitle ||
                                                t.title.startsWith(
                                                    originalTitle + " - ",
                                                )) &&
                                            t.date === freshTask.date,
                                    );

                                    if (allOccurrences.length > 0) {
                                        // Sort occurrences by occurrence number
                                        allOccurrences.sort(
                                            (a, b) =>
                                                (a.occurrence || 1) -
                                                (b.occurrence || 1),
                                        );

                                        // Reconstruct original task data with all assignees, but keep occurrence-specific info
                                        modifiedTask = {
                                            ...allOccurrences[0],
                                            title: originalTitle, // Use original title
                                            timesPerDay: allOccurrences.length, // Set correct times per day
                                            totalOccurrences:
                                                allOccurrences.length,
                                            // Collect all users from all occurrences (for rotation tasks)
                                            users: [
                                                ...new Set(
                                                    allOccurrences.flatMap(
                                                        (occ) =>
                                                            occ.users || [],
                                                    ),
                                                ),
                                            ],
                                            // Collect all due times from all occurrences
                                            dueTimes: allOccurrences
                                                .map((occ) =>
                                                    occ.dueTimes &&
                                                    occ.dueTimes[0]
                                                        ? occ.dueTimes[0]
                                                        : "",
                                                )
                                                .filter((time) => time),
                                            // Keep occurrence-specific fields
                                            occurrence: freshTask.occurrence,
                                            originalTitle:
                                                freshTask.originalTitle,
                                        };

                                        console.log(
                                            "üîç Reconstructed original task data for occurrence edit:",
                                            modifiedTask,
                                        );
                                    }
                                }
                            } catch (error) {
                                console.error(
                                    "Error fetching occurrence data for occurrence edit:",
                                    error,
                                );
                            }
                        }

                        // Mark this as a single occurrence edit
                        modifiedTask.isOccurrenceEdit = true;
                        modifiedTask.targetDate = selectedDate;
                        modifiedTask.originalStartDate =
                            freshTask.date.split(" to ")[0];
                        localStorage.setItem(
                            "familyApp_editTask",
                            JSON.stringify(modifiedTask),
                        );
                        localStorage.setItem(
                            "familyApp_editTask_index",
                            freshTask.title +
                                "-" +
                                freshTask.date +
                                "-occurrence",
                        );
                        window.location.href =
                            "/BeeMazing-A1/mobile/3-Tasks/addtasks.html";
                    });
                }

                // Edit future occurrences
                const editFutureBtn = modal.querySelector("#editFutureBtn");
                if (editFutureBtn) {
                    editFutureBtn.addEventListener("click", async () => {
                        // üîß DEBUG: Verify we're using fresh task data
                        console.log("üîß Edit button using freshTask:", {
                            title: freshTask.title,
                            date: freshTask.date,
                            users: freshTask.users,
                            dueTimes: freshTask.dueTimes,
                            originalTitle: freshTask.originalTitle,
                            totalOccurrences: freshTask.totalOccurrences,
                        });
                        console.log(
                            "üîç Debugging task for entire edit:",
                            freshTask,
                        );
                        console.log("üîç Task title:", freshTask.title);
                        console.log(
                            "üîç Original title:",
                            freshTask.originalTitle,
                        );
                        console.log("üîç Occurrence:", freshTask.occurrence);
                        console.log(
                            "üîç Total occurrences:",
                            freshTask.totalOccurrences,
                        );

                        // Check if this is an occurrence task (part of multiple daily occurrences)
                        const isOccurrenceTask =
                            freshTask.originalTitle &&
                            freshTask.totalOccurrences;
                        const isOccurrenceByTitle =
                            freshTask.title.includes(" - ") &&
                            (freshTask.title.includes("1st") ||
                                freshTask.title.includes("2nd") ||
                                freshTask.title.includes("3rd"));

                        console.log(
                            "üîç Is occurrence task (by metadata):",
                            isOccurrenceTask,
                        );
                        console.log(
                            "üîç Is occurrence task (by title pattern):",
                            isOccurrenceByTitle,
                        );

                        let modifiedTask = { ...freshTask };

                        // Check if this date has exception data (modified task data)
                        if (
                            freshTask.exceptions &&
                            freshTask.exceptions[selectedDate] &&
                            freshTask.exceptions[selectedDate].task
                        ) {
                            console.log(
                                "üîß Found exception data for selected date:",
                                selectedDate,
                            );
                            const exceptionTask =
                                freshTask.exceptions[selectedDate].task;

                            // Use the exception data as the base, but keep original task structure
                            modifiedTask = {
                                ...freshTask,
                                ...exceptionTask,
                                // Preserve important edit metadata
                                exceptions: freshTask.exceptions,
                                completions: freshTask.completions,
                            };

                            console.log("üîß Using exception data for edit:", {
                                originalUsers: freshTask.users,
                                exceptionUsers: exceptionTask.users,
                                originalDueTimes: freshTask.dueTimes,
                                exceptionDueTimes: exceptionTask.dueTimes,
                            });
                        }

                        if (isOccurrenceTask || isOccurrenceByTitle) {
                            // For occurrence tasks, reconstruct the original complete task data
                            const originalTitle =
                                freshTask.originalTitle ||
                                freshTask.title.split(" - ")[0];
                            const adminEmail =
                                localStorage.getItem("currentAdminEmail");

                            try {
                                // Fetch all tasks to find all related occurrences
                                const response = await fetch(
                                    `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                                    { cache: "no-store" },
                                );
                                if (response.ok) {
                                    const result = await response.json();
                                    const allOccurrences = result.tasks.filter(
                                        (t) =>
                                            (t.originalTitle ===
                                                originalTitle ||
                                                t.title.startsWith(
                                                    originalTitle + " - ",
                                                )) &&
                                            t.date === freshTask.date,
                                    );

                                    if (allOccurrences.length > 0) {
                                        // Sort occurrences by occurrence number
                                        allOccurrences.sort(
                                            (a, b) =>
                                                (a.occurrence || 1) -
                                                (b.occurrence || 1),
                                        );

                                        // Reconstruct original task data with all assignees
                                        modifiedTask = {
                                            ...allOccurrences[0],
                                            title: originalTitle, // Use original title
                                            timesPerDay: allOccurrences.length, // Set correct times per day
                                            totalOccurrences:
                                                allOccurrences.length,
                                            // Collect all users from all occurrences (for rotation tasks)
                                            users: [
                                                ...new Set(
                                                    allOccurrences.flatMap(
                                                        (occ) =>
                                                            occ.users || [],
                                                    ),
                                                ),
                                            ],
                                            // Collect all due times from all occurrences
                                            dueTimes: allOccurrences
                                                .map((occ) =>
                                                    occ.dueTimes &&
                                                    occ.dueTimes[0]
                                                        ? occ.dueTimes[0]
                                                        : "",
                                                )
                                                .filter((time) => time),
                                            // Remove occurrence-specific fields
                                            occurrence: undefined,
                                            originalTitle: undefined,
                                        };

                                        console.log(
                                            "üîç Reconstructed original task data for future edit:",
                                            modifiedTask,
                                        );
                                    }
                                }
                            } catch (error) {
                                console.error(
                                    "Error fetching occurrence data for future edit:",
                                    error,
                                );
                            }

                            console.log(
                                "‚úÖ Detected occurrence task - setting up group edit",
                            );
                            modifiedTask.isFutureEdit = true;
                            modifiedTask.isOccurrenceGroupEdit = true; // Flag to indicate editing all occurrences
                            modifiedTask.splitDate = selectedDate;
                            modifiedTask.originalStartDate =
                                freshTask.date.split(" to ")[0];
                            modifiedTask.originalTitle = originalTitle; // Use the original title for grouping
                            modifiedTask.totalOccurrences =
                                modifiedTask.totalOccurrences ||
                                freshTask.totalOccurrences ||
                                3; // Default if not available

                            console.log(
                                "üöÄ Setting up occurrence group edit with:",
                                {
                                    originalTitle: originalTitle,
                                    totalOccurrences:
                                        modifiedTask.totalOccurrences,
                                    splitDate: selectedDate,
                                    allUsers: modifiedTask.users,
                                },
                            );

                            localStorage.setItem(
                                "familyApp_editTask",
                                JSON.stringify(modifiedTask),
                            );
                            localStorage.setItem(
                                "familyApp_editTask_index",
                                originalTitle +
                                    "-" +
                                    freshTask.date +
                                    "-future-group",
                            );
                        } else {
                            // Regular single task future edit
                            console.log("‚úÖ Regular single task edit");
                            modifiedTask.isFutureEdit = true;
                            modifiedTask.splitDate = selectedDate;
                            modifiedTask.originalStartDate =
                                freshTask.date.split(" to ")[0];
                            localStorage.setItem(
                                "familyApp_editTask",
                                JSON.stringify(modifiedTask),
                            );
                            localStorage.setItem(
                                "familyApp_editTask_index",
                                freshTask.title +
                                    "-" +
                                    freshTask.date +
                                    "-future",
                            );
                        }

                        window.location.href =
                            "/BeeMazing-A1/mobile/3-Tasks/addtasks.html";
                    });
                }

                // Delete single occurrence
                const deleteOccurrenceBtn = modal.querySelector(
                    "#deleteOccurrenceBtn",
                );
                if (deleteOccurrenceBtn) {
                    deleteOccurrenceBtn.addEventListener("click", async () => {
                        // Prevent multiple clicks
                        if (deleteOccurrenceBtn.disabled) {
                            return;
                        }
                        deleteOccurrenceBtn.disabled = true;
                        const originalText = deleteOccurrenceBtn.textContent;
                        deleteOccurrenceBtn.textContent = "Deleting...";

                        try {
                            if (
                                confirm(
                                    `Are you sure you want to delete this task occurrence on ${selectedDate}? This will only affect this specific date.`,
                                )
                            ) {
                                modal.remove();
                                await deleteSingleOccurrence(
                                    freshTask.title,
                                    selectedDate,
                                    freshTask.date.split(" to ")[0],
                                );
                                loadTasksForDate(selectedDate);
                            }
                        } finally {
                            deleteOccurrenceBtn.disabled = false;
                            deleteOccurrenceBtn.textContent = originalText;
                        }
                    });
                }

                // Delete future occurrences
                const deleteFutureBtn = modal.querySelector("#deleteFutureBtn");
                if (deleteFutureBtn) {
                    deleteFutureBtn.addEventListener("click", async () => {
                        // Prevent multiple clicks
                        if (deleteFutureBtn.disabled) {
                            return;
                        }
                        deleteFutureBtn.disabled = true;
                        const originalText = deleteFutureBtn.textContent;
                        deleteFutureBtn.textContent = "Deleting...";

                        try {
                            // Check if this is a multiple daily occurrence task
                            const isOccurrenceTask =
                                freshTask.originalTitle &&
                                freshTask.totalOccurrences;
                            const isOccurrenceByTitle =
                                freshTask.title.includes(" - ") &&
                                (freshTask.title.includes("1st") ||
                                    freshTask.title.includes("2nd") ||
                                    freshTask.title.includes("3rd"));

                            let titleToUse;
                            let confirmMessage;

                            if (isOccurrenceTask || isOccurrenceByTitle) {
                                // For multiple daily occurrences, delete all occurrences from this date forward
                                titleToUse =
                                    freshTask.originalTitle ||
                                    freshTask.title.split(" - ")[0];
                                confirmMessage = `Are you sure you want to delete ALL occurrences of "${titleToUse}" from ${selectedDate} forward?\n\nThis will delete all daily occurrences (1st, 2nd, 3rd, etc.) from today and all future dates.`;
                            } else {
                                // For regular tasks, delete from this date forward
                                titleToUse = freshTask.title;
                                confirmMessage = `Are you sure you want to delete "${titleToUse}" from ${selectedDate} forward?\n\nThis will affect all future occurrences.`;
                            }

                            if (confirm(confirmMessage)) {
                                modal.remove();

                                if (isOccurrenceTask || isOccurrenceByTitle) {
                                    // Delete all occurrences from this date forward
                                    await deleteAllOccurrencesFuture(
                                        titleToUse,
                                        selectedDate,
                                    );
                                } else {
                                    // Delete regular task from this date forward
                                    await deleteFutureOccurrences(
                                        titleToUse,
                                        selectedDate,
                                        freshTask.date.split(" to ")[0],
                                    );
                                }

                                loadTasksForDate(selectedDate);
                            }
                        } finally {
                            deleteFutureBtn.disabled = false;
                            deleteFutureBtn.textContent = originalText;
                        }
                    });
                }

                // Delete entire task
                const deleteEntireTaskBtn = modal.querySelector(
                    "#deleteEntireTaskBtn",
                );
                if (deleteEntireTaskBtn) {
                    deleteEntireTaskBtn.addEventListener("click", async () => {
                        // Prevent multiple clicks
                        if (deleteEntireTaskBtn.disabled) {
                            return;
                        }
                        deleteEntireTaskBtn.disabled = true;
                        const originalText = deleteEntireTaskBtn.textContent;
                        deleteEntireTaskBtn.textContent = "Deleting...";

                        try {
                            // Check if this is a multiple daily occurrence task
                            const isOccurrenceTask =
                                freshTask.originalTitle &&
                                freshTask.totalOccurrences;
                            const isOccurrenceByTitle =
                                freshTask.title.includes(" - ") &&
                                (freshTask.title.includes("1st") ||
                                    freshTask.title.includes("2nd") ||
                                    freshTask.title.includes("3rd"));

                            let titleToUse;
                            let confirmMessage;

                            if (isOccurrenceTask || isOccurrenceByTitle) {
                                // For multiple daily occurrences, delete all occurrences across all dates
                                titleToUse =
                                    freshTask.originalTitle ||
                                    freshTask.title.split(" - ")[0];
                                confirmMessage = `Are you sure you want to delete ALL occurrences of "${titleToUse}"?\n\nThis will delete all daily occurrences (1st, 2nd, 3rd, etc.) across all past and future dates.`;
                            } else {
                                // For regular tasks, delete entire task
                                titleToUse = freshTask.title;
                                confirmMessage = `Are you sure you want to delete "${titleToUse}"?\n\nThis will delete the entire task and affect all past and future occurrences.`;
                            }

                            if (confirm(confirmMessage)) {
                                modal.remove();

                                if (isOccurrenceTask || isOccurrenceByTitle) {
                                    // Delete all occurrences across all dates
                                    await deleteAllOccurrences(
                                        titleToUse,
                                        freshTask.date,
                                    );
                                } else {
                                    // Delete regular task entirely
                                    await deleteTaskFromBackend(
                                        titleToUse,
                                        freshTask.date,
                                    );
                                }

                                loadTasksForDate(selectedDate);
                            }
                        } finally {
                            deleteEntireTaskBtn.disabled = false;
                            deleteEntireTaskBtn.textContent = originalText;
                        }
                    });
                }

                // Edit entire task (enhanced for multiple daily occurrences)
                const editTaskBtn = modal.querySelector("#editTaskBtn");
                if (editTaskBtn) {
                    editTaskBtn.addEventListener("click", async () => {
                        // üîß DEBUG: Verify we're using fresh task data
                        console.log("üîß Edit button using freshTask:", {
                            title: freshTask.title,
                            date: freshTask.date,
                            users: freshTask.users,
                            dueTimes: freshTask.dueTimes,
                            originalTitle: freshTask.originalTitle,
                            totalOccurrences: freshTask.totalOccurrences,
                        });
                        console.log(
                            "üîß Edit Entire Task clicked for:",
                            freshTask.title,
                        );
                        console.log(
                            "üîß Original task data:",
                            JSON.stringify(freshTask, null, 2),
                        );

                        // For occurrence tasks, we need to reconstruct the original complete task data
                        const isOccurrenceTask =
                            freshTask.originalTitle &&
                            freshTask.totalOccurrences;
                        const isOccurrenceByTitle =
                            freshTask.title.includes(" - ") &&
                            (freshTask.title.includes("1st") ||
                                freshTask.title.includes("2nd") ||
                                freshTask.title.includes("3rd"));

                        console.log("üîß Task type detection:", {
                            isOccurrenceTask,
                            isOccurrenceByTitle,
                            originalTitle: freshTask.originalTitle,
                            totalOccurrences: freshTask.totalOccurrences,
                        });

                        let taskDataToEdit = { ...freshTask };

                        // Check if this date has exception data (modified task data)
                        if (
                            freshTask.exceptions &&
                            freshTask.exceptions[selectedDate] &&
                            freshTask.exceptions[selectedDate].task
                        ) {
                            console.log(
                                "üîß Found exception data for selected date:",
                                selectedDate,
                            );
                            const exceptionTask =
                                freshTask.exceptions[selectedDate].task;

                            // Use the exception data as the base, but keep original task structure
                            taskDataToEdit = {
                                ...freshTask,
                                ...exceptionTask,
                                // Preserve important edit metadata
                                exceptions: freshTask.exceptions,
                                completions: freshTask.completions,
                            };

                            console.log("üîß Using exception data for edit:", {
                                originalUsers: freshTask.users,
                                exceptionUsers: exceptionTask.users,
                                originalDueTimes: freshTask.dueTimes,
                                exceptionDueTimes: exceptionTask.dueTimes,
                            });
                        }

                        if (isOccurrenceTask || isOccurrenceByTitle) {
                            // For occurrence tasks, reconstruct the original complete task
                            const originalTitle =
                                freshTask.originalTitle ||
                                freshTask.title.split(" - ")[0];
                            const adminEmail =
                                localStorage.getItem("currentAdminEmail");

                            try {
                                // Add longer delay to ensure backend processing is complete
                                console.log(
                                    "üîß Waiting for backend to process recent changes...",
                                );
                                await new Promise((resolve) =>
                                    setTimeout(resolve, 3000),
                                );

                                // Multiple attempts with enhanced cache busting
                                let response;
                                let attempts = 0;
                                const maxAttempts = 3;

                                while (attempts < maxAttempts) {
                                    attempts++;
                                    const cacheBuster = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}_attempt${attempts}`;
                                    console.log(
                                        `üîß Attempt ${attempts}/${maxAttempts} to fetch fresh data...`,
                                    );

                                    response = await fetch(
                                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${cacheBuster}&refresh=true&force=true`,
                                        {
                                            cache: "no-store",
                                            headers: {
                                                "Cache-Control":
                                                    "no-cache, no-store, must-revalidate",
                                                Pragma: "no-cache",
                                                Expires: "0",
                                                "X-Force-Refresh": "true",
                                            },
                                        },
                                    );

                                    if (response.ok) {
                                        break;
                                    }

                                    if (attempts < maxAttempts) {
                                        console.log(
                                            `üîß Attempt ${attempts} failed, waiting before retry...`,
                                        );
                                        await new Promise((resolve) =>
                                            setTimeout(resolve, 1000),
                                        );
                                    }
                                }
                                if (response.ok) {
                                    const result = await response.json();
                                    const allOccurrences = result.tasks.filter(
                                        (t) =>
                                            (t.originalTitle ===
                                                originalTitle ||
                                                t.title.startsWith(
                                                    originalTitle + " - ",
                                                )) &&
                                            t.date === freshTask.date,
                                    );

                                    console.log(
                                        "üîß Found occurrences for reconstruction:",
                                        allOccurrences.length,
                                    );
                                    console.log(
                                        "üîß Occurrence titles:",
                                        allOccurrences.map((t) => t.title),
                                    );

                                    if (allOccurrences.length > 0) {
                                        // Sort occurrences by occurrence number
                                        allOccurrences.sort(
                                            (a, b) =>
                                                (a.occurrence || 1) -
                                                (b.occurrence || 1),
                                        );

                                        // Reconstruct original task data
                                        taskDataToEdit = {
                                            ...allOccurrences[0],
                                            title: originalTitle, // Use original title
                                            timesPerDay: allOccurrences.length, // Set correct times per day
                                            totalOccurrences:
                                                allOccurrences.length,
                                            // Collect all users from all occurrences (for rotation tasks)
                                            users: [
                                                ...new Set(
                                                    allOccurrences.flatMap(
                                                        (occ) =>
                                                            occ.users || [],
                                                    ),
                                                ),
                                            ],
                                            // Collect all due times from all occurrences
                                            dueTimes: allOccurrences
                                                .map((occ) =>
                                                    occ.dueTimes &&
                                                    occ.dueTimes[0]
                                                        ? occ.dueTimes[0]
                                                        : "",
                                                )
                                                .filter((time) => time),
                                            // Preserve occurrence group metadata for editing
                                            originalTitle: originalTitle,
                                            isOccurrenceGroupEdit: true,
                                            // Remove individual occurrence number
                                            occurrence: undefined,
                                        };

                                        console.log(
                                            "üîç Reconstructed original task data:",
                                            JSON.stringify(
                                                taskDataToEdit,
                                                null,
                                                2,
                                            ),
                                        );
                                        console.log(
                                            `üîß Reconstructed timesPerDay: ${taskDataToEdit.timesPerDay} from ${allOccurrences.length} occurrences`,
                                        );
                                    } else {
                                        console.warn(
                                            "üîß No occurrences found - this might indicate deletion worked but data is stale",
                                        );
                                    }
                                }
                            } catch (error) {
                                console.error(
                                    "Error fetching occurrence data:",
                                    error,
                                );
                            }
                        }

                        // Store the complete task data in localStorage
                        console.log("üîß Storing task data in localStorage:");
                        console.log(
                            "üîß Task data to store:",
                            JSON.stringify(taskDataToEdit, null, 2),
                        );

                        localStorage.setItem(
                            "familyApp_editTask",
                            JSON.stringify(taskDataToEdit),
                        );
                        localStorage.setItem(
                            "familyApp_editTask_index",
                            taskDataToEdit.title +
                                "-" +
                                freshTask.date +
                                "-entire",
                        );

                        // Verify localStorage storage
                        const storedData =
                            localStorage.getItem("familyApp_editTask");
                        console.log(
                            "üîß Verified localStorage storage:",
                            storedData ? "SUCCESS" : "FAILED",
                        );
                        if (storedData) {
                            console.log(
                                "üîß Stored data length:",
                                storedData.length,
                            );
                            console.log(
                                "üîß Stored data preview:",
                                storedData.substring(0, 200) + "...",
                            );
                        }

                        const admin = localStorage.getItem("currentAdminEmail");
                        const user = localStorage.getItem("currentUser");
                        console.log("üîß Navigation params:", { admin, user });

                        if (admin && user) {
                            const targetUrl = `/BeeMazing-A1/mobile/3-Tasks/addtasks.html?admin=${encodeURIComponent(admin)}&user=${encodeURIComponent(user)}`;
                            console.log("üîß Navigating to:", targetUrl);
                            window.location.href = targetUrl;
                        } else {
                            alert(
                                "Admin or user information missing. Please log in again.",
                            );
                        }
                    });
                }
            }

            // addtasks.html Settings: Rotation //////////////////////////////////////////////////////////////////////////////////////////

            // Handle task completion and turn advancement
            // ‚úÖ Handle task completion and turn advancement
            async function finishTask(userName, task, button, selectedDate) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                const todayStr =
                    selectedDate || new Date().toISOString().split("T")[0];

                try {
                    const res = await fetch(
                        "https://beemazing1.onrender.com/api/complete-task",
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                adminEmail,
                                taskTitle: task.title,
                                user: userName,
                                date: todayStr,
                                parentApproval: task.parentApproval,
                            }),
                        },
                    );

                    const result = await res.json();
                    if (!res.ok)
                        throw new Error(
                            result.error || "Failed to complete task",
                        );

                    const rewardAmount = result.updatedTask.reward || 0;
                    const parentApprovalRequired =
                        task.parentApproval !== false; // Default to true if not specified

                    // ‚úÖ Trigger reward animation or approval message based on setting
                    if (parentApprovalRequired) {
                        // Show pending approval message
                        if (rewardAmount > 0) {
                            alert(
                                `Task completed! üéâ\n\nYour task is waiting for parent approval.\nOnce approved, you'll receive ${rewardAmount} üçØ buzz points!`,
                            );
                        } else {
                            alert(
                                `Task completed! üéâ\n\nYour task is waiting for parent approval.`,
                            );
                        }
                    } else {
                        // Instant completion - trigger reward animation
                        if (
                            typeof triggerHoneyRain === "function" &&
                            rewardAmount > 0
                        ) {
                            triggerHoneyRain(rewardAmount);
                        }
                        if (rewardAmount > 0) {
                            alert(
                                `Task completed! üéâ\n\nYou instantly received ${rewardAmount} üçØ buzz points!`,
                            );
                        } else {
                            alert(`Task completed! üéâ`);
                        }
                    }

                    // ‚úÖ Refresh task and user data after slight delay to allow DB sync
                    if (typeof loadTasksForDate === "function") {
                        setTimeout(() => loadTasksForDate(todayStr), 150);
                    }
                    if (typeof loadUserTasks === "function")
                        loadUserTasks(userName, todayStr);
                    if (typeof loadUserReward === "function")
                        loadUserReward(userName);
                } catch (err) {
                    console.error("‚ùå Error completing task:", err);
                    alert("Failed to finish task. Please try again.");
                }
            }

            // Delete all occurrences of a task group
            async function deleteAllOccurrences(originalTitle, date) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                console.log("üóëÔ∏è Deleting all occurrences for:", {
                    adminEmail,
                    originalTitle,
                    date,
                });

                if (!adminEmail) {
                    alert("No admin email found.");
                    return;
                }

                try {
                    // First, get all tasks to find related occurrences
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    const result = await response.json();
                    const allTasks = result.tasks || [];

                    // Debug: Log all tasks to see what we're working with
                    console.log(
                        "üîç DEBUG: Total tasks in database:",
                        allTasks.length,
                    );
                    console.log(
                        "üîç DEBUG: All tasks:",
                        allTasks.map((t) => ({
                            title: t.title,
                            originalTitle: t.originalTitle,
                            date: t.date,
                        })),
                    );

                    // Find all related occurrence tasks
                    const startDate = date.split(" to ")[0];
                    console.log(
                        "üîç DEBUG: Looking for tasks with startDate:",
                        startDate,
                    );
                    console.log(
                        "üîç DEBUG: Looking for originalTitle:",
                        originalTitle,
                    );

                    const relatedTasks = allTasks.filter((task) => {
                        const taskStartDate = freshTask.date.split(" to ")[0];
                        const matchesOriginalTitle =
                            task.originalTitle === originalTitle;
                        const matchesTitlePattern =
                            task.title &&
                            task.title.startsWith(originalTitle + " - ");
                        const matchesDate = taskStartDate === startDate;

                        console.log(
                            `üîç DEBUG: Checking task "${task.title}":`,
                            {
                                taskStartDate,
                                matchesOriginalTitle,
                                matchesTitlePattern,
                                matchesDate,
                                isMatch:
                                    (matchesOriginalTitle ||
                                        matchesTitlePattern) &&
                                    matchesDate,
                            },
                        );

                        return (
                            (matchesOriginalTitle || matchesTitlePattern) &&
                            matchesDate
                        );
                    });

                    console.log(
                        "üóëÔ∏è Found related tasks to delete:",
                        relatedTasks.length,
                    );
                    console.log(
                        "üóëÔ∏è Related tasks details:",
                        relatedTasks.map((t) => ({
                            title: t.title,
                            originalTitle: t.originalTitle,
                            date: t.date,
                        })),
                    );

                    if (relatedTasks.length === 0) {
                        alert("No related occurrences found to delete.");
                        return;
                    }

                    // Confirm before deleting multiple tasks
                    if (
                        !confirm(
                            `Are you sure you want to delete ${relatedTasks.length} related task occurrences?`,
                        )
                    ) {
                        return;
                    }

                    // Delete each related task
                    let deletedCount = 0;
                    for (const task of relatedTasks) {
                        console.log("üóëÔ∏è Deleting occurrence:", task.title);
                        try {
                            await deleteTaskFromBackend(task.title, task.date);
                            deletedCount++;
                        } catch (error) {
                            console.error(
                                "Failed to delete task:",
                                task.title,
                                error,
                            );
                        }
                    }

                    alert(
                        `Successfully deleted ${deletedCount} out of ${relatedTasks.length} related occurrences!`,
                    );
                } catch (error) {
                    console.error("Error deleting occurrence group:", error);
                    alert(
                        "Failed to delete occurrence group. Please try again.",
                    );
                }
            }

            // Delete a task from the backend
            async function deleteTaskFromBackend(title, date) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                console.log("üóëÔ∏è DETAILED DELETE DEBUG:");
                console.log("  - Admin Email:", adminEmail);
                console.log("  - Task Title:", title);
                console.log("  - Task Date:", date);
                console.log(
                    "  - Current tasks before delete:",
                    await getAllCurrentTasks(),
                );

                if (!adminEmail) {
                    alert(
                        "‚ùå Delete failed: No admin email found. Please refresh and try again.",
                    );
                    return;
                }

                if (!title) {
                    alert(
                        "‚ùå Delete failed: Missing task title. Please refresh and try again.",
                    );
                    return;
                }

                // Handle "as needed" tasks without dates
                let deleteUrl;
                if (!date) {
                    console.log("  - Deleting 'as needed' task without date");
                    deleteUrl = `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&title=${encodeURIComponent(title)}`;
                } else {
                    const startDate = date.split(" to ")[0];
                    console.log("  - Start Date:", startDate);
                    console.log(
                        "  - Encoded Start Date:",
                        encodeURIComponent(startDate),
                    );
                    console.log(
                        "  - Encoded Title:",
                        encodeURIComponent(title),
                    );
                    console.log(
                        "  - Encoded Admin Email:",
                        encodeURIComponent(adminEmail),
                    );
                    deleteUrl = `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&title=${encodeURIComponent(title)}&date=${encodeURIComponent(startDate)}`;
                }
                console.log("  - Delete URL:", deleteUrl);
                console.log(
                    "  - WARNING: This will delete the specific task with title '",
                    title,
                    "' and date '",
                    date,
                    "'",
                );

                const maxRetries = 3;
                let attempt = 0;

                while (attempt <= maxRetries) {
                    console.log(
                        `üîÑ Delete attempt ${attempt + 1}/${maxRetries + 1}`,
                    );
                    const controller = new AbortController();
                    const timeoutId = setTimeout(
                        () => controller.abort(),
                        120000,
                    ); // 2 minutes timeout

                    try {
                        const response = await fetch(deleteUrl, {
                            method: "DELETE",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            signal: controller.signal,
                        });

                        clearTimeout(timeoutId);
                        console.log("  - Response status:", response.status);
                        console.log("  - Response OK:", response.ok);

                        if (!response.ok) {
                            let errorData;
                            try {
                                errorData = await response.json();
                            } catch (e) {
                                errorData = {
                                    error: `HTTP ${response.status}: ${response.statusText}`,
                                };
                            }
                            console.error("  - Server error:", errorData);
                            throw new Error(
                                `Server error: ${errorData.error || response.statusText} (Status: ${response.status})`,
                            );
                        }

                        const result = await response.json();
                        console.log("‚úÖ Task deleted successfully:", result);
                        console.log(
                            "  - Tasks remaining after delete:",
                            await getAllCurrentTasks(),
                        );

                        // Refresh the task list immediately for the currently selected date
                        if (typeof loadTasksForDate === "function") {
                            setTimeout(() => {
                                const selectedDateElement =
                                    document.querySelector(".day.selected");
                                const currentSelectedDate = selectedDateElement
                                    ? selectedDateElement.dataset.date
                                    : new Date().toISOString().split("T")[0];
                                loadTasksForDate(currentSelectedDate);
                            }, 100);
                        }
                        return;
                    } catch (error) {
                        clearTimeout(timeoutId);
                        console.error(
                            `‚ùå Delete attempt ${attempt + 1} failed:`,
                            error.message,
                        );
                        attempt++;

                        if (attempt > maxRetries) {
                            console.error("üö® All delete attempts failed!");
                            const errorMsg = `Failed to delete task "${title}" after ${maxRetries + 1} attempts.\n\nError: ${error.message}\n\nPossible causes:\n‚Ä¢ Network connection issues\n‚Ä¢ Server is busy\n‚Ä¢ Task data corruption\n‚Ä¢ Permission issues\n\nTry refreshing the page and attempting again.`;
                            alert(errorMsg);
                            return;
                        }

                        const waitTime = Math.min(2000 * attempt, 10000); // Progressive backoff, max 10s
                        console.log(`‚è≥ Waiting ${waitTime}ms before retry...`);
                        await new Promise((resolve) =>
                            setTimeout(resolve, waitTime),
                        );
                    }
                }
            }

            // Get all current tasks for debugging
            async function getAllCurrentTasks() {
                try {
                    const adminEmail =
                        localStorage.getItem("currentAdminEmail");
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&t=${Date.now()}`,
                        { cache: "no-store" },
                    );
                    const result = await response.json();
                    return (result.tasks || []).map((t) => ({
                        title: t.title,
                        date: t.date,
                        repeat: t.repeat,
                        asNeeded: t.asNeeded,
                    }));
                } catch (error) {
                    console.error("Error getting current tasks:", error);
                    return [];
                }
            }

            async function deleteSingleOccurrence(
                title,
                date,
                originalStartDate,
            ) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                console.log("üóëÔ∏è SINGLE OCCURRENCE DELETE DEBUG:");
                console.log("  - Admin Email:", adminEmail);
                console.log("  - Task Title:", title);
                console.log("  - Target Date:", date);
                console.log("  - Original Start Date:", originalStartDate);

                if (!adminEmail) {
                    alert("‚ùå Delete failed: No admin email found.");
                    return;
                }

                if (!title || !date || !originalStartDate) {
                    alert(
                        "‚ùå Delete failed: Missing required data. Please refresh and try again.",
                    );
                    return;
                }

                const deleteUrl = `https://beemazing1.onrender.com/api/tasks/occurrence?adminEmail=${encodeURIComponent(adminEmail)}&title=${encodeURIComponent(title)}&date=${encodeURIComponent(date)}&originalStartDate=${encodeURIComponent(originalStartDate)}`;
                console.log("  - Delete URL:", deleteUrl);

                const maxRetries = 3;
                let attempt = 0;

                while (attempt <= maxRetries) {
                    console.log(
                        `üîÑ Single occurrence delete attempt ${attempt + 1}/${maxRetries + 1}`,
                    );
                    const controller = new AbortController();
                    const timeoutId = setTimeout(
                        () => controller.abort(),
                        120000,
                    );

                    try {
                        const response = await fetch(deleteUrl, {
                            method: "DELETE",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            signal: controller.signal,
                        });

                        clearTimeout(timeoutId);
                        console.log("  - Response status:", response.status);

                        if (!response.ok) {
                            let errorData;
                            try {
                                errorData = await response.json();
                            } catch (e) {
                                errorData = {
                                    error: `HTTP ${response.status}: ${response.statusText}`,
                                };
                            }
                            console.error("  - Server error:", errorData);
                            throw new Error(
                                `Server error: ${errorData.error || response.statusText} (Status: ${response.status})`,
                            );
                        }

                        console.log("Task occurrence deleted successfully");
                        alert("Task occurrence deleted successfully");
                        return;
                    } catch (error) {
                        clearTimeout(timeoutId);
                        attempt++;
                        if (attempt > maxRetries) {
                            console.error(
                                "Error deleting task occurrence after retries:",
                                error,
                            );
                            alert(
                                `Failed to delete task occurrence: ${error.message}`,
                            );
                            return;
                        }
                        console.log(
                            `Retrying delete occurrence request (${attempt}/${maxRetries})...`,
                        );
                        await new Promise((resolve) =>
                            setTimeout(resolve, 2000),
                        );
                    }
                }
            }

            // Delete all occurrences of a task from a specific date forward
            async function deleteAllOccurrencesFuture(originalTitle, fromDate) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                console.log("üóëÔ∏è Deleting all occurrences from date forward:", {
                    adminEmail,
                    originalTitle,
                    fromDate,
                });

                if (!adminEmail) {
                    alert("‚ùå Delete failed: No admin email found.");
                    return;
                }

                try {
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks/occurrences-future?adminEmail=${encodeURIComponent(adminEmail)}&originalTitle=${encodeURIComponent(originalTitle)}&fromDate=${encodeURIComponent(fromDate)}`,
                        {
                            method: "DELETE",
                            headers: { "Content-Type": "application/json" },
                        },
                    );

                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }

                    const result = await response.json();
                    console.log(
                        "‚úÖ Future occurrences deleted successfully:",
                        result,
                    );
                    alert(
                        `Successfully deleted future occurrences from ${fromDate} forward!`,
                    );
                } catch (error) {
                    console.error("Error deleting future occurrences:", error);
                    alert(
                        "Failed to delete future occurrences. Please try again.",
                    );
                }
            }

            // Delete regular task from a specific date forward
            async function deleteFutureOccurrences(
                title,
                fromDate,
                originalStartDate,
            ) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                console.log("üóëÔ∏è Deleting future occurrences:", {
                    adminEmail,
                    title,
                    fromDate,
                    originalStartDate,
                });

                if (!adminEmail) {
                    alert("‚ùå Delete failed: No admin email found.");
                    return;
                }

                try {
                    const response = await fetch(
                        `https://beemazing1.onrender.com/api/tasks/future?adminEmail=${encodeURIComponent(adminEmail)}&title=${encodeURIComponent(title)}&fromDate=${encodeURIComponent(fromDate)}&originalStartDate=${encodeURIComponent(originalStartDate)}`,
                        {
                            method: "DELETE",
                            headers: { "Content-Type": "application/json" },
                        },
                    );

                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }

                    const result = await response.json();
                    console.log(
                        "‚úÖ Future task occurrences deleted successfully:",
                        result,
                    );
                    alert(
                        `Successfully deleted task from ${fromDate} forward!`,
                    );
                } catch (error) {
                    console.error(
                        "Error deleting future task occurrences:",
                        error,
                    );
                    alert(
                        "Failed to delete future task occurrences. Please try again.",
                    );
                }
            }

            // Save a task to the backend
            async function saveTaskToBackend(task) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                if (!adminEmail) {
                    alert("No admin email found.");
                    return;
                }

                try {
                    const response = await fetch(
                        "https://beemazing1.onrender.com/api/tasks",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                adminEmail,
                                task,
                            }),
                        },
                    );

                    if (!response.ok) {
                        throw new Error("Failed to save task to backend");
                    }
                } catch (error) {
                    console.error("Error saving task:", error);
                    alert("Failed to save task. Please try again.");
                }
            }

            // Generate scrollable date picker
            function generateScrollableDates(monthOffset = 0) {
                const container = document.getElementById("dayScrollContainer");
                container.innerHTML = "";

                const today = new Date();
                today.setDate(1);
                today.setMonth(today.getMonth() + monthOffset);

                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const daysInMonth = new Date(
                    currentYear,
                    currentMonth + 1,
                    0,
                ).getDate();

                document.getElementById("monthLabel").textContent =
                    today.toLocaleDateString(undefined, {
                        month: "long",
                        year: "numeric",
                    });

                const todayStr = formatDate(new Date());
                const dayAbbreviations = [
                    "S",
                    "Mo",
                    "Tu",
                    "We",
                    "Th",
                    "Fr",
                    "St",
                ];

                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(currentYear, currentMonth, i);
                    const dayOfWeek = dayAbbreviations[date.getDay()]; // Get day abbreviation

                    const containerDiv = document.createElement("div");
                    containerDiv.className = "day-container";

                    const label = document.createElement("span");
                    label.className = "day-label";
                    label.textContent = dayOfWeek;

                    const btn = document.createElement("div");
                    btn.className = "day";
                    btn.textContent = i;
                    btn.dataset.date = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;

                    btn.addEventListener("click", () => {
                        document
                            .querySelectorAll(".day")
                            .forEach((d) => d.classList.remove("selected"));
                        btn.classList.add("selected");
                        loadTasksForDate(btn.dataset.date);
                    });

                    if (btn.dataset.date === todayStr) {
                        btn.classList.add("today");
                        btn.classList.add("selected");
                    }

                    containerDiv.appendChild(label);
                    containerDiv.appendChild(btn);
                    container.appendChild(containerDiv);
                }

                setTimeout(() => {
                    const selected = document.querySelector(".day.selected");
                    if (selected) {
                        selected.scrollIntoView({
                            behavior: "smooth",
                            inline: "center",
                        });
                        loadTasksForDate(selected.dataset.date);
                    }
                }, 50);
            }

            // Initialize date navigation
            let monthOffset = 0;
            document
                .getElementById("prevMonth")
                .addEventListener("click", () => {
                    monthOffset--;
                    generateScrollableDates(monthOffset);
                });

            document
                .getElementById("nextMonth")
                .addEventListener("click", () => {
                    monthOffset++;
                    generateScrollableDates(monthOffset);
                });

            if (!localStorage.getItem("currentAdminEmail")) {
                const email = prompt("Please enter your admin email:");
                if (email) {
                    localStorage.setItem("currentAdminEmail", email.trim());
                }
            }

            generateScrollableDates();

            document
                .getElementById("scrollLeft")
                .addEventListener("click", () => {
                    document.getElementById("dayScrollContainer").scrollBy({
                        left: -200,
                        behavior: "smooth",
                    });
                });

            document
                .getElementById("scrollRight")
                .addEventListener("click", () => {
                    document.getElementById("dayScrollContainer").scrollBy({
                        left: 200,
                        behavior: "smooth",
                    });
                });

            function enableSwipeToDelete(taskElement) {
                let startX = 0;
                let currentX = 0;
                let isSwiping = false;
                let isTap = true;
                let startTime = 0;

                const swipeThreshold = 80; // üêù Now needs to move 80px left to trigger swipe (was too small before)
                const tapMoveThreshold = 10; // small movements = tap
                const maxTapTime = 300; // milliseconds

                const onStart = (x) => {
                    startX = x;
                    currentX = x;
                    isSwiping = true;
                    isTap = true;
                    startTime = Date.now();
                    taskElement.style.transition = "none";
                };

                const onMove = (x, e) => {
                    if (!isSwiping) return;
                    currentX = x;
                    const deltaX = currentX - startX;

                    if (Math.abs(deltaX) > tapMoveThreshold) {
                        isTap = false;
                        e.preventDefault(); // stop scrolling
                        taskElement.dataset.swiping = "true"; // üêù Mark swiping
                    }

                    if (deltaX < 0) {
                        // Only allow swipe left
                        taskElement.style.transform = `translateX(${deltaX}px)`;
                    }
                };

                const onEnd = (e) => {
                    if (!isSwiping) return;
                    isSwiping = false;

                    const deltaX = currentX - startX;
                    const elapsedTime = Date.now() - startTime;
                    taskElement.style.transition = "transform 0.2s ease";

                    if (deltaX < -swipeThreshold) {
                        // Real swipe left detected
                        taskElement.classList.add("swiped-left");
                        taskElement.style.transform = "translateX(-100px)";
                    } else {
                        // Not enough swipe, snap back
                        taskElement.classList.remove("swiped-left");
                        taskElement.style.transform = "translateX(0)";
                    }

                    // If tap, and clicked on delete-btn, trigger it
                    if (
                        isTap &&
                        elapsedTime < maxTapTime &&
                        e.target.classList.contains("delete-btn")
                    ) {
                        e.target.click();
                    }
                };

                // Touch Events
                taskElement.addEventListener("touchstart", (e) =>
                    onStart(e.touches[0].clientX),
                );
                taskElement.addEventListener("touchmove", (e) =>
                    onMove(e.touches[0].clientX, e),
                );
                taskElement.addEventListener("touchend", (e) => onEnd(e));

                // Mouse Events (Desktop)
                taskElement.addEventListener("mousedown", (e) => {
                    e.preventDefault();
                    onStart(e.clientX);
                });
                taskElement.addEventListener("mousemove", (e) => {
                    if (e.buttons === 1) onMove(e.clientX, e);
                });
                taskElement.addEventListener("mouseup", (e) => onEnd(e));
                taskElement.addEventListener("mouseleave", () => {
                    if (isSwiping) onEnd({});
                });
            }

            async function deleteInvalidTask(task) {
                const adminEmail = localStorage.getItem("currentAdminEmail");
                if (!adminEmail) return;

                const startDate = task.date?.split(" to ")[0] || "";
                try {
                    await fetch(
                        `https://beemazing1.onrender.com/api/tasks?adminEmail=${encodeURIComponent(adminEmail)}&title=${encodeURIComponent(task.title || "")}&date=${encodeURIComponent(startDate)}`,
                        {
                            method: "DELETE",
                            headers: { "Content-Type": "application/json" },
                        },
                    );
                    console.log("Deleted invalid task:", task.title);
                } catch (error) {
                    console.error("Error deleting invalid task:", error);
                }
            }
        </script>
    </body>
</html>
